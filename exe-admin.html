<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Execurive RP | Staff Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #020617; color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .sidebar { background: #0f172a; border-right: 1px solid #1e293b; }
        .row-pending { background: rgba(234, 179, 8, 0.05); border-left: 4px solid #eab308; }
    </style>
</head>
<body class="flex min-h-screen">

    <div class="w-64 sidebar p-6 space-y-8 flex flex-col">
        <h1 class="text-xl font-black italic text-blue-500">EXE-ADMIN <span class="text-white text-[10px] block opacity-50">MANAGEMENT SYSTEM</span></h1>
        <nav class="flex-1 space-y-2">
            <a href="#" class="block p-3 rounded bg-blue-600/10 text-blue-400 text-sm font-bold"><i class="fa fa-tachometer-alt mr-2"></i> Dashboard</a>
            <a href="#" class="block p-3 rounded text-gray-400 hover:bg-white/5 text-sm font-bold"><i class="fa fa-book mr-2"></i> CS Queue</a>
            <a href="#" class="block p-3 rounded text-gray-400 hover:bg-white/5 text-sm font-bold"><i class="fa fa-user-shield mr-2"></i> Staff List</a>
        </nav>
        <button onclick="logout()" class="p-3 text-left text-red-500 text-sm font-bold border-t border-gray-800"><i class="fa fa-sign-out-alt mr-2"></i> Logout</button>
    </div>

    <div class="flex-1 p-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-2xl font-bold">Character Story Queue</h2>
                <p class="text-xs text-gray-500">Kelola pendaftaran Character Story pemain</p>
            </div>
            <div class="text-right">
                <span id="staff-name" class="font-bold text-white block">...</span>
                <span id="staff-rank" class="text-[10px] bg-red-600 px-2 py-1 rounded font-black uppercase tracking-tighter">Checking...</span>
            </div>
        </div>

        <div class="bg-[#0f172a] rounded-lg border border-gray-800 overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-black/40 text-gray-500 text-[10px] uppercase font-bold tracking-widest">
                    <tr>
                        <th class="p-4">Sender</th>
                        <th class="p-4">Char Name</th>
                        <th class="p-4">Timestamp</th>
                        <th class="p-4">Action</th>
                    </tr>
                </thead>
                <tbody id="cs-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCtfsTqg3sJuJCq_EGF36c4eg8QUwyhtwE",
            authDomain: "execuriverp.firebaseapp.com",
            databaseURL: "https://execuriverp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "execuriverp",
            storageBucket: "execuriverp.firebasestorage.app",
            appId: "1:672894448184:web:2d9635ca19ea94c3e7eccd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // SECURITY CHECK
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await get(ref(db, 'users/' + user.uid));
                if (snap.exists()) {
                    const userData = snap.val();
                    if (userData.role === "Member") {
                        // JIKA MEMBER, MENTAL KE FORUM
                        window.location.href = "forum.html";
                    } else {
                        // JIKA STAFF, TAMPILKAN DATA
                        document.getElementById('staff-name').innerText = userData.username;
                        document.getElementById('staff-rank').innerText = userData.role;
                        loadCSQueue();
                    }
                }
            } else {
                // JIKA BELUM LOGIN, MENTAL KE LOGIN PAGE
                window.location.href = "execurive.html";
            }
        });

        function loadCSQueue() {
            onValue(ref(db, 'character_stories'), (snap) => {
                const container = document.getElementById('cs-table-body');
                container.innerHTML = "";
                if (snap.exists()) {
                    const data = snap.val();
                    Object.keys(data).forEach(id => {
                        const cs = data[id];
                        if (cs.status === "Pending") {
                            container.innerHTML += `
                                <tr class="row-pending border-b border-gray-800">
                                    <td class="p-4 font-bold text-blue-400">@${cs.username}</td>
                                    <td class="p-4 italic text-white">${cs.charName}</td>
                                    <td class="p-4 text-gray-500 text-xs">${new Date(cs.timestamp).toLocaleDateString()}</td>
                                    <td class="p-4 flex gap-2">
                                        <button onclick="respondCS('${id}', '${cs.uid}', 'Accepted')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-[10px] font-black uppercase">Approve</button>
                                        <button onclick="respondCS('${id}', '${cs.uid}', 'Rejected')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-[10px] font-black uppercase">Reject</button>
                                    </td>
                                </tr>
                            `;
                        }
                    });
                } else {
                    container.innerHTML = "<tr><td colspan='4' class='p-10 text-center text-gray-600'>Antrian kosong...</td></tr>";
                }
            });
        }

        window.respondCS = async (csId, userUid, newStatus) => {
            if (!confirm(`Konfirmasi ${newStatus}?`)) return;
            try {
                // Update status di list CS
                await update(ref(db, 'character_stories/' + csId), { status: newStatus });
                // Update status di profile user (agar mereka bisa kirim ulang jika di-reject)
                await update(ref(db, 'users/' + userUid), { cs_status: newStatus });
                alert("Berhasil memproses CS!");
            } catch (e) { alert(e.message); }
        };

        window.logout = () => signOut(auth);
    </script>
</body>
</html>
