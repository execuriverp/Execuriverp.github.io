<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ExeMusic 4.0 - Device Upload Edition</title>
  <link rel="icon" type="image/png" href="exemusicicon.png">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --accent: #00ff88; 
      --text: #ffffff;
      --text-dim: #b3b3b3;
      --bg: #050505;
      --card-bg: #121212;
      --glass: rgba(255, 255, 255, 0.05);
      --danger: #ff3333;
      --warning: #ffcc00;
      --tiktok-red: #ff0050;
      --gold: #ffd700;
      --purple: #bf00ff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    /* --- ROBLOX STYLE BROADCAST SYSTEM --- */
    .sys-broadcast {
        position: fixed;
        top: -150px; 
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
        background: rgba(15, 15, 15, 0.95);
        border-left: 4px solid var(--accent);
        border-radius: 6px;
        padding: 15px;
        z-index: 12000;
        box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease, transform 0.4s ease;
        backdrop-filter: blur(10px);
    }
    .sys-broadcast.active { top: 20px; }
    
    .sb-content { display: flex; align-items: flex-start; gap: 12px; }
    .sb-icon { font-size: 20px; color: var(--accent); margin-top: 2px; }
    .sb-text h4 { margin: 0; font-size: 14px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
    .sb-text p { margin: 4px 0 0; font-size: 12px; color: #ddd; line-height: 1.4; }
    
    .sb-close {
        position: absolute; top: 10px; right: 10px;
        background: transparent; border: none; color: #666;
        cursor: pointer; font-size: 16px; padding: 5px;
    }
    .sb-close:hover { color: white; }

    .sb-progress {
        width: 100%; height: 3px; background: #333;
        margin-top: 12px; border-radius: 2px; overflow: hidden;
    }
    .sb-bar {
        width: 100%; height: 100%; background: var(--accent);
        transform-origin: left;
    }
    @keyframes countDown { from { transform: scaleX(1); } to { transform: scaleX(0); } }
    @keyframes disco-pulse { 0% { border-color: rgba(255,255,255,0.08); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 50% { border-color: rgba(var(--accent), 0.3); box-shadow: 0 20px 50px rgba(var(--accent), 0.2); } 100% { border-color: rgba(255,255,255,0.08); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } }
    @keyframes disco-heartbeat { 
      0% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 
      20% { transform: scale(1.02); box-shadow: 0 25px 60px var(--accent)80; } 
      40% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 
      60% { transform: scale(1.03); box-shadow: 0 30px 70px var(--accent); } 
      100% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 
    }
    @keyframes rainbow-glow { 
      0% { border-color: #ff0000; box-shadow: inset 0 0 20px #ff0000, 0 20px 50px #ff000080; } 
      16% { border-color: #ff7f00; box-shadow: inset 0 0 20px #ff7f00, 0 20px 50px #ff7f0080; } 
      33% { border-color: #ffff00; box-shadow: inset 0 0 20px #ffff00, 0 20px 50px #ffff0080; } 
      50% { border-color: #00ff00; box-shadow: inset 0 0 20px #00ff00, 0 20px 50px #00ff0080; } 
      66% { border-color: #0000ff; box-shadow: inset 0 0 20px #0000ff, 0 20px 50px #0000ff80; } 
      83% { border-color: #8b00ff; box-shadow: inset 0 0 20px #8b00ff, 0 20px 50px #8b00ff80; } 
      100% { border-color: #ff0000; box-shadow: inset 0 0 20px #ff0000, 0 20px 50px #ff000080; } 
    }
    @keyframes snowfall { 
      0% { transform: translateY(-10px) translateX(0); opacity: 1; } 
      25% { transform: translateY(25vh) translateX(15px); opacity: 1; }
      50% { transform: translateY(50vh) translateX(-10px); opacity: 1; }
      75% { transform: translateY(75vh) translateX(20px); opacity: 1; }
      100% { transform: translateY(100vh) translateX(0); opacity: 0; } 
    }
    .snowflake { 
      position: fixed; 
      top: -10px; 
      color: #00d4ff; 
      font-size: 1.5em; 
      font-family: Arial, sans-serif; 
      text-shadow: 0 0 5px #00d4ff; 
      z-index: 1;
      pointer-events: none;
      animation: snowfall linear forwards;
    }

    /* --- OVERLAYS --- */
    .full-overlay {
      position: fixed; inset: 0; background: #000; z-index: 10000;
      display: none; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; padding: 30px;
    }
    .full-overlay i { font-size: 60px; margin-bottom: 20px; }
    .full-overlay h1 { font-size: 24px; color: var(--accent); }
    .full-overlay p { color: var(--text-dim); margin-top: 10px; }
    #bannedScreen h1 { color: var(--danger); }

    #loadingCard {
      position: absolute; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: 0.5s;
    }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--glass); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- MAIN APP --- */
    .app {
      background: rgba(18, 18, 18, 0.6);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 35px;
      width: 95%; max-width: 400px; 
      height: 95vh;
      display: flex; flex-direction: column; 
      padding: 25px; 
      position: relative;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; margin-bottom: 15px; }
    .header img { width: 110px; cursor: pointer; transition: 0.3s; }
    .header img:active { transform: scale(0.9); }
    
    .header-right { display: flex; align-items: center; gap: 10px; }
    
    #btnNotif {
      position: relative;
      width: 42px; height: 42px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: 0.2s;
    }
    #btnNotif:hover { background: var(--accent); color: black; border-color: var(--accent); }
    #btnNotif:active { transform: scale(0.95); }
    #btnNotif .notif-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      min-width: 18px;
      height: 18px;
      background: var(--danger);
      border-radius: 9px;
      font-size: 10px;
      font-weight: 700;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    #btnNotif .notif-badge.show { display: flex; }
    
    #topLoginBtn { 
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); 
      color: white; padding: 8px 16px; border-radius: 20px; font-size: 11px; cursor: pointer;
      font-weight: 600; transition: 0.2s;
    }
    #topLoginBtn:hover { background: var(--accent); color: black; border-color: var(--accent); }

    /* Notif/Chat panel - TikTok/ML style */
    .notif-panel {
      position: fixed;
      top: 70px;
      right: 20px;
      width: 90%;
      max-width: 350px;
      max-height: 70vh;
      background: rgba(18, 18, 18, 0.98);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 15px;
      z-index: 10001;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      backdrop-filter: blur(40px);
      overflow-y: auto;
      display: none;
      flex-direction: column;
      gap: 12px;
    }
    .notif-panel.show { display: flex; }
    .notif-panel h3 {
      color: var(--accent);
      font-size: 14px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .notif-panel h3 button {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 5px 12px;
      border-radius: 10px;
      font-size: 10px;
      cursor: pointer;
      transition: 0.2s;
    }
    .notif-panel h3 button:hover {
      background: var(--accent);
      color: black;
    }
    .notif-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 12px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      transition: 0.2s;
      cursor: pointer;
    }
    .notif-item:hover {
      background: rgba(255,255,255,0.08);
    }
    .notif-item.unread {
      border-color: var(--accent);
      background: rgba(0, 255, 136, 0.05);
    }
    .notif-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 255, 136, 0.2);
      color: var(--accent);
      font-size: 14px;
      flex-shrink: 0;
    }
    .notif-content {
      flex: 1;
    }
    .notif-content .title {
      font-size: 12px;
      font-weight: 600;
      color: white;
      margin-bottom: 3px;
    }
    .notif-content .message {
      font-size: 11px;
      color: var(--text-dim);
      line-height: 1.3;
    }
    .notif-content .time {
      font-size: 10px;
      color: #666;
      margin-top: 5px;
    }

    /* SEARCH BAR */
    .search-bar {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 25px;
      padding: 12px 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    .search-bar i { color: var(--text-dim); }
    .search-bar input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 14px;
    }
    .search-bar input::placeholder { color: var(--text-dim); }

    /* MAIN CONTENT */
    .content {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }
    .content::-webkit-scrollbar { width: 5px; }
    .content::-webkit-scrollbar-track { background: transparent; }
    .content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

    /* MUSIC CARD */
    .music-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .music-card:hover { background: rgba(255,255,255,0.08); border-color: var(--accent); transform: translateY(-2px); }
    .music-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, transparent 50%);
      opacity: 0;
      transition: 0.3s;
    }
    .music-card:hover::before { opacity: 1; }

    .mc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; position: relative; z-index: 1; }
    .mc-info { flex: 1; }
    .mc-title { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 3px; }
    .mc-artist { font-size: 12px; color: var(--text-dim); }
    .mc-meta { display: flex; align-items: center; gap: 12px; font-size: 11px; color: var(--text-dim); margin-top: 8px; position: relative; z-index: 1; }
    .mc-meta i { margin-right: 4px; }

    .mc-actions { display: flex; gap: 8px; }
    .mc-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 8px 12px;
      color: white;
      font-size: 11px;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .mc-btn:hover { background: var(--accent); color: black; border-color: var(--accent); }
    .mc-btn.danger:hover { background: var(--danger); border-color: var(--danger); }

    /* ADD CARD */
    .add-card {
      background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,255,136,0.05) 100%);
      border: 2px dashed var(--accent);
      border-radius: 20px;
      padding: 30px 20px;
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.3s;
      text-align: center;
    }
    .add-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,255,136,0.2); }
    .add-card i { font-size: 40px; color: var(--accent); margin-bottom: 10px; }
    .add-card h3 { font-size: 16px; color: var(--accent); margin-bottom: 5px; }
    .add-card p { font-size: 11px; color: var(--text-dim); }

    /* BOTTOM NAV */
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      padding: 15px 0 5px;
      border-top: 1px solid rgba(255,255,255,0.08);
      flex-shrink: 0;
    }
    .nav-btn {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 22px;
      cursor: pointer;
      transition: 0.2s;
      padding: 8px 15px;
      border-radius: 15px;
    }
    .nav-btn.active { color: var(--accent); background: rgba(0,255,136,0.1); }
    .nav-btn:hover { color: var(--accent); }

    /* MODAL */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 11000;
      padding: 20px;
    }
    .modal-content {
      background: var(--card-bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 25px;
      padding: 25px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content::-webkit-scrollbar { width: 5px; }
    .modal-content::-webkit-scrollbar-track { background: transparent; }
    .modal-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { font-size: 20px; color: var(--accent); }
    .modal-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
    }
    .modal-close:hover { background: var(--danger); }

    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px 15px;
      color: var(--text);
      font-size: 14px;
      transition: 0.2s;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      border-color: var(--accent);
      background: rgba(0,255,136,0.05);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }

    .btn {
      background: var(--accent);
      color: black;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      width: 100%;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,255,136,0.3); }
    .btn:active { transform: translateY(0); }
    .btn.secondary {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .btn.secondary:hover { background: rgba(255,255,255,0.2); }

    /* WARNING BOX */
    .warning-box {
      background: rgba(255, 204, 0, 0.1);
      border: 1px solid var(--warning);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .warning-box i {
      color: var(--warning);
      font-size: 16px;
      margin-top: 2px;
    }
    .warning-box p {
      font-size: 11px;
      color: var(--text);
      line-height: 1.4;
    }

    /* DEVICE UPLOAD SPECIFIC */
    .upload-choice {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    .upload-option {
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px 15px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .upload-option:hover {
      background: rgba(255,255,255,0.08);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .upload-option.selected {
      background: rgba(0,255,136,0.1);
      border-color: var(--accent);
    }
    .upload-option i {
      font-size: 24px;
      color: var(--accent);
    }
    .upload-option span {
      font-size: 12px;
      color: var(--text);
      font-weight: 600;
    }
    .upload-option small {
      font-size: 10px;
      color: var(--text-dim);
    }

    .upload-info {
      background: rgba(0, 136, 255, 0.1);
      border: 1px solid #0088ff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 15px;
    }
    .upload-info p {
      font-size: 11px;
      color: var(--text);
      line-height: 1.4;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .upload-info i {
      color: #0088ff;
    }

    .file-preview {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .file-preview i {
      font-size: 30px;
      color: var(--accent);
    }
    .file-preview .file-info {
      flex: 1;
    }
    .file-preview .file-name {
      font-size: 13px;
      color: var(--text);
      font-weight: 600;
      margin-bottom: 3px;
    }
    .file-preview .file-size {
      font-size: 11px;
      color: var(--text-dim);
    }

    .progress-container {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: none;
    }
    .progress-container.show {
      display: block;
    }
    .progress-label {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #00cc6a);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }

    /* PROFILE MODAL */
    .profile-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--accent);
      margin: 0 auto 10px;
      position: relative;
      cursor: pointer;
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .profile-avatar .avatar-edit {
      position: absolute;
      bottom: 0;
      right: 0;
      background: var(--accent);
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: black;
      font-size: 12px;
    }
    .profile-username {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 3px;
    }
    .profile-tag {
      font-size: 12px;
      color: var(--text-dim);
    }

    .profile-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 10px;
      color: var(--text-dim);
      font-size: 12px;
      cursor: pointer;
      transition: 0.2s;
      text-align: center;
    }
    .tab-btn.active {
      background: rgba(0,255,136,0.1);
      border-color: var(--accent);
      color: var(--accent);
    }

    .profile-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat-box {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }
    .stat-label {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 3px;
    }

    .profile-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .profile-action-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px 15px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .profile-action-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: var(--accent);
    }
    .profile-action-btn i {
      color: var(--accent);
    }

    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* ABOUT MODAL - IMPROVED */
    .about-header {
      text-align: center;
      margin-bottom: 25px;
    }
    .about-logo {
      width: 120px;
      margin: 0 auto 15px;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .about-title {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), #00cc6a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }
    .about-version {
      font-size: 12px;
      color: var(--text-dim);
      font-weight: 600;
    }

    .about-section {
      margin-bottom: 20px;
    }
    .about-section h3 {
      font-size: 14px;
      color: var(--accent);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .about-section p {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.6;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .feature-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      transition: 0.2s;
    }
    .feature-item:hover {
      background: rgba(0,255,136,0.1);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .feature-item i {
      font-size: 20px;
      color: var(--accent);
      margin-bottom: 5px;
    }
    .feature-item span {
      display: block;
      font-size: 11px;
      color: var(--text);
      font-weight: 600;
    }

    .social-links {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .social-btn {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px;
      color: var(--text);
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 12px;
      transition: 0.2s;
    }
    .social-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .social-btn i {
      font-size: 16px;
    }

    .credits {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }
    .credits p {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    .credits .dev-name {
      font-size: 14px;
      color: var(--accent);
      font-weight: 700;
      margin-bottom: 3px;
    }

    /* NON TOP4TOP BADGE */
    .source-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: rgba(0, 136, 255, 0.2);
      border: 1px solid #0088ff;
      border-radius: 8px;
      padding: 3px 8px;
      font-size: 10px;
      color: #0088ff;
      margin-top: 5px;
    }
    .source-badge i {
      font-size: 10px;
    }

    /* RESPONSIVE */
    @media (max-width: 400px) {
      .app { padding: 20px; }
      .modal-content { padding: 20px; }
      .upload-choice { grid-template-columns: 1fr; }
    }

    /* Hide default file input */
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>

  <!-- System Broadcast -->
  <div id="sysBroadcast" class="sys-broadcast">
    <button class="sb-close" onclick="closeBroadcast()"><i class="fas fa-times"></i></button>
    <div class="sb-content">
      <i class="fas fa-bullhorn sb-icon"></i>
      <div class="sb-text">
        <h4 id="bcTitle">System Broadcast</h4>
        <p id="bcMessage">Loading...</p>
      </div>
    </div>
    <div class="sb-progress">
      <div class="sb-bar" id="bcBar"></div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loadingCard">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: var(--text-dim); font-size: 12px;">Memuat ExeMusic...</p>
  </div>

  <!-- Banned Screen -->
  <div id="bannedScreen" class="full-overlay">
    <i class="fas fa-ban" style="color: var(--danger);"></i>
    <h1>Akun Anda Dibanned</h1>
    <p id="banReason">Alasan: Pelanggaran aturan komunitas</p>
  </div>

  <!-- Maintenance Screen -->
  <div id="maintenanceScreen" class="full-overlay">
    <i class="fas fa-tools" style="color: var(--warning);"></i>
    <h1>Dalam Perbaikan</h1>
    <p>Sistem sedang dalam maintenance. Mohon coba lagi nanti.</p>
  </div>

  <!-- Main App -->
  <div class="app">
    <!-- Header -->
    <div class="header">
      <img src="https://i.postimg.cc/d0gbX1bq/exemusic.png" alt="ExeMusic" onclick="openAbout()">
      <div class="header-right">
        <button id="btnNotif" onclick="toggleNotif()">
          <i class="fas fa-bell"></i>
          <span class="notif-badge" id="notifBadge">0</span>
        </button>
        <button id="topLoginBtn" onclick="openLoginModal()">Login</button>
      </div>
    </div>

    <!-- Notification Panel -->
    <div id="notifPanel" class="notif-panel">
      <h3>
        <span><i class="fas fa-bell"></i> Notifikasi</span>
        <button onclick="clearAllNotifs()">Hapus Semua</button>
      </h3>
      <div id="notifList">
        <p style="text-align: center; color: var(--text-dim); font-size: 12px; padding: 20px;">
          Belum ada notifikasi
        </p>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Cari lagu atau artis..." oninput="searchMusic()">
    </div>

    <!-- Content -->
    <div class="content" id="musicList">
      <!-- Add Card with Device Upload -->
      <div class="add-card" onclick="openUploadModal()">
        <i class="fas fa-plus-circle"></i>
        <h3>Upload Lagu</h3>
        <p>⚠️ PERHATIAN: Dilarang mengupload konten SARA, pornografi audio, atau lagu earrape yang merusak telinga. Pelanggaran akan mengakibatkan BANNED PERMANENT tanpa peringatan!</p>
        <button class="btn" style="margin-top: 15px; max-width: 200px;">POST SEKARANG</button>
      </div>

      <!-- Music cards will be loaded here -->
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
      <button class="nav-btn active" onclick="switchView('home')"><i class="fas fa-home"></i></button>
      <button class="nav-btn" onclick="switchView('trending')"><i class="fas fa-fire"></i></button>
      <button class="nav-btn" onclick="switchView('library')"><i class="fas fa-music"></i></button>
      <button class="nav-btn" onclick="openProfile()"><i class="fas fa-user"></i></button>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-cloud-upload-alt"></i> Upload Lagu</h2>
        <button class="modal-close" onclick="closeUploadModal()"><i class="fas fa-times"></i></button>
      </div>

      <div class="warning-box">
        <i class="fas fa-exclamation-triangle"></i>
        <p><strong>PERHATIAN:</strong> Dilarang mengupload konten SARA, pornografi audio, atau lagu earrape. Pelanggaran = BANNED PERMANENT!</p>
      </div>

      <!-- Upload Method Selection -->
      <div class="upload-choice">
        <div class="upload-option" id="optionDevice" onclick="selectUploadMethod('device')">
          <i class="fas fa-mobile-alt"></i>
          <span>Upload dari Device</span>
          <small>File dari HP/PC Anda</small>
        </div>
        <div class="upload-option" id="optionUrl" onclick="selectUploadMethod('url')">
          <i class="fas fa-link"></i>
          <span>Link Top4Top</span>
          <small>URL dari Top4Top</small>
        </div>
      </div>

      <!-- Device Upload Section -->
      <div id="deviceUploadSection" style="display: none;">
        <div class="upload-info">
          <p><i class="fas fa-info-circle"></i> Format: MP3, WAV, OGG | Max: 10MB</p>
        </div>

        <input type="file" id="audioFileInput" accept="audio/*" onchange="handleFileSelect(event)">
        <label for="audioFileInput">
          <div class="btn secondary" style="cursor: pointer; text-align: center;">
            <i class="fas fa-folder-open"></i> Pilih File Audio
          </div>
        </label>

        <div id="filePreview" class="file-preview" style="display: none;">
          <i class="fas fa-file-audio"></i>
          <div class="file-info">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
          </div>
        </div>

        <div id="songNameSection" style="display: none;">
          <div class="form-group">
            <label><i class="fas fa-music"></i> Nama Lagu *</label>
            <input type="text" id="deviceSongName" placeholder="Masukkan nama lagu" maxlength="50">
          </div>

          <div class="form-group">
            <label><i class="fas fa-user"></i> Nama Artis (Optional)</label>
            <input type="text" id="deviceArtist" placeholder="Masukkan nama artis" maxlength="50">
          </div>

          <div class="progress-container" id="uploadProgress">
            <div class="progress-label">
              <span>Mengupload...</span>
              <span id="uploadPercent">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="uploadProgressBar"></div>
            </div>
          </div>

          <button class="btn" onclick="uploadDeviceAudio()" id="btnUploadDevice">
            <i class="fas fa-upload"></i> Upload Sekarang
          </button>
        </div>
      </div>

      <!-- URL Upload Section (Original) -->
      <div id="urlUploadSection" style="display: none;">
        <div class="form-group">
          <label><i class="fas fa-link"></i> URL Top4Top *</label>
          <input type="text" id="musicUrl" placeholder="https://top4top.io/...">
        </div>

        <div class="form-group">
          <label><i class="fas fa-music"></i> Nama Lagu *</label>
          <input type="text" id="songName" placeholder="Masukkan nama lagu" maxlength="50">
        </div>

        <div class="form-group">
          <label><i class="fas fa-user"></i> Nama Artis (Optional)</label>
          <input type="text" id="artistName" placeholder="Masukkan nama artis" maxlength="50">
        </div>

        <button class="btn" onclick="submitMusic()">
          <i class="fas fa-paper-plane"></i> Post Lagu
        </button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-sign-in-alt"></i> Login / Register</h2>
        <button class="modal-close" onclick="closeLoginModal()"><i class="fas fa-times"></i></button>
      </div>

      <div id="usernameSection" style="display: none;">
        <div class="form-group">
          <label><i class="fas fa-user"></i> Username</label>
          <input type="text" id="regUsername" placeholder="Pilih username Anda" maxlength="20">
        </div>
      </div>

      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Email</label>
        <input type="email" id="loginEmail" placeholder="email@example.com">
      </div>

      <div class="form-group">
        <label><i class="fas fa-lock"></i> Password</label>
        <input type="password" id="loginPassword" placeholder="Minimal 6 karakter">
      </div>

      <button class="btn" onclick="handleAuth()" id="authBtn">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>

      <div style="text-align: center; margin: 15px 0; color: var(--text-dim); font-size: 12px;">
        atau
      </div>

      <button class="btn secondary" onclick="handleGoogleAuth()">
        <i class="fab fa-google"></i> <span id="googleBtnText">Masuk dengan Google</span>
      </button>

      <p style="text-align: center; margin-top: 15px; font-size: 11px; color: var(--text-dim);">
        Belum punya akun? <a href="#" onclick="toggleAuthMode(); return false;" style="color: var(--accent);" id="toggleAuthText">Daftar di sini</a>
      </p>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-user-circle"></i> Profile</h2>
        <button class="modal-close" onclick="closeProfile()"><i class="fas fa-times"></i></button>
      </div>

      <div class="profile-header">
        <div class="profile-avatar" onclick="document.getElementById('avatarInput').click()">
          <img id="profileAvatar" src="https://ui-avatars.com/api/?name=User&background=00ff88&color=000" alt="Avatar">
          <div class="avatar-edit"><i class="fas fa-camera"></i></div>
        </div>
        <input type="file" id="avatarInput" accept="image/*" onchange="uploadAvatar(this)" style="display: none;">
        <div class="profile-username" id="profileUsername">Username</div>
        <div class="profile-tag" id="profileTag">@user</div>
      </div>

      <div class="profile-tabs">
        <button class="tab-btn active" id="tabProfile" onclick="switchProfileTab('profile')">
          <i class="fas fa-user"></i> Profile
        </button>
        <button class="tab-btn" id="tabAccount" onclick="switchProfileTab('account')">
          <i class="fas fa-cog"></i> Account
        </button>
      </div>

      <div id="profileTab" class="tab-content active">
        <div class="profile-stats">
          <div class="stat-box">
            <div class="stat-value" id="statFollowers">0</div>
            <div class="stat-label">Followers</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statUploads">0</div>
            <div class="stat-label">Uploads</div>
          </div>
        </div>
      </div>

      <div id="accountTab" class="tab-content">
        <div class="profile-actions">
          <button class="profile-action-btn" onclick="openChangeNameModal()">
            <span><i class="fas fa-edit"></i> Ubah Nama</span>
            <i class="fas fa-chevron-right"></i>
          </button>
          <button class="profile-action-btn" onclick="openChangePasswordModal()">
            <span><i class="fas fa-key"></i> Ubah Password</span>
            <i class="fas fa-chevron-right"></i>
          </button>
          <button class="profile-action-btn" onclick="handleLogout()" style="border-color: var(--danger);">
            <span style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</span>
            <i class="fas fa-chevron-right" style="color: var(--danger);"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- About Modal - IMPROVED -->
  <div id="aboutModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-info-circle"></i> About</h2>
        <button class="modal-close" onclick="closeAbout()"><i class="fas fa-times"></i></button>
      </div>

      <div class="about-header">
        <img src="https://i.postimg.cc/d0gbX1bq/exemusic.png" alt="ExeMusic Logo" class="about-logo">
        <div class="about-title">ExeMusic</div>
        <div class="about-version">Version 4.0 - Device Upload Edition</div>
      </div>

      <div class="about-section">
        <h3><i class="fas fa-music"></i> Tentang Platform</h3>
        <p>ExeMusic adalah platform berbagi musik berbasis komunitas yang memungkinkan Anda mengupload, mendengarkan, dan berbagi musik favorit dengan mudah.</p>
      </div>

      <div class="about-section">
        <h3><i class="fas fa-star"></i> Fitur Utama</h3>
        <div class="feature-grid">
          <div class="feature-item">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Upload dari Device</span>
          </div>
          <div class="feature-item">
            <i class="fas fa-link"></i>
            <span>Support Top4Top</span>
          </div>
          <div class="feature-item">
            <i class="fas fa-share-alt"></i>
            <span>Share Music</span>
          </div>
          <div class="feature-item">
            <i class="fas fa-search"></i>
            <span>Smart Search</span>
          </div>
        </div>
      </div>

      <div class="about-section">
        <h3><i class="fas fa-shield-alt"></i> Aturan Komunitas</h3>
        <p>• Dilarang upload konten SARA, pornografi audio, atau earrape<br>
           • Hormati hak cipta dan privasi orang lain<br>
           • Gunakan platform dengan bijak dan bertanggung jawab</p>
      </div>

      <div class="about-section">
        <h3><i class="fas fa-link"></i> Hubungi Kami</h3>
        <div class="social-links">
          <a href="#" class="social-btn" target="_blank">
            <i class="fab fa-instagram"></i> Instagram
          </a>
          <a href="#" class="social-btn" target="_blank">
            <i class="fab fa-discord"></i> Discord
          </a>
        </div>
      </div>

      <div class="credits">
        <p>Developed with ❤️ by</p>
        <div class="dev-name">ExeMusic Team</div>
        <p>© 2024 ExeMusic. All rights reserved.</p>
      </div>
    </div>
  </div>

  <!-- Change Name Modal -->
  <div id="modalChangeNames" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-edit"></i> Ubah Nama</h2>
        <button class="modal-close" onclick="document.getElementById('modalChangeNames').style.display='none'"><i class="fas fa-times"></i></button>
      </div>

      <div id="cnMsg" style="padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; display: none;"></div>

      <div class="form-group">
        <label><i class="fas fa-user"></i> Nama Baru</label>
        <input type="text" id="cnNewName" placeholder="Username baru" maxlength="20">
      </div>

      <div class="form-group">
        <label><i class="fas fa-lock"></i> Konfirmasi Password</label>
        <input type="password" id="cnPass" placeholder="Masukkan password Anda">
      </div>

      <p style="font-size: 11px; color: var(--text-dim); margin-bottom: 15px;">
        <i class="fas fa-info-circle"></i> Nama hanya bisa diubah 1x dalam 7 hari
      </p>

      <button class="btn" onclick="handleChangeName()">
        <i class="fas fa-save"></i> Simpan Perubahan
      </button>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="modalChangePass" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-key"></i> Ubah Password</h2>
        <button class="modal-close" onclick="document.getElementById('modalChangePass').style.display='none'"><i class="fas fa-times"></i></button>
      </div>

      <div id="cpMsg" style="padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; display: none;"></div>

      <div class="form-group">
        <label><i class="fas fa-lock"></i> Password Lama</label>
        <input type="password" id="cpOldPass" placeholder="Password saat ini">
      </div>

      <div class="form-group">
        <label><i class="fas fa-key"></i> Password Baru</label>
        <input type="password" id="cpNewPass" placeholder="Minimal 6 karakter">
      </div>

      <div class="form-group">
        <label><i class="fas fa-check"></i> Konfirmasi Password</label>
        <input type="password" id="cpConfirm" placeholder="Ulangi password baru">
      </div>

      <p style="font-size: 11px; color: var(--text-dim); margin-bottom: 15px;">
        <i class="fas fa-info-circle"></i> Password hanya bisa diubah 1x dalam 7 hari
      </p>

      <button class="btn" onclick="handleChangePassword()">
        <i class="fas fa-save"></i> Simpan Password
      </button>
    </div>
  </div>

  <script>
    // Firebase configuration (GANTI dengan config Anda)
    const firebaseConfig = {
      apiKey: "AIzaSyCVJYSR4nHeoRA9WTMZa3-2xliKQRrd5g4",
      authDomain: "exemusic-execuriverp.firebaseapp.com",
      databaseURL: "https://exemusic-execuriverp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "exemusic-execuriverp",
      storageBucket: "exemusic-execuriverp.firebasestorage.app",
      messagingSenderId: "722057744401",
      appId: "1:722057744401:web:cd6a6a103692059bda61b0",
      measurementId: "G-2P56Y7QQ18"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    let currentUser = null;
    let userData = {};
    let allMusic = [];
    let isAuthMode = 'login';
    let isFirstTimeUser = false;
    let selectedFile = null;
    let uploadMethod = null;

    // INIT
    auth.onAuthStateChanged(user => {
      if(user) {
        currentUser = user;
        checkUserStatus(user.uid);
      } else {
        hideLoading();
      }
    });

    function checkUserStatus(uid) {
      db.ref('users/' + uid).once('value').then(snap => {
        if(!snap.exists()) {
          hideLoading();
          return;
        }
        
        userData = snap.val();
        
        if(userData.banned) {
          document.getElementById('banReason').innerText = 'Alasan: ' + (userData.banReason || 'Pelanggaran aturan');
          document.getElementById('bannedScreen').style.display = 'flex';
          hideLoading();
          return;
        }
        
        document.getElementById('topLoginBtn').innerText = userData.username || 'User';
        document.getElementById('topLoginBtn').onclick = openProfile;
        
        loadMusic();
        loadBroadcast();
        hideLoading();
      });
    }

    function hideLoading() {
      setTimeout(() => {
        document.getElementById('loadingCard').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('loadingCard').style.display = 'none';
        }, 500);
      }, 500);
    }

    // BROADCAST
    function loadBroadcast() {
      db.ref('broadcast').once('value').then(snap => {
        if(!snap.exists()) return;
        const bc = snap.val();
        if(bc.active) {
          showBroadcast(bc.title, bc.message, bc.duration || 8000);
        }
      });
    }

    function showBroadcast(title, message, duration = 8000) {
      const bcEl = document.getElementById('sysBroadcast');
      const barEl = document.getElementById('bcBar');
      
      document.getElementById('bcTitle').innerText = title;
      document.getElementById('bcMessage').innerText = message;
      
      bcEl.classList.add('active');
      barEl.style.animation = `countDown ${duration}ms linear`;
      
      setTimeout(() => {
        closeBroadcast();
      }, duration);
    }

    function closeBroadcast() {
      document.getElementById('sysBroadcast').classList.remove('active');
    }

    // UPLOAD MODAL
    function openUploadModal() {
      if(!currentUser) {
        msg('⚠️ Login dulu untuk upload!');
        openLoginModal();
        return;
      }
      
      // Reset
      uploadMethod = null;
      selectedFile = null;
      document.getElementById('optionDevice').classList.remove('selected');
      document.getElementById('optionUrl').classList.remove('selected');
      document.getElementById('deviceUploadSection').style.display = 'none';
      document.getElementById('urlUploadSection').style.display = 'none';
      document.getElementById('songNameSection').style.display = 'none';
      document.getElementById('filePreview').style.display = 'none';
      document.getElementById('uploadProgress').classList.remove('show');
      
      document.getElementById('uploadModal').style.display = 'flex';
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').style.display = 'none';
    }

    function selectUploadMethod(method) {
      uploadMethod = method;
      
      document.getElementById('optionDevice').classList.remove('selected');
      document.getElementById('optionUrl').classList.remove('selected');
      document.getElementById('deviceUploadSection').style.display = 'none';
      document.getElementById('urlUploadSection').style.display = 'none';
      
      if(method === 'device') {
        document.getElementById('optionDevice').classList.add('selected');
        document.getElementById('deviceUploadSection').style.display = 'block';
      } else {
        document.getElementById('optionUrl').classList.add('selected');
        document.getElementById('urlUploadSection').style.display = 'block';
      }
    }

    // DEVICE UPLOAD
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if(!file) return;
      
      // Validate file
      if(!file.type.startsWith('audio/')) {
        msg('❌ Hanya file audio yang diperbolehkan!');
        return;
      }
      
      // Max 10MB
      if(file.size > 10 * 1024 * 1024) {
        msg('❌ Ukuran file maksimal 10MB!');
        return;
      }
      
      selectedFile = file;
      
      // Show preview
      document.getElementById('fileName').innerText = file.name;
      document.getElementById('fileSize').innerText = formatFileSize(file.size);
      document.getElementById('filePreview').style.display = 'flex';
      document.getElementById('songNameSection').style.display = 'block';
    }

    function formatFileSize(bytes) {
      if(bytes < 1024) return bytes + ' B';
      if(bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    async function uploadDeviceAudio() {
      if(!selectedFile) {
        msg('❌ Pilih file audio terlebih dahulu!');
        return;
      }
      
      const songName = document.getElementById('deviceSongName').value.trim();
      if(!songName) {
        msg('❌ Nama lagu harus diisi!');
        return;
      }
      
      const artist = document.getElementById('deviceArtist').value.trim() || 'Unknown Artist';
      
      // Disable button
      const btn = document.getElementById('btnUploadDevice');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
      
      // Show progress
      document.getElementById('uploadProgress').classList.add('show');
      
      try {
        // Upload to Firebase Storage
        const timestamp = Date.now();
        const fileName = `music/${currentUser.uid}/${timestamp}_${selectedFile.name}`;
        const storageRef = storage.ref(fileName);
        const uploadTask = storageRef.put(selectedFile);
        
        uploadTask.on('state_changed',
          (snapshot) => {
            // Progress
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('uploadProgressBar').style.width = progress + '%';
            document.getElementById('uploadPercent').innerText = Math.round(progress) + '%';
          },
          (error) => {
            // Error
            msg('❌ Upload gagal: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload"></i> Upload Sekarang';
            document.getElementById('uploadProgress').classList.remove('show');
          },
          async () => {
            // Complete
            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
            
            // Save to database
            const musicData = {
              title: songName,
              artist: artist,
              url: downloadURL,
              uploadedBy: currentUser.uid,
              uploader: userData.username || 'Unknown',
              timestamp: timestamp,
              plays: 0,
              likes: 0,
              source: 'device', // Mark as device upload
              fileName: selectedFile.name,
              fileSize: selectedFile.size
            };
            
            await db.ref('music').push(musicData);
            
            msg('✅ Lagu berhasil diupload!');
            closeUploadModal();
            loadMusic();
            
            // Reset
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload"></i> Upload Sekarang';
            document.getElementById('uploadProgress').classList.remove('show');
            selectedFile = null;
          }
        );
      } catch(err) {
        msg('❌ Terjadi kesalahan: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload"></i> Upload Sekarang';
        document.getElementById('uploadProgress').classList.remove('show');
      }
    }

    // ORIGINAL URL UPLOAD
    function submitMusic() {
      const url = document.getElementById('musicUrl').value.trim();
      const title = document.getElementById('songName').value.trim();
      const artist = document.getElementById('artistName').value.trim() || 'Unknown Artist';
      
      if(!url || !title) {
        msg('❌ URL dan Nama lagu harus diisi!');
        return;
      }
      
      if(!url.includes('top4top')) {
        msg('❌ Hanya link Top4Top yang diperbolehkan untuk metode URL!');
        return;
      }
      
      const musicData = {
        title: title,
        artist: artist,
        url: url,
        uploadedBy: currentUser.uid,
        uploader: userData.username || 'Unknown',
        timestamp: Date.now(),
        plays: 0,
        likes: 0,
        source: 'top4top'
      };
      
      db.ref('music').push(musicData).then(() => {
        msg('✅ Lagu berhasil diupload!');
        closeUploadModal();
        loadMusic();
      }).catch(err => {
        msg('❌ Gagal upload: ' + err.message);
      });
    }

    // LOAD MUSIC
    function loadMusic() {
      db.ref('music').orderByChild('timestamp').once('value').then(snap => {
        allMusic = [];
        snap.forEach(child => {
          allMusic.push({
            id: child.key,
            ...child.val()
          });
        });
        allMusic.reverse();
        displayMusic(allMusic);
      });
    }

    function displayMusic(musicList) {
      const container = document.getElementById('musicList');
      const addCard = container.querySelector('.add-card');
      container.innerHTML = '';
      container.appendChild(addCard);
      
      if(musicList.length === 0) {
        container.innerHTML += '<p style="text-align: center; color: var(--text-dim); padding: 40px;">Belum ada lagu</p>';
        return;
      }
      
      musicList.forEach(music => {
        const card = createMusicCard(music);
        container.appendChild(card);
      });
    }

    function createMusicCard(music) {
      const div = document.createElement('div');
      div.className = 'music-card';
      
      const sourceBadge = music.source === 'device' 
        ? '<span class="source-badge"><i class="fas fa-mobile-alt"></i> Device Upload</span>'
        : '';
      
      div.innerHTML = `
        <div class="mc-header">
          <div class="mc-info">
            <div class="mc-title">${music.title}</div>
            <div class="mc-artist">${music.artist}</div>
            ${sourceBadge}
          </div>
          <div class="mc-actions">
            <button class="mc-btn" onclick="playMusic('${music.id}')">
              <i class="fas fa-play"></i>
            </button>
            <button class="mc-btn" onclick="copyUrl('${music.url}', '${music.source}')">
              <i class="fas fa-copy"></i>
            </button>
            ${music.uploadedBy === currentUser?.uid ? `
              <button class="mc-btn danger" onclick="deleteMusic('${music.id}')">
                <i class="fas fa-trash"></i>
              </button>
            ` : ''}
          </div>
        </div>
        <div class="mc-meta">
          <span><i class="fas fa-play-circle"></i> ${music.plays || 0}</span>
          <span><i class="fas fa-heart"></i> ${music.likes || 0}</span>
          <span><i class="fas fa-user"></i> ${music.uploader}</span>
        </div>
      `;
      
      return div;
    }

    function copyUrl(url, source) {
      navigator.clipboard.writeText(url).then(() => {
        if(source === 'device') {
          msg('📋 URL disalin! ⚠️ Audio ini bukan dari Top4Top');
        } else {
          msg('📋 URL berhasil disalin!');
        }
      });
    }

    function playMusic(id) {
      const music = allMusic.find(m => m.id === id);
      if(!music) return;
      
      // Increment plays
      db.ref(`music/${id}/plays`).transaction(current => (current || 0) + 1);
      
      // Play audio (simple implementation)
      const audio = new Audio(music.url);
      audio.play();
      
      msg('🎵 Memutar: ' + music.title);
    }

    function deleteMusic(id) {
      if(!confirm('Hapus lagu ini?')) return;
      
      db.ref(`music/${id}`).remove().then(() => {
        msg('✅ Lagu dihapus!');
        loadMusic();
      });
    }

    function searchMusic() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      if(!query) {
        displayMusic(allMusic);
        return;
      }
      
      const filtered = allMusic.filter(m => 
        m.title.toLowerCase().includes(query) || 
        m.artist.toLowerCase().includes(query)
      );
      displayMusic(filtered);
    }

    // NOTIFICATIONS
    function toggleNotif() {
      const panel = document.getElementById('notifPanel');
      panel.classList.toggle('show');
    }

    function clearAllNotifs() {
      document.getElementById('notifList').innerHTML = '<p style="text-align: center; color: var(--text-dim); font-size: 12px; padding: 20px;">Belum ada notifikasi</p>';
      document.getElementById('notifBadge').classList.remove('show');
    }

    // PROFILE
    function openProfile() {
      if(!currentUser) {
        openLoginModal();
        return;
      }
      
      document.getElementById('profileUsername').innerText = userData.username || 'User';
      document.getElementById('profileTag').innerText = '@' + (userData.username || 'user');
      document.getElementById('profileAvatar').src = userData.avatar || `https://ui-avatars.com/api/?name=${userData.username}&background=00ff88&color=000`;
      document.getElementById('statFollowers').innerText = userData.followers || 0;
      document.getElementById('statUploads').innerText = allMusic.filter(m => m.uploadedBy === currentUser.uid).length;
      
      document.getElementById('profileModal').style.display = 'flex';
    }

    function closeProfile() {
      document.getElementById('profileModal').style.display = 'none';
    }

    function switchProfileTab(tab) {
      const profileTab = document.getElementById('profileTab');
      const accountTab = document.getElementById('accountTab');
      const btnProfile = document.getElementById('tabProfile');
      const btnAccount = document.getElementById('tabAccount');
      
      if(tab === 'profile') {
        profileTab.classList.add('active');
        accountTab.classList.remove('active');
        btnProfile.classList.add('active');
        btnAccount.classList.remove('active');
      } else {
        profileTab.classList.remove('active');
        accountTab.classList.add('active');
        btnProfile.classList.remove('active');
        btnAccount.classList.add('active');
      }
    }

    // ABOUT - IMPROVED
    function openAbout() {
      document.getElementById('aboutModal').style.display = 'flex';
    }

    function closeAbout() {
      document.getElementById('aboutModal').style.display = 'none';
    }

    // AUTH
    function openLoginModal() {
      document.getElementById('loginModal').style.display = 'flex';
    }

    function closeLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
    }

    function toggleAuthMode() {
      isAuthMode = isAuthMode === 'login' ? 'register' : 'login';
      const btn = document.getElementById('authBtn');
      const toggle = document.getElementById('toggleAuthText');
      
      if(isAuthMode === 'register') {
        btn.innerHTML = '<i class="fas fa-user-plus"></i> Register';
        toggle.innerText = 'Login di sini';
      } else {
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        toggle.innerText = 'Daftar di sini';
      }
    }

    function handleAuth() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if(!email || !password) {
        msg('❌ Email dan password harus diisi!');
        return;
      }
      
      if(isAuthMode === 'register') {
        auth.createUserWithEmailAndPassword(email, password)
          .then(result => {
            const username = prompt('Pilih username:');
            if(!username) return;
            
            return db.ref('users/' + result.user.uid).set({
              username: username,
              email: email,
              avatar: `https://ui-avatars.com/api/?name=${username}&background=00ff88&color=000`,
              role: 'user',
              followers: 0,
              following: [],
              tag: 'user',
              createdAt: Date.now()
            });
          })
          .then(() => {
            msg('✅ Akun berhasil dibuat!');
            closeLoginModal();
          })
          .catch(err => msg('❌ ' + err.message));
      } else {
        auth.signInWithEmailAndPassword(email, password)
          .then(() => {
            msg('✅ Login berhasil!');
            closeLoginModal();
          })
          .catch(err => msg('❌ ' + err.message));
      }
    }

    function handleGoogleAuth() {
      if(isFirstTimeUser) {
        const username = document.getElementById('regUsername').value.trim();
        if(!username || username.length < 3) {
          msg('❌ Username minimal 3 karakter!');
          return;
        }
        
        const fakeFollowers = Math.floor(Math.random() * 50) + 10;
        
        db.ref('users/' + auth.currentUser.uid).set({
          username: username,
          email: auth.currentUser.email,
          avatar: auth.currentUser.photoURL || `https://ui-avatars.com/api/?name=${username}&background=00ff88&color=000`,
          role: 'user',
          followers: fakeFollowers,
          following: [],
          tag: 'user',
          createdAt: Date.now()
        }).then(() => {
          isFirstTimeUser = false;
          document.getElementById('usernameSection').style.display = 'none';
          document.getElementById('googleBtnText').innerText = 'Masuk dengan Google';
          closeLoginModal();
          msg('✅ Akun berhasil dibuat! Selamat datang ' + username + '!');
        }).catch(err => {
          msg('❌ Gagal menyimpan data: ' + err.message);
        });
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({
          prompt: 'select_account'
        });
        
        auth.signInWithPopup(provider)
          .then(result => {
            const user = result.user;
            const isNewUser = result.additionalUserInfo.isNewUser;
            
            if(isNewUser) {
              isFirstTimeUser = true;
              document.getElementById('googleBtnText').innerText = 'Buat Akun';
              document.getElementById('usernameSection').style.display = 'block';
              msg('👋 Selamat datang! Buat username Anda untuk melanjutkan.');
            } else {
              closeLoginModal();
              msg('✅ Selamat datang kembali!');
            }
          })
          .catch(err => {
            if(err.code === 'auth/popup-closed-by-user') {
              msg('⚠️ Login dibatalkan');
            } else if(err.code === 'auth/cancelled-popup-request') {
              // Ignore
            } else {
              msg('❌ Gagal login: ' + err.message);
            }
          });
      }
    }

    function handleLogout() {
      if(!confirm('Yakin ingin logout?')) return;
      auth.signOut().then(() => {
        msg('👋 Berhasil logout!');
        closeProfile();
        location.reload();
      });
    }

    function uploadAvatar(input) {
      const file = input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        db.ref('users/' + auth.currentUser.uid).update({ avatar: e.target.result }).then(() => msg("✅ Profil Updated!"));
      };
      reader.readAsDataURL(file);
    }

    // CHANGE NAME/PASSWORD
    function openChangeNameModal() {
      document.getElementById('cnMsg').innerText = '';
      document.getElementById('cnMsg').style.display = 'none';
      document.getElementById('cnPass').value = '';
      document.getElementById('cnNewName').value = '';
      document.getElementById('modalChangeNames').style.display = 'block';
    }

    async function handleChangeName() {
      const password = document.getElementById('cnPass').value;
      const newName = document.getElementById('cnNewName').value;
      const msgEl = document.getElementById('cnMsg');
      
      if(!newName || !password) {
        msgEl.innerText = '⚠️ Isi semua field!';
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(255,51,51,0.2)';
        msgEl.style.border = '1px solid var(--danger)';
        return;
      }
      if(newName.length < 3) {
        msgEl.innerText = '⚠️ Nama minimal 3 karakter!';
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(255,51,51,0.2)';
        msgEl.style.border = '1px solid var(--danger)';
        return;
      }
      
      const lastChange = userData.lastNameChange || 0;
      const now = Date.now();
      const diffDays = (now - lastChange) / (1000 * 60 * 60 * 24);
      
      if(diffDays < 7) {
        msgEl.innerText = `⏳ Tunggu ${Math.ceil(7 - diffDays)} hari lagi!`;
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(255,51,51,0.2)';
        msgEl.style.border = '1px solid var(--danger)';
        return;
      }
      
      const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, password);
      
      try {
        await auth.currentUser.reauthenticateWithCredential(credential);
        await db.ref('users/' + auth.currentUser.uid).update({
          username: newName,
          lastNameChange: Date.now()
        });
        msgEl.innerText = '✅ Nama berhasil diubah!';
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(0,255,136,0.2)';
        msgEl.style.border = '1px solid var(--accent)';
        setTimeout(() => {
          document.getElementById('modalChangeNames').style.display = 'none';
          msg('Nama pengguna telah diperbarui!');
        }, 1500);
      } catch(err) {
        msgEl.innerText = '❌ Password salah!';
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(255,51,51,0.2)';
        msgEl.style.border = '1px solid var(--danger)';
      }
    }

    function openChangePasswordModal() {
      document.getElementById('cpMsg').innerText = '';
      document.getElementById('cpMsg').style.display = 'none';
      document.getElementById('cpOldPass').value = '';
      document.getElementById('cpNewPass').value = '';
      document.getElementById('cpConfirm').value = '';
      document.getElementById('modalChangePass').style.display = 'block';
    }

    async function handleChangePassword() {
      const oldPass = document.getElementById('cpOldPass').value;
      const newPass = document.getElementById('cpNewPass').value;
      const confirm = document.getElementById('cpConfirm').value;
      const msgEl = document.getElementById('cpMsg');
      
      if(!oldPass || !newPass || !confirm) {
        msgEl.innerText = '⚠️ Isi semua field!';
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(255,51,51,0.2)';
        msgEl.style.border = '1px solid var(--danger)';
        return;
      }
      if(newPass.length < 6) {
        msgEl.innerText = '⚠️ Password minimal 6 karakter!';
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(255,51,51,0.2)';
        msgEl.style.border = '1px solid var(--danger)';
        return;
      }
      if(newPass !== confirm) {
        msgEl.innerText = '⚠️ Password tidak cocok!';
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(255,51,51,0.2)';
        msgEl.style.border = '1px solid var(--danger)';
        return;
      }
      
      const lastChange = userData.lastPasswordChange || 0;
      const now = Date.now();
      const diffDays = (now - lastChange) / (1000 * 60 * 60 * 24);
      
      if(diffDays < 7) {
        msgEl.innerText = `⏳ Tunggu ${Math.ceil(7 - diffDays)} hari lagi!`;
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(255,51,51,0.2)';
        msgEl.style.border = '1px solid var(--danger)';
        return;
      }
      
      const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, oldPass);
      
      try {
        await auth.currentUser.reauthenticateWithCredential(credential);
        await auth.currentUser.updatePassword(newPass);
        await db.ref('users/' + auth.currentUser.uid).update({
          lastPasswordChange: Date.now()
        });
        msgEl.innerText = '✅ Password berhasil diubah!';
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(0,255,136,0.2)';
        msgEl.style.border = '1px solid var(--accent)';
        setTimeout(() => {
          document.getElementById('modalChangePass').style.display = 'none';
          msg('Password telah diperbarui!');
        }, 1500);
      } catch(err) {
        msgEl.innerText = '❌ Password lama salah!';
        msgEl.style.display = 'block';
        msgEl.style.background = 'rgba(255,51,51,0.2)';
        msgEl.style.border = '1px solid var(--danger)';
      }
    }

    // UTILITIES
    function switchView(view) {
      const btns = document.querySelectorAll('.nav-btn');
      btns.forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      
      if(view === 'home') {
        displayMusic(allMusic);
      } else if(view === 'trending') {
        const sorted = [...allMusic].sort((a, b) => (b.plays || 0) - (a.plays || 0));
        displayMusic(sorted);
      } else if(view === 'library') {
        if(!currentUser) {
          msg('⚠️ Login untuk melihat library!');
          return;
        }
        const myMusic = allMusic.filter(m => m.uploadedBy === currentUser.uid);
        displayMusic(myMusic);
      }
    }

    function msg(text) {
      Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'info',
        title: text,
        showConfirmButton: false,
        timer: 3000,
        background: 'rgba(18, 18, 18, 0.95)',
        color: 'white',
        timerProgressBar: true
      });
    }

    // Click outside modal to close
    window.onclick = function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if(event.target === modal) {
          modal.style.display = 'none';
        }
      });
      
      const notifPanel = document.getElementById('notifPanel');
      if(!event.target.closest('#btnNotif') && !event.target.closest('.notif-panel')) {
        notifPanel.classList.remove('show');
      }
    }
  </script>
</body>
</html>
