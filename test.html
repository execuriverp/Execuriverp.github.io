<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ExeMusic 3.1 - Updated</title>
  <link rel="icon" type="image/png" href="exemusicicon.png">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --accent: #00ff88; 
      --text: #ffffff;
      --text-dim: #b3b3b3;
      --bg: #050505;
      --card-bg: #121212;
      --glass: rgba(255, 255, 255, 0.05);
      --danger: #ff3333;
      --warning: #ffcc00;
      --tiktok-red: #ff0050;
      --gold: #ffd700;
      --purple: #bf00ff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    /* --- ROBLOX STYLE BROADCAST SYSTEM --- */
    .sys-broadcast {
        position: fixed;
        top: -150px; 
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
        background: rgba(15, 15, 15, 0.95);
        border-left: 4px solid var(--accent);
        border-radius: 6px;
        padding: 15px;
        z-index: 12000;
        box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease, transform 0.4s ease;
        backdrop-filter: blur(10px);
    }
    .sys-broadcast.active { top: 20px; }
    
    .sb-content { display: flex; align-items: flex-start; gap: 12px; }
    .sb-icon { font-size: 20px; color: var(--accent); margin-top: 2px; }
    .sb-text h4 { margin: 0; font-size: 14px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
    .sb-text p { margin: 4px 0 0; font-size: 12px; color: #ddd; line-height: 1.4; }
    
    .sb-close {
        position: absolute; top: 10px; right: 10px;
        background: transparent; border: none; color: #666;
        cursor: pointer; font-size: 16px; padding: 5px;
    }
    .sb-close:hover { color: white; }

    .sb-progress {
        width: 100%; height: 3px; background: #333;
        margin-top: 12px; border-radius: 2px; overflow: hidden;
    }
    .sb-bar {
        width: 100%; height: 100%; background: var(--accent);
        transform-origin: left;
    }
    @keyframes countDown { from { transform: scaleX(1); } to { transform: scaleX(0); } }
    @keyframes disco-pulse { 0% { border-color: rgba(255,255,255,0.08); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 50% { border-color: var(--accent); box-shadow: 0 20px 50px var(--accent); } 100% { border-color: rgba(255,255,255,0.08); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } }
    @keyframes disco-heartbeat { 
      0% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 
      20% { transform: scale(1.02); box-shadow: 0 25px 60px var(--accent); } 
      40% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 
      60% { transform: scale(1.03); box-shadow: 0 30px 70px var(--accent); } 
      100% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 
    }
    @keyframes rainbow-glow { 
      0% { border-color: #ff0000; box-shadow: inset 0 0 20px #ff0000, 0 20px 50px #ff000080; } 
      16% { border-color: #ff7f00; box-shadow: inset 0 0 20px #ff7f00, 0 20px 50px #ff7f0080; } 
      33% { border-color: #ffff00; box-shadow: inset 0 0 20px #ffff00, 0 20px 50px #ffff0080; } 
      50% { border-color: #00ff00; box-shadow: inset 0 0 20px #00ff00, 0 20px 50px #00ff0080; } 
      66% { border-color: #0000ff; box-shadow: inset 0 0 20px #0000ff, 0 20px 50px #0000ff80; } 
      83% { border-color: #8b00ff; box-shadow: inset 0 0 20px #8b00ff, 0 20px 50px #8b00ff80; } 
      100% { border-color: #ff0000; box-shadow: inset 0 0 20px #ff0000, 0 20px 50px #ff000080; } 
    }
    @keyframes snowfall { 
      0% { transform: translateY(-10px) translateX(0); opacity: 1; } 
      25% { transform: translateY(25vh) translateX(15px); opacity: 1; }
      50% { transform: translateY(50vh) translateX(-10px); opacity: 1; }
      75% { transform: translateY(75vh) translateX(20px); opacity: 1; }
      100% { transform: translateY(100vh) translateX(0); opacity: 0; } 
    }
    .snowflake { 
      position: fixed; 
      top: -10px; 
      color: #00d4ff; 
      font-size: 1.5em; 
      font-family: Arial, sans-serif; 
      text-shadow: 0 0 5px #00d4ff; 
      z-index: 1;
      pointer-events: none;
      animation: snowfall linear forwards;
    }

    /* --- OVERLAYS --- */
    .full-overlay {
      position: fixed; inset: 0; background: #000; z-index: 10000;
      display: none; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; padding: 30px;
    }
    .full-overlay i { font-size: 60px; margin-bottom: 20px; }
    .full-overlay h1 { font-size: 24px; color: var(--accent); }
    .full-overlay p { color: var(--text-dim); margin-top: 10px; }
    #bannedScreen h1 { color: var(--danger); }

    #loadingCard {
      position: absolute; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: 0.5s;
    }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--glass); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- MAIN APP --- */
    .app {
      background: rgba(18, 18, 18, 0.6);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 35px;
      width: 95%; max-width: 400px; 
      height: 95vh;
      display: flex; flex-direction: column; 
      padding: 25px; 
      position: relative;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; margin-bottom: 15px; }
    .header img { width: 110px; cursor: pointer; transition: 0.3s; }
    .header img:active { transform: scale(0.9); }
    
    .header-right { display: flex; align-items: center; gap: 10px; }
    
    #btnNotif {
      position: relative;
      width: 42px; height: 42px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: 0.2s;
    }
    #btnNotif:hover { background: var(--accent); color: black; border-color: var(--accent); }
    #btnNotif:active { transform: scale(0.95); }
    #btnNotif .notif-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      min-width: 18px;
      height: 18px;
      background: var(--danger);
      border-radius: 9px;
      font-size: 10px;
      font-weight: 700;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    #btnNotif .notif-badge.show { display: flex; }
    
    #topLoginBtn { 
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); 
      color: white; padding: 8px 16px; border-radius: 20px; font-size: 11px; cursor: pointer;
      font-weight: 600; transition: 0.2s;
    }
    #topLoginBtn:hover { background: var(--accent); color: black; border-color: var(--accent); }

    /* Notif/Chat panel - TikTok/ML style */
    .notif-panel {
      position: fixed;
      top: 70px;
      right: 20px;
      width: calc(100vw - 40px);
      max-width: 360px;
      max-height: 70vh;
      background: rgba(24, 24, 24, 0.98);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.6);
      z-index: 2500;
      display: none;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(20px);
      animation: notifPanelIn 0.25s ease;
    }
    .notif-panel.show { display: flex; }
    @keyframes notifPanelIn {
      from { opacity: 0; transform: translateY(-15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .notif-panel-header {
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .notif-panel-header h3 {
      margin: 0;
      font-size: 16px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .notif-panel-close {
      background: none;
      border: none;
      color: #888;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
    }
    .notif-panel-close:hover { color: white; }
    .notif-list {
      overflow-y: auto;
      flex: 1;
      padding: 8px 0;
      min-height: 120px;
      max-height: 60vh;
    }
    .notif-list::-webkit-scrollbar { width: 6px; }
    .notif-list::-webkit-scrollbar-track { background: #111; border-radius: 10px; }
    .notif-list::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    .notif-item {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: background 0.2s;
      cursor: default;
    }
    .notif-item:hover { background: rgba(255,255,255,0.04); }
    .notif-item-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .notif-item-icon.admin { background: rgba(255,51,51,0.2); color: #ff6b6b; }
    .notif-item-icon.violation { background: rgba(255,204,0,0.2); color: var(--warning); }
    .notif-item-icon.upload { background: rgba(0,255,136,0.15); color: var(--accent); }
    .notif-item-icon.follow { background: rgba(255,0,80,0.15); color: var(--tiktok-red); }
    .notif-item-icon.system { background: rgba(0,212,255,0.15); color: #00d4ff; }
    .notif-item-body { flex: 1; min-width: 0; }
    .notif-item-body .n-text { font-size: 13px; color: #ddd; line-height: 1.4; }
    .notif-item-body .n-time { font-size: 11px; color: #666; margin-top: 4px; }
    .notif-empty {
      padding: 30px 20px;
      text-align: center;
      color: #555;
      font-size: 13px;
    }
    @media (max-width: 480px) {
      .notif-panel {
      right: 10px;
      left: 10px;
      width: auto;
      max-width: none;
    }
    }
    
    /* MODERN PROFILE UI */
    .modern-profile-header {
      display: flex; flex-direction: column; align-items: center;
      padding: 30px 20px 20px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.03), transparent);
    }
    .modern-profile-header.vip {
      background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,255,255,0.04));
      position: relative;
      overflow: hidden;
    }
    .modern-profile-header.vip::after {
      content: '';
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.06), transparent 40%),
                  linear-gradient(120deg, rgba(255,215,0,0.08), transparent 60%);
      animation: vipShine 6s linear infinite;
      pointer-events: none;
    }
    @keyframes vipShine {
      0% { transform: translate(0,0) rotate(0deg); }
      50% { transform: translate(10%,10%) rotate(20deg); }
      100% { transform: translate(0,0) rotate(0deg); }
    }
    .mp-avatar-container { position: relative; margin-bottom: 15px; }
    .mp-avatar { 
      width: 90px; height: 90px; border-radius: 50%; 
      object-fit: cover; border: 2px solid var(--accent);
      box-shadow: 0 10px 30px rgba(0,255,136,0.2);
    }
    .modern-profile-header.vip .mp-avatar {
      border-color: #ffd700;
      box-shadow: 0 0 0 3px rgba(255,215,0,0.15), 0 10px 30px rgba(255,215,0,0.25);
    }
    .mp-edit-badge {
      position: absolute; bottom: 0; right: 0;
      background: #222; color: #fff;
      width: 26px; height: 26px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      border: 1px solid rgba(255,255,255,0.2); cursor: pointer; font-size: 12px;
    }
    .mp-name-row { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; justify-content: center; }
    .mp-name { font-size: 18px; font-weight: 700; color: #fff; }
    .mp-handle { font-size: 12px; color: #888; margin-bottom: 12px; }
    .mp-stats { display: flex; gap: 25px; margin-bottom: 20px; }
    .mp-stat-item { text-align: center; cursor: pointer; }
    .mp-stat-val { display: block; font-size: 16px; font-weight: 700; color: #fff; }
    .mp-stat-label { font-size: 10px; color: #888; }
    .mp-actions { 
      display: flex; gap: 8px; width: 100%; margin-bottom: 15px; 
      flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch;
      padding: 6px; border-radius: 10px; 
      background: rgba(255,255,255,0.04); 
      border: 1px solid rgba(255,255,255,0.08);
      justify-content: center;
    }
    .mp-btn { 
      flex: 0 0 auto; padding: 8px 12px; border-radius: 6px; border: none; 
      font-weight: 600; font-size: 12px; cursor: pointer; transition: 0.2s; 
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .mp-btn-primary { background: var(--accent); color: #000; }
    .mp-btn-sec { background: rgba(255,255,255,0.1); color: #fff; }
    .mp-tabs { 
      display: flex; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); 
      margin-bottom: 10px;
    }
    .mp-tab { 
      flex: 1; padding: 12px; text-align: center; color: #666; 
      cursor: pointer; font-size: 12px; font-weight: 600; position: relative; transition: 0.2s;
    }
    .mp-tab.active { color: var(--accent); }
    .mp-tab.active::after {
      content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--accent);
    }
    .mp-list { display: flex; flex-direction: column; gap: 8px; padding: 0 15px 20px; max-height: 300px; overflow-y: auto; }
    .mp-song-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.03);
      cursor: pointer;
    }
    .mp-song-item:hover { background: rgba(255,255,255,0.06); }
    .mp-song-icon { 
      width: 32px; height: 32px; border-radius: 4px; background: rgba(255,255,255,0.1); 
      display: flex; align-items: center; justify-content: center; font-size: 12px; color: #888;
    }
    .mp-song-info { flex: 1; min-width: 0; }
    .mp-song-title { font-size: 12px; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mp-song-artist { font-size: 10px; color: #666; }

    .cover-box {
      flex: 1; width: 100%; border-radius: 25px;
      background: #000; display: flex; align-items: center; justify-content: center;
      margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
      overflow: hidden; position: relative; z-index: 10; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .eq { display: flex; align-items: flex-end; gap: 5px; height: 60px; position: relative; z-index: 15; }
    .eq span { width: 6px; background: var(--accent); border-radius: 10px; height: 10px; transition: height 0.2s ease; box-shadow: 0 0 15px var(--accent); }
    .playing span { animation: wave 0.8s infinite ease-in-out; }
    .playing span:nth-child(1) { animation-delay: 0.1s; }
    .playing span:nth-child(2) { animation-delay: 0.3s; }
    .playing span:nth-child(3) { animation-delay: 0.2s; }
    .playing span:nth-child(4) { animation-delay: 0.4s; }
    @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 50px; } }

    .track-info { margin-bottom: 20px; flex-shrink: 0; text-align: left; }
    #title { font-size: 22px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 5px; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
    
    .user-row { display: flex; align-items: center; gap: 10px; }
    #by { color: var(--accent); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    
    #btnFollow { 
      font-size: 12px; 
      background: var(--tiktok-red); 
      color: white; 
      border: none; 
      width: 22px; height: 22px; 
      border-radius: 50%; 
      font-weight: bold; 
      cursor: pointer; 
      display: none; 
      transition: 0.2s; 
      align-items: center; 
      justify-content: center;
    }
    #btnFollow:active { transform: scale(0.9); }

    .sys-container { background: rgba(255,255,255,0.03); border-radius: 18px; padding: 12px; margin-bottom: 15px; flex-shrink: 0; z-index: 5;}
    .sys-tools { display: flex; justify-content: space-between; margin-bottom: 8px; padding: 0 10px; }
    .sys-tools button { background: none; border: none; color: white; cursor: pointer; font-size: 18px; opacity: 0.7; transition: 0.2s; }
    .sys-tools button:hover { opacity: 1; transform: translateY(-2px); color: var(--accent); }
    
    .vol-row { display: flex; align-items: center; gap: 10px; padding: 0 5px; }
    #vol { flex: 1; height: 4px; accent-color: var(--accent); cursor: pointer; border-radius: 2px; }

    .prog-area { margin-bottom: 20px; flex-shrink: 0; z-index: 5; }
    #seek { width: 100%; height: 5px; accent-color: var(--accent); cursor: pointer; display: block; border-radius: 2px; }
    .time { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-dim); margin-top: 6px; font-weight: 500; position: relative; align-items: center; }
    
    /* LOADING SPINNER */
    .loading-spinner {
      width: 12px;
      height: 12px;
      border: 2px solid rgba(0, 255, 136, 0.3);
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
      margin: 0 auto;
    }
    .loading-spinner.show { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .dur-wrapper { display: flex; align-items: center; gap: 6px; }

    .main-ctrl { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-bottom: 20px; flex-shrink: 0; position: relative; z-index: 110; }
    .btn-play { width: 65px; height: 65px; background: var(--accent); border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-size: 24px; cursor: pointer; box-shadow: 0 0 25px rgba(0, 255, 136, 0.4); transition: 0.2s; }
    .btn-play:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(0, 255, 136, 0.4); }
    .btn-sec { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 10px; opacity: 0.9; }
    .btn-sec:active { transform: scale(0.9); }

    .footer { margin-top: auto; display: flex; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 15px 30px; border-radius: 25px; flex-shrink: 0; z-index: 10; }
    .footer button { background: none; border: none; color: white; font-size: 18px; opacity: 0.5; cursor: pointer; transition: 0.2s; }
    .footer button:hover { opacity: 1; }
    
    .active { color: var(--accent) !important; opacity: 1 !important; text-shadow: 0 0 10px var(--accent); }

    /* MODALS */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 2000; backdrop-filter: blur(5px); }
    .sheet { position: absolute; bottom: 0; width: 100%; max-width: 400px; left: 50%; transform: translateX(-50%); background: #181818; border-radius: 30px 30px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); border-top: 1px solid #333; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }

    .song-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-radius: 8px; transition: 0.2s; }
    .song-item:hover { background: rgba(255,255,255,0.05); }
    
    #toast { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) translateY(20px); background: #222; border: 1px solid var(--accent); color: var(--accent); padding: 12px 25px; border-radius: 50px; font-size: 13px; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 3000; pointer-events: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .inp-dark { width:100%; padding:14px; margin-bottom:12px; background:#0a0a0a; color:white; border:1px solid #333; border-radius: 12px; font-size: 14px; }
    .inp-dark:focus { border-color: var(--accent); }
    .btn-act { width:100%; padding:14px; background:var(--accent); border:none; border-radius:12px; font-weight:bold; color:black; cursor: pointer; margin-top: 5px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
    
    .prof-stat { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
    .prof-stat div { text-align: center; }
    .prof-stat b { display: block; font-size: 20px; color: white; }
    .prof-stat span { font-size: 11px; color: var(--text-dim); text-transform: uppercase; }
    .section-title { font-size: 12px; font-weight: bold; margin: 20px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

    /* PROFILE TAB STYLES */
    .profile-tabs-wrapper { display: flex; gap: 0; margin: 20px -25px 0 -25px; border-bottom: 2px solid #222; }
    .profile-tab-btn { 
      flex: 1; 
      background: transparent; 
      border: none; 
      color: #666; 
      padding: 15px 20px; 
      cursor: pointer; 
      border-bottom: 3px solid transparent;
      text-transform: uppercase; 
      font-weight: 600; 
      font-size: 12px;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      position: relative;
    }
    .profile-tab-btn:hover { color: #999; }
    .profile-tab-btn.active { 
      color: var(--accent); 
      border-bottom-color: var(--accent);
    }

    .profile-tab-content { 
      display: none; 
      padding: 25px 0;
      animation: fadeIn 0.3s ease;
    }
    .profile-tab-content.active { display: block; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* PROFILE GRID IMPROVEMENTS */
    .profile-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 25px 0;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 15px;
      border: 1px solid #333;
    }
    .profile-stat-item {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      background: transparent;
      transition: all 0.2s ease;
      border: none;
    }
    .profile-stat-item:hover {
      background: transparent;
      transform: translateY(-2px);
      border-color: transparent;
    }
    .profile-stat-item b { 
      display: block; 
      font-size: 24px; 
      color: #fff;
      margin-bottom: 5px;
    }
    .profile-stat-item span { 
      font-size: 11px; 
      color: var(--text-dim); 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ACCOUNT SETTINGS STYLES */
    .account-setting-box {
      padding: 18px;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.03);
      border: 1px solid #333;
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .account-setting-box:hover {
      background: rgba(255,255,255,0.05);
      border-color: #444;
    }
    .account-setting-label {
      color: var(--accent);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: block;
    }
    .account-setting-value {
      color: #ddd;
      font-size: 13px;
      word-break: break-all;
      margin-bottom: 12px;
      padding: 12px;
      background: #0a0a0a;
      border-radius: 8px;
      border: 1px solid #222;
      font-family: 'Courier New', monospace;
    }

    /* RESPONSIVE POST LIST */
    .posts-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; }
    .posts-list::-webkit-scrollbar { width: 6px; }
    .posts-list::-webkit-scrollbar-track { background: #0a0a0a; border-radius: 10px; }
    .posts-list::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    .posts-list::-webkit-scrollbar-thumb:hover { background: #00dd7a; }

    /* BUTTON IMPROVEMENTS */
    .btn-account {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      font-weight: 600;
      color: black;
      cursor: pointer;
      margin-bottom: 10px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s ease;
    }
    .btn-account:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px var(--accent);
    }
    .btn-account:active {
      transform: translateY(0);
    }
    .btn-account.danger {
      background: #ff6b6b;
    }
    .btn-account.danger:hover {
      box-shadow: 0 8px 20px #ff6b6b40;
    }
    .btn-account.logout {
      background: #222;
      color: #ff6b6b;
      border: 1px solid #333;
    }
    .btn-account.logout:hover {
      background: #1a1a1a;
      border-color: #ff6b6b;
      box-shadow: 0 8px 20px #ff6b6b20;
    }

    /* MODAL MESSAGE STYLES */
    .modal-msg {
      text-align: center;
      font-size: 12px;
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      display: none;
    }
    .modal-msg.show { display: block; }
    .modal-msg.success {
      color: var(--accent);
      background: rgba(0,255,136,0.1);
      border: 1px solid #00dd7a;
    }
    .modal-msg.error {
      color: #ff6b6b;
      background: rgba(255,107,107,0.1);
      border: 1px solid #ff6b6b;
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 480px) {
      .spotify-banner {
        height: 100px;
        margin: -25px -25px 15px -25px;
        padding: 15px;
      }
      .spotify-avatar {
        width: 70px;
        height: 70px;
      }
    }

    /* === NEW FEATURES CSS === */
    #btnFav {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }
    #btnFav:hover { color: var(--accent); transform: scale(1.1); }
    #btnFav.active { color: var(--tiktok-red); animation: heartBeat 0.3s ease-in-out; }
    @keyframes heartBeat { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

    /* TOAST NOTIFICATION */
    #toast-container {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 99999;
      pointer-events: none;
    }
    .toast {
      background: rgba(18, 18, 18, 0.9);
      border: 1px solid rgba(255,255,255,0.1);
      border-left: 3px solid var(--accent);
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      animation: toastIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      backdrop-filter: blur(5px);
    }
    .toast.hide {
      animation: toastOut 0.3s forwards;
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toastOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }
    @media (max-width: 480px) {
      .spotify-info {
        margin-left: 12px;
      }
      .spotify-info h2 {
        font-size: 18px;
      }
      .profile-stats-grid {
        grid-template-columns: 1fr;
        margin: 20px 0;
        padding: 15px;
        gap: 15px;
      }
      .profile-stats-grid b {
        font-size: 20px;
      }
      .profile-tabs-wrapper {
        margin: 15px -25px 0 -25px;
      }
      .profile-tab-btn {
        padding: 12px 15px;
        font-size: 11px;
      }
      .profile-tab-content {
        padding: 20px 0;
      }
      .account-setting-box {
        padding: 14px;
        margin-bottom: 12px;
      }
      .btn-account {
        padding: 12px;
        font-size: 12px;
        margin-bottom: 8px;
      }
      .posts-list {
        max-height: 200px;
      }
    }

    @media (min-width: 481px) and (max-width: 768px) {
      .profile-stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      .spotify-banner {
        height: 110px;
      }
    }

    @media (min-width: 769px) {
      .profile-stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .v-badge { color: #1da1f2; font-size: 12px; margin-left: 4px; }

    .spotify-banner {
      width: 100%; height: 120px;
      background: linear-gradient(to bottom, var(--accent), #181818);
      margin: -25px -25px 20px -25px;
      border-radius: 30px 30px 0 0;
      display: flex; align-items: flex-end; padding: 20px;
      position: relative;
    }
    .spotify-avatar {
      width: 80px; height: 80px; background: #222; 
      border-radius: 50%; box-shadow: 0 8px 25px rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center; font-size: 30px;
      border: 3px solid #181818;
      overflow: hidden;
      position: relative;
    }
    .spotify-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-edit {
        position: absolute; inset: 0; background: rgba(0,0,0,0.5);
        display: none; align-items: center; justify-content: center;
        font-size: 14px; cursor: pointer; color: white;
    }
    .spotify-avatar:hover .avatar-edit { display: flex; }

    .spotify-info { margin-left: 15px; }
    .spotify-info h2 { font-size: 24px; margin: 0; }
    
    /* Updated Tag Styles */
    .user-tag {
      font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 800;
      text-transform: uppercase; margin-left: 5px; vertical-align: middle; letter-spacing: 0.5px;
    }
    .tag-admin { background: #ff3333; color: #fff; }
    .tag-velly\2665\FE0F { background: gold; color: #000; animation: pulse 2s infinite; }
    .tag-staff { background: #0088ff; color: #fff; }
    .tag-executive { background: #aa00ff; color: #fff; }
    .tag-user { background: #444; color: #eee; }
    .tag-sepuh { background: #1a1a1a; color: var(--accent); border: 1px solid var(--accent); }
    .tag-rich { background: linear-gradient(45deg, gold, #fff); color: #000; }
    .tag-galau { background: #555; color: #fff; font-style: italic; }
    .tag-cheater { background: #ff0050; color: #fff; text-decoration: line-through; }
    .tag-vvip { background: var(--purple); color: #fff; box-shadow: 0 0 10px var(--purple); }
    
    /* New Fun Tags */
    .tag-owner { background: #00ff88; color: #000; border: 1px solid #fff; box-shadow: 0 0 10px #00ff88; font-weight: 900; }
    .tag-developer { background: #000; color: #00ff00; border: 1px solid #00ff00; font-family: 'Courier New', monospace; letter-spacing: 1px; }
    .tag-sultan { background: linear-gradient(135deg, #ffd700, #fbf5b7, #ffd700); color: #000; border: 1px solid #b8860b; font-weight: bold; }
    .tag-wibu { background: #ff69b4; color: #fff; border: 1px solid #ff1493; }
    .tag-sadboy { background: #000080; color: #add8e6; border: 1px solid #add8e6; font-style: italic; }
    .tag-hacker { background: #000; color: #0f0; text-shadow: 0 0 5px #0f0; font-family: 'Courier New', monospace; }
    .tag-verified { background: #1da1f2; color: #fff; border: 1px solid #fff; }
    .tag-bot { background: #708090; color: #fff; border: 1px solid #a9a9a9; }
    .tag-npc { background: #d3d3d3; color: #000; }
    .tag-dj { background: #ff00ff; color: #fff; box-shadow: 0 0 8px #ff00ff; }
    .tag-pro { background: #ff4500; color: #fff; font-weight: bold; border: 1px solid #fff; }
    .tag-noob { background: #8b4513; color: #fff; border: 1px dashed #deb887; }
    .tag-top-global { background: linear-gradient(90deg, #00c6ff, #0072ff); color: #fff; font-weight: bold; box-shadow: 0 0 5px #00c6ff; }
    .tag-premium { background: linear-gradient(45deg, #8a2387, #e94057, #f27121); color: #fff; font-weight: bold; }
    .tag-influencer { background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d); color: #fff; }

    
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }

    /* About Modal Styling */
    .about-box { font-size: 13px; line-height: 1.6; color: #ccc; }
    .about-box h3 { color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
    .about-box p { margin-bottom: 10px; }
    .about-box b { color: #fff; }
    .about-features { margin: 8px 0 12px 18px; padding: 0; }
    .about-features li { margin-bottom: 8px; }
    .about-footer { font-size: 12px; color: #888; margin-top: 8px; }
    .about-credit { font-size: 12px; color: #666; margin-top: 8px; }
    .about-dev-link { color: #00d4ff; font-weight: 700; text-decoration: none; text-shadow: 0 0 10px #00d4ff; transition: color 0.2s, text-shadow 0.2s; }
    .about-dev-link:hover { color: #7df9ff; text-shadow: 0 0 15px #7df9ff; }
    .rules-warn { background: rgba(255, 51, 51, 0.1); border-left: 3px solid var(--danger); padding: 10px; margin: 10px 0; border-radius: 4px; }

    /* Broadcast: exit animation & developer name */
    .sys-broadcast.sb-closing {
      top: -180px !important;
      opacity: 0;
      transform: translateX(-50%) translateY(-15px);
      transition: top 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease, transform 0.4s ease;
    }
    .sb-text p .sb-dev-name {
      color: #00d4ff;
      font-weight: 700;
      text-shadow: 0 0 8px #00d4ff;
      display: inline;
    }
    .event-card {
      background: linear-gradient(180deg, rgba(24,24,24,0.95) 0%, rgba(18,18,18,0.95) 100%);
      border: 1px solid rgba(255,255,255,0.08);
      border-left: 4px solid var(--accent);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,255,136,0.08);
      position: relative;
      overflow: hidden;
    }
    .event-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cg fill='none' stroke='%23ffd700' stroke-width='2' opacity='0.12'%3E%3Cpath d='M60 10 l20 20 -20 20 -20 -20z'/%3E%3Cpath d='M20 50 l20 20 -20 20 -20 -20z'/%3E%3Cpath d='M100 50 l20 20 -20 20 -20 -20z'/%3E%3Cpath d='M60 90 l20 20 -20 20 -20 -20z'/%3E%3C/g%3E%3C/svg%3E");
      background-size: 140px 140px;
      background-repeat: repeat;
      background-position: center;
      opacity: 0.35;
      filter: saturate(1.2);
      pointer-events: none;
    }
    .countdown-wrap {
      display: flex; gap: 12px; justify-content: center; align-items: center; margin: 10px 0 14px;
    }
    .count-item {
      min-width: 64px; padding: 10px; border-radius: 12px; 
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      text-align: center;
      box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    }
    .count-val { font-size: 20px; font-weight: 800; color: #fff; }
    .count-lbl { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .mini-row { display:flex; justify-content:center; gap:10px; align-items:center; font-size:12px; color:#aaa; margin-top:4px; }
    .mini-badge { display:inline-flex; align-items:center; gap:6px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); padding:6px 10px; border-radius:999px; }
    .claim-btn {
      width:100%; padding:14px; background: linear-gradient(90deg, #ffd700, #fbf5b7); color:#000; border:none; border-radius:12px; font-weight:800; cursor:pointer; letter-spacing:0.5px; box-shadow: 0 10px 30px rgba(255,215,0,0.25);
    }
    .vip-bg-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px; padding:0 15px; }
    .vip-trial-timer { margin-top: 8px; }
    .shop-item { 
      padding:12px; border-radius:16px; 
      background: linear-gradient(180deg, rgba(28,28,28,0.96), rgba(20,20,20,0.96));
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 12px 35px rgba(0,0,0,0.6), inset 0 0 18px rgba(255,215,0,0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      position: relative; overflow: hidden;
    }
    .shop-item::before {
      content:'';
      position:absolute; inset:0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cg fill='none' stroke='%23ffd700' stroke-width='2' opacity='0.08'%3E%3Cpath d='M60 10 l20 20 -20 20 -20 -20z'/%3E%3C/g%3E%3C/svg%3E");
      background-size: 120px 120px; background-repeat: repeat;
      pointer-events:none;
    }
    .shop-item:hover { transform: translateY(-2px); box-shadow: 0 18px 45px rgba(0,0,0,0.7), inset 0 0 24px rgba(255,215,0,0.12); border-color: rgba(255,215,0,0.3); }
    .shop-item-head { display:flex; align-items:center; justify-content:space-between; width:100%; margin-bottom:10px; }
    .shop-item-title { font-weight:800; color:#fff; letter-spacing:0.3px; }
    .shop-price { font-size:12px; color:#000; background: linear-gradient(90deg, #ffd700, #fbf5b7); border: 1px solid rgba(255,215,0,0.45); border-radius:999px; padding:4px 10px; font-weight:800; box-shadow: 0 6px 18px rgba(255,215,0,0.25); }
    .shop-action { 
      width:100%; padding:12px; 
      background: linear-gradient(90deg, #ffd700, #fbf5b7); 
      color:#000; border:none; border-radius:10px; font-weight:800; cursor:pointer; 
      box-shadow: 0 10px 30px rgba(255,215,0,0.25);
    }
    .claim-btn:active { transform: scale(0.98); }
    .shop-btn {
      width:100%; padding:12px; background:#222; color:#fff; border:1px solid #333; border-radius:12px; font-weight:700; cursor:pointer;
    }
    .gift-anim {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); animation: fadeIn 0.2s ease;
    }
    .gift-box {
      width: 120px; height: 120px; border-radius: 18px; background: linear-gradient(135deg, #ff4d4d, #ffcc00); box-shadow: 0 15px 40px rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; color:#000; font-size:42px; animation: giftPop 0.8s ease forwards;
    }
    @keyframes giftPop { 0% { transform: scale(0.7) rotate(-8deg); opacity: 0; } 60% { transform: scale(1.1) rotate(3deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); } }
    @keyframes flipDown { 0% { transform: rotateX(0deg); } 50% { transform: rotateX(40deg); } 100% { transform: rotateX(0deg); } }
    .shop-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; }
    .shop-item { padding:10px; border-radius:12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); display:flex; flex-direction:column; gap:8px; align-items:center; text-align:center; }
    .shop-action { width:100%; padding:10px; background: var(--accent); color:#000; border:none; border-radius:8px; font-weight:700; cursor:pointer; }
    .shop-row { display:flex; gap:8px; align-items:center; }
    .shop-select { flex:1; }
    @media (max-width: 480px) { .shop-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); } }
    #btnEvent {
      position: relative;
      width: 46px; height: 46px;
      background: radial-gradient(120% 120% at 50% 50%, rgba(0,255,136,0.15) 0%, rgba(0,0,0,0.2) 60%);
      border: 2px solid var(--accent);
      border-radius: 50%;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: 0.2s;
      box-shadow: 0 0 18px rgba(0,255,136,0.35), inset 0 0 12px rgba(0,255,136,0.15);
      overflow: hidden;
    }
    #btnEvent::after {
      content: "";
      position: absolute;
      top: -40%; left: -40%;
      width: 180%; height: 180%;
      background: linear-gradient(120deg, transparent 40%, rgba(255,255,255,0.18) 50%, transparent 60%);
      transform: rotate(25deg);
      pointer-events: none;
    }
    #btnEvent:hover { transform: scale(1.05); box-shadow: 0 0 24px rgba(0,255,136,0.55), inset 0 0 16px rgba(0,255,136,0.25); }
    #btnEvent:active { transform: scale(0.97); }
  </style>
</head>
<body>

  <div id="sysBroadcast" class="sys-broadcast">
      <button class="sb-close" onclick="closeBroadcast()"><i class="fas fa-times"></i></button>
      <div class="sb-content">
          <i class="fas fa-bullhorn sb-icon"></i>
          <div class="sb-text">
              <h4>Announcement</h4>
              <p id="sbMessage">Loading message...</p>
          </div>
      </div>
      <div class="sb-progress"><div id="sbBar" class="sb-bar"></div></div>
  </div>

  <div class="modal" id="modalKetupatShop" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <div class="event-card">
        <div style="text-align:center; margin-bottom:10px; color:#fff; font-weight:800"><i class="fas fa-store"></i> Toko Ketupat</div>
        <div class="shop-grid">
          <div class="shop-item">
            <div class="shop-item-head"><div class="shop-item-title">Tag Ramadhan</div><div class="shop-price">10ðŸ’ </div></div>
            <button class="shop-action" onclick="exchangeTag('ramadhan',10)">Tukar</button>
          </div>
          <div class="shop-item">
            <div class="shop-item-head"><div class="shop-item-title">Tag Sepuh</div><div class="shop-price">10ðŸ’ </div></div>
            <button class="shop-action" onclick="exchangeTag('sepuh',10)">Tukar</button>
          </div>
          <div class="shop-item">
            <div class="shop-item-head"><div class="shop-item-title">Tag Pro</div><div class="shop-price">10ðŸ’ </div></div>
            <button class="shop-action" onclick="exchangeTag('pro',10)">Tukar</button>
          </div>
          <div class="shop-item">
            <div class="shop-item-head"><div class="shop-item-title">Background Merah</div><div class="shop-price">50ðŸ’ </div></div>
            <button class="shop-action" onclick="exchangeBg('red',50)">Tukar</button>
          </div>
          <div class="shop-item">
            <div class="shop-item-head"><div class="shop-item-title">Background Biru</div><div class="shop-price">50ðŸ’ </div></div>
            <button class="shop-action" onclick="exchangeBg('blue',50)">Tukar</button>
          </div>
          <div class="shop-item">
            <div class="shop-item-head"><div class="shop-item-title">Background Hijau</div><div class="shop-price">50ðŸ’ </div></div>
            <button class="shop-action" onclick="exchangeBg('green',50)">Tukar</button>
          </div>
          <div class="shop-item">
            <div class="shop-item-head"><div class="shop-item-title">Background Ungu</div><div class="shop-price">50ðŸ’ </div></div>
            <button class="shop-action" onclick="exchangeBg('purple',50)">Tukar</button>
          </div>
          <div class="shop-item" style="grid-column: 1 / -1">
            <div class="shop-item-head"><div class="shop-item-title">VIP Trial</div><div class="shop-price">100ðŸ’ /Hari</div></div>
            <div class="shop-row">
              <select id="vipDaysSel" class="inp-dark shop-select">
                <option value="1">VIP Trial 1 Hari (100ðŸ’ )</option>
                <option value="2">VIP Trial 2 Hari (200ðŸ’ )</option>
                <option value="3">VIP Trial 3 Hari (300ðŸ’ )</option>
              </select>
              <button class="shop-action" onclick="exchangeVipTrial()">Tukar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="mtScreen" class="full-overlay">
    <i class="fas fa-tools" style="color: var(--accent)"></i>
    <h1>Server Maintenance</h1>
    <p>Kami sedang melakukan pembaruan sistem.<br>Mohon tunggu beberapa saat lagi.</p>
  </div>

  <div id="bannedScreen" class="full-overlay">
    <i class="fas fa-user-slash" style="color: var(--danger)"></i>
    <h1>Access Denied</h1>
    <p>Akun anda telah diblokir secara permanen oleh admin.</p>
  </div>

  <div id="loadingCard"><div class="spinner"></div></div>
  <div id="toast">Notification</div>

  <div class="app">
    <div class="header">
        <img src="exemusic.png" alt="Logo" onclick="openAbout()">
        <div class="header-right">
          <button id="btnEvent" onclick="openEvent()" title="Event">
            <span style="font-size:20px">ðŸ’ </span>
            <span id="eventBadge" class="notif-badge"></span>
          </button>
          <button id="btnNotif" onclick="toggleNotifPanel()" title="Notifikasi">
            <i class="fas fa-bell"></i>
            <span id="notifBadge" class="notif-badge"></span>
          </button>
          <button id="topLoginBtn" onclick="openProfile()">Log-in</button>
        </div>
    </div>

    

    <div id="notifPanel" class="notif-panel">
      <div class="notif-panel-header">
        <h3><i class="fas fa-comment-dots"></i> Notifikasi</h3>
        <button class="notif-panel-close" onclick="openClearNotifConfirm()" style="margin-right:8px"><i class="fas fa-trash"></i></button>
        <button class="notif-panel-close" onclick="closeNotifPanel()"><i class="fas fa-times"></i></button>
      </div>
      <div id="notifList" class="notif-list">
        <div class="notif-empty">Memuat...</div>
      </div>
    </div>

    <div class="cover-box">
      <div class="eq" id="eq"><span></span><span></span><span></span><span></span><span></span></div>
    </div>

    <div class="track-info">
      <div id="title">Loading Lagu...</div>
      <div class="user-row">
        <div id="by" onclick="viewCreator()">@system</div>
        <button id="btnFav" onclick="toggleFavorite()"><i class="far fa-heart"></i></button>
        <button id="btnFollow" onclick="followUser()"><i class="fas fa-plus"></i></button>
      </div>
    </div>

    <div class="sys-container">
      <div class="sys-tools">
        <button onclick="copyRawUrl()" title="Copy Url"><i class="fas fa-link"></i></button>
        <button onclick="openCopyLink()" title="Share Link"><i class="fas fa-share-alt"></i></button>
        <button onclick="downloadSong()" title="Download"><i class="fas fa-download"></i></button>
        <button onclick="openReq()" title="Add/Request"><i class="fas fa-plus-circle"></i></button>
      </div>
      <div class="vol-row">
        <i class="fas fa-volume-down" style="font-size:12px; color:#888"></i>
        <input type="range" id="vol" min="0" max="1" step="0.01" value="0.8">
        <i class="fas fa-volume-up" style="font-size:12px; color:#fff"></i>
      </div>
    </div>

    <div class="prog-area">
      <input type="range" id="seek" value="0">
      <div class="time">
        <span id="cur">0:00</span>
        <div class="dur-wrapper">
          <div class="loading-spinner" id="loadSpinner"></div>
          <span id="dur">0:00</span>
        </div>
      </div>
    </div>

    <div class="main-ctrl">
      <button class="btn-sec" onclick="prev()"><i class="fas fa-step-backward"></i></button>
      <button class="btn-play" onclick="toggle()" id="playBtn"><i class="fas fa-play"></i></button>
      <button class="btn-sec" onclick="next()"><i class="fas fa-step-forward"></i></button>
    </div>

    <div class="footer">
      <button id="shuf" onclick="toggleShuffle()"><i class="fas fa-random"></i></button>
      <button onclick="openList(false)"><i class="fas fa-list-ul"></i></button>
      <button onclick="openList(true)"><i class="fas fa-heart"></i></button>
      <button id="adminBtn" style="display:none; color:gold" onclick="openAdmin()"><i class="fas fa-shield-alt"></i></button>
      <button id="rep" onclick="toggleRepeat()"><i class="fas fa-redo"></i></button>
    </div>
  </div>

  <div class="modal" id="modalAuth" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 id="authTitle" style="text-align:center; margin-bottom:20px; color:var(--accent)">Login ke ExeMusic</h3>
      <div id="usernameSection" style="display:none; margin-bottom:15px;">
        <p style="font-size:12px; color:#888; text-align:center; margin-bottom:10px;">ðŸ‘‹ Selamat datang! Buat username Anda:</p>
        <input id="authUser" class="inp-dark" placeholder="Username (min 3 karakter)">
      </div>
      <button onclick="handleGoogleAuth()" id="googleAuthBtn" class="btn-act" style="background:#fff; color:#000; display:flex; align-items:center; justify-content:center; gap:10px; font-weight:600;">
        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
        <span id="googleBtnText">Masuk dengan Google</span>
      </button>
      <p style="font-size:11px; color:#888; text-align:center; margin-top:15px;">ðŸ”’ Login aman dengan akun Google Anda</p>
    </div>
  </div>

  <div class="modal" id="modalProfile" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet" style="padding:0; overflow:hidden">
      <div class="modern-profile-header">
        <div class="mp-avatar-container">
          <img id="pAvatarImg" src="https://via.placeholder.com/150" class="mp-avatar">
          <div class="mp-edit-badge" onclick="document.getElementById('avatarInp').click()"><i class="fas fa-camera"></i></div>
        </div>
        <input type="file" id="avatarInp" style="display:none" accept="image/*" onchange="uploadAvatar(this)">
        
        <div class="mp-name-row">
          <span id="pUsername" class="mp-name">User</span>
          <span id="pBadge"></span>
        </div>
        <span id="pEmail" class="mp-handle">user@email.com</span>
        <div id="pTagDisplay" style="margin-bottom:12px"></div>

        <div class="mp-stats">
          <div class="mp-stat-item">
            <span id="pFol" class="mp-stat-val">0</span>
            <span class="mp-stat-label">Followers</span>
          </div>
          <div class="mp-stat-item">
            <span id="pFollowing" class="mp-stat-val">0</span>
            <span class="mp-stat-label">Following</span>
          </div>
        </div>

        <div class="mp-actions">
           <button class="mp-btn mp-btn-sec" onclick="openChangeNameModal()"><i class="fas fa-edit"></i> Edit</button>
           <button class="mp-btn mp-btn-sec" onclick="openChangePasswordModal()"><i class="fas fa-lock"></i> Pass</button>
           <button class="mp-btn mp-btn-sec" onclick="shareProfile(auth.currentUser && auth.currentUser.uid, userData && userData.username)"><i class="fas fa-share"></i> Share Profile</button>
           <button class="mp-btn mp-btn-primary" style="background:var(--danger); color:#fff" onclick="auth.signOut(); location.reload()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        <div style="font-size:11px; color:#888; margin-top:8px" id="pVipStatus">Status VIP: NONVIP</div>
        <div id="vipTrialTimer" class="countdown-wrap vip-trial-timer" style="display:none">
          <div class="count-item"><div id="vipDays" class="count-val">0</div><div class="count-lbl">Hari</div></div>
          <div class="count-item"><div id="vipHours" class="count-val">0</div><div class="count-lbl">Jam</div></div>
          <div class="count-item"><div id="vipMinutes" class="count-val">0</div><div class="count-lbl">Menit</div></div>
        </div>
        <div id="vipBgRow" class="vip-bg-row" style="display:none">
          <input id="vipBgPicker" type="color" value="#ffd700" class="inp-dark">
          <button class="mp-btn mp-btn-primary" onclick="saveVipBgColor()">Simpan BG VIP</button>
        </div>
      </div>

      <div class="mp-tabs">
        <div class="mp-tab active" onclick="switchProfileTab('posts')" id="tabPosts">MY UPLOADS</div>
        <div class="mp-tab" onclick="switchProfileTab('likes')" id="tabLikes">FAVORITES</div>
      </div>

      <div id="myPostList" class="mp-list"></div>
      <div id="myLikeList" class="mp-list" style="display:none"></div>
    </div>
  </div>

  <div class="modal" id="modalChangeNames" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:20px; color:var(--accent); font-size:16px;">âœï¸ Ubah Nama Pengguna</h3>
      <input id="cnPass" type="password" class="inp-dark" placeholder="Password Saat Ini">
      <input id="cnNewName" class="inp-dark" placeholder="Nama Pengguna Baru">
      <button onclick="handleChangeName()" class="btn-act">Ubah Nama</button>
      <div id="cnMsg" class="modal-msg"></div>
    </div>
  </div>

  <div class="modal" id="modalChangePass" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:20px; color:var(--accent); font-size:16px;">ðŸ” Ubah Password</h3>
      <input id="cpOldPass" type="password" class="inp-dark" placeholder="Password Lama">
      <input id="cpNewPass" type="password" class="inp-dark" placeholder="Password Baru (Min. 6 karakter)">
      <input id="cpConfirm" type="password" class="inp-dark" placeholder="Konfirmasi Password Baru">
      <button onclick="handleChangePassword()" class="btn-act">Ubah Password</button>
      <div id="cpMsg" class="modal-msg"></div>
    </div>
  </div>

  <div class="modal" id="modalCreator" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet" style="padding:0; overflow:hidden">
      <div class="modern-profile-header">
        <div class="mp-avatar-container">
          <img id="vAvatarImg" src="https://via.placeholder.com/150" class="mp-avatar">
        </div>
        
        <div class="mp-name-row">
          <span id="vName" class="mp-name">@creator</span>
        </div>
        <div id="vTagDisplay" style="margin-bottom:12px; display:flex; gap:5px; justify-content:center"></div>

        <div class="mp-stats">
          <div class="mp-stat-item" onclick="openCreatorFollowers()">
            <span id="vFol" class="mp-stat-val">0</span>
            <span class="mp-stat-label">Followers</span>
          </div>
          <div class="mp-stat-item" onclick="openCreatorFollowing()">
            <span id="vFollowing" class="mp-stat-val">0</span>
            <span class="mp-stat-label">Following</span>
          </div>
        </div>

        <div class="mp-actions" style="justify-content:center">
           <button id="vCreatorFollowBtn" class="mp-btn mp-btn-primary" onclick="followCreator()" style="max-width:120px">Follow</button>
           <button class="mp-btn mp-btn-sec" onclick="shareProfile(document.getElementById('modalCreator').dataset.creatorUid, document.getElementById('vName').textContent)"><i class="fas fa-share"></i> Share</button>
        </div>
      </div>

      <div style="padding:15px 15px 5px; font-size:12px; color:#888; font-weight:600">UPLOADED SONGS</div>
      <div id="creatorPostList" class="mp-list"></div>
    </div>
  </div>

  

  <div class="modal" id="modalReq" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent)">Upload Lagu</h3>
      <div class="rules-warn" style="font-size: 11px; margin-bottom: 15px;">
          <b>âš ï¸ PERHATIAN:</b> Dilarang mengupload konten SARA, pornografi audio, atau lagu earrape yang merusak telinga. Pelanggaran akan mengakibatkan <b>BANNED PERMANENT</b> tanpa peringatan!
      </div>
      <div id="uploadFormUser" style="display:none">
          <!-- URL Upload Form Only -->
          <div id="urlUploadForm" style="display:block;">
            <p style="font-size:12px; color:#888; margin-bottom:10px;">Upload lagu menggunakan link direct dari Top4Top atau penyedia file hosting lainnya.</p>
            <input id="rLagu" class="inp-dark" placeholder="Judul Lagu - Artist">
            <input id="rUrl" class="inp-dark" placeholder="Link MP3 (Top4Top Only)">
            <button onclick="confirmAndSave()" class="btn-act">POST SEKARANG</button>
          </div>
      </div>
      <div id="uploadFormGuest">
          <input id="guestName" class="inp-dark" placeholder="Nama Anda">
          <input id="guestLagu" class="inp-dark" placeholder="Judul Lagu - Artist">
          <input id="guestUrl" class="inp-dark" placeholder="Link MP3 Top4Top">
          <button onclick="sendWA()" class="btn-act" style="background:#25D366; color:white">WHATSAPP REQUEST</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalList" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet"><div id="songContainer"></div></div>
  </div>

  <div class="modal" id="modalAbout" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <div class="about-box">
        <h3>ðŸŽµ ExeMusic 3.1 Version</h3>
        <p>Selamat datang di exemusic. Website ini dirancang khusus untuk para creator url yang ingin berbagi dan menikmati musik berkualitas tinggi dengan komunitas yang solid.</p>
        
        <p><b>Fitur Unggulan Platform</b></p>
        <ul class="about-features">
          <li><b>High-Fidelity Audio Streaming</b> â€“ Nikmati streaming musik dengan kualitas audio lossless tanpa kompresi berlebihan</li>
          <li><b>Smart Social System</b> â€“ Follow creator favorit Anda dan bangun komunitas musik dengan sistem following yang terintegrasi</li>
          <li><b>Dynamic Badge System</b> â€“ Dapatkan badge verifikasi otomatis saat mencapai 50+ followers sebagai tanda kreator original (bisa request ke admin)</li>
          <li><b>Deep Linking Technology</b> â€“ Bagikan lagu spesifik dengan ID unik langsung ke teman via link khusus</li>
          <li><b>Anti-Spam Protection</b> â€“ Sistem cooldown menjaga kualitas konten (VIP 15 menit, Non-VIP 30 menit)</li>
          <li><b>Real-time Sync System</b> â€“ Semua data followers, likes, dan playlist tersinkronisasi secara real-time</li>
          <li><b>Cloud-Based Infrastructure</b> â€“ Data tersimpan aman di database dengan backup otomatis</li>
          <li><b>Multi-Device Support</b> â€“ Akses dari desktop, mobile, atau tablet dengan pengalaman yang konsisten</li>
        </ul>

        <p><b>Cara Upload Musik</b></p>
        <p><b>Untuk User yang Sudah Login:</b><br>
        Anda dapat langsung mengupload musik dengan menekan tombol + (Add/Request), kemudian masukkan judul lagu dan link MP3 dari Top4Top. Setelah submit, lagu Anda akan langsung tersedia di platform dan dapat didengarkan oleh semua user.</p>
        <p><b>Untuk Guest (Belum Login):</b><br>
        Jika Anda belum memiliki akun, Anda masih bisa request upload dengan mengirim detail lagu via WhatsApp ke admin. Setelah admin meninjau dan menyetujui, lagu Anda akan diupload ke platform dengan kredit nama Anda.</p>

        <p><b>Program Reward & Incentive</b></p>
        <p>Kami menghargai kontribusi para creator aktif dengan sistem reward yang menarik:</p>
        <ul class="about-features">
          <li>ðŸ† <b>VIP Membership</b> â€“ Creator dengan performa terbaik berkesempatan mendapatkan akses VIP eksklusif dari admin</li>
          <li>ðŸ’° <b>Cash Reward</b> â€“ Raih reward hingga $0.99 atau Rp 16.000 untuk creator yang mencapai target followers dan engagement tertentu</li>
          <li>ðŸ“ˆ <b>Kriteria Penilaian:</b> Total followers, jumlah lagu terupload, engagement rate, dan konsistensi konten</li>
        </ul>
        <p><em>* Syarat dan ketentuan berlaku. Keputusan admin bersifat final.</em></p>
        
        <p><b>Fitur VIP</b></p>
        <ul class="about-features">
          <li>ðŸ‘‘ Tema profil khusus VIP dengan animasi emas</li>
          <li>â±ï¸ Cooldown upload dipercepat menjadi 15 menit</li>
          <li>ðŸŽŸï¸ Ikon mahkota di nama dan list lagu</li>
          <li>ðŸ”— Share profil cepat dengan deep link khusus</li>
        </ul>

        <p><b>Badge Original User</b></p>
        <p>Sistem badge verifikasi akan otomatis muncul di profil Anda ketika berhasil mengumpulkan 50 followers organik. Badge ini menandakan bahwa Anda adalah creator original dan terpercaya di exemusic.</p>
        
        <div class="rules-warn">
          <b>PERATURAN KETAT EXEMUSIC:</b><br><br>
          Akun yang terbukti mengupload konten ilegal seperti:<br>
          â€¢ Konten SARA (Suku, Agama, Ras, dan Antar golongan)<br>
          â€¢ Audio pornografi atau konten seksual eksplisit<br>
          â€¢ Earrape atau audio yang merusak pendengaran<br>
          â€¢ Konten yang melanggar hak cipta secara jelas<br>
          â€¢ Konten yang mengandung ujaran kebencian<br><br>
          <strong>âš ï¸ AKAN DIHAPUS PERMANEN TANPA PERINGATAN</strong>
        </div>

        <p style="margin-top:12px; color:#ddd">
          ðŸ“± Contact WhatsApp â€” <a href="https://wa.me/62895329018240" target="_blank" rel="noopener" class="about-dev-link">click here</a><br>
          ðŸ“‹ Changelogs â€” <a href="https://execuriverp.github.io/changelogs" target="_blank" rel="noopener" class="about-dev-link">click here</a><br>
          ðŸ“» Use Boombox â€” <a href="javascript:void(0)" onclick="openBoomboxTutorial()" class="about-dev-link">click here</a>
        </p>
        <p class="about-footer">Kami menerapkan zero-tolerance policy untuk menjaga kualitas dan keamanan exemusic. Mohon hormati aturan ini demi kenyamanan bersama.</p>
        <p class="about-credit">Dibuat oleh <a href="?profile_userid=GsU6ThLD9gb5P3k8RS87ro553Ks2" class="about-dev-link">Hexky</a><br>Â© 2025 ExeMusic Website</p>
        <button onclick="closeModal()" class="btn-act">SAYA MENGERTI</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalClearNotif" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent)">Konfirmasi</h3>
      <p style="text-align:center; color:#ccc; margin-bottom:14px">Yakin ingin membersihkan notifikasi?</p>
      <div style="display:flex; gap:10px">
        <button class="btn-act" onclick="confirmClearNotif()">Confirm</button>
        <button class="btn-act" style="background:#222; color:#fff" onclick="document.getElementById('modalClearNotif').style.display='none'">Discard</button>
      </div>
    </div>
  </div>
  <div class="modal" id="modalEvent" onclick="if(event.target==this)closeEventModal()">
    <div class="sheet">
      <div class="event-card">
        <div style="text-align:center; margin-bottom:8px; color:var(--accent); font-weight:800"><i class="fas fa-star"></i> ExeMusic Event â€” Idul Fitri 1447H</div>
        <div id="eidCountdown" class="countdown-wrap">
          <div class="count-item">
            <div class="count-val" id="cDays">0</div>
            <div class="count-lbl">Hari</div>
          </div>
          <div class="count-item">
            <div class="count-val" id="cHours">0</div>
            <div class="count-lbl">Jam</div>
          </div>
          <div class="count-item">
            <div class="count-val" id="cMins">0</div>
            <div class="count-lbl">Menit</div>
          </div>
          <div class="count-item">
            <div class="count-val" id="cSecs">0</div>
            <div class="count-lbl">Detik</div>
          </div>
        </div>
        <div class="mini-row">
          <span class="mini-badge"><span style="color:#00ff88; font-size:14px">ðŸ’ </span> <b id="eidKetVal">0</b></span>
          <span id="eidClaimStatus">Belum claim</span>
        </div>
        <div style="display:flex; gap:10px; justify-content:center; margin:14px 0 10px">
          <button id="claimBtn" class="claim-btn" onclick="claimTrialVip1d()">Claim VIP 1 Day</button>
        </div>
        <button class="shop-btn" onclick="openKetupatShop()">Buka Toko Ketupat</button>
        <div style="text-align:center; color:#888; font-size:12px; margin-top:12px">Event hourly: setiap jam :00 ada disco mode random dan peluang dapat ketupat 1â€“10 jika online.</div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalCopyLink" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent)">Salin Deep Link</h3>
      <div id="copyLinkText" style="background:#0a0a0a; border:1px solid #333; border-radius:8px; padding:12px; color:#00d4ff; font-family:'Courier New', monospace; font-size:12px; word-break:break-all; margin-bottom:12px">URL belum dibuat</div>
      <div style="display:flex; gap:10px">
        <button class="btn-act" onclick="copyBuiltLink()">Copy</button>
        <button class="btn-act" style="background:#25D366; color:#fff" onclick="shareToWhatsApp()">WhatsApp</button>
        <button class="btn-act" style="background:#222; color:#fff" onclick="document.getElementById('modalCopyLink').style.display='none'">Back</button>
      </div>
    </div>
  </div>
  <div class="modal" id="modalSocialList" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:12px; color:var(--accent)" id="socialTitle">Social</h3>
      <div id="socialList" class="mp-list"></div>
    </div>
  </div>
  <div class="modal" id="modalCopyAudio" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent)">Salin URL Audio MP3</h3>
      <div id="copyAudioText" style="background:#0a0a0a; border:1px solid #333; border-radius:8px; padding:12px; color:#00d4ff; font-family:'Courier New', monospace; font-size:12px; word-break:break-all; margin-bottom:12px">URL belum dibuat</div>
      <div style="display:flex; gap:10px">
        <button class="btn-act" onclick="copyBuiltAudio()">Copy</button>
        <button class="btn-act" style="background:#222; color:#fff" onclick="document.getElementById('modalCopyAudio').style.display='none'">Back</button>
      </div>
    </div>
  </div>
  <div class="modal" id="modalBoombox" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent)">How to use URL Top4Top</h3>
      <div style="font-size:13px; color:#ddd; line-height:1.6; margin-bottom:12px">
        <p>1. pastikan kamu sudah punya boombox.</p>
        <p>2. pakai command /placebb untuk menaruh boombox.</p>
        <p>3. pakai command /setbb untuk memulai music.</p>
        <p>4. pilih url paling bawah dan masukan url top4top nya.</p>
        <p>note : jika url tidak bunyi silahkan hapus s di bagian https menjadi http dan pastikan url adalah top4top.</p>
        <p>end.</p>
      </div>
      <div style="display:flex; gap:10px">
        <button class="btn-act" onclick="document.getElementById('modalBoombox').style.display='none'">Close</button>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCVJYSR4nHeoRA9WTMZa3-2xliKQRrd5g4",
      authDomain: "exemusic-execuriverp.firebaseapp.com",
      databaseURL: "https://exemusic-execuriverp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "exemusic-execuriverp",
      storageBucket: "exemusic-execuriverp.firebasestorage.app",
      messagingSenderId: "722057744401",
      appId: "1:722057744401:web:cd6a6a103692059bda61b0",
      measurementId: "G-2P56Y7QQ18"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();
    let selectedAudioFile = null;

    let songs = [], i = 0, isLoginMode = true;
    
    let repeatMode = parseInt(localStorage.getItem('exeRepeat') || '0'); // 0: OFF, 1: ONE, 2: ALL
    let isShuf = localStorage.getItem('exeShuffle') === 'true';
    let fav = JSON.parse(localStorage.getItem("exeFav") || "[]");
    let savedVol = parseFloat(localStorage.getItem("exeVolume") || "0.8");
    let lastSongData = JSON.parse(localStorage.getItem("exeLastSong") || "{}");

    let userData = null;
    const audio = new Audio();
    audio.volume = savedVol; // Apply saved volume immediately
    const eventAudio = new Audio();
    eventAudio.volume = 1.0;
    let vipTrialInterval = null;
    let broadcastTimeout;
    let discoModeActive = false;
    let discoColor = "#00ff88";
    let lastDiscoUser = null;
    let iceModeActive = false;
    let snowflakeInterval = null;
    let notifList = [];
    const lastReadNotifTimeKey = 'exeNotifRead';

    function getTagHTML(tag) {
      if(!tag || tag === "none") return '';
      const t = tag.toLowerCase();
      return `<span class="user-tag tag-${t}">${tag}</span>`;
    }

    db.ref('settings').on('value', s => {
        const val = s.val();
        if(!val) return;
        if(val.mt === true) {
            db.ref('users/' + auth.currentUser?.uid + '/role').once('value', r => {
                if(r.val() !== 'admin') document.getElementById('mtScreen').style.display = 'flex';
            });
        } else { document.getElementById('mtScreen').style.display = 'none'; }
        if(val.announcement) triggerBroadcast(val.announcement);
        
        if(val.discoMode !== discoModeActive) {
            discoModeActive = val.discoMode || false;
            if(discoModeActive) {
                const v = val.discoVariant || 'heartbeat';
                const c = val.discoColor || '#00ff88';
                applyDiscoMode(v, c);
            } else {
                resetTheme();
                triggerBroadcast("Disco mode ended!");
            }
        } else if(discoModeActive) {
            const v = val.discoVariant || 'heartbeat';
            const c = val.discoColor || '#00ff88';
            applyDiscoMode(v, c);
        }
    });

    function loadNotifs() {
      auth.onAuthStateChanged(u => {
        if (!u) { mergeAndRenderNotifs([], 'user'); return; }
        db.ref('users/' + u.uid + '/notifications').orderByChild('timestamp').limitToLast(80).on('value', snap => {
          const val = snap.val();
          const list = [];
          if (val) Object.keys(val).forEach(k => list.push({ ...val[k], id: 'u_' + k }));
          mergeAndRenderNotifs(list, 'user');
        });
      });
    }
    let _globalNotifs = [];
    let _userNotifs = [];
    function mergeAndRenderNotifs(list, source) {
      if (source === 'global') _globalNotifs = list;
      else _userNotifs = list;
      notifList = [..._globalNotifs, ..._userNotifs].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      renderNotifList();
      updateNotifBadge();
    }
    function timeAgo(ts) {
      if (!ts) return '';
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 60) return 'Baru saja';
      if (s < 3600) return Math.floor(s / 60) + ' menit lalu';
      if (s < 86400) return Math.floor(s / 3600) + ' jam lalu';
      if (s < 604800) return Math.floor(s / 86400) + ' hari lalu';
      return new Date(ts).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
    }
    function renderNotifList() {
      const el = document.getElementById('notifList');
      if (!el) return;
      if (!notifList.length) {
        el.innerHTML = '<div class="notif-empty">Belum ada notifikasi</div>';
        return;
      }
      const typeIcon = { admin: 'fa-shield-alt', violation: 'fa-exclamation-triangle', upload: 'fa-music', follow: 'fa-user-plus', system: 'fa-info-circle' };
      el.innerHTML = notifList.map(n => {
        const type = (n.type || 'system');
        const icon = typeIcon[type] || 'fa-bell';
        return '<div class="notif-item"><div class="notif-item-icon ' + type + '"><i class="fas ' + icon + '"></i></div><div class="notif-item-body"><div class="n-text">' + escapeHtml(n.text || n.message || '') + '</div><div class="n-time">' + timeAgo(n.timestamp) + '</div></div></div>';
      }).join('');
    }
    function updateNotifBadge() {
      const lastRead = parseInt(localStorage.getItem(lastReadNotifTimeKey) || '0', 10);
      const count = notifList.filter(n => (n.timestamp || 0) > lastRead).length;
      const badge = document.getElementById('notifBadge');
      if (badge) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.classList.toggle('show', count > 0);
      }
    }
    function toggleNotifPanel() {
      const panel = document.getElementById('notifPanel');
      if (panel.classList.toggle('show')) {
        localStorage.setItem(lastReadNotifTimeKey, String(Date.now()));
        updateNotifBadge();
      }
    }
    function closeNotifPanel() {
      document.getElementById('notifPanel').classList.remove('show');
      localStorage.setItem(lastReadNotifTimeKey, String(Date.now()));
      updateNotifBadge();
    }
    document.addEventListener('click', function(e) {
      const panel = document.getElementById('notifPanel');
      const btn = document.getElementById('btnNotif');
      if (panel && panel.classList.contains('show') && !panel.contains(e.target) && btn && !btn.contains(e.target))
        closeNotifPanel();
    });
    loadNotifs();


    function triggerBroadcast(msg) {
        const el = document.getElementById('sysBroadcast');
        const bar = document.getElementById('sbBar');
        const msgEl = document.getElementById('sbMessage');
        el.classList.remove('active', 'sb-closing');
        bar.style.animation = 'none';
        void bar.offsetWidth;
        if (typeof msg === 'string' && msg.trim().toLowerCase().startsWith('hexky:')) {
            const rest = msg.slice(6).trim();
            msgEl.innerHTML = '<span class="sb-dev-name">Hexky</span>: ' + escapeHtml(rest);
        } else {
            msgEl.textContent = msg;
        }
        setTimeout(() => {
            el.classList.add('active');
            bar.style.animation = 'countDown 15s linear forwards';
        }, 100);
        clearTimeout(broadcastTimeout);
        broadcastTimeout = setTimeout(closeBroadcast, 15000);
    }
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    function attrEscape(text) {
        if(text == null) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
    }

    function closeBroadcast() {
        const el = document.getElementById('sysBroadcast');
        el.classList.add('sb-closing');
        setTimeout(() => {
            el.classList.remove('active', 'sb-closing');
        }, 400);
    }

    function createSnowflake() {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.textContent = 'â„';
        snowflake.style.left = Math.random() * window.innerWidth + 'px';
        const duration = Math.random() * 3 + 4; // 4-7 detik jatuh - lebih ringan dan cepat!
        const delay = Math.random() * 0.3;
        snowflake.style.animation = `snowfall ${duration}s linear ${delay}s forwards`;
        document.body.appendChild(snowflake);
        
        setTimeout(() => snowflake.remove(), (duration + delay) * 1000);
    }

    function startSnowfall() {
        if(snowflakeInterval) clearInterval(snowflakeInterval);
        snowflakeInterval = setInterval(() => {
            if(document.querySelectorAll('.snowflake').length < 30) createSnowflake();
        }, 1200);
        for(let i = 0; i < 6; i++) {
            setTimeout(() => createSnowflake(), i * 150);
        }
    }

    function stopSnowfall() {
        if(snowflakeInterval) {
            clearInterval(snowflakeInterval);
            snowflakeInterval = null;
        }
        document.querySelectorAll('.snowflake').forEach(flake => flake.remove());
    }

    function applyDiscoMode(variant, color) {
        const app = document.querySelector('.app');
        document.documentElement.style.setProperty('--accent', color || '#00ff88');
        if(app) app.style.animation = 'none';
        stopSnowfall();
        if(variant === 'ice') {
            document.documentElement.style.setProperty('--accent', '#00d4ff');
            if(app) app.style.animation = 'disco-heartbeat 1.2s infinite';
            startSnowfall();
            return;
        }
        if(variant === 'rainbow') {
            if(app) app.style.animation = 'rainbow-glow 3s infinite linear';
            return;
        }
        if(variant === 'heartbeat') {
            if(app) app.style.animation = 'disco-heartbeat 1.2s infinite';
            return;
        }
    }

    function resetTheme() {
        document.documentElement.style.setProperty('--accent', '#00ff88');
        document.documentElement.style.setProperty('--bg', '#050505');
        document.documentElement.style.setProperty('--card-bg', '#121212');
        
        document.body.style.background = '#050505';
        
        stopSnowfall();
        
        const app = document.querySelector('.app');
        if(app) {
            app.style.animation = 'none';
            app.style.background = 'rgba(18, 18, 18, 0.6)';
            app.style.borderColor = 'rgba(255,255,255,0.08)';
            app.style.borderWidth = '1px';
            app.style.boxShadow = '0 20px 50px rgba(0,0,0,0.5)';
        }
        
        document.querySelectorAll('.btn-act').forEach(btn => {
            btn.style.background = 'var(--accent)';
            btn.style.boxShadow = 'none';
            btn.style.transform = 'scale(1)';
        });
        
        document.querySelectorAll('.btn-play').forEach(btn => {
            btn.style.background = 'var(--accent)';
            btn.style.boxShadow = '0 0 25px rgba(0, 255, 136, 0.4)';
            btn.style.color = '#000';
        });
        
        document.querySelectorAll('.eq span').forEach(span => {
            span.style.background = 'var(--accent)';
            span.style.boxShadow = '0 0 15px var(--accent)';
            span.style.filter = 'brightness(1)';
        });
        
        const sbBar = document.getElementById('sbBar');
        if(sbBar) {
            sbBar.style.background = 'var(--accent)';
            sbBar.style.boxShadow = 'none';
        }
        
        document.querySelectorAll('.sys-container').forEach(el => {
            el.style.background = 'rgba(255,255,255,0.03)';
            el.style.border = '1px solid rgba(255,255,255,0.05)';
            el.style.boxShadow = 'none';
        });
        
        document.querySelectorAll('.sheet').forEach(el => {
            el.style.background = '#181818';
            el.style.borderTop = '1px solid #333';
        });
        
        const title = document.getElementById('title');
        if(title) {
            title.style.color = '';
            title.style.textShadow = '0 0 10px rgba(0,0,0,0.5)';
        }
        
        const byEl = document.getElementById('by');
        if(byEl) {
            byEl.style.color = 'var(--accent)';
            byEl.style.textShadow = 'none';
        }
    }

    function generateFakeFollower() {
      const randomNum = Math.floor(Math.random() * 999999) + 10000;
      return `User_${randomNum}`;
    }

    auth.onAuthStateChanged(u => {
      if(u) {
        db.ref('users/' + u.uid).on('value', snap => {
          userData = snap.val();
          if(!userData) return;
          if(userData.banned === true) {
              document.getElementById('bannedScreen').style.display = 'flex';
              auth.signOut(); return;
          }
          const now = Date.now();
          const vipActive = !!(userData.vip || (userData.trialvip && userData.trialvip.expireAt > now));
          document.getElementById('topLoginBtn').textContent = userData.username;
          document.getElementById('pUsername').innerHTML = userData.username + (vipActive ? ' <i class="fas fa-crown" style="color:#ffd700; font-size:14px; margin-left:6px"></i>' : '');
          document.getElementById('pAvatarImg').src = userData.avatar || "https://via.placeholder.com/150";
          (function(){
            const fol = userData.followers;
            let folCount = 0;
            if(Array.isArray(fol)) folCount = fol.length;
            else if(fol && typeof fol === 'object') folCount = Object.keys(fol).length;
            else folCount = fol || 0;
            document.getElementById('pFol').innerText = folCount;
          })();
          (function(){
            const flg = userData.following;
            let flgCount = 0;
            if(Array.isArray(flg)) flgCount = flg.length;
            else if(flg && typeof flg === 'object') flgCount = Object.keys(flg).length;
            else flgCount = flg || 0;
            document.getElementById('pFollowing').innerText = flgCount;
          })();
          document.getElementById('pTagDisplay').innerHTML = getTagHTML(userData.tag);
          const followerCount = (() => {
            const fol = userData.followers;
            if(Array.isArray(fol)) return fol.length;
            if(fol && typeof fol === 'object') return Object.keys(fol).length;
            return fol || 0;
          })();
          document.getElementById('pBadge').innerHTML = (followerCount >= 50) ? '<i class="fas fa-check-circle v-badge"></i>' : '';
          
          const profHeader = document.querySelector('#modalProfile .modern-profile-header');
          if(profHeader) {
            profHeader.classList.toggle('vip', vipActive);
            if(vipActive) {
              if(userData.vipBgColor) profHeader.style.background = userData.vipBgColor;
              else profHeader.style.background = '';
            } else {
              if(userData.profileBg) profHeader.style.background = userData.profileBg;
              else profHeader.style.background = '';
            }
          }
          updateKetupatUI(userData.ketupat || 0);
          updateEidMiniStatus();
          const vs = document.getElementById('pVipStatus'); 
          if(vs) vs.textContent = 'Status VIP: ' + (vipActive ? 'AKTIF' : 'NONVIP');
          updateClaimButtonVisibility();
          const trialActive = !!(userData.trialvip && userData.trialvip.expireAt > now);
          const vipBgRow = document.getElementById('vipBgRow');
          if(vipBgRow) vipBgRow.style.display = vipActive ? 'flex' : 'none';
          if(trialActive) startVipTrialCountdown(userData.trialvip.expireAt);
          else {
            const cont = document.getElementById('vipTrialTimer');
            if(cont) cont.style.display = 'none';
            if(vipTrialInterval) { clearInterval(vipTrialInterval); vipTrialInterval = null; }
          }
          
          const email = u.email || "";
          const [name, domain] = email.split('@');
          const sensoredEmail = name.slice(0, Math.max(1, Math.floor(name.length / 3))) + '*'.repeat(Math.max(3, name.length - 2)) + '@' + domain;
          document.getElementById('pEmail').innerText = sensoredEmail;
          
          if(userData.role === 'admin') document.getElementById('adminBtn').style.display = 'block';
          document.getElementById('uploadFormUser').style.display = 'block';
          document.getElementById('uploadFormGuest').style.display = 'none';
          document.getElementById('btnFollow').style.display = 'flex';
          updateFollowUI();
        });
      } else {
        document.getElementById('topLoginBtn').textContent = "Login";
        document.getElementById('btnFollow').style.display = 'none';
        document.getElementById('adminBtn').style.display = 'none';
      }
      document.getElementById('loadingCard').style.display = 'none';
    });

    db.ref('songs').on('value', snap => {
      const val = snap.val();
      if(val) {
        songs = Object.keys(val).map(k => ({...val[k], key: k}));
        
        const urlParams = new URLSearchParams(window.location.search);
        const songId = urlParams.get('id');
        const profileUid = urlParams.get('profile_userid');
        
        if(profileUid && auth.currentUser) {
          if(profileUid === auth.currentUser.uid) {
            openProfile();
          } else {
            db.ref('users/' + profileUid).get().then(snap => {
              if(snap.exists()) {
                const userData = snap.val();
                document.getElementById('vAvatarImg').src = userData?.avatar || "https://via.placeholder.com/150";
                const followerCountView = (() => {
                  const fol = userData?.followers;
                  if(Array.isArray(fol)) return fol.length;
                  if(fol && typeof fol === 'object') return Object.keys(fol).length;
                  return fol || 0;
                })();
                const nowC = Date.now();
                const creatorVipActive = !!(userData?.vip || (userData?.trialvip && userData.trialvip.expireAt > nowC));
                document.getElementById('vName').innerHTML = "@" + userData.username + ((followerCountView >= 50) ? '<i class="fas fa-check-circle v-badge" style="font-size:14px; margin-left:5px"></i>' : '') + (creatorVipActive ? ' <i class="fas fa-crown" style="color:#ffd700; font-size:14px; margin-left:6px"></i>' : '');
                document.getElementById('vFol').innerText = followerCountView;
                const followingCountView = (() => {
                  const flg = userData?.following;
                  if(Array.isArray(flg)) return flg.length;
                  if(flg && typeof flg === 'object') return Object.keys(flg).length;
                  return flg || 0;
                })();
                document.getElementById('vFollowing').innerText = followingCountView;
                document.getElementById('vTagDisplay').innerHTML = getTagHTML(userData?.tag);
                
                const creatorHeader = document.querySelector('#modalCreator .modern-profile-header');
                if(creatorHeader) creatorHeader.classList.toggle('vip', creatorVipActive);
                
                const creatorSongs = songs.filter(x => x.uid === profileUid);
                creatorSongs.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
                
         document.getElementById('creatorPostList').innerHTML = creatorSongs.map(x => 
             `<div class="mp-song-item" onclick="setup(${songs.indexOf(x)}); closeModal()">
                 <div class="mp-song-icon"><i class="fas fa-music"></i></div>
                 <div class="mp-song-info">
                     <div class="mp-song-title">${x.title}</div>
                 </div>
                 <div style="font-size:10px; color:#555"><i class="fas fa-play"></i></div>
              </div>`
         ).join('');
                
                document.getElementById('modalCreator').dataset.creatorUid = profileUid;
                updateCreatorFollowUI(profileUid);
                document.getElementById('modalCreator').style.display = 'block';
              }
            });
          }
        } else if(audio.src === "") {
            const savedVol = localStorage.getItem('exeVolume');
            if(savedVol !== null) {
                audio.volume = parseFloat(savedVol);
                document.getElementById('vol').value = savedVol;
            }

            if(songId && songs[songId]) {
                setup(parseInt(songId), false);
            } else {
                const savedIdx = localStorage.getItem('exeLastSongIdx');
                const savedTime = localStorage.getItem('exeLastTime');
                
                if(savedIdx !== null && songs[savedIdx]) {
                    setup(parseInt(savedIdx), false).then(() => {
                        if(savedTime) audio.currentTime = parseFloat(savedTime);
                    });
                } else {
                    setup(0, false);
                }
            }
        }
      }
    });
    initHourlyEvent();

    async function setup(idx, play = true) {
      if(!songs[idx]) return;
      i = idx;
      
      const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + i;
      window.history.pushState({path:newUrl},'',newUrl);

      audio.src = songs[i].url;
      document.getElementById('title').textContent = songs[i].title;
      const cRef = await db.ref('users/' + songs[i].uid).get();
      const cData = cRef.val();
      const followerCountBadge = Array.isArray(cData?.followers) ? cData.followers.length : cData?.followers || 0;
      const badge = (followerCountBadge >= 50) ? '<i class="fas fa-check-circle v-badge"></i>' : '';
      const creatorVipActive = !!(cData?.vip || (cData?.trialvip && cData.trialvip.expireAt > Date.now()));
      const crown = creatorVipActive ? ' <i class="fas fa-crown" style="color:#ffd700; font-size:12px"></i>' : '';
      document.getElementById('by').innerHTML = "@" + (songs[i].by || "system") + badge + crown;
      const hasCreator = !!songs[i].uid;
      if(play) { 
        audio.play(); 
        document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>'; 
        document.getElementById('eq').classList.add('playing'); 
        showToast(`ðŸŽµ Now Playing: ${songs[i].title}`);
      }
      updateFollowUI();
      updateFavoriteUI();
      saveLastSong();
    }

    function confirmAndSave() {
        const title = document.getElementById('rLagu').value;
        const url = document.getElementById('rUrl').value;
        
        if(!title || !url) return msg("Isi semua data!");
        
        const lastUpload = userData.lastUpload || 0;
        const now = Date.now();
        const diff = (now - lastUpload) / 1000 / 60; // dalam menit
        const vipActive = !!(userData.vip || (userData.trialvip && userData.trialvip.expireAt > now));
        const cooldown = (userData.role === 'admin') ? 0 : (vipActive ? 15 : 30);
        
        if(diff < cooldown && userData.role !== 'admin') {
            return Swal.fire({
                icon: 'error',
                title: 'Sabar...',
                text: `Tunggu ${Math.ceil(cooldown - diff)} menit lagi untuk upload lagu berikutnya.`,
                background: '#181818', color: '#fff'
            });
        }

        Swal.fire({
            title: 'Are you sure?',
            text: "Jika lagu ini melanggar rules kami (Sara, Porn, Earrape), akun anda akan kami BANNED PERMANENT!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#00ff88',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Saya Tanggung Jawab',
            background: '#181818',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                saveMusic(title, url);
            }
        });
    }

    function saveMusic(t, u) {
        const newSong = {
            title: t,
            url: u,
            uid: auth.currentUser.uid,
            by: userData.username,
            timestamp: Date.now()
        };
        
        db.ref('songs').push(newSong).then(() => {
            db.ref('users/' + auth.currentUser.uid).update({ lastUpload: Date.now() });
            db.ref('users/' + auth.currentUser.uid + '/notifications').push({
              type: 'upload',
              text: userData.username + ' mengupload: ' + t,
              fromName: userData.username,
              timestamp: Date.now()
            });
            msg("Berhasil diposting!");
            closeModal();
            document.getElementById('rLagu').value = "";
            document.getElementById('rUrl').value = "";
        });
    }

    function toggle() {
      if(audio.paused) { audio.play(); document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>'; document.getElementById('eq').classList.add('playing'); }
      else { audio.pause(); document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>'; document.getElementById('eq').classList.remove('playing'); }
    }
    function next() { setup(isShuf ? Math.floor(Math.random()*songs.length) : (i+1)%songs.length); }
    function prev() { setup(isShuf ? Math.floor(Math.random()*songs.length) : (i-1+songs.length)%songs.length); }
    
    audio.ontimeupdate = () => {
      document.getElementById('seek').value = (audio.currentTime/audio.duration)*100 || 0;
      document.getElementById('cur').textContent = fmt(audio.currentTime);
      document.getElementById('dur').textContent = fmt(audio.duration);
      if(audio.duration > 0) {
        document.getElementById('loadSpinner').classList.remove('show');
      }
      
      if(Math.floor(audio.currentTime) % 2 === 0) {
          localStorage.setItem('exeLastTime', audio.currentTime);
      }
    };
    
    audio.onplay = () => {
      if(audio.duration === 0 || isNaN(audio.duration)) {
        document.getElementById('loadSpinner').classList.add('show');
      }
      localStorage.setItem('exeIsPlaying', 'true');
    };
    
    audio.onpause = () => {
        localStorage.setItem('exeIsPlaying', 'false');
        localStorage.setItem('exeLastTime', audio.currentTime);
    };
    
    audio.onloadedmetadata = () => {
      document.getElementById('loadSpinner').classList.remove('show');
    };
    document.getElementById('seek').oninput = (e) => audio.currentTime = (e.target.value/100)*audio.duration;
    
    document.getElementById('vol').oninput = (e) => {
        audio.volume = e.target.value;
        localStorage.setItem('exeVolume', e.target.value);
    };
    
    audio.onended = () => {
        if(repeatMode === 1) { // Repeat One
            audio.currentTime = 0;
            audio.play();
        } else if (repeatMode === 2 || isShuf) { // Repeat All or Shuffle
            next();
        } else { // Repeat Off
            if(i < songs.length - 1) next();
        }
    };

    function saveLastSong() {
        localStorage.setItem('exeLastSongIdx', i);
    }

    async function followUser() {
      if(!auth.currentUser) return msg("Login dulu!");
      const targetUid = songs[i].uid;
      if(!targetUid || targetUid === auth.currentUser.uid) return msg("Gak bisa follow diri sendiri");
      
      try {
        const targetRef = db.ref('users/' + targetUid);
        const currentRef = db.ref('users/' + auth.currentUser.uid);
        
        const targetSnap = await targetRef.get();
        const currentSnap = await currentRef.get();
        
        const targetData = targetSnap.val();
        const currentData = currentSnap.val();
        
        const followersArr = Array.isArray(targetData?.followers) ? [...targetData.followers] : (targetData?.followers && typeof targetData.followers === 'object' ? Object.keys(targetData.followers) : []);
        const followingArr = Array.isArray(currentData?.following) ? [...currentData.following] : (currentData?.following && typeof currentData.following === 'object' ? Object.keys(currentData.following) : []);
        const isFollowing = followersArr.includes(auth.currentUser.uid);
        
        if(isFollowing) {
          const newFollowers = followersArr.filter(uid => uid !== auth.currentUser.uid);
          const newFollowing = followingArr.filter(uid => uid !== targetUid);
          await targetRef.update({ followers: newFollowers });
          await currentRef.update({ following: newFollowing });
          msg("Unfollowed!");
        } else {
          const newFollowers = [...followersArr, auth.currentUser.uid];
          const newFollowing = [...followingArr, targetUid];
          await targetRef.update({ followers: newFollowers });
          await currentRef.update({ following: newFollowing });
          db.ref('users/' + targetUid + '/notifications').push({
            type: 'follow',
            text: userData.username + ' mulai mengikuti kamu',
            fromName: userData.username,
            fromUid: auth.currentUser.uid,
            timestamp: Date.now()
          });
          msg("Followed! âœ…");
        }
        await updateFollowUI();
      } catch(err) {
        msg("Error: " + err.message);
      }
    }

    async function updateFollowUI() {
      if(!auth.currentUser || !songs[i].uid) return;
      const targetSnap = await db.ref('users/' + songs[i].uid).get();
      const targetData = targetSnap.val();
      const targetFollowers = targetData?.followers || {};
      const isFollowing = Array.isArray(targetFollowers) ? targetFollowers.includes(auth.currentUser.uid) : !!targetFollowers[auth.currentUser.uid];
      
      const btn = document.getElementById('btnFollow');
      if(isFollowing) {
        btn.style.display = 'none'; // Hide button jika sudah follow
      } else {
        btn.style.display = 'flex';
        btn.innerHTML = '<i class="fas fa-plus"></i>';
        btn.style.background = "var(--tiktok-red)";
      }
    }

    function fmt(s) { if(isNaN(s)) return "0:00"; let m=Math.floor(s/60),sec=Math.floor(s%60); return m+":"+(sec<10?"0"+sec:sec); }
    function msg(m) { showToast(m, 'info'); }

    function showToast(text, type='info') {
      const container = document.getElementById('toast-container');
      if(!container) return;
      const el = document.createElement('div');
      el.className = 'toast';
      let icon = 'fa-info-circle';
      if(text.includes('Playing')) icon = 'fa-music';
      else if(text.includes('Favorit')) icon = 'fa-heart';
      else if(text.includes('Shuffle')) icon = 'fa-random';
      else if(text.includes('Repeat')) icon = 'fa-redo';
      else if(text.includes('Error')) icon = 'fa-exclamation-triangle';
      
      el.innerHTML = `<i class="fas ${icon}"></i> <span>${text}</span>`;
      container.appendChild(el);
      
      setTimeout(() => el.classList.add('hide'), 2500);
      setTimeout(() => el.remove(), 2900);
    }
    
    function saveVipBgColor() {
      if(!auth.currentUser) return msg('Login dulu!');
      const color = document.getElementById('vipBgPicker').value;
      db.ref('users/' + auth.currentUser.uid).update({ vipBgColor: color }).then(() => {
        const profHeader = document.querySelector('#modalProfile .modern-profile-header');
        if(profHeader) profHeader.style.background = color;
        msg('BG VIP diperbarui');
      });
    }
    function startVipTrialCountdown(expireAt) {
      const cont = document.getElementById('vipTrialTimer');
      if(!cont) return;
      if(vipTrialInterval) { clearInterval(vipTrialInterval); vipTrialInterval = null; }
      cont.style.display = 'flex';
      function tick() {
        const now = Date.now();
        const diff = Math.max(0, expireAt - now);
        const days = Math.floor(diff / (24*3600000));
        const hours = Math.floor((diff % (24*3600000)) / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const dEl = document.getElementById('vipDays');
        const hEl = document.getElementById('vipHours');
        const mEl = document.getElementById('vipMinutes');
        if(dEl) dEl.textContent = String(days);
        if(hEl) hEl.textContent = String(hours);
        if(mEl) mEl.textContent = String(minutes);
        if(diff <= 0) {
          clearInterval(vipTrialInterval); vipTrialInterval = null;
          cont.style.display = 'none';
          msg('VIP trial berakhir');
        }
      }
      tick();
      vipTrialInterval = setInterval(tick, 30000);
    }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
    
    function openEvent() { 
      document.getElementById('modalEvent').style.display='block'; 
      startEventCountdown(); 
      updateEidMiniStatus(); 
      updateClaimButtonVisibility();
      try { audio.pause(); document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>'; } catch(e) {}
      try { eventAudio.src = 'https://g.top4top.io/m_36891kox71.mp3'; eventAudio.play(); } catch(e) {} 
    }
    function startEventCountdown() {
      const fallback = new Date('2026-03-20T00:00:00Z').getTime();
      db.ref('settings/eidTs').get().then(s => {
        const target = s.exists() ? s.val() : fallback;
        if(window._eidInterval) clearInterval(window._eidInterval);
        window._eidInterval = setInterval(() => {
          const d = target - Date.now();
          const dEl = document.getElementById('cDays');
          const hEl = document.getElementById('cHours');
          const mEl = document.getElementById('cMins');
          const sEl = document.getElementById('cSecs');
          if(!dEl || !hEl || !mEl || !sEl) return;
          if(d <= 0) {
            dEl.textContent = '0'; hEl.textContent = '0'; mEl.textContent = '0'; sEl.textContent = '0';
            clearInterval(window._eidInterval);
            return;
          }
          const days = Math.floor(d/86400000);
          const hrs = Math.floor((d%86400000)/3600000);
          const mins = Math.floor((d%3600000)/60000);
          const secs = Math.floor((d%60000)/1000);
          dEl.textContent = String(days);
          hEl.textContent = String(hrs);
          mEl.textContent = String(mins);
          sEl.textContent = String(secs);
          [dEl,hEl,mEl,sEl].forEach(x => { x.style.animation = 'none'; void x.offsetWidth; x.style.animation = 'flipDown 0.9s'; });
        }, 1000);
      });
    }
    function claimTrialVip1d() {
      if(!auth.currentUser) return msg('Login dulu!');
      const ref = db.ref('users/'+auth.currentUser.uid+'/trialvip');
      ref.get().then(s => {
        const cur = s.val() || {};
        if(cur.freeClaimed === true) { msg('Kamu sudah claim VIP'); return; }
        const expire = Date.now() + 24*3600000;
        ref.set({ active: true, expireAt: expire, freeClaimed: true }).then(() => {
          msg('Trial VIP 1 hari aktif');
          playClaimAnimation();
          updateEidMiniStatus();
        });
      });
    }
    function ensureKetupat(countNeeded) {
      return db.ref('users/'+auth.currentUser.uid+'/ketupat').get().then(s => {
        const cur = s.val() || 0;
        if(cur < countNeeded) { msg('Ketupat kurang '+(countNeeded-cur)); return Promise.reject('insufficient'); }
        return cur;
      });
    }
    function exchangeTag(tag, cost) {
      if(!auth.currentUser) return msg('Login dulu!');
      ensureKetupat(cost).then(cur => {
        const newVal = cur - cost;
        return db.ref('users/'+auth.currentUser.uid).update({ ketupat: newVal, tag: tag });
      }).then(() => msg('Tag diperbarui'));
    }
    function exchangeBg(color, cost) {
      if(!auth.currentUser) return msg('Login dulu!');
      ensureKetupat(cost).then(cur => {
        const newVal = cur - cost;
        return db.ref('users/'+auth.currentUser.uid).update({ ketupat: newVal, profileBg: color });
      }).then(() => msg('Background profil diubah'));
    }
    function exchangeVipTrial() {
      if(!auth.currentUser) return msg('Login dulu!');
      const days = parseInt(document.getElementById('vipDaysSel').value, 10) || 1;
      const cost = 100 * days;
      ensureKetupat(cost).then(cur => {
        const newVal = cur - cost;
        const expire = Date.now() + days*24*3600000;
        return db.ref('users/'+auth.currentUser.uid).update({ ketupat: newVal }).then(() => db.ref('users/'+auth.currentUser.uid+'/trialvip').update({ active: true, expireAt: expire }));
      }).then(() => msg('VIP trial aktif'));
    }
    function updateKetupatUI(val) {
      const b = document.getElementById('eventBadge'); if(!b) return;
      b.textContent = val ? String(val) : '';
      b.classList.toggle('show', !!val);
      const k = document.getElementById('eidKetVal'); if(k) k.textContent = val ? String(val) : '0';
    }
    function updateEidMiniStatus() {
      const sEl = document.getElementById('eidClaimStatus');
      if(!sEl) return;
      const claimed = !!(userData && userData.trialvip && userData.trialvip.freeClaimed === true);
      sEl.textContent = claimed ? 'Claimed' : 'Belum claim';
    }
    function updateClaimButtonVisibility() {
      const btn = document.getElementById('claimBtn');
      if(!btn) return;
      const claimed = !!(userData && userData.trialvip && userData.trialvip.freeClaimed === true);
      btn.style.display = claimed ? 'none' : 'block';
    }
    function playClaimAnimation() { showToast('ðŸŽ VIP claimed'); }
    function closeEventModal() { const m = document.getElementById('modalEvent'); if(m) m.style.display='none'; try { eventAudio.pause(); eventAudio.src=''; } catch(e) {} }
    function openKetupatShop() { try { eventAudio.pause(); eventAudio.src=''; } catch(e) {} document.getElementById('modalEvent').style.display='none'; document.getElementById('modalKetupatShop').style.display='block'; }
    function initHourlyEvent() {
      let lastHour = null;
      let isActive = false;
      setInterval(() => {
        const now = new Date();
        const m = now.getMinutes();
        const h = now.getHours();
        if(m < 5) {
          if(h !== lastHour || !isActive) {
            lastHour = h;
            isActive = true;
            const variants = ['heartbeat','rainbow','minimal','ice'];
            const colors = ['#00ff88','#00d4ff','#ff4d4d','#ffcc00'];
            const v = variants[Math.floor(Math.random()*variants.length)];
            const c = colors[Math.floor(Math.random()*colors.length)];
            applyDiscoMode(v, c);
            if(auth.currentUser) {
              const slot = new Date().toDateString()+'-'+h;
              const ref = db.ref('users/'+auth.currentUser.uid+'/lastEventHour');
              ref.get().then(s => {
                if(s.val() === slot) return;
                const gain = Math.floor(Math.random()*10)+1;
                db.ref('users/'+auth.currentUser.uid).transaction(u => {
                  const cur = (u&&u.ketupat)||0;
                  return Object.assign({}, u||{}, { ketupat: cur + gain, lastEventHour: slot });
                }).then(() => {
                  db.ref('users/'+auth.currentUser.uid+'/notifications').push({ type:'system', text:'+ '+gain+' ðŸ’ ', timestamp: Date.now() });
                  updateKetupatUI((userData&&userData.ketupat)||0 + gain);
                });
              });
            }
          }
        } else if(isActive) {
          resetTheme();
          isActive = false;
        }
      }, 15000);
    }
    function openCreatorFollowers() {
      const uid = document.getElementById('modalCreator').dataset.creatorUid;
      if(!uid) return;
      db.ref('users/'+uid+'/followers').get().then(s => {
        const arr = s.val() || [];
        const ids = Array.isArray(arr) ? arr : (arr && typeof arr === 'object' ? Object.keys(arr) : []);
        if(!ids.length) { renderSocialList('Followers', []); return; }
        Promise.all(ids.map(id => db.ref('users/'+id+'/username').get().then(r => ({ id, name: r.val()||id })))).then(list => {
          renderSocialList('Followers', list);
        });
      });
    }
    function openCreatorFollowing() {
      const uid = document.getElementById('modalCreator').dataset.creatorUid;
      if(!uid) return;
      db.ref('users/'+uid+'/following').get().then(s => {
        const arr = s.val() || [];
        const ids = Array.isArray(arr) ? arr : (arr && typeof arr === 'object' ? Object.keys(arr) : []);
        if(!ids.length) { renderSocialList('Following', []); return; }
        Promise.all(ids.map(id => db.ref('users/'+id+'/username').get().then(r => ({ id, name: r.val()||id })))).then(list => {
          renderSocialList('Following', list);
        });
      });
    }
    function renderSocialList(title, items) {
      const modal = document.getElementById('modalSocialList');
      const sheet = modal.querySelector('.sheet');
      sheet.querySelector('#socialTitle').textContent = title;
      const box = sheet.querySelector('#socialList');
      box.innerHTML = items.length ? items.map(x => `<div class="mp-song-item"><div class="mp-song-info"><div class="mp-song-title">@${x.name}</div></div></div>`).join('') : '<div class="notif-empty">Belum ada data</div>';
      modal.style.display = 'block';
    }
    function openProfile() { 
        if(!auth.currentUser) document.getElementById('modalAuth').style.display='block'; 
        else {
            const myPosts = songs.filter(s => s.uid === auth.currentUser.uid);
            myPosts.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
            
             document.getElementById('myPostList').innerHTML = myPosts.map(s => 
                 `<div class="mp-song-item" onclick="setup(${songs.indexOf(s)}); closeModal()">
                     <div class="mp-song-icon"><i class="fas fa-music"></i></div>
                     <div class="mp-song-info">
                         <div class="mp-song-title">${s.title}</div>
                     </div>
                     <div style="font-size:10px; color:#555"><i class="fas fa-play"></i></div>
                  </div>`
             ).join('');
            
            const myLikes = songs.filter(s => fav.includes(s.url));
            document.getElementById('myLikeList').innerHTML = myLikes.map(s => 
                `<div class="mp-song-item" onclick="setup(${songs.indexOf(s)}); closeModal()">
                    <div class="mp-song-icon" style="color:var(--accent)"><i class="fas fa-heart"></i></div>
                    <div class="mp-song-info">
                        <div class="mp-song-title">${s.title}</div>
                        <div class="mp-song-artist">@${s.by}</div>
                    </div>
                 </div>`
            ).join('');
            
            switchProfileTab('posts');
            document.getElementById('modalProfile').style.display = 'block';
        }
    }

    function fmtTimestamp(ts) {
        if(!ts) return 'Unknown date';
        const d = new Date(ts);
        return d.toLocaleDateString();
    }
    
    async function viewCreator() {
        const s = songs[i]; 
        if(!s.uid) return;
        
        if(auth.currentUser && s.uid === auth.currentUser.uid) {
            openProfile();
            return;
        }
        
        const cRef = await db.ref('users/' + s.uid).get();
        const cData = cRef.val();
        const followerCountCreator = (() => {
          const fol = cData?.followers;
          if(Array.isArray(fol)) return fol.length;
          if(fol && typeof fol === 'object') return Object.keys(fol).length;
          return fol || 0;
        })();
        
        document.getElementById('vAvatarImg').src = cData?.avatar || "https://via.placeholder.com/150";
        const nowVC = Date.now();
        const creatorVipActiveVC = !!(cData?.vip || (cData?.trialvip && cData.trialvip.expireAt > nowVC));
        document.getElementById('vName').innerHTML = "@" + s.by + ((followerCountCreator >= 50) ? '<i class="fas fa-check-circle v-badge" style="font-size:14px; margin-left:5px"></i>' : '') + (creatorVipActiveVC ? ' <i class="fas fa-crown" style="color:#ffd700; font-size:14px; margin-left:6px"></i>' : '');
        document.getElementById('vFol').innerText = followerCountCreator;
        document.getElementById('vTagDisplay').innerHTML = getTagHTML(cData?.tag);
        
        const creatorHeader = document.querySelector('#modalCreator .modern-profile-header');
        if(creatorHeader) creatorHeader.classList.toggle('vip', creatorVipActiveVC);
        
        const creatorSongs = songs.filter(x => x.uid === s.uid);
        creatorSongs.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
        
                 document.getElementById('creatorPostList').innerHTML = creatorSongs.map(x => 
                     `<div class="mp-song-item" onclick="setup(${songs.indexOf(x)}); closeModal()">
                         <div class="mp-song-icon"><i class="fas fa-music"></i></div>
                         <div class="mp-song-info">
                             <div class="mp-song-title">${x.title}</div>
                         </div>
                         <div style="font-size:10px; color:#555"><i class="fas fa-play"></i></div>
                      </div>`
                 ).join('');
        
        document.getElementById('modalCreator').dataset.creatorUid = s.uid;
        updateCreatorFollowUI(s.uid);
        document.getElementById('modalCreator').style.display = 'block';
    }

    async function updateCreatorFollowUI(creatorUid) {
      if(!auth.currentUser) return;
      const creatorSnap = await db.ref('users/' + creatorUid).get();
      const creatorData = creatorSnap.val();
      const creatorFollowers = creatorData?.followers || {};
      const isFollowing = Array.isArray(creatorFollowers) ? creatorFollowers.includes(auth.currentUser.uid) : !!creatorFollowers[auth.currentUser.uid];
      
      const btnText = document.getElementById('vCreatorFollowBtn');
      
      if(isFollowing) {
        btnText.innerText = 'Following âœ“';
        btnText.classList.add('following');
      } else {
        btnText.innerText = 'Follow';
        btnText.classList.remove('following');
      }
    }

    async function followCreator() {
      if(!auth.currentUser) return msg("Login dulu!");
      
      const creatorUid = document.getElementById('modalCreator').dataset.creatorUid;
      if(!creatorUid || creatorUid === auth.currentUser.uid) return msg("Gak bisa follow diri sendiri");
      
      try {
      const creatorRef = db.ref('users/' + creatorUid);
        const currentRef = db.ref('users/' + auth.currentUser.uid);
        
        const creatorSnap = await creatorRef.get();
        const currentSnap = await currentRef.get();
        
        const creatorData = creatorSnap.val();
        const currentData = currentSnap.val();
        
      const followersArr = Array.isArray(creatorData?.followers) ? [...creatorData.followers] : (creatorData?.followers && typeof creatorData.followers === 'object' ? Object.keys(creatorData.followers) : []);
      const followingArr = Array.isArray(currentData?.following) ? [...currentData.following] : (currentData?.following && typeof currentData.following === 'object' ? Object.keys(currentData.following) : []);
      
      const isFollowing = followersArr.includes(auth.currentUser.uid);
      
      if(isFollowing) {
        const newFollowers = followersArr.filter(uid => uid !== auth.currentUser.uid);
        const newFollowing = followingArr.filter(uid => uid !== creatorUid);
        await creatorRef.update({ followers: newFollowers });
        await currentRef.update({ following: newFollowing });
        msg("Unfollowed!");
      } else {
        const newFollowers = [...followersArr, auth.currentUser.uid];
        const newFollowing = [...followingArr, creatorUid];
        await creatorRef.update({ followers: newFollowers });
        await currentRef.update({ following: newFollowing });
          db.ref('users/' + creatorUid + '/notifications').push({
            type: 'follow',
            text: userData.username + ' mulai mengikuti kamu',
            fromName: userData.username,
            fromUid: auth.currentUser.uid,
            timestamp: Date.now()
          });
          msg("Followed! âœ…");
        }
        await updateCreatorFollowUI(creatorUid);
      } catch(err) {
        msg("Error: " + err.message);
      }
    }

    let userCache = {};

    function openList(f) {
      const c = document.getElementById('songContainer');
      const l = f ? songs.filter(s => fav.includes(s.url)) : songs;
      c.innerHTML = '<p style="text-align:center; padding:20px; color:#555">Memuat...</p>';
      
      const html = l.map(s => {
          let badge = '';
          let crown = '';
          if(userCache[s.uid]) {
              if(userCache[s.uid].followers >= 50) badge = '<i class="fas fa-check-circle v-badge" style="font-size:10px; margin-left:3px"></i>';
              if(userCache[s.uid].vip) crown = ' <i class="fas fa-crown" style="color:#ffd700; font-size:10px; margin-left:4px"></i>';
          }
          return `<div class="song-item" onclick="setup(${songs.indexOf(s)}); closeModal()">
            <div style="flex:1">
                <b>${s.title}</b><br>
                <small id="artist-${s.key}" class="artist" data-uid="${s.uid}" style="color:#777">@${s.by}${badge}${crown}</small>
            </div>
            <span onclick="toggleFav('${s.url}', event)" style="color:${fav.includes(s.url)?'var(--accent)':'#444'}">
                <i class="fas fa-heart"></i>
            </span>
          </div>`;
      }).join('');
      
      c.innerHTML = html;
      document.getElementById('modalList').style.display='block';
      
      l.forEach(s => {
          if(!userCache[s.uid] && s.uid) {
             userCache[s.uid] = { followers: 0, vip: false, fetching: true };
             
             db.ref('users/' + s.uid).get().then(snap => {
                 const val = snap.val() || {};
                 let count = 0;
        const fol = val.followers;
        if(Array.isArray(fol)) count = fol.length;
        else if(fol && typeof fol === 'object') count = Object.keys(fol).length;
        else count = fol || 0;
        const vipActiveCache = !!(val.vip || (val.trialvip && val.trialvip.expireAt > Date.now()));
        userCache[s.uid] = { followers: count, vip: vipActiveCache };
                 
                 const els = document.querySelectorAll(`.artist[data-uid="${s.uid}"]`);
                 if(els && els.length) {
                     let add = '';
                     if(count >= 50) add += '<i class="fas fa-check-circle v-badge" style="font-size:10px; margin-left:3px"></i>';
                     if(isVip) add += ' <i class="fas fa-crown" style="color:#ffd700; font-size:10px; margin-left:4px"></i>';
                     els.forEach(e => { e.innerHTML = `@${s.by}${add}`; });
                 }
             });
          }
      });
    }

    function toggleFav(u, e) { 
        e.stopPropagation(); 
        if(fav.includes(u)) {
            fav = fav.filter(x => x !== u);
            showToast('Dihapus dari Favorit');
        } else {
            fav.push(u);
            showToast('â¤ï¸ Ditambahkan ke Favorit');
        }
        localStorage.setItem("exeFav", JSON.stringify(fav)); 
        openList(false);
        if(songs[i] && songs[i].url === u) updateFavBtn();
    }

    function toggleFavorite() {
        if(!songs[i]) return;
        const url = songs[i].url;
        const btn = document.getElementById('btnFav');
        
        if(fav.includes(url)) {
            fav = fav.filter(u => u !== url);
            showToast('Dihapus dari Favorit');
            btn.classList.remove('active');
            btn.innerHTML = '<i class="far fa-heart"></i>';
        } else {
            fav.push(url);
            showToast('â¤ï¸ Ditambahkan ke Favorit');
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-heart"></i>';
        }
        localStorage.setItem("exeFav", JSON.stringify(fav));
        if(document.getElementById('modalList').style.display === 'block') openList(false);
    }

    function updateFavBtn() {
        if(!songs[i]) return;
        const btn = document.getElementById('btnFav');
        if(fav.includes(songs[i].url)) {
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-heart"></i>';
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<i class="far fa-heart"></i>';
        }
    }

    function toggleShuffle() { 
        isShuf = !isShuf; 
        localStorage.setItem('exeShuffle', isShuf);
        document.getElementById('shuf').classList.toggle('active', isShuf); 
        showToast(isShuf ? 'ðŸ”€ Shuffle Aktif' : 'Shuffle Non-aktif');
    }

    function toggleRepeat() { 
        repeatMode = (repeatMode + 1) % 3;
        localStorage.setItem('exeRepeat', repeatMode);
        
        const btn = document.getElementById('rep');
        if(repeatMode === 0) {
            btn.classList.remove('active');
            btn.innerHTML = '<i class="fas fa-redo"></i>';
            showToast('Repeat OFF');
        } else if(repeatMode === 1) {
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-redo"></i><span style="font-size:8px;position:absolute;top:8px;right:8px;font-weight:bold;background:var(--bg);border-radius:50%;padding:1px 3px;">1</span>';
            showToast('ðŸ” Repeat: One');
        } else {
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-redo"></i>';
            showToast('ðŸ” Repeat: All');
        }
    }

    function showToast(text) {
        const container = document.getElementById('toast-container');
        if(!container) return;
        const el = document.createElement('div');
        el.className = 'toast';
        
        let icon = 'fa-info-circle';
        if(text.includes('Playing')) icon = 'fa-music';
        if(text.includes('Favorit')) icon = 'fa-heart';
        if(text.includes('Shuffle')) icon = 'fa-random';
        if(text.includes('Repeat')) icon = 'fa-redo';
        
        el.innerHTML = `<i class="fas ${icon}"></i> <span>${text}</span>`;
        container.appendChild(el);
        
        setTimeout(() => {
            el.classList.add('hide');
            setTimeout(() => el.remove(), 300);
        }, 2500);
    }

    function buildDeepLink() { return window.location.origin + window.location.pathname + "?id=" + i; }
    function copyRawUrl() { openCopyAudio(); }
    
    function shareLink() { 
        const link = buildDeepLink();
        navigator.clipboard.writeText(link); 
        msg("Link lagu dengan ID disalin"); 
    }
    function shareProfile(uid, username) {
        const link = window.location.origin + window.location.pathname + '?profile_userid=' + uid;
        navigator.clipboard.writeText(link);
        showToast('Link profil @' + (username||'user') + ' disalin');
    }
    function shareToWhatsApp() {
        const name = (userData && userData.username) ? userData.username : 'Guest';
        const title = (songs[i] && songs[i].title) ? songs[i].title : 'Lagu ExeMusic';
        const link = buildDeepLink();
        const text = "Hello " + name + " telah berbagi link ExeMusic:\nðŸŽµ " + title + "\nðŸ”— " + link;
        window.open("https://wa.me/?text=" + encodeURIComponent(text));
    }
    function openCopyAudio() {
        const url = (songs[i] && songs[i].url) ? songs[i].url : '';
        const el = document.getElementById('copyAudioText');
        if(el) el.textContent = url || 'URL belum dibuat';
        document.getElementById('modalCopyAudio').style.display = 'block';
    }
    function copyBuiltAudio() {
        const t = document.getElementById('copyAudioText').textContent;
        if(!t || t === 'URL belum dibuat') return;
        navigator.clipboard.writeText(t).then(() => showToast("Link audio disalin"));
        document.getElementById('modalCopyAudio').style.display = 'none';
    }
    
    function downloadSong() { window.open(songs[i].url); }
    function openReq() { document.getElementById('modalReq').style.display='block'; }
    function openAbout() { document.getElementById('modalAbout').style.display='block'; }
    function openBoomboxTutorial() { document.getElementById('modalBoombox').style.display='block'; }
    function toggleAuthMode() { /* Google Sign-In only - not used */ }
    function sendWA() { window.open(`https://wa.me/62895329018240?text=Halo Admin, saya ${document.getElementById('guestName').value} ingin upload: ${document.getElementById('guestLagu').value}`); }
    function openAdmin() { if(userData?.role === 'admin') window.location.href = 'admmenu.html'; }

    function openClearNotifConfirm() {
        document.getElementById('modalClearNotif').style.display = 'block';
    }
    function confirmClearNotif() {
        if(!auth.currentUser) return msg("Login dulu!");
        const ref = db.ref('users/' + auth.currentUser.uid + '/notifications');
        ref.set(null).then(() => ref.get()).then(snap => {
            if(snap.exists()) {
                const val = snap.val() || {};
                const keys = Object.keys(val);
                return Promise.all(keys.map(k => ref.child(k).remove()));
            }
        }).then(() => {
            document.getElementById('modalClearNotif').style.display = 'none';
            mergeAndRenderNotifs([], 'user');
            updateNotifBadge();
            showToast("Notifikasi dibersihkan");
        }).catch(() => {
            showToast("Gagal menghapus notifikasi");
        });
    }
    function openCopyLink() {
        const link = window.location.origin + window.location.pathname + "?id=" + i;
        const el = document.getElementById('copyLinkText');
        if(el) el.textContent = link;
        document.getElementById('modalCopyLink').style.display = 'block';
    }
    function copyBuiltLink() {
        const t = document.getElementById('copyLinkText').textContent;
        if(!t || t === 'URL belum dibuat') return;
        navigator.clipboard.writeText(t).then(() => showToast("Link lagu dengan ID disalin"));
        document.getElementById('modalCopyLink').style.display = 'none';
    }

    let isFirstTimeUser = false;

    function handleAuth() {
      /* Old function - replaced by handleGoogleAuth */
    }

    function handleGoogleAuth() {
      if(isFirstTimeUser) {
        const username = document.getElementById('authUser').value.trim();
        
        if(!username || username.length < 3) {
          msg('âŒ Username minimal 3 karakter!');
          return;
        }
        
        const user = auth.currentUser;
        if(!user) {
          msg('âŒ Session expired, silakan coba lagi');
          isFirstTimeUser = false;
          document.getElementById('usernameSection').style.display = 'none';
          document.getElementById('googleBtnText').innerText = 'Masuk dengan Google';
          return;
        }
        
        db.ref('users/' + user.uid).set({
          username: username,
          email: user.email,
          avatar: user.photoURL || "https://via.placeholder.com/150",
          role: 'user',
          followers: {},
          following: {},
          tag: 'user',
          createdAt: Date.now()
        }).then(() => {
          isFirstTimeUser = false;
          document.getElementById('usernameSection').style.display = 'none';
          document.getElementById('googleBtnText').innerText = 'Masuk dengan Google';
          closeModal();
          msg('âœ… Akun berhasil dibuat! Selamat datang ' + username + '!');
        }).catch(err => {
          msg('âŒ Gagal menyimpan data: ' + err.message);
        });
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({
          prompt: 'select_account'
        });
        
        auth.signInWithPopup(provider)
          .then(result => {
            const user = result.user;
            const isNewUser = result.additionalUserInfo.isNewUser;
            
            if(isNewUser) {
              isFirstTimeUser = true;
              document.getElementById('googleBtnText').innerText = 'Buat Akun';
              document.getElementById('usernameSection').style.display = 'block';
              msg('ðŸ‘‹ Selamat datang! Buat username Anda untuk melanjutkan.');
            } else {
              closeModal();
              msg('âœ… Selamat datang kembali!');
            }
          })
          .catch(err => {
            if(err.code === 'auth/popup-closed-by-user') {
              msg('âš ï¸ Login dibatalkan');
            } else if(err.code === 'auth/cancelled-popup-request') {
            } else {
              msg('âŒ Gagal login: ' + err.message);
            }
          });
      }
    }

    function uploadAvatar(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            db.ref('users/' + auth.currentUser.uid).update({ avatar: e.target.result }).then(() => msg("Profil Updated!"));
        };
        reader.readAsDataURL(file);
    }

    function switchProfileTab(tab) {
        document.querySelectorAll('.mp-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('myPostList').style.display = 'none';
        document.getElementById('myLikeList').style.display = 'none';
        
        if(tab === 'posts') {
            document.getElementById('tabPosts').classList.add('active');
            document.getElementById('myPostList').style.display = 'flex';
        } else if(tab === 'likes') {
            document.getElementById('tabLikes').classList.add('active');
            document.getElementById('myLikeList').style.display = 'flex';
        }
    }

    function openChangeNameModal() {
      document.getElementById('cnMsg').innerText = '';
      document.getElementById('cnMsg').classList.remove('show', 'success', 'error');
      document.getElementById('cnPass').value = '';
      document.getElementById('cnNewName').value = '';
      document.getElementById('modalChangeNames').style.display = 'block';
    }

    async function handleChangeName() {
      const password = document.getElementById('cnPass').value;
      const newName = document.getElementById('cnNewName').value;
      const msgEl = document.getElementById('cnMsg');
      
      msgEl.classList.remove('success', 'error');
      
      if(!newName || !password) {
        msgEl.innerText = 'âš ï¸ Isi semua field!';
        msgEl.classList.add('show', 'error');
        return;
      }
      if(newName.length < 3) {
        msgEl.innerText = 'âš ï¸ Nama minimal 3 karakter!';
        msgEl.classList.add('show', 'error');
        return;
      }
      
      const lastChange = userData.lastNameChange || 0;
      const now = Date.now();
      const diffDays = (now - lastChange) / (1000 * 60 * 60 * 24);
      
      if(diffDays < 7) {
        msgEl.innerText = `â³ Tunggu ${Math.ceil(7 - diffDays)} hari lagi!`;
        msgEl.classList.add('show', 'error');
        return;
      }
      
      const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, password);
      
      try {
        await auth.currentUser.reauthenticateWithCredential(credential);
        await db.ref('users/' + auth.currentUser.uid).update({
          username: newName,
          lastNameChange: Date.now()
        });
        msgEl.innerText = 'âœ… Nama berhasil diubah!';
        msgEl.classList.add('show', 'success');
        setTimeout(() => {
          document.getElementById('modalChangeNames').style.display = 'none';
          msg('Nama pengguna telah diperbarui!');
        }, 1500);
      } catch(err) {
        msgEl.innerText = 'âŒ Password salah!';
        msgEl.classList.add('show', 'error');
      }
    }

    function openChangePasswordModal() {
      document.getElementById('cpMsg').innerText = '';
      document.getElementById('cpMsg').classList.remove('show', 'success', 'error');
      document.getElementById('cpOldPass').value = '';
      document.getElementById('cpNewPass').value = '';
      document.getElementById('cpConfirm').value = '';
      document.getElementById('modalChangePass').style.display = 'block';
    }

    async function handleChangePassword() {
      const oldPass = document.getElementById('cpOldPass').value;
      const newPass = document.getElementById('cpNewPass').value;
      const confirm = document.getElementById('cpConfirm').value;
      const msgEl = document.getElementById('cpMsg');
      
      msgEl.classList.remove('success', 'error');
      
      if(!oldPass || !newPass || !confirm) {
        msgEl.innerText = 'âš ï¸ Isi semua field!';
        msgEl.classList.add('show', 'error');
        return;
      }
      if(newPass.length < 6) {
        msgEl.innerText = 'âš ï¸ Password minimal 6 karakter!';
        msgEl.classList.add('show', 'error');
        return;
      }
      if(newPass !== confirm) {
        msgEl.innerText = 'âš ï¸ Password tidak cocok!';
        msgEl.classList.add('show', 'error');
        return;
      }
      
      const lastChange = userData.lastPasswordChange || 0;
      const now = Date.now();
      const diffDays = (now - lastChange) / (1000 * 60 * 60 * 24);
      
      if(diffDays < 7) {
        msgEl.innerText = `â³ Tunggu ${Math.ceil(7 - diffDays)} hari lagi!`;
        msgEl.classList.add('show', 'error');
        return;
      }
      
      const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, oldPass);
      
      try {
        await auth.currentUser.reauthenticateWithCredential(credential);
        await auth.currentUser.updatePassword(newPass);
        await db.ref('users/' + auth.currentUser.uid).update({
          lastPasswordChange: Date.now()
        });
        msgEl.innerText = 'âœ… Password berhasil diubah!';
        msgEl.classList.add('show', 'success');
        setTimeout(() => {
          document.getElementById('modalChangePass').style.display = 'none';
          msg('Password telah diperbarui!');
        }, 1500);
      } catch(err) {
        msgEl.innerText = 'âŒ Password lama salah!';
        msgEl.classList.add('show', 'error');
      }
    }
  


  </script>
</body>
</html>
