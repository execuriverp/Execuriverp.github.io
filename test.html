<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ExeMusic 3.2</title>
  <link rel="icon" type="image/png" href="exemusicicon.png">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Exo+2:wght@400;600;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #00ff88;
      --accent2: #00d4ff;
      --text: #ffffff;
      --text-dim: #b3b3b3;
      --bg: #040408;
      --card-bg: #0d0d15;
      --glass: rgba(255,255,255,0.05);
      --danger: #ff3333;
      --warning: #ffcc00;
      --tiktok-red: #ff0050;
      --gold: #ffd700;
      --purple: #bf00ff;
      --pink: #ff69b4;
      --deep-pink: #ff1493;
      --ml-blue: #1a237e;
      --ml-gold: #ffc107;
      --ml-red: #b71c1c;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Exo 2', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    /* ============================================================
       LOADING SCREEN - GAME STYLE
    ============================================================ */
    #gameLoadScreen {
      position: fixed; inset: 0; z-index: 99999;
      background: radial-gradient(ellipse at 50% -20%, rgba(0,212,255,0.15), transparent 60%),
                  radial-gradient(ellipse at 80% 100%, rgba(0,255,136,0.1), transparent 50%),
                  linear-gradient(180deg, #030308 0%, #06060f 50%, #030308 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.8s ease, transform 0.8s ease;
    }
    #gameLoadScreen.fade-out {
      opacity: 0;
      transform: scale(1.05);
      pointer-events: none;
    }

    .load-logo-wrap {
      position: relative;
      margin-bottom: 40px;
    }
    .load-logo-ring {
      width: 110px; height: 110px; border-radius: 50%;
      border: 2px solid transparent;
      background: linear-gradient(#030308, #030308) padding-box,
                  linear-gradient(135deg, var(--accent), var(--accent2), var(--purple)) border-box;
      display: flex; align-items: center; justify-content: center;
      position: relative;
      animation: ringPulse 2s ease-in-out infinite;
    }
    @keyframes ringPulse {
      0%, 100% { box-shadow: 0 0 15px rgba(0,255,136,0.3), inset 0 0 15px rgba(0,255,136,0.05); }
      50% { box-shadow: 0 0 35px rgba(0,255,136,0.6), 0 0 60px rgba(0,212,255,0.2), inset 0 0 25px rgba(0,255,136,0.1); }
    }
    .load-logo-ring-outer {
      position: absolute; inset: -8px; border-radius: 50%;
      border: 1px solid rgba(0,255,136,0.2);
      animation: ringOuterSpin 8s linear infinite;
    }
    @keyframes ringOuterSpin {
      to { transform: rotate(360deg); }
    }
    .load-logo-ring-outer::before {
      content: '';
      position: absolute; top: -2px; left: 50%; transform: translateX(-50%);
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
    }
    .load-logo-icon {
      font-size: 40px; color: var(--accent);
      text-shadow: 0 0 20px var(--accent);
    }

    .load-title {
      font-family: 'Rajdhani', sans-serif;
      font-size: 32px; font-weight: 700;
      letter-spacing: 6px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .load-subtitle {
      font-size: 11px; color: rgba(255,255,255,0.3);
      letter-spacing: 3px; text-transform: uppercase;
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 50px;
    }

    .load-bar-wrap {
      width: 320px; max-width: 90vw;
      margin-bottom: 16px;
    }
    .load-bar-track {
      width: 100%; height: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .load-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2), var(--accent));
      background-size: 200% 100%;
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      animation: barShimmer 1.5s linear infinite;
    }
    @keyframes barShimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .load-bar-fill::after {
      content: '';
      position: absolute; right: 0; top: 50%; transform: translateY(-50%);
      width: 12px; height: 12px; border-radius: 50%;
      background: white;
      box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent2);
    }
    .load-bar-glow {
      position: absolute; inset: 0;
      background: linear-gradient(90deg, transparent, rgba(0,255,136,0.15), transparent);
      animation: glowSlide 1.5s ease-in-out infinite;
    }
    @keyframes glowSlide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .load-info-row {
      display: flex; justify-content: space-between;
      align-items: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
    }
    .load-status { color: rgba(255,255,255,0.4); letter-spacing: 1px; }
    .load-percent {
      font-weight: 700; font-size: 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .load-dots {
      display: flex; gap: 8px; margin-top: 30px;
    }
    .load-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(255,255,255,0.15);
      animation: dotPulse 1.2s ease-in-out infinite;
    }
    .load-dot:nth-child(1) { animation-delay: 0s; }
    .load-dot:nth-child(2) { animation-delay: 0.2s; }
    .load-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotPulse {
      0%, 100% { background: rgba(255,255,255,0.15); transform: scale(1); }
      50% { background: var(--accent); transform: scale(1.4); box-shadow: 0 0 8px var(--accent); }
    }

    /* corner decorations */
    .load-corner {
      position: absolute;
      width: 30px; height: 30px;
      border-color: rgba(0,255,136,0.3);
      border-style: solid;
    }
    .load-corner.tl { top: 20px; left: 20px; border-width: 2px 0 0 2px; }
    .load-corner.tr { top: 20px; right: 20px; border-width: 2px 2px 0 0; }
    .load-corner.bl { bottom: 20px; left: 20px; border-width: 0 0 2px 2px; }
    .load-corner.br { bottom: 20px; right: 20px; border-width: 0 2px 2px 0; }

    /* ============================================================
       VELLY TAG - PINK HEARTS EFFECT
    ============================================================ */
    .tag-velly {
      background:
        radial-gradient(circle at 0 0, rgba(255,182,193,0.55), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(255,192,203,0.45), transparent 55%),
        linear-gradient(135deg, #ff1493, #ff69b4, #ff1493);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.7);
      font-weight: 900;
      letter-spacing: 1px;
      box-shadow: 0 0 14px rgba(255,20,147,0.9), 0 0 28px rgba(255,105,180,0.7);
      position: relative;
      overflow: visible;
      border-radius: 999px;
      animation: vellyPulse 1.7s ease-in-out infinite;
    }
    .tag-velly::before,
    .tag-velly::after {
      content: '❤';
      position: absolute;
      top: -6px;
      font-size: 9px;
      opacity: 0.9;
    }
    .tag-velly::before {
      left: -4px;
      transform: rotate(-12deg);
    }
    .tag-velly::after {
      right: -4px;
      transform: rotate(10deg);
    }
    @keyframes vellyPulse {
      0%, 100% { box-shadow: 0 0 12px rgba(255,20,147,0.6), inset 0 0 8px rgba(255,255,255,0.2); }
      50% { box-shadow: 0 0 22px rgba(255,20,147,0.9), 0 0 40px rgba(255,105,180,0.4), inset 0 0 12px rgba(255,255,255,0.3); }
    }

    /* floating hearts around velly tag */
    .hearts-container {
      position: fixed; pointer-events: none; z-index: 99990;
      width: 100vw; height: 100vh; top: 0; left: 0;
      overflow: hidden;
      display: none;
    }
    .hearts-container.active { display: block; }
    
    .heart-particle {
      position: absolute;
      bottom: -30px;
      font-size: 14px;
      animation: floatHeart linear infinite;
      opacity: 0;
    }
    @keyframes floatHeart {
      0% { transform: translateY(0) rotate(0deg) scale(0.5); opacity: 0; }
      10% { opacity: 1; }
      80% { opacity: 0.8; }
      100% { transform: translateY(-100vh) rotate(360deg) scale(1.2); opacity: 0; }
    }

    /* ============================================================
       BROADCAST SYSTEM
    ============================================================ */
    .sys-broadcast {
        position: fixed; top: -150px; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 400px;
        background: rgba(15,15,20,0.97);
        border-left: 4px solid var(--accent);
        border-radius: 8px; padding: 15px; z-index: 12000;
        box-shadow: 0 10px 40px rgba(0,0,0,0.8), 0 0 20px rgba(0,255,136,0.1);
        display: flex; flex-direction: column;
        transition: top 0.5s cubic-bezier(0.175,0.885,0.32,1.275), opacity 0.4s ease;
        backdrop-filter: blur(15px);
    }
    .sys-broadcast.active { top: 20px; }
    .sb-content { display: flex; align-items: flex-start; gap: 12px; }
    .sb-icon { font-size: 20px; color: var(--accent); margin-top: 2px; }
    .sb-text h4 { margin: 0; font-size: 14px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
    .sb-text p { margin: 4px 0 0; font-size: 12px; color: #ddd; line-height: 1.4; }
    .sb-close { position: absolute; top: 10px; right: 10px; background: transparent; border: none; color: #666; cursor: pointer; font-size: 16px; padding: 5px; }
    .sb-close:hover { color: white; }
    .sb-progress { width: 100%; height: 3px; background: #333; margin-top: 12px; border-radius: 2px; overflow: hidden; }
    .sb-bar { width: 100%; height: 100%; background: var(--accent); transform-origin: left; }
    @keyframes countDown { from { transform: scaleX(1); } to { transform: scaleX(0); } }
    .sys-broadcast.sb-closing { top: -180px !important; opacity: 0; transition: top 0.4s ease, opacity 0.4s ease; }
    .sb-dev-name { color: #00d4ff; font-weight: 700; text-shadow: 0 0 8px #00d4ff; }

    /* ============================================================
       ADMIN FLOAT CHAT (GLOBAL)
    ============================================================ */
    .admin-float-chat {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 420px;
      width: calc(100% - 40px);
      padding: 10px 14px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0, rgba(0,212,255,0.35), transparent 55%),
                  radial-gradient(circle at 100% 0, rgba(0,255,136,0.35), transparent 55%),
                  rgba(5,5,15,0.96);
      border: 1px solid rgba(0,255,136,0.3);
      box-shadow: 0 14px 40px rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 12500;
      pointer-events: none;
      overflow: hidden;
    }
    .admin-float-chat.show {
      display: flex;
      animation: floatChatIn 0.25s ease-out;
    }
    .admin-float-name {
      font-size: 11px;
      font-weight: 700;
      color: #e0f2ff;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .admin-float-name i {
      color: #1da1f2;
    }
    .admin-float-msg {
      font-size: 12px;
      color: #f5f5f5;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      flex: 1;
    }
    .admin-float-timer {
      font-size: 10px;
      color: #9ca3af;
      margin-left: 6px;
      white-space: nowrap;
    }
    @media (max-width: 480px) {
      .admin-float-chat {
        top: 60px;
        padding: 8px 10px;
        width: calc(100% - 24px);
      }
      .admin-float-name {
        font-size: 10px;
      }
      .admin-float-msg {
        font-size: 11px;
      }
    }
    @keyframes floatChatIn {
      from { opacity: 0; transform: translate(-50%, -10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* ============================================================
       OVERLAYS
    ============================================================ */
    .full-overlay {
      position: fixed; inset: 0; background: #000; z-index: 10000;
      display: none; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; padding: 30px;
    }
    .full-overlay i { font-size: 60px; margin-bottom: 20px; }
    .full-overlay h1 { font-size: 24px; color: var(--accent); }
    .full-overlay p { color: var(--text-dim); margin-top: 10px; }
    #bannedScreen h1 { color: var(--danger); }

    /* ============================================================
       MAIN APP - MOBILE LEGENDS STYLE
    ============================================================ */
    .app {
      background: linear-gradient(145deg, rgba(13,13,21,0.9) 0%, rgba(8,8,16,0.95) 100%);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border: 1px solid rgba(0,255,136,0.12);
      border-radius: 28px;
      width: 95%; max-width: 400px;
      height: 95vh;
      display: flex; flex-direction: column;
      padding: 22px;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 40px rgba(0,255,136,0.05), inset 0 1px 0 rgba(255,255,255,0.06);
      overflow: hidden;
    }
    .app::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent), var(--accent2), transparent);
      opacity: 0.6;
    }

    /* ML Corner Decorations */
    .ml-corner {
      position: absolute; width: 16px; height: 16px; pointer-events: none;
    }
    .ml-corner::before, .ml-corner::after { content: ''; position: absolute; background: var(--accent); opacity: 0.5; }
    .ml-corner-tl { top: 12px; left: 12px; }
    .ml-corner-tl::before { top: 0; left: 0; width: 100%; height: 2px; }
    .ml-corner-tl::after { top: 0; left: 0; width: 2px; height: 100%; }
    .ml-corner-tr { top: 12px; right: 12px; }
    .ml-corner-tr::before { top: 0; right: 0; width: 100%; height: 2px; }
    .ml-corner-tr::after { top: 0; right: 0; width: 2px; height: 100%; }
    .ml-corner-bl { bottom: 12px; left: 12px; }
    .ml-corner-bl::before { bottom: 0; left: 0; width: 100%; height: 2px; }
    .ml-corner-bl::after { bottom: 0; left: 0; width: 2px; height: 100%; }
    .ml-corner-br { bottom: 12px; right: 12px; }
    .ml-corner-br::before { bottom: 0; right: 0; width: 100%; height: 2px; }
    .ml-corner-br::after { bottom: 0; right: 0; width: 2px; height: 100%; }

    /* ============================================================
       HEADER
    ============================================================ */
    .header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; margin-bottom: 15px; }
    .header img { width: 100px; cursor: pointer; transition: 0.3s; filter: drop-shadow(0 0 8px rgba(0,255,136,0.3)); }
    .header img:active { transform: scale(0.9); }
    .header-right { display: flex; align-items: center; gap: 8px; }

    #btnNotif {
      position: relative; width: 40px; height: 40px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 50%; color: white; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 17px; transition: 0.2s;
    }
    #btnNotif:hover { background: var(--accent); color: black; border-color: var(--accent); }
    #btnNotif .notif-badge { position: absolute; top: -2px; right: -2px; min-width: 17px; height: 17px; background: var(--danger); border-radius: 9px; font-size: 9px; font-weight: 700; display: none; align-items: center; justify-content: center; padding: 0 3px; }
    #btnNotif .notif-badge.show { display: flex; }
    #btnEvent {
      width: 40px; height: 40px;
      background: rgba(76,81,191,0.15);
      border: 1px solid rgba(76,81,191,0.4);
      border-radius: 50%; color: #c4b5fd; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s;
    }
    #btnEvent:hover { background: rgba(76,81,191,0.5); color: #fff; box-shadow: 0 0 18px rgba(76,81,191,0.6); }

    #btnAdmin {
      display: none;
      width: 40px; height: 40px;
      background: linear-gradient(135deg, rgba(255,193,7,0.15), rgba(255,152,0,0.08));
      border: 1px solid rgba(255,193,7,0.25);
      border-radius: 50%; color: var(--ml-gold); cursor: pointer;
      align-items: center; justify-content: center; font-size: 16px; transition: 0.2s;
      box-shadow: 0 0 10px rgba(255,193,7,0.1);
    }
    #btnAdmin:hover { background: var(--ml-gold); color: black; box-shadow: 0 0 20px rgba(255,193,7,0.4); }
    #btnAdmin.show { display: flex; }

    #topLoginBtn {
      background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,212,255,0.05));
      border: 1px solid rgba(0,255,136,0.2);
      color: var(--accent); padding: 8px 15px; border-radius: 20px; font-size: 11px; cursor: pointer;
      font-weight: 700; transition: 0.2s; font-family: 'Rajdhani', sans-serif; letter-spacing: 1px;
    }
    #topLoginBtn:hover { background: var(--accent); color: black; border-color: var(--accent); }

    /* ============================================================
       NOTIF PANEL
    ============================================================ */
    .notif-panel {
      position: fixed;
      top: 70px; right: 10px; /* fallback, overridden by JS */
      width: min(calc(100vw - 20px), 360px);
      max-height: min(72vh, 600px);
      background: rgba(8,8,18,0.98); border: 1px solid rgba(0,255,136,0.18);
      border-radius: 20px; box-shadow: 0 15px 50px rgba(0,0,0,0.8), 0 0 30px rgba(0,255,136,0.08);
      z-index: 9000; display: none; flex-direction: column; overflow: hidden;
      backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
      animation: notifPanelIn 0.25s ease;
    }
    .notif-panel.show { display: flex; }
    @keyframes notifPanelIn { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }
    .notif-panel-header { padding: 16px 18px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .notif-panel-header h3 { margin: 0; font-size: 15px; color: var(--accent); display: flex; align-items: center; gap: 8px; font-family: 'Rajdhani', sans-serif; letter-spacing: 1px; }
    .notif-panel-close { background: none; border: none; color: #888; font-size: 17px; cursor: pointer; padding: 4px; }
    .notif-panel-close:hover { color: white; }
    .notif-list { overflow-y: auto; flex: 1; padding: 8px 0; min-height: 120px; max-height: 60vh; }
    .notif-list::-webkit-scrollbar { width: 4px; }
    .notif-list::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    .notif-item { padding: 13px 18px; border-bottom: 1px solid rgba(255,255,255,0.04); display: flex; gap: 12px; align-items: flex-start; transition: background 0.2s; }
    .notif-item:hover { background: rgba(255,255,255,0.03); }
    .notif-item-icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0; }
    .notif-item-icon.admin { background: rgba(255,51,51,0.15); color: #ff6b6b; }
    .notif-item-icon.violation { background: rgba(255,204,0,0.15); color: var(--warning); }
    .notif-item-icon.upload { background: rgba(0,255,136,0.1); color: var(--accent); }
    .notif-item-icon.follow { background: rgba(255,0,80,0.1); color: var(--tiktok-red); }
    .notif-item-icon.system { background: rgba(0,212,255,0.1); color: #00d4ff; }
    .notif-item-body { flex: 1; min-width: 0; }
    .notif-item-body .n-text { font-size: 12px; color: #ddd; line-height: 1.4; }
    .notif-item-body .n-time { font-size: 10px; color: #555; margin-top: 3px; }
    .notif-empty { padding: 30px 20px; text-align: center; color: #444; font-size: 12px; }

    /* ============================================================
       EVENT CENTER (MLBB STYLE)
    ============================================================ */
    .event-center-sheet {
      padding: 18px 20px;
      background:
        radial-gradient(circle at 0 0, rgba(0,255,184,0.14), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(56,189,248,0.18), transparent 55%),
        linear-gradient(145deg, #050712 0%, #050510 40%, #030308 100%);
      border-radius: 22px;
      border: 1px solid rgba(37,99,235,0.7);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 18px 50px rgba(0,0,0,0.9),
        inset 0 0 30px rgba(15,23,42,0.85);
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 980px;
      width: calc(100% - 24px);
      margin: 0 auto;
    }
    .event-center-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(148,163,184,0.35);
    }
    .event-center-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Rajdhani', sans-serif;
      letter-spacing: 1.1px;
      font-size: 15px;
      color: #e5e7eb;
      text-transform: uppercase;
    }
    .event-center-title i {
      padding: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, rgba(250,204,21,0.2), transparent),
                  linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #0b1120;
      box-shadow: 0 0 18px rgba(56,189,248,0.7);
    }
    .event-center-coins {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0, rgba(250,204,21,0.16), transparent 60%),
                  rgba(15,23,42,0.98);
      border: 1px solid rgba(250,204,21,0.7);
      box-shadow: 0 0 20px rgba(250,204,21,0.35);
    }
    .event-coins-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fff7c2, #f59e0b);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #92400e;
    }
    .event-coins-body {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
    }
    .event-coins-label {
      font-size: 9px;
      text-transform: uppercase;
      color: #fef9c3;
      opacity: 0.9;
    }
    .event-coins-value {
      font-size: 16px;
      font-weight: 800;
      color: #facc15;
      text-shadow: 0 0 8px rgba(245,158,11,0.9);
    }
    .event-center-layout {
      display: grid;
      grid-template-columns: 140px minmax(0, 1fr) 190px;
      gap: 14px;
      align-items: flex-start;
    }
    .event-center-sidebar {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .event-tab-btn {
      width: 100%;
      border-radius: 18px;
      border: 1px solid rgba(30,64,175,0.9);
      background: radial-gradient(circle at 0 0, rgba(56,189,248,0.12), transparent 60%),
                  rgba(15,23,42,0.98);
      color: #9ca3af;
      font-size: 11px;
      padding: 9px 9px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      outline: none;
      transition: 0.18s;
      font-weight: 600;
    }
    .event-tab-btn i {
      font-size: 13px;
    }
    .event-tab-btn.active {
      background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(56,189,248,0.3));
      border-color: rgba(56,189,248,0.9);
      color: #e5e7eb;
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 0 20px rgba(34,197,94,0.7);
    }
    .event-center-main {
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.16), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,0.16), transparent 55%),
        rgba(15,23,42,0.97);
      border-radius: 18px;
      border: 1px solid rgba(30,64,175,0.9);
      padding: 10px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 0 24px rgba(15,23,42,0.8);
    }
    .event-tab-caption {
      font-size: 10px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .event-quest-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
    }
    .event-quest-list::-webkit-scrollbar {
      width: 4px;
    }
    .event-quest-list::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, #22c55e, #38bdf8);
      border-radius: 999px;
    }
    .event-quest-card {
      border-radius: 14px;
      padding: 9px 10px;
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.16), transparent 70%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,0.16), transparent 70%),
        rgba(15,23,42,0.98);
      border: 1px solid rgba(37,99,235,0.9);
      display: grid;
      grid-template-columns: minmax(0,1fr) auto;
      gap: 8px;
      align-items: center;
      box-shadow: 0 0 18px rgba(15,23,42,0.9);
    }
    .event-quest-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .event-quest-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }
    .event-quest-title {
      font-size: 12px;
      color: #e5e7eb;
      font-weight: 600;
    }
    .event-quest-reward {
      font-size: 11px;
      color: #fbbf24;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .event-quest-reward i {
      font-size: 11px;
    }
    .event-quest-desc {
      font-size: 11px;
      color: #9ca3af;
    }
    .event-quest-progress-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }
    .event-quest-progress-bar {
      position: relative;
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: rgba(31,41,55,0.9);
      overflow: hidden;
    }
    .event-quest-progress-fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, #22c55e, #38bdf8);
      transform-origin: left;
      transform: scaleX(0);
      transition: transform 0.2s ease-out;
    }
    .event-quest-progress-text {
      font-size: 10px;
      color: #9ca3af;
      white-space: nowrap;
    }
    .event-quest-action {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .event-quest-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #e5e7eb;
      background: rgba(37,99,235,0.25);
      border: 1px solid rgba(59,130,246,0.7);
    }
    .event-quest-btn {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #f9fafb;
      box-shadow: 0 0 14px rgba(34,197,94,0.65);
    }
    .event-quest-btn[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      background: rgba(55,65,81,0.85);
    }
    .event-quest-btn.secondary {
      background: rgba(31,41,55,0.95);
      color: #e5e7eb;
      box-shadow: none;
      border: 1px solid rgba(75,85,99,0.95);
    }
    .event-center-sidepanel {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .event-side-card {
      border-radius: 16px;
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.18), transparent 70%),
        rgba(15,23,42,0.98);
      border: 1px solid rgba(37,99,235,0.9);
      padding: 9px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 0 18px rgba(15,23,42,0.9);
    }
    .event-side-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #9ca3af;
    }
    .event-side-body {
      font-size: 11px;
      color: #e5e7eb;
    }
    .event-side-main {
      font-weight: 600;
    }
    .event-side-sub {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .event-side-timer {
      font-size: 10px;
      color: #f97316;
      margin-top: 4px;
    }
    .event-side-tips {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 10px;
      color: #9ca3af;
    }
    .event-side-tips li::before {
      content: '•';
      color: #22c55e;
      display: inline-block;
      margin-right: 4px;
    }
    .event-shop-section {
      border-radius: 16px;
      border: 1px solid rgba(30,64,175,0.8);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.14), transparent 70%),
        rgba(15,23,42,0.98);
      padding: 9px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 0 18px rgba(15,23,42,0.9);
    }
    .event-shop-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.7px;
      color: #e5e7eb;
      border-left: 3px solid #38bdf8;
      padding-left: 6px;
    }
    .event-shop-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .event-shop-card {
      border-radius: 14px;
      padding: 8px 9px;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.92));
      border: 1px solid rgba(51,65,85,0.95);
      display: grid;
      grid-template-columns: minmax(0,1fr) auto;
      gap: 8px;
      align-items: center;
    }
    .event-shop-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .event-shop-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }
    .event-shop-title {
      font-size: 12px;
      color: #e5e7eb;
      font-weight: 600;
    }
    .event-shop-price {
      font-size: 11px;
      color: #fbbf24;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .event-shop-desc {
      font-size: 11px;
      color: #9ca3af;
    }
    .event-shop-progress-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }
    .event-shop-progress-bar {
      position: relative;
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: rgba(31,41,55,0.9);
      overflow: hidden;
    }
    .event-shop-progress-fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, #22c55e, #38bdf8);
      transform-origin: left;
      transform: scaleX(0);
      transition: transform 0.2s ease-out;
    }
    .event-shop-progress-text {
      font-size: 10px;
      color: #9ca3af;
      white-space: nowrap;
    }
    .event-shop-action {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .event-shop-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #e5e7eb;
      background: rgba(37,99,235,0.35);
      border: 1px solid rgba(59,130,246,0.9);
    }
    .event-shop-btn {
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      border: none;
      cursor: default;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(31,41,55,0.96);
      color: #e5e7eb;
      border: 1px solid rgba(75,85,99,0.95);
    }

    /* ============================================================
       COVER BOX
    ============================================================ */
    .cover-box {
      flex: 1; width: 100%; border-radius: 20px;
      background: radial-gradient(ellipse at 30% 30%, rgba(0,255,136,0.05), transparent 50%),
                  radial-gradient(ellipse at 70% 70%, rgba(0,212,255,0.05), transparent 50%),
                  #050510;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 18px;
      border: 1px solid rgba(255,255,255,0.04);
      overflow: hidden; position: relative; z-index: 10;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4), inset 0 0 30px rgba(0,0,0,0.3);
    }
    .cover-box::before {
      content: '';
      position: absolute; inset: 0;
      background: repeating-linear-gradient(0deg, transparent, transparent 30px, rgba(0,255,136,0.01) 30px, rgba(0,255,136,0.01) 31px),
                  repeating-linear-gradient(90deg, transparent, transparent 30px, rgba(0,255,136,0.01) 30px, rgba(0,255,136,0.01) 31px);
    }
    .eq { display: flex; align-items: flex-end; gap: 5px; height: 60px; position: relative; z-index: 15; }
    .eq span { width: 6px; background: linear-gradient(to top, var(--accent), var(--accent2)); border-radius: 10px; height: 10px; transition: height 0.2s ease; box-shadow: 0 0 10px var(--accent); }
    .playing span { animation: wave 0.8s infinite ease-in-out; }
    .playing span:nth-child(1) { animation-delay: 0.1s; }
    .playing span:nth-child(2) { animation-delay: 0.3s; }
    .playing span:nth-child(3) { animation-delay: 0.2s; }
    .playing span:nth-child(4) { animation-delay: 0.4s; }
    .playing span:nth-child(5) { animation-delay: 0.15s; }
    @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 50px; } }

    /* ============================================================
       TRACK INFO
    ============================================================ */
    .track-info { margin-bottom: 16px; flex-shrink: 0; text-align: left; }
    #title { font-size: 20px; font-weight: 800; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 5px; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.5px; }
    .user-row { display: flex; align-items: center; gap: 10px; }
    #by { color: var(--accent); font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    #btnFav { background: none; border: none; color: var(--text-dim); font-size: 14px; cursor: pointer; transition: 0.2s; }
    #btnFav:hover { color: var(--tiktok-red); transform: scale(1.1); }
    #btnFav.active { color: var(--tiktok-red); animation: heartBeat 0.3s ease-in-out; }
    @keyframes heartBeat { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    #btnFollow { font-size: 12px; background: var(--tiktok-red); color: white; border: none; width: 22px; height: 22px; border-radius: 50%; font-weight: bold; cursor: pointer; display: none; transition: 0.2s; align-items: center; justify-content: center; }
    #btnFollow:active { transform: scale(0.9); }

    /* ============================================================
       SYS CONTAINER (TOOLS)
    ============================================================ */
    .sys-container {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 16px; padding: 12px; margin-bottom: 14px; flex-shrink: 0; z-index: 5;
    }
    .sys-tools { display: flex; justify-content: space-between; margin-bottom: 10px; padding: 0 6px; }
    .sys-tools button { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 17px; opacity: 0.7; transition: 0.2s; padding: 4px; }
    .sys-tools button:hover { opacity: 1; transform: translateY(-2px); color: var(--accent); }
    .vol-row { display: flex; align-items: center; gap: 10px; padding: 0 5px; }
    #vol { flex: 1; height: 4px; accent-color: var(--accent); cursor: pointer; border-radius: 2px; }

    /* ============================================================
       PROGRESS
    ============================================================ */
    .prog-area { margin-bottom: 16px; flex-shrink: 0; z-index: 5; }
    #seek { width: 100%; height: 5px; accent-color: var(--accent); cursor: pointer; display: block; border-radius: 2px; }
    .time { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-dim); margin-top: 6px; font-weight: 500; align-items: center; font-family: 'JetBrains Mono', monospace; }
    .loading-spinner { width: 11px; height: 11px; border: 2px solid rgba(0,255,136,0.2); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .loading-spinner.show { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .dur-wrapper { display: flex; align-items: center; gap: 6px; }

    /* ============================================================
       CONTROLS
    ============================================================ */
    .main-ctrl { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; margin-bottom: 18px; flex-shrink: 0; position: relative; z-index: 110; }
    .btn-play {
      width: 62px; height: 62px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: black; font-size: 22px; cursor: pointer;
      box-shadow: 0 0 25px rgba(0,255,136,0.4), 0 0 50px rgba(0,255,136,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
      transition: 0.2s;
    }
    .btn-play:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(0,255,136,0.4); }
    .btn-sec { background: none; border: none; color: rgba(255,255,255,0.8); font-size: 26px; cursor: pointer; padding: 10px; opacity: 0.9; transition: 0.2s; }
    .btn-sec:hover { color: var(--accent); opacity: 1; }
    .btn-sec:active { transform: scale(0.9); }

    /* ============================================================
       FOOTER NAV
    ============================================================ */
    .footer {
      margin-top: auto; display: flex; justify-content: space-between;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.05);
      padding: 13px 25px; border-radius: 20px; flex-shrink: 0; z-index: 10;
    }
    .footer button { background: none; border: none; color: white; font-size: 17px; opacity: 0.4; cursor: pointer; transition: 0.2s; }
    .footer button:hover { opacity: 0.8; }
    .active-btn { color: var(--accent) !important; opacity: 1 !important; text-shadow: 0 0 10px var(--accent); }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; z-index: 2000; backdrop-filter: blur(8px); }
    .sheet {
      position: absolute; bottom: 0; width: 100%; max-width: 400px; left: 50%; transform: translateX(-50%);
      background: linear-gradient(180deg, #121220, #0a0a16);
      border-radius: 28px 28px 0 0; padding: 24px; max-height: 88vh; overflow-y: auto;
      box-shadow: 0 -10px 50px rgba(0,0,0,0.6), 0 -1px 0 rgba(0,255,136,0.1);
      border-top: 1px solid rgba(0,255,136,0.1);
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }
    .sheet::-webkit-scrollbar { width: 4px; }
    .sheet::-webkit-scrollbar-thumb { background: rgba(0,255,136,0.3); border-radius: 10px; }

    .upload-queue-section {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .upload-queue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 11px;
    }
    .upload-queue-title-label {
      font-weight: 600;
      color: #fff;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .upload-queue-info {
      color: #aaa;
      font-size: 10px;
    }
    .upload-queue-list {
      max-height: 150px;
      overflow-y: auto;
      border-radius: 10px;
      background: rgba(8,8,20,0.9);
      border: 1px solid rgba(255,255,255,0.04);
    }
    .upload-queue-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 7px 10px;
      font-size: 11px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      gap: 10px;
    }
    .upload-queue-item:last-child {
      border-bottom: none;
    }
    .upload-queue-main {
      flex: 1;
      min-width: 0;
    }
    .upload-queue-title {
      margin-right: 4px;
      color: #ddd;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .upload-queue-time {
      font-size: 10px;
      color: #888;
    }
    .upload-queue-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .upload-queue-status {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      color: #ccc;
      white-space: nowrap;
    }
    .upload-queue-status.status-queued {
      background: rgba(0,255,136,0.08);
      color: #7bffb9;
    }
    .upload-queue-status.status-processing {
      background: rgba(0,212,255,0.08);
      color: #7be9ff;
    }
    .upload-queue-status.status-done {
      background: rgba(120,120,120,0.2);
      color: #bbb;
    }
    .upload-queue-btn {
      border: none;
      background: rgba(255,255,255,0.06);
      color: #fff;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      cursor: pointer;
    }
    .upload-queue-btn:hover {
      background: rgba(255,255,255,0.12);
    }

    .upload-cd-card {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: radial-gradient(circle at 0 0, rgba(0,255,136,0.12), transparent 55%),
                  radial-gradient(circle at 100% 100%, rgba(0,212,255,0.1), transparent 55%),
                  rgba(6,6,18,0.95);
      border: 1px solid rgba(0,255,136,0.3);
      display: none;
    }
    .upload-cd-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .upload-cd-label {
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: #a3a3ff;
    }
    .upload-cd-timer {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 700;
      color: #00ff88;
    }
    .upload-cd-sub {
      margin-top: 4px;
      font-size: 10px;
      color: #888;
    }

    /* ============================================================
       PROFILE UI
    ============================================================ */
    .modern-profile-header {
      display: flex; flex-direction: column; align-items: center;
      padding: 28px 20px 18px;
      background: linear-gradient(to bottom, rgba(0,255,136,0.04), transparent);
      position: relative;
    }
    .modern-profile-header.vip {
      background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,152,0,0.06), rgba(255,255,255,0.02));
    }
    .modern-profile-header.vip::after {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(circle at 30% 30%, rgba(255,215,0,0.07), transparent 40%);
      animation: vipShine 6s linear infinite; pointer-events: none;
    }
    /* PINK PROFILE */
    .modern-profile-header.pink-profile {
      background: linear-gradient(135deg,
        rgba(255,20,147,0.12) 0%,
        rgba(255,105,180,0.08) 30%,
        rgba(180,0,80,0.06) 60%,
        rgba(255,255,255,0.02) 100%
      );
    }
    .modern-profile-header.pink-profile::before {
      content: ''; position: absolute; inset: 0; pointer-events: none; border-radius: 0;
      background:
        radial-gradient(ellipse at 20% 0%, rgba(255,20,147,0.15), transparent 50%),
        radial-gradient(ellipse at 80% 0%, rgba(255,105,180,0.1), transparent 50%);
    }
    .modern-profile-header.pink-profile::after {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, transparent, #ff1493, #ff69b4, #ff1493, transparent);
      animation: pinkSweep 3s ease-in-out infinite;
    }
    @keyframes pinkSweep { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    @keyframes vipShine { 0% { transform: translate(0,0) rotate(0deg); } 50% { transform: translate(10%,10%) rotate(20deg); } 100% { transform: translate(0,0) rotate(0deg); } }

    .mp-avatar-container { position: relative; margin-bottom: 14px; }
    .mp-avatar { width: 85px; height: 85px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); box-shadow: 0 8px 25px rgba(0,255,136,0.2); }
    .modern-profile-header.vip .mp-avatar { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(255,215,0,0.12), 0 8px 25px rgba(255,215,0,0.2); }
    .modern-profile-header.pink-profile .mp-avatar { border-color: var(--deep-pink); box-shadow: 0 0 0 3px rgba(255,20,147,0.15), 0 8px 25px rgba(255,20,147,0.25); }
    .mp-edit-badge { position: absolute; bottom: 0; right: 0; background: #1a1a2e; color: #fff; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; font-size: 11px; }
    .mp-name-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; justify-content: center; }
    .mp-name { font-size: 18px; font-weight: 800; color: #fff; font-family: 'Rajdhani', sans-serif; }
    .mp-handle { font-size: 11px; color: #666; margin-bottom: 10px; }
    .mp-stats { display: flex; gap: 28px; margin-bottom: 18px; }
    .mp-stat-item { text-align: center; cursor: pointer; }
    .mp-stat-val { display: block; font-size: 16px; font-weight: 800; color: #fff; font-family: 'Rajdhani', sans-serif; }
    .mp-stat-label { font-size: 10px; color: #666; letter-spacing: 0.5px; }
    .mp-actions { display: flex; gap: 7px; width: 100%; margin-bottom: 14px; flex-wrap: nowrap; overflow-x: auto; padding: 5px; border-radius: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); justify-content: center; }
    .mp-btn { flex: 0 0 auto; padding: 8px 11px; border-radius: 6px; border: none; font-weight: 700; font-size: 11px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.5px; }
    .mp-btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #000; }
    .mp-btn-sec { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
    .mp-btn-pink { background: linear-gradient(135deg, #ff1493, #ff69b4); color: #fff; }
    .mp-tabs { display: flex; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.06); margin-bottom: 10px; }
    .mp-tab { flex: 1; padding: 12px; text-align: center; color: #555; cursor: pointer; font-size: 11px; font-weight: 700; position: relative; transition: 0.2s; font-family: 'Rajdhani', sans-serif; letter-spacing: 1px; }
    .mp-tab.active { color: var(--accent); }
    .mp-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--accent), transparent); }
    .mp-list { display: flex; flex-direction: column; gap: 6px; padding: 0 12px 18px; max-height: 280px; overflow-y: auto; }
    .mp-song-item { display: flex; align-items: center; gap: 10px; padding: 9px; border-radius: 10px; background: rgba(255,255,255,0.02); cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
    .mp-song-item:hover { background: rgba(255,255,255,0.05); border-color: rgba(0,255,136,0.1); }
    .mp-song-icon { width: 30px; height: 30px; border-radius: 6px; background: rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--accent); }
    .mp-song-info { flex: 1; min-width: 0; }
    .mp-song-title { font-size: 12px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mp-song-artist { font-size: 10px; color: #555; }

    /* ============================================================
       SONG LIST
    ============================================================ */
    .song-item { padding: 13px; border-bottom: 1px solid rgba(255,255,255,0.04); cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-radius: 10px; transition: 0.2s; }
    .song-item:hover { background: rgba(255,255,255,0.04); }

    /* ============================================================
       INPUTS & BUTTONS
    ============================================================ */
    .inp-dark {
      width:100%; padding:13px; margin-bottom:10px;
      background: rgba(0,0,0,0.4); color:white;
      border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; font-size: 13px;
      transition: border-color 0.2s;
    }
    .inp-dark:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,255,136,0.08); }
    .btn-act {
      width:100%; padding:13px; background: linear-gradient(135deg, var(--accent), var(--accent2));
      border:none; border-radius:12px; font-weight:800; color:black; cursor: pointer; margin-top: 5px;
      font-size: 14px; text-transform: uppercase; letter-spacing: 1.5px; font-family: 'Rajdhani', sans-serif;
      box-shadow: 0 5px 20px rgba(0,255,136,0.3);
      transition: 0.2s;
    }
    .btn-act:hover { transform: translateY(-1px); box-shadow: 0 8px 28px rgba(0,255,136,0.4); }

    /* ============================================================
       TAGS
    ============================================================ */
    .user-tag {
      font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 800;
      text-transform: uppercase; margin-left: 4px; vertical-align: middle; letter-spacing: 0.5px;
      font-family: 'Rajdhani', sans-serif;
    }
    .tag-vip {
      background: linear-gradient(135deg, #ffd700, #ff9800);
      color: #000;
      box-shadow: 0 0 10px rgba(255,215,0,0.6);
      border: 1px solid rgba(0,0,0,0.3);
    }
    .tag-newbie {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #7dd3fc;
      border: 1px solid rgba(125,211,252,0.4);
    }
    .tag-admin { background: #ff3333; color: #fff; }
    .tag-staff { background: #0088ff; color: #fff; }
    .tag-executive { background: #aa00ff; color: #fff; }
    .tag-user { background: #2a2a3a; color: #999; border: 1px solid rgba(255,255,255,0.1); }
    .tag-sepuh { background: #1a1a2e; color: var(--accent); border: 1px solid var(--accent); }
    .tag-rich { background: linear-gradient(45deg, gold, #fff9c4); color: #000; }
    .tag-galau { background: #2a2a3a; color: #aaa; font-style: italic; }
    .tag-cheater { background: #ff0050; color: #fff; text-decoration: line-through; }
    .tag-vvip { background: var(--purple); color: #fff; box-shadow: 0 0 8px var(--purple); }
    .tag-owner { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #000; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 0 10px var(--accent); font-weight: 900; }
    .tag-developer { background: #000; color: #00ff00; border: 1px solid #00ff00; font-family: 'JetBrains Mono', monospace; letter-spacing: 1px; text-shadow: 0 0 6px #0f0; }
    .tag-sultan { background: linear-gradient(135deg, #ffd700, #fbf5b7, #ffd700); color: #000; border: 1px solid #b8860b; font-weight: bold; }
    .tag-wibu { background: #ff69b4; color: #fff; border: 1px solid #ff1493; }
    .tag-sadboy { background: #000080; color: #add8e6; border: 1px solid #add8e6; font-style: italic; }
    .tag-hacker { background: #000; color: #0f0; text-shadow: 0 0 5px #0f0; font-family: 'JetBrains Mono', monospace; }
    .tag-verified { background: #1da1f2; color: #fff; }
    .tag-bot { background: #708090; color: #fff; }
    .tag-npc { background: #d3d3d3; color: #000; }
    .tag-dj { background: #ff00ff; color: #fff; box-shadow: 0 0 8px #ff00ff; }
    .tag-pro { background: linear-gradient(135deg, #ff4500, #ff6b35); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .tag-noob { background: #8b4513; color: #fff; border: 1px dashed #deb887; }
    .tag-mythic {
      background: linear-gradient(135deg, #4c1d95, #7c3aed, #f97316);
      color: #fff;
      box-shadow: 0 0 12px rgba(124,58,237,0.7);
      border: 1px solid rgba(249,115,22,0.7);
    }
    .tag-top-global { background: linear-gradient(90deg, #00c6ff, #0072ff); color: #fff; font-weight: bold; box-shadow: 0 0 5px #00c6ff; }
    .tag-premium { background: linear-gradient(45deg, #8a2387, #e94057, #f27121); color: #fff; font-weight: bold; }
    .tag-influencer { background: linear-gradient(45deg, #405de6, #833ab4, #c13584, #e1306c, #fd1d1d); color: #fff; }
    /* NEW TAGS */
    .tag-legend { background: linear-gradient(135deg, #ff6b00, #ffd700, #ff6b00); color: #000; font-weight: 900; box-shadow: 0 0 10px rgba(255,107,0,0.5); animation: legendFlicker 2s ease-in-out infinite; }
    @keyframes legendFlicker { 0%,100% { box-shadow: 0 0 10px rgba(255,107,0,0.5); } 50% { box-shadow: 0 0 20px rgba(255,215,0,0.8), 0 0 35px rgba(255,107,0,0.4); } }
    .tag-mythic { background: linear-gradient(135deg, #9c27b0, #673ab7, #3f51b5); color: #fff; font-weight: 900; box-shadow: 0 0 12px rgba(156,39,176,0.6); border: 1px solid rgba(255,255,255,0.2); }
    .tag-godlike { background: linear-gradient(135deg, #ffd700, #ff8c00, #ffd700); color: #000; font-weight: 900; border: 1px solid #fff; box-shadow: 0 0 15px rgba(255,215,0,0.7), 0 0 30px rgba(255,140,0,0.4); animation: godPulse 1.5s ease-in-out infinite; }
    @keyframes godPulse { 0%,100% { box-shadow: 0 0 15px rgba(255,215,0,0.7); } 50% { box-shadow: 0 0 25px rgba(255,215,0,1), 0 0 45px rgba(255,140,0,0.6); } }
    .tag-savage { background: #000; color: #ff0050; border: 2px solid #ff0050; font-weight: 900; text-shadow: 0 0 8px #ff0050; letter-spacing: 2px; animation: savageFlash 0.8s ease-in-out infinite; }
    @keyframes savageFlash { 0%,100% { border-color: #ff0050; text-shadow: 0 0 8px #ff0050; } 50% { border-color: #ff6b6b; text-shadow: 0 0 16px #ff0050, 0 0 30px #ff0050; } }
    .tag-maniac { background: linear-gradient(135deg, #e91e63, #9c27b0); color: #fff; font-weight: 900; box-shadow: 0 0 10px rgba(233,30,99,0.5); }
    .tag-ultra { background: linear-gradient(135deg, #00bcd4, #009688, #4caf50); color: #fff; font-weight: 900; box-shadow: 0 0 10px rgba(0,188,212,0.5); border: 1px solid rgba(255,255,255,0.3); }
    .tag-terkeren {
      background: linear-gradient(135deg, #00f5ff, #7c3aed);
      color: #fff;
      box-shadow: 0 0 12px rgba(124,58,237,0.7);
      border: 1px solid rgba(59,130,246,0.7);
    }
    .tag-tersulit {
      background: linear-gradient(135deg, #ff0050, #ff8c00);
      color: #fff;
      box-shadow: 0 0 12px rgba(255,92,92,0.7);
      border: 1px solid rgba(248,113,113,0.8);
    }

    .v-badge { color: #1da1f2; font-size: 12px; margin-left: 3px; }

    /* ============================================================
       VIP TRIAL SYSTEM
    ============================================================ */
    .vip-trial-banner {
      background: linear-gradient(135deg, rgba(255,215,0,0.16), rgba(255,152,0,0.1));
      border: 1px solid rgba(255,215,0,0.4);
      border-radius: 10px;
      padding: 10px 14px;
      margin-bottom: 8px;
      display: none;
      align-items: center;
      gap: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
    }
    .vip-trial-banner.show { display: flex; }
    .vip-trial-banner i { color: var(--gold); font-size: 18px; flex-shrink: 0; }
    .vip-trial-info { flex: 1; }
    .vip-trial-info .vt-label { font-size: 10px; color: var(--gold); font-weight: 800; letter-spacing: 1px; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; }
    .vip-trial-info .vt-timer { font-size: 13px; font-weight: 700; color: #fff; font-family: 'JetBrains Mono', monospace; }
    .vip-trial-close {
      margin-left: 8px;
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      cursor: pointer;
    }

    /* ============================================================
       LEBARAN COUNTDOWN
    ============================================================ */
    .event-countdown {
      background: linear-gradient(135deg, rgba(0,212,255,0.18), rgba(0,150,136,0.12));
      border: 1px solid rgba(0,212,255,0.4);
      border-radius: 10px;
      padding: 9px 14px;
      margin-bottom: 12px;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
    }
    .event-countdown.show { display: flex; }
    .event-countdown .ec-main { display: flex; flex-direction: column; gap: 2px; }
    .event-countdown .ec-label {
      font-size: 10px; font-weight: 800; letter-spacing: 1px;
      text-transform: uppercase; color: #00d4ff; font-family: 'Rajdhani', sans-serif;
    }
    .event-countdown .ec-time {
      font-size: 13px; font-weight: 700; color: #fff; font-family: 'JetBrains Mono', monospace;
    }
    .event-countdown .ec-badge {
      margin-left: auto; padding: 4px 10px;
      border-radius: 999px;
      font-size: 10px; font-weight: 700; letter-spacing: 1px;
      text-transform: uppercase;
      background: rgba(0,0,0,0.5);
      color: #ffd700;
      border: 1px solid rgba(255,215,0,0.4);
    }
    .event-countdown .ec-close {
      margin-left: 6px;
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      cursor: pointer;
    }
    .event-banner {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2600;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 10px 14px;
      display: none;
      align-items: center;
      gap: 10px;
      box-shadow: 0 14px 35px rgba(0,0,0,0.55);
      font-size: 11px;
      color: #e5e7eb;
      pointer-events: auto;
    }
    .event-banner.show {
      display: flex;
      animation: notifPanelIn 0.25s ease;
    }
    .event-banner-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #38bdf8, #1e40af);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 16px;
      flex-shrink: 0;
    }
    .event-banner-body {
      min-width: 0;
    }
    .event-banner-title {
      font-size: 12px;
      font-weight: 700;
      color: #e5e7eb;
      margin-bottom: 2px;
    }
    .event-banner-sub {
      font-size: 10px;
      color: #9ca3af;
    }
    .event-banner-timer {
      font-size: 11px;
      font-weight: 700;
      color: #facc15;
      margin-left: 8px;
    }
    .event-banner-close {
      border: none;
      background: none;
      color: #6b7280;
      cursor: pointer;
      font-size: 14px;
      padding: 4px;
    }
    .event-countdown.celebrate {
      background: linear-gradient(135deg, rgba(255,215,0,0.25), rgba(255,152,0,0.24));
      border-color: rgba(255,215,0,0.8);
    }

    /* ============================================================
       ADMIN PANEL (built-in)
    ============================================================ */
    .admin-panel-overlay {
      position: fixed;
      inset: 0;
      z-index: 5000;
      display: none;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 70px 16px 16px;
      pointer-events: none;
    }
    .admin-panel-overlay.show { display: flex; pointer-events: auto; }

    .admin-panel {
      width: 380px;
      max-width: 420px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(ellipse at 50% -10%, rgba(255,193,7,0.1), transparent 60%),
                  linear-gradient(180deg, #05050c, #07070f);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .admin-header {
      background: linear-gradient(135deg, rgba(255,193,7,0.12), rgba(255,152,0,0.06));
      border-bottom: 1px solid rgba(255,193,7,0.2);
      padding: 15px 20px;
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .admin-header-title {
      font-family: 'Rajdhani', sans-serif; font-size: 20px; font-weight: 800;
      letter-spacing: 3px; color: var(--ml-gold);
      text-shadow: 0 0 15px rgba(255,193,7,0.5);
      display: flex; align-items: center; gap: 10px;
    }
    .admin-header-close {
      background: rgba(255,51,51,0.15); border: 1px solid rgba(255,51,51,0.3);
      color: #ff6b6b; width: 36px; height: 36px; border-radius: 50%;
      cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;
      transition: 0.2s;
    }
    .admin-header-close:hover { background: var(--danger); color: #fff; }
    .admin-header-tools {
      display: flex; align-items: center; gap: 6px;
    }
    .admin-header-btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.16);
      color: #ccc;
      width: 30px; height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
      transition: 0.16s;
    }
    .admin-header-btn:hover { background: rgba(255,255,255,0.14); color: #fff; }
    .admin-panel.admin-full {
      width: 100%;
      max-width: none;
      max-height: 100vh;
    }
    .admin-panel.admin-mini {
      width: 230px;
      max-width: 260px;
    }
    .admin-overlay-mini {
      align-items: flex-end;
      justify-content: flex-end;
      padding: 0 16px 16px;
    }
    .admin-panel.admin-mini .admin-nav,
    .admin-panel.admin-mini .admin-content {
      display: none;
    }

    .admin-nav {
      display: flex; padding: 12px 15px 0;
      gap: 6px; flex-shrink: 0;
      overflow-x: auto; border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .admin-nav::-webkit-scrollbar { display: none; }
    .admin-nav-btn {
      flex: 0 0 auto; padding: 8px 14px;
      background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
      color: #888; border-radius: 10px 10px 0 0; border-bottom: none;
      font-family: 'Rajdhani', sans-serif; font-size: 12px; font-weight: 700;
      letter-spacing: 1px; cursor: pointer; transition: 0.2s; white-space: nowrap;
    }
    .admin-nav-btn:hover { color: var(--ml-gold); border-color: rgba(255,193,7,0.3); }
    .admin-nav-btn.active { background: rgba(255,193,7,0.1); border-color: rgba(255,193,7,0.3); color: var(--ml-gold); }

    .admin-content {
      flex: 1; overflow-y: auto; padding: 18px;
    }
    .admin-content::-webkit-scrollbar { width: 4px; }
    .admin-content::-webkit-scrollbar-thumb { background: rgba(255,193,7,0.3); border-radius: 10px; }

    .admin-view { display: none; }
    .admin-view.active { display: block; }

    .admin-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 14px; padding: 16px; margin-bottom: 16px;
      position: relative; overflow: hidden;
    }
    .tag-selector-sheet {
      max-width: 640px;
    }
    .tag-selector-layout {
      display: flex;
      gap: 12px;
      margin-top: 6px;
    }
    .tag-selector-col {
      flex: 1;
      min-width: 0;
    }
    .tag-section-title {
      font-size: 11px;
      color: #aaa;
      margin-bottom: 6px;
    }
    .tag-current-text {
      font-size: 12px;
      color: #ddd;
      margin-bottom: 8px;
    }
    .tag-chip-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .tag-chip {
      border: none;
      background: rgba(255,255,255,0.05);
      border-radius: 999px;
      padding: 4px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: #eee;
      transition: 0.16s;
    }
    .tag-chip:hover {
      background: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .tag-chip-none {
      background: rgba(255,80,80,0.1);
    }
    .tag-meta-list {
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .tag-meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.05);
    }
    .tag-meta-desc {
      font-size: 10px;
      color: #999;
      text-align: right;
    }
    @media (max-width: 768px) {
      .tag-selector-layout {
        flex-direction: column;
      }
    }
    .admin-two-col {
      display: flex;
      gap: 10px;
    }
    .admin-two-col > div {
      flex: 1;
      min-width: 0;
    }
    .admin-label {
      font-size: 10px;
      color: #888;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .admin-users-layout {
      display: flex;
      gap: 12px;
    }
    .admin-users-left {
      flex: 1.2;
      min-width: 0;
    }
    .admin-users-right {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .admin-tag-active-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .admin-tag-user-name {
      font-size: 13px;
      font-weight: 700;
      color: #fff;
    }
    .admin-tag-current {
      font-size: 11px;
      color: #aaa;
    }
    .admin-tag-chip-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .admin-tag-chip {
      border: none;
      background: rgba(255,255,255,0.04);
      border-radius: 999px;
      padding: 4px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: #eee;
      transition: 0.16s;
    }
    .admin-tag-chip:hover {
      background: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .admin-tag-meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.05);
    }
    .admin-tag-meta-desc {
      font-size: 10px;
      color: #999;
      text-align: right;
    }
    @media (max-width: 768px) {
      .admin-users-layout {
        flex-direction: column;
      }
      .admin-panel {
        background: #05050c;
        box-shadow: 0 14px 40px rgba(0,0,0,0.75);
      }
    }
    .admin-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, transparent, var(--ml-gold), transparent);
      opacity: 0.3;
    }
    .admin-card h3 {
      font-family: 'Rajdhani', sans-serif; font-size: 14px; font-weight: 800;
      color: var(--ml-gold); letter-spacing: 1.5px; margin-bottom: 12px;
      display: flex; align-items: center; gap: 7px;
    }
    .admin-stat-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 10px; margin-bottom: 15px;
    }
    .admin-stat-box {
      background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px;
      border: 1px solid rgba(255,255,255,0.05); text-align: center;
    }
    .admin-stat-box .sv { font-size: 28px; font-weight: 800; font-family: 'Rajdhani', sans-serif; color: #fff; }
    .admin-stat-box .sl { font-size: 10px; color: #555; letter-spacing: 1px; margin-top: 3px; }

    .admin-inp {
      width: 100%; padding: 11px 13px; background: rgba(0,0,0,0.4);
      color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
      font-size: 12px; margin-bottom: 8px; font-family: 'JetBrains Mono', monospace;
      transition: border-color 0.2s;
    }
    .admin-inp:focus { border-color: var(--ml-gold); box-shadow: 0 0 0 2px rgba(255,193,7,0.1); }
    .admin-sel {
      width: 100%; padding: 11px 13px; background: rgba(0,0,0,0.6);
      color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
      font-size: 12px; margin-bottom: 8px; font-family: 'JetBrains Mono', monospace;
    }
    .admin-btn {
      padding: 10px 16px; border: none; border-radius: 10px;
      font-family: 'Rajdhani', sans-serif; font-size: 13px; font-weight: 700;
      letter-spacing: 1px; cursor: pointer; transition: 0.2s;
    }
    .admin-btn-gold { background: linear-gradient(135deg, var(--ml-gold), #ff8c00); color: #000; box-shadow: 0 4px 15px rgba(255,193,7,0.3); }
    .admin-btn-gold:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(255,193,7,0.4); }
    .admin-btn-red { background: linear-gradient(135deg, #ff5252, #d32f2f); color: #fff; }
    .admin-btn-blue { background: linear-gradient(135deg, #42a5f5, #1565c0); color: #fff; }
    .admin-btn-green { background: linear-gradient(135deg, var(--accent), #00a86b); color: #000; }
    .admin-btn-full { width: 100%; padding: 12px; }

    .user-row-admin {
      background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05);
      border-radius: 10px; padding: 12px; margin-bottom: 8px;
      display: flex; flex-direction: column; gap: 8px;
    }
    .user-row-admin .ur-top { display: flex; align-items: center; gap: 10px; }
    .user-row-admin .ur-name { font-weight: 800; font-family: 'Rajdhani', sans-serif; font-size: 14px; }
    .user-row-admin .ur-uid { font-size: 10px; color: #444; font-family: 'JetBrains Mono', monospace; }
    .user-row-admin .ur-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .admin-search { width: 100%; padding: 11px 13px; background: rgba(0,0,0,0.4); color: #fff; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; font-size: 12px; margin-bottom: 12px; }

    /* ============================================================
       ADMIN LOCK / CAPTCHA GATE
    ============================================================ */
    .admin-lock-gate {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 30px 20px;
      background:
        radial-gradient(ellipse at 30% 0%, rgba(0,212,255,0.12), transparent 50%),
        radial-gradient(ellipse at 70% 100%, rgba(255,193,7,0.1), transparent 50%),
        linear-gradient(180deg, #030308, #05050f);
      z-index: 5010;
      transition: opacity 0.4s ease, transform 0.4s ease;
      overflow-y: auto;
    }
    .admin-lock-gate.unlocked {
      opacity: 0; transform: scale(1.04) translateY(-15px);
      pointer-events: none;
    }

    .alg-badge {
      width: 80px; height: 80px; border-radius: 50%;
      background: radial-gradient(circle, rgba(255,193,7,0.15), rgba(0,0,0,0));
      border: 2px solid rgba(255,193,7,0.3);
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; margin-bottom: 20px;
      position: relative;
      animation: alg-pulse 2.5s ease-in-out infinite;
    }
    @keyframes alg-pulse {
      0%,100% { box-shadow: 0 0 15px rgba(255,193,7,0.2), inset 0 0 15px rgba(255,193,7,0.05); }
      50% { box-shadow: 0 0 35px rgba(255,193,7,0.5), inset 0 0 25px rgba(255,193,7,0.1); }
    }
    .alg-badge::before {
      content: '';
      position: absolute; inset: -8px; border-radius: 50%;
      border: 1px solid rgba(255,193,7,0.15);
      animation: alg-spin 6s linear infinite;
    }
    .alg-badge::after {
      content: '';
      position: absolute; top: -9px; left: 50%; transform: translateX(-50%);
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--ml-gold);
      box-shadow: 0 0 10px var(--ml-gold), 0 0 20px rgba(255,193,7,0.5);
      animation: alg-spin 6s linear infinite;
      transform-origin: 0 50px;
    }
    @keyframes alg-spin { to { transform: rotate(360deg); } }

    .alg-title {
      font-family: 'Rajdhani', sans-serif;
      font-size: 22px; font-weight: 800;
      letter-spacing: 4px; color: var(--ml-gold);
      text-shadow: 0 0 20px rgba(255,193,7,0.4);
      margin-bottom: 4px; text-transform: uppercase;
    }
    .alg-sub {
      font-size: 10px; color: rgba(255,255,255,0.25);
      letter-spacing: 3px; font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase; margin-bottom: 28px;
    }

    /* captcha canvas area */
    .alg-cap-box {
      background: radial-gradient(circle, #05101a, #000);
      border: 1px solid rgba(0,212,255,0.35);
      border-radius: 12px; padding: 8px;
      margin-bottom: 14px;
      box-shadow: 0 0 20px rgba(0,212,255,0.2), inset 0 0 20px rgba(0,0,0,0.5);
      width: 100%; max-width: 300px;
    }
    #algCapCanvas {
      display: block; width: 100%; height: 80px;
      border-radius: 8px;
      filter: drop-shadow(0 0 6px rgba(0,212,255,0.4));
    }
    .alg-code-display {
      color: #00ff88; font-family: 'JetBrains Mono', monospace;
      letter-spacing: 6px; font-size: 20px; font-weight: bold;
      text-shadow: 0 0 12px rgba(0,255,136,0.6);
      text-align: center; padding: 6px 14px;
      border: 1px solid rgba(0,255,136,0.3);
      border-radius: 999px; background: rgba(0,0,0,0.5);
      margin-bottom: 8px;
    }
    .alg-refresh {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      color: #888; font-size: 11px; padding: 6px 14px; border-radius: 8px;
      cursor: pointer; transition: 0.2s; font-family: 'Rajdhani', sans-serif;
      font-weight: 600; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;
      margin: 0 auto 18px;
    }
    .alg-refresh:hover { color: var(--ml-gold); border-color: rgba(255,193,7,0.4); }

    .alg-inp {
      width: 100%; max-width: 300px;
      padding: 13px; margin-bottom: 12px;
      background: rgba(0,0,0,0.5); color: white;
      border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
      font-size: 18px; font-weight: 800; letter-spacing: 5px;
      text-align: center; font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase; transition: 0.2s;
    }
    .alg-inp:focus { border-color: var(--ml-gold); box-shadow: 0 0 0 3px rgba(255,193,7,0.12); }

    .alg-enter-btn {
      width: 100%; max-width: 300px;
      padding: 14px; font-size: 15px; font-weight: 800;
      background: linear-gradient(135deg, var(--ml-gold), #ff8c00);
      border: none; border-radius: 12px; color: #000;
      cursor: pointer; font-family: 'Rajdhani', sans-serif;
      letter-spacing: 2px; text-transform: uppercase;
      box-shadow: 0 5px 20px rgba(255,193,7,0.3);
      transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .alg-enter-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(255,193,7,0.45); }
    .alg-enter-btn:active { transform: scale(0.98); }
    @keyframes algShake {
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
    }

    .alg-error {
      font-size: 12px; color: #ff6b6b; text-align: center;
      font-family: 'JetBrains Mono', monospace; margin-bottom: 10px;
      min-height: 18px; letter-spacing: 0.5px;
    }

    /* corner ML decorations on lock gate */
    .alg-corner { position: absolute; width: 22px; height: 22px; }
    .alg-corner::before, .alg-corner::after { content: ''; position: absolute; background: rgba(255,193,7,0.4); }
    .alg-tl { top: 15px; left: 15px; }
    .alg-tl::before { top:0; left:0; width:100%; height:2px; }
    .alg-tl::after  { top:0; left:0; width:2px; height:100%; }
    .alg-tr { top: 15px; right: 15px; }
    .alg-tr::before { top:0; right:0; width:100%; height:2px; }
    .alg-tr::after  { top:0; right:0; width:2px; height:100%; }
    .alg-bl { bottom: 15px; left: 15px; }
    .alg-bl::before { bottom:0; left:0; width:100%; height:2px; }
    .alg-bl::after  { bottom:0; left:0; width:2px; height:100%; }
    .alg-br { bottom: 15px; right: 15px; }
    .alg-br::before { bottom:0; right:0; width:100%; height:2px; }
    .alg-br::after  { bottom:0; right:0; width:2px; height:100%; }

    /* song rows in admin */
    .admin-song-row {
      display: flex; align-items: center; gap: 10px;
      background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05);
      border-radius: 10px; padding: 10px 12px; margin-bottom: 6px;
    }
    .admin-song-row .as-info { flex: 1; min-width: 0; }
    .admin-song-row .as-title { font-size: 13px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .admin-song-row .as-by { font-size: 10px; color: #555; }

    /* log terminal */
    .log-terminal {
      background: #000; border: 1px solid rgba(0,255,136,0.15); border-radius: 10px;
      padding: 14px; height: 300px; overflow-y: auto; font-family: 'JetBrains Mono', monospace;
      font-size: 11px; color: var(--accent);
    }
    .log-terminal::-webkit-scrollbar { width: 4px; }
    .log-terminal::-webkit-scrollbar-thumb { background: rgba(0,255,136,0.3); }
    .log-line { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom: 3px; }
    .log-time { color: #444; }

    /* ============================================================
       TOAST
    ============================================================ */
    #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 8px; z-index: 99999; pointer-events: none; }
    .toast {
      background: rgba(10,10,18,0.95);
      border: 1px solid rgba(255,255,255,0.08);
      border-left: 3px solid var(--accent);
      color: #fff; padding: 9px 18px;
      border-radius: 8px; font-size: 12px;
      display: flex; align-items: center; gap: 9px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      animation: toastIn 0.3s cubic-bezier(0.68,-0.55,0.27,1.55);
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }
    .toast.hide { animation: toastOut 0.3s forwards; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }

    /* Modal messages */
    .modal-msg { text-align: center; font-size: 12px; margin-top: 10px; padding: 9px; border-radius: 8px; display: none; }
    .modal-msg.show { display: block; }
    .modal-msg.success { color: var(--accent); background: rgba(0,255,136,0.08); border: 1px solid rgba(0,255,136,0.2); }
    .modal-msg.error { color: #ff6b6b; background: rgba(255,107,107,0.08); border: 1px solid rgba(255,107,107,0.2); }

    .rules-warn { background: rgba(255,51,51,0.08); border-left: 3px solid var(--danger); padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 12px; }
    .tutorial-link { color: #3498db; text-decoration: underline; cursor: pointer; font-weight: 600; }

    /* Tutorial */
    .tutorial-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 10001; display: none; align-items: center; justify-content: center; padding: 20px; }
    .tutorial-card { background: #141422; border-radius: 18px; padding: 22px; width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.08); position: relative; animation: slideIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275); }
    @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    .tutorial-card .close-btn { position: absolute; top: 14px; right: 14px; background: rgba(255,255,255,0.08); border: none; color: #fff; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; }
    .tutorial-card .close-btn:hover { background: var(--danger); }
    .tutorial-card h3 { color: var(--accent); margin-bottom: 14px; font-size: 18px; font-family: 'Rajdhani', sans-serif; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 10px; margin-bottom: 14px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

    /* About */
    .about-box { font-size: 12px; line-height: 1.6; color: #ccc; }
    .about-box h3 { color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: 5px; font-family: 'Rajdhani', sans-serif; font-size: 18px; }
    .about-box p { margin-bottom: 10px; }
    .about-box b { color: #fff; }
    .about-features { margin: 8px 0 12px 16px; padding: 0; }
    .about-features li { margin-bottom: 7px; }
    .about-dev-link { color: #00d4ff; font-weight: 700; text-decoration: none; text-shadow: 0 0 10px #00d4ff; }
    .about-dev-link:hover { color: #7df9ff; }

    @media (max-width: 480px) {
      .app { width: 100%; height: 100vh; border-radius: 0; max-width: none; }
    }
  </style>
</head>
<body>

  <!-- LOADING SCREEN -->
  <div id="gameLoadScreen">
    <div class="load-corner tl"></div>
    <div class="load-corner tr"></div>
    <div class="load-corner bl"></div>
    <div class="load-corner br"></div>
    <div class="load-logo-wrap">
      <div class="load-logo-ring">
        <div class="load-logo-ring-outer"></div>
        <div class="load-logo-icon"><i class="fas fa-music"></i></div>
      </div>
    </div>
    <div class="load-title">ExeMusic</div>
    <div class="load-subtitle">v3.2 · Premium Audio</div>
    <div class="load-bar-wrap">
      <div class="load-bar-track">
        <div class="load-bar-fill" id="loadBarFill"></div>
        <div class="load-bar-glow"></div>
      </div>
    </div>
    <div class="load-info-row load-bar-wrap">
      <span class="load-status" id="loadStatus">INITIALIZING...</span>
      <span class="load-percent" id="loadPercent">0%</span>
    </div>
    <div class="load-dots">
      <div class="load-dot"></div>
      <div class="load-dot"></div>
      <div class="load-dot"></div>
    </div>
  </div>

  <!-- FLOATING HEARTS (for velly) -->
  <div class="hearts-container" id="heartsContainer"></div>

  <!-- BROADCAST -->
  <div id="sysBroadcast" class="sys-broadcast">
    <button class="sb-close" onclick="closeBroadcast()"><i class="fas fa-times"></i></button>
    <div class="sb-content">
      <i class="fas fa-bullhorn sb-icon"></i>
      <div class="sb-text">
        <h4>Announcement</h4>
        <p id="sbMessage">Loading...</p>
      </div>
    </div>
    <div class="sb-progress"><div id="sbBar" class="sb-bar"></div></div>
  </div>

  <!-- MAINTENANCE / BANNED -->
  <div id="mtScreen" class="full-overlay"><i class="fas fa-tools" style="color:var(--accent)"></i><h1>Server Maintenance</h1><p>Kami sedang melakukan pembaruan sistem.<br>Mohon tunggu sebentar lagi.</p></div>
  <div id="bannedScreen" class="full-overlay"><i class="fas fa-user-slash" style="color:var(--danger)"></i><h1>Access Denied</h1><p>Akun anda telah diblokir secara permanen.</p></div>

  <div id="toastLegacy" style="display:none"></div>

    <!-- Notif Panel — OUTSIDE .app to avoid overflow:hidden clipping -->
    <div id="notifPanel" class="notif-panel">
      <div class="notif-panel-header">
        <h3><i class="fas fa-comment-dots"></i> Notifikasi</h3>
        <button class="notif-panel-close" onclick="openClearNotifConfirm()" style="margin-right:8px" title="Hapus notif"><i class="fas fa-trash"></i></button>
        <button class="notif-panel-close" onclick="closeNotifPanel()"><i class="fas fa-times"></i></button>
      </div>
      <div id="notifList" class="notif-list"><div class="notif-empty">Memuat...</div></div>
    </div>

  <!-- MAIN APP -->
  <div class="app">
  <div class="ml-corner-tl ml-corner"></div>
    <div class="ml-corner-tr ml-corner"></div>
    <div class="ml-corner-bl ml-corner"></div>
    <div class="ml-corner-br ml-corner"></div>

  <div id="adminFloatChat" class="admin-float-chat">
    <div class="admin-float-name">
      <i class="fas fa-check-circle"></i>
      <span id="adminFloatName"></span>
    </div>
    <div class="admin-float-msg" id="adminFloatMsg"></div>
    <div class="admin-float-timer" id="adminFloatTimer"></div>
  </div>

    <div class="header">
      <img src="exemusic.png" alt="Logo" onclick="openAbout()">
      <div class="header-right">
        <button id="btnNotif" onclick="toggleNotifPanel()" title="Notifikasi">
          <i class="fas fa-bell"></i>
          <span id="notifBadge" class="notif-badge"></span>
        </button>
        <button id="btnEvent" onclick="openEventCenter()" title="Event">
          <i class="fas fa-calendar-alt"></i>
        </button>
        <button id="btnAdmin" onclick="openAdminPanel()" title="Admin Panel">
          <i class="fas fa-shield-alt"></i>
        </button>
        <button id="topLoginBtn" onclick="openProfile()">Login</button>
      </div>
    </div>

    <!-- VIP Trial Banner -->
    <div class="vip-trial-banner" id="vipTrialBanner">
      <i class="fas fa-crown"></i>
      <div class="vip-trial-info">
        <div class="vt-label">VIP TRIAL AKTIF</div>
        <div class="vt-timer" id="vipTrialTimer">--d --h --m</div>
      </div>
      <button class="vip-trial-close" onclick="closeVipTrialBanner()">×</button>
    </div>

    <!-- Lebaran Countdown -->
    <div class="event-countdown" id="lebaranCountdown">
      <div class="ec-main">
        <div class="ec-label">Countdown Lebaran</div>
        <div class="ec-time" id="lebaranTimer">--d --h --m</div>
      </div>
      <div class="ec-badge">Idulfitri</div>
      <button class="ec-close" onclick="closeLebaranCountdown()">×</button>
    </div>

    <div class="cover-box">
      <div class="eq" id="eq"><span></span><span></span><span></span><span></span><span></span></div>
    </div>

    <div class="track-info">
      <div id="title">Loading Lagu...</div>
      <div class="user-row">
        <div id="by" onclick="viewCreator()">@system</div>
        <button id="btnFav" onclick="toggleFavorite()"><i class="far fa-heart"></i></button>
        <button id="btnFollow" onclick="followUser()"><i class="fas fa-plus"></i></button>
      </div>
    </div>

    <div class="sys-container">
      <div class="sys-tools">
        <button onclick="copyRawUrl()" title="Copy URL Audio"><i class="fas fa-link"></i></button>
        <button onclick="openCopyLink()" title="Share Link"><i class="fas fa-share-alt"></i></button>
        <button onclick="downloadSong()" title="Download"><i class="fas fa-download"></i></button>
        <button onclick="openReq()" title="Upload"><i class="fas fa-plus-circle"></i></button>
      </div>
      <div class="vol-row">
        <i class="fas fa-volume-down" style="font-size:12px; color:#555"></i>
        <input type="range" id="vol" min="0" max="1" step="0.01" value="0.8">
        <i class="fas fa-volume-up" style="font-size:12px; color:#888"></i>
      </div>
    </div>

    <div class="prog-area">
      <input type="range" id="seek" value="0">
      <div class="time">
        <span id="cur">0:00</span>
        <div class="dur-wrapper">
          <div class="loading-spinner" id="loadSpinner"></div>
          <span id="dur">0:00</span>
        </div>
      </div>
    </div>

    <div class="main-ctrl">
      <button class="btn-sec" onclick="prev()"><i class="fas fa-step-backward"></i></button>
      <button class="btn-play" onclick="toggle()" id="playBtn"><i class="fas fa-play"></i></button>
      <button class="btn-sec" onclick="next()"><i class="fas fa-step-forward"></i></button>
    </div>

    <div class="footer">
      <button id="shuf" onclick="toggleShuffle()"><i class="fas fa-random"></i></button>
      <button onclick="openList(false)"><i class="fas fa-list-ul"></i></button>
      <button onclick="openList(true)"><i class="fas fa-heart"></i></button>
      <button id="rep" onclick="toggleRepeat()"><i class="fas fa-redo"></i></button>
    </div>
  </div>

  <!-- ADMIN PANEL (Built-in) -->
    <div class="admin-panel-overlay" id="adminPanelOverlay">
    <div class="admin-panel" id="adminPanelInner" style="display:none; flex:1; flex-direction:column">
      <div class="admin-header" onmousedown="startAdminDrag(event)">
        <div class="admin-header-title">
          <i class="fas fa-shield-alt"></i> ADMIN PANEL
        </div>
        <div class="admin-header-tools">
          <button class="admin-header-btn" onclick="toggleAdminSize('mini')" title="Minimize"><i class="fas fa-minus"></i></button>
          <button class="admin-header-btn" onclick="toggleAdminSize('full')" title="Full"><i class="fas fa-expand"></i></button>
          <button class="admin-header-close" onclick="closeAdminPanel()"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="admin-nav">
        <button class="admin-nav-btn active" onclick="switchAdminView('dash', this)"><i class="fas fa-th-large"></i> DASH</button>
        <button class="admin-nav-btn" onclick="switchAdminView('users', this)"><i class="fas fa-users"></i> USERS</button>
        <button class="admin-nav-btn" onclick="switchAdminView('songs', this)"><i class="fas fa-music"></i> SONGS</button>
        <button class="admin-nav-btn" onclick="switchAdminView('notif', this)"><i class="fas fa-paper-plane"></i> NOTIF</button>
        <button class="admin-nav-btn" onclick="switchAdminView('visual', this)"><i class="fas fa-palette"></i> VISUAL</button>
        <button class="admin-nav-btn" onclick="switchAdminView('logs', this)"><i class="fas fa-terminal"></i> LOGS</button>
      </div>
      <div class="admin-content">

        <!-- DASH -->
        <div id="adv-dash" class="admin-view active">
          <div class="admin-stat-grid">
            <div class="admin-stat-box"><div class="sv" id="adCountU">0</div><div class="sl">USERS</div></div>
            <div class="admin-stat-box"><div class="sv" id="adCountS">0</div><div class="sl">SONGS</div></div>
          </div>
          <div class="admin-card">
            <h3><i class="fas fa-broadcast-tower"></i> GLOBAL BROADCAST</h3>
            <textarea class="admin-inp" id="adBcInput" rows="3" placeholder="Isi pengumuman..."></textarea>
            <div style="display:flex; gap:8px">
              <button class="admin-btn admin-btn-gold" onclick="adSendBC()">SEND</button>
              <button class="admin-btn admin-btn-red" onclick="adClearBC()">CLEAR</button>
              <button class="admin-btn admin-btn-blue" style="margin-left:auto" onclick="adToggleMT()">MAINTENANCE</button>
            </div>
            <div style="margin-top:10px">
              <div class="admin-label">Admin Float Chat (15s, global)</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:4px">
                <input class="admin-inp" id="adFloatMsg" placeholder="Contoh: who want free tag?" style="flex:1; min-width:0">
                <button class="admin-btn admin-btn-blue" style="white-space:nowrap" onclick="adSendFloatChat()">SEND CHAT</button>
              </div>
            </div>
          </div>
          <div class="admin-card">
            <h3><i class="fas fa-cog"></i> SYSTEM TOOLS</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="admin-btn admin-btn-green" onclick="openCopyUrlCard()">COPY DEEP LINK</button>
              <button class="admin-btn admin-btn-red" onclick="adOpenClearNotif()">CLEAR MY NOTIFS</button>
            </div>
          </div>
          <div class="admin-card">
            <h3><i class="fas fa-gift"></i> EVENT TAG DROP</h3>
            <div class="admin-two-col">
              <div>
                <div class="admin-label">Tag drop</div>
                <input class="admin-inp" id="adTagDropName" placeholder="contoh: pro">
              </div>
              <div>
                <div class="admin-label">Chance (%)</div>
                <input class="admin-inp" id="adTagDropChance" type="number" min="0" max="100" step="1" value="10">
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <button class="admin-btn admin-btn-gold" onclick="adSaveTagDrop()">SAVE</button>
              <button class="admin-btn admin-btn-blue" onclick="adPreviewTagDrop()">TEST</button>
              <button class="admin-btn admin-btn-red" onclick="adClearTagDrop()">CLEAR</button>
            </div>
            <div id="adTagDropStatus" style="font-size:11px;color:#888;margin-top:6px"></div>
          </div>
          <div class="admin-card">
            <h3><i class="fas fa-moon"></i> LEBARAN COUNTDOWN</h3>
            <p style="font-size:11px; color:#888; margin-bottom:8px">Atur tanggal Idulfitri supaya countdown muncul untuk semua user.</p>
            <input class="admin-inp" id="adLebaranDate" type="date">
            <input class="admin-inp" id="adLebaranTime" type="time" value="00:00">
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="admin-btn admin-btn-gold" onclick="adSaveLebaran()">SAVE</button>
              <button class="admin-btn admin-btn-red" onclick="adClearLebaran()">CLEAR</button>
            </div>
          </div>
        </div>

        <!-- USERS -->
        <div id="adv-users" class="admin-view">
          <div class="admin-users-layout">
            <div class="admin-users-left">
              <input class="admin-search" placeholder="Cari user..." id="adUserSearch" oninput="adFilterUsers(this.value)">
              <div id="adUserList"><div style="text-align:center; padding:30px; color:#444; font-size:13px">Loading...</div></div>
            </div>
            <div class="admin-users-right">
              <div class="admin-card">
                <h3><i class="fas fa-id-badge"></i> EDIT TAG USER</h3>
                <div id="adTagEditorEmpty" style="font-size:12px;color:#777;padding:10px 0">Pilih user di kiri dulu.</div>
                <div id="adTagEditor" style="display:none">
                  <div class="admin-tag-active-row">
                    <div id="adTagUserName" class="admin-tag-user-name"></div>
                    <div id="adTagCurrentDisplay" class="admin-tag-current"></div>
                  </div>
                  <div id="adTagChipGrid" class="admin-tag-chip-grid"></div>
                </div>
              </div>
              <div class="admin-card">
                <h3><i class="fas fa-tags"></i> ALL TAG & CARA DAPET</h3>
                <div id="adAllTagInfo"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- SONGS -->
        <div id="adv-songs" class="admin-view">
          <div class="admin-card">
            <h3><i class="fas fa-plus-circle"></i> ADD SONG MANUAL</h3>
            <input class="admin-inp" id="adAddTitle" placeholder="Judul Lagu - Artist">
            <input class="admin-inp" id="adAddUrl" placeholder="URL MP3">
            <button class="admin-btn admin-btn-green admin-btn-full" onclick="adManualAdd()">UPLOAD TO DATABASE</button>
          </div>
          <input class="admin-search" placeholder="Cari lagu..." id="adSongSearch" oninput="adFilterSongs(this.value)">
          <div id="adSongList"></div>
        </div>

        <!-- NOTIF -->
        <div id="adv-notif" class="admin-view">
          <div class="admin-card">
            <h3><i class="fas fa-paper-plane"></i> KIRIM NOTIFIKASI</h3>
            <select class="admin-sel" id="adNType">
              <option value="admin">🔴 ADMIN MSG</option>
              <option value="violation">⚠️ VIOLATION</option>
              <option value="system">🔵 SYSTEM INFO</option>
              <option value="upload">🎵 UPLOAD</option>
            </select>
            <input class="admin-inp" id="adNTarget" placeholder="UID target (kosong = global)">
            <textarea class="admin-inp" id="adNMsg" rows="3" placeholder="Isi pesan..."></textarea>
            <button class="admin-btn admin-btn-gold admin-btn-full" onclick="adSendNotif()">SEND NOTIFICATION</button>
          </div>
        </div>

        <!-- VISUAL / DISCO -->
        <div id="adv-visual" class="admin-view">
          <div class="admin-card">
            <h3><i class="fas fa-palette"></i> ACCENT COLOR</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px">
              <button class="admin-btn admin-btn-green" onclick="adSetAccent('#00ff88')">DEFAULT GREEN</button>
              <button class="admin-btn admin-btn-blue" onclick="adSetAccent('#00d4ff')">ICE BLUE</button>
              <button class="admin-btn" style="background:linear-gradient(135deg,#ff1493,#ff69b4);color:#fff" onclick="adSetAccent('#ff1493')">PINK</button>
              <button class="admin-btn" style="background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000" onclick="adSetAccent('#ffd700')">GOLD</button>
              <button class="admin-btn" style="background:linear-gradient(135deg,#bf00ff,#6600cc);color:#fff" onclick="adSetAccent('#bf00ff')">PURPLE</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <input class="admin-inp" id="adCustomColor" placeholder="#00ff88" style="margin:0;flex:1">
              <button class="admin-btn admin-btn-gold" onclick="adSetAccent(document.getElementById('adCustomColor').value)">APPLY</button>
            </div>
          </div>
          <div class="admin-card">
            <h3><i class="fas fa-bolt"></i> DISCO MODE</h3>
            <select class="admin-sel" id="adDiscoVariant">
              <option value="minimal">Minimal</option>
              <option value="heartbeat">Heartbeat</option>
              <option value="rainbow">Rainbow</option>
              <option value="ice">Ice</option>
            </select>
            <input class="admin-inp" id="adDiscoColor" placeholder="#00ff88" value="#00ff88">
            <div style="display:flex;gap:8px">
              <button class="admin-btn admin-btn-gold" onclick="adStartDisco()">START DISCO</button>
              <button class="admin-btn admin-btn-red" onclick="adStopDisco()">STOP</button>
            </div>
          </div>
        </div>

        <!-- LOGS -->
        <div id="adv-logs" class="admin-view">
          <div class="admin-card">
            <h3><i class="fas fa-terminal"></i> SYSTEM LOGS</h3>
            <div class="log-terminal" id="adLogBox"><div style="color:#444">Loading logs...</div></div>
            <button class="admin-btn admin-btn-red" style="margin-top:10px" onclick="adClearLogs()">CLEAR LOGS</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal" id="modalAuth" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 id="authTitle" style="text-align:center; margin-bottom:18px; color:var(--accent); font-family:'Rajdhani',sans-serif; letter-spacing:1px">LOGIN EXEMUSIC</h3>
      <div id="usernameSection" style="display:none; margin-bottom:14px;">
        <p style="font-size:12px; color:#888; text-align:center; margin-bottom:10px;">👋 Buat username Anda:</p>
        <input id="authUser" class="inp-dark" placeholder="Username (min 3 karakter)">
      </div>
      <button onclick="handleGoogleAuth()" id="googleAuthBtn" class="btn-act" style="background:#fff; color:#000; display:flex; align-items:center; justify-content:center; gap:10px; font-weight:700; margin-bottom:10px;">
        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
        <span id="googleBtnText">Masuk dengan Google</span>
      </button>
      <p style="font-size:11px; color:#666; text-align:center;">🔒 Login aman dengan Google</p>
    </div>
  </div>

  <div class="modal" id="modalProfile" onclick="if(event.target==this)closeProfileModal()">
    <div class="sheet" style="padding:0; overflow:hidden">
      <div class="modern-profile-header" id="profileHeader">
        <div class="mp-avatar-container">
          <img id="pAvatarImg" src="https://via.placeholder.com/150" class="mp-avatar">
          <div class="mp-edit-badge" onclick="document.getElementById('avatarInp').click()"><i class="fas fa-camera"></i></div>
        </div>
        <input type="file" id="avatarInp" style="display:none" accept="image/*" onchange="uploadAvatar(this)">
        <div class="mp-name-row">
          <span id="pUsername" class="mp-name">User</span>
          <span id="pBadge"></span>
        </div>
        <span id="pEmail" class="mp-handle">user@email.com</span>
        <div id="pTagDisplay" style="margin-bottom:10px"></div>
        <div class="mp-stats">
          <div class="mp-stat-item"><span id="pFol" class="mp-stat-val">0</span><span class="mp-stat-label">Followers</span></div>
          <div class="mp-stat-item"><span id="pFollowing" class="mp-stat-val">0</span><span class="mp-stat-label">Following</span></div>
        </div>
        <div class="mp-actions">
          <button class="mp-btn mp-btn-sec" onclick="openChangeNameModal()"><i class="fas fa-edit"></i> Edit</button>
          <button class="mp-btn mp-btn-sec" onclick="openChangePasswordModal()"><i class="fas fa-lock"></i> Pass</button>
          <button class="mp-btn mp-btn-sec" onclick="openTagSelector()"><i class="fas fa-tag"></i> Tag</button>
          <button class="mp-btn mp-btn-sec" id="btnProfileMusic" style="display:none" onclick="toggleProfileMusicInput()"><i class="fas fa-music"></i> Music</button>
          <button class="mp-btn mp-btn-sec" onclick="shareProfile(auth.currentUser&&auth.currentUser.uid, userData&&userData.username)"><i class="fas fa-share"></i> Share</button>
          <button class="mp-btn" style="background:var(--danger); color:#fff" onclick="auth.signOut(); location.reload()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        <div id="profileMusicRow" style="width:100%; padding:0 18px 8px; display:none">
          <input id="profileMusicUrl" class="inp-dark" placeholder="Link MP3 khusus profil">
          <button class="btn-act" style="margin-top:8px; width:100%" onclick="saveProfileMusic()">SIMPAN MUSIC PROFIL</button>
        </div>
        <div style="font-size:11px; color:#666; margin-top:6px" id="pVipStatus">Status: NONVIP</div>
      </div>
      <div class="mp-tabs">
        <div class="mp-tab active" onclick="switchProfileTab('posts')" id="tabPosts">MY UPLOADS</div>
        <div class="mp-tab" onclick="switchProfileTab('likes')" id="tabLikes">FAVORITES</div>
      </div>
      <div id="myPostList" class="mp-list"></div>
      <div id="myLikeList" class="mp-list" style="display:none"></div>
    </div>
  </div>

  <div class="modal" id="modalCreator" onclick="if(event.target==this)closeCreatorModal()">
    <div class="sheet" style="padding:0; overflow:hidden">
      <div class="modern-profile-header">
        <div class="mp-avatar-container"><img id="vAvatarImg" src="https://via.placeholder.com/150" class="mp-avatar"></div>
        <div class="mp-name-row"><span id="vName" class="mp-name">@creator</span></div>
        <div id="vTagDisplay" style="margin-bottom:10px; display:flex; gap:5px; justify-content:center"></div>
        <div class="mp-stats">
          <div class="mp-stat-item"><span id="vFol" class="mp-stat-val">0</span><span class="mp-stat-label">Followers</span></div>
          <div class="mp-stat-item"><span id="vFollowing" class="mp-stat-val">0</span><span class="mp-stat-label">Following</span></div>
        </div>
        <div class="mp-actions" style="justify-content:center">
          <button id="vCreatorFollowBtn" class="mp-btn mp-btn-primary" onclick="followCreator()">Follow</button>
          <button class="mp-btn mp-btn-sec" onclick="shareProfile(document.getElementById('modalCreator').dataset.creatorUid, document.getElementById('vName').textContent)"><i class="fas fa-share"></i></button>
        </div>
      </div>
      <div style="padding:12px 14px 4px; font-size:11px; color:#555; font-weight:700; letter-spacing:1px">UPLOADED SONGS</div>
      <div id="creatorPostList" class="mp-list"></div>
    </div>
  </div>

  <div class="modal" id="modalReq" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent); font-family:'Rajdhani',sans-serif; letter-spacing:1px">UPLOAD LAGU</h3>
      <div class="rules-warn"><b>⚠️ PERHATIAN:</b> Dilarang upload konten SARA, pornografi audio, atau earrape. Pelanggaran = <b>BANNED PERMANENT</b>!</div>
      <p style="font-size:12px; color:#88c; margin:10px 0">Belum tau cara buat Top4Top? <span class="tutorial-link" onclick="openTutorial()">klik disini</span></p>
      <div id="uploadFormUser" style="display:none">
        <input id="rLagu" class="inp-dark" placeholder="Judul Lagu - Artist">
        <input id="rUrl" class="inp-dark" placeholder="Link MP3 (Top4Top)">
        <button onclick="confirmAndSave()" class="btn-act">POST SEKARANG</button>
        <div id="uploadQueueSection" class="upload-queue-section" style="display:none">
          <div class="upload-queue-header">
            <span class="upload-queue-title-label">UPLOAD QUEUE</span>
            <span id="uploadQueueInfo" class="upload-queue-info"></span>
          </div>
          <div id="uploadQueueList" class="upload-queue-list"></div>
        </div>
        <div id="uploadCdCard" class="upload-cd-card">
          <div class="upload-cd-row">
            <span class="upload-cd-label">COOLDOWN</span>
            <span id="uploadCdTimer" class="upload-cd-timer">00:00</span>
          </div>
          <div class="upload-cd-sub" id="uploadCdSub">Menunggu...</div>
        </div>
      </div>
      <div id="uploadFormGuest">
        <input id="guestName" class="inp-dark" placeholder="Nama Anda">
        <input id="guestLagu" class="inp-dark" placeholder="Judul Lagu - Artist">
        <input id="guestUrl" class="inp-dark" placeholder="Link MP3 Top4Top">
        <button onclick="sendWA()" class="btn-act" style="background:#25D366; color:white">WHATSAPP REQUEST</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalList" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet"><div id="songContainer"></div></div>
  </div>

  <div class="modal" id="modalAbout" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <div class="about-box">
        <h3>🎵 ExeMusic 3.2</h3>
        <p>Platform musik untuk para creator url berbagi dan menikmati musik berkualitas tinggi.</p>
        <p><b>Fitur Platform</b></p>
        <ul class="about-features">
          <li><b>High-Fidelity Streaming</b> – Audio lossless tanpa kompresi berlebihan</li>
          <li><b>Smart Social System</b> – Follow creator favorit & bangun komunitas</li>
          <li><b>VIP Trial System</b> – Nikmati VIP sementara dengan cooldown 15 menit</li>
          <li><b>Badge System</b> – Verifikasi otomatis di 50+ followers</li>
          <li><b>Built-in Admin Panel</b> – Kelola platform langsung dari aplikasi</li>
          <li><b>Real-time Sync</b> – Followers, likes, playlist real-time</li>
        </ul>
        <div class="rules-warn">
          <b>PERATURAN KETAT:</b><br>Konten SARA, pornografi audio, earrape, ujaran kebencian →<br>
          <strong>⚠️ DIHAPUS & BANNED PERMANENT</strong>
        </div>
        <p style="margin-top:12px; color:#ddd">
          📱 WhatsApp — <a href="https://wa.me/62895329018240" target="_blank" class="about-dev-link">click here</a><br>
          📋 Changelogs — <a href="https://execuriverp.github.io/changelogs" target="_blank" class="about-dev-link">click here</a><br>
          📻 Use Boombox — <a href="javascript:void(0)" onclick="openBoomboxTutorial()" class="about-dev-link">click here</a>
        </p>
        <p style="font-size:11px; color:#555; margin-top:10px">Dibuat oleh <a href="?profile_userid=GsU6ThLD9gb5P3k8RS87ro553Ks2" class="about-dev-link">Hexky</a><br>© 2025 ExeMusic</p>
        <button onclick="closeModal()" class="btn-act">SAYA MENGERTI</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalEventCenter" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet event-center-sheet">
      <div class="event-center-header">
        <div class="event-center-title">
          <i class="fas fa-gamepad"></i>
          <span>EVENT & QUEST EXEMUSIC</span>
        </div>
        <div class="event-center-coins">
          <div class="event-coins-icon">
            <i class="fas fa-coins"></i>
          </div>
          <div class="event-coins-body">
            <div class="event-coins-label">EXECOIN</div>
            <div class="event-coins-value" id="evCoinBalance">0</div>
          </div>
        </div>
      </div>
      <div class="event-center-layout">
        <div class="event-center-sidebar">
          <button class="event-tab-btn active" data-tab="daily" onclick="switchEventTab('daily', this)"><i class="fas fa-sun"></i> Tugas Harian</button>
          <button class="event-tab-btn" data-tab="weekly" onclick="switchEventTab('weekly', this)"><i class="fas fa-calendar-week"></i> Misi Mingguan</button>
          <button class="event-tab-btn" data-tab="shop" onclick="switchEventTab('shop', this)"><i class="fas fa-store"></i> Toko ExeCoin</button>
        </div>
        <div class="event-center-main">
          <div id="evTabDaily" class="event-tab-view active">
            <div class="event-tab-caption">Reset tiap 24 jam untuk semua akun.</div>
            <div id="evDailyList" class="event-quest-list"></div>
          </div>
          <div id="evTabWeekly" class="event-tab-view">
            <div class="event-tab-caption">Reset tiap 7 hari. Cocok untuk misi jangka panjang.</div>
            <div id="evWeeklyList" class="event-quest-list"></div>
          </div>
          <div id="evTabShop" class="event-tab-view">
            <div class="event-tab-caption">Tukar ExeCoin dengan tag eksklusif dan VIP.</div>
            <div id="evShopList" class="event-quest-list"></div>
          </div>
        </div>
        <div class="event-center-sidepanel">
          <div class="event-side-card">
            <div class="event-side-label">Event Status</div>
            <div id="evTagDropStatusBox" class="event-side-body">
              <div class="event-side-main" id="evTagDropMain">Tidak ada event tag drop aktif</div>
              <div class="event-side-sub" id="evTagDropSub">Tunggu admin mengaktifkan event.</div>
              <div class="event-side-timer" id="evTagDropTimer">--:--</div>
            </div>
          </div>
          <div class="event-side-card">
            <div class="event-side-label">Tips ExeCoin</div>
            <ul class="event-side-tips">
              <li>Upload rutin untuk ambil semua Tugas Harian.</li>
              <li>Aktif dengerin lagu sambil tab aktif.</li>
              <li>Pakai Toko ExeCoin untuk beli tag eksklusif.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="eventTagBanner" class="event-banner">
    <div class="event-banner-icon"><i class="fas fa-bolt"></i></div>
    <div class="event-banner-body">
      <div class="event-banner-title" id="eventTagBannerTitle">TAG DROP EVENT</div>
      <div class="event-banner-sub" id="eventTagBannerSub">Tag spesial lagi drop untuk user online!</div>
    </div>
    <div class="event-banner-timer" id="eventTagBannerTimer">--:--</div>
    <button class="event-banner-close" onclick="closeEventTagBanner()">×</button>
  </div>
  <div class="modal" id="modalChangeNames" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:18px; color:var(--accent); font-family:'Rajdhani',sans-serif">✏️ UBAH NAMA</h3>
      <input id="cnPass" type="password" class="inp-dark" placeholder="Password Saat Ini">
      <input id="cnNewName" class="inp-dark" placeholder="Nama Pengguna Baru">
      <button onclick="handleChangeName()" class="btn-act">UBAH NAMA</button>
      <div id="cnMsg" class="modal-msg"></div>
    </div>
  </div>

  <div class="modal" id="modalChangePass" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:18px; color:var(--accent); font-family:'Rajdhani',sans-serif">🔐 UBAH PASSWORD</h3>
      <input id="cpOldPass" type="password" class="inp-dark" placeholder="Password Lama">
      <input id="cpNewPass" type="password" class="inp-dark" placeholder="Password Baru (Min. 6)">
      <input id="cpConfirm" type="password" class="inp-dark" placeholder="Konfirmasi Password Baru">
      <button onclick="handleChangePassword()" class="btn-act">UBAH PASSWORD</button>
      <div id="cpMsg" class="modal-msg"></div>
    </div>
  </div>

  <div class="modal" id="modalClearNotif" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent); font-family:'Rajdhani',sans-serif">KONFIRMASI</h3>
      <p style="text-align:center; color:#ccc; margin-bottom:14px; font-size:13px">Yakin ingin menghapus semua notifikasi?</p>
      <div style="display:flex; gap:8px">
        <button class="btn-act" onclick="confirmClearNotif()">CONFIRM</button>
        <button class="btn-act" style="background:rgba(255,255,255,0.1); color:#fff; box-shadow:none" onclick="document.getElementById('modalClearNotif').style.display='none'">BATAL</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalCopyLink" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent); font-family:'Rajdhani',sans-serif">SHARE LINK</h3>
      <div id="copyLinkText" style="background:#050510; border:1px solid rgba(0,255,136,0.2); border-radius:10px; padding:12px; color:#00d4ff; font-family:'JetBrains Mono',monospace; font-size:11px; word-break:break-all; margin-bottom:12px">URL belum dibuat</div>
      <div style="display:flex; gap:8px">
        <button class="btn-act" onclick="copyBuiltLink()">COPY</button>
        <button class="btn-act" style="background:#25D366; color:#fff; box-shadow:none" onclick="shareToWhatsApp()">WHATSAPP</button>
        <button class="btn-act" style="background:rgba(255,255,255,0.1); color:#fff; box-shadow:none; flex:0" onclick="document.getElementById('modalCopyLink').style.display='none'"><i class="fas fa-arrow-left"></i></button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalCopyAudio" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent); font-family:'Rajdhani',sans-serif">URL AUDIO MP3</h3>
      <div id="copyAudioText" style="background:#050510; border:1px solid rgba(0,255,136,0.2); border-radius:10px; padding:12px; color:#00d4ff; font-family:'JetBrains Mono',monospace; font-size:11px; word-break:break-all; margin-bottom:12px">URL belum dibuat</div>
      <div style="display:flex; gap:8px">
        <button class="btn-act" onclick="copyBuiltAudio()">COPY</button>
        <button class="btn-act" style="background:rgba(255,255,255,0.1); color:#fff; box-shadow:none; flex:0" onclick="document.getElementById('modalCopyAudio').style.display='none'"><i class="fas fa-arrow-left"></i></button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalSocialList" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:12px; color:var(--accent); font-family:'Rajdhani',sans-serif" id="socialTitle">Social</h3>
      <div id="socialList" class="mp-list"></div>
    </div>
  </div>

  <div class="modal" id="modalBoombox" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent); font-family:'Rajdhani',sans-serif">HOW TO USE TOP4TOP</h3>
      <div style="font-size:13px; color:#ddd; line-height:1.8; margin-bottom:14px">
        <p>1. Pastikan kamu sudah punya boombox.</p>
        <p>2. Pakai command /placebb untuk menaruh boombox.</p>
        <p>3. Pakai command /setbb untuk memulai music.</p>
        <p>4. Pilih url paling bawah dan masukan url top4top.</p>
        <p style="color:#888; font-size:12px">Note: jika tidak bunyi, hapus 's' di https → http. Pastikan url adalah top4top.</p>
      </div>
      <button class="btn-act" onclick="document.getElementById('modalBoombox').style.display='none'">CLOSE</button>
    </div>
  </div>

  <!-- Admin Copy URL Modal -->
  <div class="modal" id="modalAdminCopyUrl" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--ml-gold); font-family:'Rajdhani',sans-serif">COPY DEEP LINK</h3>
      <input id="adCopySongId" class="inp-dark" placeholder="ID lagu (contoh: 0)" oninput="adUpdateDeepLink(this.value)">
      <div id="adCopyUrlText" style="background:#050510; border:1px solid rgba(255,193,7,0.2); border-radius:10px; padding:12px; color:#00d4ff; font-family:'JetBrains Mono',monospace; font-size:11px; word-break:break-all; margin-bottom:12px">URL belum dibuat</div>
      <div style="display:flex; gap:8px">
        <button class="btn-act" style="background:linear-gradient(135deg,var(--ml-gold),#ff8c00); color:#000" onclick="adCopyDeepLink()">COPY</button>
        <button class="btn-act" style="background:rgba(255,255,255,0.1); color:#fff; box-shadow:none; flex:0" onclick="document.getElementById('modalAdminCopyUrl').style.display='none'"><i class="fas fa-times"></i></button>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <div class="tutorial-overlay" id="tutorialOverlay">
    <div class="tutorial-card">
      <button class="close-btn" onclick="closeTutorial()">&times;</button>
      <h3>Tutorial Upload via Top4Top</h3>
      <div class="video-container">
        <iframe id="tutorialVideo" src="https://www.youtube.com/embed/eLNvOj2lFNk" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
      <p style="font-size:13px; color:#888; text-align:center">Video oleh: Hexky</p>
    </div>
  </div>

  <div class="modal" id="modalTagSelector" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet tag-selector-sheet">
      <h3 style="text-align:center; margin-bottom:8px; color:var(--accent); font-family:'Rajdhani',sans-serif; letter-spacing:1px">PILIH TAG</h3>
      <div class="tag-selector-layout">
        <div class="tag-selector-col">
          <div class="tag-section-title">EDIT TAG</div>
          <div id="tagSelectorCurrent" class="tag-current-text"></div>
          <div id="tagSelectorChipGrid" class="tag-chip-grid"></div>
        </div>
        <div class="tag-selector-col">
          <div class="tag-section-title">ALL TAG & CARA DAPET</div>
          <div id="tagSelectorAllInfo" class="tag-meta-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCVJYSR4nHeoRA9WTMZa3-2xliKQRrd5g4",
      authDomain: "exemusic-execuriverp.firebaseapp.com",
      databaseURL: "https://exemusic-execuriverp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "exemusic-execuriverp",
      storageBucket: "exemusic-execuriverp.firebasestorage.app",
      messagingSenderId: "722057744401",
      appId: "1:722057744401:web:cd6a6a103692059bda61b0",
      measurementId: "G-2P56Y7QQ18"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // ============================================================
    // LOADING SCREEN LOGIC
    // ============================================================
    const loadSteps = [
      { pct: 8, msg: 'INITIALIZING...' },
      { pct: 20, msg: 'CONNECTING DATABASE...' },
      { pct: 38, msg: 'LOADING AUDIO ENGINE...' },
      { pct: 55, msg: 'FETCHING SONGS...' },
      { pct: 72, msg: 'SYNCING PROFILE...' },
      { pct: 88, msg: 'PREPARING UI...' },
      { pct: 100, msg: 'READY!' }
    ];
    let loadIdx = 0;
    function advanceLoader(targetPct, msg) {
      const bar = document.getElementById('loadBarFill');
      const pctEl = document.getElementById('loadPercent');
      const statusEl = document.getElementById('loadStatus');
      if (statusEl) statusEl.textContent = msg;
      if (bar) bar.style.width = targetPct + '%';
      if (pctEl) pctEl.textContent = targetPct + '%';
    }
    function runLoadSequence() {
      let idx = 0;
      function next() {
        if (idx >= loadSteps.length) return;
        const s = loadSteps[idx++];
        advanceLoader(s.pct, s.msg);
        if (idx < loadSteps.length) setTimeout(next, 350 + Math.random() * 200);
      }
      next();
    }
    function dismissLoader() {
      advanceLoader(100, 'READY!');
      setTimeout(() => {
        const screen = document.getElementById('gameLoadScreen');
        if (screen) {
          screen.classList.add('fade-out');
          setTimeout(() => { screen.style.display = 'none'; }, 800);
        }
      }, 400);
    }
    runLoadSequence();

    // ============================================================
    // HEARTS SYSTEM (for velly tag)
    // ============================================================
    let heartsInterval = null;
    function createHeart() {
      const c = document.getElementById('heartsContainer');
      if (!c) return;
      const h = document.createElement('div');
      h.className = 'heart-particle';
      h.textContent = ['❤️','💗','💓','💕','💖','🩷'][Math.floor(Math.random() * 6)];
      h.style.left = Math.random() * 100 + 'vw';
      h.style.fontSize = (10 + Math.random() * 16) + 'px';
      h.style.animationDuration = (4 + Math.random() * 4) + 's';
      h.style.animationDelay = (Math.random() * 1) + 's';
      c.appendChild(h);
      setTimeout(() => h.remove(), 9000);
    }
    function startHearts() {
      const c = document.getElementById('heartsContainer');
      if (!c) return;
      c.classList.add('active');
      if (heartsInterval) return;
      heartsInterval = setInterval(createHeart, 600);
    }
    function stopHearts() {
      const c = document.getElementById('heartsContainer');
      if (c) c.classList.remove('active');
      if (heartsInterval) { clearInterval(heartsInterval); heartsInterval = null; }
    }

    // ============================================================
    // STATE
    // ============================================================
    let songs = [], i = 0, isLoginMode = true;
    let repeatMode = parseInt(localStorage.getItem('exeRepeat') || '0');
    let isShuf = localStorage.getItem('exeShuffle') === 'true';
    let fav = JSON.parse(localStorage.getItem('exeFav') || '[]');
    let savedVol = parseFloat(localStorage.getItem('exeVolume') || '0.8');
    let userData = null;
    let profileAudio = null;
    let broadcastTimeout;
    let notifList = [], _globalNotifs = [], _userNotifs = [];
    const lastReadNotifTimeKey = 'exeNotifRead';
    let userCache = {};
    let isFirstTimeUser = false;
    let adAllUsers = [], adAllSongs = [];
    let adminLoaded = false;
    let adminDrag = { active: false, offsetX: 0, offsetY: 0 };
    let adminMode = 'normal';
    let tagDropInterval = null;
    let currentTagDrop = null;
    let lebaranInterval = null;
    let vipTrialBannerClosed = false;
    let uploadQueueInterval = null;
    let uploadQueueListenerUid = null;
    let uploadCooldownInterval = null;
    let isAdminUnlocked = localStorage.getItem('exeAdminUnlocked') === '1';
    let currentProfileUid = null;
    let adminFloatInterval = null;
    let userQuestState = { daily: {}, weekly: {} };
    let listenDailySeconds = 0;
    let listenWeeklySeconds = 0;
    let lastListenTick = 0;

    const audio = new Audio();
    audio.volume = savedVol;

    // Init UI
    window.addEventListener('DOMContentLoaded', () => {
      const repBtn = document.getElementById('rep');
      if (repBtn) {
        if (repeatMode === 1) {
          repBtn.classList.add('active-btn');
          repBtn.innerHTML = '<i class="fas fa-redo"></i><span style="font-size:7px;position:absolute;top:7px;right:5px;font-weight:bold">1</span>';
        } else if (repeatMode === 2) {
          repBtn.classList.add('active-btn');
        }
      }
      document.getElementById('shuf').classList.toggle('active-btn', isShuf);
      document.getElementById('vol').value = savedVol;
    });

    // ============================================================
    // HELPERS
    // ============================================================
    function escapeHtml(text) {
      const d = document.createElement('div'); d.textContent = text; return d.innerHTML;
    }
    function getTagHTML(tag) {
      if (!tag || tag === 'none') return '';
      const t = tag.toLowerCase();
      return `<span class="user-tag tag-${t}">${tag.toUpperCase()}</span>`;
    }
    function playProfileMusic(url) {
      if (!url) return;
      if (!profileAudio) profileAudio = new Audio();
      if (!audio.paused) {
        audio.pause();
        document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>';
        document.getElementById('eq').classList.remove('playing');
      }
      profileAudio.src = url;
      profileAudio.loop = true;
      profileAudio.play().catch(() => {});
    }
    function stopProfileMusic() {
      if (profileAudio) {
        profileAudio.pause();
        profileAudio.currentTime = 0;
      }
    }
    function getVipStatus(u) {
      const now = Date.now();
      if (u && u.vip) return 'permanent';
      if (u && u.trialvip && u.trialvip.expireAt && now < u.trialvip.expireAt) return 'trial';
      return false;
    }
    function computeQuestTags(u, folCount, flgCount) {
      const tags = {};
      tags.user = true;
      const vipType = getVipStatus(u);
      if (vipType) tags.vip = true;
      if (typeof folCount === 'number') {
        if (folCount >= 10) tags.newbie = true;
        if (folCount >= 50) tags.pro = true;
        if (folCount >= 150) { tags.terkeren = true; tags.tersulit = true; }
      }
      return tags;
    }
    function syncUserQuestTags(uid, u, folCount, flgCount) {
      if (!uid || !u) return;
      const quest = computeQuestTags(u, folCount, flgCount);
      const existing = u.alltag || {};
      const merged = {};
      let changed = false;
      Object.keys(existing).forEach(k => {
        merged[k] = existing[k];
      });
      Object.keys(quest).forEach(k => {
        if (!merged[k]) {
          merged[k] = true;
          changed = true;
        }
      });
      if (changed) {
        db.ref('users/' + uid + '/alltag').set(merged);
      }
    }
    function ensureCurrentTagInAlltag(uid, u) {
      if (!uid || !u) return;
      const t = (u.tag || '').toLowerCase();
      if (!t || t === 'none') return;
      const all = u.alltag || {};
      if (all[t]) return;
      db.ref('users/' + uid + '/alltag/' + t).set(true);
    }
    function setupTagDropWatcher() {
      if (tagDropInterval) {
        clearInterval(tagDropInterval);
        tagDropInterval = null;
      }
      const banner = document.getElementById('eventTagBanner');
      if (!auth.currentUser || !userData || !currentTagDrop || !currentTagDrop.active || !currentTagDrop.tag || !currentTagDrop.chance) {
        if (banner) banner.classList.remove('show');
        return;
      }
      if (banner) {
        const titleEl = document.getElementById('eventTagBannerTitle');
        const subEl = document.getElementById('eventTagBannerSub');
        const timerEl = document.getElementById('eventTagBannerTimer');
        if (titleEl) titleEl.textContent = 'TAG DROP: ' + String(currentTagDrop.tag || '').toUpperCase();
        if (subEl) subEl.textContent = currentTagDrop.desc || 'Tag spesial lagi drop untuk user online!';
        if (timerEl) {
          if (currentTagDrop.endAt) {
            const updateBannerTimer = () => {
              const now = Date.now();
              const diff = currentTagDrop.endAt - now;
              if (diff <= 0) {
                timerEl.textContent = 'EVENT SELESAI';
                banner.classList.remove('show');
                return;
              }
              const totalSec = Math.floor(diff / 1000);
              const m = String(Math.floor(totalSec / 60)).padStart(2, '0');
              const s = String(totalSec % 60).padStart(2, '0');
              timerEl.textContent = m + ':' + s;
            };
            updateBannerTimer();
            setInterval(updateBannerTimer, 1000);
          } else {
            timerEl.textContent = 'LIVE';
          }
        }
        banner.classList.add('show');
      }
      tagDropInterval = setInterval(() => {
        if (!auth.currentUser || !userData || !currentTagDrop || !currentTagDrop.active) return;
        if (Math.random() < currentTagDrop.chance) {
          const tag = String(currentTagDrop.tag).toLowerCase();
          const all = userData.alltag || {};
          if (!all[tag]) {
            const updates = {};
            updates['users/' + auth.currentUser.uid + '/alltag/' + tag] = true;
            db.ref().update(updates).then(() => {
              showToast('Kamu mendapatkan tag ' + tag.toUpperCase());
            });
          }
        }
      }, 30000);
    }
    function updateUploadCooldownCard() {
      const card = document.getElementById('uploadCdCard');
      const timerEl = document.getElementById('uploadCdTimer');
      const subEl = document.getElementById('uploadCdSub');
      if (!card || !timerEl || !subEl || !userData) return;
      const lastUpload = userData.lastUpload || 0;
      const now = Date.now();
      const vipType = getVipStatus(userData);
      const isAdmin = userData.role === 'admin';
      const cooldown = isAdmin ? 0 : (vipType ? 15 : 30);
      if (!cooldown) {
        card.style.display = 'none';
        return;
      }
      const nextAt = lastUpload + cooldown * 60 * 1000;
      const diffMs = nextAt - now;
      if (diffMs <= 0) {
        card.style.display = 'none';
        return;
      }
      card.style.display = 'block';
      const totalSec = Math.floor(diffMs / 1000);
      const m = String(Math.floor(totalSec / 60)).padStart(2, '0');
      const s = String(totalSec % 60).padStart(2, '0');
      timerEl.textContent = m + ':' + s;
      if (vipType) subEl.textContent = 'VIP cooldown 15 menit';
      else subEl.textContent = 'Non-VIP cooldown 30 menit';
    }
    function startUploadCooldownWatcher() {
      if (uploadCooldownInterval) clearInterval(uploadCooldownInterval);
      updateUploadCooldownCard();
      uploadCooldownInterval = setInterval(updateUploadCooldownCard, 1000);
    }
    function stopUploadCooldownWatcher() {
      if (uploadCooldownInterval) {
        clearInterval(uploadCooldownInterval);
        uploadCooldownInterval = null;
      }
      const card = document.getElementById('uploadCdCard');
      if (card) card.style.display = 'none';
    }
    function closeEventTagBanner() {
      const el = document.getElementById('eventTagBanner');
      if (el) el.classList.remove('show');
    }
    function openEventCenter() {
      const modal = document.getElementById('modalEventCenter');
      if (!auth.currentUser || !userData) {
        msg('Login dulu untuk akses event');
        return;
      }
      if (!modal) return;
      modal.style.display = 'block';
      loadUserQuests().then(() => {
        renderEventCenter();
      });
    }
    function switchEventTab(id, btn) {
      document.querySelectorAll('.event-tab-view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active'));
      const tab = document.getElementById(id === 'daily' ? 'evTabDaily' : id === 'weekly' ? 'evTabWeekly' : 'evTabShop');
      if (tab) tab.classList.add('active');
      if (btn) btn.classList.add('active');
      renderEventCenter();
    }
    function applyProfileUrl(push = false) {
      try {
        const base = window.location.protocol + '//' + window.location.host + window.location.pathname;
        let newUrl;
        if (currentProfileUid) newUrl = base + '?profile_userid=' + encodeURIComponent(currentProfileUid);
        else newUrl = base + '?id=' + i;
        if (push) window.history.pushState({ path: newUrl }, '', newUrl);
        else window.history.replaceState({ path: newUrl }, '', newUrl);
      } catch (e) {}
    }
    function fmt(s) { if (isNaN(s)) return '0:00'; let m = Math.floor(s / 60), sec = Math.floor(s % 60); return m + ':' + (sec < 10 ? '0' + sec : sec); }
    function addLog(msg) { db.ref('logs').push({ msg, time: new Date().toLocaleTimeString() }); }

    function renderEventCenter() {
      if (!auth.currentUser || !userData) return;
      const coinsEl = document.getElementById('evCoinBalance');
      if (coinsEl) coinsEl.textContent = String(userData.coins || 0);
      const dailyEl = document.getElementById('evDailyList');
      const weeklyEl = document.getElementById('evWeeklyList');
      const shopEl = document.getElementById('evShopList');
      if (dailyEl) dailyEl.innerHTML = buildDailyQuestsHtml();
      if (weeklyEl) weeklyEl.innerHTML = buildWeeklyQuestsHtml();
      if (shopEl) shopEl.innerHTML = buildShopHtml();
      updateEventSideFromTagDrop();
    }
    function getDailyKey() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + day;
    }
    function getWeeklyKey() {
      const d = new Date();
      const onejan = new Date(d.getFullYear(), 0, 1);
      const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
      return d.getFullYear() + '-w' + String(week).padStart(2, '0');
    }
    function loadUserQuests() {
      if (!auth.currentUser) return Promise.resolve();
      return db.ref('userQuests/' + auth.currentUser.uid).once('value').then(snap => {
        const val = snap.val() || {};
        userQuestState.daily = val.daily || {};
        userQuestState.weekly = val.weekly || {};
        listenDailySeconds = 0;
        listenWeeklySeconds = 0;
        lastListenTick = 0;
      }).catch(() => {
        userQuestState = { daily: {}, weekly: {} };
        listenDailySeconds = 0;
        listenWeeklySeconds = 0;
        lastListenTick = 0;
      });
    }
    function buildDailyQuestsHtml() {
      const defs = [
        { id: 'daily_first_upload', title: 'First Upload', desc: 'Upload 1 musik hari ini', reward: 5, max: 1, type: 'daily', enabled: true },
        { id: 'daily_music_producer', title: 'Music Producer', desc: 'Upload 5 musik dalam 1 hari', reward: 15, max: 5, type: 'daily', enabled: true },
        { id: 'daily_top_listener_1', title: 'Top Listener I', desc: 'Putar musik 30 menit (tab aktif)', reward: 10, max: 30, type: 'daily', enabled: true },
        { id: 'daily_follower_boost', title: 'Follower Boost', desc: 'Dapat 5 followers dalam 1 hari', reward: 20, max: 5, type: 'daily', enabled: false }
      ];
      const key = getDailyKey();
      return defs.map(def => {
        const st = (userQuestState.daily && userQuestState.daily[def.id]) || {};
        const samePeriod = st.periodKey === key;
        const cur = samePeriod ? (st.cur || 0) : 0;
        const claimed = samePeriod && !!st.claimed;
        return renderQuestCard({
          id: def.id,
          title: def.title,
          desc: def.desc,
          reward: def.reward,
          max: def.max,
          cur,
          claimed,
          type: def.type,
          enabled: def.enabled
        });
      }).join('');
    }
    function buildWeeklyQuestsHtml() {
      const defs = [
        { id: 'weekly_social_hunter', title: 'Social Hunter', desc: 'Follow 2 creator baru', reward: 50, max: 2, type: 'weekly', enabled: true },
        { id: 'weekly_top_listener_2', title: 'Top Listener II', desc: 'Putar musik 2 jam total', reward: 50, max: 120, type: 'weekly', enabled: true },
        { id: 'weekly_trending_uploader', title: 'Trending Uploader', desc: 'Total 100 play di lagu kamu', reward: 75, max: 100, type: 'weekly', enabled: false },
        { id: 'weekly_active_creator', title: 'Active Creator', desc: 'Upload 10 lagu dalam seminggu', reward: 100, max: 10, type: 'weekly', enabled: true }
      ];
      const key = getWeeklyKey();
      return defs.map(def => {
        const st = (userQuestState.weekly && userQuestState.weekly[def.id]) || {};
        const samePeriod = st.periodKey === key;
        const cur = samePeriod ? (st.cur || 0) : 0;
        const claimed = samePeriod && !!st.claimed;
        return renderQuestCard({
          id: def.id,
          title: def.title,
          desc: def.desc,
          reward: def.reward,
          max: def.max,
          cur,
          claimed,
          type: def.type,
          enabled: def.enabled
        });
      }).join('');
    }
    function buildShopHtml() {
      const tags = [
        { id: 'shop_tag_gamers', title: 'Tag [GAMERS]', desc: 'Profile dark + aksen neon green', price: 100, badge: 'Tag Eksklusif' },
        { id: 'shop_tag_legend', title: 'Tag [LEGEND]', desc: 'Nama glow + border emas', price: 500, badge: 'Tag Premium' },
        { id: 'shop_tag_execurive', title: 'Tag [EXECURIVE]', desc: 'Boost visibility dan akses VIP', price: 1000, badge: 'Tag Ultra' }
      ];
      const vips = [
        { id: 'shop_vip_3', title: 'VIP 3 Hari', desc: 'Akses VIP sementara', price: 200, badge: 'VIP Bronze' },
        { id: 'shop_vip_7', title: 'VIP 7 Hari', desc: 'Durasi VIP lebih lama', price: 500, badge: 'VIP Silver' },
        { id: 'shop_vip_30', title: 'VIP 30 Hari', desc: 'Paket VIP bulanan', price: 1200, badge: 'VIP Gold' }
      ];
      const renderItem = it => {
        const coins = userData.coins || 0;
        const progressText = coins + '/' + it.price;
        const pct = Math.max(0, Math.min(1, coins / it.price));
        const canBuy = coins >= it.price;
        return '<div class="event-shop-card">' +
          '<div class="event-shop-main">' +
            '<div class="event-shop-title-row">' +
              '<div class="event-shop-title">' + escapeHtml(it.title) + '</div>' +
              '<div class="event-shop-price"><i class="fas fa-coins"></i>' + it.price + '</div>' +
            '</div>' +
            '<div class="event-shop-desc">' + escapeHtml(it.desc) + '</div>' +
            '<div class="event-shop-progress-wrap">' +
              '<div class="event-shop-progress-bar"><div class="event-shop-progress-fill" style="transform:scaleX(' + pct + ')"></div></div>' +
              '<div class="event-shop-progress-text">' + escapeHtml(progressText) + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="event-shop-action">' +
            '<div class="event-shop-badge">' + escapeHtml(it.badge) + '</div>' +
            '<button class="event-shop-btn" disabled>' + (canBuy ? 'Beli via admin' : 'Coin belum cukup') + '</button>' +
          '</div>' +
        '</div>';
      };
      let html = '';
      html += '<div class="event-shop-section">' +
                '<div class="event-shop-section-title">Tag Eksklusif</div>' +
                '<div class="event-shop-list">' +
                  tags.map(renderItem).join('') +
                '</div>' +
              '</div>';
      html += '<div class="event-shop-section">' +
                '<div class="event-shop-section-title">Paket VIP</div>' +
                '<div class="event-shop-list">' +
                  vips.map(renderItem).join('') +
                '</div>' +
              '</div>';
      return html;
    }
    function getQuestDef(type, id) {
      if (type === 'daily') {
        if (id === 'daily_first_upload') return { id, type, title: 'First Upload', reward: 5, max: 1, enabled: true };
        if (id === 'daily_music_producer') return { id, type, title: 'Music Producer', reward: 15, max: 5, enabled: true };
        if (id === 'daily_top_listener_1') return { id, type, title: 'Top Listener I', reward: 10, max: 30, enabled: true };
        if (id === 'daily_follower_boost') return { id, type, title: 'Follower Boost', reward: 20, max: 5, enabled: false };
      } else if (type === 'weekly') {
        if (id === 'weekly_social_hunter') return { id, type, title: 'Social Hunter', reward: 50, max: 2, enabled: true };
        if (id === 'weekly_top_listener_2') return { id, type, title: 'Top Listener II', reward: 50, max: 120, enabled: true };
        if (id === 'weekly_trending_uploader') return { id, type, title: 'Trending Uploader', reward: 75, max: 100, enabled: false };
        if (id === 'weekly_active_creator') return { id, type, title: 'Active Creator', reward: 100, max: 10, enabled: true };
      }
      return null;
    }
    function updateQuestProgress(type, id, delta, uidOverride) {
      if (!auth || !auth.currentUser || !delta) return;
      const def = getQuestDef(type, id);
      if (!def || def.enabled === false) return;
      const uid = uidOverride || auth.currentUser.uid;
      const periodKey = type === 'daily' ? getDailyKey() : getWeeklyKey();
      const ref = db.ref('userQuests/' + uid + '/' + type + '/' + id);
      return ref.transaction(cur => {
        if (!cur || cur.periodKey !== periodKey) {
          const curVal = Math.min(delta, def.max);
          return { periodKey, cur: curVal, claimed: false };
        }
        const curVal = cur.cur || 0;
        const nextVal = Math.min(curVal + delta, def.max);
        if (nextVal === curVal) return cur;
        return { ...cur, cur: nextVal };
      }).then(res => {
        if (!res.committed) return;
        if (uid === (auth.currentUser && auth.currentUser.uid)) {
          if (!userQuestState[type]) userQuestState[type] = {};
          userQuestState[type][id] = res.snapshot.val() || {};
        }
      }).catch(() => {});
    }
    function grantCoins(uid, amount) {
      if (!uid || !amount || amount <= 0) return Promise.resolve();
      let remaining = amount;
      const step = () => {
        if (remaining <= 0) return Promise.resolve();
        const chunk = remaining > 10 ? 10 : remaining;
        remaining -= chunk;
        const ref = db.ref('users/' + uid + '/coins');
        return ref.transaction(cur => {
          const base = typeof cur === 'number' ? cur : 0;
          return base + chunk;
        }).then(res => {
          if (!res.committed) {
            remaining += chunk;
            return Promise.resolve();
          }
          return step();
        });
      };
      return step();
    }
    function claimQuest(type, id) {
      if (!auth || !auth.currentUser || !userData) return msg('Login dulu!');
      const def = getQuestDef(type, id);
      if (!def) return;
      if (def.enabled === false) { showToast('Quest belum aktif'); return; }
      const uid = auth.currentUser.uid;
      const periodKey = type === 'daily' ? getDailyKey() : getWeeklyKey();
      const ref = db.ref('userQuests/' + uid + '/' + type + '/' + id);
      ref.once('value').then(snap => {
        const st = snap.val() || {};
        if (st.periodKey !== periodKey) { showToast('Quest sudah reset'); return; }
        const cur = st.cur || 0;
        if (cur < def.max) { showToast('Progress belum penuh'); return; }
        if (st.claimed) { showToast('Quest sudah diklaim'); return; }
        return grantCoins(uid, def.reward).then(() => {
          return ref.update({ claimed: true, claimedAt: Date.now(), periodKey, cur });
        }).then(() => {
          return db.ref('users/' + uid + '/coins').once('value');
        }).then(csnap => {
          const newCoins = csnap.val() || 0;
          userData.coins = newCoins;
          if (!userQuestState[type]) userQuestState[type] = {};
          userQuestState[type][id] = { periodKey, cur, claimed: true };
          renderEventCenter();
          showToast('Kamu mendapatkan ' + def.reward + ' ExeCoin dari quest ' + def.title);
        });
      }).catch(() => {
        showToast('Gagal klaim quest');
      });
    }
    function renderQuestCard(q) {
      const pct = Math.max(0, Math.min(1, q.max ? (q.cur || 0) / q.max : 0));
      const progressText = (q.cur || 0) + '/' + q.max;
      const completed = (q.cur || 0) >= q.max;
      const claimed = !!q.claimed;
      const enabled = q.enabled !== false;
      let badgeText = 'Berjalan';
      if (!enabled) badgeText = 'Segera hadir';
      else if (claimed) badgeText = 'Selesai';
      else if (completed) badgeText = 'Siap diklaim';
      let btnLabel = 'Progress ' + progressText;
      let btnAttrs = 'disabled';
      if (!enabled) {
        btnLabel = 'Belum tersedia';
      } else if (claimed) {
        btnLabel = 'Sudah diklaim';
      } else if (completed) {
        btnLabel = 'Klaim ' + q.reward + ' ExeCoin';
        btnAttrs = 'onclick="claimQuest(\'' + q.type + '\', \'' + q.id + '\')"';
      }
      return '<div class="event-quest-card">' +
        '<div class="event-quest-main">' +
          '<div class="event-quest-title-row">' +
            '<div class="event-quest-title">' + escapeHtml(q.title) + '</div>' +
            '<div class="event-quest-reward"><i class="fas fa-coins"></i>' + q.reward + '</div>' +
          '</div>' +
          '<div class="event-quest-desc">' + escapeHtml(q.desc) + '</div>' +
          '<div class="event-quest-progress-wrap">' +
            '<div class="event-quest-progress-bar"><div class="event-quest-progress-fill" style="transform:scaleX(' + pct + ')"></div></div>' +
            '<div class="event-quest-progress-text">' + escapeHtml(progressText) + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="event-quest-action">' +
          '<div class="event-quest-badge">' + escapeHtml(badgeText) + '</div>' +
          '<button class="event-quest-btn secondary" ' + btnAttrs + '>' + escapeHtml(btnLabel) + '</button>' +
        '</div>' +
      '</div>';
    }
    function updateEventSideFromTagDrop() {
      const mainEl = document.getElementById('evTagDropMain');
      const subEl = document.getElementById('evTagDropSub');
      const timerEl = document.getElementById('evTagDropTimer');
      if (!mainEl || !subEl || !timerEl) return;
      if (!currentTagDrop || !currentTagDrop.active) {
        mainEl.textContent = 'Tidak ada event tag drop aktif';
        subEl.textContent = 'Tunggu admin mengaktifkan event.';
        timerEl.textContent = '--:--';
        return;
      }
      mainEl.textContent = 'TAG DROP: ' + String(currentTagDrop.tag || '').toUpperCase();
      subEl.textContent = currentTagDrop.desc || 'Tag spesial lagi drop untuk user online!';
      if (currentTagDrop.endAt) {
        const diff = currentTagDrop.endAt - Date.now();
        if (diff <= 0) {
          timerEl.textContent = 'EVENT SELESAI';
        } else {
          const totalSec = Math.floor(diff / 1000);
          const m = String(Math.floor(totalSec / 60)).padStart(2, '0');
          const s = String(totalSec % 60).padStart(2, '0');
          timerEl.textContent = m + ':' + s;
        }
      } else {
        timerEl.textContent = 'LIVE';
      }
    }

    // ============================================================
    // TOAST
    // ============================================================
    function showToast(text, type = 'info') {
      const container = document.getElementById('toast-container');
      if (!container) return;
      const el = document.createElement('div');
      el.className = 'toast';
      let icon = 'fa-info-circle';
      if (text.includes('Playing')) icon = 'fa-music';
      else if (text.includes('Favorit') || text.includes('heart') || text.includes('❤')) icon = 'fa-heart';
      else if (text.includes('Shuffle') || text.includes('🔀')) icon = 'fa-random';
      else if (text.includes('Repeat') || text.includes('🔁')) icon = 'fa-redo';
      else if (text.includes('✅') || text.includes('berhasil')) icon = 'fa-check-circle';
      else if (text.includes('Error') || text.includes('❌')) icon = 'fa-exclamation-triangle';
      el.innerHTML = `<i class="fas ${icon}"></i> <span>${text}</span>`;
      container.appendChild(el);
      setTimeout(() => el.classList.add('hide'), 2500);
      setTimeout(() => el.remove(), 2900);
    }
    function msg(m) { showToast(m); }
    function closeModal() {
      document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
      stopHearts();
      stopProfileMusic();
      currentProfileUid = null;
      applyProfileUrl(true);
    }

    // ============================================================
    // SETTINGS LISTENER
    // ============================================================
    db.ref('settings').on('value', s => {
      const val = s.val();
      if (!val) return;
      if (val.accentColor && typeof val.accentColor === 'string') {
        document.documentElement.style.setProperty('--accent', val.accentColor);
      } else {
        document.documentElement.style.setProperty('--accent', '#00ff88');
      }
      if (val.mt === true) {
        db.ref('users/' + (auth.currentUser?.uid) + '/role').once('value', r => {
          if (r.val() !== 'admin') document.getElementById('mtScreen').style.display = 'flex';
        });
      } else {
        document.getElementById('mtScreen').style.display = 'none';
      }
      if (val.announcement) triggerBroadcast(val.announcement);

      const lc = document.getElementById('lebaranCountdown');
      const lt = document.getElementById('lebaranTimer');
      if (val.lebaranTs && typeof val.lebaranTs === 'number') {
        setupLebaranCountdown(val.lebaranTs);
        if (lc && lt) {
          lc.classList.add('show');
        }
        const dEl = document.getElementById('adLebaranDate');
        const tEl = document.getElementById('adLebaranTime');
        if (dEl && tEl) {
          const dt = new Date(val.lebaranTs);
          const yyyy = dt.getFullYear();
          const mm = String(dt.getMonth() + 1).padStart(2, '0');
          const dd = String(dt.getDate()).padStart(2, '0');
          const hh = String(dt.getHours()).padStart(2, '0');
          const mi = String(dt.getMinutes()).padStart(2, '0');
          dEl.value = `${yyyy}-${mm}-${dd}`;
          tEl.value = `${hh}:${mi}`;
        }
      } else {
        if (lebaranInterval) {
          clearInterval(lebaranInterval);
          lebaranInterval = null;
        }
        if (lc) {
          lc.classList.remove('show', 'celebrate');
        }
      }
    });

    // ============================================================
    // BROADCAST
    // ============================================================
    function triggerBroadcast(msg) {
      const el = document.getElementById('sysBroadcast');
      const bar = document.getElementById('sbBar');
      const msgEl = document.getElementById('sbMessage');
      el.classList.remove('active', 'sb-closing');
      bar.style.animation = 'none';
      void bar.offsetWidth;
      if (typeof msg === 'string' && msg.trim().toLowerCase().startsWith('hexky:')) {
        const rest = msg.slice(6).trim();
        msgEl.innerHTML = '<span class="sb-dev-name">Hexky</span>: ' + escapeHtml(rest);
      } else {
        msgEl.textContent = msg;
      }
      setTimeout(() => { el.classList.add('active'); bar.style.animation = 'countDown 15s linear forwards'; }, 100);
      clearTimeout(broadcastTimeout);
      broadcastTimeout = setTimeout(closeBroadcast, 15000);
    }
    function closeBroadcast() {
      const el = document.getElementById('sysBroadcast');
      el.classList.add('sb-closing');
      setTimeout(() => el.classList.remove('active', 'sb-closing'), 400);
    }

    function setupGlobalNotifsWatcher() {
      db.ref('globalNotifications').limitToLast(50).on('value', snap => {
        const list = [];
        const val = snap.val();
        if (val) {
          Object.keys(val).forEach(k => list.push({ ...val[k], id: 'g_' + k }));
        }
        mergeAndRenderNotifs(list, 'global');
      });
    }

    function setupAdminFloatChatWatcher() {
      const wrap = document.getElementById('adminFloatChat');
      const nameEl = document.getElementById('adminFloatName');
      const msgEl = document.getElementById('adminFloatMsg');
      const timerEl = document.getElementById('adminFloatTimer');
      if (!wrap || !nameEl || !msgEl || !timerEl) return;
      db.ref('adminFloatChat/current').on('value', snap => {
        const val = snap.val();
        if (adminFloatInterval) {
          clearInterval(adminFloatInterval);
          adminFloatInterval = null;
        }
        if (!val) {
          wrap.classList.remove('show');
          nameEl.textContent = '';
          msgEl.textContent = '';
          timerEl.textContent = '';
          return;
        }
        const now = Date.now();
        const expireAt = val.expireAt || 0;
        if (expireAt && now >= expireAt) {
          wrap.classList.remove('show');
          nameEl.textContent = '';
          msgEl.textContent = '';
          timerEl.textContent = '';
          if (auth.currentUser && userData && (userData.role === 'admin' || userData.role === 'owner')) {
            db.ref('adminFloatChat/current').remove();
          }
          return;
        }
        nameEl.textContent = (val.name || 'Admin') + '';
        msgEl.textContent = val.msg || '';
        wrap.classList.add('show');
        function updateTimer() {
          const now2 = Date.now();
          const diff = (val.expireAt || 0) - now2;
          if (diff <= 0) {
            timerEl.textContent = '0s';
            wrap.classList.remove('show');
            clearInterval(adminFloatInterval);
            adminFloatInterval = null;
            if (auth.currentUser && userData && (userData.role === 'admin' || userData.role === 'owner')) {
              db.ref('adminFloatChat/current').remove();
            }
            return;
          }
          const sec = Math.ceil(diff / 1000);
          timerEl.textContent = sec + 's';
        }
        updateTimer();
        adminFloatInterval = setInterval(updateTimer, 500);
      });
    }

    // ============================================================
    // NOTIFICATIONS
    // ============================================================
    function loadNotifs() {
      auth.onAuthStateChanged(u => {
        if (!u) {
          mergeAndRenderNotifs([], 'user');
          showGuestIntroNotif();
          return;
        }
        db.ref('users/' + u.uid + '/notifications').orderByChild('timestamp').limitToLast(80).on('value', snap => {
          const val = snap.val();
          const list = [];
          if (val) Object.keys(val).forEach(k => list.push({ ...val[k], id: 'u_' + k }));
          mergeAndRenderNotifs(list, 'user');
        });
      });
    }
    function mergeAndRenderNotifs(list, source) {
      if (source === 'global') _globalNotifs = list;
      else _userNotifs = list;
      notifList = [..._globalNotifs, ..._userNotifs].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      renderNotifList(); updateNotifBadge();
    }
    function timeAgo(ts) {
      if (!ts) return '';
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 60) return 'Baru saja';
      if (s < 3600) return Math.floor(s / 60) + ' menit lalu';
      if (s < 86400) return Math.floor(s / 3600) + ' jam lalu';
      if (s < 604800) return Math.floor(s / 86400) + ' hari lalu';
      return new Date(ts).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
    }
    function renderNotifList() {
      const el = document.getElementById('notifList');
      if (!el) return;
      if (!notifList.length) { el.innerHTML = '<div class="notif-empty">Belum ada notifikasi</div>'; return; }
      const typeIcon = { admin: 'fa-shield-alt', violation: 'fa-exclamation-triangle', upload: 'fa-music', follow: 'fa-user-plus', system: 'fa-info-circle' };
      el.innerHTML = notifList.map(n => {
        const type = (n.type || 'system');
        const icon = typeIcon[type] || 'fa-bell';
        return `<div class="notif-item"><div class="notif-item-icon ${type}"><i class="fas ${icon}"></i></div><div class="notif-item-body"><div class="n-text">${escapeHtml(n.text || n.message || '')}</div><div class="n-time">${timeAgo(n.timestamp)}</div></div></div>`;
      }).join('');
    }
    function updateNotifBadge() {
      const lastRead = parseInt(localStorage.getItem(lastReadNotifTimeKey) || '0', 10);
      const count = notifList.filter(n => (n.timestamp || 0) > lastRead).length;
      const badge = document.getElementById('notifBadge');
      if (badge) { badge.textContent = count > 99 ? '99+' : count; badge.classList.toggle('show', count > 0); }
    }
    function positionNotifPanel() {
      const btn = document.getElementById('btnNotif');
      const panel = document.getElementById('notifPanel');
      if (!btn || !panel) return;
      const rect = btn.getBoundingClientRect();
      const panelW = Math.min(360, window.innerWidth - 20);
      let left = rect.right - panelW;
      if (left < 10) left = 10;
      if (left + panelW > window.innerWidth - 10) left = window.innerWidth - panelW - 10;
      panel.style.top = (rect.bottom + 10) + 'px';
      panel.style.left = left + 'px';
      panel.style.right = 'auto';
      panel.style.width = panelW + 'px';
    }
    function toggleNotifPanel() {
      const panel = document.getElementById('notifPanel');
      const willShow = !panel.classList.contains('show');
      if (willShow) {
        positionNotifPanel();
        panel.classList.add('show');
        localStorage.setItem(lastReadNotifTimeKey, String(Date.now()));
        updateNotifBadge();
      } else {
        panel.classList.remove('show');
        localStorage.setItem(lastReadNotifTimeKey, String(Date.now()));
        updateNotifBadge();
      }
    }
    function closeNotifPanel() { document.getElementById('notifPanel').classList.remove('show'); localStorage.setItem(lastReadNotifTimeKey, String(Date.now())); updateNotifBadge(); }
    document.addEventListener('click', function(e) {
      const panel = document.getElementById('notifPanel'); const btn = document.getElementById('btnNotif');
      if (panel && panel.classList.contains('show') && !panel.contains(e.target) && btn && !btn.contains(e.target)) closeNotifPanel();
    });
    function showGuestIntroNotif() {
      if (localStorage.getItem('exeGuestIntroShown') === '1') return;
      localStorage.setItem('exeGuestIntroShown', '1');
      const payload = {
        type: 'system',
        text: '[bot exemusic] Login dan daftarkan akun kamu ke ExeMusic sekarang!!',
        fromName: 'bot exemusic',
        timestamp: Date.now()
      };
      mergeAndRenderNotifs([payload], 'global');
    }
    loadNotifs();
    setupGlobalNotifsWatcher();
    setupAdminFloatChatWatcher();

    // ============================================================
    // AUTH
    // ============================================================
    auth.onAuthStateChanged(u => {
      if (u) {
        startUploadQueueWatcher(u.uid);
        db.ref('users/' + u.uid).on('value', snap => {
          userData = snap.val();
          if (!userData) { dismissLoader(); return; }
          if (userData.banned === true) { document.getElementById('bannedScreen').style.display = 'flex'; auth.signOut(); return; }

          const now = Date.now();
          const vipType = getVipStatus(userData);
          const vipActive = !!vipType;

          document.getElementById('topLoginBtn').textContent = userData.username;

          // Crown
          document.getElementById('pUsername').innerHTML = userData.username + (vipActive ? ' <i class="fas fa-crown" style="color:#ffd700;font-size:13px;margin-left:5px"></i>' : '');
          document.getElementById('pAvatarImg').src = userData.avatar || 'https://via.placeholder.com/150';

          const fol = userData.followers;
          const folCount = Array.isArray(fol) ? fol.length : (fol && typeof fol === 'object' ? Object.keys(fol).length : fol || 0);
          const flg = userData.following;
          const flgCount = Array.isArray(flg) ? flg.length : (flg && typeof flg === 'object' ? Object.keys(flg).length : flg || 0);
          document.getElementById('pFol').innerText = folCount;
          document.getElementById('pFollowing').innerText = flgCount;
          document.getElementById('pTagDisplay').innerHTML = getTagHTML(userData.tag);
          syncUserQuestTags(u.uid, userData, folCount, flgCount);
          ensureCurrentTagInAlltag(u.uid, userData);
          startUploadCooldownWatcher();

          document.getElementById('pBadge').innerHTML = folCount >= 50 ? '<i class="fas fa-check-circle v-badge"></i>' : '';

          // Profile header style
          const profHeader = document.getElementById('profileHeader');
          if (profHeader) {
            profHeader.classList.remove('vip', 'pink-profile');
            const tagLower = (userData.tag || '').toLowerCase();
            if (tagLower.includes('velly')) {
              profHeader.classList.add('pink-profile');
            }
          }

          const pmBtn = document.getElementById('btnProfileMusic');
          const pmRow = document.getElementById('profileMusicRow');
          if (pmBtn && pmRow) {
            pmBtn.style.display = vipActive ? 'inline-flex' : 'none';
            pmRow.style.display = 'none';
            document.getElementById('profileMusicUrl').value = userData.profilemusic || '';
          }

          // VIP status text
          let statusText = 'Status: NONVIP';
          if (userData.vip) statusText = 'Status: VIP PERMANENT ✨';
          else if (userData.trialvip && userData.trialvip.expireAt && now < userData.trialvip.expireAt) {
            statusText = 'Status: VIP TRIAL AKTIF 👑';
            updateVipTrialBanner(userData.trialvip.expireAt);
          }
          const vs = document.getElementById('pVipStatus');
          if (vs) vs.textContent = statusText;

          const emailParts = (u.email || '').split('@');
          const name = emailParts[0], domain = emailParts[1] || '';
          const sensoredEmail = name.slice(0, Math.max(1, Math.floor(name.length / 3))) + '*'.repeat(Math.max(3, name.length - 2)) + '@' + domain;
          document.getElementById('pEmail').innerText = sensoredEmail;

          document.getElementById('uploadFormUser').style.display = 'block';
          document.getElementById('uploadFormGuest').style.display = 'none';
          document.getElementById('btnFollow').style.display = 'flex';
          if (userData.role === 'admin' || userData.role === 'owner') {
            document.getElementById('btnAdmin').classList.add('show');
          }
          updateFollowUI();
        });
        setupTagDropWatcher();
      } else {
        stopUploadQueueWatcher();
        stopUploadCooldownWatcher();
        if (tagDropInterval) {
          clearInterval(tagDropInterval);
          tagDropInterval = null;
        }
        document.getElementById('topLoginBtn').textContent = 'Login';
        document.getElementById('btnFollow').style.display = 'none';
        document.getElementById('btnAdmin').classList.remove('show');
        stopHearts();
      }
      dismissLoader();
    });

    // ============================================================
    // VIP TRIAL BANNER
    // ============================================================
    function updateVipTrialBanner(expireAt) {
      const banner = document.getElementById('vipTrialBanner');
      const timerEl = document.getElementById('vipTrialTimer');
      if (!banner || !timerEl) return;

      function update() {
        if (vipTrialBannerClosed) { banner.classList.remove('show'); return; }
        const now = Date.now();
        const diff = expireAt - now;
        if (diff <= 0) { banner.classList.remove('show'); return; }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        timerEl.textContent = `${d}h ${h}j ${m}m lagi`;
        banner.classList.add('show');
      }
      update();
      setInterval(update, 60000);
    }

    function closeVipTrialBanner() {
      vipTrialBannerClosed = true;
      const banner = document.getElementById('vipTrialBanner');
      if (banner) banner.classList.remove('show');
    }

    // ============================================================
    // LEBARAN COUNTDOWN
    // ============================================================
    function setupLebaranCountdown(targetTs) {
      const wrap = document.getElementById('lebaranCountdown');
      const timerEl = document.getElementById('lebaranTimer');
      if (!wrap || !timerEl) return;
      if (lebaranInterval) {
        clearInterval(lebaranInterval);
        lebaranInterval = null;
      }
      function updateLebaran() {
        const now = Date.now();
        const diff = targetTs - now;
        if (diff <= 0) {
          timerEl.textContent = 'Selamat Idulfitri! 🌙';
          wrap.classList.add('celebrate');
          if (lebaranInterval) {
            clearInterval(lebaranInterval);
            lebaranInterval = null;
          }
          return;
        }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        timerEl.textContent = `${d}h ${h}j ${m}m lagi`;
        wrap.classList.add('show');
      }
      updateLebaran();
      lebaranInterval = setInterval(updateLebaran, 60000);
    }

    function closeLebaranCountdown() {
      const wrap = document.getElementById('lebaranCountdown');
      if (wrap) wrap.classList.remove('show', 'celebrate');
      if (lebaranInterval) {
        clearInterval(lebaranInterval);
        lebaranInterval = null;
      }
    }

    // ============================================================
    // SONGS
    // ============================================================
    db.ref('songs').on('value', snap => {
      const val = snap.val();
      if (val) {
        songs = Object.keys(val).map(k => ({ ...val[k], key: k }));
        adAllSongs = [...songs];
        renderAdminSongs();

        const urlParams = new URLSearchParams(window.location.search);
        const songId = urlParams.get('id');
        const profileUid = urlParams.get('profile_userid');

        if (profileUid && auth.currentUser) {
          if (profileUid === auth.currentUser.uid) openProfile();
          else openCreatorByUid(profileUid);
        } else if (audio.src === '') {
          if (songId && songs[parseInt(songId)]) {
            setup(parseInt(songId), false);
          } else {
            const savedIdx = localStorage.getItem('exeLastSongIdx');
            const savedTime = localStorage.getItem('exeLastTime');
            if (savedIdx !== null && songs[parseInt(savedIdx)]) {
              setup(parseInt(savedIdx), false).then(() => { if (savedTime) audio.currentTime = parseFloat(savedTime); });
            } else {
              setup(0, false);
            }
          }
        }
      }
    });

    async function setup(idx, play = true) {
      if (!songs[idx]) return;
      i = idx;
      applyProfileUrl(true);
      audio.src = songs[i].url;
      document.getElementById('title').textContent = songs[i].title;
      const cRef = await db.ref('users/' + songs[i].uid).get();
      const cData = cRef.val();
      const fcb = (() => { const f = cData?.followers; return Array.isArray(f) ? f.length : (f && typeof f === 'object' ? Object.keys(f).length : f || 0); })();
      const badge = fcb >= 50 ? '<i class="fas fa-check-circle v-badge"></i>' : '';
      const creatorVip = getVipStatus(cData);
      const crown = creatorVip ? ' <i class="fas fa-crown" style="color:#ffd700;font-size:11px"></i>' : '';
      document.getElementById('by').innerHTML = '@' + (songs[i].by || 'system') + badge + crown;
      if (play) {
        audio.play();
        document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>';
        document.getElementById('eq').classList.add('playing');
        showToast(`🎵 Now Playing: ${songs[i].title}`);
      }
      updateFollowUI(); updateFavoriteUI(); saveLastSong();
    }

    function toggle() {
      if (audio.paused) { audio.play(); document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>'; document.getElementById('eq').classList.add('playing'); }
      else { audio.pause(); document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>'; document.getElementById('eq').classList.remove('playing'); }
    }
    function next() { setup(isShuf ? Math.floor(Math.random() * songs.length) : (i + 1) % songs.length); }
    function prev() { setup(isShuf ? Math.floor(Math.random() * songs.length) : (i - 1 + songs.length) % songs.length); }

    audio.ontimeupdate = () => {
      document.getElementById('seek').value = (audio.currentTime / audio.duration) * 100 || 0;
      document.getElementById('cur').textContent = fmt(audio.currentTime);
      document.getElementById('dur').textContent = fmt(audio.duration);
      if (audio.duration > 0) document.getElementById('loadSpinner').classList.remove('show');
      if (Math.floor(audio.currentTime) % 2 === 0) localStorage.setItem('exeLastTime', audio.currentTime);
      if (auth && auth.currentUser && !audio.paused && document.visibilityState === 'visible') {
        const now = Date.now();
        if (!lastListenTick) lastListenTick = now;
        const diffSec = (now - lastListenTick) / 1000;
        if (diffSec >= 5) {
          lastListenTick = now;
          const addSec = Math.floor(diffSec);
          addListeningProgress(addSec);
        }
      }
    };
    audio.onplay = () => { if (!audio.duration || isNaN(audio.duration)) document.getElementById('loadSpinner').classList.add('show'); };
    audio.onpause = () => { localStorage.setItem('exeLastTime', audio.currentTime); };
    audio.onloadedmetadata = () => document.getElementById('loadSpinner').classList.remove('show');
    document.getElementById('seek').oninput = (e) => audio.currentTime = (e.target.value / 100) * audio.duration;
    document.getElementById('vol').oninput = (e) => { audio.volume = e.target.value; localStorage.setItem('exeVolume', e.target.value); };
    audio.onended = () => {
      if (repeatMode === 1) { audio.currentTime = 0; audio.play(); }
      else if (repeatMode === 2 || isShuf) next();
      else if (i < songs.length - 1) next();
    };
    function saveLastSong() { localStorage.setItem('exeLastSongIdx', i); }
    function addListeningProgress(sec) {
      if (!auth || !auth.currentUser || !sec) return;
      listenDailySeconds += sec;
      listenWeeklySeconds += sec;
      const addedDailyMin = Math.floor(listenDailySeconds / 60);
      const addedWeeklyMin = Math.floor(listenWeeklySeconds / 60);
      if (addedDailyMin > 0) {
        listenDailySeconds -= addedDailyMin * 60;
        updateQuestProgress('daily', 'daily_top_listener_1', addedDailyMin, auth.currentUser.uid);
      }
      if (addedWeeklyMin > 0) {
        listenWeeklySeconds -= addedWeeklyMin * 60;
        updateQuestProgress('weekly', 'weekly_top_listener_2', addedWeeklyMin, auth.currentUser.uid);
      }
    }

    // ============================================================
    // UPLOAD / SAVE + QUEUE
    // ============================================================
    function startUploadQueueWatcher(uid) {
      if (!uid) return;
      if (uploadQueueListenerUid && uploadQueueListenerUid !== uid) {
        db.ref('uploadQueue/' + uploadQueueListenerUid).off();
      }
      uploadQueueListenerUid = uid;
      db.ref('uploadQueue/' + uid).on('value', snap => {
        const val = snap.val() || {};
        renderUploadQueue(val);
      });
      if (uploadQueueInterval) clearInterval(uploadQueueInterval);
      uploadQueueInterval = setInterval(() => processUploadQueue(uid), 15000);
    }
    function stopUploadQueueWatcher() {
      if (uploadQueueInterval) {
        clearInterval(uploadQueueInterval);
        uploadQueueInterval = null;
      }
      if (uploadQueueListenerUid) {
        db.ref('uploadQueue/' + uploadQueueListenerUid).off();
        uploadQueueListenerUid = null;
      }
      const section = document.getElementById('uploadQueueSection');
      if (section) section.style.display = 'none';
    }
    function renderUploadQueue(map) {
      const section = document.getElementById('uploadQueueSection');
      const listEl = document.getElementById('uploadQueueList');
      const infoEl = document.getElementById('uploadQueueInfo');
      if (!section || !listEl || !infoEl || !userData) return;
      const vipType = getVipStatus(userData);
      const limit = userData.role === 'admin' ? 0 : (vipType ? 2 : 1);
      const entries = Object.keys(map || {}).map(id => ({ id, ...(map[id] || {}) }))
        .sort((a, b) => (a.scheduledAt || 0) - (b.scheduledAt || 0));
      section.style.display = 'block';
      if (!entries.length) {
        infoEl.textContent = 'Belum ada antrian upload';
        listEl.innerHTML = '<div style="font-size:11px;color:#777;padding:6px 0">Kamu belum punya upload di queue.</div>';
        return;
      }
      const activeCount = entries.filter(it => it.status !== 'done' && it.status !== 'cancelled').length;
      if (limit) infoEl.textContent = activeCount + '/' + limit + ' slot terpakai';
      else infoEl.textContent = '';
      listEl.innerHTML = entries.map(it => {
        const t = it.title || '';
        const timeStr = it.scheduledAt ? new Date(it.scheduledAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '';
        let statusLabel = 'Queued';
        let statusClass = 'status-queued';
        if (it.status === 'processing') { statusLabel = 'Processing'; statusClass = 'status-processing'; }
        else if (it.status === 'done') { statusLabel = 'Uploaded'; statusClass = 'status-done'; }
        const disabled = it.status === 'processing';
        return `<div class="upload-queue-item">
          <div class="upload-queue-main">
            <div class="upload-queue-title">${escapeHtml(t)}</div>
            <div class="upload-queue-time">${escapeHtml(timeStr)}</div>
          </div>
          <div class="upload-queue-actions">
            <span class="upload-queue-status ${statusClass}">${escapeHtml(statusLabel)}</span>
            <button class="upload-queue-btn" onclick="editUploadQueueItem('${it.id}')" ${disabled ? 'disabled' : ''}><i class="fas fa-pen"></i></button>
            <button class="upload-queue-btn" onclick="deleteUploadQueueItem('${it.id}')" ${disabled ? 'disabled' : ''}><i class="fas fa-trash"></i></button>
          </div>
        </div>`;
      }).join('');
    }
    async function processUploadQueue(uid) {
      if (!uid || !auth.currentUser || !userData || auth.currentUser.uid !== uid) return;
      const now = Date.now();
      const snap = await db.ref('uploadQueue/' + uid).orderByChild('scheduledAt').endAt(now).limitToFirst(1).get();
      const val = snap.val();
      if (!val) return;
      const id = Object.keys(val)[0];
      const item = val[id];
      if (!item || item.status !== 'queued') return;
      const itemRef = db.ref('uploadQueue/' + uid + '/' + id);
      const txRes = await itemRef.transaction(cur => {
        if (!cur || cur.status !== 'queued') return cur;
        return { ...cur, status: 'processing', processingAt: now };
      });
      if (!txRes.committed) return;
      const cur = txRes.snapshot.val();
      if (!cur || cur.status !== 'processing') return;
      const songRef = db.ref('songs').push();
      const songData = { title: cur.title, url: cur.url, uid, by: userData.username, timestamp: Date.now() };
      await songRef.set(songData);
      const songKey = songRef.key;
      await db.ref('users/' + uid).update({ lastUpload: Date.now() });
      await itemRef.update({ status: 'done', uploadedAt: Date.now(), songKey });
      await db.ref('users/' + uid + '/notifications').push({ type: 'upload', text: userData.username + ' mengupload (queue): ' + (cur.title || ''), fromName: userData.username, timestamp: Date.now() });
      updateQuestProgress('daily', 'daily_first_upload', 1, uid);
      updateQuestProgress('daily', 'daily_music_producer', 1, uid);
      updateQuestProgress('weekly', 'weekly_active_creator', 1, uid);
      msg('✅ Upload queue terupload: ' + (cur.title || ''));
    }
    async function editUploadQueueItem(id) {
      if (!auth.currentUser || !userData || !id) return;
      const uid = auth.currentUser.uid;
      const snap = await db.ref('uploadQueue/' + uid + '/' + id).get();
      const item = snap.val();
      if (!item) { msg('Queue tidak ditemukan'); return; }
      if (item.status === 'processing') { msg('Queue sedang diproses'); return; }
      const safeTitle = (item.title || '').replace(/"/g, '&quot;');
      const safeUrl = (item.url || '').replace(/"/g, '&quot;');
      Swal.fire({
        title: 'Edit Upload Queue',
        html:
          '<input id="qTitle" class="swal2-input" placeholder="Judul Lagu" value="' + safeTitle + '">' +
          '<input id="qUrl" class="swal2-input" placeholder="URL MP3" value="' + safeUrl + '">',
        focusConfirm: false,
        showCancelButton: true,
        background: '#181818',
        color: '#fff',
        confirmButtonColor: '#00ff88',
        cancelButtonColor: '#d33',
        preConfirm: () => {
          const title = (document.getElementById('qTitle').value || '').trim();
          const url = (document.getElementById('qUrl').value || '').trim();
          if (!title || !url) {
            Swal.showValidationMessage('Judul dan URL wajib diisi');
            return;
          }
          return { title, url };
        }
      }).then(async res => {
        if (!res.value) return;
        await db.ref('uploadQueue/' + uid + '/' + id).update({
          title: res.value.title,
          url: res.value.url
        });
        msg('Queue diperbarui');
      });
    }
    function deleteUploadQueueItem(id) {
      if (!auth.currentUser || !id) return;
      const uid = auth.currentUser.uid;
      Swal.fire({
        title: 'Hapus dari queue?',
        text: 'Lagu tidak akan diupload otomatis.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ff4d4f',
        cancelButtonColor: '#555',
        confirmButtonText: 'Ya, hapus',
        background: '#181818',
        color: '#fff'
      }).then(async r => {
        if (!r.isConfirmed) return;
        await db.ref('uploadQueue/' + uid + '/' + id).remove();
        msg('Queue dihapus');
      });
    }
    function getUploadQueueLimit() {
      if (!userData || userData.role === 'admin') return 0;
      const vipType = getVipStatus(userData);
      return vipType ? 2 : 1;
    }
    async function confirmAndSave() {
      const title = document.getElementById('rLagu').value;
      const url = document.getElementById('rUrl').value;
      if (!title || !url) return msg('Isi semua data!');
      if (!auth.currentUser || !userData) return msg('Login dulu!');
      if (userData.banUpload) {
        msg('Akun ini dibanned dari upload');
        return;
      }
      const lastUpload = userData.lastUpload || 0;
      const now = Date.now();
      const diff = (now - lastUpload) / 1000 / 60;
      const vipType = getVipStatus(userData);
      const isAdmin = userData.role === 'admin';
      const cooldown = isAdmin ? 0 : (vipType ? 15 : 30);
      if (isAdmin || diff >= cooldown) {
        let cdInterval;
        Swal.fire({
          title: 'Yakin?',
          html: 'Pelanggaran rules → BANNED PERMANENT!<br><span id="uploadConfirmCd" style="font-size:11px;display:block;margin-top:6px;color:#ccc">Tunggu 5 detik sebelum bisa upload...</span>',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#00ff88',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Saya Bertanggung Jawab',
          background: '#181828',
          color: '#fff',
          didOpen: () => {
            const btn = Swal.getConfirmButton();
            const label = document.getElementById('uploadConfirmCd');
            let sec = 5;
            if (btn) btn.disabled = true;
            cdInterval = setInterval(() => {
              sec--;
              if (label) label.textContent = sec > 0 ? `Tunggu ${sec} detik sebelum bisa upload...` : 'Silakan upload jika sudah yakin.';
              if (sec <= 0) {
                if (btn) btn.disabled = false;
                clearInterval(cdInterval);
              }
            }, 1000);
          },
          willClose: () => {
            if (cdInterval) clearInterval(cdInterval);
          }
        }).then(r => { if (r.isConfirmed) saveMusic(title, url); });
        return;
      }
      const queueLimit = getUploadQueueLimit();
      if (!queueLimit) {
        Swal.fire({ icon: 'error', title: 'Sabar...', text: `Tunggu ${Math.ceil(cooldown - diff)} menit lagi.`, background: '#181828', color: '#fff' });
        return;
      }
      const qSnap = await db.ref('uploadQueue/' + auth.currentUser.uid).get();
      const qVal = qSnap.val() || {};
      let activeCount = 0;
      Object.keys(qVal).forEach(k => {
        const it = qVal[k];
        if (!it) return;
        if (it.status === 'done' || it.status === 'cancelled') return;
        activeCount++;
      });
      if (activeCount >= queueLimit) {
        Swal.fire({ icon: 'error', title: 'Queue penuh', text: 'Upload queue kamu sudah penuh, tunggu antrian terupload dulu.', background: '#181828', color: '#fff' });
        return;
      }
      const scheduledAt = Math.max(lastUpload + cooldown * 60 * 1000, now);
      Swal.fire({ title: 'Masuk Upload Queue?', text: 'Lagu akan otomatis diupload saat cooldown selesai.', icon: 'question', showCancelButton: true, confirmButtonColor: '#00ff88', cancelButtonColor: '#d33', confirmButtonText: 'Ya, antrikan', background: '#181828', color: '#fff' })
        .then(async r => {
          if (!r.isConfirmed) return;
          const item = { title, url, uid: auth.currentUser.uid, by: userData.username, createdAt: now, scheduledAt, status: 'queued', cooldownMinutes: cooldown, vip: !!vipType };
          await db.ref('uploadQueue/' + auth.currentUser.uid).push(item);
          msg('✅ Lagu masuk upload queue');
          document.getElementById('rLagu').value = '';
          document.getElementById('rUrl').value = '';
        });
    }
    function saveMusic(t, u) {
      const newSong = { title: t, url: u, uid: auth.currentUser.uid, by: userData.username, timestamp: Date.now() };
      db.ref('songs').push(newSong).then(() => {
        const uid = auth.currentUser.uid;
        db.ref('users/' + uid).update({ lastUpload: Date.now() });
        db.ref('users/' + uid + '/notifications').push({ type: 'upload', text: userData.username + ' mengupload: ' + t, fromName: userData.username, timestamp: Date.now() });
        updateQuestProgress('daily', 'daily_first_upload', 1, uid);
        updateQuestProgress('daily', 'daily_music_producer', 1, uid);
        updateQuestProgress('weekly', 'weekly_active_creator', 1, uid);
        msg('✅ Berhasil diposting!'); closeModal();
        document.getElementById('rLagu').value = ''; document.getElementById('rUrl').value = '';
      });
    }

    // ============================================================
    // FOLLOW / FAVORITE
    // ============================================================
    async function followUser() {
      if (!auth.currentUser) return msg('Login dulu!');
      const targetUid = songs[i].uid;
      if (!targetUid || targetUid === auth.currentUser.uid) return msg('Gak bisa follow diri sendiri');
      try {
        const [tSnap, cSnap] = await Promise.all([db.ref('users/' + targetUid).get(), db.ref('users/' + auth.currentUser.uid).get()]);
        const tData = tSnap.val(), cData = cSnap.val();
        const fArr = Array.isArray(tData?.followers) ? [...tData.followers] : (tData?.followers && typeof tData.followers === 'object' ? Object.keys(tData.followers) : []);
        const flArr = Array.isArray(cData?.following) ? [...cData.following] : (cData?.following && typeof cData.following === 'object' ? Object.keys(cData.following) : []);
        const isF = fArr.includes(auth.currentUser.uid);
        if (isF) {
          await db.ref('users/' + targetUid).update({ followers: fArr.filter(u => u !== auth.currentUser.uid) });
          await db.ref('users/' + auth.currentUser.uid).update({ following: flArr.filter(u => u !== targetUid) });
          msg('Unfollowed!');
        } else {
          await db.ref('users/' + targetUid).update({ followers: [...fArr, auth.currentUser.uid] });
          await db.ref('users/' + auth.currentUser.uid).update({ following: [...flArr, targetUid] });
          db.ref('users/' + targetUid + '/notifications').push({ type: 'follow', text: userData.username + ' mulai mengikuti kamu', fromName: userData.username, fromUid: auth.currentUser.uid, timestamp: Date.now() });
          msg('Followed! ✅');
        }
        const newFolCount = isF ? fArr.length - 1 : fArr.length + 1;
        const newFlCount = isF ? flArr.length - 1 : flArr.length + 1;
        syncUserQuestTags(targetUid, tData || {}, newFolCount, (tData && tData.following) ? (Array.isArray(tData.following) ? tData.following.length : (typeof tData.following === 'object' ? Object.keys(tData.following).length : 0)) : 0);
        syncUserQuestTags(auth.currentUser.uid, cData || {}, (cData && cData.followers) ? (Array.isArray(cData.followers) ? cData.followers.length : (typeof cData.followers === 'object' ? Object.keys(cData.followers).length : 0)) : 0, newFlCount);
        if (!isF) {
          updateQuestProgress('weekly', 'weekly_social_hunter', 1, auth.currentUser.uid);
        }
        await updateFollowUI();
      } catch (err) { msg('Error: ' + err.message); }
    }
    async function updateFollowUI() {
      if (!auth.currentUser || !songs[i]?.uid) return;
      const tSnap = await db.ref('users/' + songs[i].uid).get();
      const tData = tSnap.val();
      const tFol = tData?.followers || {};
      const isF = Array.isArray(tFol) ? tFol.includes(auth.currentUser.uid) : !!tFol[auth.currentUser.uid];
      const btn = document.getElementById('btnFollow');
      btn.style.display = (isF || songs[i].uid === auth.currentUser.uid) ? 'none' : 'flex';
    }
    function toggleFavorite() {
      if (!songs[i]) return;
      const url = songs[i].url;
      const btn = document.getElementById('btnFav');
      if (fav.includes(url)) { fav = fav.filter(u => u !== url); showToast('Dihapus dari Favorit'); btn.classList.remove('active'); btn.innerHTML = '<i class="far fa-heart"></i>'; }
      else { fav.push(url); showToast('❤️ Ditambahkan ke Favorit'); btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-heart"></i>'; }
      localStorage.setItem('exeFav', JSON.stringify(fav));
      if (document.getElementById('modalList').style.display === 'block') openList(false);
    }
    function updateFavoriteUI() {
      if (!songs[i]) return;
      const btn = document.getElementById('btnFav');
      if (fav.includes(songs[i].url)) { btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-heart"></i>'; }
      else { btn.classList.remove('active'); btn.innerHTML = '<i class="far fa-heart"></i>'; }
    }

    // ============================================================
    // SHUFFLE / REPEAT
    // ============================================================
    function toggleShuffle() {
      isShuf = !isShuf; localStorage.setItem('exeShuffle', isShuf);
      document.getElementById('shuf').classList.toggle('active-btn', isShuf);
      showToast(isShuf ? '🔀 Shuffle Aktif' : 'Shuffle Non-aktif');
    }
    function toggleRepeat() {
      repeatMode = (repeatMode + 1) % 3; localStorage.setItem('exeRepeat', repeatMode);
      const btn = document.getElementById('rep');
      btn.classList.remove('active-btn');
      btn.style.position = 'relative';
      if (repeatMode === 0) { btn.innerHTML = '<i class="fas fa-redo"></i>'; showToast('Repeat OFF'); }
      else if (repeatMode === 1) { btn.classList.add('active-btn'); btn.innerHTML = '<i class="fas fa-redo"></i><span style="font-size:7px;position:absolute;top:7px;right:5px;font-weight:bold;color:var(--bg)">1</span>'; showToast('🔁 Repeat: One'); }
      else { btn.classList.add('active-btn'); btn.innerHTML = '<i class="fas fa-redo"></i>'; showToast('🔁 Repeat: All'); }
    }

    // ============================================================
    // SONG LIST
    // ============================================================
    function openList(f) {
      const c = document.getElementById('songContainer');
      const l = f ? songs.filter(s => fav.includes(s.url)) : songs;
      const html = l.map(s => `<div class="song-item" onclick="setup(${songs.indexOf(s)}); closeModal()">
        <div style="flex:1"><b>${escapeHtml(s.title)}</b><br><small class="artist" data-uid="${s.uid}" style="color:#555">@${escapeHtml(s.by || '')}</small></div>
        <span onclick="toggleFav('${s.url}', event)" style="color:${fav.includes(s.url) ? 'var(--tiktok-red)' : '#333'}"><i class="fas fa-heart"></i></span>
      </div>`).join('');
      c.innerHTML = html;
      document.getElementById('modalList').style.display = 'block';
    }
    function toggleFav(u, e) {
      e.stopPropagation();
      if (fav.includes(u)) { fav = fav.filter(x => x !== u); showToast('Dihapus dari Favorit'); }
      else { fav.push(u); showToast('❤️ Ditambahkan ke Favorit'); }
      localStorage.setItem('exeFav', JSON.stringify(fav));
      openList(false);
      if (songs[i] && songs[i].url === u) updateFavoriteUI();
    }

    // ============================================================
    // PROFILE
    // ============================================================
    function openProfile() {
      if (!auth.currentUser) { document.getElementById('modalAuth').style.display = 'block'; return; }
      currentProfileUid = auth.currentUser.uid;
      const myPosts = songs.filter(s => s.uid === auth.currentUser.uid).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      document.getElementById('myPostList').innerHTML = myPosts.map(s =>
        `<div class="mp-song-item" onclick="setup(${songs.indexOf(s)}); closeModal()"><div class="mp-song-icon"><i class="fas fa-music"></i></div><div class="mp-song-info"><div class="mp-song-title">${escapeHtml(s.title)}</div></div><i class="fas fa-play" style="font-size:10px; color:#444"></i></div>`
      ).join('');
      const myLikes = songs.filter(s => fav.includes(s.url));
      document.getElementById('myLikeList').innerHTML = myLikes.map(s =>
        `<div class="mp-song-item" onclick="setup(${songs.indexOf(s)}); closeModal()"><div class="mp-song-icon" style="color:var(--tiktok-red)"><i class="fas fa-heart"></i></div><div class="mp-song-info"><div class="mp-song-title">${escapeHtml(s.title)}</div><div class="mp-song-artist">@${escapeHtml(s.by)}</div></div></div>`
      ).join('');
      switchProfileTab('posts');
      const myTagLower = (userData && userData.tag ? userData.tag.toLowerCase() : '');
      if (myTagLower.includes('velly')) startHearts();
      else stopHearts();
      if (!audio.paused) {
        audio.pause();
        document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>';
        document.getElementById('eq').classList.remove('playing');
      }
      if (userData && userData.profilemusic) playProfileMusic(userData.profilemusic);
      else stopProfileMusic();
      document.getElementById('modalProfile').style.display = 'block';
      applyProfileUrl(true);
    }
    function switchProfileTab(tab) {
      document.querySelectorAll('.mp-tab').forEach(t => t.classList.remove('active'));
      document.getElementById('myPostList').style.display = 'none';
      document.getElementById('myLikeList').style.display = 'none';
      if (tab === 'posts') { document.getElementById('tabPosts').classList.add('active'); document.getElementById('myPostList').style.display = 'flex'; }
      else { document.getElementById('tabLikes').classList.add('active'); document.getElementById('myLikeList').style.display = 'flex'; }
    }

    async function viewCreator() {
      const s = songs[i]; if (!s.uid) return;
      if (auth.currentUser && s.uid === auth.currentUser.uid) { openProfile(); return; }
      openCreatorByUid(s.uid);
    }
    async function openCreatorByUid(uid) {
      const cRef = await db.ref('users/' + uid).get();
      const cData = cRef.val();
      const now = Date.now();
      const fcr = (() => { const f = cData?.followers; return Array.isArray(f) ? f.length : (f && typeof f === 'object' ? Object.keys(f).length : f || 0); })();
      const flgr = (() => { const f = cData?.following; return Array.isArray(f) ? f.length : (f && typeof f === 'object' ? Object.keys(f).length : f || 0); })();
      document.getElementById('vAvatarImg').src = cData?.avatar || 'https://via.placeholder.com/150';
      const creatorVip = getVipStatus(cData);
      document.getElementById('vName').innerHTML = '@' + (cData?.username || uid) + (fcr >= 50 ? '<i class="fas fa-check-circle v-badge" style="font-size:13px;margin-left:4px"></i>' : '') + (creatorVip ? ' <i class="fas fa-crown" style="color:#ffd700;font-size:13px;margin-left:4px"></i>' : '');
      document.getElementById('vFol').innerText = fcr;
      document.getElementById('vFollowing').innerText = flgr;
      document.getElementById('vTagDisplay').innerHTML = getTagHTML(cData?.tag);

      // Apply vip/pink header to creator modal
      const creatorHeader = document.querySelector('#modalCreator .modern-profile-header');
      if (creatorHeader) {
        creatorHeader.classList.remove('vip', 'pink-profile');
        const cTagLower = (cData && cData.tag ? cData.tag.toLowerCase() : '');
        const isVellyCreator = cTagLower.includes('velly');
        if (isVellyCreator) {
          creatorHeader.classList.add('pink-profile');
          startHearts();
        } else {
          if (creatorVip) creatorHeader.classList.add('vip');
          stopHearts();
        }
      }

      if (cData && cData.profilemusic) playProfileMusic(cData.profilemusic);
      else {
        if (!audio.paused) {
          audio.pause();
          document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>';
          document.getElementById('eq').classList.remove('playing');
        }
        stopProfileMusic();
      }

      const creatorSongs = songs.filter(x => x.uid === uid).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      document.getElementById('creatorPostList').innerHTML = creatorSongs.map(x =>
        `<div class="mp-song-item" onclick="setup(${songs.indexOf(x)}); closeModal()"><div class="mp-song-icon"><i class="fas fa-music"></i></div><div class="mp-song-info"><div class="mp-song-title">${escapeHtml(x.title)}</div></div><i class="fas fa-play" style="font-size:10px; color:#444"></i></div>`
      ).join('');

      document.getElementById('modalCreator').dataset.creatorUid = uid;
      updateCreatorFollowUI(uid);
      document.getElementById('modalCreator').style.display = 'block';
      currentProfileUid = uid;
      applyProfileUrl(true);
    }

    async function updateCreatorFollowUI(uid) {
      if (!auth.currentUser) return;
      const snap = await db.ref('users/' + uid + '/followers').get();
      const fol = snap.val() || {};
      const isF = Array.isArray(fol) ? fol.includes(auth.currentUser.uid) : !!fol[auth.currentUser.uid];
      const btn = document.getElementById('vCreatorFollowBtn');
      if (isF) { btn.innerText = 'Following ✓'; btn.style.background = 'rgba(255,255,255,0.1)'; btn.style.color = '#fff'; }
      else { btn.innerText = 'Follow'; btn.style.background = ''; btn.style.color = ''; }
    }

    async function followCreator() {
      if (!auth.currentUser) return msg('Login dulu!');
      const creatorUid = document.getElementById('modalCreator').dataset.creatorUid;
      if (!creatorUid || creatorUid === auth.currentUser.uid) return msg('Gak bisa follow diri sendiri');
      try {
        const [cSnap, mSnap] = await Promise.all([db.ref('users/' + creatorUid).get(), db.ref('users/' + auth.currentUser.uid).get()]);
        const cData = cSnap.val(), mData = mSnap.val();
        const fArr = Array.isArray(cData?.followers) ? [...cData.followers] : (cData?.followers && typeof cData.followers === 'object' ? Object.keys(cData.followers) : []);
        const flArr = Array.isArray(mData?.following) ? [...mData.following] : (mData?.following && typeof mData.following === 'object' ? Object.keys(mData.following) : []);
        const isF = fArr.includes(auth.currentUser.uid);
        if (isF) {
          await Promise.all([db.ref('users/' + creatorUid).update({ followers: fArr.filter(u => u !== auth.currentUser.uid) }), db.ref('users/' + auth.currentUser.uid).update({ following: flArr.filter(u => u !== creatorUid) })]);
          msg('Unfollowed!');
        } else {
          await Promise.all([db.ref('users/' + creatorUid).update({ followers: [...fArr, auth.currentUser.uid] }), db.ref('users/' + auth.currentUser.uid).update({ following: [...flArr, creatorUid] })]);
          db.ref('users/' + creatorUid + '/notifications').push({ type: 'follow', text: userData.username + ' mulai mengikuti kamu', fromName: userData.username, fromUid: auth.currentUser.uid, timestamp: Date.now() });
          msg('Followed! ✅');
        }
        const newFolCount = isF ? fArr.length - 1 : fArr.length + 1;
        const newFlCount = isF ? flArr.length - 1 : flArr.length + 1;
        syncUserQuestTags(creatorUid, cData || {}, newFolCount, (cData && cData.following) ? (Array.isArray(cData.following) ? cData.following.length : (typeof cData.following === 'object' ? Object.keys(cData.following).length : 0)) : 0);
        syncUserQuestTags(auth.currentUser.uid, mData || {}, (mData && mData.followers) ? (Array.isArray(mData.followers) ? mData.followers.length : (typeof mData.followers === 'object' ? Object.keys(mData.followers).length : 0)) : 0, newFlCount);
        await updateCreatorFollowUI(creatorUid);
      } catch (err) { msg('Error: ' + err.message); }
    }

    // ============================================================
    // SHARING / COPY
    // ============================================================
    function buildDeepLink() { return window.location.origin + window.location.pathname + '?id=' + i; }
    function openCopyLink() { document.getElementById('copyLinkText').textContent = buildDeepLink(); document.getElementById('modalCopyLink').style.display = 'block'; }
    function copyBuiltLink() { navigator.clipboard.writeText(document.getElementById('copyLinkText').textContent).then(() => showToast('Link disalin!')); document.getElementById('modalCopyLink').style.display = 'none'; }
    function shareToWhatsApp() { const txt = '🎵 ' + (songs[i]?.title || 'ExeMusic') + '\n🔗 ' + buildDeepLink(); window.open('https://wa.me/?text=' + encodeURIComponent(txt)); }
    function copyRawUrl() { document.getElementById('copyAudioText').textContent = songs[i]?.url || ''; document.getElementById('modalCopyAudio').style.display = 'block'; }
    function copyBuiltAudio() { const t = document.getElementById('copyAudioText').textContent; if (!t) return; navigator.clipboard.writeText(t).then(() => showToast('URL audio disalin')); document.getElementById('modalCopyAudio').style.display = 'none'; }
    function downloadSong() { window.open(songs[i].url); }
    function openReq() { document.getElementById('modalReq').style.display = 'block'; }
    function openAbout() { document.getElementById('modalAbout').style.display = 'block'; }
    function openBoomboxTutorial() { document.getElementById('modalBoombox').style.display = 'block'; }
    function openTutorial() { document.getElementById('tutorialOverlay').style.display = 'flex'; }
    function closeTutorial() { const o = document.getElementById('tutorialOverlay'); o.style.display = 'none'; const v = document.getElementById('tutorialVideo'); if (v) { const src = v.src; v.src = src; } }
    function sendWA() { window.open('https://wa.me/62895329018240?text=Halo Admin, saya ' + document.getElementById('guestName').value + ' ingin upload: ' + document.getElementById('guestLagu').value); }
    function shareProfile(uid, username) { if (!uid) return; navigator.clipboard.writeText(window.location.origin + window.location.pathname + '?profile_userid=' + uid); showToast('Link profil @' + (username || 'user') + ' disalin'); }
    function closeProfileModal() {
      const modal = document.getElementById('modalProfile');
      if (modal) modal.style.display = 'none';
      stopHearts();
      stopProfileMusic();
      currentProfileUid = null;
      applyProfileUrl(true);
    }
    function closeCreatorModal() {
      const modal = document.getElementById('modalCreator');
      if (modal) modal.style.display = 'none';
      stopHearts();
      stopProfileMusic();
      currentProfileUid = null;
      applyProfileUrl(true);
    }
    function openTagSelector() {
      if (!auth.currentUser || !userData) { msg('Login dulu!'); return; }
      ensureCurrentTagInAlltag(auth.currentUser.uid, userData);
      const all = userData.alltag || {};
      const keys = Object.keys(all).filter(k => all[k]);
      if (!keys.length) { msg('Belum ada tag yang kebuka'); return; }
      const modal = document.getElementById('modalTagSelector');
      const curEl = document.getElementById('tagSelectorCurrent');
      const grid = document.getElementById('tagSelectorChipGrid');
      const info = document.getElementById('tagSelectorAllInfo');
      if (!modal || !curEl || !grid || !info) return;
      const cur = (userData.tag || 'none').toLowerCase();
      curEl.innerHTML = cur === 'none' ? 'Tanpa tag aktif' : 'Tag aktif: ' + getTagHTML(cur);
      const chips = keys.map(k => {
        const meta = TAG_META[k] || { title: k.toUpperCase() };
        return `<button class="tag-chip" data-tag="${k}"><span class="user-tag tag-${k}">${meta.title}</span></button>`;
      }).join('') + `<button class="tag-chip tag-chip-none" data-tag="none">TANPA TAG</button>`;
      grid.innerHTML = chips;
      if (!grid.dataset.bound) {
        grid.dataset.bound = '1';
        grid.addEventListener('click', function(e) {
          const btn = e.target.closest('.tag-chip');
          if (!btn) return;
          const tag = btn.dataset.tag;
          const uid = auth.currentUser && auth.currentUser.uid;
          if (!uid || !userData) return;
          const updates = {};
          updates['users/' + uid + '/tag'] = tag === 'none' ? 'none' : tag;
          if (tag !== 'none') {
            updates['users/' + uid + '/alltag/' + tag] = true;
          }
          db.ref().update(updates).then(() => {
            document.getElementById('modalTagSelector').style.display = 'none';
            showToast('Tag diganti');
          });
        });
      }
      if (!info.dataset.filled) {
        const rows = Object.keys(TAG_META).map(k => {
          const m = TAG_META[k];
          return `<div class="tag-meta-row">
            <div><span class="user-tag tag-${k}">${m.title}</span></div>
            <div class="tag-meta-desc">${m.desc}</div>
          </div>`;
        }).join('');
        info.innerHTML = rows;
        info.dataset.filled = '1';
      }
      modal.style.display = 'block';
    }

    // ============================================================
    // NOTIFICATIONS - CLEAR
    // ============================================================
    function openClearNotifConfirm() { document.getElementById('modalClearNotif').style.display = 'block'; }
    function confirmClearNotif() {
      if (!auth.currentUser) return msg('Login dulu!');
      db.ref('users/' + auth.currentUser.uid + '/notifications').remove().then(() => {
        document.getElementById('modalClearNotif').style.display = 'none';
        mergeAndRenderNotifs([], 'user'); updateNotifBadge();
        showToast('Notifikasi dibersihkan');
      }).catch(() => showToast('Gagal menghapus notifikasi'));
    }

    // ============================================================
    // CHANGE NAME / PASSWORD
    // ============================================================
    function openChangeNameModal() {
      document.getElementById('cnMsg').innerText = ''; document.getElementById('cnMsg').classList.remove('show', 'success', 'error');
      document.getElementById('cnPass').value = ''; document.getElementById('cnNewName').value = '';
      document.getElementById('modalChangeNames').style.display = 'block';
    }
    async function handleChangeName() {
      const password = document.getElementById('cnPass').value;
      const newName = document.getElementById('cnNewName').value;
      const msgEl = document.getElementById('cnMsg');
      msgEl.classList.remove('success', 'error');
      if (!newName || !password) { msgEl.innerText = '⚠️ Isi semua field!'; msgEl.classList.add('show', 'error'); return; }
      if (newName.length < 3) { msgEl.innerText = '⚠️ Nama minimal 3 karakter!'; msgEl.classList.add('show', 'error'); return; }
      const lastChange = userData.lastNameChange || 0;
      const diffDays = (Date.now() - lastChange) / (1000 * 60 * 60 * 24);
      if (diffDays < 7) { msgEl.innerText = `⏳ Tunggu ${Math.ceil(7 - diffDays)} hari lagi!`; msgEl.classList.add('show', 'error'); return; }
      const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, password);
      try {
        await auth.currentUser.reauthenticateWithCredential(credential);
        await db.ref('users/' + auth.currentUser.uid).update({ username: newName, lastNameChange: Date.now() });
        msgEl.innerText = '✅ Nama berhasil diubah!'; msgEl.classList.add('show', 'success');
        setTimeout(() => { document.getElementById('modalChangeNames').style.display = 'none'; msg('Nama pengguna diperbarui!'); }, 1500);
      } catch { msgEl.innerText = '❌ Password salah!'; msgEl.classList.add('show', 'error'); }
    }
    function openChangePasswordModal() {
      document.getElementById('cpMsg').innerText = ''; document.getElementById('cpMsg').classList.remove('show', 'success', 'error');
      ['cpOldPass', 'cpNewPass', 'cpConfirm'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('modalChangePass').style.display = 'block';
    }
    function toggleProfileMusicInput() {
      const row = document.getElementById('profileMusicRow');
      if (!row) return;
      row.style.display = row.style.display === 'none' || row.style.display === '' ? 'block' : 'none';
    }
    function saveProfileMusic() {
      if (!auth.currentUser || !userData) return msg('Login dulu!');
      const vipType = getVipStatus(userData);
      if (!vipType) return msg('Fitur ini khusus VIP / VIP Trial');
      const inp = document.getElementById('profileMusicUrl');
      if (!inp) return;
      const url = inp.value.trim();
      db.ref('users/' + auth.currentUser.uid).update({ profilemusic: url || null }).then(() => {
        userData.profilemusic = url || null;
        msg('Music profil disimpan');
      }).catch(() => msg('Gagal menyimpan music profil'));
    }
    async function handleChangePassword() {
      const oldPass = document.getElementById('cpOldPass').value;
      const newPass = document.getElementById('cpNewPass').value;
      const confirm = document.getElementById('cpConfirm').value;
      const msgEl = document.getElementById('cpMsg');
      msgEl.classList.remove('success', 'error');
      if (!oldPass || !newPass || !confirm) { msgEl.innerText = '⚠️ Isi semua field!'; msgEl.classList.add('show', 'error'); return; }
      if (newPass.length < 6) { msgEl.innerText = '⚠️ Password min 6 karakter!'; msgEl.classList.add('show', 'error'); return; }
      if (newPass !== confirm) { msgEl.innerText = '⚠️ Password tidak cocok!'; msgEl.classList.add('show', 'error'); return; }
      const lastChange = userData.lastPasswordChange || 0;
      const diffDays = (Date.now() - lastChange) / (1000 * 60 * 60 * 24);
      if (diffDays < 7) { msgEl.innerText = `⏳ Tunggu ${Math.ceil(7 - diffDays)} hari lagi!`; msgEl.classList.add('show', 'error'); return; }
      const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, oldPass);
      try {
        await auth.currentUser.reauthenticateWithCredential(credential);
        await auth.currentUser.updatePassword(newPass);
        await db.ref('users/' + auth.currentUser.uid).update({ lastPasswordChange: Date.now() });
        msgEl.innerText = '✅ Password berhasil diubah!'; msgEl.classList.add('show', 'success');
        setTimeout(() => { document.getElementById('modalChangePass').style.display = 'none'; msg('Password diperbarui!'); }, 1500);
      } catch { msgEl.innerText = '❌ Password lama salah!'; msgEl.classList.add('show', 'error'); }
    }

    // ============================================================
    // GOOGLE AUTH
    // ============================================================
    function handleGoogleAuth() {
      if (isFirstTimeUser) {
        const username = document.getElementById('authUser').value.trim();
        if (!username || username.length < 3) { msg('❌ Username minimal 3 karakter!'); return; }
        const user = auth.currentUser;
        if (!user) { msg('❌ Session expired'); isFirstTimeUser = false; document.getElementById('usernameSection').style.display = 'none'; document.getElementById('googleBtnText').innerText = 'Masuk dengan Google'; return; }
        db.ref('users/' + user.uid).set({ username, email: user.email, avatar: user.photoURL || 'https://via.placeholder.com/150', role: 'user', followers: {}, following: {}, tag: 'user', createdAt: Date.now() })
          .then(() => { isFirstTimeUser = false; document.getElementById('usernameSection').style.display = 'none'; document.getElementById('googleBtnText').innerText = 'Masuk dengan Google'; closeModal(); msg('✅ Selamat datang ' + username + '!'); })
          .catch(err => msg('❌ Gagal: ' + err.message));
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        auth.signInWithPopup(provider).then(result => {
          const isNew = result.additionalUserInfo.isNewUser;
          if (isNew) { isFirstTimeUser = true; document.getElementById('googleBtnText').innerText = 'Buat Akun'; document.getElementById('usernameSection').style.display = 'block'; msg('👋 Buat username Anda!'); }
          else { closeModal(); msg('✅ Selamat datang kembali!'); }
        }).catch(err => {
          if (err.code === 'auth/popup-closed-by-user') msg('⚠️ Login dibatalkan');
          else if (err.code !== 'auth/cancelled-popup-request') msg('❌ Gagal login: ' + err.message);
        });
      }
    }

    function uploadAvatar(input) {
      const file = input.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => { db.ref('users/' + auth.currentUser.uid).update({ avatar: e.target.result }).then(() => msg('Foto profil diperbarui!')); };
      reader.readAsDataURL(file);
    }

    // ============================================================
    // ADMIN PANEL - LOCK GATE + CAPTCHA
    // ============================================================
    let algSecret = '';
    let adMtState = false;

    async function openAdminPanel() {
      if (!auth.currentUser || !userData || (userData.role !== 'admin' && userData.role !== 'owner')) {
        msg('Khusus admin');
        return;
      }
      const uid = auth.currentUser.uid;
      const snap = await db.ref('users/' + uid + '/pwadmin').get();
      let pw = snap.val();
      if (!pw) {
        const resSet = await Swal.fire({
          title: 'Set Admin Password',
          input: 'password',
          inputPlaceholder: 'Password admin baru',
          confirmButtonText: 'Simpan',
          showCancelButton: true,
          background: '#0d0d15',
          color: '#fff'
        });
        if (!resSet.value) return;
        pw = resSet.value;
        await db.ref('users/' + uid).update({ pwadmin: pw });
        showToast('Password admin disimpan');
      } else {
        const res = await Swal.fire({
          title: 'Admin Password',
          input: 'password',
          inputPlaceholder: 'Masukkan password admin',
          confirmButtonText: 'Masuk',
          showCancelButton: true,
          background: '#0d0d15',
          color: '#fff'
        });
        if (!res.value || res.value !== pw) {
          msg('Password admin salah');
          return;
        }
      }
      const overlay = document.getElementById('adminPanelOverlay');
      const inner = document.getElementById('adminPanelInner');
      overlay.classList.add('show');
      inner.style.display = 'flex';
      adLoadData();
    }

    function algGenCaptcha() {
      const canvas = document.getElementById('algCapCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      canvas.width = 290; canvas.height = 80;

      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      algSecret = '';
      for (let c = 0; c < 5; c++) algSecret += chars[Math.floor(Math.random() * chars.length)];

      // bg
      ctx.fillStyle = '#020d15';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // grid lines
      ctx.strokeStyle = 'rgba(0,212,255,0.08)'; ctx.lineWidth = 1;
      for (let x = 0; x < canvas.width; x += 25) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
      for (let y = 0; y < canvas.height; y += 20) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }

      // noise dots
      for (let n = 0; n < 40; n++) {
        ctx.fillStyle = `rgba(0,255,136,${Math.random()*0.25})`;
        ctx.beginPath(); ctx.arc(Math.random()*canvas.width, Math.random()*canvas.height, Math.random()*2, 0, Math.PI*2);
        ctx.fill();
      }

      // noise lines
      for (let l = 0; l < 4; l++) {
        ctx.strokeStyle = `rgba(${Math.random()>0.5?'0,255,136':'0,212,255'},${Math.random()*0.3+0.1})`;
        ctx.lineWidth = 1; ctx.beginPath();
        ctx.moveTo(Math.random()*canvas.width, Math.random()*canvas.height);
        ctx.lineTo(Math.random()*canvas.width, Math.random()*canvas.height);
        ctx.stroke();
      }

      // each character
      const colors = ['#00ff88','#00d4ff','#ffd700','#ffffff','#a0f0c0'];
      for (let c = 0; c < 5; c++) {
        ctx.save();
        const x = 28 + c * 50;
        const y = 42 + (Math.random() * 16 - 8);
        ctx.translate(x, y);
        ctx.rotate((Math.random() - 0.5) * 0.45);
        ctx.font = `bold ${34 + Math.random()*10}px 'Courier New', monospace`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.shadowColor = colors[c % colors.length];
        ctx.shadowBlur = 12;
        ctx.fillStyle = colors[c % colors.length];
        ctx.fillText(algSecret[c], 0, 0);
        ctx.restore();
      }

      // update fallback display
      const disp = document.getElementById('algCodeDisplay');
      if (disp) disp.textContent = algSecret;
    }

    function algVerify() {
      const inner = document.getElementById('adminPanelInner');
      if (!inner) return;
      inner.style.display = 'flex';
      adLoadData();
    }

    function closeAdminPanel() {
      const overlay = document.getElementById('adminPanelOverlay');
      const inner = document.getElementById('adminPanelInner');
      if (!overlay || !inner) return;
      overlay.classList.remove('show');
      inner.style.display = 'none';
      adminMode = 'normal';
      inner.classList.remove('admin-full', 'admin-mini');
      overlay.classList.remove('admin-overlay-mini');
      inner.style.position = '';
      inner.style.top = '';
      inner.style.left = '';
      inner.style.right = '';
      inner.style.bottom = '';
    }

    function startAdminDrag(e) {
      const panel = document.getElementById('adminPanelInner');
      if (!panel || adminMode === 'full') return;
      if (e.target.closest('button')) return;
      adminDrag.active = true;
      const rect = panel.getBoundingClientRect();
      adminDrag.offsetX = e.clientX - rect.left;
      adminDrag.offsetY = e.clientY - rect.top;
      document.addEventListener('mousemove', onAdminDrag);
      document.addEventListener('mouseup', stopAdminDrag);
    }
    function onAdminDrag(e) {
      if (!adminDrag.active) return;
      const panel = document.getElementById('adminPanelInner');
      if (!panel) return;
      panel.style.position = 'fixed';
      panel.style.top = (e.clientY - adminDrag.offsetY) + 'px';
      panel.style.left = (e.clientX - adminDrag.offsetX) + 'px';
      panel.style.right = 'auto';
      panel.style.bottom = 'auto';
    }
    function stopAdminDrag() {
      adminDrag.active = false;
      document.removeEventListener('mousemove', onAdminDrag);
      document.removeEventListener('mouseup', stopAdminDrag);
    }
    function toggleAdminSize(mode) {
      const overlay = document.getElementById('adminPanelOverlay');
      const panel = document.getElementById('adminPanelInner');
      if (!overlay || !panel) return;
      if (mode === 'full') {
        adminMode = adminMode === 'full' ? 'normal' : 'full';
      } else if (mode === 'mini') {
        adminMode = adminMode === 'mini' ? 'normal' : 'mini';
      }
      panel.classList.remove('admin-full', 'admin-mini');
      overlay.classList.remove('admin-overlay-mini');
      if (adminMode === 'full') {
        panel.classList.add('admin-full');
        panel.style.position = '';
        panel.style.top = '';
        panel.style.left = '';
      } else if (adminMode === 'mini') {
        panel.classList.add('admin-mini');
        overlay.classList.add('admin-overlay-mini');
        panel.style.position = '';
        panel.style.top = '';
        panel.style.left = '';
      } else {
        panel.style.position = '';
        panel.style.top = '';
        panel.style.left = '';
      }
    }

    function switchAdminView(id, btn) {
      document.querySelectorAll('.admin-view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('adv-' + id).classList.add('active');
      btn.classList.add('active');
      if (id === 'songs') renderAdminSongs();
      if (id === 'dash') {
        document.getElementById('adCountS').innerText = songs.length;
        db.ref('users').once('value').then(s => { document.getElementById('adCountU').innerText = s.numChildren(); });
      }
    }

    const TAG_META = {
      user: { title: 'USER', desc: 'Tag default semua user' },
      newbie: { title: 'NEWBIE', desc: '10+ followers' },
      pro: { title: 'PRO', desc: '50+ followers' },
      terkeren: { title: 'TERKEREN', desc: '150+ followers, special' },
      tersulit: { title: 'TERSULIT', desc: '150+ followers, special' },
      vip: { title: 'VIP', desc: 'Pernah VIP atau trial' },
      vvip: { title: 'VVIP', desc: 'Tag spesial sangat langka' },
      legend: { title: 'LEGEND', desc: 'Creator legend pilihan admin' },
      mythic: { title: 'MYTHIC', desc: 'Tag event eksklusif' },
      godlike: { title: 'GODLIKE', desc: 'Performa upload dan followers tinggi' },
      savage: { title: 'SAVAGE', desc: 'Aktif upload dan support creator lain' },
      ultra: { title: 'ULTRA', desc: 'Kombinasi event dan pencapaian' },
      velly: { title: 'VELLY', desc: 'Tag spesial owner' }
    };
    let adSelectedUserUid = null;

    function initAdminTagUI() {
      const info = document.getElementById('adAllTagInfo');
      if (info) {
        const rows = Object.keys(TAG_META).map(k => {
          const m = TAG_META[k];
          return `<div class="admin-tag-meta-row">
            <div><span class="user-tag tag-${k}">${m.title}</span></div>
            <div class="admin-tag-meta-desc">${m.desc}</div>
          </div>`;
        }).join('');
        info.innerHTML = rows;
      }
      const grid = document.getElementById('adTagChipGrid');
      if (grid && !grid.dataset.bound) {
        const chips = Object.keys(TAG_META).map(k => {
          const m = TAG_META[k];
          return `<button class="admin-tag-chip" data-tag="${k}"><span class="user-tag tag-${k}">${m.title}</span></button>`;
        }).join('');
        grid.innerHTML = chips;
        grid.dataset.bound = '1';
        grid.addEventListener('click', function(e) {
          const btn = e.target.closest('.admin-tag-chip');
          if (!btn) return;
          const tag = btn.dataset.tag;
          if (!adSelectedUserUid) return;
          adSetUserTag(adSelectedUserUid, tag);
        });
      }
    }

    function adSelectUser(uid) {
      const u = adAllUsers.find(x => x.uid === uid);
      const body = document.getElementById('adTagEditor');
      const empty = document.getElementById('adTagEditorEmpty');
      if (!u || !body || !empty) return;
      adSelectedUserUid = uid;
      empty.style.display = 'none';
      body.style.display = 'block';
      const nameEl = document.getElementById('adTagUserName');
      const curEl = document.getElementById('adTagCurrentDisplay');
      if (nameEl) nameEl.textContent = '@' + (u.username || uid);
      if (curEl) curEl.innerHTML = getTagHTML(u.tag);
    }

    function adLoadData() {
      if (adminLoaded) return;
      adminLoaded = true;
      db.ref('users').on('value', snap => {
        const data = snap.val() || {};
        adAllUsers = Object.keys(data).map(uid => ({ uid, ...data[uid] }));
        document.getElementById('adCountU').innerText = adAllUsers.length;
        adRenderUsers(adAllUsers);
        initAdminTagUI();
      });
      db.ref('songs').on('value', snap => {
        const data = snap.val() || {};
        adAllSongs = Object.keys(data).map(key => ({ key, ...data[key] }));
        document.getElementById('adCountS').innerText = adAllSongs.length;
      });
      // Logs - realtime
      db.ref('logs').limitToLast(50).on('value', snap => {
        const box = document.getElementById('adLogBox');
        if (!box) return;
        let h = '';
        snap.forEach(c => { const l = c.val(); h = `<div class="log-line"><span class="log-time">[${l.time}]</span> ${escapeHtml(l.msg)}</div>` + h; });
        box.innerHTML = h || '<div style="color:#333">No logs</div>';
      });
      db.ref('settings').on('value', s => {
        const sv = s.val() || {};
        adMtState = sv.mt || false;
        if (sv.announcement) document.getElementById('adBcInput').value = sv.announcement;
        const td = sv.tagDrop || null;
        const nameInp = document.getElementById('adTagDropName');
        const chInp = document.getElementById('adTagDropChance');
        const statusEl = document.getElementById('adTagDropStatus');
        if (nameInp && chInp && statusEl) {
          if (!td) {
            nameInp.value = '';
            chInp.value = '0';
            statusEl.textContent = 'Event OFF';
          } else {
            nameInp.value = td.tag || '';
            chInp.value = String(Math.round((td.chance || 0) * 100));
            statusEl.textContent = td.active ? 'Event aktif: ' + (td.tag || '') : 'Event OFF';
          }
        }
        currentTagDrop = td;
        setupTagDropWatcher();
      });
    }

    function adRenderUsers(users) {
      const box = document.getElementById('adUserList');
      if (!box) return;
      if (!users.length) { box.innerHTML = '<div style="text-align:center;padding:30px;color:#444">Tidak ada user</div>'; return; }
      box.innerHTML = users.map(u => {
        const folCount = Array.isArray(u.followers) ? u.followers.length : (u.followers && typeof u.followers === 'object' ? Object.keys(u.followers).length : u.followers || 0);
        const tagHtml = getTagHTML(u.tag);
        return `<div class="user-row-admin">
          <div class="ur-top">
            <div style="flex:1">
              <div class="ur-name" onclick="adSelectUser('${u.uid}')">${escapeHtml(u.username || 'Unknown')} ${tagHtml}</div>
              <div class="ur-uid">${u.uid}</div>
            </div>
          </div>
          <div class="ur-actions">
            <button class="admin-btn admin-btn-gold" onclick="adSelectUser('${u.uid}')" style="padding:6px 10px;font-size:11px">TAG</button>
            <button class="admin-btn admin-btn-blue" onclick="adOpenUserTools('${u.uid}','${escapeHtml(u.username||'')}')" style="padding:6px 10px;font-size:11px">TOOLS</button>
            <button class="admin-btn admin-btn-red" onclick="adToggleBan('${u.uid}', ${!!u.banned})" style="padding:6px 10px;font-size:11px">${u.banned ? 'UNBAN' : 'BAN'}</button>
          </div>
        </div>`;
      }).join('');
    }

    function adFilterUsers(q) {
      const filtered = adAllUsers.filter(u => (u.username || '').toLowerCase().includes(q.toLowerCase()) || u.uid.includes(q));
      adRenderUsers(filtered);
    }

    function renderAdminSongs() {
      if (adAllSongs.length > 0) { adRenderSongs(adAllSongs); return; }
      db.ref('songs').once('value').then(snap => {
        adAllSongs = [];
        snap.forEach(c => adAllSongs.push({ key: c.key, ...c.val() }));
        document.getElementById('adCountS').innerText = adAllSongs.length;
        adRenderSongs(adAllSongs);
      });
    }
    function adRenderSongs(list) {
      const box = document.getElementById('adSongList');
      if (!box) return;
      box.innerHTML = list.map(s => `<div class="admin-song-row">
        <div class="as-info"><div class="as-title">${escapeHtml(s.title)}</div><div class="as-by">@${escapeHtml(s.by || '')}</div></div>
        <button class="admin-btn admin-btn-red" onclick="adDelSong('${s.key}')" style="padding:6px 10px;font-size:11px"><i class="fas fa-trash"></i></button>
      </div>`).join('');
    }
    function adFilterSongs(q) {
      const filtered = adAllSongs.filter(s => s.title.toLowerCase().includes(q.toLowerCase()) || (s.by || '').toLowerCase().includes(q.toLowerCase()));
      adRenderSongs(filtered);
    }

    function adDelSong(id) {
      Swal.fire({ title: 'Hapus Lagu?', text: 'Permanen!', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ff3333', confirmButtonText: 'Hapus!', background: '#0d0d15', color: '#fff' })
        .then(r => { if (r.isConfirmed) { db.ref('songs/' + id).remove(); addLog('Deleted song: ' + id); showToast('Lagu dihapus'); } });
    }

    function adManualAdd() {
      const title = document.getElementById('adAddTitle').value;
      const url = document.getElementById('adAddUrl').value;
      if (!title || !url) { showToast('Isi judul dan URL!'); return; }
      db.ref('songs').push({ title, url, uid: 'ADMIN', by: 'ADMIN', timestamp: Date.now() })
        .then(() => { addLog('Admin upload: ' + title); showToast('✅ Lagu ditambahkan!'); document.getElementById('adAddTitle').value = ''; document.getElementById('adAddUrl').value = ''; });
    }

    function adSendBC() {
      const v = document.getElementById('adBcInput').value;
      if (!v) { showToast('Isi pesan dulu!'); return; }
      db.ref('settings').update({ announcement: v });
      addLog('Broadcast: ' + v);
      showToast('✅ Broadcast terkirim!');
    }
    function adClearBC() { db.ref('settings/announcement').remove(); showToast('Broadcast dihapus'); }
    function adSaveLebaran() {
      const d = document.getElementById('adLebaranDate').value;
      const t = document.getElementById('adLebaranTime').value || '00:00';
      if (!d) { showToast('Isi tanggal Lebaran dulu!'); return; }
      const partsD = d.split('-').map(Number);
      const partsT = t.split(':').map(Number);
      const year = partsD[0], month = (partsD[1] || 1) - 1, day = partsD[2] || 1;
      const hour = partsT[0] || 0, minute = partsT[1] || 0;
      const ts = new Date(year, month, day, hour, minute, 0).getTime();
      if (isNaN(ts)) { showToast('Tanggal tidak valid'); return; }
      db.ref('settings').update({ lebaranTs: ts }).then(() => {
        addLog('Set Lebaran TS: ' + ts);
        showToast('✅ Countdown Lebaran disimpan');
      });
    }
    function adClearLebaran() {
      db.ref('settings/lebaranTs').remove().then(() => {
        addLog('Clear Lebaran TS');
        showToast('Countdown Lebaran dimatikan');
        const lc = document.getElementById('lebaranCountdown');
        if (lc) lc.classList.remove('show', 'celebrate');
        if (lebaranInterval) { clearInterval(lebaranInterval); lebaranInterval = null; }
      });
    }
    function adToggleMT() {
      adMtState = !adMtState;
      db.ref('settings').update({ mt: adMtState });
      addLog('Maintenance: ' + adMtState);
      showToast('Maintenance: ' + (adMtState ? 'AKTIF' : 'OFF'));
    }
    function adOpenClearNotif() {
      if (!auth.currentUser) return msg('Login dulu!');
      db.ref('users/' + auth.currentUser.uid + '/notifications').remove().then(() => { mergeAndRenderNotifs([], 'user'); updateNotifBadge(); showToast('Notif dibersihkan'); });
    }
    function adClearLogs() { db.ref('logs').remove().then(() => showToast('Logs dihapus')); }

    function adSendFloatChat() {
      if (!auth.currentUser || !userData || (userData.role !== 'admin' && userData.role !== 'owner')) {
        showToast('Hanya admin/owner yang bisa kirim chat ini');
        return;
      }
      const inp = document.getElementById('adFloatMsg');
      if (!inp) return;
      const msg2 = inp.value.trim();
      if (!msg2) { showToast('Isi pesan dulu!'); return; }
      const now = Date.now();
      const data = {
        name: userData.username || 'Admin',
        msg: msg2,
        createdAt: now,
        expireAt: now + 15000
      };
      db.ref('adminFloatChat/current').set(data).then(() => {
        showToast('Chat admin dikirim');
        inp.value = '';
      });
    }

    function adSendNotif() {
      const type = document.getElementById('adNType').value;
      const target = document.getElementById('adNTarget').value.trim();
      const msg2 = document.getElementById('adNMsg').value.trim();
      if (!msg2) { showToast('Isi pesan dulu!'); return; }
      const payload = { type, text: msg2, fromName: 'Admin', timestamp: Date.now() };
      if (target) {
        db.ref('users/' + target + '/notifications')
          .push(payload)
          .then(() => showToast('✅ Notif terkirim ke ' + target));
      } else {
        db.ref('users').once('value').then(snap => {
          const users = snap.val() || {};
          const uids = Object.keys(users);
          if (!uids.length) return;
          const ops = uids.map(uid =>
            db.ref('users/' + uid + '/notifications').push(payload)
          );
          return Promise.all(ops);
        }).then(() => {
          addLog('Global notif: ' + msg2);
          showToast('✅ Global notif terkirim!');
          document.getElementById('adNMsg').value = '';
        });
      }
    }

    function adSetUserTag(uid, tag) {
      const updates = {};
      updates['users/' + uid + '/tag'] = tag || 'none';
      if (tag && tag !== 'none') {
        updates['users/' + uid + '/alltag/' + tag] = true;
      }
      db.ref().update(updates).then(() => {
        addLog('Tag: ' + uid + ' → ' + (tag || 'none'));
        showToast('Tag diubah!');
      });
    }

    function adSaveTagDrop() {
      const nameInp = document.getElementById('adTagDropName');
      const chInp = document.getElementById('adTagDropChance');
      if (!nameInp || !chInp) return;
      const tag = nameInp.value.trim().toLowerCase();
      let chance = parseFloat(chInp.value);
      if (!tag) {
        msg('Tag tidak boleh kosong');
        return;
      }
      if (isNaN(chance) || chance <= 0) chance = 0;
      if (chance > 100) chance = 100;
      const active = chance > 0;
      const now = Date.now();
      const endAt = active ? now + 30 * 60 * 1000 : 0;
      const data = {
        active,
        tag,
        chance: chance / 100,
        desc: 'Event tag drop dimulai oleh admin',
        startedBy: auth.currentUser ? (userData && userData.username) : 'Admin',
        startedAt: now,
        endAt,
        obtainedCount: 0
      };
      db.ref('settings/tagDrop').set(data).then(() => {
        showToast('Event tag drop diupdate');
        if (active) {
          const msg2 = `Event tag drop ${tag.toUpperCase()} has started by ${data.startedBy}`;
          const payload = { type: 'event', text: msg2, timestamp: now, fromName: data.startedBy };
          db.ref('globalNotifications').push(payload);
        }
      });
    }
    function adClearTagDrop() {
      db.ref('settings/tagDrop').remove().then(() => {
        const statusEl = document.getElementById('adTagDropStatus');
        if (statusEl) statusEl.textContent = 'Event OFF';
        showToast('Event tag drop dimatikan');
      });
    }
    function adPreviewTagDrop() {
      const chInp = document.getElementById('adTagDropChance');
      if (!chInp) return;
      const chance = parseFloat(chInp.value) || 0;
      msg('Simulasi chance sekitar ' + chance.toFixed(1) + '% per tick untuk user online');
    }

    function adOpenUserTools(uid, name) {
      const html = `
        <div style="text-align:left; display:flex; flex-direction:column; gap:14px">
          <p style="color:#888; font-size:12px; font-family:'JetBrains Mono',monospace">${uid}</p>
          <div>
            <div style="font-size:11px;color:#666;margin-bottom:6px;font-weight:700">VIP MANAGEMENT</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="swal2-confirm swal2-styled" style="background:#ffc107;color:#000;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adAddPermanentVip('${uid}')">+ VIP PERMANENT</button>
              <button class="swal2-confirm swal2-styled" style="background:#1976d2;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adAddTrialVip('${uid}')">+ VIP TRIAL</button>
              <button class="swal2-confirm swal2-styled" style="background:#c62828;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adRemoveVip('${uid}')">REMOVE VIP</button>
              <button class="swal2-confirm swal2-styled" style="background:#555;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adRemoveTrialVip('${uid}')">REMOVE TRIAL</button>
            </div>
          </div>
          <div>
            <div style="font-size:11px;color:#666;margin-bottom:6px;font-weight:700">FOLLOWERS</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="swal2-confirm swal2-styled" style="background:#2e7d32;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adFakeDelta('${uid}',1)">+1</button>
              <button class="swal2-confirm swal2-styled" style="background:#2e7d32;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adFakeDelta('${uid}',5)">+5</button>
              <button class="swal2-confirm swal2-styled" style="background:#2e7d32;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adFakeDelta('${uid}',10)">+10</button>
              <button class="swal2-confirm swal2-styled" style="background:#c62828;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adFakeDelta('${uid}',-1)">-1</button>
              <button class="swal2-confirm swal2-styled" style="background:#c62828;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adFakeDelta('${uid}',-5)">-5</button>
              <button class="swal2-confirm swal2-styled" style="background:#555;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adClearFake('${uid}')">CLEAR FAKE</button>
            </div>
          </div>
          <div>
            <div style="font-size:11px;color:#666;margin-bottom:6px;font-weight:700">LAINNYA</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="swal2-confirm swal2-styled" style="background:#388e3c;color:#fff;padding:8px 12px;font-size:12px;border:none;border-radius:8px;cursor:pointer" onclick="adResetCD('${uid}')">RESET COOLDOWN</button>
            </div>
          </div>
        </div>`;
      Swal.fire({ title: '⚙️ Tools: ' + name, html, background: '#0d0d15', color: '#fff', showConfirmButton: false, showCloseButton: true, width: '90%', maxWidth: '420px' });
    }

    function adAddPermanentVip(uid) {
      Swal.fire({ title: 'Tambah VIP Permanent?', icon: 'question', showCancelButton: true, confirmButtonColor: '#ffc107', background: '#0d0d15', color: '#fff' })
        .then(r => { if (r.isConfirmed) { db.ref('users/' + uid).update({ vip: true }).then(() => { addLog('Perm VIP: ' + uid); showToast('✅ VIP Permanent ditambahkan!'); adLoadData(); }); } });
    }

    function adAddTrialVip(uid) {
      Swal.fire({ title: 'VIP Trial (hari)', input: 'number', inputLabel: 'Berapa hari?', inputAttributes: { min: 1, max: 365 }, background: '#0d0d15', color: '#fff' })
        .then(r => {
          const d = parseInt(r.value, 10); if (!d || d <= 0) return;
          const expireAt = Date.now() + d * 24 * 60 * 60 * 1000;
          db.ref('users/' + uid + '/trialvip').set({ expireAt }).then(() => { addLog('TrialVIP ' + d + 'd: ' + uid); showToast('✅ VIP Trial ' + d + ' hari!'); adLoadData(); });
        });
    }

    function adRemoveVip(uid) {
      db.ref('users/' + uid).update({ vip: null }).then(() => { addLog('Remove VIP: ' + uid); showToast('VIP dihapus'); adLoadData(); });
    }

    function adRemoveTrialVip(uid) {
      db.ref('users/' + uid + '/trialvip').remove().then(() => { addLog('Remove TrialVIP: ' + uid); showToast('Trial VIP dihapus'); adLoadData(); });
    }

    function adFakeDelta(uid, delta) {
      db.ref('users/' + uid).once('value').then(s => {
        const u = s.val() || {};
        let fol = Array.isArray(u.followers) ? [...u.followers] : (u.followers && typeof u.followers === 'object' ? Object.keys(u.followers) : []);
        if (delta > 0) {
          for (let i = 0; i < delta; i++) fol.push('fake_' + Math.floor(Math.random() * 9999999));
        } else {
          let rem = Math.abs(delta);
          for (let i = fol.length - 1; i >= 0 && rem > 0; i--) {
            if (String(fol[i]).startsWith('fake_')) { fol.splice(i, 1); rem--; }
          }
        }
        db.ref('users/' + uid).update({ followers: fol }).then(() => { addLog('Followers delta ' + delta + ': ' + uid); showToast('Followers diubah ' + (delta > 0 ? '+' : '') + delta); adLoadData(); });
      });
    }

    function adClearFake(uid) {
      db.ref('users/' + uid).once('value').then(s => {
        const u = s.val() || {};
        let fol = Array.isArray(u.followers) ? [...u.followers] : (u.followers && typeof u.followers === 'object' ? Object.keys(u.followers) : []);
        fol = fol.filter(f => !String(f).startsWith('fake_'));
        db.ref('users/' + uid).update({ followers: fol }).then(() => { addLog('Clear fake fol: ' + uid); showToast('Fake followers dihapus'); adLoadData(); });
      });
    }

    function adResetCD(uid) { db.ref('users/' + uid + '/lastUpload').remove().then(() => { addLog('Reset CD: ' + uid); showToast('Cooldown direset!'); }); }
    function adToggleBan(uid, status) { db.ref('users/' + uid).update({ banned: !status }).then(() => { addLog((status ? 'Unban' : 'Ban') + ': ' + uid); showToast((status ? 'Unbanned' : 'Banned') + '!'); adLoadData(); }); }

    // VISUAL / DISCO
    let discoInterval = null;
    function adSetAccent(color) {
      if (!color || !color.startsWith('#')) { showToast('Format warna salah (gunakan #hex)'); return; }
      db.ref('settings').update({ accentColor: color });
      document.documentElement.style.setProperty('--accent', color);
      addLog('Accent color: ' + color);
      showToast('Warna accent diubah: ' + color);
    }

    function adStartDisco() {
      const variant = document.getElementById('adDiscoVariant').value;
      const color = document.getElementById('adDiscoColor').value || '#00ff88';
      db.ref('settings').update({ discoMode: true, discoVariant: variant, discoColor: color });
      applyDiscoMode(variant, color);
      addLog('Disco start: ' + variant);
      showToast('🎉 Disco Mode ON!');
    }
    function adStopDisco() {
      db.ref('settings').update({ discoMode: false });
      if (discoInterval) { clearInterval(discoInterval); discoInterval = null; }
      document.documentElement.style.setProperty('--accent', '#00ff88');
      addLog('Disco stop');
      showToast('Disco OFF');
    }
    function applyDiscoMode(variant, color) {
      const c = color || '#00ff88';
      if (discoInterval) { clearInterval(discoInterval); discoInterval = null; }
      if (variant === 'rainbow') {
        const cols = ['#00ff88','#00d4ff','#ff0050','#ffd700','#bf00ff','#ff69b4'];
        let ci = 0;
        discoInterval = setInterval(() => { document.documentElement.style.setProperty('--accent', cols[ci++ % cols.length]); }, 600);
      } else if (variant === 'heartbeat') {
        let tog = false;
        discoInterval = setInterval(() => { document.documentElement.style.setProperty('--accent', tog ? c : '#ffffff'); tog = !tog; }, 800);
      } else if (variant === 'ice') {
        document.documentElement.style.setProperty('--accent', '#00d4ff');
      } else {
        document.documentElement.style.setProperty('--accent', c);
      }
    }

    function openCopyUrlCard() {
      document.getElementById('adCopySongId').value = '';
      document.getElementById('adCopyUrlText').textContent = 'Ketik ID lagu dulu';
      document.getElementById('modalAdminCopyUrl').style.display = 'block';
    }
    function adUpdateDeepLink(v) {
      const base = window.location.origin + window.location.pathname;
      document.getElementById('adCopyUrlText').textContent = v ? base + '?id=' + encodeURIComponent(v) : base;
    }
    function adCopyDeepLink() {
      const t = document.getElementById('adCopyUrlText').textContent;
      if (!t || t === 'Ketik ID lagu dulu') { showToast('Isi ID dulu'); return; }
      navigator.clipboard.writeText(t).then(() => showToast('URL disalin!')); document.getElementById('modalAdminCopyUrl').style.display = 'none';
    }
  </script>
</body>
</html>
