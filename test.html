<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ExeMusic 3.1 - VIP Update</title>
  <link rel="icon" type="image/png" href="exemusicicon.png">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* CSS Root & Global tetap sama */
    :root {
      --accent: #00ff88; --text: #ffffff; --text-dim: #b3b3b3; --bg: #050505;
      --card-bg: #121212; --glass: rgba(255, 255, 255, 0.05); --danger: #ff3333;
      --warning: #ffcc00; --tiktok-red: #ff0050; --gold: #ffd700; --purple: #bf00ff;
    }

    /* --- THEME VARIATIONS (NEW) --- */
    body.theme-vip { --accent: var(--purple); }
    body.theme-admin { --accent: var(--gold); }

    /* --- PROFILE UI REBORN --- */
    .sheet { border-radius: 25px 25px 0 0; background: #111; }
    .profile-edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    
    .vip-card {
        background: linear-gradient(45deg, #1a1a1a, #222);
        border: 1px solid var(--glass); border-radius: 15px;
        padding: 15px; margin-top: 15px; position: relative; overflow: hidden;
    }
    .vip-card::after {
        content: 'VIP'; position: absolute; top: -10px; right: -10px;
        font-size: 40px; font-weight: 900; opacity: 0.05; transform: rotate(-20deg);
    }

    /* --- FOLLOW BUTTON ANIMATION --- */
    #btnFollow { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    #btnFollow.followed { transform: scale(0); opacity: 0; pointer-events: none; }

    /* (Gunakan CSS sisanya dari kode lama kamu agar tampilan tidak berubah drastis) */
    /* ... [Sisa CSS lamamu di sini] ... */
  </style>
</head>
<body id="mainBody">

  <script>
    // FIREBASE CONFIG (Tetap pakai milikmu)
    const firebaseConfig = { /* ... paste configmu ... */ };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // VARIABEL GLOBAL (isShuf sekarang FALSE default)
    let songs = [], i = 0, isShuf = false, isRepeat = false, isLoginMode = true;
    let userData = null;
    let userFavs = {}; // Sekarang pakai object untuk Firebase
    const audio = new Audio();

    // 1. MONITORING DATA USER & ROLE
    auth.onAuthStateChanged(u => {
      if(u) {
        // Sync Favorit dari Firebase
        db.ref(`users/${u.uid}/favorites`).on('value', s => { userFavs = s.val() || {}; });

        db.ref('users/' + u.uid).on('value', snap => {
          userData = snap.val();
          if(!userData) return;
          
          // Apply Theme Berdasarkan Role
          document.getElementById('mainBody').className = `theme-${userData.role || 'user'}`;
          
          // Update UI Profile
          document.getElementById('topLoginBtn').textContent = userData.username;
          if(userData.role === 'admin') document.getElementById('adminBtn').style.display = 'block';
        });
      }
    });

    // 2. LOGIKA NEXT/PREV SEKUENSIAL (Jika Shuffle OFF)
    function next() { 
        if(isShuf) {
            setup(Math.floor(Math.random() * songs.length));
        } else {
            let nextIdx = (i + 1) % songs.length;
            setup(nextIdx);
        }
    }

    // 3. FITUR FOLLOW ALA TIKTOK (Anti-Spam)
    async function followUser() {
      if(!auth.currentUser) return msg("Login dulu!");
      const targetUid = songs[i].uid;
      if(!targetUid || targetUid === auth.currentUser.uid) return msg("Gak bisa follow diri sendiri");

      const followPath = `follows/${targetUid}/${auth.currentUser.uid}`;
      const myFollowingPath = `users/${auth.currentUser.uid}/following_list/${targetUid}`;
      
      const snap = await db.ref(followPath).get();
      const btn = document.getElementById('btnFollow');

      if(snap.exists()) {
          // Unfollow
          await db.ref(followPath).remove();
          await db.ref(myFollowingPath).remove();
          db.ref(`users/${targetUid}/followers`).transaction(c => (c || 0) - 1);
          msg("Berhenti mengikuti");
      } else {
          // Follow
          await db.ref(followPath).set(true);
          await db.ref(myFollowingPath).set(true);
          db.ref(`users/${targetUid}/followers`).transaction(c => (c || 0) + 1);
          btn.innerHTML = '<i class="fas fa-check"></i>';
          btn.classList.add('followed');
          msg("Mengikuti!");
      }
    }

    // 4. FAVORIT DATABASE (Pindah dari LocalStorage)
    function toggleFav(songKey, e) {
      e.stopPropagation();
      if(!auth.currentUser) return msg("Login untuk simpan favorit!");
      
      const favRef = db.ref(`users/${auth.currentUser.uid}/favorites/${songKey}`);
      if(userFavs[songKey]) {
          favRef.remove();
      } else {
          favRef.set(true);
      }
    }

    // 5. UPDATE PROFILE & PASSWORD (7 Days Delay)
    async function updateAccount(type) {
        const now = Date.now();
        const lastChange = userData.lastNameChange || 0;
        const diffDays = (now - lastChange) / (1000 * 60 * 60 * 24);

        if(diffDays < 7 && userData.role === 'user') {
            return msg(`Tunggu ${Math.ceil(7 - diffDays)} hari lagi untuk ganti data.`);
        }

        if(type === 'username') {
            const newName = prompt("Masukkan Username Baru:");
            if(newName) {
                await db.ref(`users/${auth.currentUser.uid}`).update({ 
                    username: newName, 
                    lastNameChange: now 
                });
                msg("Username diganti!");
            }
        }
    }

    // 6. BYPASS COOLDOWN UNTUK VIP/ADMIN
    function saveMusic(t, u) {
        const isPrivileged = (userData.role === 'vip' || userData.role === 'admin');
        const lastUpload = userData.lastUpload || 0;
        const diff = (Date.now() - lastUpload) / 1000 / 60;

        if(!isPrivileged && diff < 30) {
            return msg("Tunggu cooldown 30 menit!");
        }

        const newSong = {
            title: t, url: u, uid: auth.currentUser.uid,
            by: userData.username, timestamp: Date.now()
        };
        
        db.ref('songs').push(newSong).then(() => {
            db.ref(`users/${auth.currentUser.uid}`).update({ lastUpload: Date.now() });
            msg("Berhasil diposting!");
            closeModal();
        });
    }

    // Perbaikan About/Logo Content
    function openAbout() {
        const aboutContent = `
            <div class="about-box">
                <h3>ExeMusic v3.1 Elite</h3>
                <p>Dapatkan <b>VIP</b> dan buka fitur menarik!</p>
                <div class="vip-card">
                    <small>Benefit VIP:</small><br>
                    • Tanpa Cooldown Upload (0m)<br>
                    • Durasi MP3 hingga 5 Jam<br>
                    • Akses Ganti Theme & Tag Eksklusif<br>
                    • Request Lagu Prioritas ke Hexky
                </div>
                <button onclick="closeModal()" class="btn-act">MENGERTI</button>
            </div>
        `;
        // Masukkan ke modal about
        document.querySelector('#modalAbout .sheet').innerHTML = aboutContent;
        document.getElementById('modalAbout').style.display = 'block';
    }

    // Sisa fungsi core (setup, play, toggle, dll) tetap menggunakan logikamu.
  </script>
</body>
</html>
