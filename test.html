<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ExeMusic v3.2 - Music Streaming Platform</title>
  <link rel="icon" type="image/png" href="exemusicicon.png">
  
  <!-- Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    
    :root {
      --primary: #1DB954;
      --bg-dark: #000000;
      --bg-card: #121212;
      --bg-hover: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --text-dim: #6a6a6a;
      --accent-gradient: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);
      --card-shadow: 0 8px 24px rgba(0,0,0,0.4);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* App Layout */
    .app-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-dark);
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      border-right: 1px solid rgba(255,255,255,0.05);
      transition: var(--transition);
      z-index: 100;
    }

    .logo {
      padding: 0 12px 32px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo img {
      height: 45px;
      cursor: pointer;
      transition: var(--transition);
    }

    .logo img:hover {
      transform: scale(1.05);
    }

    .nav-menu {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.1) transparent;
    }

    .nav-menu::-webkit-scrollbar {
      width: 6px;
    }

    .nav-menu::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 16px;
      margin-bottom: 4px;
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      font-size: 15px;
    }

    .nav-item i {
      font-size: 22px;
      width: 24px;
      text-align: center;
    }

    .nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--bg-hover);
      color: var(--primary);
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
    }

    /* Top Bar */
    .topbar {
      height: 70px;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 99;
    }

    .search-box {
      position: relative;
      width: 400px;
      max-width: 50%;
    }

    .search-box input {
      width: 100%;
      padding: 12px 20px 12px 45px;
      border-radius: 25px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: var(--text-primary);
      font-size: 14px;
      transition: var(--transition);
    }

    .search-box input:focus {
      background: rgba(255,255,255,0.15);
      outline: 2px solid var(--primary);
    }

    .search-box i {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .coin-display {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,215,0,0.1);
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      color: #ffd700;
      border: 1px solid rgba(255,215,0,0.3);
    }

    .btn-upgrade {
      background: var(--accent-gradient);
      color: #000;
      padding: 10px 24px;
      border-radius: 25px;
      border: none;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-upgrade:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(29,185,84,0.4);
    }

    .user-avatar-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.05);
      padding: 6px 12px 6px 6px;
      border-radius: 25px;
      cursor: pointer;
      transition: var(--transition);
    }

    .user-avatar-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
    }

    /* Content View */
    .content-view {
      flex: 1;
      overflow-y: auto;
      padding: 0 0 120px 0;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.1) transparent;
    }

    .content-view::-webkit-scrollbar {
      width: 8px;
    }

    .content-view::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
    }

    /* Hero Banner */
    .hero-banner {
      padding: 40px 32px;
      background: linear-gradient(180deg, rgba(29,185,84,0.3) 0%, transparent 100%);
      margin-bottom: 32px;
    }

    .hero-content {
      display: flex;
      align-items: flex-end;
      gap: 28px;
    }

    .hero-image {
      width: 240px;
      height: 240px;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: var(--card-shadow);
    }

    .hero-info h1 {
      font-size: 80px;
      font-weight: 900;
      margin: 12px 0;
      line-height: 1;
      letter-spacing: -3px;
    }

    .hero-info p {
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 600;
    }

    /* Sections */
    .section {
      padding: 0 32px;
      margin-bottom: 48px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h2 {
      font-size: 28px;
      font-weight: 800;
    }

    .see-all {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .see-all:hover {
      color: var(--text-primary);
    }

    /* Song Grid */
    .song-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 24px;
    }

    .song-card {
      background: var(--bg-card);
      padding: 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .song-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.6) 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .song-card:hover {
      background: var(--bg-hover);
      transform: translateY(-4px);
      box-shadow: var(--card-shadow);
    }

    .song-card:hover::before {
      opacity: 1;
    }

    .card-image-wrapper {
      position: relative;
      margin-bottom: 16px;
      overflow: hidden;
      border-radius: 8px;
    }

    .card-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }

    .play-button-overlay {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 48px;
      height: 48px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: translateY(8px);
      transition: var(--transition);
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
    }

    .song-card:hover .play-button-overlay {
      opacity: 1;
      transform: translateY(0);
    }

    .play-button-overlay i {
      color: #000;
      font-size: 18px;
      margin-left: 2px;
    }

    .card-title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-artist {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-stats {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-dim);
    }

    .card-stats span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Player Bar */
    .player-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 90px;
      background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.95) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      padding: 0 16px;
      z-index: 1000;
    }

    .player-left {
      flex: 0.3;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .now-playing-cover {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      object-fit: cover;
      cursor: pointer;
      transition: var(--transition);
    }

    .now-playing-cover:hover {
      transform: scale(1.05);
    }

    .now-playing-info {
      flex: 1;
    }

    .now-playing-info h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      cursor: pointer;
      transition: var(--transition);
    }

    .now-playing-info h4:hover {
      text-decoration: underline;
    }

    .now-playing-info p {
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .player-center {
      flex: 0.4;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .player-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .control-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      padding: 8px;
    }

    .control-btn:hover {
      color: var(--text-primary);
      transform: scale(1.1);
    }

    .play-pause-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--text-primary);
      color: #000;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .play-pause-btn:hover {
      transform: scale(1.08);
    }

    .progress-container {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .time-display {
      font-size: 11px;
      color: var(--text-secondary);
      min-width: 40px;
    }

    .progress-bar {
      flex: 1;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    .progress-filled {
      height: 100%;
      background: var(--text-primary);
      border-radius: 2px;
      position: relative;
    }

    .progress-filled::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: var(--text-primary);
      border-radius: 50%;
      opacity: 0;
      transition: var(--transition);
    }

    .progress-bar:hover .progress-filled::after {
      opacity: 1;
    }

    .player-right {
      flex: 0.3;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
    }

    .volume-container {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 120px;
    }

    .volume-slider {
      flex: 1;
      height: 4px;
      -webkit-appearance: none;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      outline: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: var(--text-primary);
      border-radius: 50%;
      cursor: pointer;
    }

    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 24px 48px rgba(0,0,0,0.6);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      font-size: 28px;
      font-weight: 800;
    }

    .close-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: rotate(90deg);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 14px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
      font-size: 14px;
      transition: var(--transition);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255,255,255,0.08);
    }

    .btn {
      padding: 14px 28px;
      border-radius: 25px;
      border: none;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent-gradient);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(29,185,84,0.4);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.15);
    }

    /* Announcement Banner */
    .announcement-banner {
      margin: 0 32px 32px;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(29,185,84,0.2) 0%, rgba(29,185,84,0.05) 100%);
      border-radius: 12px;
      border-left: 4px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .announcement-icon {
      font-size: 28px;
      color: var(--primary);
    }

    .announcement-content h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .announcement-content p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
    }

    .toast {
      background: rgba(0,0,0,0.95);
      color: var(--text-primary);
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      border-left: 4px solid var(--primary);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Admin Panel Overlay */
    .admin-overlay {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 350px;
      background: rgba(0,0,0,0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      display: none;
      z-index: 1500;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .admin-overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .admin-quick-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-box {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-box h4 {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
    }

    .stat-box p {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Profile Modal Tabs */
    .profile-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .profile-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 2px solid transparent;
    }

    .profile-tab.active {
      color: var(--text-primary);
      border-bottom-color: var(--primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -280px;
        height: 100vh;
        z-index: 1000;
      }

      .sidebar.open {
        left: 0;
      }

      .topbar {
        padding: 0 16px;
      }

      .search-box {
        width: 200px;
      }

      .coin-display {
        display: none;
      }

      .hero-content {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .hero-info h1 {
        font-size: 48px;
      }

      .section {
        padding: 0 16px;
      }

      .song-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .player-bar {
        height: 80px;
        padding: 0 12px;
      }

      .player-left {
        flex: 1;
      }

      .player-center {
        flex: 0;
        display: none;
      }

      .player-right {
        flex: 0;
      }

      .volume-container {
        display: none;
      }

      .admin-overlay {
        right: 10px;
        width: calc(100% - 20px);
      }
    }

    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Tags Display */
    .user-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .tag-badge {
      background: var(--accent-gradient);
      color: #000;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .tag-badge.custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    /* VIP Badge */
    .vip-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #000;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
    }

    /* Customer Service Categories */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .category-card {
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
    }

    .category-card:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--primary);
    }

    .category-card.selected {
      background: rgba(29,185,84,0.2);
      border-color: var(--primary);
    }

    .category-card i {
      font-size: 32px;
      margin-bottom: 8px;
      color: var(--primary);
    }

    .category-card p {
      font-size: 13px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- App Container -->
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="logo">
        <img src="exemusic.png" alt="ExeMusic" onerror="this.src='exemusicicon.png'">
      </div>

      <div class="nav-menu">
        <div class="nav-item active" onclick="switchPage('home')">
          <i class="fas fa-home"></i>
          <span>Beranda</span>
        </div>
        <div class="nav-item" onclick="switchPage('search')">
          <i class="fas fa-search"></i>
          <span>Cari</span>
        </div>
        <div class="nav-item" onclick="openUploadModal()">
          <i class="fas fa-upload"></i>
          <span>Upload Lagu</span>
        </div>
        <div class="nav-item" onclick="openProfileModal()">
          <i class="fas fa-user"></i>
          <span>Profil</span>
        </div>
        <div class="nav-item" onclick="openNotifModal()">
          <i class="fas fa-bell"></i>
          <span>Notifikasi</span>
        </div>
        <div class="nav-item" onclick="openEventModal()">
          <i class="fas fa-gift"></i>
          <span>Event</span>
        </div>
        <div class="nav-item" onclick="openCoinShopModal()">
          <i class="fas fa-coins"></i>
          <span>Coin Shop</span>
        </div>
        <div class="nav-item" onclick="openCustomerServiceModal()">
          <i class="fas fa-headset"></i>
          <span>Customer Service</span>
        </div>
        <div class="nav-item" onclick="openTutorial()">
          <i class="fas fa-question-circle"></i>
          <span>Tutorial</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Bar -->
      <div class="topbar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Cari lagu, artis, atau album..." oninput="handleSearch()">
        </div>

        <div class="user-section">
          <div class="coin-display" id="coinDisplay">
            <i class="fas fa-coins"></i>
            <span id="userCoins">0</span>
          </div>
          <button class="btn-upgrade" onclick="openVipModal()">Upgrade VIP</button>
          <div class="user-avatar-btn" onclick="openProfileModal()" id="userAvatarBtn">
            <img src="exemusicicon.png" alt="User" class="user-avatar" id="userAvatarImg">
            <span id="usernameDisplay">Guest</span>
          </div>
        </div>
      </div>

      <!-- Content View -->
      <div class="content-view" id="contentView">
        <!-- Hero Banner -->
        <div class="hero-banner" id="heroBanner">
          <div class="hero-content">
            <img src="exemusicicon.png" alt="Featured" class="hero-image" id="heroImage">
            <div class="hero-info">
              <p>PLAYLIST</p>
              <h1 id="heroTitle">Trending Now</h1>
              <p id="heroDesc">Lagu-lagu terpopuler minggu ini</p>
            </div>
          </div>
        </div>

        <!-- Announcement Banner -->
        <div class="announcement-banner" id="announcementBanner" style="display: none;">
          <i class="fas fa-bullhorn announcement-icon" id="announcementIcon"></i>
          <div class="announcement-content">
            <h3 id="announcementTitle">Pengumuman</h3>
            <p id="announcementMessage">Selamat datang di ExeMusic!</p>
          </div>
        </div>

        <!-- Trending Section -->
        <div class="section">
          <div class="section-header">
            <h2>Trending Hari Ini</h2>
            <span class="see-all" onclick="switchPage('search')">Lihat Semua</span>
          </div>
          <div class="song-grid" id="trendingGrid"></div>
        </div>

        <!-- Recommended Section -->
        <div class="section">
          <div class="section-header">
            <h2>Rekomendasi Untuk Anda</h2>
            <span class="see-all" onclick="switchPage('search')">Lihat Semua</span>
          </div>
          <div class="song-grid" id="recommendedGrid"></div>
        </div>

        <!-- Recent Uploads -->
        <div class="section">
          <div class="section-header">
            <h2>Baru Ditambahkan</h2>
            <span class="see-all" onclick="switchPage('search')">Lihat Semua</span>
          </div>
          <div class="song-grid" id="recentGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Player Bar -->
  <div class="player-bar">
    <div class="player-left">
      <img src="exemusicicon.png" alt="Cover" class="now-playing-cover" id="nowPlayingCover" onclick="openEQModal()">
      <div class="now-playing-info">
        <h4 id="nowPlayingTitle">Pilih Lagu</h4>
        <p id="nowPlayingArtist">-</p>
      </div>
      <button class="control-btn" id="likeBtn" onclick="toggleLike()">
        <i class="far fa-heart"></i>
      </button>
    </div>

    <div class="player-center">
      <div class="player-controls">
        <button class="control-btn" onclick="previousSong()">
          <i class="fas fa-step-backward"></i>
        </button>
        <button class="play-pause-btn control-btn" id="playPauseBtn" onclick="togglePlay()">
          <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" onclick="nextSong()">
          <i class="fas fa-step-forward"></i>
        </button>
        <button class="control-btn" id="repeatBtn" onclick="toggleRepeat()">
          <i class="fas fa-redo"></i>
        </button>
        <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()">
          <i class="fas fa-random"></i>
        </button>
      </div>

      <div class="progress-container">
        <span class="time-display" id="currentTime">0:00</span>
        <div class="progress-bar" id="progressBar" onclick="seekSong(event)">
          <div class="progress-filled" id="progressFilled"></div>
        </div>
        <span class="time-display" id="totalTime">0:00</span>
      </div>
    </div>

    <div class="player-right">
      <button class="control-btn" onclick="toggleQueue()">
        <i class="fas fa-list"></i>
      </button>
      <div class="volume-container">
        <button class="control-btn" onclick="toggleMute()">
          <i class="fas fa-volume-up" id="volumeIcon"></i>
        </button>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70" oninput="setVolume(this.value)">
      </div>
    </div>
  </div>

  <!-- Hidden Audio Element -->
  <audio id="audioPlayer" preload="metadata"></audio>


  <!-- Auth Modal -->
  <div class="modal" id="modalAuth">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Masuk / Daftar</h2>
        <button class="close-btn" onclick="closeModal('modalAuth')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" class="form-control" id="authEmail" placeholder="email@example.com">
      </div>

      <div class="form-group">
        <label>Password</label>
        <input type="password" class="form-control" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <div class="form-group">
        <label>Username (untuk daftar)</label>
        <input type="text" class="form-control" id="authUsername" placeholder="Username Anda">
      </div>

      <div style="display: flex; gap: 12px;">
        <button class="btn btn-primary" onclick="handleLogin()" style="flex: 1;">Masuk</button>
        <button class="btn btn-secondary" onclick="handleRegister()" style="flex: 1;">Daftar</button>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal" id="modalUpload">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Upload Lagu</h2>
        <button class="close-btn" onclick="closeModal('modalUpload')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="guestUploadSection" style="display: none;">
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          <i class="fas fa-info-circle"></i> Kamu belum login. Request lagu sebagai guest.
        </p>
        <div class="form-group">
          <label>Nama Kamu</label>
          <input type="text" class="form-control" id="guestName" placeholder="Nama Anda">
        </div>
      </div>

      <div class="form-group">
        <label>Judul Lagu *</label>
        <input type="text" class="form-control" id="uploadTitle" placeholder="Judul lagu">
      </div>

      <div class="form-group">
        <label>URL Lagu * <button class="btn btn-secondary" onclick="showURLTutorial()" style="padding: 4px 12px; margin-left: 8px; font-size: 12px;">Tutorial</button></label>
        <input type="text" class="form-control" id="uploadURL" placeholder="https://www.youtube.com/watch?v=...">
      </div>

      <div class="form-group">
        <label>Cover URL (opsional)</label>
        <input type="text" class="form-control" id="uploadCover" placeholder="https://...">
      </div>

      <button class="btn btn-primary" onclick="submitUpload()" style="width: 100%;">
        <i class="fas fa-upload"></i> Kirim Request
      </button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal" id="modalProfile">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Profil</h2>
        <button class="close-btn" onclick="closeModal('modalProfile')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div style="text-align: center; margin-bottom: 24px;">
        <img src="exemusicicon.png" alt="Avatar" id="profileAvatarImg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 16px;">
        <h3 id="profileUsername" style="font-size: 24px; font-weight: 800; margin-bottom: 8px;">Username</h3>
        <div class="user-tags" id="profileTags"></div>
        <div style="display: flex; justify-content: center; gap: 32px; margin-top: 16px;">
          <div>
            <h4 id="profileFollowers" style="font-size: 20px; font-weight: 800;">0</h4>
            <p style="color: var(--text-secondary); font-size: 13px;">Followers</p>
          </div>
          <div>
            <h4 id="profileFollowing" style="font-size: 20px; font-weight: 800;">0</h4>
            <p style="color: var(--text-secondary); font-size: 13px;">Following</p>
          </div>
        </div>
        <button class="btn btn-primary" id="followBtn" onclick="toggleFollow()" style="margin-top: 16px; display: none;">Follow</button>
        <button class="btn btn-secondary" id="editProfileBtn" onclick="openEditProfile()" style="margin-top: 16px; display: none;">Edit Profil</button>
      </div>

      <div class="profile-tabs">
        <button class="profile-tab active" onclick="switchProfileTab('posts')">Upload Saya</button>
        <button class="profile-tab" onclick="switchProfileTab('favorites')">Favorit</button>
      </div>

      <div class="song-grid" id="profileSongsGrid"></div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal" id="modalEditProfile">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Profil</h2>
        <button class="close-btn" onclick="closeModal('modalEditProfile')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="form-group">
        <label>Avatar URL</label>
        <input type="text" class="form-control" id="editAvatar" placeholder="https://...">
      </div>

      <div class="form-group" id="vipColorSection" style="display: none;">
        <label>Warna Profil (VIP Only) üåü</label>
        <input type="color" class="form-control" id="editProfileColor" value="#1DB954">
      </div>

      <div class="form-group">
        <label>Kelola Tags</label>
        <div id="tagsManager"></div>
        <button class="btn btn-secondary" onclick="openAddTagModal()" style="margin-top: 8px; width: 100%;">
          <i class="fas fa-plus"></i> Tambah Tag
        </button>
      </div>

      <button class="btn btn-primary" onclick="saveProfileChanges()" style="width: 100%;">
        <i class="fas fa-save"></i> Simpan Perubahan
      </button>
    </div>
  </div>

  <!-- Add Tag Modal -->
  <div class="modal" id="modalAddTag">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Tambah Tag</h2>
        <button class="close-btn" onclick="closeModal('modalAddTag')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <p style="color: var(--text-secondary); margin-bottom: 16px;">
        <i class="fas fa-info-circle"></i> Non-VIP: max 2 tags | VIP: max 5 tags
      </p>

      <div class="form-group">
        <label>Nama Tag</label>
        <input type="text" class="form-control" id="newTagName" placeholder="LEGEND" maxlength="20">
      </div>

      <button class="btn btn-primary" onclick="addNewTag()" style="width: 100%;">
        <i class="fas fa-plus"></i> Tambah Tag
      </button>
    </div>
  </div>

  <!-- VIP Modal -->
  <div class="modal" id="modalVIP">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üíé Upgrade VIP</h2>
        <button class="close-btn" onclick="closeModal('modalVIP')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div style="background: var(--accent-gradient); color: #000; padding: 24px; border-radius: 12px; text-align: center; margin-bottom: 24px;">
        <h3 style="font-size: 28px; font-weight: 900; margin-bottom: 8px;">VIP MEMBERSHIP</h3>
        <p style="font-size: 14px; font-weight: 600;">Dapatkan fitur eksklusif!</p>
      </div>

      <div style="margin-bottom: 24px;">
        <h4 style="margin-bottom: 12px; font-weight: 700;">Fitur VIP:</h4>
        <ul style="list-style: none; padding: 0;">
          <li style="padding: 8px 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Custom warna profil</span>
          </li>
          <li style="padding: 8px 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Maksimal 5 custom tags</span>
          </li>
          <li style="padding: 8px 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Badge VIP eksklusif</span>
          </li>
          <li style="padding: 8px 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Upload tanpa cooldown</span>
          </li>
          <li style="padding: 8px 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Event rewards x2</span>
          </li>
        </ul>
      </div>

      <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h4 style="margin-bottom: 12px; font-weight: 700;">Beli dengan Coin:</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button class="btn btn-secondary" onclick="buyVIPWithCoins(7)" style="flex-direction: column; padding: 16px;">
            <span style="font-size: 20px; font-weight: 800;">7 Hari</span>
            <span style="font-size: 14px; color: #ffd700;">500 Coins</span>
          </button>
          <button class="btn btn-secondary" onclick="buyVIPWithCoins(30)" style="flex-direction: column; padding: 16px;">
            <span style="font-size: 20px; font-weight: 800;">30 Hari</span>
            <span style="font-size: 14px; color: #ffd700;">1500 Coins</span>
          </button>
        </div>
      </div>

      <p style="text-align: center; color: var(--text-secondary); font-size: 12px;">
        VIP bersifat sementara dan akan expire sesuai durasi yang dibeli
      </p>
    </div>
  </div>

  <!-- Coin Shop Modal -->
  <div class="modal" id="modalCoinShop">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üí∞ Coin Shop</h2>
        <button class="close-btn" onclick="closeModal('modalCoinShop')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div style="background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); padding: 16px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Coin Kamu</p>
        <h3 style="font-size: 32px; font-weight: 900; color: #ffd700;" id="coinShopBalance">0</h3>
      </div>

      <div style="margin-bottom: 20px;">
        <h4 style="margin-bottom: 12px; font-weight: 700;">Tukar Views ke Coins</h4>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
          5 Views = 1 Coin | Total Views: <span id="totalViewsDisplay">0</span>
        </p>
        <button class="btn btn-primary" onclick="convertViewsToCoins()" style="width: 100%;">
          <i class="fas fa-exchange-alt"></i> Tukar Semua Views
        </button>
      </div>

      <div>
        <h4 style="margin-bottom: 12px; font-weight: 700;">Beli dengan Coins</h4>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h5 style="font-weight: 700; margin-bottom: 4px;">Custom Tag</h5>
              <p style="font-size: 12px; color: var(--text-secondary);">100 Coins</p>
            </div>
            <button class="btn btn-secondary" onclick="buyCustomTag()">Beli</button>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h5 style="font-weight: 700; margin-bottom: 4px;">VIP 7 Hari</h5>
              <p style="font-size: 12px; color: var(--text-secondary);">500 Coins</p>
            </div>
            <button class="btn btn-secondary" onclick="buyVIPWithCoins(7)">Beli</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal" id="modalEvent">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üéÅ Event Terbaru</h2>
        <button class="close-btn" onclick="closeModal('modalEvent')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="eventContent" style="text-align: center;">
        <div style="background: var(--accent-gradient); padding: 32px; border-radius: 12px; margin-bottom: 24px;">
          <h3 style="font-size: 32px; font-weight: 900; color: #000; margin-bottom: 8px;">üéµ Music Festival 2026</h3>
          <p style="color: #000; font-weight: 600;">Event spesial dengan hadiah menarik!</p>
        </div>

        <div style="margin-bottom: 24px;">
          <h4 style="margin-bottom: 16px; font-weight: 700;">Countdown:</h4>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px;">
              <h3 id="eventDays" style="font-size: 36px; font-weight: 900; color: var(--primary);">0</h3>
              <p style="font-size: 12px; color: var(--text-secondary);">Hari</p>
            </div>
            <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px;">
              <h3 id="eventHours" style="font-size: 36px; font-weight: 900; color: var(--primary);">0</h3>
              <p style="font-size: 12px; color: var(--text-secondary);">Jam</p>
            </div>
            <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px;">
              <h3 id="eventMinutes" style="font-size: 36px; font-weight: 900; color: var(--primary);">0</h3>
              <p style="font-size: 12px; color: var(--text-secondary);">Menit</p>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <h4 style="margin-bottom: 12px; font-weight: 700;">Ketupat Kamu: <span id="ketupatCount" style="color: var(--primary);">0</span></h4>
          <button class="btn btn-primary" onclick="claimDailyReward()" id="claimRewardBtn">
            <i class="fas fa-gift"></i> Claim Reward Harian
          </button>
        </div>

        <div>
          <h4 style="margin-bottom: 12px; font-weight: 700;">Rewards:</h4>
          <ul style="list-style: none; padding: 0;">
            <li style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
              <i class="fas fa-star" style="color: #ffd700;"></i> VIP 1 Hari - 100 Ketupat
            </li>
            <li style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
              <i class="fas fa-star" style="color: #ffd700;"></i> Custom Tag - 200 Ketupat
            </li>
            <li style="padding: 8px 0;">
              <i class="fas fa-star" style="color: #ffd700;"></i> 500 Coins - 300 Ketupat
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Service Modal -->
  <div class="modal" id="modalCustomerService">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üéß Customer Service</h2>
        <button class="close-btn" onclick="closeModal('modalCustomerService')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <p style="color: var(--text-secondary); margin-bottom: 20px;">
        Pilih kategori bantuan yang Anda butuhkan:
      </p>

      <div class="category-grid">
        <div class="category-card" onclick="selectCSCategory('refund_data')">
          <i class="fas fa-database"></i>
          <p>Refund Data</p>
        </div>
        <div class="category-card" onclick="selectCSCategory('refund_vip')">
          <i class="fas fa-crown"></i>
          <p>Refund VIP</p>
        </div>
        <div class="category-card" onclick="selectCSCategory('question')">
          <i class="fas fa-question"></i>
          <p>Bertanya</p>
        </div>
        <div class="category-card" onclick="selectCSCategory('update_request')">
          <i class="fas fa-code"></i>
          <p>Request Update</p>
        </div>
        <div class="category-card" onclick="selectCSCategory('bug_report')">
          <i class="fas fa-bug"></i>
          <p>Laporkan Bug</p>
        </div>
        <div class="category-card" onclick="selectCSCategory('other')">
          <i class="fas fa-ellipsis-h"></i>
          <p>Lainnya</p>
        </div>
      </div>

      <div id="csFormSection" style="display: none; margin-top: 20px;">
        <div class="form-group">
          <label>Kategori: <span id="selectedCategory" style="color: var(--primary); font-weight: 700;"></span></label>
        </div>

        <div class="form-group">
          <label>Pesan *</label>
          <textarea class="form-control" id="csMessage" rows="5" placeholder="Jelaskan masalah Anda secara detail..." maxlength="1000"></textarea>
        </div>

        <button class="btn btn-primary" onclick="submitCSTicket()" style="width: 100%;">
          <i class="fas fa-paper-plane"></i> Kirim Tiket
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Modal -->
  <div class="modal" id="modalNotif">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîî Notifikasi</h2>
        <button class="close-btn" onclick="closeModal('modalNotif')">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div style="text-align: right; margin-bottom: 16px;">
        <button class="btn btn-secondary" onclick="clearAllNotifications()" style="padding: 8px 16px; font-size: 13px;">
          <i class="fas fa-trash"></i> Hapus Semua
        </button>
      </div>

      <div id="notifList" style="display: flex; flex-direction: column; gap: 12px;">
        <p style="text-align: center; color: var(--text-secondary);">Tidak ada notifikasi</p>
      </div>
    </div>
  </div>

  <!-- Admin Overlay (for admins only) -->
  <div class="admin-overlay" id="adminOverlay">
    <div class="admin-overlay-header">
      <h3 style="font-size: 18px; font-weight: 800;">Admin Quick Panel</h3>
      <button class="close-btn" onclick="toggleAdminOverlay()" style="width: 28px; height: 28px; font-size: 16px;">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="admin-quick-stats">
      <div class="stat-box">
        <h4 id="adminTotalUsers">0</h4>
        <p>Total Users</p>
      </div>
      <div class="stat-box">
        <h4 id="adminTotalSongs">0</h4>
        <p>Total Songs</p>
      </div>
      <div class="stat-box">
        <h4 id="adminPendingRequests">0</h4>
        <p>Pending Requests</p>
      </div>
      <div class="stat-box">
        <h4 id="adminOnlineUsers">0</h4>
        <p>Online Now</p>
      </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 8px;">
      <button class="btn btn-secondary" onclick="window.open('adminv3_2.html', '_blank')" style="width: 100%; justify-content: center;">
        <i class="fas fa-cog"></i> Open Full Admin Panel
      </button>
      <button class="btn btn-secondary" onclick="sendBroadcastNotif()" style="width: 100%; justify-content: center;">
        <i class="fas fa-bullhorn"></i> Send Broadcast
      </button>
      <button class="btn btn-secondary" onclick="viewPendingRequests()" style="width: 100%; justify-content: center;">
        <i class="fas fa-tasks"></i> View Requests
      </button>
    </div>
  </div>

  <!-- Firebase Configuration & Main Script -->
  <script>
    // Firebase Configuration - REPLACE WITH YOUR CONFIG
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // Global Variables
    let currentUser = null;
    let allSongs = [];
    let currentSongIndex = 0;
    let isPlaying = false;
    let isShuffle = false;
    let isRepeat = false;
    let favorites = [];
    let currentViewingProfile = null;
    let selectedCSCategory = null;

    const audioPlayer = document.getElementById('audioPlayer');

    // Initialize App
    window.addEventListener('load', () => {
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          loadUserData();
          initializeApp();
        } else {
          currentUser = null;
          initializeGuestMode();
        }
      });

      // Load songs
      loadSongs();
      
      // Load announcements
      loadAnnouncements();

      // Setup audio player events
      setupAudioPlayer();
    });

    function loadUserData() {
      db.ref('users/' + currentUser.uid).on('value', snapshot => {
        const userData = snapshot.val();
        if (userData) {
          document.getElementById('usernameDisplay').textContent = userData.username || 'User';
          document.getElementById('userAvatarImg').src = userData.avatar || 'exemusicicon.png';
          document.getElementById('userCoins').textContent = userData.coins || 0;
          
          // Check VIP status
          if (userData.vipExpiry && userData.vipExpiry > Date.now()) {
            // User has active VIP
            document.querySelector('.btn-upgrade').innerHTML = '<i class="fas fa-crown"></i> VIP Active';
            document.querySelector('.btn-upgrade').style.background = 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)';
            document.querySelector('.btn-upgrade').style.color = '#000';
          }

          // Load favorites
          if (userData.favorites) {
            favorites = Object.keys(userData.favorites);
          }

          // Show admin overlay if admin
          if (userData.role === 'admin' || userData.role === 'owner') {
            showAdminFeatures();
          }
        }
      });
    }

    function initializeGuestMode() {
      document.getElementById('usernameDisplay').textContent = 'Guest';
      document.getElementById('userAvatarImg').src = 'exemusicicon.png';
      document.getElementById('coinDisplay').style.display = 'none';
    }

    function initializeApp() {
      document.getElementById('coinDisplay').style.display = 'flex';
    }

    function loadSongs() {
      db.ref('songs').orderByChild('timestamp').limitToLast(100).on('value', snapshot => {
        allSongs = [];
        snapshot.forEach(child => {
          const song = child.val();
          song.id = child.key;
          allSongs.push(song);
        });
        allSongs.reverse(); // Newest first
        
        renderSongs();
      });
    }

    function renderSongs() {
      // Trending (sorted by plays)
      const trending = [...allSongs].sort((a, b) => (b.plays || 0) - (a.plays || 0)).slice(0, 6);
      renderSongGrid('trendingGrid', trending);

      // Recommended (random selection)
      const recommended = [...allSongs].sort(() => 0.5 - Math.random()).slice(0, 6);
      renderSongGrid('recommendedGrid', recommended);

      // Recent uploads
      const recent = allSongs.slice(0, 6);
      renderSongGrid('recentGrid', recent);
    }

    function renderSongGrid(gridId, songs) {
      const grid = document.getElementById(gridId);
      if (!songs || songs.length === 0) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">Belum ada lagu</p>';
        return;
      }

      grid.innerHTML = songs.map((song, index) => `
        <div class="song-card" onclick="playSong(${allSongs.indexOf(song)})">
          <div class="card-image-wrapper">
            <img src="${song.cover || 'exemusicicon.png'}" alt="${song.title}" class="card-image" onerror="this.src='exemusicicon.png'">
            <div class="play-button-overlay">
              <i class="fas fa-play"></i>
            </div>
          </div>
          <div class="card-title">${song.title || 'Unknown Title'}</div>
          <div class="card-artist">@${song.by || song.byName || 'Unknown'}</div>
          <div class="card-stats">
            <span><i class="fas fa-play"></i> ${song.plays || 0}</span>
            <span><i class="fas fa-heart"></i> ${song.likes || 0}</span>
          </div>
        </div>
      `).join('');
    }

    function loadAnnouncements() {
      db.ref('announcements').orderByChild('timestamp').limitToLast(1).once('value', snapshot => {
        snapshot.forEach(child => {
          const announcement = child.val();
          const banner = document.getElementById('announcementBanner');
          document.getElementById('announcementTitle').textContent = announcement.title || 'Pengumuman';
          document.getElementById('announcementMessage').textContent = announcement.message || '';
          document.getElementById('announcementIcon').className = `fas ${announcement.icon || 'fa-bullhorn'} announcement-icon`;
          banner.style.display = 'flex';
        });
      });
    }


    // Audio Player Functions
    function setupAudioPlayer() {
      audioPlayer.addEventListener('timeupdate', updateProgress);
      audioPlayer.addEventListener('ended', () => {
        if (isRepeat) {
          audioPlayer.currentTime = 0;
          audioPlayer.play();
        } else {
          nextSong();
        }
      });
      audioPlayer.addEventListener('loadedmetadata', () => {
        document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
      });
    }

    function playSong(index) {
      if (index < 0 || index >= allSongs.length) return;
      
      currentSongIndex = index;
      const song = allSongs[index];

      // Update UI
      document.getElementById('nowPlayingTitle').textContent = song.title || 'Unknown';
      document.getElementById('nowPlayingArtist').textContent = '@' + (song.by || song.byName || 'Unknown');
      document.getElementById('nowPlayingCover').src = song.cover || 'exemusicicon.png';

      // Update hero if on home page
      document.getElementById('heroImage').src = song.cover || 'exemusicicon.png';
      document.getElementById('heroTitle').textContent = song.title || 'Unknown';

      // Set audio source and play
      audioPlayer.src = song.url;
      audioPlayer.play();
      isPlaying = true;
      document.querySelector('#playPauseBtn i').className = 'fas fa-pause';

      // Increment play count
      if (song.id) {
        const newPlays = (song.plays || 0) + 1;
        db.ref('songs/' + song.id + '/plays').set(newPlays);
        
        // Increment user's total views
        if (song.uid && song.uid !== 'ADMIN_CONSOLE') {
          db.ref('users/' + song.uid + '/totalViews').transaction(val => (val || 0) + 1);
        }
      }

      // Update like button
      updateLikeButton();
    }

    function togglePlay() {
      if (isPlaying) {
        audioPlayer.pause();
        isPlaying = false;
        document.querySelector('#playPauseBtn i').className = 'fas fa-play';
      } else {
        audioPlayer.play();
        isPlaying = true;
        document.querySelector('#playPauseBtn i').className = 'fas fa-pause';
      }
    }

    function nextSong() {
      if (isShuffle) {
        currentSongIndex = Math.floor(Math.random() * allSongs.length);
      } else {
        currentSongIndex = (currentSongIndex + 1) % allSongs.length;
      }
      playSong(currentSongIndex);
    }

    function previousSong() {
      currentSongIndex = (currentSongIndex - 1 + allSongs.length) % allSongs.length;
      playSong(currentSongIndex);
    }

    function toggleShuffle() {
      isShuffle = !isShuffle;
      const btn = document.getElementById('shuffleBtn');
      if (isShuffle) {
        btn.style.color = 'var(--primary)';
      } else {
        btn.style.color = 'var(--text-secondary)';
      }
    }

    function toggleRepeat() {
      isRepeat = !isRepeat;
      const btn = document.getElementById('repeatBtn');
      if (isRepeat) {
        btn.style.color = 'var(--primary)';
      } else {
        btn.style.color = 'var(--text-secondary)';
      }
    }

    function toggleLike() {
      if (!currentUser) {
        openModal('modalAuth');
        return;
      }

      const song = allSongs[currentSongIndex];
      if (!song.id) return;

      const userFavRef = db.ref('users/' + currentUser.uid + '/favorites/' + song.id);
      const songLikesRef = db.ref('songs/' + song.id + '/likes');

      userFavRef.once('value', snapshot => {
        if (snapshot.exists()) {
          // Remove from favorites
          userFavRef.remove();
          songLikesRef.transaction(val => Math.max(0, (val || 0) - 1));
          showToast('Dihapus dari favorit', 'info');
        } else {
          // Add to favorites
          userFavRef.set(true);
          songLikesRef.transaction(val => (val || 0) + 1);
          showToast('Ditambahkan ke favorit', 'success');
        }
        updateLikeButton();
      });
    }

    function updateLikeButton() {
      if (!currentUser) return;
      
      const song = allSongs[currentSongIndex];
      if (!song.id) return;

      db.ref('users/' + currentUser.uid + '/favorites/' + song.id).once('value', snapshot => {
        const likeIcon = document.querySelector('#likeBtn i');
        if (snapshot.exists()) {
          likeIcon.className = 'fas fa-heart';
          likeIcon.style.color = 'var(--primary)';
        } else {
          likeIcon.className = 'far fa-heart';
          likeIcon.style.color = 'var(--text-secondary)';
        }
      });
    }

    function seekSong(event) {
      const progressBar = document.getElementById('progressBar');
      const clickX = event.offsetX;
      const width = progressBar.offsetWidth;
      const duration = audioPlayer.duration;
      audioPlayer.currentTime = (clickX / width) * duration;
    }

    function updateProgress() {
      const current = audioPlayer.currentTime;
      const duration = audioPlayer.duration;
      const percentage = (current / duration) * 100;
      
      document.getElementById('progressFilled').style.width = percentage + '%';
      document.getElementById('currentTime').textContent = formatTime(current);
    }

    function setVolume(value) {
      audioPlayer.volume = value / 100;
      updateVolumeIcon(value);
    }

    function toggleMute() {
      if (audioPlayer.volume > 0) {
        audioPlayer.volume = 0;
        document.getElementById('volumeSlider').value = 0;
        updateVolumeIcon(0);
      } else {
        audioPlayer.volume = 0.7;
        document.getElementById('volumeSlider').value = 70;
        updateVolumeIcon(70);
      }
    }

    function updateVolumeIcon(value) {
      const icon = document.getElementById('volumeIcon');
      if (value == 0) {
        icon.className = 'fas fa-volume-mute';
      } else if (value < 50) {
        icon.className = 'fas fa-volume-down';
      } else {
        icon.className = 'fas fa-volume-up';
      }
    }

    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Search Function
    function handleSearch() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      if (!query) {
        renderSongs();
        return;
      }

      const results = allSongs.filter(song => {
        const title = (song.title || '').toLowerCase();
        const artist = (song.by || song.byName || '').toLowerCase();
        return title.includes(query) || artist.includes(query);
      });

      renderSongGrid('trendingGrid', results.slice(0, 6));
      renderSongGrid('recommendedGrid', results.slice(6, 12));
      renderSongGrid('recentGrid', results.slice(12, 18));
    }

    // Modal Functions
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function switchPage(page) {
      // Simple page switching
      if (page === 'search') {
        document.getElementById('searchInput').focus();
      }
    }

    // Auth Functions
    function handleLogin() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;

      if (!email || !password) {
        showToast('Email dan password harus diisi!', 'warning');
        return;
      }

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          showToast('Login berhasil!', 'success');
          closeModal('modalAuth');
        })
        .catch(error => {
          showToast('Login gagal: ' + error.message, 'error');
        });
    }

    function handleRegister() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const username = document.getElementById('authUsername').value;

      if (!email || !password || !username) {
        showToast('Semua field harus diisi!', 'warning');
        return;
      }

      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          const user = userCredential.user;
          return db.ref('users/' + user.uid).set({
            username: username,
            email: email,
            coins: 0,
            totalViews: 0,
            createdAt: Date.now()
          });
        })
        .then(() => {
          showToast('Registrasi berhasil!', 'success');
          closeModal('modalAuth');
        })
        .catch(error => {
          showToast('Registrasi gagal: ' + error.message, 'error');
        });
    }

    // Upload Functions
    function openUploadModal() {
      if (!currentUser) {
        document.getElementById('guestUploadSection').style.display = 'block';
      } else {
        document.getElementById('guestUploadSection').style.display = 'none';
      }
      openModal('modalUpload');
    }

    function submitUpload() {
      const title = document.getElementById('uploadTitle').value;
      const url = document.getElementById('uploadURL').value;
      const cover = document.getElementById('uploadCover').value;

      if (!title || !url) {
        showToast('Judul dan URL wajib diisi!', 'warning');
        return;
      }

      // Convert YouTube URL to embed format
      let embedUrl = url;
      if (url.includes('youtube.com/watch?v=')) {
        const videoId = url.split('v=')[1]?.split('&')[0];
        if (videoId) {
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        }
      } else if (url.includes('youtu.be/')) {
        const videoId = url.split('youtu.be/')[1]?.split('?')[0];
        if (videoId) {
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        }
      }

      const requestData = {
        title: title,
        url: embedUrl,
        cover: cover || 'exemusicicon.png',
        timestamp: Date.now(),
        status: 'pending'
      };

      if (currentUser) {
        requestData.uid = currentUser.uid;
        db.ref('users/' + currentUser.uid).once('value', snapshot => {
          requestData.by = snapshot.val()?.username || 'User';
          submitRequest(requestData);
        });
      } else {
        const guestName = document.getElementById('guestName').value;
        if (!guestName) {
          showToast('Nama harus diisi untuk guest!', 'warning');
          return;
        }
        requestData.guestName = guestName;
        requestData.uid = 'guest';
        requestData.by = guestName;
        submitRequest(requestData);
      }
    }

    function submitRequest(data) {
      db.ref('requests').push(data)
        .then(() => {
          showToast('Request lagu berhasil dikirim!', 'success');
          closeModal('modalUpload');
          // Clear form
          document.getElementById('uploadTitle').value = '';
          document.getElementById('uploadURL').value = '';
          document.getElementById('uploadCover').value = '';
          document.getElementById('guestName').value = '';
        })
        .catch(error => {
          showToast('Gagal mengirim request: ' + error.message, 'error');
        });
    }

    function showURLTutorial() {
      Swal.fire({
        title: 'Cara Mendapatkan URL YouTube',
        html: `
          <div style="text-align: left; color: #fff;">
            <p style="margin-bottom: 12px;"><strong>Langkah-langkah:</strong></p>
            <ol style="padding-left: 20px;">
              <li style="margin-bottom: 8px;">Buka video YouTube yang ingin kamu upload</li>
              <li style="margin-bottom: 8px;">Klik tombol "Share" di bawah video</li>
              <li style="margin-bottom: 8px;">Copy link yang muncul</li>
              <li style="margin-bottom: 8px;">Paste link tersebut di field URL</li>
            </ol>
            <p style="margin-top: 16px; color: var(--text-secondary); font-size: 13px;">
              Format yang diterima:<br>
              ‚Ä¢ https://www.youtube.com/watch?v=...<br>
              ‚Ä¢ https://youtu.be/...
            </p>
          </div>
        `,
        background: '#181818',
        color: '#fff',
        confirmButtonColor: '#1DB954',
        confirmButtonText: 'Mengerti'
      });
    }

    // Profile Functions
    function openProfileModal() {
      if (!currentUser) {
        openModal('modalAuth');
        return;
      }
      viewProfile(currentUser.uid);
    }

    function viewProfile(uid) {
      currentViewingProfile = uid;
      openModal('modalProfile');

      db.ref('users/' + uid).once('value', snapshot => {
        const user = snapshot.val();
        if (!user) return;

        document.getElementById('profileUsername').textContent = user.username || 'User';
        document.getElementById('profileAvatarImg').src = user.avatar || 'exemusicicon.png';
        document.getElementById('profileFollowers').textContent = user.followers ? Object.keys(user.followers).length : 0;
        document.getElementById('profileFollowing').textContent = user.following ? Object.keys(user.following).length : 0;

        // Show tags
        const tagsContainer = document.getElementById('profileTags');
        tagsContainer.innerHTML = '';
        
        if (user.vipExpiry && user.vipExpiry > Date.now()) {
          tagsContainer.innerHTML += '<span class="vip-badge"><i class="fas fa-crown"></i> VIP</span>';
        }

        if (user.tags) {
          Object.values(user.tags).forEach(tag => {
            tagsContainer.innerHTML += `<span class="tag-badge custom">${tag}</span>`;
          });
        } else if (user.tag) {
          tagsContainer.innerHTML += `<span class="tag-badge">${user.tag}</span>`;
        }

        // Show follow button or edit button
        if (currentUser && uid === currentUser.uid) {
          document.getElementById('followBtn').style.display = 'none';
          document.getElementById('editProfileBtn').style.display = 'inline-flex';
        } else if (currentUser) {
          document.getElementById('editProfileBtn').style.display = 'none';
          document.getElementById('followBtn').style.display = 'inline-flex';
          checkFollowStatus(uid);
        }
      });

      switchProfileTab('posts');
    }

    function checkFollowStatus(uid) {
      if (!currentUser) return;

      db.ref('users/' + currentUser.uid + '/following/' + uid).once('value', snapshot => {
        const btn = document.getElementById('followBtn');
        if (snapshot.exists()) {
          btn.textContent = 'Unfollow';
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-secondary');
        } else {
          btn.textContent = 'Follow';
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-primary');
        }
      });
    }

    function toggleFollow() {
      if (!currentUser || !currentViewingProfile) return;

      const followRef = db.ref('users/' + currentUser.uid + '/following/' + currentViewingProfile);
      const followerRef = db.ref('users/' + currentViewingProfile + '/followers/' + currentUser.uid);

      followRef.once('value', snapshot => {
        if (snapshot.exists()) {
          // Unfollow
          followRef.remove();
          followerRef.remove();
          showToast('Unfollow berhasil', 'info');
        } else {
          // Follow
          followRef.set(true);
          followerRef.set(true);
          showToast('Follow berhasil', 'success');
          
          // Send notification
          db.ref('users/' + currentUser.uid + '/username').once('value', nameSnap => {
            db.ref('users/' + currentViewingProfile + '/notifications').push({
              message: `${nameSnap.val() || 'Someone'} mulai mengikuti kamu`,
              timestamp: Date.now(),
              type: 'follow'
            });
          });
        }
        checkFollowStatus(currentViewingProfile);
        viewProfile(currentViewingProfile);
      });
    }

    function switchProfileTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.profile-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      event?.target?.classList?.add('active');

      const grid = document.getElementById('profileSongsGrid');
      
      if (tab === 'posts') {
        const userSongs = allSongs.filter(s => s.uid === currentViewingProfile);
        renderSongGrid('profileSongsGrid', userSongs);
      } else if (tab === 'favorites') {
        if (!currentUser) {
          grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">Login untuk melihat favorit</p>';
          return;
        }
        
        db.ref('users/' + currentUser.uid + '/favorites').once('value', snapshot => {
          const favIds = snapshot.val() ? Object.keys(snapshot.val()) : [];
          const favSongs = allSongs.filter(s => favIds.includes(s.id));
          renderSongGrid('profileSongsGrid', favSongs);
        });
      }
    }

    // Edit Profile Functions
    function openEditProfile() {
      closeModal('modalProfile');
      openModal('modalEditProfile');

      db.ref('users/' + currentUser.uid).once('value', snapshot => {
        const user = snapshot.val();
        document.getElementById('editAvatar').value = user.avatar || '';
        
        // Show VIP color picker if VIP
        if (user.vipExpiry && user.vipExpiry > Date.now()) {
          document.getElementById('vipColorSection').style.display = 'block';
          document.getElementById('editProfileColor').value = user.profileColor || '#1DB954';
        } else {
          document.getElementById('vipColorSection').style.display = 'none';
        }

        // Load tags
        loadTagsManager(user);
      });
    }

    function loadTagsManager(user) {
      const container = document.getElementById('tagsManager');
      const tags = user.tags ? Object.entries(user.tags) : [];
      const isVIP = user.vipExpiry && user.vipExpiry > Date.now();
      const maxTags = isVIP ? 5 : 2;

      container.innerHTML = tags.map(([id, tag]) => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 8px;">
          <span>${tag}</span>
          <button class="btn btn-secondary" onclick="removeTag('${id}')" style="padding: 4px 12px; font-size: 12px;">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('') || '<p style="color: var(--text-secondary); font-size: 13px;">Belum ada tags</p>';

      container.innerHTML += `<p style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">${tags.length}/${maxTags} tags</p>`;
    }

    function openAddTagModal() {
      db.ref('users/' + currentUser.uid).once('value', snapshot => {
        const user = snapshot.val();
        const tags = user.tags ? Object.keys(user.tags) : [];
        const isVIP = user.vipExpiry && user.vipExpiry > Date.now();
        const maxTags = isVIP ? 5 : 2;

        if (tags.length >= maxTags) {
          showToast(`Maksimal ${maxTags} tags. Hapus tag lama terlebih dahulu.`, 'warning');
          return;
        }

        openModal('modalAddTag');
      });
    }

    function addNewTag() {
      const tagName = document.getElementById('newTagName').value.toUpperCase().trim();
      
      if (!tagName) {
        showToast('Nama tag tidak boleh kosong!', 'warning');
        return;
      }

      db.ref('users/' + currentUser.uid + '/tags').push(tagName)
        .then(() => {
          showToast('Tag berhasil ditambahkan!', 'success');
          closeModal('modalAddTag');
          document.getElementById('newTagName').value = '';
          openEditProfile();
        })
        .catch(error => {
          showToast('Gagal menambahkan tag: ' + error.message, 'error');
        });
    }

    function removeTag(tagId) {
      if (confirm('Hapus tag ini?')) {
        db.ref('users/' + currentUser.uid + '/tags/' + tagId).remove()
          .then(() => {
            showToast('Tag berhasil dihapus', 'info');
            openEditProfile();
          });
      }
    }

    function saveProfileChanges() {
      const avatar = document.getElementById('editAvatar').value;
      const updates = {};

      if (avatar) {
        updates.avatar = avatar;
      }

      // Save VIP color if VIP
      const colorSection = document.getElementById('vipColorSection');
      if (colorSection.style.display !== 'none') {
        updates.profileColor = document.getElementById('editProfileColor').value;
      }

      db.ref('users/' + currentUser.uid).update(updates)
        .then(() => {
          showToast('Profil berhasil diupdate!', 'success');
          closeModal('modalEditProfile');
        })
        .catch(error => {
          showToast('Gagal update profil: ' + error.message, 'error');
        });
    }


    // VIP Functions
    function openVipModal() {
      if (!currentUser) {
        openModal('modalAuth');
        return;
      }
      openModal('modalVIP');
    }

    function buyVIPWithCoins(days) {
      if (!currentUser) {
        openModal('modalAuth');
        return;
      }

      const prices = {
        7: 500,
        30: 1500
      };

      const price = prices[days];
      if (!price) return;

      db.ref('users/' + currentUser.uid).once('value', snapshot => {
        const user = snapshot.val();
        const currentCoins = user.coins || 0;

        if (currentCoins < price) {
          showToast('Coin tidak cukup!', 'warning');
          return;
        }

        const vipDuration = days * 24 * 60 * 60 * 1000; // Convert days to milliseconds
        const currentVipExpiry = (user.vipExpiry && user.vipExpiry > Date.now()) ? user.vipExpiry : Date.now();
        const newVipExpiry = currentVipExpiry + vipDuration;

        db.ref('users/' + currentUser.uid).update({
          coins: currentCoins - price,
          vipExpiry: newVipExpiry,
          role: 'vip'
        }).then(() => {
          showToast(`VIP ${days} hari berhasil dibeli!`, 'success');
          closeModal('modalVIP');
          
          // Log transaction
          db.ref('logs').push({
            action: 'buy_vip',
            userId: currentUser.uid,
            days: days,
            coins: price,
            timestamp: Date.now()
          });
        });
      });
    }

    // Coin Shop Functions
    function openCoinShopModal() {
      if (!currentUser) {
        openModal('modalAuth');
        return;
      }
      openModal('modalCoinShop');

      db.ref('users/' + currentUser.uid).once('value', snapshot => {
        const user = snapshot.val();
        document.getElementById('coinShopBalance').textContent = user.coins || 0;
        document.getElementById('totalViewsDisplay').textContent = user.totalViews || 0;
      });
    }

    function convertViewsToCoins() {
      if (!currentUser) return;

      db.ref('users/' + currentUser.uid).once('value', snapshot => {
        const user = snapshot.val();
        const totalViews = user.totalViews || 0;
        const coins = user.coins || 0;

        // 5 views = 1 coin
        const coinsToAdd = Math.floor(totalViews / 5);
        const remainingViews = totalViews % 5;

        if (coinsToAdd === 0) {
          showToast('Butuh minimal 5 views untuk 1 coin!', 'warning');
          return;
        }

        db.ref('users/' + currentUser.uid).update({
          coins: coins + coinsToAdd,
          totalViews: remainingViews
        }).then(() => {
          showToast(`${coinsToAdd} coin berhasil didapatkan!`, 'success');
          openCoinShopModal(); // Refresh
        });
      });
    }

    function buyCustomTag() {
      if (!currentUser) return;

      const price = 100;

      db.ref('users/' + currentUser.uid).once('value', snapshot => {
        const user = snapshot.val();
        const currentCoins = user.coins || 0;

        if (currentCoins < price) {
          showToast('Coin tidak cukup!', 'warning');
          return;
        }

        Swal.fire({
          title: 'Beli Custom Tag',
          text: 'Masukkan nama tag (max 20 karakter)',
          input: 'text',
          inputAttributes: {
            maxlength: 20
          },
          background: '#181818',
          color: '#fff',
          confirmButtonColor: '#1DB954',
          showCancelButton: true,
          confirmButtonText: 'Beli',
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed && result.value) {
            const tagName = result.value.toUpperCase().trim();
            
            db.ref('users/' + currentUser.uid + '/tags').push(tagName);
            db.ref('users/' + currentUser.uid + '/coins').set(currentCoins - price);
            
            showToast('Custom tag berhasil dibeli!', 'success');
            closeModal('modalCoinShop');
          }
        });
      });
    }

    // Event Functions
    function openEventModal() {
      if (!currentUser) {
        openModal('modalAuth');
        return;
      }
      openModal('modalEvent');
      startEventCountdown();

      db.ref('users/' + currentUser.uid + '/ketupat').on('value', snapshot => {
        document.getElementById('ketupatCount').textContent = snapshot.val() || 0;
      });
    }

    function startEventCountdown() {
      const eventDate = new Date('2026-05-01T00:00:00').getTime();
      
      const updateCountdown = () => {
        const now = new Date().getTime();
        const distance = eventDate - now;

        if (distance < 0) {
          document.getElementById('eventDays').textContent = '0';
          document.getElementById('eventHours').textContent = '0';
          document.getElementById('eventMinutes').textContent = '0';
          return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById('eventDays').textContent = days;
        document.getElementById('eventHours').textContent = hours;
        document.getElementById('eventMinutes').textContent = minutes;
      };

      updateCountdown();
      setInterval(updateCountdown, 60000); // Update every minute
    }

    function claimDailyReward() {
      if (!currentUser) return;

      db.ref('users/' + currentUser.uid).once('value', snapshot => {
        const user = snapshot.val();
        const lastClaim = user.lastDailyClaim || 0;
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;

        if (now - lastClaim < oneDay) {
          const timeLeft = oneDay - (now - lastClaim);
          const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
          showToast(`Tunggu ${hoursLeft} jam lagi untuk claim berikutnya!`, 'warning');
          return;
        }

        const isVIP = user.vipExpiry && user.vipExpiry > Date.now();
        const rewardAmount = isVIP ? 20 : 10; // VIP gets 2x rewards

        db.ref('users/' + currentUser.uid).update({
          ketupat: (user.ketupat || 0) + rewardAmount,
          lastDailyClaim: now
        }).then(() => {
          showToast(`${rewardAmount} ketupat berhasil diklaim!`, 'success');
        });
      });
    }

    // Customer Service Functions
    function openCustomerServiceModal() {
      if (!currentUser) {
        openModal('modalAuth');
        return;
      }
      
      // Reset form
      selectedCSCategory = null;
      document.getElementById('csFormSection').style.display = 'none';
      document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      openModal('modalCustomerService');
    }

    function selectCSCategory(category) {
      selectedCSCategory = category;
      
      // Update UI
      document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.target.closest('.category-card').classList.add('selected');
      
      // Show form
      document.getElementById('csFormSection').style.display = 'block';
      
      // Update category label
      const categoryNames = {
        'refund_data': 'Refund Data',
        'refund_vip': 'Refund VIP',
        'question': 'Pertanyaan',
        'update_request': 'Request Update',
        'bug_report': 'Laporan Bug',
        'other': 'Lainnya'
      };
      
      document.getElementById('selectedCategory').textContent = categoryNames[category] || category;
    }

    function submitCSTicket() {
      if (!selectedCSCategory) {
        showToast('Pilih kategori terlebih dahulu!', 'warning');
        return;
      }

      const message = document.getElementById('csMessage').value.trim();
      
      if (!message) {
        showToast('Pesan tidak boleh kosong!', 'warning');
        return;
      }

      db.ref('users/' + currentUser.uid + '/username').once('value', snapshot => {
        const username = snapshot.val() || 'User';
        
        db.ref('customerService').push({
          category: selectedCSCategory,
          message: message,
          uid: currentUser.uid,
          username: username,
          timestamp: Date.now(),
          status: 'pending'
        }).then(() => {
          showToast('Tiket berhasil dikirim! Admin akan merespons segera.', 'success');
          closeModal('modalCustomerService');
          document.getElementById('csMessage').value = '';
        });
      });
    }

    // Notification Functions
    function openNotifModal() {
      if (!currentUser) {
        openModal('modalAuth');
        return;
      }
      openModal('modalNotif');
      loadNotifications();
    }

    function loadNotifications() {
      if (!currentUser) return;

      db.ref('users/' + currentUser.uid + '/notifications').limitToLast(20).once('value', snapshot => {
        const notifList = document.getElementById('notifList');
        const notifications = [];

        snapshot.forEach(child => {
          notifications.push({
            id: child.key,
            ...child.val()
          });
        });

        notifications.reverse(); // Show newest first

        if (notifications.length === 0) {
          notifList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Tidak ada notifikasi</p>';
          return;
        }

        notifList.innerHTML = notifications.map(notif => {
          const date = new Date(notif.timestamp);
          return `
            <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; border-left: 3px solid var(--primary);">
              <p style="margin-bottom: 8px;">${notif.message}</p>
              <span style="font-size: 11px; color: var(--text-secondary);">${date.toLocaleString('id-ID')}</span>
            </div>
          `;
        }).join('');
      });
    }

    function clearAllNotifications() {
      if (!currentUser) return;

      if (confirm('Hapus semua notifikasi?')) {
        db.ref('users/' + currentUser.uid + '/notifications').remove()
          .then(() => {
            showToast('Semua notifikasi berhasil dihapus', 'info');
            loadNotifications();
          });
      }
    }

    // Admin Functions
    function showAdminFeatures() {
      // Show admin nav item
      const navMenu = document.querySelector('.nav-menu');
      const adminNavItem = document.createElement('div');
      adminNavItem.className = 'nav-item';
      adminNavItem.innerHTML = '<i class="fas fa-shield-alt"></i><span>Admin Panel</span>';
      adminNavItem.onclick = toggleAdminOverlay;
      navMenu.appendChild(adminNavItem);

      // Load admin stats
      loadAdminStats();
    }

    function toggleAdminOverlay() {
      const overlay = document.getElementById('adminOverlay');
      overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
      
      if (overlay.style.display === 'block') {
        loadAdminStats();
      }
    }

    function loadAdminStats() {
      // Total users
      db.ref('users').once('value', snapshot => {
        document.getElementById('adminTotalUsers').textContent = snapshot.numChildren();
      });

      // Total songs
      db.ref('songs').once('value', snapshot => {
        document.getElementById('adminTotalSongs').textContent = snapshot.numChildren();
      });

      // Pending requests
      db.ref('requests').orderByChild('status').equalTo('pending').once('value', snapshot => {
        document.getElementById('adminPendingRequests').textContent = snapshot.numChildren();
      });

      // Online users (simplified - just show total users for now)
      db.ref('users').limitToLast(10).once('value', snapshot => {
        document.getElementById('adminOnlineUsers').textContent = snapshot.numChildren();
      });
    }

    function sendBroadcastNotif() {
      Swal.fire({
        title: 'Send Broadcast',
        html: `
          <input id="broadcastTitle" class="swal2-input" placeholder="Judul">
          <textarea id="broadcastMessage" class="swal2-textarea" placeholder="Pesan"></textarea>
        `,
        background: '#181818',
        color: '#fff',
        confirmButtonColor: '#1DB954',
        showCancelButton: true,
        confirmButtonText: 'Kirim',
        preConfirm: () => {
          const title = document.getElementById('broadcastTitle').value;
          const message = document.getElementById('broadcastMessage').value;
          
          if (!title || !message) {
            Swal.showValidationMessage('Judul dan pesan harus diisi!');
            return false;
          }
          
          return { title, message };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const { title, message } = result.value;
          
          // Send to all users
          db.ref('users').once('value', snapshot => {
            const updates = {};
            snapshot.forEach(child => {
              const notifId = db.ref('users/' + child.key + '/notifications').push().key;
              updates['users/' + child.key + '/notifications/' + notifId] = {
                message: `${title}: ${message}`,
                timestamp: Date.now(),
                type: 'broadcast'
              };
            });
            
            db.ref().update(updates).then(() => {
              showToast('Broadcast berhasil dikirim!', 'success');
            });
          });

          // Also add to announcements
          db.ref('announcements').push({
            title: title,
            message: message,
            timestamp: Date.now(),
            priority: 'high',
            icon: 'fa-bullhorn'
          });
        }
      });
    }

    function viewPendingRequests() {
      db.ref('requests').orderByChild('status').equalTo('pending').once('value', snapshot => {
        const requests = [];
        snapshot.forEach(child => {
          requests.push({
            id: child.key,
            ...child.val()
          });
        });

        if (requests.length === 0) {
          Swal.fire({
            title: 'Pending Requests',
            text: 'Tidak ada request pending',
            background: '#181818',
            color: '#fff',
            confirmButtonColor: '#1DB954'
          });
          return;
        }

        const html = `
          <div style="max-height: 400px; overflow-y: auto;">
            ${requests.map(req => `
              <div style="background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 8px; border-radius: 8px; text-align: left;">
                <h4 style="margin-bottom: 4px;">${req.title}</h4>
                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                  By: ${req.by || req.guestName || 'Unknown'} | ${new Date(req.timestamp).toLocaleString('id-ID')}
                </p>
                <p style="font-size: 11px; color: var(--text-dim); overflow: hidden; text-overflow: ellipsis;">${req.url}</p>
              </div>
            `).join('')}
          </div>
        `;

        Swal.fire({
          title: `Pending Requests (${requests.length})`,
          html: html,
          background: '#181818',
          color: '#fff',
          confirmButtonColor: '#1DB954',
          width: '600px'
        });
      });
    }

    // Tutorial Function
    function openTutorial() {
      Swal.fire({
        title: 'üìñ Tutorial ExeMusic',
        html: `
          <div style="text-align: left; color: #fff; padding: 0 16px;">
            <h3 style="margin-top: 16px; margin-bottom: 12px; color: var(--primary);">üéµ Cara Memutar Musik</h3>
            <ol style="padding-left: 20px; margin-bottom: 16px;">
              <li style="margin-bottom: 8px;">Cari lagu menggunakan search bar di atas</li>
              <li style="margin-bottom: 8px;">Klik kartu lagu yang ingin kamu putar</li>
              <li style="margin-bottom: 8px;">Musik akan otomatis diputar di player bar bawah</li>
            </ol>

            <h3 style="margin-top: 16px; margin-bottom: 12px; color: var(--primary);">‚¨ÜÔ∏è Cara Upload Lagu</h3>
            <ol style="padding-left: 20px; margin-bottom: 16px;">
              <li style="margin-bottom: 8px;">Klik menu "Upload Lagu" di sidebar</li>
              <li style="margin-bottom: 8px;">Isi judul dan URL YouTube (klik "Tutorial" untuk panduan)</li>
              <li style="margin-bottom: 8px;">Klik "Kirim Request" - Admin akan mereview</li>
              <li style="margin-bottom: 8px;">Guest bisa upload tanpa login!</li>
            </ol>

            <h3 style="margin-top: 16px; margin-bottom: 12px; color: var(--primary);">üí∞ Sistem Coin</h3>
            <ul style="padding-left: 20px; margin-bottom: 16px;">
              <li style="margin-bottom: 8px;">Dapatkan views dari lagu yang kamu upload</li>
              <li style="margin-bottom: 8px;">Tukar 5 views = 1 coin di Coin Shop</li>
              <li style="margin-bottom: 8px;">Gunakan coin untuk beli VIP atau custom tag</li>
            </ul>

            <h3 style="margin-top: 16px; margin-bottom: 12px; color: var(--primary);">üëë VIP Benefits</h3>
            <ul style="padding-left: 20px; margin-bottom: 16px;">
              <li style="margin-bottom: 8px;">Custom warna profil</li>
              <li style="margin-bottom: 8px;">Maksimal 5 custom tags (non-VIP: 2)</li>
              <li style="margin-bottom: 8px;">Event rewards x2</li>
              <li style="margin-bottom: 8px;">Upload tanpa cooldown</li>
            </ul>

            <h3 style="margin-top: 16px; margin-bottom: 12px; color: var(--primary);">üéÅ Event</h3>
            <p style="padding-left: 20px; margin-bottom: 16px;">
              Claim reward harian untuk mendapatkan ketupat. Tukar ketupat dengan VIP, coins, atau custom tag!
            </p>

            <h3 style="margin-top: 16px; margin-bottom: 12px; color: var(--primary);">üéß Customer Service</h3>
            <p style="padding-left: 20px; margin-bottom: 16px;">
              Ada masalah? Hubungi CS melalui menu Customer Service. Pilih kategori dan kirim tiket!
            </p>
          </div>
        `,
        background: '#181818',
        color: '#fff',
        confirmButtonColor: '#1DB954',
        confirmButtonText: 'Mengerti',
        width: '700px'
      });
    }

    // Toast Notification
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };

      const colors = {
        success: '#1DB954',
        error: '#e91e63',
        warning: '#ff9800',
        info: '#2196f3'
      };

      toast.style.borderLeftColor = colors[type] || colors.info;
      toast.innerHTML = `
        <i class="fas ${icons[type] || icons.info}" style="margin-right: 8px;"></i>
        ${message}
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Mobile Menu Toggle
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('open');
    }

    // Initialize volume
    setVolume(70);
  </script>

  <style>
    @keyframes slideOut {
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* Mobile sidebar toggle */
    @media (max-width: 768px) {
      .sidebar::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: none;
        z-index: 99;
      }

      .sidebar.open::before {
        display: block;
      }
    }
  </style>
</body>
</html>
