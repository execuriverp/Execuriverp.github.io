<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ExeMusic v3.2 - Spotify Edition</title>
  <link rel="icon" type="image/png" href="exemusicicon.png">
  
  <!-- Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Circular+Std:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --spotify-green: #1DB954;
      --spotify-black: #121212;
      --spotify-dark-gray: #181818;
      --spotify-light-gray: #282828;
      --spotify-text: #FFFFFF;
      --spotify-text-dim: #b3b3b3;
      --accent: #1DB954;
      --bg-gradient: linear-gradient(180deg, #222222 0%, #121212 100%);
      --glass: rgba(255, 255, 255, 0.1);
      --danger: #e91e63;
      --gold: #ffd700;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    body {
      font-family: 'Circular Std', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #000;
      color: var(--spotify-text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Layout Containers */
    .app-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background-color: #000;
      display: flex;
      flex-direction: column;
      padding: 24px 12px;
      gap: 24px;
      flex-shrink: 0;
    }

    .logo-container {
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .logo-container img {
      height: 40px;
      cursor: pointer;
    }

    .nav-list {
      list-style: none;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px;
      border-radius: 4px;
      color: var(--spotify-text-dim);
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      transition: color 0.2s, background-color 0.2s;
      cursor: pointer;
    }

    .nav-item i { font-size: 20px; }
    .nav-item:hover, .nav-item.active {
      color: var(--spotify-text);
      background-color: var(--spotify-light-gray);
    }

    /* Main Content */
    .main-view {
      flex: 1;
      background: var(--bg-gradient);
      overflow-y: auto;
      position: relative;
      padding-bottom: 100px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.1) transparent;
    }

    .main-view::-webkit-scrollbar { width: 8px; }
    .main-view::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    .top-bar {
      position: sticky;
      top: 0;
      height: 64px;
      background: rgba(18, 18, 18, 0.8);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      z-index: 100;
    }

    .search-container {
      position: relative;
      width: 300px;
    }

    .search-input {
      width: 100%;
      background: #fff;
      border: none;
      padding: 8px 16px 8px 40px;
      border-radius: 500px;
      font-size: 14px;
      color: #000;
    }

    .search-container i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #000;
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .btn-upgrade {
      background: #000;
      color: #fff;
      border: 1px solid var(--spotify-text-dim);
      padding: 6px 16px;
      border-radius: 500px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn-upgrade:hover { transform: scale(1.04); border-color: #fff; }

    .user-profile-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0,0,0,0.7);
      padding: 2px 2px 2px 8px;
      border-radius: 500px;
      cursor: pointer;
      border: none;
      color: #fff;
      font-weight: 700;
      font-size: 14px;
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* Hero Section */
    .hero {
      padding: 32px;
      background: linear-gradient(180deg, rgba(29, 185, 84, 0.4) 0%, rgba(18, 18, 18, 0) 100%);
      margin-bottom: 24px;
    }

    .hero-content {
      display: flex;
      align-items: flex-end;
      gap: 24px;
    }

    .hero-img {
      width: 232px;
      height: 232px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      border-radius: 4px;
      object-fit: cover;
    }

    .hero-text h1 {
      font-size: 72px;
      font-weight: 900;
      margin: 8px 0;
      letter-spacing: -2px;
    }

    .hero-text p {
      color: var(--spotify-text-dim);
      font-size: 14px;
    }

    /* Sections & Grids */
    .content-section {
      padding: 0 32px;
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 16px;
    }

    .section-header h2 { font-size: 24px; font-weight: 700; }
    .show-all {
      font-size: 12px;
      font-weight: 700;
      color: var(--spotify-text-dim);
      text-decoration: none;
    }
    .show-all:hover { text-decoration: underline; }

    .song-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 24px;
    }

    .song-card {
      background: #181818;
      padding: 16px;
      border-radius: 8px;
      transition: background-color 0.3s;
      cursor: pointer;
      position: relative;
    }

    .song-card:hover { background-color: #282828; }

    .card-img-container {
      position: relative;
      margin-bottom: 16px;
      aspect-ratio: 1;
    }

    .card-img {
      width: 100%;
      height: 100%;
      border-radius: 4px;
      object-fit: cover;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }

    .play-overlay {
      position: absolute;
      right: 8px;
      bottom: 8px;
      width: 48px;
      height: 48px;
      background: var(--spotify-green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-size: 20px;
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.3s;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }

    .song-card:hover .play-overlay {
      opacity: 1;
      transform: translateY(0);
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-artist {
      font-size: 14px;
      color: var(--spotify-text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Bottom Player */
    .player-bar {
      height: 90px;
      background: #181818;
      border-top: 1px solid #282828;
      display: flex;
      align-items: center;
      padding: 0 16px;
      z-index: 200;
    }

    .now-playing {
      width: 30%;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .now-playing-img {
      width: 56px;
      height: 56px;
      border-radius: 4px;
      object-fit: cover;
    }

    .now-playing-info {
      overflow: hidden;
    }

    .now-playing-title {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .now-playing-artist {
      font-size: 11px;
      color: var(--spotify-text-dim);
    }

    .player-controls {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .control-btns {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .control-btn {
      background: none;
      border: none;
      color: var(--spotify-text-dim);
      font-size: 16px;
      cursor: pointer;
      transition: color 0.2s, transform 0.1s;
    }

    .control-btn:hover { color: #fff; }
    .control-btn:active { transform: scale(0.9); }
    .btn-main-play {
      width: 32px;
      height: 32px;
      background: #fff;
      color: #000;
      border-radius: 50%;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-main-play:hover { transform: scale(1.06); }

    .progress-container {
      width: 100%;
      max-width: 600px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--spotify-text-dim);
    }

    .progress-bar {
      flex: 1;
      height: 4px;
      background: #4d4d4d;
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }

    .progress-fill {
      height: 100%;
      background: #fff;
      border-radius: 2px;
      width: 0%;
      position: relative;
    }

    .progress-bar:hover .progress-fill { background: var(--spotify-green); }

    .player-extra {
      width: 30%;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
    }

    .volume-bar {
      width: 100px;
      height: 4px;
      background: #4d4d4d;
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }

    .volume-fill {
      height: 100%;
      background: #fff;
      border-radius: 2px;
      width: 70%;
    }

    .volume-bar:hover .volume-fill { background: var(--spotify-green); }

    /* Modals & Overlays */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      padding: 20px;
    }

    .modal-content {
      background: #282828;
      width: 100%;
      max-width: 600px;
      border-radius: 8px;
      padding: 32px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: var(--spotify-text-dim);
      font-size: 24px;
      cursor: pointer;
    }

    .modal-close:hover { color: #fff; }

    /* Loading Screen */
    #loadingCard {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #333;
      border-top-color: var(--spotify-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Snowfall */
    .snowflake { 
      position: fixed; top: -10px; color: #fff; font-size: 1.5em; z-index: 10001; pointer-events: none;
      animation: snowfall linear forwards; opacity: 0.8;
    }
    @keyframes snowfall { 
      0% { transform: translateY(-10px) translateX(0); opacity: 1; } 
      100% { transform: translateY(100vh) translateX(20px); opacity: 0; } 
    }

    /* Modal Styles Refinement */
    .modal-content {
      background: #181818;
      border: 1px solid #282828;
      box-shadow: 0 15px 50px rgba(0,0,0,0.8);
    }
    .inp-dark {
      width: 100%; background: #282828; border: 1px solid #3e3e3e; color: #fff;
      padding: 12px 16px; border-radius: 4px; margin-bottom: 16px;
    }
    .inp-dark:focus { border-color: var(--spotify-green); }

    /* Mobile Nav */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 64px;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(20px);
      z-index: 150;
      justify-content: space-around;
      align-items: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .mobile-nav { display: flex; }
      .top-bar { padding: 0 16px; }
      .search-container { width: 150px; }
      .hero-content { flex-direction: column; align-items: center; text-align: center; }
      .hero-img { width: 180px; height: 180px; }
      .hero-text h1 { font-size: 36px; }
      .content-section { padding: 0 16px; }
      .now-playing-img { display: none; }
      .now-playing { width: 40%; }
      .player-extra { display: none; }
      .player-bar { bottom: 64px; height: 80px; padding-bottom: env(safe-area-inset-bottom); position: fixed; width: 100%; background: #000; border-top: 1px solid #181818; }
      .main-view { padding-bottom: 160px; }
    }

    /* Broadcast System */
    .sys-broadcast {
        position: fixed;
        top: -150px; 
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
        background: rgba(24, 24, 24, 0.95);
        border-left: 4px solid var(--spotify-green);
        border-radius: 8px;
        padding: 16px;
        z-index: 12000;
        box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(10px);
    }
    .sys-broadcast.active { top: 20px; }
    .sb-content { display: flex; align-items: flex-start; gap: 12px; }
    .sb-icon { font-size: 20px; color: var(--spotify-green); }
    .sb-text h4 { margin: 0; font-size: 14px; color: var(--spotify-green); text-transform: uppercase; letter-spacing: 1px; }
    .sb-text p { margin: 4px 0 0; font-size: 12px; color: #ddd; line-height: 1.4; }
    .sb-close { position: absolute; top: 10px; right: 10px; background: transparent; border: none; color: #666; cursor: pointer; }
    .sb-progress { width: 100%; height: 3px; background: #333; margin-top: 12px; border-radius: 2px; overflow: hidden; }
    .sb-bar { width: 100%; height: 100%; background: var(--spotify-green); transform-origin: left; }

    /* EQ Visualizer */
    .eq-container {
      display: flex;
      align-items: flex-end;
      gap: 3px;
      height: 30px;
    }
    .eq-bar {
      width: 4px;
      background: var(--spotify-green);
      height: 5px;
      border-radius: 2px;
      transition: height 0.2s;
    }
    .playing .eq-bar { animation: eq-wave 0.6s infinite ease-in-out; }
    .playing .eq-bar:nth-child(1) { animation-delay: 0.1s; }
    .playing .eq-bar:nth-child(2) { animation-delay: 0.3s; }
    .playing .eq-bar:nth-child(3) { animation-delay: 0.2s; }
    .playing .eq-bar:nth-child(4) { animation-delay: 0.4s; }
    @keyframes eq-wave { 0%, 100% { height: 5px; } 50% { height: 25px; } }

    /* Full EQ Mode */
    .modal-eq {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 300;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }
    .eq-visualizer-large {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 200px;
      margin-bottom: 48px;
    }
    .eq-bar-large {
      width: 12px;
      background: var(--spotify-green);
      height: 20px;
      border-radius: 6px;
      box-shadow: 0 0 20px rgba(29, 185, 84, 0.5);
    }
    .playing .eq-bar-large { animation: eq-wave-large 0.8s infinite ease-in-out; }
    @keyframes eq-wave-large { 0%, 100% { height: 20px; } 50% { height: 180px; } }
    #toast-container {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
    }

    .toast {
      background: var(--spotify-green);
      color: #000;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 700;
      margin-bottom: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Gacha Styles */
    .gacha-container {
      background: #181818;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }
    .gacha-wheel-container {
      width: 200px;
      height: 200px;
      margin: 20px auto;
      position: relative;
    }
    .gacha-wheel {
      width: 100%; height: 100%;
      border-radius: 50%;
      border: 8px solid #333;
      background: conic-gradient(from 0deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #8b00ff, #ff0000);
    }
    .gacha-spinning { animation: spin 2s cubic-bezier(0.1, 0, 0.1, 1) infinite; }
    .gacha-pointer {
      position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
      width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--accent);
      z-index: 5;
    }
    .gacha-button {
      background: var(--spotify-green);
      color: #000;
      border: none;
      padding: 12px 32px;
      border-radius: 500px;
      font-weight: 700;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="sysBroadcast" class="sys-broadcast">
    <button class="sb-close" onclick="closeBroadcast()"><i class="fas fa-times"></i></button>
    <div class="sb-content">
        <i class="fas fa-bullhorn sb-icon"></i>
        <div class="sb-text">
            <h4>Announcement</h4>
            <p id="sbMessage">Loading message...</p>
        </div>
    </div>
    <div class="sb-progress"><div id="sbBar" class="sb-bar"></div></div>
  </div>

  <div id="mtScreen" class="full-overlay" style="display: none; position: fixed; inset: 0; background: #000; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
    <i class="fas fa-tools" style="font-size: 64px; color: var(--spotify-green); margin-bottom: 24px;"></i>
    <h1>Server Maintenance</h1>
    <p style="color: var(--spotify-text-dim);">Kami sedang melakukan pembaruan sistem.<br>Mohon tunggu beberapa saat lagi.</p>
  </div>

  <div id="bannedScreen" class="full-overlay" style="display: none; position: fixed; inset: 0; background: #000; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
    <i class="fas fa-user-slash" style="font-size: 64px; color: var(--danger); margin-bottom: 24px;"></i>
    <h1 style="color: var(--danger);">Access Denied</h1>
    <p style="color: var(--spotify-text-dim);">Akun anda telah diblokir secara permanen oleh admin.</p>
  </div>

  <div id="loadingCard">
    <div class="spinner"></div>
    <p style="margin-top: 20px; color: var(--spotify-text-dim);">Memuat ExeMusic v3.2...</p>
  </div>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo-container">
        <img src="exemusicicon.png" alt="ExeMusic" onclick="location.reload()">
      </div>
      <nav class="nav-list">
        <a class="nav-item active" onclick="switchView('home')">
          <i class="fas fa-home"></i> <span>Home</span>
        </a>
        <a class="nav-item" onclick="switchView('search')">
          <i class="fas fa-search"></i> <span>Search</span>
        </a>
        <a class="nav-item" onclick="openProfile()">
          <i class="fas fa-layer-group"></i> <span>Library</span>
        </a>
      </nav>
      <nav class="nav-list" style="margin-top: auto;">
        <a class="nav-item" onclick="openEvent()">
          <i class="fas fa-star" style="color: var(--gold)"></i> <span>Ramadan Event</span>
        </a>
        <a class="nav-item" onclick="openKetupatShop()">
          <i class="fas fa-shopping-cart"></i> <span>Ketupat Shop</span>
        </a>
      </nav>
    </aside>

    <!-- Main View -->
    <main class="main-view" id="mainView">
      <header class="top-bar">
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" class="search-input" placeholder="Apa yang ingin kamu dengar?" id="searchInput" oninput="handleSearch()">
        </div>
        <div class="user-actions">
          <button class="btn-upgrade" onclick="openEvent()">Event Baru!</button>
          <button class="control-btn" onclick="openUpload()" title="Upload Lagu"><i class="fas fa-plus-circle" style="font-size: 20px;"></i></button>
          <button class="control-btn" onclick="openNotif()" title="Notifikasi" style="position: relative;">
            <i class="fas fa-bell" style="font-size: 20px;"></i>
            <span id="notifBadge" style="position: absolute; top: -5px; right: -5px; background: var(--danger); color: #fff; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: none; align-items: center; justify-content: center;">0</span>
          </button>
          <button class="control-btn" id="adminBtn" style="display: none;" onclick="location.href='adminv3.2.html'" title="Admin Panel"><i class="fas fa-shield-alt" style="color: var(--gold); font-size: 20px;"></i></button>
          <button class="user-profile-btn" id="userProfileBtn" onclick="openProfile()">
            <span id="topUsername">Login</span>
            <img src="exemusicicon.png" alt="User" class="user-avatar" id="topAvatar">
          </button>
        </div>
      </header>

      <!-- Hero Section -->
      <section class="hero" id="heroSection">
        <div class="hero-content">
          <img src="exemusicicon.png" alt="Featured" class="hero-img" id="heroImg">
          <div class="hero-text">
            <p>FEATURED PLAYLIST</p>
            <h1 id="heroTitle">ExeMusic v3.2</h1>
            <p id="heroDesc">Nikmati musik terbaik dari komunitas Executive Roleplay.</p>
          </div>
        </div>
      </section>

      <!-- Content Sections -->
      <div id="dynamicContent">
        <section class="content-section" id="popularSection" style="display: none;">
          <div class="section-header">
            <h2>Top 10 Populer</h2>
          </div>
          <div class="song-grid" id="popularGrid">
            <!-- Popular songs will be rendered here -->
          </div>
        </section>

        <section class="content-section">
          <div class="section-header">
            <h2>Semua Lagu</h2>
            <a href="#" class="show-all">Tampilkan semua</a>
          </div>
          <div class="song-grid" id="songGrid">
            <!-- Songs will be rendered here -->
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Bottom Player -->
  <footer class="player-bar">
    <div class="now-playing">
      <div style="position: relative;" onclick="toggleEQMode()">
        <img src="exemusicicon.png" alt="Song" class="now-playing-img" id="playerImg" onerror="this.src='exemusicicon.png'">
        <div id="miniEQ" class="eq-container" style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.5); padding: 2px; border-radius: 2px;">
          <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
        </div>
      </div>
      <div class="now-playing-info">
        <div class="now-playing-title" id="playerTitle">Pilih Lagu</div>
        <div class="now-playing-artist" id="playerArtist">Artist</div>
      </div>
      <button class="control-btn" style="margin-left: 10px;" id="btnFav" onclick="toggleFav()">
        <i class="far fa-heart"></i>
      </button>
    </div>

    <div class="player-controls">
      <div class="control-btns">
        <button class="control-btn" onclick="toggleShuffle()"><i class="fas fa-random" id="shuffleIcon"></i></button>
        <button class="control-btn" onclick="prev()"><i class="fas fa-step-backward"></i></button>
        <button class="control-btn btn-main-play" id="playBtn" onclick="togglePlay()">
          <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" onclick="next()"><i class="fas fa-step-forward"></i></button>
        <button class="control-btn" onclick="toggleRepeat()"><i class="fas fa-redo" id="repeatIcon"></i></button>
      </div>
      <div class="progress-container">
        <span id="curTime">0:00</span>
        <div class="progress-bar" id="progBar" onclick="seek(event)">
          <div class="progress-fill" id="progFill"></div>
        </div>
        <span id="durTime">0:00</span>
      </div>
    </div>

    <div class="player-extra">
      <button class="control-btn" onclick="openTutorial()"><i class="fas fa-info-circle"></i></button>
      <i class="fas fa-volume-up" style="font-size: 14px; color: var(--spotify-text-dim);"></i>
      <div class="volume-bar" id="volBar" onclick="setVol(event)">
        <div class="volume-fill" id="volFill"></div>
      </div>
    </div>
  </footer>

  <!-- Full EQ Mode Modal -->
  <div id="modalEQ" class="modal-eq">
    <button class="modal-close" onclick="toggleEQMode()" style="top: 40px; right: 40px;">&times;</button>
    <div class="eq-visualizer-large" id="largeEQ">
      <div class="eq-bar-large"></div><div class="eq-bar-large"></div><div class="eq-bar-large"></div><div class="eq-bar-large"></div><div class="eq-bar-large"></div>
      <div class="eq-bar-large"></div><div class="eq-bar-large"></div><div class="eq-bar-large"></div><div class="eq-bar-large"></div><div class="eq-bar-large"></div>
    </div>
    <div style="text-align: center;">
      <h1 id="eqTitle" style="font-size: 48px; margin-bottom: 8px;">Pilih Lagu</h1>
      <p id="eqArtist" style="color: var(--spotify-text-dim); font-size: 24px; margin-bottom: 40px;">Artist</p>
      <div class="control-btns" style="gap: 40px; justify-content: center;">
        <button class="control-btn" style="font-size: 32px;" onclick="prev()"><i class="fas fa-step-backward"></i></button>
        <button class="control-btn btn-main-play" style="width: 80px; height: 80px; font-size: 32px;" onclick="togglePlay()"><i class="fas fa-play" id="eqPlayIcon"></i></button>
        <button class="control-btn" style="font-size: 32px;" onclick="next()"><i class="fas fa-step-forward"></i></button>
      </div>
    </div>
  </div>

  <!-- Mobile Nav -->
  <nav class="mobile-nav">
    <a class="nav-item" onclick="switchView('home')"><i class="fas fa-home"></i></a>
    <a class="nav-item" onclick="switchView('search')"><i class="fas fa-search"></i></a>
    <a class="nav-item" onclick="openProfile()"><i class="fas fa-layer-group"></i></a>
    <a class="nav-item" onclick="openEvent()"><i class="fas fa-star" style="color: var(--gold)"></i></a>
  </nav>

  <!-- Modals -->
  <div class="modal" id="modalUpload" onclick="if(event.target==this)this.style.display='none'">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <h2 style="margin-bottom: 24px;">Upload / Request Lagu</h2>
      <input id="upTitle" class="inp-dark" placeholder="Judul Lagu">
      <input id="upUrl" class="inp-dark" placeholder="URL Audio (Direct Link)">
      <input id="upCover" class="inp-dark" placeholder="URL Cover Image (Opsional)">
      <p style="font-size: 11px; color: var(--spotify-text-dim); margin-bottom: 16px;">
        Lagu akan dikirim ke tim admin untuk diverifikasi sebelum tampil di publik.
      </p>
      <button class="gacha-button" style="width: 100%;" onclick="submitUpload()">Kirim Lagu</button>
    </div>
  </div>

  <div class="modal" id="modalNotif" onclick="if(event.target==this)this.style.display='none'">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2>Notifikasi</h2>
        <button onclick="clearAllNotif()" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 14px; font-weight: 700;">Hapus Semua</button>
      </div>
      <div id="notifList" style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Notifications here -->
        <p style="text-align: center; color: var(--spotify-text-dim);">Tidak ada notifikasi.</p>
      </div>
    </div>
  </div>

  <div class="modal" id="modalAuth" onclick="if(event.target==this)this.style.display='none'">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <h2 style="margin-bottom: 24px;">Login ke ExeMusic</h2>
      <button class="gacha-button" style="width: 100%; margin-bottom: 16px;" onclick="loginGoogle()">
        <i class="fab fa-google"></i> Masuk dengan Google
      </button>
      <p style="text-align: center; color: var(--spotify-text-dim); font-size: 12px;">
        Dengan masuk, kamu menyetujui Ketentuan Layanan ExeMusic.
      </p>
    </div>
  </div>

  <div class="modal" id="modalProfile" onclick="if(event.target==this)this.style.display='none'">
    <div class="modal-content" style="max-width: 800px;">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <div id="profileContent">
        <div style="display: flex; gap: 24px; align-items: flex-end; margin-bottom: 32px;">
          <img id="pAvatarImg" src="exemusicicon.png" style="width: 192px; height: 192px; border-radius: 50%; box-shadow: 0 8px 24px rgba(0,0,0,0.5); object-fit: cover;">
          <div>
            <p style="font-size: 12px; font-weight: 700;">PROFIL</p>
            <h1 id="pUsername" style="font-size: 48px; margin: 8px 0;">Username</h1>
            <div style="display: flex; gap: 16px; color: var(--spotify-text-dim); font-size: 14px; margin-bottom: 16px;">
              <span><b id="pFol" style="color: #fff;">0</b> Pengikut</span>
              <span><b id="pFollowing" style="color: #fff;">0</b> Mengikuti</span>
            </div>
            <button id="btnFollow" class="btn-upgrade" style="background: var(--spotify-green); color: #000; border: none; display: none;" onclick="toggleFollow()">Ikuti</button>
          </div>
        </div>
        
        <div style="border-top: 1px solid #333; padding-top: 24px;">
          <div style="display: flex; gap: 24px; margin-bottom: 24px;">
            <button class="btn-upgrade" onclick="switchProfileTab('posts')">Lagu Kamu</button>
            <button class="btn-upgrade" onclick="switchProfileTab('likes')">Disukai</button>
            <button class="btn-upgrade" style="background: var(--danger); border: none;" onclick="auth.signOut(); location.reload();">Logout</button>
          </div>
          <div id="profileTabContent" class="song-grid">
            <!-- Profile songs will be here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal" id="modalEvent" onclick="if(event.target==this)closeEventModal()">
    <div class="modal-content" style="background: linear-gradient(135deg, #121212 0%, #1a1a1a 100%); border: 1px solid var(--accent);">
      <button class="modal-close" onclick="closeEventModal()">&times;</button>
      <div style="text-align: center;">
        <h2 style="color: var(--accent); margin-bottom: 8px;">Ramadan Event 1447H</h2>
        <p style="color: var(--spotify-text-dim); margin-bottom: 24px;">Kumpulkan ketupat dan tukarkan dengan hadiah menarik!</p>
        
        <div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 32px;">
          <div style="background: #181818; padding: 16px; border-radius: 8px; min-width: 80px;">
            <h3 id="cDays">0</h3><p style="font-size: 10px;">HARI</p>
          </div>
          <div style="background: #181818; padding: 16px; border-radius: 8px; min-width: 80px;">
            <h3 id="cHours">0</h3><p style="font-size: 10px;">JAM</p>
          </div>
          <div style="background: #181818; padding: 16px; border-radius: 8px; min-width: 80px;">
            <h3 id="cMins">0</h3><p style="font-size: 10px;">MENIT</p>
          </div>
        </div>

        <div style="background: rgba(29, 185, 84, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
          <p>Ketupat Kamu: <b id="eidKetVal" style="color: var(--accent); font-size: 24px;">0</b> ðŸ’ </p>
          <button id="claimBtn" class="gacha-button" style="margin-top: 16px;" onclick="claimTrialVip1d()">Claim Free VIP 1 Day</button>
        </div>

        <button class="btn-upgrade" onclick="openKetupatShop()">Buka Toko Ketupat</button>
      </div>
    </div>
  </div>

  <!-- Shop Modal -->
  <div class="modal" id="modalKetupatShop" onclick="if(event.target==this)this.style.display='none'">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <h2 style="text-align: center; margin-bottom: 24px;">Toko Ketupat</h2>
      
      <!-- Gacha Section -->
      <div class="gacha-container" style="margin-bottom: 32px;">
        <h3>ðŸŽ° Gacha Ketupat</h3>
        <p style="font-size: 12px; color: var(--spotify-text-dim);">100 Ketupat per spin</p>
        <div class="gacha-wheel-container">
          <div class="gacha-wheel" id="gachaWheel"></div>
          <div class="gacha-pointer"></div>
        </div>
        <button class="gacha-button" id="gachaBtn" onclick="spinGacha()">SPIN SEKARANG</button>
        <div id="gachaResult" style="margin-top: 16px; display: none;">
          <h4 id="gachaResultTitle" style="color: var(--accent);"></h4>
          <p id="gachaResultDesc" style="font-size: 14px;"></p>
        </div>
      </div>

      <div class="song-grid" style="grid-template-columns: 1fr 1fr;">
        <div style="background: #181818; padding: 16px; border-radius: 8px;">
          <h4>VIP Trial</h4>
          <p style="font-size: 12px; color: var(--spotify-text-dim);">100ðŸ’  / hari</p>
          <select id="vipDaysSel" style="width: 100%; background: #333; color: #fff; border: none; padding: 8px; margin: 12px 0;">
            <option value="1">1 Hari</option>
            <option value="3">3 Hari</option>
            <option value="7">7 Hari</option>
          </select>
          <button class="btn-upgrade" style="width: 100%;" onclick="exchangeVipTrial()">Beli VIP</button>
        </div>
        <div style="background: #181818; padding: 16px; border-radius: 8px;">
          <h4>Tag Custom</h4>
          <p style="font-size: 12px; color: var(--spotify-text-dim);">500ðŸ’ </p>
          <input type="text" id="customTagInp" placeholder="Teks Tag" style="width: 100%; background: #333; color: #fff; border: none; padding: 8px; margin: 12px 0;">
          <button class="btn-upgrade" style="width: 100%;" onclick="exchangeTag(document.getElementById('customTagInp').value, 500)">Beli Tag</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCVJYSR4nHeoRA9WTMZa3-2xliKQRrd5g4",
      authDomain: "exemusic-execuriverp.firebaseapp.com",
      databaseURL: "https://exemusic-execuriverp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "exemusic-execuriverp",
      storageBucket: "exemusic-execuriverp.firebasestorage.app",
      messagingSenderId: "722057744401",
      appId: "1:722057744401:web:cd6a6a103692059bda61b0",
      measurementId: "G-2P56Y7QQ18"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Global Variables
    let songs = [];
    let i = 0;
    let audio = new Audio();
    let userData = null;
    let fav = JSON.parse(localStorage.getItem('exeFav') || '[]');
    let isShuffle = false;
    let isRepeat = false;
    let isEQActive = false;
    let eqInterval = null;

    // Initialize App
    window.onload = () => {
      loadSongs();
      initAuth();
      initBroadcast();
      initMaintenance();
      initSnowfall();
      setTimeout(() => {
        const loading = document.getElementById('loadingCard');
        if(loading) loading.style.display = 'none';
      }, 2000);
    };

    function loadSongs() {
      db.ref('songs').on('value', snap => {
        const val = snap.val();
        if(val) {
          songs = Object.keys(val).map(k => ({...val[k], key: k}));
          renderSongs(songs);
          updateHero();
          updatePopular();
        }
      });
    }

    function renderSongs(list) {
      const grid = document.getElementById('songGrid');
      if(!grid) return;
      grid.innerHTML = list.map((s, idx) => `
        <div class="song-card" onclick="setup(${songs.indexOf(s)})">
          <div class="card-img-container">
            <img src="${s.cover || 'exemusicicon.png'}" class="card-img" onerror="this.src='exemusicicon.png'">
            <div class="play-overlay"><i class="fas fa-play"></i></div>
          </div>
          <div class="card-title">${s.title}</div>
          <div class="card-artist" onclick="event.stopPropagation(); viewProfile('${s.uid}')">@${s.by || 'Unknown'}</div>
        </div>
      `).join('');
    }

    function updateHero() {
      if(songs.length > 0) {
        const randomSong = songs[Math.floor(Math.random() * songs.length)];
        const heroImg = document.getElementById('heroImg');
        const heroTitle = document.getElementById('heroTitle');
        const heroDesc = document.getElementById('heroDesc');
        if(heroImg) heroImg.src = randomSong.cover || 'exemusicicon.png';
        if(heroTitle) heroTitle.textContent = randomSong.title;
        if(heroDesc) heroDesc.textContent = "Populer saat ini oleh @" + (randomSong.by || 'Unknown');
      }
    }

    function updatePopular() {
      const list = document.getElementById('popularList');
      if(!list) return;
      // For now, just show top 10 from the main list (or filter by plays if available)
      const top10 = songs.slice(0, 10);
      list.innerHTML = top10.map((s, idx) => `
        <div class="popular-item" onclick="setup(${songs.indexOf(s)})">
          <span class="popular-rank">${idx + 1}</span>
          <img src="${s.cover || 'exemusicicon.png'}" class="popular-img" onerror="this.src='exemusicicon.png'">
          <div class="popular-info">
            <div class="popular-title">${s.title}</div>
            <div class="popular-artist">@${s.by || 'Unknown'}</div>
          </div>
          <div class="popular-plays"><i class="fas fa-play" style="font-size: 10px; margin-right: 4px;"></i> ${s.plays || 0}</div>
        </div>
      `).join('');
    }

    function initAuth() {
      auth.onAuthStateChanged(u => {
        if(u) {
          db.ref('users/' + u.uid).on('value', snap => {
            userData = snap.val();
            if(userData) {
              if(userData.banned) {
                document.getElementById('bannedScreen').style.display = 'flex';
                auth.signOut();
                return;
              }
              document.getElementById('topUsername').textContent = userData.username;
              document.getElementById('topAvatar').src = userData.avatar || "exemusicicon.png";
              updateKetupatUI(userData.ketupat || 0);
              
              // Admin Check
              const adminBtn = document.getElementById('adminBtn');
              if(adminBtn) adminBtn.style.display = (userData.role === 'admin') ? 'flex' : 'none';
              
              // Notif Check
              checkNotifs(u.uid);
            }
          });
        } else {
          document.getElementById('topUsername').textContent = "Login";
          document.getElementById('topAvatar').src = "exemusicicon.png";
          const adminBtn = document.getElementById('adminBtn');
          if(adminBtn) adminBtn.style.display = 'none';
        }
      });
    }

    function checkNotifs(uid) {
      db.ref('notifications/' + uid).on('value', snap => {
        const val = snap.val();
        const badge = document.getElementById('notifBadge');
        if(val) {
          const count = Object.keys(val).length;
          badge.textContent = count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      });
    }

    function loginGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).then(res => {
        const u = res.user;
        db.ref('users/' + u.uid).get().then(snap => {
          if(!snap.exists()) {
            db.ref('users/' + u.uid).set({
              username: u.displayName,
              avatar: u.photoURL,
              ketupat: 0,
              role: 'user',
              timestamp: Date.now()
            });
          }
        });
        closeModal();
      }).catch(err => showToast(err.message, 'error'));
    }

    // Music Logic
    function setup(idx) {
      i = idx;
      const s = songs[i];
      if(!s) return;
      audio.src = s.url;
      audio.play();
      
      document.getElementById('playerTitle').textContent = s.title;
      document.getElementById('playerArtist').textContent = "@" + (s.by || 'Unknown');
      document.getElementById('playerImg').src = s.cover || 'exemusicicon.png';
      document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>';
      
      // EQ Modal update
      document.getElementById('eqTitle').textContent = s.title;
      document.getElementById('eqArtist').textContent = "@" + (s.by || 'Unknown');
      document.getElementById('eqPlayIcon').className = 'fas fa-pause';

      updateFavIcon();
      showToast("Memutar: " + s.title);
      document.title = "â–¶ " + s.title + " - ExeMusic";

      // Increment Plays
      if(s.key) db.ref('songs/' + s.key + '/plays').transaction(c => (c || 0) + 1);
    }

    function togglePlay() {
      if(audio.paused) {
        audio.play();
        document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>';
        document.getElementById('eqPlayIcon').className = 'fas fa-pause';
      } else {
        audio.pause();
        document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>';
        document.getElementById('eqPlayIcon').className = 'fas fa-play';
      }
    }

    function next() {
      if(isShuffle) i = Math.floor(Math.random() * songs.length);
      else i = (i + 1) % songs.length;
      setup(i);
    }

    function prev() {
      i = (i - 1 + songs.length) % songs.length;
      setup(i);
    }

    audio.ontimeupdate = () => {
      const cur = audio.currentTime;
      const dur = audio.duration;
      if(dur) {
        const per = (cur / dur) * 100;
        document.getElementById('progFill').style.width = per + "%";
        document.getElementById('curTime').textContent = fmtTime(cur);
        document.getElementById('durTime').textContent = fmtTime(dur);
      }
    };

    audio.onended = () => {
      if(isRepeat) audio.play();
      else next();
    };

    function fmtTime(s) {
      let m = Math.floor(s / 60);
      let sec = Math.floor(s % 60);
      return m + ":" + (sec < 10 ? "0" + sec : sec);
    }

    function seek(e) {
      const rect = document.getElementById('progBar').getBoundingClientRect();
      const per = (e.clientX - rect.left) / rect.width;
      audio.currentTime = per * audio.duration;
    }

    function setVol(e) {
      const rect = document.getElementById('volBar').getBoundingClientRect();
      const per = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1);
      audio.volume = per;
      document.getElementById('volFill').style.width = (per * 100) + "%";
    }

    function toggleShuffle() {
      isShuffle = !isShuffle;
      document.getElementById('shuffleIcon').style.color = isShuffle ? 'var(--spotify-green)' : 'inherit';
      showToast(isShuffle ? "Shuffle Aktif" : "Shuffle Mati");
    }

    function toggleRepeat() {
      isRepeat = !isRepeat;
      document.getElementById('repeatIcon').style.color = isRepeat ? 'var(--spotify-green)' : 'inherit';
      showToast(isRepeat ? "Repeat Aktif" : "Repeat Mati");
    }

    function toggleFav() {
      const s = songs[i];
      if(!s) return;
      const url = s.url;
      if(fav.includes(url)) {
        fav = fav.filter(u => u !== url);
        showToast("Dihapus dari Favorit");
      } else {
        fav.push(url);
        showToast("Ditambah ke Favorit");
      }
      localStorage.setItem('exeFav', JSON.stringify(fav));
      updateFavIcon();
    }

    function updateFavIcon() {
      const icon = document.getElementById('btnFav').querySelector('i');
      if(fav.includes(songs[i]?.url)) {
        icon.className = 'fas fa-heart';
        icon.style.color = 'var(--spotify-green)';
      } else {
        icon.className = 'far fa-heart';
        icon.style.color = 'inherit';
      }
    }

    // Search
    function handleSearch() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const filtered = songs.filter(s => s.title.toLowerCase().includes(q) || (s.by && s.by.toLowerCase().includes(q)));
      renderSongs(filtered);
    }

    // EQ Mode
    function toggleEQMode() {
      const modal = document.getElementById('modalEQ');
      isEQActive = !isEQActive;
      modal.style.display = isEQActive ? 'flex' : 'none';
      
      if(isEQActive) {
        startEQAnimation();
      } else {
        stopEQAnimation();
      }
    }

    function startEQAnimation() {
      const bars = document.querySelectorAll('.eq-bar, .eq-bar-large');
      eqInterval = setInterval(() => {
        bars.forEach(bar => {
          const h = Math.random() * 100;
          bar.style.height = h + "%";
        });
      }, 100);
    }

    function stopEQAnimation() {
      clearInterval(eqInterval);
      const bars = document.querySelectorAll('.eq-bar, .eq-bar-large');
      bars.forEach(bar => bar.style.height = "20%");
    }

    // Broadcast
    function initBroadcast() {
      db.ref('broadcast').on('value', snap => {
        const b = snap.val();
        if(b && b.active) {
          const el = document.getElementById('sysBroadcast');
          document.getElementById('bcTitle').textContent = b.title || "PENGUMUMAN";
          document.getElementById('bcMsg').textContent = b.message || "";
          el.style.top = '20px';
          setTimeout(() => el.style.top = '-150px', 8000);
        }
      });
    }

    // Maintenance
    function initMaintenance() {
      db.ref('settings/maintenance').on('value', snap => {
        if(snap.val() === true) {
          document.getElementById('maintenanceScreen').style.display = 'flex';
        } else {
          document.getElementById('maintenanceScreen').style.display = 'none';
        }
      });
    }

    // Snowfall
    function initSnowfall() {
      db.ref('settings/snowfall').on('value', snap => {
        if(snap.val() === true) {
          startSnow();
        } else {
          stopSnow();
        }
      });
    }

    let snowInterval = null;
    function startSnow() {
      if(snowInterval) return;
      snowInterval = setInterval(() => {
        const s = document.createElement('div');
        s.className = 'snowflake';
        s.innerHTML = 'â„';
        s.style.left = Math.random() * 100 + 'vw';
        s.style.animationDuration = (Math.random() * 3 + 2) + 's';
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 5000);
      }, 300);
    }
    function stopSnow() {
      clearInterval(snowInterval);
      snowInterval = null;
      document.querySelectorAll('.snowflake').forEach(s => s.remove());
    }

    // Modals & Views
    function switchView(view) {
      document.getElementById('heroSection').style.display = (view === 'home') ? 'block' : 'none';
      if(view === 'search') document.getElementById('searchInput').focus();
    }

    function closeModal() {
      document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }

    function openProfile() {
      if(!auth.currentUser) return document.getElementById('modalAuth').style.display = 'flex';
      viewProfile(auth.currentUser.uid);
    }

    let viewingUid = null;
    function viewProfile(uid) {
      viewingUid = uid;
      document.getElementById('modalProfile').style.display = 'flex';
      switchProfileTab('posts');
      
      db.ref('users/' + uid).once('value', snap => {
        const u = snap.val();
        if(!u) return;
        
        document.getElementById('pUsername').textContent = u.username;
        document.getElementById('pAvatarImg').src = u.avatar || "exemusicicon.png";
        document.getElementById('pFol').textContent = u.followers ? Object.keys(u.followers).length : 0;
        document.getElementById('pFollowing').textContent = u.following ? Object.keys(u.following).length : 0;
        
        const btnFollow = document.getElementById('btnFollow');
        if(auth.currentUser && uid !== auth.currentUser.uid) {
          btnFollow.style.display = 'block';
          if(u.followers && u.followers[auth.currentUser.uid]) {
            btnFollow.textContent = 'Mengikuti';
            btnFollow.style.background = '#333';
            btnFollow.style.color = '#fff';
          } else {
            btnFollow.textContent = 'Ikuti';
            btnFollow.style.background = 'var(--spotify-green)';
            btnFollow.style.color = '#000';
          }
        } else {
          btnFollow.style.display = 'none';
        }
      });
    }

    function toggleFollow() {
      if(!auth.currentUser) return showToast("Login dulu!");
      const myUid = auth.currentUser.uid;
      const targetUid = viewingUid;
      if(myUid === targetUid) return;
      
      db.ref('users/' + targetUid + '/followers/' + myUid).get().then(snap => {
        if(snap.exists()) {
          db.ref('users/' + targetUid + '/followers/' + myUid).remove();
          db.ref('users/' + myUid + '/following/' + targetUid).remove();
          showToast("Berhenti mengikuti");
        } else {
          db.ref('users/' + targetUid + '/followers/' + myUid).set(true);
          db.ref('users/' + myUid + '/following/' + targetUid).set(true);
          showToast("Mulai mengikuti");
        }
        viewProfile(targetUid);
      });
    }

    function switchProfileTab(tab) {
      const grid = document.getElementById('profileTabContent');
      let list = [];
      if(tab === 'posts') list = songs.filter(s => s.uid === viewingUid);
      else list = songs.filter(s => fav.includes(s.url));
      
      if(list.length === 0) {
        grid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--spotify-text-dim); padding: 40px;">Belum ada lagu.</p>`;
        return;
      }

      grid.innerHTML = list.map(s => `
        <div class="song-card" onclick="setup(${songs.indexOf(s)}); closeModal()">
          <div class="card-img-container">
            <img src="${s.cover || 'exemusicicon.png'}" class="card-img" onerror="this.src='exemusicicon.png'">
            <div class="play-overlay"><i class="fas fa-play"></i></div>
          </div>
          <div class="card-title">${s.title}</div>
          <div class="card-artist">@${s.by || 'Unknown'}</div>
        </div>
      `).join('');
    }

    function openEvent() {
      document.getElementById('modalEvent').style.display = 'flex';
      startEventCountdown();
    }

    function openKetupatShop() {
      document.getElementById('modalKetupatShop').style.display = 'flex';
    }

    function openUpload() {
      if(!auth.currentUser) return document.getElementById('modalAuth').style.display = 'flex';
      document.getElementById('modalUpload').style.display = 'flex';
    }

    function openNotif() {
      if(!auth.currentUser) return document.getElementById('modalAuth').style.display = 'flex';
      document.getElementById('modalNotif').style.display = 'flex';
      loadNotifs();
    }

    function loadNotifs() {
      const list = document.getElementById('notifList');
      db.ref('notifications/' + auth.currentUser.uid).once('value', snap => {
        const val = snap.val();
        if(val) {
          list.innerHTML = Object.keys(val).map(k => `
            <div style="background: #282828; padding: 12px; border-radius: 4px;">
              <p style="font-size: 14px;">${val[k].message}</p>
              <span style="font-size: 10px; color: var(--spotify-text-dim);">${new Date(val[k].timestamp).toLocaleString()}</span>
            </div>
          `).join('');
        } else {
          list.innerHTML = '<p style="text-align: center; color: var(--spotify-text-dim);">Tidak ada notifikasi.</p>';
        }
      });
    }

    function clearAllNotif() {
      if(!auth.currentUser) return;
      db.ref('notifications/' + auth.currentUser.uid).remove();
      loadNotifs();
    }

    function submitUpload() {
      const title = document.getElementById('upTitle').value;
      const url = document.getElementById('upUrl').value;
      const cover = document.getElementById('upCover').value;
      
      if(!title || !url) return showToast("Judul dan URL wajib diisi!", "warning");
      
      db.ref('requests').push({
        title, url, cover,
        uid: auth.currentUser.uid,
        by: userData.username,
        timestamp: Date.now(),
        status: 'pending'
      }).then(() => {
        showToast("Lagu berhasil dikirim ke admin!", "success");
        closeModal();
      });
    }

    // Event Logic
    function startEventCountdown() {
      const target = new Date('2026-03-20T00:00:00Z').getTime();
      if(window._eidInterval) clearInterval(window._eidInterval);
      window._eidInterval = setInterval(() => {
        const d = target - Date.now();
        if(d <= 0) {
          clearInterval(window._eidInterval);
          return;
        }
        document.getElementById('cDays').textContent = Math.floor(d/86400000);
        document.getElementById('cHours').textContent = Math.floor((d%86400000)/3600000);
        document.getElementById('cMins').textContent = Math.floor((d%3600000)/60000);
      }, 1000);
    }

    function claimTrialVip1d() {
      if(!auth.currentUser) return showToast("Login dulu!");
      db.ref('users/' + auth.currentUser.uid + '/claimedVipTrial').get().then(snap => {
        if(snap.exists()) return showToast("Kamu sudah klaim!", "warning");
        db.ref('users/' + auth.currentUser.uid).update({
          role: 'vip',
          vipUntil: Date.now() + 86400000,
          claimedVipTrial: true
        }).then(() => showToast("VIP 1 Hari diklaim!", "success"));
      });
    }

    function spinGacha() {
      if(!auth.currentUser) return showToast("Login dulu!");
      if((userData.ketupat || 0) < 100) return showToast("Ketupat tidak cukup!");
      
      const btn = document.getElementById('gachaBtn');
      const wheel = document.getElementById('gachaWheel');
      btn.disabled = true;
      wheel.classList.add('gacha-spinning');
      
      setTimeout(() => {
        wheel.classList.remove('gacha-spinning');
        btn.disabled = false;
        
        const prizes = [
          { name: 'Cashback 100ðŸ’ ', type: 'cashback', val: 100 },
          { name: 'VIP 1 Hari', type: 'vip', val: 1 },
          { name: 'Tag Legend', type: 'tag', val: 'LEGEND' },
          { name: 'Jackpot 500ðŸ’ ', type: 'cashback', val: 500 }
        ];
        const prize = prizes[Math.floor(Math.random() * prizes.length)];
        
        const updates = { ketupat: userData.ketupat - 100 + (prize.type === 'cashback' ? prize.val : 0) };
        if(prize.type === 'tag') updates.tag = prize.val;
        if(prize.type === 'vip') updates.vipUntil = (userData.vipUntil || Date.now()) + 86400000;
        
        db.ref('users/' + auth.currentUser.uid).update(updates);
        
        document.getElementById('gachaResult').style.display = 'block';
        document.getElementById('gachaResultTitle').textContent = prize.name;
        showToast("ðŸŽ° Kamu dapat: " + prize.name);
      }, 2000);
    }

    function updateKetupatUI(val) {
      const el = document.getElementById('eidKetVal');
      if(el) el.textContent = val;
    }

    function showToast(m, type='info') {
      const container = document.getElementById('toast-container');
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = m;
      container.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    function openTutorial() {
      Swal.fire({
        title: 'Tutorial ExeMusic',
        html: `<div style="text-align: left; color: #fff;">
          <p>1. <b>Cari</b> lagu di bar pencarian.</p>
          <p>2. <b>Klik</b> kartu lagu untuk memutar.</p>
          <p>3. <b>Event</b>: Kumpulkan ketupat setiap jam!</p>
          <p>4. <b>EQ Mode</b>: Klik foto lagu di player bar.</p>
        </div>`,
        background: '#181818', color: '#fff', confirmButtonColor: '#1DB954'
      });
    }
  </script>
</body>
</html>
