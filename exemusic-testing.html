<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
  /* Tambahan Style untuk Admin & Login */
  .admin-badge { background: #ff4444; font-size: 10px; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }
  .btn-auth { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
  .btn-google { background: white; color: black; }
  .panel-admin { display: none; background: #222; border-radius: 15px; padding: 15px; margin-top: 10px; }
  .log-item { font-size: 11px; border-bottom: 1px solid #333; padding: 5px 0; color: #aaa; }
</style>

<div class="modal" id="modalAuth">
  <div class="sheet">
    <h3 style="text-align:center; margin-bottom:15px">Login ExeMusic</h3>
    <div id="authContent">
      <button class="btn-auth btn-google" onclick="loginGoogle()">Login with Google</button>
    </div>
    <div id="setupUsername" style="display:none">
      <input id="newUsername" placeholder="Username (4-10 huruf)" maxlength="10" style="width:100%; padding:12px; margin-bottom:10px; background:#222; color:white; border:none; border-radius:10px">
      <input id="newPass" type="password" placeholder="Password Database" style="width:100%; padding:12px; margin-bottom:15px; background:#222; color:white; border:none; border-radius:10px">
      <button onclick="saveUserDetail()" class="btn-auth" style="background:var(--accent)">SIMPAN AKUN</button>
    </div>
  </div>
</div>

<div class="modal" id="modalAdmin">
  <div class="sheet">
    <h3>Admin Panel</h3>
    <button onclick="toggleMT()" id="btnMT" style="padding:10px; margin:10px 0; width:100%">Toggle MT Mode</button>
    <div id="adminLogs" style="max-height: 200px; overflow: auto; background: #000; padding: 10px;"></div>
    <button onclick="this.parentElement.parentElement.style.display='none'" style="margin-top:10px; width:100%">Tutup</button>
  </div>
</div>

<script>
  // CONFIGURASI FIREBASE (Ganti dengan milikmu)
  const firebaseConfig = {
    apiKey: "AIzaSyCVJYSR4nHeoRA9WTMZa3-2xliKQRrd5g4",
    authDomain: "exemusic-execuriverp.firebaseapp.com",
    databaseURL: "https://exemusic-execuriverp-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "exemusic-execuriverp",
    storageBucket: "exemusic-execuriverp.firebasestorage.app",
    messagingSenderId: "722057744401",
    appId: "1:722057744401:web:cd6a6a103692059bda61b0"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  let userData = null;
  let isMT = false;

  // 1. MONITORING AUTH & DATABASE
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      const snapshot = await db.ref('users/' + user.uid).get();
      if (snapshot.exists()) {
        userData = snapshot.val();
        document.getElementById('modalAuth').style.display = 'none';
        checkAdmin();
      } else {
        document.getElementById('modalAuth').style.display = 'block';
        document.getElementById('authContent').style.display = 'none';
        document.getElementById('setupUsername').style.display = 'block';
      }
    }
  });

  // 2. FUNGSI ADD SONG DENGAN VALIDASI KETAT
  async function addSong() {
    if (!userData) return msg("Login dulu bos!");
    
    // Check Cooldown 1 Jam
    const now = Date.now();
    if (userData.lastUpload && now - userData.lastUpload < 3600000) {
      const sisa = Math.ceil((3600000 - (now - userData.lastUpload)) / 60000);
      return msg(`Tunggu ${sisa} menit lagi!`);
    }

    const title = document.getElementById('rLagu').value;
    const url = document.getElementById('rUrl').value;

    // Validasi top4top
    if (!url.includes("top4top")) {
      msg("WAJIB TOP4TOP! Akun terancam BANNED.");
      return;
    }

    msg("Memeriksa durasi...");
    const tempAudio = new Audio(url);
    tempAudio.addEventListener('loadedmetadata', async function() {
      const durationInMinutes = tempAudio.duration / 60;

      if (durationInMinutes > 120) {
        msg("Max 120 Menit!");
        return;
      }

      // Lolos Validasi -> Push ke Firebase
      const songData = {
        title: title,
        url: url,
        by: userData.username,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };

      try {
        await db.ref('songs').push(songData);
        await db.ref('users/' + currentUser.uid).update({ lastUpload: now });
        writeLog(`${userData.username} menambahkan lagu: ${title}`);
        msg("Lagu Berhasil Ditambahkan!");
        document.getElementById('modalReq').style.display = 'none';
      } catch (e) {
        msg("Gagal Upload!");
      }
    });
    
    tempAudio.addEventListener('error', () => msg("URL Mati atau Tidak Valid!"));
  }

  // 3. FITUR ADMIN & LOGS
  function checkAdmin() {
    if (userData.role === 'admin') {
      const btn = document.createElement('button');
      btn.innerHTML = "ðŸ›¡ï¸";
      btn.onclick = () => {
        loadLogs();
        document.getElementById('modalAdmin').style.display = 'block';
      };
      document.querySelector('.footer').appendChild(btn);
    }
  }

  function writeLog(text) {
    db.ref('logs').push({
      msg: text,
      time: new Date().toLocaleString()
    });
  }

  function loadLogs() {
    db.ref('logs').limitToLast(10).on('value', snap => {
      let html = '';
      snap.forEach(child => {
        html = `<div class="log-item">[${child.val().time}] ${child.val().msg}</div>` + html;
      });
      document.getElementById('adminLogs').innerHTML = html;
    });
  }

  // 4. SYNC REALTIME DATABASE KE UI
  db.ref('songs').on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      songs = Object.keys(data).map(key => ({
        ...data[key],
        id: key,
        by: data[key].by // Tetap menampilkan siapa yang post
      }));
      // Jika playlist kosong/awal, load lagu pertama
      if (songs.length > 0 && audio.src === "") setup(0, false);
    }
  });

  // 5. HELPER UNTUK LOGIN
  function loginGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  }

  async function saveUserDetail() {
    const user = auth.currentUser;
    const username = document.getElementById('newUsername').value.trim();
    const pass = document.getElementById('newPass').value;

    if (username.length < 4 || username.length > 10) return msg("Username 4-10 Karakter!");
    if (pass.length < 6) return msg("Password min 6 Karakter!");

    await db.ref('users/' + user.uid).set({
      username: username,
      password: pass, // Disimpan terenkripsi otomatis oleh Firebase (Security Rules)
      role: 'user',
      lastUpload: 0
    });
    location.reload();
  }

  // Override fungsi openReq yang lama
  function openReq() { 
    if(!currentUser) {
      document.getElementById('modalAuth').style.display = 'block';
    } else {
      document.getElementById('modalReq').style.display='block'; 
      // Ganti text tombol kirim
      const btn = document.querySelector('#modalReq button');
      btn.textContent = "ADD SONG";
      btn.onclick = addSong;
      // Sembunyikan input nama karena sudah otomatis pakai username
      document.getElementById('rNama').style.display = 'none';
    }
  }
</script>
