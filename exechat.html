<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>ExeChat | Secure Database Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #09090b; --panel: #111114; --main: #3b82f6; --admin-color: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #e4e4e7; font-family: 'Inter', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: fixed; width: 100%; }
        header { background: #0f0f14; padding: 15px; border-bottom: 2px solid #222; text-align: center; font-weight: 900; color: var(--main); font-size: 1.4rem; letter-spacing: 2px; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 16px; max-width: 85%; font-size: 14px; line-height: 1.5; animation: fadeIn 0.3s ease; }
        .warga { background: var(--panel); align-self: flex-start; border: 1px solid #27272a; border-bottom-left-radius: 2px; }
        .admin { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--admin-color); align-self: flex-start; border-bottom-left-radius: 2px; }
        .tag { font-size: 10px; font-weight: 800; display: block; margin-bottom: 4px; text-transform: uppercase; }
        .anno-card { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); padding: 16px; border-radius: 12px; border-left: 6px solid #fff; margin: 10px 0; }
        .footer { background: #0c0c0e; border-top: 1px solid #222; padding: 12px 12px 30px 12px; }
        .input-row { display: flex; gap: 10px; max-width: 900px; margin: 0 auto; width: 100%; }
        input { flex: 1; padding: 14px; border-radius: 12px; border: 1px solid #333; background: #000; color: white; outline: none; font-size: 16px; }
        button { background: var(--main); color: white; border: none; padding: 0 20px; border-radius: 12px; font-weight: 800; cursor: pointer; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header id="chat-title">ExeChat</header>
<div id="chat-box"></div>

<div class="footer">
    <div class="input-row">
        <input type="text" id="userMsg" placeholder="Ketik pesan..." autocomplete="off">
        <button id="btnSend" onclick="handleSend()">SEND</button>
    </div>
</div>

<script>
    // === 1. CONFIG FIREBASE ===
    const firebaseConfig = {
        apiKey: "AIzaSyCl4ei8kfMaBoQEokFE5FlkPvz-NdEhQXw",
        authDomain: "exeai-eefc8.firebaseapp.com",
        databaseURL: "https://exeai-eefc8-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "exeai-eefc8",
        storageBucket: "exeai-eefc8.firebasestorage.app",
        messagingSenderId: "1013428002517",
        appId: "1:1013428002517:web:6e3e07a810167c97bb8c5c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === 2. SETTINGS ===
    let remotePW = ""; // Password akan diambil dari database
    let myName = "someone" + Math.floor(1000 + Math.random() * (99999-1000));
    let isAdmin = false;
    let isLocked = false;

    // Ambil password admin dari database secara realtime
    db.ref("admin_config/password").on("value", (snapshot) => {
        remotePW = snapshot.val();
    });

    function handleSend() {
        const input = document.getElementById('userMsg');
        const text = input.value.trim();
        if (!text) return;

        // Login Admin
        if (text.startsWith("/login ")) {
            const inputEncoded = btoa(text.replace("/login ", ""));
            if (inputEncoded === remotePW) {
                isAdmin = true;
                myName = "Admin Hexky";
                alert("ðŸ‘‘ Database Verified: Admin Access Granted!");
            } else { alert("âŒ Wrong Password!"); }
            input.value = ""; return;
        }

        if (isLocked && !isAdmin) {
            alert("âš ï¸ Chat Locked!"); return;
        }

        if (isAdmin) {
            if (text === "/clearchat") { db.ref("messages").remove(); input.value = ""; return; }
            if (text === "/stopchat") { db.ref("room_status").set({ locked: !isLocked }); input.value = ""; return; }
            if (text.startsWith("/announcement ")) {
                db.ref("messages").push({ type: "anno", nama: "Admin Hexky", pesan: text.replace("/announcement ", ""), timestamp: firebase.database.ServerValue.TIMESTAMP });
                input.value = ""; return;
            }
        }

        // Cek Link (Hanya Admin yang boleh)
        if (!isAdmin && text.includes("http")) {
            alert("âŒ Links are forbidden!"); return;
        }

        db.ref("messages").push({
            nama: myName,
            pesan: text,
            role: isAdmin ? "admin" : "user",
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        input.value = "";
    }

    // LISTENER CHAT
    db.ref("messages").limitToLast(50).on("child_added", (snap) => {
        const data = snap.val();
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');

        if (data.type === "anno") {
            div.className = "anno-card";
            div.innerHTML = `<span style="font-size:10px; font-weight:900; opacity:0.8">ðŸ“¢ ANNOUNCEMENT</span><br><b>${data.pesan}</b>`;
        } else {
            const isAdm = data.role === 'admin';
            div.className = `msg ${isAdm ? 'admin' : 'warga'}`;
            div.innerHTML = `<span class="tag ${isAdm ? 'tag-admin' : 'tag-warga'}">${isAdm ? 'ðŸ‘‘ ' : ''}${data.nama}</span>${data.pesan}`;
        }
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });

    db.ref("room_status/locked").on("value", (s) => {
        isLocked = s.val() || false;
        document.getElementById('chat-title').innerText = isLocked ? "ExeChat (LOCKED)" : "ExeChat";
    });

    db.ref("messages").on("child_removed", () => { document.getElementById('chat-box').innerHTML = ""; });

    document.getElementById('userMsg').addEventListener("keypress", (e) => { if(e.key === 'Enter') handleSend(); });
</script>
</body>
</html>
