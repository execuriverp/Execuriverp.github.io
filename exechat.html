<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExeChat V27 - Premium</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --main: #007bff;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        /* --- LOGIN & REGISTER UI --- */
        #auth-container {
            background: var(--card);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .input-group { margin-bottom: 1rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; opacity: 0.8; }
        .input-group input {
            width: 100%; padding: 12px; border-radius: 8px; border: none;
            background: #334155; color: white; outline: none;
        }

        .btn-auth {
            width: 100%; padding: 12px; border-radius: 8px; border: none;
            background: var(--main); color: white; font-weight: bold;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }

        .btn-auth:hover { opacity: 0.9; transform: translateY(-2px); }
        .toggle-auth { margin-top: 15px; font-size: 0.85rem; cursor: pointer; color: var(--main); }

        /* --- CHAT UI --- */
        #chat-app { display: none; width: 100%; height: 100vh; flex-direction: column; }
        
        header {
            background: var(--card);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #chat-box {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* Message Styles */
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 12px; position: relative; animation: fadeIn 0.3s; }
        .msg.sent { align-self: flex-end; background: var(--main); }
        .msg.received { align-self: flex-start; background: #334155; }
        
        .sender { font-size: 0.75rem; font-weight: bold; margin-bottom: 3px; display: flex; align-items: center; gap: 5px; }
        .online-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; display: inline-block; }

        /* Reply Preview */
        .reply-box {
            background: rgba(0,0,0,0.2);
            border-left: 3px solid var(--main);
            padding: 5px 10px;
            margin-bottom: 5px;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        /* Input Area */
        .input-area { background: var(--card); padding: 15px; display: flex; gap: 10px; }
        #msg-input { flex: 1; padding: 12px; border-radius: 25px; border: none; background: #334155; color: white; }

        /* Admin Panel Custom Theme */
        #admin-panel {
            position: fixed; top: 0; right: -300px; width: 300px; height: 100%;
            background: var(--card); transition: 0.3s; padding: 20px; z-index: 100;
        }
        #admin-panel.active { right: 0; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <audio id="notif-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>

    <div id="auth-container">
        <h2 id="auth-title">Welcome Back</h2>
        <div class="input-group">
            <label>Email</label>
            <input type="email" id="email" placeholder="example@exe.com">
        </div>
        <div class="input-group">
            <label>Password</label>
            <input type="password" id="password" placeholder="••••••••">
        </div>
        <div id="reg-fields" style="display: none;">
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="NickName">
            </div>
        </div>
        <button class="btn-auth" id="btn-action" onclick="handleAuth()">Login</button>
        <p class="toggle-auth" onclick="toggleAuth()">Don't have an account? Register</p>
    </div>

    <div id="chat-app">
        <header>
            <div>
                <span id="display-name" style="font-weight: bold;">User</span>
                <span class="online-dot"></span>
            </div>
            <button onclick="toggleAdmin()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-cog"></i></button>
        </header>

        <div id="chat-box"></div>

        <div id="reply-preview" style="display:none; background:#1e293b; padding:10px; border-top:2px solid var(--main);">
            <small id="reply-text"></small>
            <button onclick="cancelReply()" style="float:right; color:red; border:none; background:none;">X</button>
        </div>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Type a message...">
            <button onclick="sendMessage()" style="background:var(--main); border:none; color:white; padding:10px 20px; border-radius:25px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="admin-panel">
        <h3>Admin Panel</h3>
        <hr>
        <label>Custom Theme Color:</label><br>
        <input type="color" id="theme-color" onchange="changeTheme(this.value)" style="width:100%; height:40px; margin-top:10px;">
        <br><br>
        <button onclick="clearChat()" style="width:100%; padding:10px; background:red; border:none; color:white; border-radius:5px;">Wipe All Chat</button>
        <br><br>
        <button onclick="logout()" style="width:100%; padding:10px; background:#475569; border:none; color:white; border-radius:5px;">Logout</button>
    </div>

    <script>
        // --- CONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            databaseURL: "https://your-project.firebaseio.com",
            projectId: "your-project",
            authDomain: "your-project.firebaseapp.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let isRegister = false;
        let currentUser = null;
        let replyData = null;

        // --- AUTH LOGIC ---
        function toggleAuth() {
            isRegister = !isRegister;
            document.getElementById('auth-title').innerText = isRegister ? "Create Account" : "Welcome Back";
            document.getElementById('btn-action').innerText = isRegister ? "Register" : "Login";
            document.getElementById('reg-fields').style.display = isRegister ? "block" : "none";
        }

        function handleAuth() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const user = document.getElementById('username').value;

            if(isRegister) {
                auth.createUserWithEmailAndPassword(email, pass).then((res) => {
                    db.ref('users/' + res.user.uid).set({ username: user, role: 'member', status: 'online' });
                    alert("Account Created!");
                    location.reload();
                }).catch(e => alert(e.message));
            } else {
                auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
            }
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('chat-app').style.display = 'flex';
                
                // Set Online Status
                db.ref('users/' + user.uid).update({ status: 'online' });
                db.ref('users/' + user.uid + '/username').once('value', s => {
                    document.getElementById('display-name').innerText = s.val();
                });
                loadMessages();
                listenTheme();
            }
        });

        // --- CHAT LOGIC ---
        function sendMessage() {
            const text = document.getElementById('msg-input').value;
            if(!text) return;

            db.ref('users/' + currentUser.uid + '/username').once('value', s => {
                const msgData = {
                    uid: currentUser.uid,
                    sender: s.val(),
                    text: text,
                    replyTo: replyData,
                    timestamp: Date.now()
                };
                db.ref('messages').push(msgData);
                document.getElementById('msg-input').value = '';
                cancelReply();
            });
        }

        function loadMessages() {
            db.ref('messages').limitToLast(50).on('child_added', snap => {
                const data = snap.val();
                const chatBox = document.getElementById('chat-box');
                const isMine = data.uid === currentUser.uid;
                
                const div = document.createElement('div');
                div.className = `msg ${isMine ? 'sent' : 'received'}`;
                
                let replyHtml = data.replyTo ? `<div class="reply-box"><b>${data.replyTo.user}</b><br>${data.replyTo.msg}</div>` : '';
                
                div.innerHTML = `
                    <div class="sender">${data.sender}</div>
                    ${replyHtml}
                    <div class="text">${data.text}</div>
                `;
                
                div.onclick = () => setReply(data.sender, data.text);
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;

                // Sound Notif for received
                if(!isMine) document.getElementById('notif-sound').play();
            });
        }

        // --- REPLY SYSTEM ---
        function setReply(user, msg) {
            replyData = { user, msg };
            document.getElementById('reply-preview').style.display = 'block';
            document.getElementById('reply-text').innerText = `Replying to ${user}: ${msg}`;
        }
        function cancelReply() {
            replyData = null;
            document.getElementById('reply-preview').style.display = 'none';
        }

        // --- THEME & ADMIN ---
        function toggleAdmin() { document.getElementById('admin-panel').classList.toggle('active'); }

        function changeTheme(color) {
            db.ref('settings/theme').set(color);
        }

        function listenTheme() {
            db.ref('settings/theme').on('value', s => {
                if(s.val()) {
                    document.documentElement.style.setProperty('--main', s.val());
                }
            });
        }

        function logout() {
            db.ref('users/' + currentUser.uid).update({ status: 'offline' });
            auth.signOut().then(() => location.reload());
        }

        function clearChat() {
            if(confirm("Wipe all messages?")) db.ref('messages').remove();
        }
    </script>
</body>
</html>
