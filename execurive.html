<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPhoneNumber, RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCtfsTqg3sJuJCq_EGF36c4eg8QUwyhtwE",
      authDomain: "execuriverp.firebaseapp.com",
      databaseURL: "https://execuriverp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "execuriverp",
      storageBucket: "execuriverp.firebasestorage.app",
      messagingSenderId: "672894448184",
      appId: "1:672894448184:web:2d9635ca19ea94c3e7eccd",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Inisialisasi Recaptcha Bawaan Firebase (Lebih Stabil)
    window.onload = () => {
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'sign-in-button', {
            'size': 'invisible',
            'callback': (response) => {
                // reCAPTCHA solved, biarkan fungsi login berjalan
            }
        });
    };

    window.prosesLogin = async () => {
        const phoneNumber = document.getElementById('phone').value;
        
        if(!phoneNumber.startsWith('+62')) {
            alert("Gunakan format Indonesia! (+628...)");
            return;
        }

        // Cek Blacklist
        try {
            const blacklistRef = doc(db, "blacklist", phoneNumber);
            const blacklistSnap = await getDoc(blacklistRef);
            if (blacklistSnap.exists()) {
                alert("NOMOR DIBLOKIR!");
                return; 
            }
        } catch (e) { console.error(e); }

        const appVerifier = window.recaptchaVerifier;

        signInWithPhoneNumber(auth, phoneNumber, appVerifier)
            .then((confirmationResult) => {
                window.confirmationResult = confirmationResult;
                alert("OTP Terkirim!");
                document.getElementById('otp-section').classList.remove('hidden');
            }).catch((error) => {
                alert("Gagal: " + error.message);
                // Reset recaptcha jika gagal agar bisa klik lagi
                window.recaptchaVerifier.render().then(widgetId => {
                    grecaptcha.reset(widgetId);
                });
            });
    };

    window.verifikasiOTP = () => {
        const code = document.getElementById('otp-code').value;
        window.confirmationResult.confirm(code).then(() => {
            alert("Login Berhasil!");
            window.location.href = "forum.html"; 
        }).catch(() => alert("OTP SALAH!"));
    };
</script>

<button 
    onclick="prosesLogin()"
    id="sign-in-button"
    class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-4 rounded transition-all shadow-lg uppercase">
    LOGIN TO FORUM
</button>
