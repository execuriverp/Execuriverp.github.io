<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miracle RP</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyD5JGQ3eARM5Lo2IG3mkpdx7p3uh0nrBIk",
  authDomain: "samp-miracle.firebaseapp.com",
  databaseURL: "https://samp-miracle-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "samp-miracle",
  storageBucket: "samp-miracle.firebasestorage.app",
  messagingSenderId: "465126706451",
  appId: "1:465126706451:web:b94f2359a348ff7078dee6"
});
const DB = firebase.database();
</script>

<style>
:root{
  --bg:#09090E;--bg2:#0F0F18;--bg3:#161622;--bg4:#1E1E2E;--bg5:#252535;
  --border:rgba(255,255,255,.07);--border2:rgba(255,255,255,.04);--border3:rgba(255,255,255,.14);
  --text:#DCDCE8;--text2:#9898B0;--text3:#5A5A72;
  --accent:#fff;--gold:#FFD700;--orange:#FF6B00;--red:#E63946;--green:#25D366;--blue:#64b4ff;--purple:#b464ff;--cyan:#00C9B1;
  --r:3px;--font:'Segoe UI',system-ui,sans-serif;--mono:'Courier New',monospace
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.5;min-height:100vh}
a{color:inherit;text-decoration:none}img{max-width:100%}
::-webkit-scrollbar{width:3px;height:3px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1)}
.wrap{max-width:1200px;margin:0 auto;padding:0 16px}

/* TOPBAR */
#topbar{background:rgba(9,9,14,.97);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;backdrop-filter:blur(10px)}
.tb-inner{display:flex;align-items:center;height:50px;gap:4px}
.logo{font-size:15px;font-weight:800;letter-spacing:3px;color:#fff;white-space:nowrap;margin-right:12px;flex-shrink:0;cursor:pointer}
.logo em{color:var(--text3);font-weight:400;font-size:10px;letter-spacing:0;font-style:normal;margin-left:4px}
.main-nav{display:flex;align-items:center;gap:1px;flex:1;overflow-x:auto}
.main-nav a{padding:5px 9px;color:var(--text2);font-size:11.5px;border-radius:var(--r);white-space:nowrap;transition:all .1s;cursor:pointer}
.main-nav a:hover,.main-nav a.active{color:#fff;background:var(--bg3)}
.tb-right{display:flex;align-items:center;gap:6px;flex-shrink:0;margin-left:8px}
.notif-dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--red);margin-left:2px;vertical-align:middle}

/* MOBILE */
.hamburger{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:6px;background:none;border:none}
.hamburger span{display:block;width:16px;height:1.5px;background:var(--text2)}
.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300}
.mob-overlay.open{display:block}
.mob-nav{position:fixed;top:0;left:0;width:250px;height:100vh;background:var(--bg2);border-right:1px solid var(--border);z-index:301;padding:12px 8px;display:flex;flex-direction:column;gap:2px;overflow-y:auto;transform:translateX(-100%);transition:transform .2s}
.mob-nav.open{transform:translateX(0)}
.mob-nav-logo{font-size:13px;font-weight:800;letter-spacing:3px;padding:4px 8px 12px;border-bottom:1px solid var(--border);margin-bottom:6px}
.mob-close{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer;line-height:1}
.mob-nav a{display:block;padding:7px 8px;color:var(--text2);border-radius:var(--r);font-size:12px;cursor:pointer;transition:all .08s}
.mob-nav a:hover{background:var(--bg3);color:#fff}

/* BTN */
.btn{display:inline-flex;align-items:center;gap:4px;padding:5px 11px;border:1px solid var(--border3);border-radius:var(--r);font-size:11.5px;cursor:pointer;transition:all .1s;background:transparent;color:var(--text2);font-family:var(--font);white-space:nowrap}
.btn:hover{color:#fff;background:var(--bg3)}
.btn-primary{background:#fff;color:#000;border-color:#fff;font-weight:700}
.btn-primary:hover{background:#ddd;color:#000}
.btn-danger{color:var(--red);border-color:rgba(230,57,70,.3)}
.btn-danger:hover{background:var(--red);color:#fff}
.btn-green{color:var(--green);border-color:rgba(37,211,102,.3)}
.btn-green:hover{background:var(--green);color:#000}
.btn-sm{padding:3px 8px;font-size:11px}
.btn:disabled{opacity:.4;cursor:not-allowed}

/* LAYOUT */
.page-layout{display:flex;gap:16px;padding:16px 0 40px;align-items:flex-start}
.main-col{flex:1;min-width:0}
.side-col{width:234px;flex-shrink:0;display:flex;flex-direction:column;gap:8px}

/* CARD/WIDGET */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r)}
.widget{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.widget-title{padding:7px 11px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);border-bottom:1px solid var(--border)}
.widget-body{padding:9px 11px}
.stat-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border2);font-size:11.5px}
.stat-row:last-child{border-bottom:none}
.stat-row .sv{font-weight:700;color:#fff}

/* FORUM ROWS */
.cat-title{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--text3);padding:0 0 6px;border-bottom:1px solid var(--border);margin-bottom:3px}
.forum-row{display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border2);gap:10px;transition:background .08s;cursor:pointer}
.forum-row:last-child{border-bottom:none}
.forum-row:hover{background:var(--bg3)}
.f-icon{width:32px;height:32px;border-radius:var(--r);background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.f-info{flex:1;min-width:0}
.f-name{font-size:12.5px;font-weight:600;color:#fff;margin-bottom:2px}
.f-desc{font-size:10.5px;color:var(--text3)}
.f-stat{text-align:right;flex-shrink:0;min-width:50px}
.f-stat .count{font-size:13px;font-weight:700;display:block}
.f-stat .lbl{font-size:9.5px;color:var(--text3)}

/* FORMS */
.form-row{display:flex;flex-direction:column;gap:3px;margin-bottom:10px}
.form-label{font-size:10.5px;font-weight:600;color:var(--text2)}
.form-input{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:7px 9px;color:#fff;font-size:12.5px;font-family:var(--font);outline:none;transition:border-color .1s;width:100%}
.form-input:focus{border-color:rgba(255,255,255,.18)}
select.form-input option{background:var(--bg3)}
textarea.form-input{resize:vertical;min-height:80px}

/* BADGES */
.badge{font-size:9.5px;font-weight:700;letter-spacing:.6px;padding:2px 6px;display:inline-block;border-radius:var(--r)}
.b-pending{background:rgba(255,215,0,.08);color:var(--gold);border:1px solid rgba(255,215,0,.2)}
.b-process{background:rgba(100,180,255,.08);color:var(--blue);border:1px solid rgba(100,180,255,.2)}
.b-accepted{background:rgba(37,211,102,.08);color:var(--green);border:1px solid rgba(37,211,102,.2)}
.b-rejected,.b-denied{background:rgba(230,57,70,.08);color:var(--red);border:1px solid rgba(230,57,70,.2)}
.b-banned{background:rgba(230,57,70,.14);color:var(--red);border:1px solid rgba(230,57,70,.3)}
.b-open{background:rgba(37,211,102,.08);color:var(--green);border:1px solid rgba(37,211,102,.2)}
.b-closed{background:rgba(255,255,255,.04);color:var(--text3);border:1px solid var(--border)}

/* ROLE COLORS */
.r-owner{color:#ff6b6b;font-weight:700}.r-developer{color:var(--blue);font-weight:700}
.r-headadmin,.r-admin,.r-senioradmin,.r-junioradmin{color:var(--red);font-weight:700}
.r-management{color:var(--purple);font-weight:700}.r-moderator{color:var(--orange);font-weight:700}
.r-communityhandle,.r-seniorhelper,.r-helper,.r-juniorhelper,.r-volunteer{color:var(--cyan);font-weight:600}
.r-vip{color:var(--gold);font-weight:600}.r-user,.r-exstaff{color:var(--text2)}

/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:12px;gap:0}
.tab-btn{padding:6px 13px;font-size:11.5px;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .1s;background:none;border-top:none;border-left:none;border-right:none;font-family:var(--font)}
.tab-btn:hover{color:var(--text)}
.tab-btn.active{color:#fff;border-bottom-color:#fff}
.tab-panel{display:none}.tab-panel.active{display:block}

/* INFO BOX */
.info-box{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:9px 11px;font-size:11.5px;color:var(--text2);margin-bottom:10px}
.info-box.warn{border-left:2px solid var(--orange);color:var(--orange)}
.info-box.closed{border-left:2px solid var(--red);color:var(--red)}
.info-box.success{border-left:2px solid var(--green);color:var(--green)}

/* ANNOUNCE BAR */
.ann-bar{background:var(--bg2);border:1px solid var(--border);border-left:2px solid #fff;border-radius:var(--r);padding:8px 11px;font-size:11.5px;color:var(--text2);margin-bottom:12px;display:flex;align-items:center;gap:8px}

/* POSTS / FEED */
.feed-composer{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:12px;margin-bottom:8px}
.composer-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:8px 10px;color:#fff;font-size:12.5px;font-family:var(--font);outline:none;resize:none;transition:border-color .1s}
.composer-input:focus{border-color:rgba(255,255,255,.15)}
.post-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);margin-bottom:7px}
.post-header{display:flex;align-items:center;gap:9px;padding:11px 13px 0}
.post-ava{width:34px;height:34px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--text2);overflow:hidden}
.post-ava img{width:100%;height:100%;object-fit:cover}
.post-body{padding:8px 13px;font-size:12.5px;color:var(--text2);line-height:1.65;white-space:pre-wrap;word-break:break-word}
.post-actions{display:flex;align-items:center;gap:5px;padding:7px 13px 9px;border-top:1px solid var(--border2)}
.react-btn{background:none;border:1px solid var(--border);border-radius:20px;padding:3px 9px;font-size:11.5px;color:var(--text3);cursor:pointer;font-family:var(--font);transition:all .1s;display:flex;align-items:center;gap:3px}
.react-btn:hover{border-color:var(--border3);color:var(--text2)}
.react-btn.liked{border-color:rgba(230,57,70,.3);color:var(--red);background:rgba(230,57,70,.05)}
.post-comments{border-top:1px solid var(--border2);padding:8px 13px}
.comment-item{display:flex;gap:6px;margin-bottom:6px}
.cmt-ava{width:24px;height:24px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;overflow:hidden}
.cmt-ava img{width:100%;height:100%;object-fit:cover}
.cmt-body{background:var(--bg3);border-radius:var(--r);padding:5px 9px;flex:1}
.cmt-author{font-size:10px;font-weight:600;color:#fff;margin-bottom:1px}
.cmt-text{font-size:11.5px;color:var(--text2)}
.cmt-input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:5px 11px;color:#fff;font-size:11.5px;font-family:var(--font);outline:none}
.cmt-input:focus{border-color:rgba(255,255,255,.12)}

/* WL STEPS */
.wl-steps{display:flex;align-items:center;margin-bottom:16px}
.wl-step{display:flex;align-items:center;flex:1}
.step-circle{width:26px;height:26px;border-radius:50%;border:1.5px solid var(--border3);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--text3);flex-shrink:0}
.step-lbl{font-size:9.5px;color:var(--text3);margin-left:5px;white-space:nowrap}
.wl-step.done .step-circle{background:var(--green);border-color:var(--green);color:#000}
.wl-step.done .step-lbl{color:var(--green)}
.wl-step.active .step-circle{border-color:#fff;color:#fff}
.wl-step.active .step-lbl{color:#fff}
.step-line{flex:1;height:1px;background:var(--border);margin:0 5px}

/* STAFF */
.staff-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:8px}
.staff-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:13px;text-align:center;transition:border-color .1s}
.staff-card:hover{border-color:var(--border3)}
.staff-ava{width:46px;height:46px;border-radius:50%;background:var(--bg3);border:1.5px solid var(--border);margin:0 auto 7px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:var(--text2)}
.staff-name{font-size:12.5px;font-weight:600;margin-bottom:2px}
.staff-role-txt{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}

/* LEADERBOARD */
.lb-row{display:flex;align-items:center;gap:9px;padding:9px 12px;border-bottom:1px solid var(--border2);transition:background .08s}
.lb-row:hover{background:var(--bg3)}.lb-row:last-child{border-bottom:none}
.lb-rank{width:22px;text-align:center;font-size:12px;font-weight:700;color:var(--text3);flex-shrink:0}
.lb-rank.r1{color:var(--gold)}.lb-rank.r2{color:#ccc}.lb-rank.r3{color:#cd7f32}
.lb-ava{width:32px;height:32px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;overflow:hidden}
.lb-ava img{width:100%;height:100%;object-fit:cover}
.lb-info{flex:1;min-width:0}.lb-name{font-size:12.5px;font-weight:600}.lb-sub{font-size:10px;color:var(--text3)}
.lb-val{font-size:12.5px;font-weight:700;color:var(--green);flex-shrink:0}

/* PM / CHAT */
.chat-wrap{display:flex;height:calc(100vh - 120px);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;background:var(--bg2)}
.chat-sidebar{width:230px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column}
.chat-sidebar-hdr{padding:9px 11px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-size:11.5px;font-weight:700}
.chat-sb-search{padding:6px 9px;border-bottom:1px solid var(--border)}
.chat-sb-search input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:4px 8px;color:#fff;font-size:11.5px;font-family:var(--font);outline:none}
.chat-list{flex:1;overflow-y:auto}
.chat-item{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-bottom:1px solid var(--border2);transition:background .07s;position:relative}
.chat-item:hover{background:var(--bg3)}.chat-item.active{background:var(--bg4)}
.chat-item.unread::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:2px;height:20px;background:#fff}
.ci-ava{width:33px;height:33px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;overflow:hidden}
.ci-ava img{width:100%;height:100%;object-fit:cover}
.ci-name{font-size:11.5px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ci-preview{font-size:10px;color:var(--text3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:1px}
.unread-badge{position:absolute;top:6px;right:8px;background:#fff;color:#000;font-size:8px;font-weight:700;width:15px;height:15px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.chat-main{flex:1;display:flex;flex-direction:column;min-width:0}
.chat-main-hdr{padding:9px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:12.5px;font-weight:700}
.chat-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:7px}
.msg-row{display:flex;gap:7px;align-items:flex-end}.msg-row.mine{flex-direction:row-reverse}
.msg-ava-sm{width:24px;height:24px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;overflow:hidden}
.msg-ava-sm img{width:100%;height:100%;object-fit:cover}
.msg-bubbles{display:flex;flex-direction:column;gap:2px;max-width:65%}
.msg-row.mine .msg-bubbles{align-items:flex-end}
.msg-bubble{padding:6px 10px;border-radius:12px;font-size:11.5px;line-height:1.45;word-break:break-word;background:var(--bg3);border:1px solid var(--border)}
.msg-row.mine .msg-bubble{background:var(--bg4);border-color:var(--border3)}
.msg-time{font-size:9px;color:var(--text3);margin-top:1px}
.msg-row.mine .msg-time{text-align:right}
.chat-input-area{padding:9px 12px;border-top:1px solid var(--border);display:flex;align-items:flex-end;gap:6px}
.chat-input-wrap{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:6px 11px;display:flex;align-items:flex-end;gap:6px;transition:border-color .1s}
.chat-input-wrap:focus-within{border-color:rgba(255,255,255,.14)}
.chat-textarea{flex:1;background:none;border:none;color:#fff;font-size:11.5px;font-family:var(--font);outline:none;resize:none;max-height:90px;line-height:1.5}
.send-btn{width:32px;height:32px;border-radius:50%;background:#fff;color:#000;border:none;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:500;align-items:center;justify-content:center;padding:1rem}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border3);border-radius:var(--r);width:90%;max-width:440px;max-height:90vh;overflow-y:auto;animation:mIn .18s ease}
.modal.wide{max-width:560px}
@keyframes mIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;border-bottom:1px solid var(--border)}
.modal-title{font-size:13px;font-weight:700;color:#fff}
.modal-close{background:none;border:none;color:var(--text3);font-size:18px;cursor:pointer;line-height:1}
.modal-close:hover{color:#fff}
.modal-body{padding:14px 15px}
.modal-footer{padding:10px 15px;border-top:1px solid var(--border);display:flex;gap:7px;justify-content:flex-end}
.detail-row{display:flex;gap:8px;margin-bottom:5px;font-size:12px}
.dk{font-size:10px;color:var(--text2);min-width:110px;padding-top:.1rem;flex-shrink:0}
.dv{color:#fff;font-weight:600;flex:1;word-break:break-all}
.detail-story{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:8px;font-size:11.5px;color:#fff;line-height:1.65;max-height:170px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}

/* ADMIN */
.adm-layout{display:flex;min-height:calc(100vh - 50px);margin:0 -16px}
.adm-sidebar{width:195px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);padding:10px 0;overflow-y:auto}
.adm-section{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--text3);padding:8px 12px 3px;margin-top:4px}
.adm-item{display:flex;align-items:center;gap:6px;padding:6px 12px;font-size:11.5px;color:var(--text2);cursor:pointer;transition:all .07s;border:none;background:none;width:100%;text-align:left;border-left:2px solid transparent;font-family:var(--font)}
.adm-item:hover{background:rgba(255,255,255,.02);color:var(--text)}
.adm-item.active{color:#fff;background:rgba(255,255,255,.03);border-left-color:#fff}
.adm-badge{margin-left:auto;background:var(--red);color:#fff;font-size:8.5px;padding:1px 5px;border-radius:8px;min-width:14px;text-align:center}
.adm-content{flex:1;padding:18px 20px;overflow:auto;min-width:0}
.adm-title{font-size:16px;font-weight:700;color:#fff;margin-bottom:3px}
.adm-sub{font-size:10.5px;color:var(--text3);margin-bottom:14px;letter-spacing:.3px}
.adm-tab{display:none}.adm-tab.active{display:block}
.adm-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin-bottom:16px}
.adm-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:12px}
.adm-card .acl{font-size:9.5px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.adm-card .acv{font-size:24px;font-weight:700;color:#fff}

/* TABLE */
.tbl-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;overflow-x:auto;margin-bottom:12px}
.tbl-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:6px}
.tbl-title{font-size:11px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:#fff}
.tbl-search{background:var(--bg3);border:1px solid var(--border);color:#fff;padding:5px 9px;font-size:11px;font-family:var(--font);outline:none;border-radius:var(--r);width:160px;transition:border-color .1s}
.tbl-search:focus{border-color:rgba(255,255,255,.14)}
table{width:100%;border-collapse:collapse;min-width:480px}
th{background:var(--bg3);padding:7px 10px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);text-align:left;border-bottom:1px solid var(--border)}
td{padding:8px 10px;font-size:11.5px;color:var(--text2);border-bottom:1px solid var(--border2);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.01)}
.empty-row td{text-align:center;color:var(--text3);font-size:11px;padding:1.5rem}
.atn-btn{background:none;border:1px solid var(--border);color:var(--text2);padding:3px 7px;font-size:10px;cursor:pointer;border-radius:var(--r);font-family:var(--font);transition:all .1s}
.atn-btn:hover{border-color:#fff;color:#fff}
.atn-btn.r:hover{border-color:var(--red);color:var(--red)}
.atn-btn.g:hover{border-color:var(--green);color:var(--green)}

/* LOG STREAM */
.log-stream{background:var(--bg);border:1px solid var(--border);padding:8px;max-height:360px;overflow-y:auto;font-family:var(--mono);font-size:10.5px}
.log-line{padding:2.5px 0;border-bottom:1px solid rgba(255,255,255,.025);display:flex;gap:8px;align-items:flex-start}
.log-time{color:var(--text3);min-width:115px;flex-shrink:0;font-size:9.5px}
.log-type{min-width:52px;flex-shrink:0;font-weight:700;font-size:9.5px}
.log-type.AUTH{color:var(--blue)}.log-type.WL,.log-type.WL_REVIEW{color:var(--gold)}
.log-type.BAN{color:var(--red)}.log-type.ACCEPT{color:var(--green)}
.log-type.DENY,.log-type.REJECT{color:var(--orange)}.log-type.ROLE{color:var(--purple)}
.log-type.CS,.log-type.CS_REVIEW{color:var(--cyan)}.log-type.IMPORT{color:#6DD5A8}
.log-type.SYSTEM{color:var(--text2)}.log-type.NEWS{color:var(--purple)}
.log-type.CHAT{color:var(--gold)}.log-type.POST{color:var(--blue)}
.log-msg{color:#fff;flex:1;line-height:1.4;font-size:10.5px}

/* ADMIN CHAT */
.adm-chat-wrap{display:flex;flex-direction:column;height:60vh;border:1px solid var(--border);border-radius:var(--r)}
.adm-chat-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:7px;background:var(--bg3)}
.adm-msg{max-width:72%;padding:7px 10px;border-radius:var(--r)}
.adm-msg.mine{align-self:flex-end;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1)}
.adm-msg.theirs{align-self:flex-start;background:var(--bg2);border:1px solid var(--border)}
.adm-msg-meta{font-size:9px;color:var(--text2);margin-bottom:2px}
.adm-msg-text{font-size:11.5px;color:#fff;line-height:1.5}
.adm-msg-time{font-size:9px;color:var(--text3);margin-top:2px}
.adm-chat-input{display:flex;gap:6px;padding:9px 12px;background:var(--bg2);border-top:1px solid var(--border)}
.adm-chat-input input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:7px 10px;color:#fff;font-family:var(--font);font-size:12px;outline:none}
.adm-chat-input input:focus{border-color:rgba(255,255,255,.14)}
.adm-chat-input button{background:#fff;color:#000;border:none;padding:7px 14px;font-size:11.5px;font-weight:700;cursor:pointer;border-radius:var(--r)}

/* SETTINGS */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.s-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px}
.s-card-title{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--border)}

/* PERM TAGS */
.perm-tag{font-size:10px;padding:3px 8px;cursor:pointer;user-select:none;display:inline-block;margin:2px;border-radius:var(--r);transition:all .1s}
.perm-tag.on{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.22);color:#fff}
.perm-tag.off{background:none;border:1px solid var(--border);color:var(--text3)}
.role-chip{font-size:10px;padding:4px 9px;cursor:pointer;border:1px solid var(--border);color:var(--text2);display:inline-block;margin:2px;border-radius:var(--r);transition:all .1s}
.role-chip:hover{border-color:var(--border3)}
.role-chip.sel{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.25);color:#fff}

/* TOAST */
.toast-wrap{position:fixed;bottom:18px;right:18px;z-index:600;display:flex;flex-direction:column;gap:7px}
.toast{background:var(--bg2);border:1px solid var(--border3);border-radius:var(--r);padding:9px 14px;font-size:11.5px;color:#fff;display:flex;align-items:center;gap:7px;min-width:180px;animation:tIn .18s ease}
.toast.s{border-left:2px solid var(--green)}.toast.e{border-left:2px solid var(--red)}.toast.i{border-left:2px solid var(--blue)}
@keyframes tIn{from{transform:translateX(14px);opacity:0}to{transform:none;opacity:1}}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;transition:opacity .3s}
#loader.hidden{opacity:0;pointer-events:none}
.loader-logo{font-size:18px;font-weight:800;letter-spacing:4px;color:#fff}
.loader-bar-wrap{width:140px;height:1.5px;background:var(--border);border-radius:2px;overflow:hidden}
.loader-bar{height:100%;background:#fff;animation:lBar 1s ease-in-out forwards}
@keyframes lBar{0%{width:0}100%{width:100%}}

/* PAGES */
.page{display:none}.page.active{display:block}

/* PROFILE */
.prof-banner{height:100px;background:linear-gradient(135deg,#0a0a14,#14141f 50%,#090912);border-bottom:1px solid var(--border);position:relative}
.prof-banner::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 12px,rgba(255,255,255,.006) 12px,rgba(255,255,255,.006) 13px)}
.prof-head{display:flex;align-items:flex-end;gap:12px;padding:0 16px 12px;margin-top:-28px;position:relative}
.prof-ava{width:68px;height:68px;border-radius:50%;border:2.5px solid var(--bg2);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:var(--text2);overflow:hidden;flex-shrink:0}
.prof-ava img{width:100%;height:100%;object-fit:cover}
.p-stat .pv{font-size:15px;font-weight:700;color:#fff;display:block}
.p-stat .pl{font-size:9.5px;color:var(--text3);text-transform:uppercase}

/* ANNOUNCE PAGE */
.ann-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:15px;margin-bottom:8px}
.ann-tag-badge{font-size:9.5px;font-weight:700;padding:2px 6px;border-radius:var(--r);display:inline-block;margin-bottom:7px}
.ann-title-txt{font-size:13.5px;font-weight:700;color:#fff;margin-bottom:7px}
.ann-body-txt{font-size:12px;color:var(--text2);line-height:1.7;white-space:pre-wrap}
.ann-meta{font-size:10px;color:var(--text3);margin-top:8px}

/* GUIDES/RULES */
.guide-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:15px;margin-bottom:8px}
.guide-tag{font-size:9px;font-weight:700;letter-spacing:.8px;padding:2px 6px;border:1px solid var(--border);border-radius:var(--r);display:inline-block;margin-bottom:6px;color:var(--text3)}
.guide-title{font-size:13px;font-weight:700;color:#fff;margin-bottom:8px}
.guide-body{font-size:12px;color:var(--text2);line-height:1.7;white-space:pre-wrap}

/* IMPORT TYPES */
.imp-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:12px}
.imp-type-btn{background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--r);padding:10px 6px;text-align:center;cursor:pointer;transition:all .13s}
.imp-type-btn:hover{border-color:var(--border3)}
.imp-type-btn.sel{border-color:#fff;background:rgba(255,255,255,.04)}
.imp-type-btn.disabled{opacity:.3;pointer-events:none}
.it-icon{font-size:20px;margin-bottom:4px}
.it-lbl{font-size:10.5px;font-weight:600;color:var(--text2)}

/* SERVER BLOCK */
.srv-block{padding:8px;border:1px solid var(--border);border-radius:var(--r);margin-bottom:6px;cursor:pointer;transition:border-color .1s}
.srv-block:last-child{margin-bottom:0}
.srv-block:hover{border-color:var(--border3)}
.srv-type{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:2px}
.srv-addr{font-family:var(--mono);color:#fff;font-size:11.5px}

/* RESPONSIVE */
@media(max-width:900px){.side-col{display:none}}
@media(max-width:700px){.hamburger{display:flex}.main-nav{display:none}.chat-sidebar{display:none}.adm-sidebar{display:none}.settings-grid{grid-template-columns:1fr}.adm-cards{grid-template-columns:1fr 1fr}}
@media(max-width:480px){.adm-cards{grid-template-columns:1fr}.imp-type-grid{grid-template-columns:repeat(3,1fr)}}
</style>
</head>
<body>

<div id="loader"><div class="loader-logo">MIRACLE</div><div class="loader-bar-wrap"><div class="loader-bar"></div></div></div>
<div class="toast-wrap" id="toastWrap"></div>

<!-- MODALS -->
<div class="modal-overlay" id="modalLogin">
  <div class="modal">
    <div class="modal-hdr"><div class="modal-title">Login / Daftar</div><button class="modal-close" onclick="closeModal('modalLogin')">‚úï</button></div>
    <div class="modal-body">
      <p style="font-size:11.5px;color:var(--text2);margin-bottom:14px">Login dengan Google untuk bergabung di komunitas Miracle RP.</p>
      <button class="btn btn-primary" style="width:100%;justify-content:center;padding:10px;font-size:13px" onclick="loginGoogle()">
        <svg width="14" height="14" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        Masuk dengan Google
      </button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="modalNewPM">
  <div class="modal"><div class="modal-hdr"><div class="modal-title">Pesan Baru</div><button class="modal-close" onclick="closeModal('modalNewPM')">‚úï</button></div>
  <div class="modal-body">
    <div class="form-row"><label class="form-label">Kirim ke (username)</label><input type="text" class="form-input" id="pmTargetUsername" placeholder="Username..."></div>
    <div class="form-row"><label class="form-label">Pesan</label><textarea class="form-input" id="pmNewMsg" placeholder="Tulis pesan..."></textarea></div>
  </div>
  <div class="modal-footer"><button class="btn" onclick="closeModal('modalNewPM')">Batal</button><button class="btn btn-primary" onclick="sendNewPM()">Kirim</button></div></div>
</div>
<div class="modal-overlay" id="modalWLDetail">
  <div class="modal wide"><div class="modal-hdr"><div class="modal-title">Detail Whitelist</div><button class="modal-close" onclick="closeModal('modalWLDetail')">‚úï</button></div>
  <div class="modal-body" id="wlDetailBody"></div>
  <div class="modal-footer" id="wlDetailActions"></div></div>
</div>
<div class="modal-overlay" id="modalCSDetail">
  <div class="modal wide"><div class="modal-hdr"><div class="modal-title">Detail CS Request</div><button class="modal-close" onclick="closeModal('modalCSDetail')">‚úï</button></div>
  <div class="modal-body" id="csDetailBody"></div>
  <div class="modal-footer" id="csDetailActions"></div></div>
</div>
<div class="modal-overlay" id="modalImportDetail">
  <div class="modal wide"><div class="modal-hdr"><div class="modal-title">Detail Import Request</div><button class="modal-close" onclick="closeModal('modalImportDetail')">‚úï</button></div>
  <div class="modal-body" id="importDetailBody"></div>
  <div class="modal-footer" id="importDetailActions"></div></div>
</div>
<div class="modal-overlay" id="modalRole">
  <div class="modal wide"><div class="modal-hdr"><div class="modal-title">Kelola Role & Permission</div><button class="modal-close" onclick="closeModal('modalRole')">‚úï</button></div>
  <div class="modal-body">
    <p style="font-size:11px;color:var(--text2);margin-bottom:12px" id="roleTargetInfo"></p>
    <div style="margin-bottom:12px"><div class="form-label" style="margin-bottom:5px">Primary Role</div><div id="roleSelect" style="display:flex;flex-wrap:wrap;gap:3px"></div></div>
    <div><div class="form-label" style="margin-bottom:5px">Permissions</div><div id="permSelect" style="display:flex;flex-wrap:wrap;gap:2px"></div></div>
  </div>
  <div class="modal-footer"><button class="btn" onclick="closeModal('modalRole')">Batal</button><button class="btn btn-primary" onclick="confirmRole()">Simpan</button></div></div>
</div>
<div class="modal-overlay" id="modalBan">
  <div class="modal"><div class="modal-hdr"><div class="modal-title" style="color:var(--red)">Ban User</div><button class="modal-close" onclick="closeModal('modalBan')">‚úï</button></div>
  <div class="modal-body">
    <p style="font-size:11.5px;color:var(--text2);margin-bottom:10px" id="banTargetInfo"></p>
    <div class="form-row"><label class="form-label">Alasan Ban</label><input type="text" class="form-input" id="banReasonInput" placeholder="Alasan..."></div>
  </div>
  <div class="modal-footer"><button class="btn" onclick="closeModal('modalBan')">Batal</button><button class="btn btn-danger" onclick="confirmBan()">Ban User</button></div></div>
</div>
<div class="modal-overlay" id="modalICName">
  <div class="modal"><div class="modal-hdr"><div class="modal-title">Edit Nama IC</div><button class="modal-close" onclick="closeModal('modalICName')">‚úï</button></div>
  <div class="modal-body">
    <p style="font-size:11px;color:var(--text2);margin-bottom:10px" id="icTargetInfo"></p>
    <div class="form-row"><label class="form-label">Nama IC Baru</label><input type="text" class="form-input" id="icNameInput" placeholder="Nama_IC"></div>
  </div>
  <div class="modal-footer"><button class="btn" onclick="closeModal('modalICName')">Batal</button><button class="btn btn-primary" onclick="confirmICName()">Simpan</button></div></div>
</div>

<!-- MOBILE NAV -->
<div class="mob-overlay" id="mobOverlay" onclick="closeMobNav()"></div>
<nav class="mob-nav" id="mobNav">
  <button class="mob-close" onclick="closeMobNav()">‚úï</button>
  <div class="mob-nav-logo">MIRACLE</div>
  <a onclick="nav('home');closeMobNav()">üè† Home</a>
  <a onclick="nav('feed');closeMobNav()">üì∞ Feed</a>
  <a onclick="nav('whitelist');closeMobNav()">üìã Whitelist</a>
  <a onclick="nav('cs');closeMobNav()">üé≠ Character Story</a>
  <a onclick="nav('import');closeMobNav()">üì¶ Import</a>
  <a onclick="nav('staff');closeMobNav()">üë• Staff</a>
  <a onclick="nav('leaderboard');closeMobNav()">üèÜ Leaderboard</a>
  <a onclick="nav('report');closeMobNav()">üö© Report</a>
  <a onclick="nav('announcements');closeMobNav()">üì¢ Pengumuman</a>
  <a onclick="nav('rules');closeMobNav()">üìú Rules</a>
  <a onclick="nav('pm');closeMobNav()">üí¨ Pesan<span class="notif-dot" id="pmDotMob" style="display:none"></span></a>
  <a id="mobAdminLink" onclick="nav('admin');closeMobNav()" style="display:none">‚öôÔ∏è Admin Panel</a>
</nav>

<!-- TOPBAR -->
<div id="topbar">
  <div class="wrap">
    <div class="tb-inner">
      <button class="hamburger" onclick="openMobNav()"><span></span><span></span><span></span></button>
      <div class="logo" onclick="nav('home')">MIRACLE<em>RP</em></div>
      <nav class="main-nav" id="mainNav">
        <a onclick="nav('home')" data-page="home" class="active">Home</a>
        <a onclick="nav('feed')" data-page="feed">Feed</a>
        <a onclick="nav('whitelist')" data-page="whitelist">Whitelist</a>
        <a onclick="nav('cs')" data-page="cs">C.Story</a>
        <a onclick="nav('import')" data-page="import">Import</a>
        <a onclick="nav('staff')" data-page="staff">Staff</a>
        <a onclick="nav('leaderboard')" data-page="leaderboard">LB</a>
        <a onclick="nav('report')" data-page="report">Report</a>
        <a onclick="nav('announcements')" data-page="announcements">Pengumuman</a>
        <a onclick="nav('pm')" data-page="pm">Pesan<span class="notif-dot" id="pmDot" style="display:none"></span></a>
        <a id="adminNavLink" onclick="nav('admin')" data-page="admin" style="display:none">Admin</a>
      </nav>
      <div class="tb-right" id="tbRight">
        <button class="btn" onclick="openModal('modalLogin')">Masuk</button>
        <button class="btn btn-primary" onclick="openModal('modalLogin')">Daftar</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">

<!-- HOME -->
<div class="page active" id="page-home">
  <div class="page-layout">
    <div class="main-col">
      <div class="ann-bar" id="topAnnBar" style="display:none"><span>üì¢</span><span id="topAnnText"></span></div>
      <div style="margin-bottom:12px">
        <div class="cat-title" style="margin-bottom:6px">Miracle Roleplay</div>
        <div class="card">
          <div class="forum-row" onclick="nav('feed')"><div class="f-icon">üì∞</div><div class="f-info"><div class="f-name">Community Feed</div><div class="f-desc">Update, cerita dan diskusi komunitas.</div></div><div class="f-stat"><span class="count" id="hStatPosts">‚Äî</span><span class="lbl">posts</span></div></div>
          <div class="forum-row" onclick="nav('whitelist')"><div class="f-icon">üìã</div><div class="f-info"><div class="f-name">Pendaftaran Whitelist</div><div class="f-desc">Daftar untuk bergabung sebagai player.</div></div><div class="f-stat"><span class="count" id="hStatWL">‚Äî</span><span class="lbl">pending</span></div></div>
          <div class="forum-row" onclick="nav('cs')"><div class="f-icon">üé≠</div><div class="f-info"><div class="f-name">Character Story Request</div><div class="f-desc">Ajukan cerita latar belakang karakter.</div></div><div class="f-stat"><span class="count" id="hStatCS">‚Äî</span><span class="lbl">request</span></div></div>
          <div class="forum-row" onclick="nav('import')"><div class="f-icon">üì¶</div><div class="f-info"><div class="f-name">Import Request</div><div class="f-desc">Request import goodside / badside / family.</div></div><div class="f-stat"><span class="count" id="hStatImport">‚Äî</span><span class="lbl">pending</span></div></div>
          <div class="forum-row" onclick="nav('report')"><div class="f-icon">üö©</div><div class="f-info"><div class="f-name">Laporan & Bantuan</div><div class="f-desc">Laporkan pelanggaran atau minta bantuan.</div></div><div class="f-stat"><span class="count" id="hStatReports">‚Äî</span><span class="lbl">open</span></div></div>
        </div>
      </div>
      <div>
        <div class="cat-title" style="margin-bottom:6px">Informasi Server</div>
        <div class="card">
          <div class="forum-row" onclick="nav('announcements')"><div class="f-icon">üì¢</div><div class="f-info"><div class="f-name">Pengumuman</div><div class="f-desc">Informasi resmi dari tim Miracle RP.</div></div></div>
          <div class="forum-row" onclick="nav('rules')"><div class="f-icon">üìú</div><div class="f-info"><div class="f-name">Peraturan & Guide</div><div class="f-desc">Rules, Guide Job, Goodside, Badside.</div></div></div>
          <div class="forum-row" onclick="nav('staff')"><div class="f-icon">üëë</div><div class="f-info"><div class="f-name">Tim Staff</div><div class="f-desc">Kenali tim admin dan staff Miracle RP.</div></div></div>
        </div>
      </div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Server Address</div><div class="widget-body">
        <div class="srv-block" onclick="copyTxt(document.getElementById('srvIP').textContent)"><div class="srv-type">SA:MP</div><div class="srv-addr" id="srvIP">memuat...</div></div>
        <div class="srv-block" onclick="copyTxt(document.getElementById('srvWA').textContent)"><div class="srv-type">WhatsApp</div><div class="srv-addr" id="srvWA">memuat...</div></div>
      </div></div>
      <div class="widget"><div class="widget-title">Statistik</div><div class="widget-body" style="padding:0 11px">
        <div class="stat-row"><span>Total Member</span><span class="sv" id="sideStatMembers">‚Äî</span></div>
        <div class="stat-row"><span>WL Diterima</span><span class="sv" id="sideStatWLAcc">‚Äî</span></div>
        <div class="stat-row"><span>WL Pending</span><span class="sv" id="sideStatWLPend">‚Äî</span></div>
      </div></div>
      <div class="widget"><div class="widget-title">Fitur Server</div><div class="widget-body" id="featuresWidget" style="padding:0 11px"></div></div>
    </div>
  </div>
</div>

<!-- FEED -->
<div class="page" id="page-feed">
  <div class="page-layout">
    <div class="main-col">
      <div id="feedComposer" style="display:none">
        <div class="feed-composer">
          <div style="display:flex;gap:9px;align-items:flex-start">
            <div class="post-ava" id="composerAva">?</div>
            <textarea class="composer-input" id="composerText" placeholder="Bagikan sesuatu ke komunitas..." rows="3"></textarea>
          </div>
          <div style="display:flex;align-items:center;gap:7px;margin-top:9px">
            <span id="cooldownMsg" style="font-size:10px;color:var(--text3);display:none"></span>
            <div style="flex:1"></div>
            <button class="btn btn-primary btn-sm" onclick="submitPost()">Posting</button>
          </div>
        </div>
      </div>
      <div id="feedList"></div>
      <div id="feedEmpty" style="display:none;text-align:center;padding:36px;color:var(--text3);font-size:12px">Belum ada post.</div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Server</div><div class="widget-body"><div class="srv-block"><div class="srv-type">SA:MP</div><div class="srv-addr" id="feedSrvIP">‚Äî</div></div></div></div>
    </div>
  </div>
</div>

<!-- WHITELIST -->
<div class="page" id="page-whitelist">
  <div class="page-layout">
    <div class="main-col">
      <div id="wlMyStatus" style="display:none"></div>
      <div id="wlFormWrap">
        <div id="wlClosedBox" class="info-box closed" style="display:none">üö´ Whitelist sedang ditutup. Pantau pengumuman.</div>
        <div id="wlOpenWrap">
          <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Form Pendaftaran Whitelist</div>
          <div class="wl-steps">
            <div class="wl-step active" id="wlS1"><div class="step-circle">1</div><div class="step-lbl">Data Diri</div></div>
            <div class="step-line"></div>
            <div class="wl-step" id="wlS2"><div class="step-circle">2</div><div class="step-lbl">Pengetahuan RP</div></div>
            <div class="step-line"></div>
            <div class="wl-step" id="wlS3"><div class="step-circle">3</div><div class="step-lbl">Verifikasi</div></div>
            <div class="step-line"></div>
            <div class="wl-step" id="wlS4"><div class="step-circle">4</div><div class="step-lbl">Selesai</div></div>
          </div>
          <div class="card" style="padding:18px">
            <div id="wlP1">
              <div style="font-size:12px;font-weight:700;color:#fff;margin-bottom:12px">Data Diri</div>
              <div id="wlReqInfo" class="info-box" style="display:none"></div>
              <div class="form-row"><label class="form-label">Nama IC (Format: Nama_Belakang)</label><input type="text" class="form-input" id="wlIcName" placeholder="Contoh: John_Doe"></div>
              <div class="form-row"><label class="form-label">Nama Lengkap (OOC)</label><input type="text" class="form-input" id="wlFullName" placeholder="Nama lengkap kamu"></div>
              <div class="form-row"><label class="form-label">Umur</label><input type="number" class="form-input" id="wlAge" placeholder="Umur" style="max-width:100px"></div>
              <div class="form-row"><label class="form-label">Nomor WhatsApp</label><input type="text" class="form-input" id="wlWA" placeholder="08xxxxxxxxxx" style="max-width:180px"></div>
              <div class="form-row"><label class="form-label">Pengalaman SA:MP</label><select class="form-input" id="wlExp" style="max-width:220px"><option value="">Pilih...</option><option value="veteran">Veteran (sudah lama)</option><option value="menengah">Menengah</option><option value="pemula">Pemula (baru belajar)</option></select></div>
              <div class="form-row"><label class="form-label">Fraksi yang Diminati</label><input type="text" class="form-input" id="wlFaction" placeholder="Civilian, LSPD, dll" style="max-width:220px"></div>
              <button class="btn btn-primary" onclick="wlNext(1)">Lanjut ‚Üí</button>
            </div>
            <div id="wlP2" style="display:none">
              <div style="font-size:12px;font-weight:700;color:#fff;margin-bottom:12px">Pengetahuan Roleplay</div>
              <div class="form-row"><label class="form-label">Apa itu Roleplay?</label><textarea class="form-input" id="wlQ1" placeholder="Jelaskan dengan kata-katamu sendiri..."></textarea></div>
              <div class="form-row"><label class="form-label">Apa itu Metagaming? Berikan contoh!</label><textarea class="form-input" id="wlQ2" placeholder="Penjelasan + contoh..."></textarea></div>
              <div class="form-row"><label class="form-label">Apa itu Powergaming? Berikan contoh!</label><textarea class="form-input" id="wlQ3" placeholder="Penjelasan + contoh..."></textarea></div>
              <div class="form-row"><label class="form-label">Alasan bergabung di Miracle RP</label><textarea class="form-input" id="wlReason" placeholder="Alasan kamu..."></textarea></div>
              <div style="display:flex;gap:7px"><button class="btn" onclick="wlBack(2)">‚Üê Kembali</button><button class="btn btn-primary" onclick="wlNext(2)">Lanjut ‚Üí</button></div>
            </div>
            <div id="wlP3" style="display:none">
              <div style="font-size:12px;font-weight:700;color:#fff;margin-bottom:10px">Verifikasi</div>
              <p style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">Pastikan semua data sudah benar sebelum submit.</p>
              <div id="wlPreview" class="info-box" style="font-size:11px;line-height:1.9"></div>
              <div style="display:flex;gap:7px"><button class="btn" onclick="wlBack(3)">‚Üê Kembali</button><button class="btn btn-primary" onclick="wlSubmit()">Kirim Pendaftaran</button></div>
            </div>
            <div id="wlP4" style="display:none;text-align:center;padding:24px 0">
              <div style="font-size:32px;margin-bottom:10px">‚úÖ</div>
              <div style="font-size:15px;font-weight:700;color:var(--green);margin-bottom:7px">Pendaftaran Berhasil!</div>
              <div style="font-size:11.5px;color:var(--text3)">Tunggu review dari staff. Pantau status di halaman ini.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Syarat WL</div><div class="widget-body" id="wlReqWidget" style="font-size:11.5px;color:var(--text2);line-height:1.9">Memuat...</div></div>
      <div class="widget"><div class="widget-title">Status WL</div><div class="widget-body" style="padding:0 11px">
        <div class="stat-row"><span>Pending</span><span class="sv" id="wlSidePending">‚Äî</span></div>
        <div class="stat-row"><span>Diproses</span><span class="sv" id="wlSideProcess">‚Äî</span></div>
        <div class="stat-row"><span>Diterima</span><span class="sv" id="wlSideAccepted">‚Äî</span></div>
      </div></div>
    </div>
  </div>
</div>

<!-- CS -->
<div class="page" id="page-cs">
  <div class="page-layout">
    <div class="main-col">
      <div id="csMyStatus" style="display:none"></div>
      <div id="csFormWrap">
        <div id="csClosedBox" class="info-box closed" style="display:none">üö´ CS Request sedang ditutup.</div>
        <div id="csOpenWrap">
          <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Character Story Request</div>
          <div class="card" style="padding:18px">
            <div id="csInfoBox" class="info-box">Memuat info...</div>
            <div class="form-row"><label class="form-label">Nama IC (sesuai WL)</label><input type="text" class="form-input" id="csIcName" placeholder="Nama_IC"></div>
            <div class="form-row"><label class="form-label">Nama Character Story</label><input type="text" class="form-input" id="csCharName" placeholder="Nama karakter CS"></div>
            <div class="form-row"><label class="form-label">Usia Karakter</label><input type="number" class="form-input" id="csAge" placeholder="Usia" style="max-width:100px"></div>
            <div class="form-row"><label class="form-label">Level Karakter</label><input type="number" class="form-input" id="csLevel" placeholder="Level" style="max-width:100px"></div>
            <div class="form-row"><label class="form-label">Screenshot Level (link)</label><input type="text" class="form-input" id="csScreenshot" placeholder="https://..."></div>
            <div class="form-row"><label class="form-label">Story IC <span id="csMinWordLbl" style="font-size:9.5px;color:var(--text3)">(min. 150 kata)</span></label><textarea class="form-input" id="csStory" rows="6" placeholder="Ceritakan latar belakang karakter..."></textarea><div style="font-size:10px;color:var(--text3);margin-top:3px" id="csWordCount">0 kata</div></div>
            <div class="form-row"><label class="form-label">Jadwal Review</label>
              <div id="csSlots" style="display:flex;flex-wrap:wrap;gap:5px;margin-top:4px"></div>
            </div>
            <button class="btn btn-primary" onclick="submitCS()">Kirim CS Request</button>
          </div>
        </div>
      </div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Panduan CS</div><div class="widget-body" id="csPanduanWidget" style="font-size:11.5px;color:var(--text2);line-height:1.9">Memuat...</div></div>
    </div>
  </div>
</div>

<!-- IMPORT -->
<div class="page" id="page-import">
  <div class="page-layout">
    <div class="main-col">
      <div id="importMyStatus" style="display:none"></div>
      <div id="importFormWrap">
        <div id="importClosedBox" class="info-box closed" style="display:none">üö´ Import Request sedang ditutup.</div>
        <div id="importOpenWrap">
          <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Import Request</div>
          <div class="card" style="padding:18px">
            <div id="importInfoBox" class="info-box">Memuat info...</div>
            <div class="form-row"><label class="form-label">Jenis Import</label>
              <div class="imp-type-grid">
                <div class="imp-type-btn" id="impGoodside" onclick="selectImpType(this,'goodside')"><div class="it-icon">üîµ</div><div class="it-lbl">Goodside</div></div>
                <div class="imp-type-btn" id="impBadside" onclick="selectImpType(this,'badside')"><div class="it-icon">üî¥</div><div class="it-lbl">Badside</div></div>
                <div class="imp-type-btn" id="impFamily" onclick="selectImpType(this,'family')"><div class="it-icon">üë®‚Äçüë©‚Äçüëß</div><div class="it-lbl">Family</div></div>
              </div>
            </div>
            <div class="form-row"><label class="form-label">Nama Karakter (charName)</label><input type="text" class="form-input" id="importCharName" placeholder="Nama karakter tujuan"></div>
            <div class="form-row"><label class="form-label">Fraksi / Family Tujuan</label><input type="text" class="form-input" id="importFaction" placeholder="Nama fraksi atau family"></div>
            <div class="form-row"><label class="form-label">Items / Aset yang Dibawa</label><textarea class="form-input" id="importItems" rows="2" placeholder="List item, uang, kendaraan, dll"></textarea></div>
            <div class="form-row"><label class="form-label">Lore IC (Alasan)</label><textarea class="form-input" id="importLore" rows="4" placeholder="Jelaskan alasan in-character..."></textarea></div>
            <div class="form-row"><label class="form-label">Bukti Pendukung (link)</label><input type="text" class="form-input" id="importProof" placeholder="https://..."></div>
            <button class="btn btn-primary" onclick="submitImport()">Kirim Request</button>
          </div>
        </div>
      </div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Ketentuan Import</div><div class="widget-body" id="importReqWidget" style="font-size:11.5px;color:var(--text2);line-height:1.9">Memuat...</div></div>
    </div>
  </div>
</div>

<!-- STAFF -->
<div class="page" id="page-staff">
  <div class="page-layout">
    <div class="main-col">
      <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Tim Staff Miracle RP</div>
      <div class="staff-grid" id="staffGrid"></div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Hubungi Staff</div><div class="widget-body" style="font-size:11.5px;color:var(--text2);line-height:2"><p id="staffWAInfo">WhatsApp: memuat...</p><p>‚è∞ Jam aktif: 17:00‚Äì24:00 WIB</p></div></div>
    </div>
  </div>
</div>

<!-- LEADERBOARD -->
<div class="page" id="page-leaderboard">
  <div class="page-layout">
    <div class="main-col">
      <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Leaderboard</div>
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this,'lb-posts')">Posts Terbanyak</button>
        <button class="tab-btn" onclick="switchTab(this,'lb-wl')">WL Terbaru</button>
      </div>
      <div class="tab-panel active" id="lb-posts"><div class="card" id="lbPostsList"></div></div>
      <div class="tab-panel" id="lb-wl"><div class="card" id="lbWLList"></div></div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Role Colors</div><div class="widget-body" style="padding:0 11px">
        <div class="stat-row"><span class="r-owner">Owner</span></div>
        <div class="stat-row"><span class="r-admin">Admin</span></div>
        <div class="stat-row"><span class="r-communityhandle">Staff</span></div>
        <div class="stat-row"><span class="r-vip">VIP</span></div>
        <div class="stat-row"><span class="r-user">Member</span></div>
      </div></div>
    </div>
  </div>
</div>

<!-- REPORT -->
<div class="page" id="page-report">
  <div class="page-layout">
    <div class="main-col">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this,'rp-form')">Buat Laporan</button>
        <button class="tab-btn" onclick="switchTab(this,'rp-mine');loadMyReports()">Laporan Saya</button>
      </div>
      <div class="tab-panel active" id="rp-form">
        <div class="info-box warn" style="margin-bottom:10px">‚ö†Ô∏è Sertakan bukti valid. Laporan palsu = sanksi.</div>
        <div class="card" style="padding:16px">
          <div class="form-row"><label class="form-label">Nama Karakter Pelapor</label><input type="text" class="form-input" id="repReporter" placeholder="Nama_IC_Kamu"></div>
          <div class="form-row"><label class="form-label">Nama / ID Terlapor</label><input type="text" class="form-input" id="repTarget" placeholder="Nama_IC / Mask 123456"></div>
          <div class="form-row"><label class="form-label">Jenis Pelanggaran</label><select class="form-input" id="repType"><option value="">Pilih...</option><option>DM (Deathmatch)</option><option>VDM</option><option>Hack / Cheat</option><option>Bug Abuse</option><option>Bad RP</option><option>OOC Harassment</option><option>Scam</option><option>Lainnya</option></select></div>
          <div class="form-row"><label class="form-label">Tanggal & Waktu</label><input type="datetime-local" class="form-input" id="repDate" style="max-width:220px"></div>
          <div class="form-row"><label class="form-label">Kronologi</label><textarea class="form-input" id="repKronologi" rows="5" placeholder="Jelaskan secara detail..."></textarea></div>
          <div class="form-row"><label class="form-label">Link Bukti</label><input type="text" class="form-input" id="repBukti" placeholder="https://..."></div>
          <button class="btn btn-primary" onclick="submitReport()">Kirim Laporan</button>
        </div>
      </div>
      <div class="tab-panel" id="rp-mine"><div class="card" id="myReportsList"></div></div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Panduan Report</div><div class="widget-body" style="font-size:11.5px;color:var(--text2);line-height:1.9"><p>1. Sertakan bukti valid</p><p>2. Isi semua kolom</p><p>3. Jangan laporan palsu</p><p>4. Tunggu respons staff</p></div></div>
    </div>
  </div>
</div>

<!-- ANNOUNCEMENTS -->
<div class="page" id="page-announcements">
  <div class="page-layout">
    <div class="main-col">
      <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Pengumuman</div>
      <div id="annList"></div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Info</div><div class="widget-body" style="font-size:11.5px;color:var(--text2)">Pengumuman resmi dari tim Miracle RP.</div></div>
    </div>
  </div>
</div>

<!-- RULES/GUIDES -->
<div class="page" id="page-rules">
  <div class="page-layout">
    <div class="main-col">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this,'rules-tab');loadGuides('rules')">Rules Server</button>
        <button class="tab-btn" onclick="switchTab(this,'guide-job');loadGuides('guide_job')">Guide Job</button>
        <button class="tab-btn" onclick="switchTab(this,'guide-good');loadGuides('guide_goodside')">Goodside</button>
        <button class="tab-btn" onclick="switchTab(this,'guide-bad');loadGuides('guide_badside')">Badside</button>
      </div>
      <div class="tab-panel active" id="rules-tab"><div id="guideRules"><div style="padding:24px;text-align:center;color:var(--text3)">Memuat...</div></div></div>
      <div class="tab-panel" id="guide-job"><div id="guideJob"></div></div>
      <div class="tab-panel" id="guide-good"><div id="guideGood"></div></div>
      <div class="tab-panel" id="guide-bad"><div id="guideBad"></div></div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Navigasi</div><div class="widget-body" style="padding:0 11px">
        <div class="stat-row" style="cursor:pointer" onclick="switchTab(document.querySelector('.tab-btn'),'rules-tab');loadGuides('rules')"><span>Rules Server</span></div>
        <div class="stat-row"><span>Guide Job</span></div>
        <div class="stat-row"><span>Guide Goodside</span></div>
        <div class="stat-row"><span>Guide Badside</span></div>
      </div></div>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div class="page" id="page-profile">
  <div style="max-width:820px">
    <div class="card" style="margin-bottom:10px;overflow:visible">
      <div class="prof-banner"></div>
      <div class="prof-head">
        <div class="prof-ava" id="profAva">?</div>
        <div style="flex:1">
          <div style="font-size:17px;font-weight:700;color:#fff" id="profName">‚Äî</div>
          <span id="profRoleBadge" style="font-size:10px;color:var(--text3)">Member</span>
          <div style="display:flex;gap:16px;margin-top:8px">
            <div class="p-stat"><span class="pv" id="profPostCount">0</span><span class="pl">Posts</span></div>
            <div class="p-stat"><span class="pv" id="profJoined">‚Äî</span><span class="pl">Bergabung</span></div>
          </div>
        </div>
        <div style="margin-left:auto;align-self:flex-start;margin-top:36px">
          <button class="btn btn-danger btn-sm" id="profLogoutBtn" onclick="logoutUser()" style="display:none">Logout</button>
        </div>
      </div>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(this,'prof-about')">Tentang</button>
      <button class="tab-btn" onclick="switchTab(this,'prof-posts');loadMyPosts()">Postingan</button>
      <button class="tab-btn" onclick="switchTab(this,'prof-settings')">Pengaturan</button>
    </div>
    <div class="tab-panel active" id="prof-about">
      <div class="card" style="padding:13px">
        <div class="detail-row"><div class="dk">Username</div><div class="dv" id="profUsername">‚Äî</div></div>
        <div class="detail-row"><div class="dk">Email</div><div class="dv" id="profEmail">‚Äî</div></div>
        <div class="detail-row"><div class="dk">Status WL</div><div class="dv" id="profWLStatus">‚Äî</div></div>
        <div class="detail-row" style="margin-bottom:0"><div class="dk">IC Name</div><div class="dv" id="profICName">‚Äî</div></div>
      </div>
    </div>
    <div class="tab-panel" id="prof-posts"><div class="card" id="myPostsList"><div style="padding:18px;text-align:center;color:var(--text3)">Memuat...</div></div></div>
    <div class="tab-panel" id="prof-settings">
      <div class="card" style="padding:16px;max-width:400px">
        <div class="form-row"><label class="form-label">Username</label><input type="text" class="form-input" id="settingsUsername" placeholder="Username"></div>
        <button class="btn btn-primary" onclick="saveProfile()">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- PM -->
<div class="page" id="page-pm" style="padding:16px 0">
  <div class="chat-wrap">
    <div class="chat-sidebar">
      <div class="chat-sidebar-hdr"><span>Pesan</span><button class="btn btn-primary btn-sm" onclick="openModal('modalNewPM')">+ Baru</button></div>
      <div class="chat-sb-search"><input type="text" placeholder="Cari..." oninput="filterPMList(this.value)"></div>
      <div class="chat-list" id="pmList"></div>
    </div>
    <div class="chat-main">
      <div class="chat-main-hdr" id="chatHdr" style="display:none">
        <div class="ci-ava" id="chatHdrAva">?</div>
        <div id="chatHdrName">‚Äî</div>
      </div>
      <div class="chat-msgs" id="chatMsgs"><div style="text-align:center;padding:36px;color:var(--text3);font-size:12px">Pilih percakapan atau mulai yang baru.</div></div>
      <div class="chat-input-area" id="chatInputArea" style="display:none">
        <div class="chat-input-wrap">
          <textarea class="chat-textarea" id="chatInput" placeholder="Tulis pesan..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChatMsg()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,90)+'px'"></textarea>
        </div>
        <button class="send-btn" onclick="sendChatMsg()">‚ñ∂</button>
      </div>
    </div>
  </div>
</div>

</div><!-- /wrap -->

<!-- ADMIN (full width) -->
<div class="page" id="page-admin">
  <div class="adm-layout">
    <div class="adm-sidebar" id="admSidebar"></div>
    <div class="adm-content" id="admContent">

      <div id="adm-overview" class="adm-tab active">
        <div class="adm-title">Dashboard</div><div class="adm-sub">Statistik real-time Miracle RP</div>
        <div class="adm-cards">
          <div class="adm-card"><div class="acl">Member</div><div class="acv" id="admMembers">‚Äî</div></div>
          <div class="adm-card"><div class="acl">WL Pending</div><div class="acv" style="color:var(--red)" id="admWLPend">‚Äî</div></div>
          <div class="adm-card"><div class="acl">CS Pending</div><div class="acv" id="admCSPend">‚Äî</div></div>
          <div class="adm-card"><div class="acl">Import Pending</div><div class="acv" id="admImpPend">‚Äî</div></div>
          <div class="adm-card"><div class="acl">Report Open</div><div class="acv" style="color:var(--orange)" id="admRepOpen">‚Äî</div></div>
          <div class="adm-card"><div class="acl">WL Diterima</div><div class="acv" style="color:var(--green)" id="admWLAcc">‚Äî</div></div>
          <div class="adm-card"><div class="acl">Banned</div><div class="acv" style="color:var(--red)" id="admBanned">‚Äî</div></div>
          <div class="adm-card"><div class="acl">Staff</div><div class="acv" style="color:var(--blue)" id="admStaff">‚Äî</div></div>
        </div>
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:7px">Aktivitas Terbaru</div>
        <div class="log-stream" id="dashLogStream"></div>
      </div>

      <div id="adm-adminChat" class="adm-tab" style="display:none">
        <div class="adm-title">Admin Chat</div><div class="adm-sub">Diskusi internal tim staff</div>
        <div class="adm-chat-wrap">
          <div class="adm-chat-msgs" id="admChatMsgs"></div>
          <div class="adm-chat-input">
            <input id="admChatInput" placeholder="Tulis ke tim admin..." onkeydown="if(event.key==='Enter')sendAdminChat()">
            <button onclick="sendAdminChat()">Kirim</button>
          </div>
        </div>
      </div>

      <div id="adm-wlPending" class="adm-tab" style="display:none">
        <div class="adm-title">Pending Whitelist</div><div class="adm-sub">Review antrian WL</div>
        <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Antrian WL <span id="wlPendLbl" style="color:var(--red);font-size:9px"></span></div><input class="tbl-search" placeholder="Cari..." oninput="filterTbl('tblWLPend',this.value)"></div>
        <table id="tblWLPend"><thead><tr><th>Nama IC</th><th>WA</th><th>Fraksi</th><th>Tgl Daftar</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbodyWLPend"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-wlAll" class="adm-tab" style="display:none">
        <div class="adm-title">Semua Whitelist</div>
        <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Riwayat WL</div><input class="tbl-search" placeholder="Cari..." oninput="filterTbl('tblWLAll',this.value)"></div>
        <table id="tblWLAll"><thead><tr><th>Nama IC</th><th>Username</th><th>WA</th><th>Status</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody id="tbodyWLAll"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-csPending" class="adm-tab" style="display:none">
        <div class="adm-title">Pending CS Request</div>
        <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Antrian CS</div><input class="tbl-search" placeholder="Cari..." oninput="filterTbl('tblCSPend',this.value)"></div>
        <table id="tblCSPend"><thead><tr><th>IC Name</th><th>Char Name</th><th>Level</th><th>Jadwal</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbodyCSPend"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-csAll" class="adm-tab" style="display:none">
        <div class="adm-title">Semua CS Request</div>
        <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Riwayat CS</div><input class="tbl-search" placeholder="Cari..." oninput="filterTbl('tblCSAll',this.value)"></div>
        <table id="tblCSAll"><thead><tr><th>IC Name</th><th>Char Name</th><th>Level</th><th>Status</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody id="tbodyCSAll"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-importReq" class="adm-tab" style="display:none">
        <div class="adm-title">Import Requests</div>
        <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Antrian Import</div><input class="tbl-search" placeholder="Cari..." oninput="filterTbl('tblImport',this.value)"></div>
        <table id="tblImport"><thead><tr><th>Username</th><th>charName</th><th>Tipe</th><th>Fraksi</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbodyImport"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-users" class="adm-tab" style="display:none">
        <div class="adm-title">Users & Role</div>
        <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Daftar User</div><input class="tbl-search" placeholder="Cari..." oninput="filterTbl('tblUsers',this.value)"></div>
        <table id="tblUsers"><thead><tr><th>Username</th><th>Email</th><th>Role</th><th>WL</th><th>IC Name</th><th>Joined</th><th>Aksi</th></tr></thead><tbody id="tbodyUsers"><tr class="empty-row"><td colspan="7">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-banned" class="adm-tab" style="display:none">
        <div class="adm-title">Banned Users</div>
        <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Banned List</div></div>
        <table id="tblBanned"><thead><tr><th>Username</th><th>Email</th><th>Alasan</th><th>Oleh</th><th>Aksi</th></tr></thead><tbody id="tbodyBanned"><tr class="empty-row"><td colspan="5">Tidak ada.</td></tr></tbody></table></div>
      </div>

      <div id="adm-reports" class="adm-tab" style="display:none">
        <div class="adm-title">Reports</div>
        <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Daftar Report</div><input class="tbl-search" placeholder="Cari..." oninput="filterTbl('tblReports',this.value)"></div>
        <table id="tblReports"><thead><tr><th>Pelapor</th><th>Terlapor</th><th>Jenis</th><th>Status</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody id="tbodyReports"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-announce" class="adm-tab" style="display:none">
        <div class="adm-title">Kelola Pengumuman</div>
        <div style="display:grid;grid-template-columns:1fr 300px;gap:12px;align-items:start">
          <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Pengumuman</div></div><div id="annAdminList" style="padding:8px"></div></div>
          <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Buat Pengumuman</div></div>
          <div style="padding:12px">
            <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:8px" id="annTagPicker">
              <span class="role-chip sel" onclick="selAnnTag(this,'ANNOUNCEMENT')">ANNOUNCEMENT</span>
              <span class="role-chip" onclick="selAnnTag(this,'MAINTENANCE')">MAINTENANCE</span>
              <span class="role-chip" onclick="selAnnTag(this,'WARNING')">WARNING</span>
              <span class="role-chip" onclick="selAnnTag(this,'INFO')">INFO</span>
            </div>
            <div class="form-row"><label class="form-label">Judul</label><input type="text" class="form-input" id="annTitleInput" placeholder="Judul..."></div>
            <div class="form-row"><label class="form-label">Isi</label><textarea class="form-input" id="annBodyInput" rows="4" placeholder="Isi pengumuman..."></textarea></div>
            <button class="btn btn-primary" style="width:100%" onclick="postAnn()">Posting</button>
          </div></div>
        </div>
      </div>

      <div id="adm-guides" class="adm-tab" style="display:none">
        <div class="adm-title">Kelola Guides & Rules</div>
        <div style="display:grid;grid-template-columns:1fr 300px;gap:12px;align-items:start">
          <div class="tbl-wrap">
            <div class="tbl-hdr"><div class="tbl-title">Artikel</div>
              <select class="tbl-search" id="guideTypeFilter" onchange="loadAdmGuides()" style="width:140px">
                <option value="rules">Rules Server</option>
                <option value="guide_job">Guide Job</option>
                <option value="guide_goodside">Guide Goodside</option>
                <option value="guide_badside">Guide Badside</option>
              </select>
            </div>
            <div id="guideAdmList" style="padding:8px"></div>
          </div>
          <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title" id="guideFormTitle">Tambah Artikel</div></div>
          <div style="padding:12px">
            <div class="form-row"><label class="form-label">Judul</label><input type="text" class="form-input" id="guideTitleInput" placeholder="Judul..."></div>
            <div class="form-row"><label class="form-label">Tag</label><input type="text" class="form-input" id="guideTagInput" placeholder="WAJIB BACA, dll"></div>
            <div class="form-row"><label class="form-label">Konten</label><textarea class="form-input" id="guideBodyInput" rows="5" placeholder="Isi artikel..."></textarea></div>
            <label style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text2);margin-bottom:8px;cursor:pointer"><input type="checkbox" id="guidePinnedInput"> Pinned</label>
            <button class="btn btn-primary" style="width:100%" onclick="submitGuide()">Simpan</button>
            <button class="btn" id="cancelGuideBtn" onclick="cancelGuideEdit()" style="display:none;width:100%;margin-top:4px">Batal Edit</button>
          </div></div>
        </div>
      </div>

      <div id="adm-staff" class="adm-tab" style="display:none">
        <div class="adm-title">Kelola Staff List</div>
        <div style="display:grid;grid-template-columns:1fr 260px;gap:12px;align-items:start">
          <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Staff</div></div>
          <table><thead><tr><th>Nama</th><th>Role</th><th>WA</th><th>Aksi</th></tr></thead><tbody id="staffAdmTbody"><tr class="empty-row"><td colspan="4">Memuat...</td></tr></tbody></table></div>
          <div class="tbl-wrap"><div class="tbl-hdr"><div class="tbl-title">Tambah Staff</div></div>
          <div style="padding:12px">
            <div class="form-row"><label class="form-label">Nama</label><input type="text" class="form-input" id="staffNameInput" placeholder="Nama"></div>
            <div class="form-row"><label class="form-label">Role</label><select class="form-input" id="staffRoleInput"><option value="Owner">Owner</option><option value="Co-Owner">Co-Owner</option><option value="Developer">Developer</option><option value="Head Admin">Head Admin</option><option value="Senior Admin">Senior Admin</option><option value="Admin">Admin</option><option value="Junior Admin">Junior Admin</option><option value="Management">Management</option><option value="Moderator">Moderator</option><option value="Community Handle">Community Handle</option><option value="Senior Helper">Senior Helper</option><option value="Helper">Helper</option><option value="Junior Helper">Junior Helper</option><option value="Volunteer">Volunteer</option><option value="Ex Staff">Ex Staff</option></select></div>
            <div class="form-row"><label class="form-label">WhatsApp (nomor)</label><input type="text" class="form-input" id="staffWAInput" placeholder="628xxxxxxxxxx"></div>
            <button class="btn btn-primary" style="width:100%" onclick="addStaff()">Tambah</button>
          </div></div>
        </div>
      </div>

      <div id="adm-settings" class="adm-tab" style="display:none">
        <div class="adm-title">Pengaturan Sistem</div><div class="adm-sub">Semua konfigurasi bisa diubah di sini, langsung tersimpan ke database</div>
        <div class="settings-grid">
          <div class="s-card">
            <div class="s-card-title">Server Config</div>
            <div class="form-row"><label class="form-label">IP SA:MP</label><input type="text" class="form-input" id="cfgServerIP" placeholder="ip:port"></div>
            <div class="form-row"><label class="form-label">Nama Server</label><input type="text" class="form-input" id="cfgServerName" placeholder="MIRACLE ROLEPLAY"></div>
            <div class="form-row"><label class="form-label">Nomor WA Admin</label><input type="text" class="form-input" id="cfgWANumber" placeholder="628xxxxxxxxxx"></div>
            <div class="form-row"><label class="form-label">Link WA Group</label><input type="text" class="form-input" id="cfgWAGroup" placeholder="https://chat.whatsapp.com/..."></div>
            <div class="form-row"><label class="form-label">Deskripsi Server</label><textarea class="form-input" id="cfgDescription" rows="2"></textarea></div>
            <div class="form-row"><label class="form-label">Post Cooldown (menit)</label><input type="number" class="form-input" id="cfgPostCooldown" style="max-width:90px"></div>
            <button class="btn btn-primary" onclick="saveServerConfig()">Simpan</button>
          </div>
          <div class="s-card">
            <div class="s-card-title">Whitelist Settings</div>
            <div class="form-row"><label class="form-label">Status WL</label><select class="form-input" id="cfgWLOpen"><option value="1">üü¢ Terbuka</option><option value="0">üî¥ Ditutup</option></select></div>
            <div class="form-row"><label class="form-label">Syarat WL (satu per baris)</label><textarea class="form-input" id="cfgWLReq" rows="5" placeholder="Min. 17 tahun&#10;WA aktif&#10;Mengerti RP dasar"></textarea></div>
            <button class="btn btn-primary" onclick="saveWLConfig()">Simpan WL</button>
          </div>
          <div class="s-card">
            <div class="s-card-title">CS Request Settings</div>
            <div class="form-row"><label class="form-label">Status CS</label><select class="form-input" id="cfgCSOpen"><option value="1">üü¢ Terbuka</option><option value="0">üî¥ Ditutup</option></select></div>
            <div class="form-row"><label class="form-label">Info CS</label><textarea class="form-input" id="cfgCSInfo" rows="2"></textarea></div>
            <div class="form-row"><label class="form-label">Jadwal Review (pisah koma)</label><input type="text" class="form-input" id="cfgCSSchedules" placeholder="Senin 19:00,Kamis 19:00"></div>
            <div class="form-row"><label class="form-label">Min. Kata Story</label><input type="number" class="form-input" id="cfgCSMinWords" style="max-width:90px"></div>
            <div class="form-row"><label class="form-label">Panduan CS (satu per baris)</label><textarea class="form-input" id="cfgCSPanduan" rows="4"></textarea></div>
            <button class="btn btn-primary" onclick="saveCSConfig()">Simpan CS</button>
          </div>
          <div class="s-card">
            <div class="s-card-title">Import Request Settings</div>
            <div class="form-row"><label class="form-label">Import (master)</label><select class="form-input" id="cfgImportOpen"><option value="1">üü¢ Buka</option><option value="0">üî¥ Tutup</option></select></div>
            <div class="form-row"><label class="form-label">Goodside</label><select class="form-input" id="cfgGoodside"><option value="1">üü¢ Buka</option><option value="0">üî¥ Tutup</option></select></div>
            <div class="form-row"><label class="form-label">Badside</label><select class="form-input" id="cfgBadside"><option value="1">üü¢ Buka</option><option value="0">üî¥ Tutup</option></select></div>
            <div class="form-row"><label class="form-label">Family</label><select class="form-input" id="cfgFamily"><option value="1">üü¢ Buka</option><option value="0">üî¥ Tutup</option></select></div>
            <div class="form-row"><label class="form-label">Info Import</label><textarea class="form-input" id="cfgImportInfo" rows="2"></textarea></div>
            <div class="form-row"><label class="form-label">Ketentuan Import (satu per baris)</label><textarea class="form-input" id="cfgImportReq" rows="4"></textarea></div>
            <button class="btn btn-primary" onclick="saveImportConfig()">Simpan Import</button>
          </div>
        </div>
      </div>

      <div id="adm-logs" class="adm-tab" style="display:none">
        <div class="adm-title">System Logs</div><div class="adm-sub">Riwayat semua aktivitas</div>
        <div class="tbl-wrap">
          <div class="tbl-hdr">
            <div class="tbl-title">Activity Log</div>
            <div style="display:flex;gap:5px">
              <select class="tbl-search" style="width:110px" id="logTypeFilter" onchange="renderLogs()">
                <option value="">Semua</option><option>AUTH</option><option>WL</option><option>WL_REVIEW</option>
                <option>CS</option><option>CS_REVIEW</option><option>IMPORT</option><option>BAN</option>
                <option>ROLE</option><option>NEWS</option><option>POST</option><option>SYSTEM</option><option>CHAT</option>
              </select>
              <button class="btn btn-danger btn-sm" id="clearLogsBtn" onclick="clearAllLogs()" style="display:none">Clear</button>
            </div>
          </div>
          <div class="log-stream" id="logStream" style="max-height:520px;border:none"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// ============================================================
// GLOBALS ‚Äî ALL DATA LIVES IN RTDB
// ============================================================
let CU = null;        // current Firebase user
let UP = null;        // user profile from RTDB /users/{uid}
let CFG = {};         // /config
let appConfig = {};   // full settings from /settings
let activeConvoId = null;
let admChatListener = null;
let logsCache = [];
let selectedImpType = null;
let selectedCSSlot = null;
let editingGuideKey = null;
let selectedAnnTag = 'ANNOUNCEMENT';
let roleTarget = null;
let banTarget = null;
let icTarget = null;

const ALL_PERMS = ['handle_wl','handle_cs','handle_import','handle_goodside','handle_badside','ban_user','edit_icname','manage_news','manage_guides','manage_announce','view_logs','clear_logs','settings','admin_chat','manage_roles'];
const PERM_LABELS = {'handle_wl':'Handle WL','handle_cs':'Handle CS','handle_import':'Handle Import','handle_goodside':'Goodside','handle_badside':'Badside','ban_user':'Ban User','edit_icname':'Edit IC Name','manage_news':'Manage News','manage_guides':'Manage Guides','manage_announce':'Manage Announce','view_logs':'View Logs','clear_logs':'Clear Logs','settings':'Settings','admin_chat':'Admin Chat','manage_roles':'Manage Roles'};
const ROLES = ['owner','developer','headadmin','senioradmin','admin','junioradmin','management','moderator','communityhandle','seniorhelper','helper','juniorhelper','volunteer','exstaff','vip','user'];
const ROLE_LABELS = {owner:'Owner',developer:'Developer',headadmin:'Head Admin',senioradmin:'Senior Admin',admin:'Admin',junioradmin:'Junior Admin',management:'Management',moderator:'Moderator',communityhandle:'Community Handle',seniorhelper:'Senior Helper',helper:'Helper',juniorhelper:'Junior Helper',volunteer:'Volunteer',exstaff:'Ex Staff',vip:'VIP',user:'Member'};
const ADMIN_ROLES = ['owner','developer','headadmin','senioradmin','admin','junioradmin','management','moderator','communityhandle','seniorhelper','helper','juniorhelper','volunteer'];

// ============================================================
// HELPERS
// ============================================================
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }
function ini(n){ if(!n)return '?'; const p=n.trim().split(/\s+/); return (p[0][0]+(p[1]?p[1][0]:'')).toUpperCase() }
function fmtDate(ts){ if(!ts)return '‚Äî'; return new Date(ts).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}) }
function fmtDT(ts){ if(!ts)return '‚Äî'; return new Date(ts).toLocaleString('id-ID',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) }
function timeAgo(ts){ if(!ts)return ''; const d=Math.floor((Date.now()-ts)/1000); if(d<60)return d+'d'; if(d<3600)return Math.floor(d/60)+'m'; if(d<86400)return Math.floor(d/3600)+'j'; return Math.floor(d/86400)+'h lalu' }
function rClass(r){ return 'r-'+(r||'user').toLowerCase().replace(/[\s\/]/g,'') }
function toast(msg,type='i',dur=3200){ const el=document.createElement('div'); el.className='toast '+type; el.innerHTML='<span>'+(type==='s'?'‚úì':type==='e'?'‚úó':'‚Ñπ')+'</span><span>'+esc(msg)+'</span>'; document.getElementById('toastWrap').prepend(el); setTimeout(()=>el.remove(),dur) }
function openModal(id){ document.getElementById(id).classList.add('open') }
function closeModal(id){ document.getElementById(id).classList.remove('open') }
function copyTxt(t){ navigator.clipboard.writeText(t).then(()=>toast('Tersalin!','s')) }
document.addEventListener('keydown',e=>{ if(e.key==='Escape') document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open')) })

// ============================================================
// NAVIGATION
// ============================================================
function nav(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'))
  document.getElementById('page-'+page)?.classList.add('active')
  document.querySelectorAll('.main-nav a').forEach(a=>a.classList.remove('active'))
  document.querySelector(`.main-nav a[data-page="${page}"]`)?.classList.add('active')
  if(page==='feed') initFeed()
  if(page==='whitelist') initWL()
  if(page==='cs') initCS()
  if(page==='import') initImport()
  if(page==='staff') loadStaff()
  if(page==='leaderboard') loadLB()
  if(page==='announcements') loadAnn()
  if(page==='rules') loadGuides('rules')
  if(page==='pm') initPM()
  if(page==='profile') initProfile()
  if(page==='admin') initAdmin()
  window.scrollTo(0,0)
}
function switchTab(btn,panelId){
  const parent = btn.closest('.tabs'); if(!parent) return
  parent.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'))
  btn.classList.add('active')
  const next = parent.nextElementSibling
  if(next) next.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'))
  document.getElementById(panelId)?.classList.add('active')
}
function openMobNav(){ document.getElementById('mobNav').classList.add('open'); document.getElementById('mobOverlay').classList.add('open') }
function closeMobNav(){ document.getElementById('mobNav').classList.remove('open'); document.getElementById('mobOverlay').classList.remove('open') }

// ============================================================
// AUTH
// ============================================================
async function loginGoogle(){
  try{ const p=new firebase.auth.GoogleAuthProvider(); await firebase.auth().signInWithPopup(p); closeModal('modalLogin'); toast('Login berhasil!','s') }
  catch(e){ toast('Login gagal: '+e.message,'e') }
}
async function logoutUser(){
  await firebase.auth().signOut(); CU=null; UP=null; renderTBAuth(); toast('Logout.','i'); nav('home')
}

firebase.auth().onAuthStateChanged(async u => {
  CU = u
  if(u){
    const snap = await DB.ref('users/'+u.uid).get()
    if(!snap.exists()){
      await DB.ref('users/'+u.uid).set({ uid:u.uid, email:u.email, username:u.displayName||u.email.split('@')[0], photoURL:u.photoURL||'', role:'user', status:'active', wlStatus:'none', icName:'', postCount:0, createdAt:Date.now() })
    }
    UP = (await DB.ref('users/'+u.uid).get()).val()
    if(UP?.status === 'banned'){ await firebase.auth().signOut(); toast('Akun kamu dibanned.','e'); return }
    // merge admin_perms if exists
    const permSnap = await DB.ref('admin_perms/'+u.uid).get()
    if(permSnap.exists()){
      const pd = permSnap.val()
      if(pd.role !== UP.role) await DB.ref('users/'+u.uid).update({ role: pd.role })
      UP.role = pd.role
      UP.perms = pd.perms || []
    }
    addLog('AUTH','Login: '+UP.username+' ('+UP.role+')')
  }
  renderTBAuth()
  loadConfig()
  loadHomeStats()
})

function renderTBAuth(){
  const el = document.getElementById('tbRight')
  if(!CU){ el.innerHTML='<button class="btn" onclick="openModal(\'modalLogin\')">Masuk</button><button class="btn btn-primary" onclick="openModal(\'modalLogin\')">Daftar</button>'; document.getElementById('adminNavLink').style.display='none'; document.getElementById('mobAdminLink').style.display='none'; return }
  const isAdm = ADMIN_ROLES.includes(UP?.role)
  if(isAdm){ document.getElementById('adminNavLink').style.display=''; document.getElementById('mobAdminLink').style.display='' }
  const ava = UP?.photoURL ? `<img src="${UP.photoURL}" style="width:28px;height:28px;border-radius:50%;object-fit:cover">` : `<div style="width:28px;height:28px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;border:1px solid var(--border)">${ini(UP?.username)}</div>`
  el.innerHTML=`<div style="display:flex;align-items:center;gap:7px;cursor:pointer" onclick="nav('profile')">${ava}<span style="font-size:11px;color:var(--text);max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(UP?.username||'')}</span></div>`
}

// ============================================================
// CONFIG ‚Äî read from /config and /settings in RTDB
// ============================================================
function loadConfig(){
  DB.ref('config').on('value', snap => {
    CFG = snap.val() || {}
    applyServerConfig()
  })
  DB.ref('settings').on('value', snap => {
    appConfig = snap.val() || {}
    applyAppConfig()
  })
}

function applyServerConfig(){
  const c = CFG
  const setTxt = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v||'‚Äî' }
  setTxt('srvIP', c.serverIP); setTxt('feedSrvIP', c.serverIP); setTxt('srvWA', c.waNumber)
  setTxt('staffWAInfo','WhatsApp: '+c.waNumber)
  // top ann bar
  DB.ref('announcements').orderByChild('ts').limitToLast(1).get().then(snap=>{
    if(snap.exists()){
      const ann = Object.values(snap.val())[0]
      document.getElementById('topAnnBar').style.display='flex'
      document.getElementById('topAnnText').innerHTML=`<strong>${esc(ann.tag||'INFO')}</strong> ‚Äî ${esc((ann.title||'').substring(0,70))}`
    }
  })
  // features widget
  DB.ref('features').orderByChild('order').get().then(snap=>{
    const fw = document.getElementById('featuresWidget')
    if(fw && snap.exists()){
      const items = Object.values(snap.val()).sort((a,b)=>a.order-b.order)
      fw.innerHTML = items.map(f=>`<div class="stat-row"><span>${f.icon} ${esc(f.title)}</span></div>`).join('')
    }
  })
}

function applyAppConfig(){
  const s = appConfig
  // WL
  const wlOpen = s.wlOpen !== false
  const wcb = document.getElementById('wlClosedBox'); if(wcb) wcb.style.display=wlOpen?'none':''
  const wow = document.getElementById('wlOpenWrap'); if(wow) wow.style.display=wlOpen?'':'none'
  const wlRW = document.getElementById('wlReqWidget')
  if(wlRW) wlRW.innerHTML = (s.wlRequirements||'Min. 17 tahun\nWhatsApp aktif\nMengerti RP dasar').split('\n').filter(Boolean).map(r=>`<p>‚úì ${esc(r)}</p>`).join('')
  const wlRI = document.getElementById('wlReqInfo')
  if(wlRI && s.wlRequirements){ wlRI.style.display=''; wlRI.innerHTML=s.wlRequirements.split('\n').filter(Boolean).map(r=>`‚úì ${esc(r)}`).join(' | ') }
  // CS
  const csOpen = s.csOpen !== false
  const ccb = document.getElementById('csClosedBox'); if(ccb) ccb.style.display=csOpen?'none':''
  const cow = document.getElementById('csOpenWrap'); if(cow) cow.style.display=csOpen?'':'none'
  const cib = document.getElementById('csInfoBox'); if(cib) cib.textContent=s.csInfo||'Jadwal review setiap Senin & Kamis'
  const cml = document.getElementById('csMinWordLbl'); if(cml) cml.textContent='(min. '+(s.csMinWords||150)+' kata)'
  const cpw = document.getElementById('csPanduanWidget')
  if(cpw) cpw.innerHTML=(s.csPanduan||'Min. 150 kata\nKarakter realistis').split('\n').filter(Boolean).map(r=>`<p>‚úì ${esc(r)}</p>`).join('')
  const slots = document.getElementById('csSlots')
  if(slots){ const sl=(s.csSchedules||'Senin 19:00,Kamis 19:00').split(',').map(x=>x.trim()).filter(Boolean); slots.innerHTML=sl.map(x=>`<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:4px 9px;font-size:11px;color:var(--text2);cursor:pointer;transition:all .1s" onclick="selectSlot(this,'${esc(x)}')">${esc(x)}</div>`).join('') }
  // Import
  const impOpen = s.importOpen !== false
  const icb = document.getElementById('importClosedBox'); if(icb) icb.style.display=impOpen?'none':''
  const iow = document.getElementById('importOpenWrap'); if(iow) iow.style.display=impOpen?'':'none'
  const iib = document.getElementById('importInfoBox'); if(iib) iib.textContent=s.importInfo||'Import request dibuka secara berkala'
  const irw = document.getElementById('importReqWidget')
  if(irw) irw.innerHTML=(s.importRequirements||'Harus ada lore IC\nMax 1 request/minggu').split('\n').filter(Boolean).map(r=>`<p>‚úì ${esc(r)}</p>`).join('')
  const types = ['goodside','badside','family']
  types.forEach(t=>{
    const btn = document.getElementById('imp'+t.charAt(0).toUpperCase()+t.slice(1))
    if(btn){ const ok = impOpen && s[t+'Open']!==false; btn.classList.toggle('disabled',!ok) }
  })
}

// ============================================================
// HOME STATS
// ============================================================
function loadHomeStats(){
  DB.ref('users').get().then(s=>{ const v=s.val()||{}; const c=Object.keys(v).length; setText('sideStatMembers',c); setText('hStatPosts',Object.values(v).reduce((a,u)=>a+(u.postCount||0),0)) })
  DB.ref('registrations').get().then(s=>{ const v=s.val()||{}; const vals=Object.values(v); setText('hStatWL',vals.filter(x=>x.status==='pending').length); setText('sideStatWLPend',vals.filter(x=>x.status==='pending').length); setText('sideStatWLAcc',vals.filter(x=>x.status==='accepted').length); setText('wlSidePending',vals.filter(x=>x.status==='pending').length); setText('wlSideProcess',vals.filter(x=>x.process).length); setText('wlSideAccepted',vals.filter(x=>x.status==='accepted').length) })
  DB.ref('cs_requests').get().then(s=>{ setText('hStatCS',s.exists()?Object.values(s.val()||{}).filter(x=>x.status==='pending').length:0) })
  DB.ref('import_requests').get().then(s=>{ setText('hStatImport',s.exists()?Object.values(s.val()||{}).filter(x=>x.status==='pending').length:0) })
  DB.ref('reports').get().then(s=>{ setText('hStatReports',s.exists()?Object.values(s.val()||{}).filter(x=>x.status==='open').length:0) })
}
function setText(id,v){ const el=document.getElementById(id); if(el) el.textContent=v }

// ============================================================
// FEED
// ============================================================
let feedInit=false
function initFeed(){
  if(CU&&UP){ const fc=document.getElementById('feedComposer'); if(fc) fc.style.display=''; const ca=document.getElementById('composerAva'); if(ca){ ca.innerHTML=UP.photoURL?`<img src="${UP.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`:ini(UP.username) } }
  loadFeed()
}
function loadFeed(){
  const list=document.getElementById('feedList'), empty=document.getElementById('feedEmpty'); if(!list) return
  DB.ref('posts').orderByChild('ts').limitToLast(30).get().then(snap=>{
    if(!snap.exists()){ list.innerHTML=''; if(empty) empty.style.display=''; return }
    const posts = Object.entries(snap.val()).reverse()
    list.innerHTML = posts.map(([k,p])=>renderPost(k,p)).join('')
    if(empty) empty.style.display='none'
  })
}
function renderPost(key,p){
  const ava = p.photoURL?`<img src="${p.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`:ini(p.author||'?')
  const likes=Object.keys(p.likes||{}).length, liked=CU&&p.likes&&p.likes[CU.uid]
  const canDel=CU&&(CU.uid===p.uid||(UP&&ADMIN_ROLES.includes(UP.role)))
  return `<div class="post-card" id="pc-${key}">
    <div class="post-header"><div class="post-ava">${ava}</div>
      <div style="flex:1"><div style="font-size:12.5px;font-weight:600">${esc(p.author||'?')} <span class="${rClass(p.role)}" style="font-size:9.5px">[${ROLE_LABELS[p.role]||'Member'}]</span></div><div style="font-size:9.5px;color:var(--text3)">${timeAgo(p.ts)}</div></div>
      ${canDel?`<button class="btn btn-danger btn-sm" onclick="delPost('${key}')">Hapus</button>`:''}
    </div>
    <div class="post-body">${esc(p.content||'')}</div>
    <div class="post-actions">
      <button class="react-btn ${liked?'liked':''}" id="like-${key}" onclick="toggleLike('${key}',this)">‚ù§ ${likes}</button>
      <button class="react-btn" onclick="toggleCmt('${key}')">üí¨ Komentar</button>
    </div>
    <div class="post-comments" id="cmt-${key}" style="display:none">
      <div id="cmtList-${key}" style="margin-bottom:6px"></div>
      ${CU?`<div style="display:flex;gap:6px"><div class="cmt-ava">${ini(UP?.username||'?')}</div><input class="cmt-input" placeholder="Tambah komentar..." onkeydown="if(event.key==='Enter')addComment('${key}',this)"></div>`:''}
    </div>
  </div>`
}
async function submitPost(){
  if(!CU){ openModal('modalLogin'); return }
  const txt=document.getElementById('composerText').value.trim(); if(!txt){ toast('Tulis sesuatu dulu!','e'); return }
  const cooldown = (appConfig.postCooldownMin||60)*60*1000
  const lastPost = await DB.ref('posts').orderByChild('uid').equalTo(CU.uid).limitToLast(1).get()
  if(lastPost.exists()){
    const lp = Object.values(lastPost.val())[0]
    const diff = Date.now()-lp.ts
    if(diff<cooldown){ toast(`Cooldown: tunggu ${Math.ceil((cooldown-diff)/60000)} menit.`,'e'); return }
  }
  const key = DB.ref('posts').push().key
  await DB.ref('posts/'+key).set({ uid:CU.uid, author:UP.username, photoURL:UP.photoURL||'', role:UP.role||'user', wlStatus:UP.wlStatus||'', content:txt, likeCount:0, likes:{}, ts:Date.now() })
  await DB.ref('users/'+CU.uid+'/postCount').transaction(c=>(c||0)+1)
  addLog('POST',UP.username+' posting: '+txt.substring(0,60))
  document.getElementById('composerText').value=''; toast('Post berhasil!','s'); loadFeed()
}
async function delPost(key){
  if(!confirm('Hapus post ini?')) return
  await DB.ref('posts/'+key).remove()
  toast('Post dihapus.','i'); loadFeed()
}
async function toggleLike(key,btn){
  if(!CU){ toast('Login dulu!','e'); return }
  const ref=DB.ref('posts/'+key+'/likes/'+CU.uid)
  const snap=await ref.get()
  if(snap.exists()){ await ref.remove(); btn.className='react-btn'; btn.innerHTML='‚ù§ '+(parseInt(btn.textContent.trim().split(' ')[1]||0)-1) }
  else { await ref.set(true); btn.className='react-btn liked'; btn.innerHTML='‚ù§ '+(parseInt(btn.textContent.trim().split(' ')[1]||0)+1) }
}
async function toggleCmt(key){
  const el=document.getElementById('cmt-'+key); if(!el) return
  const open=el.style.display!=='none'; el.style.display=open?'none':''
  if(!open){ const ls=document.getElementById('cmtList-'+key); if(ls){ const snap=await DB.ref('posts/'+key+'/comments').get(); ls.innerHTML=snap.exists()?Object.values(snap.val()).map(c=>`<div class="comment-item"><div class="cmt-ava">${ini(c.author||'?')}</div><div class="cmt-body"><div class="cmt-author">${esc(c.author||'?')}</div><div class="cmt-text">${esc(c.text||'')}</div></div></div>`).join(''):'<div style="font-size:10.5px;color:var(--text3)">Belum ada komentar.</div>' } }
}
async function addComment(key,input){
  if(!CU||!input.value.trim()) return
  await DB.ref('posts/'+key+'/comments').push({ uid:CU.uid, author:UP.username, text:input.value.trim(), ts:Date.now() })
  input.value=''; toggleCmt(key); toggleCmt(key)
}

// ============================================================
// WHITELIST
// ============================================================
function initWL(){
  checkMyWL()
  loadHomeStats()
}
async function checkMyWL(){
  if(!CU) return
  const snap = await DB.ref('registrations').orderByChild('uid').equalTo(CU.uid).get()
  if(snap.exists()){
    const entries = Object.values(snap.val())
    const latest = entries.sort((a,b)=>b.submittedAt-a.submittedAt)[0]
    const statMap={pending:'<span class="badge b-pending">PENDING</span>',process:'<span class="badge b-process">DIPROSES</span>',accepted:'<span class="badge b-accepted">DITERIMA ‚úì</span>',rejected:'<span class="badge b-rejected">DITOLAK</span>',denied:'<span class="badge b-denied">DITOLAK</span>'}
    const sv=document.getElementById('wlMyStatus'), fw=document.getElementById('wlFormWrap')
    if(['pending','process'].includes(latest.status)){
      sv.style.display=''; fw.style.display='none'
      sv.innerHTML=`<div class="card" style="padding:16px"><div style="font-size:12.5px;font-weight:700;margin-bottom:10px">Status Whitelist Kamu</div><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">${statMap[latest.status]} <span style="font-size:10px;color:var(--text3)">${fmtDate(latest.submittedAt)}</span></div><div class="detail-row"><div class="dk">Nama IC</div><div class="dv">${esc(latest.name||'')}</div></div><div class="detail-row"><div class="dk">Fraksi</div><div class="dv">${esc(latest.faction||'')}</div></div>${latest.adminNote?`<div class="info-box" style="margin-top:10px"><strong>Catatan:</strong> ${esc(latest.adminNote)}</div>`:''}</div>`
    } else if(latest.status==='accepted'){
      sv.style.display=''; fw.style.display='none'
      sv.innerHTML=`<div class="info-box success">‚úÖ Whitelist kamu sudah diterima. IC: <strong>${esc(latest.name)}</strong></div>`
    } else {
      // rejected - bisa daftar ulang
      sv.style.display=''; fw.style.display=''
      sv.innerHTML=`<div class="info-box warn" style="margin-bottom:10px">‚ö†Ô∏è Pendaftaran sebelumnya ditolak. Kamu bisa mendaftar ulang.${latest.adminNote?'<br>Alasan: '+esc(latest.adminNote):''}</div>`
    }
  }
}
let wlData={}
function wlNext(p){
  if(p===1){
    const ic=document.getElementById('wlIcName').value.trim(), fn=document.getElementById('wlFullName').value.trim(), age=document.getElementById('wlAge').value, wa=document.getElementById('wlWA').value.trim(), exp=document.getElementById('wlExp').value
    if(!ic||!fn||!age||!wa||!exp){ toast('Isi semua field!','e'); return }
    if(!CU){ openModal('modalLogin'); return }
    wlData={name:ic,fullName:fn,age:parseInt(age),wa,exp,faction:document.getElementById('wlFaction').value.trim()}
    document.getElementById('wlP1').style.display='none'; document.getElementById('wlP2').style.display=''
    setStep(2)
  } else if(p===2){
    const q1=document.getElementById('wlQ1').value.trim(),q2=document.getElementById('wlQ2').value.trim(),q3=document.getElementById('wlQ3').value.trim(),reason=document.getElementById('wlReason').value.trim()
    if(!q1||!q2||!q3||!reason){ toast('Isi semua pertanyaan!','e'); return }
    wlData={...wlData,q1,q2,q3,reason}
    document.getElementById('wlP2').style.display='none'; document.getElementById('wlP3').style.display=''
    setStep(3)
    document.getElementById('wlPreview').innerHTML=`IC: <b>${esc(wlData.name)}</b> | Nama: <b>${esc(wlData.fullName)}</b> | Umur: <b>${wlData.age}</b> | WA: <b>${esc(wlData.wa)}</b> | Fraksi: <b>${esc(wlData.faction||'-')}</b>`
  }
}
function wlBack(p){
  if(p===2){ document.getElementById('wlP2').style.display='none'; document.getElementById('wlP1').style.display=''; setStep(1) }
  else if(p===3){ document.getElementById('wlP3').style.display='none'; document.getElementById('wlP2').style.display=''; setStep(2) }
}
function setStep(n){
  for(let i=1;i<=4;i++){
    const s=document.getElementById('wlS'+i)
    if(!s) continue
    s.className='wl-step'+(i<n?' done':i===n?' active':'')
  }
}
async function wlSubmit(){
  if(!CU){ toast('Login dulu!','e'); return }
  try{
    const key=DB.ref('registrations').push().key
    await DB.ref('registrations/'+key).set({ ...wlData, uid:CU.uid, email:CU.email, username:UP.username, status:'pending', submittedAt:Date.now() })
    await DB.ref('users/'+CU.uid).update({ wlStatus:'pending' })
    addLog('WL',UP.username+' daftar WL: '+wlData.name)
    document.getElementById('wlP3').style.display='none'; document.getElementById('wlP4').style.display=''; setStep(4)
    toast('Pendaftaran berhasil!','s'); loadHomeStats()
  }catch(e){ toast('Gagal: '+e.message,'e') }
}

// ============================================================
// CS
// ============================================================
function initCS(){
  checkMyCS()
  document.getElementById('csStory')?.addEventListener('input',function(){ document.getElementById('csWordCount').textContent=this.value.trim().split(/\s+/).filter(Boolean).length+' kata' })
}
function selectSlot(el,val){ document.querySelectorAll('#csSlots > div').forEach(s=>{ s.style.borderColor='var(--border)'; s.style.color='var(--text2)' }); el.style.borderColor='#fff'; el.style.color='#fff'; selectedCSSlot=val }
async function checkMyCS(){
  if(!CU) return
  const snap=await DB.ref('cs_requests').orderByChild('uid').equalTo(CU.uid).limitToLast(1).get()
  if(snap.exists()){
    const d=Object.values(snap.val())[0]
    if(['pending','process'].includes(d.status)){
      document.getElementById('csMyStatus').style.display=''; document.getElementById('csFormWrap').style.display='none'
      document.getElementById('csMyStatus').innerHTML=`<div class="card" style="padding:14px;margin-bottom:10px"><div style="font-size:12.5px;font-weight:700;margin-bottom:8px">CS Request Aktif</div><div class="detail-row"><div class="dk">Char Name</div><div class="dv">${esc(d.charName||'')}</div></div><div class="detail-row"><div class="dk">Jadwal</div><div class="dv">${esc(d.schedule||'')}</div></div><div class="detail-row" style="margin-bottom:0"><div class="dk">Status</div><div class="dv"><span class="badge b-${d.status}">${d.status.toUpperCase()}</span></div></div></div>`
    }
  }
}
async function submitCS(){
  if(!CU){ openModal('modalLogin'); return }
  const icName=document.getElementById('csIcName').value.trim(), charName=document.getElementById('csCharName').value.trim(), age=document.getElementById('csAge').value, level=document.getElementById('csLevel').value, screenshot=document.getElementById('csScreenshot').value.trim(), story=document.getElementById('csStory').value.trim()
  if(!icName||!charName||!age||!level||!story||!selectedCSSlot){ toast('Isi semua field!','e'); return }
  const wc=story.trim().split(/\s+/).filter(Boolean).length, min=appConfig.csMinWords||150
  if(wc<min){ toast(`Story min. ${min} kata! (${wc} sekarang)`,'e'); return }
  try{
    const key=DB.ref('cs_requests').push().key
    await DB.ref('cs_requests/'+key).set({ uid:CU.uid, email:CU.email, username:UP.username, icName, charName, age:parseInt(age), level:parseInt(level), screenshot, story, schedule:selectedCSSlot, status:'pending', createdAt:Date.now() })
    addLog('CS',UP.username+' CS request: '+charName)
    toast('CS Request terkirim!','s')
    document.getElementById('csFormWrap').style.display='none'; document.getElementById('csMyStatus').style.display=''
    document.getElementById('csMyStatus').innerHTML='<div class="info-box success">‚úÖ CS Request berhasil dikirim!</div>'
  }catch(e){ toast('Gagal: '+e.message,'e') }
}

// ============================================================
// IMPORT
// ============================================================
function initImport(){ checkMyImport() }
function selectImpType(el,type){ document.querySelectorAll('.imp-type-btn').forEach(b=>b.classList.remove('sel')); el.classList.add('sel'); selectedImpType=type }
async function checkMyImport(){
  if(!CU) return
  const snap=await DB.ref('import_requests').orderByChild('userId').equalTo(CU.uid).limitToLast(1).get()
  if(snap.exists()){
    const d=Object.values(snap.val())[0]
    if(d.status==='pending'){
      document.getElementById('importMyStatus').style.display=''; document.getElementById('importFormWrap').style.display='none'
      document.getElementById('importMyStatus').innerHTML=`<div class="card" style="padding:14px;margin-bottom:10px"><div style="font-size:12.5px;font-weight:700;margin-bottom:8px">Import Request Aktif</div><div class="detail-row"><div class="dk">Tipe</div><div class="dv" style="text-transform:capitalize">${esc(d.type||'')}</div></div><div class="detail-row" style="margin-bottom:0"><div class="dk">Status</div><div class="dv"><span class="badge b-${d.status}">${d.status.toUpperCase()}</span></div></div></div>`
    }
  }
}
async function submitImport(){
  if(!CU){ openModal('modalLogin'); return }
  if(!selectedImpType){ toast('Pilih jenis import!','e'); return }
  const charName=document.getElementById('importCharName').value.trim(), faction=document.getElementById('importFaction').value.trim(), items=document.getElementById('importItems').value.trim(), lore=document.getElementById('importLore').value.trim(), proof=document.getElementById('importProof').value.trim()
  if(!charName||!faction||!lore){ toast('Isi semua field wajib!','e'); return }
  try{
    const key=DB.ref('import_requests').push().key
    await DB.ref('import_requests/'+key).set({ userId:CU.uid, email:CU.email, username:UP.username, type:selectedImpType, charName, faction, items, lore, proof, status:'pending', createdAt:Date.now() })
    addLog('IMPORT',UP.username+' import request: '+charName+' ('+selectedImpType+')')
    toast('Import request terkirim!','s')
    document.getElementById('importFormWrap').style.display='none'; document.getElementById('importMyStatus').style.display=''
    document.getElementById('importMyStatus').innerHTML='<div class="info-box success">‚úÖ Import request berhasil dikirim!</div>'
  }catch(e){ toast('Gagal: '+e.message,'e') }
}

// ============================================================
// STAFF
// ============================================================
async function loadStaff(){
  const grid=document.getElementById('staffGrid'); if(!grid) return
  const snap=await DB.ref('staff').orderByChild('order').get()
  if(!snap.exists()){ grid.innerHTML='<p style="color:var(--text3);font-size:11px">Tidak ada data staff.</p>'; return }
  const roleColors={'Owner':'r-owner','Co-Owner':'r-owner','Developer':'r-developer','Head Admin':'r-headadmin','Senior Admin':'r-senioradmin','Admin':'r-admin','Junior Admin':'r-junioradmin','Management':'r-management','Moderator':'r-moderator','Community Handle':'r-communityhandle','Senior Helper':'r-seniorhelper','Helper':'r-helper','Junior Helper':'r-juniorhelper','Volunteer':'r-volunteer','Ex Staff':'r-exstaff'}
  const sorted=Object.values(snap.val()).sort((a,b)=>a.order-b.order)
  grid.innerHTML=sorted.map(s=>`<div class="staff-card"><div class="staff-ava">${s.emoji||ini(s.name||'?')}</div><div class="staff-name">${esc(s.name||'‚Äî')}</div><div class="staff-role-txt ${roleColors[s.role]||'r-user'}">${esc(s.role||'')}</div>${s.wa?`<div style="font-size:9px;color:var(--text3);margin-top:4px">üì± +${s.wa}</div>`:''}</div>`).join('')
}

// ============================================================
// LEADERBOARD
// ============================================================
async function loadLB(){
  const snap=await DB.ref('users').orderByChild('postCount').limitToLast(10).get()
  const lbP=document.getElementById('lbPostsList')
  if(lbP && snap.exists()){
    const users=Object.values(snap.val()).filter(u=>u.postCount>0).sort((a,b)=>b.postCount-a.postCount)
    const rc={0:'r1',1:'r2',2:'r3'}
    lbP.innerHTML=users.length?users.map((u,i)=>`<div class="lb-row"><div class="lb-rank ${rc[i]||''}">${i+1}</div><div class="lb-ava">${u.photoURL?`<img src="${u.photoURL}">`:ini(u.username||'?')}</div><div class="lb-info"><div class="lb-name">${esc(u.username||'')}</div><div class="lb-sub ${rClass(u.role)}">${ROLE_LABELS[u.role||'user']||'Member'}</div></div><div class="lb-val">${u.postCount||0}</div></div>`).join(''):'<div style="padding:18px;text-align:center;color:var(--text3)">Belum ada data.</div>'
  }
  const snapWL=await DB.ref('registrations').orderByChild('status').equalTo('accepted').get()
  const lbW=document.getElementById('lbWLList')
  if(lbW && snapWL.exists()){
    const wls=Object.values(snapWL.val()).sort((a,b)=>b.reviewedAt-a.reviewedAt).slice(0,10)
    const rc2={0:'r1',1:'r2',2:'r3'}
    lbW.innerHTML=wls.map((w,i)=>`<div class="lb-row"><div class="lb-rank ${rc2[i]||''}">${i+1}</div><div class="lb-ava">${ini(w.name||'?')}</div><div class="lb-info"><div class="lb-name">${esc(w.name||'')}</div><div class="lb-sub">${fmtDate(w.reviewedAt)}</div></div><div class="lb-val">‚úì</div></div>`).join('')
  }
}

// ============================================================
// ANNOUNCEMENTS
// ============================================================
async function loadAnn(){
  const el=document.getElementById('annList'); if(!el) return
  el.innerHTML='<div style="padding:24px;text-align:center;color:var(--text3)">Memuat...</div>'
  const snap=await DB.ref('announcements').orderByChild('ts').limitToLast(30).get()
  if(!snap.exists()){ el.innerHTML='<div style="padding:24px;text-align:center;color:var(--text3)">Belum ada pengumuman.</div>'; return }
  const tagColors={ANNOUNCEMENT:'var(--red)',MAINTENANCE:'var(--orange)',WARNING:'var(--orange)',INFO:'var(--blue)'}
  el.innerHTML=Object.values(snap.val()).reverse().map(a=>`<div class="ann-card"><div class="ann-tag-badge" style="background:${tagColors[a.tag]||'var(--blue)'}22;color:${tagColors[a.tag]||'var(--blue)'};">${esc(a.tag||'INFO')}</div><div class="ann-title-txt">${esc(a.title||'')}</div><div class="ann-body-txt">${esc(a.content||'')}</div><div class="ann-meta">${fmtDT(a.ts)} ‚Ä¢ ${esc(a.author||'Admin')}</div></div>`).join('')
}

// ============================================================
// GUIDES
// ============================================================
const guideCache={}
async function loadGuides(type){
  const ids={rules:'guideRules',guide_job:'guideJob',guide_goodside:'guideGood',guide_badside:'guideBad'}
  const el=document.getElementById(ids[type]); if(!el) return
  if(guideCache[type]){ el.innerHTML=guideCache[type]; return }
  el.innerHTML='<div style="padding:24px;text-align:center;color:var(--text3)">Memuat...</div>'
  const snap=await DB.ref('guides').orderByChild('type').equalTo(type).get()
  if(!snap.exists()){ el.innerHTML='<div style="padding:24px;text-align:center;color:var(--text3)">Belum ada konten.</div>'; return }
  const items=Object.values(snap.val()).sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0))
  guideCache[type]=items.map(g=>`<div class="guide-card">${g.pinned?'<div style="font-size:9px;color:var(--gold);font-weight:700;margin-bottom:4px">üìå PINNED</div>':''}<div class="guide-tag">${esc(g.tag||'')}</div><div class="guide-title">${esc(g.title||'')}</div><div class="guide-body">${esc(g.body||'')}</div></div>`).join('')
  el.innerHTML=guideCache[type]
}

// ============================================================
// REPORT
// ============================================================
async function submitReport(){
  if(!CU){ openModal('modalLogin'); return }
  const reporter=document.getElementById('repReporter').value.trim(), target=document.getElementById('repTarget').value.trim(), type=document.getElementById('repType').value, date=document.getElementById('repDate').value, kron=document.getElementById('repKronologi').value.trim(), bukti=document.getElementById('repBukti').value.trim()
  if(!reporter||!target||!type||!kron){ toast('Isi semua field wajib!','e'); return }
  const key=DB.ref('reports').push().key
  await DB.ref('reports/'+key).set({ uid:CU.uid, email:CU.email, username:UP.username, reporter, target, type, date, kronologi:kron, bukti, status:'open', createdAt:Date.now() })
  toast('Laporan dikirim!','s'); ['repReporter','repTarget','repKronologi','repBukti'].forEach(id=>document.getElementById(id).value=''); document.getElementById('repType').value=''
}
async function loadMyReports(){
  const el=document.getElementById('myReportsList'); if(!el) return
  if(!CU){ el.innerHTML='<div style="padding:14px;color:var(--text3);font-size:11px">Login untuk melihat laporan.</div>'; return }
  const snap=await DB.ref('reports').orderByChild('uid').equalTo(CU.uid).get()
  if(!snap.exists()){ el.innerHTML='<div style="padding:14px;color:var(--text3);font-size:11px">Belum ada laporan.</div>'; return }
  el.innerHTML=Object.values(snap.val()).reverse().map(r=>`<div style="padding:9px 13px;border-bottom:1px solid var(--border2)"><div style="font-size:12px;font-weight:600">${esc(r.type)}: ${esc(r.target)}</div><div style="font-size:10px;color:var(--text3);margin-top:2px">${fmtDate(r.createdAt)} ‚Ä¢ <span class="badge b-${r.status==='open'?'open':'accepted'}">${r.status.toUpperCase()}</span></div></div>`).join('')
}

// ============================================================
// PM
// ============================================================
let pmListener = null
function initPM(){
  if(!CU){ document.getElementById('chatMsgs').innerHTML='<div style="padding:36px;text-align:center;color:var(--text3)">Login untuk menggunakan pesan.</div>'; return }
  loadPMList()
}
function loadPMList(){
  const el=document.getElementById('pmList'); if(!el) return
  if(pmListener) pmListener()
  pmListener = DB.ref('pm_convos').on('value', snap=>{
    if(!snap.exists()){ el.innerHTML='<div style="padding:18px;text-align:center;color:var(--text3);font-size:11px">Belum ada percakapan.</div>'; return }
    const convos=Object.entries(snap.val()).filter(([id])=>id.includes(CU.uid))
    if(!convos.length){ el.innerHTML='<div style="padding:18px;text-align:center;color:var(--text3);font-size:11px">Belum ada percakapan.</div>'; return }
    el.innerHTML=convos.map(([id,c])=>{
      const msgs=Object.values(c.messages||{}).sort((a,b)=>b.ts-a.ts)
      const last=msgs[0]||{}
      const otherId=id.replace(CU.uid,'').replace('_','')
      const otherName=c.names?.[otherId]||otherId
      const unread=msgs.filter(m=>m.to===CU.uid&&!m.read).length
      return `<div class="chat-item ${id===activeConvoId?'active':''} ${unread?'unread':''}" onclick="openConvo('${id}','${esc(otherName)}')"><div class="ci-ava">${ini(otherName)}</div><div style="flex:1;min-width:0"><div class="ci-name">${esc(otherName)}</div><div class="ci-preview">${esc((last.text||'').substring(0,35))}</div></div>${unread?`<div class="unread-badge">${unread}</div>`:''}</div>`
    }).join('')
    // PM dot
    const hasUnread=convos.some(([,c])=>Object.values(c.messages||{}).some(m=>m.to===CU.uid&&!m.read))
    ;['pmDot','pmDotMob'].forEach(id=>{ const e=document.getElementById(id); if(e) e.style.display=hasUnread?'':'none' })
  })
}
function openConvo(convoId, otherName){
  activeConvoId=convoId
  const hdr=document.getElementById('chatHdr'), inp=document.getElementById('chatInputArea')
  hdr.style.display='flex'; inp.style.display='flex'
  document.getElementById('chatHdrName').textContent=otherName
  document.getElementById('chatHdrAva').textContent=ini(otherName)
  DB.ref('pm_convos/'+convoId).on('value', snap=>{
    if(!snap.exists()) return
    const msgs=Object.values(snap.val().messages||{}).sort((a,b)=>a.ts-b.ts)
    const el=document.getElementById('chatMsgs')
    el.innerHTML=msgs.map(m=>{
      const mine=m.from===CU.uid
      return `<div class="msg-row ${mine?'mine':''}"><div class="msg-ava-sm">${ini(mine?(UP?.username||'?'):otherName)}</div><div class="msg-bubbles"><div class="msg-bubble">${esc(m.text||'')}</div><div class="msg-time">${timeAgo(m.ts)}</div></div></div>`
    }).join('')
    el.scrollTop=el.scrollHeight
    // mark read
    msgs.filter(m=>m.to===CU.uid&&!m.read).forEach(m=>{
      const key=Object.entries(snap.val().messages||{}).find(([,v])=>v.ts===m.ts)?.[0]
      if(key) DB.ref('pm_convos/'+convoId+'/messages/'+key+'/read').set(true)
    })
  })
}
async function sendChatMsg(){
  const input=document.getElementById('chatInput'); if(!input||!input.value.trim()||!activeConvoId||!CU) return
  const text=input.value.trim(); input.value=''; input.style.height='auto'
  const otherId=activeConvoId.replace(CU.uid,'').replace('_','')
  await DB.ref('pm_convos/'+activeConvoId+'/messages').push({ from:CU.uid, to:otherId, text, ts:Date.now(), read:false })
}
async function sendNewPM(){
  if(!CU){ toast('Login dulu!','e'); return }
  const targetUn=document.getElementById('pmTargetUsername').value.trim(), msg=document.getElementById('pmNewMsg').value.trim()
  if(!targetUn||!msg){ toast('Isi semua field!','e'); return }
  const snap=await DB.ref('users').orderByChild('username').equalTo(targetUn).get()
  if(!snap.exists()){ toast('User tidak ditemukan!','e'); return }
  const otherId=Object.keys(snap.val())[0]
  if(otherId===CU.uid){ toast('Tidak bisa kirim ke diri sendiri!','e'); return }
  const convoId=[CU.uid,otherId].sort().join('_')
  const names={}; names[CU.uid]=UP.username; names[otherId]=targetUn
  await DB.ref('pm_convos/'+convoId).update({ names })
  await DB.ref('pm_convos/'+convoId+'/messages').push({ from:CU.uid, to:otherId, text:msg, ts:Date.now(), read:false })
  closeModal('modalNewPM'); document.getElementById('pmTargetUsername').value=''; document.getElementById('pmNewMsg').value=''
  toast('Pesan terkirim!','s'); openConvo(convoId,targetUn)
}
function filterPMList(q){ document.querySelectorAll('.chat-item').forEach(el=>{ el.style.display=el.textContent.toLowerCase().includes(q.toLowerCase())?'':'none' }) }

// ============================================================
// PROFILE
// ============================================================
async function initProfile(){
  if(!CU){ nav('home'); return }
  document.getElementById('profName').textContent=UP.username||''
  document.getElementById('profUsername').textContent='@'+(UP.username||'')
  document.getElementById('profEmail').textContent=CU.email||''
  document.getElementById('profICName').textContent=UP.icName||'‚Äî'
  document.getElementById('profJoined').textContent=fmtDate(UP.createdAt)||'‚Äî'
  document.getElementById('profPostCount').textContent=UP.postCount||0
  document.getElementById('profLogoutBtn').style.display=''
  const ava=document.getElementById('profAva'); ava.innerHTML=UP.photoURL?`<img src="${UP.photoURL}" style="width:100%;height:100%;object-fit:cover">`:ini(UP.username||'?')
  document.getElementById('profRoleBadge').textContent=ROLE_LABELS[UP.role||'user']||'Member'
  const wlSnap=await DB.ref('registrations').orderByChild('uid').equalTo(CU.uid).limitToLast(1).get()
  const statusMap={pending:'<span class="badge b-pending">PENDING</span>',process:'<span class="badge b-process">DIPROSES</span>',accepted:'<span class="badge b-accepted">DITERIMA</span>',rejected:'<span class="badge b-rejected">DITOLAK</span>',denied:'<span class="badge b-denied">DITOLAK</span>'}
  document.getElementById('profWLStatus').innerHTML=wlSnap.exists()?statusMap[Object.values(wlSnap.val())[0].status]||'‚Äî':'<span style="color:var(--text3)">Belum Mendaftar</span>'
  document.getElementById('settingsUsername').value=UP.username||''
}
async function saveProfile(){
  if(!CU) return; const name=document.getElementById('settingsUsername').value.trim(); if(!name){ toast('Nama tidak boleh kosong!','e'); return }
  await DB.ref('users/'+CU.uid+'/username').set(name); UP.username=name; renderTBAuth(); toast('Tersimpan!','s')
}
async function loadMyPosts(){
  const el=document.getElementById('myPostsList'); if(!el||!CU) return
  el.innerHTML='<div style="padding:18px;text-align:center;color:var(--text3)">Memuat...</div>'
  const snap=await DB.ref('posts').orderByChild('uid').equalTo(CU.uid).get()
  if(!snap.exists()){ el.innerHTML='<div style="padding:14px;color:var(--text3)">Belum ada post.</div>'; return }
  el.innerHTML=Object.entries(snap.val()).reverse().map(([,p])=>`<div style="padding:9px 12px;border-bottom:1px solid var(--border2)"><div style="font-size:11.5px;color:var(--text2)">${esc((p.content||'').substring(0,100))}</div><div style="font-size:9.5px;color:var(--text3);margin-top:3px">${timeAgo(p.ts)}</div></div>`).join('')
}

// ============================================================
// LOGS
// ============================================================
async function addLog(type,msg){
  try{ await DB.ref('logs').push({ by:UP?.username||'system', msg, type, ts:Date.now() }) }catch(e){}
}
async function loadAdmLogs(){
  const snap=await DB.ref('logs').orderByChild('ts').limitToLast(200).get()
  logsCache=snap.exists()?Object.values(snap.val()).reverse():[]
  renderLogs()
  const btn=document.getElementById('clearLogsBtn'); if(btn && hasPerm('clear_logs')) btn.style.display=''
}
function renderLogs(){
  const el=document.getElementById('logStream'); if(!el) return
  const filter=document.getElementById('logTypeFilter')?.value||''
  const logs=filter?logsCache.filter(l=>l.type===filter):logsCache
  if(!logs.length){ el.innerHTML='<div class="log-line"><div class="log-msg" style="color:var(--text3)">Tidak ada log.</div></div>'; return }
  el.innerHTML=logs.map(l=>`<div class="log-line"><div class="log-time">${fmtDT(l.ts)}</div><div class="log-type ${l.type||''}">${esc(l.type||'SYS')}</div><div class="log-msg">[${esc(l.by||'?')}] ${esc(l.msg||'')}</div></div>`).join('')
}
async function clearAllLogs(){
  if(!confirm('Hapus semua logs?')) return
  await DB.ref('logs').remove()
  logsCache=[]; renderLogs(); addLog('SYSTEM','Logs dihapus oleh '+UP?.username); toast('Logs dihapus.','i')
}

// ============================================================
// ADMIN
// ============================================================
function hasPerm(p){ if(!UP) return false; if(['owner','developer'].includes(UP.role)) return true; return (UP.perms||[]).includes(p) }
function initAdmin(){
  if(!CU||!UP||!ADMIN_ROLES.includes(UP.role)){ nav('home'); return }
  buildAdmSidebar(); switchAdmTab('overview'); loadAdmDash()
}
function buildAdmSidebar(){
  const sb=document.getElementById('admSidebar'); if(!sb) return
  sb.innerHTML=`<div style="padding:7px 12px 5px;font-size:13px;font-weight:800;letter-spacing:2px;color:#fff;margin-bottom:4px">ADMIN</div>
    <div class="adm-section">Utama</div>
    <button class="adm-item active" id="si-overview" onclick="switchAdmTab('overview')">üìä Overview</button>
    ${hasPerm('admin_chat')?`<button class="adm-item" id="si-adminChat" onclick="switchAdmTab('adminChat');loadAdmChat()">üí¨ Admin Chat</button>`:''}
    <div class="adm-section">Manajemen</div>
    ${hasPerm('handle_wl')?`<button class="adm-item" id="si-wlPending" onclick="switchAdmTab('wlPending');loadAdmWL('pending')">üìã WL Pending <span class="adm-badge" id="nbWL">0</span></button>`:''}
    ${hasPerm('handle_wl')?`<button class="adm-item" id="si-wlAll" onclick="switchAdmTab('wlAll');loadAdmWL('all')">üìã WL Semua</button>`:''}
    ${hasPerm('handle_cs')?`<button class="adm-item" id="si-csPending" onclick="switchAdmTab('csPending');loadAdmCS('pending')">üé≠ CS Pending <span class="adm-badge" id="nbCS">0</span></button>`:''}
    ${hasPerm('handle_cs')?`<button class="adm-item" id="si-csAll" onclick="switchAdmTab('csAll');loadAdmCS('all')">üé≠ CS Semua</button>`:''}
    ${hasPerm('handle_import')?`<button class="adm-item" id="si-importReq" onclick="switchAdmTab('importReq');loadAdmImport()">üì¶ Import <span class="adm-badge" id="nbImport">0</span></button>`:''}
    ${hasPerm('manage_roles')?`<button class="adm-item" id="si-users" onclick="switchAdmTab('users');loadAdmUsers()">üë• Users & Role</button>`:''}
    ${hasPerm('ban_user')?`<button class="adm-item" id="si-banned" onclick="switchAdmTab('banned');loadAdmBanned()">üö´ Banned</button>`:''}
    <button class="adm-item" id="si-reports" onclick="switchAdmTab('reports');loadAdmReports()">üö© Reports</button>
    <div class="adm-section">Konten</div>
    ${hasPerm('manage_announce')?`<button class="adm-item" id="si-announce" onclick="switchAdmTab('announce');loadAdmAnn()">üì¢ Pengumuman</button>`:''}
    ${hasPerm('manage_guides')?`<button class="adm-item" id="si-guides" onclick="switchAdmTab('guides');loadAdmGuides()">üìö Guides</button>`:''}
    <button class="adm-item" id="si-staff" onclick="switchAdmTab('staff');loadAdmStaff()">üëë Staff List</button>
    ${hasPerm('settings')?`<div class="adm-section">Sistem</div><button class="adm-item" id="si-settings" onclick="switchAdmTab('settings');loadSettingsForm()">‚öôÔ∏è Settings</button>`:''}
    ${hasPerm('view_logs')?`<button class="adm-item" id="si-logs" onclick="switchAdmTab('logs');loadAdmLogs()">üìú Logs</button>`:''}
  `
}
function switchAdmTab(name){
  document.querySelectorAll('.adm-tab').forEach(t=>{ t.style.display='none'; t.classList.remove('active') })
  const t=document.getElementById('adm-'+name); if(t){ t.style.display=''; t.classList.add('active') }
  document.querySelectorAll('.adm-item').forEach(b=>b.classList.remove('active'))
  const si=document.getElementById('si-'+name); if(si) si.classList.add('active')
}
async function loadAdmDash(){
  const [users,regs,cs,imp,reps,banned,staff]=await Promise.all([
    DB.ref('users').get(), DB.ref('registrations').get(), DB.ref('cs_requests').get(),
    DB.ref('import_requests').get(), DB.ref('reports').get(),
    DB.ref('users').orderByChild('status').equalTo('banned').get(), DB.ref('staff').get()
  ])
  const uv=users.val()||{}, rv=regs.val()||{}, cv=cs.val()||{}, iv=imp.val()||{}, repv=reps.val()||{}, sv=staff.val()||{}
  const wlPend=Object.values(rv).filter(x=>x.status==='pending').length
  const csPend=Object.values(cv).filter(x=>x.status==='pending').length
  const impPend=Object.values(iv).filter(x=>x.status==='pending').length
  const repOpen=Object.values(repv).filter(x=>x.status==='open').length
  const wlAcc=Object.values(rv).filter(x=>x.status==='accepted').length
  const banCount=Object.values(uv).filter(u=>u.status==='banned').length
  const s=(id,v)=>setText(id,v)
  s('admMembers',Object.keys(uv).length); s('admWLPend',wlPend); s('admCSPend',csPend); s('admImpPend',impPend); s('admRepOpen',repOpen); s('admWLAcc',wlAcc); s('admBanned',banCount); s('admStaff',Object.keys(sv).length)
  const nb=(id,v)=>{ const e=document.getElementById(id); if(e) e.textContent=v }
  nb('nbWL',wlPend); nb('nbCS',csPend); nb('nbImport',impPend)
  await loadDashLogs()
}
async function loadDashLogs(){
  const el=document.getElementById('dashLogStream'); if(!el) return
  const snap=await DB.ref('logs').orderByChild('ts').limitToLast(30).get()
  if(!snap.exists()){ el.innerHTML='<div class="log-line"><div class="log-msg" style="color:var(--text3)">Belum ada log.</div></div>'; return }
  const logs=Object.values(snap.val()).reverse()
  el.innerHTML=logs.map(l=>`<div class="log-line"><div class="log-time">${fmtDT(l.ts)}</div><div class="log-type ${l.type||''}">${esc(l.type||'SYS')}</div><div class="log-msg">[${esc(l.by||'?')}] ${esc(l.msg||'')}</div></div>`).join('')
}

// ‚îÄ‚îÄ WL ADMIN ‚îÄ‚îÄ
async function loadAdmWL(mode){
  const tbodyId=mode==='pending'?'tbodyWLPend':'tbodyWLAll'
  const tbody=document.getElementById(tbodyId); if(!tbody) return
  tbody.innerHTML=`<tr class="empty-row"><td colspan="6">Memuat...</td></tr>`
  const snap=await DB.ref('registrations').get()
  if(!snap.exists()){ tbody.innerHTML=`<tr class="empty-row"><td colspan="6">Tidak ada data.</td></tr>`; return }
  let entries=Object.entries(snap.val()).map(([k,v])=>({...v,_key:k}))
  if(mode==='pending') entries=entries.filter(x=>x.status==='pending')
  entries.sort((a,b)=>b.submittedAt-a.submittedAt)
  const lbl=document.getElementById('wlPendLbl'); if(lbl&&mode==='pending') lbl.textContent='('+entries.length+')'
  tbody.innerHTML=entries.map(w=>`<tr><td><strong>${esc(w.name||'')}</strong></td><td>${esc(w.wa||'')}</td><td>${esc(w.faction||'')}</td><td>${fmtDate(w.submittedAt)}</td><td><span class="badge b-${w.status}">${w.status.toUpperCase()}</span></td><td><button class="atn-btn" onclick="openWLDetail('${w._key}')">Detail</button></td></tr>`).join('')
}
async function openWLDetail(key){
  const snap=await DB.ref('registrations/'+key).get(); if(!snap.exists()) return
  const w=snap.val()
  document.getElementById('wlDetailBody').innerHTML=`
    <div class="detail-row"><div class="dk">Nama IC</div><div class="dv">${esc(w.name||'')}</div></div>
    <div class="detail-row"><div class="dk">Username</div><div class="dv">${esc(w.username||'')}</div></div>
    <div class="detail-row"><div class="dk">WA</div><div class="dv">${esc(w.wa||'')}</div></div>
    <div class="detail-row"><div class="dk">Umur</div><div class="dv">${esc(w.age||'')}</div></div>
    <div class="detail-row"><div class="dk">Fraksi</div><div class="dv">${esc(w.faction||'')}</div></div>
    <div class="detail-row"><div class="dk">Pengalaman</div><div class="dv">${esc(w.exp||'')}</div></div>
    <div class="detail-row"><div class="dk">Status</div><div class="dv"><span class="badge b-${w.status}">${w.status.toUpperCase()}</span></div></div>
    <hr style="border-color:var(--border);margin:10px 0">
    <div class="form-label" style="margin-bottom:4px">Q: Apa itu RP?</div><div class="detail-story">${esc(w.q1||'')}</div>
    <div class="form-label" style="margin:8px 0 4px">Q: Metagaming</div><div class="detail-story">${esc(w.q2||'')}</div>
    <div class="form-label" style="margin:8px 0 4px">Q: Powergaming</div><div class="detail-story">${esc(w.q3||'')}</div>
    <div class="form-label" style="margin:8px 0 4px">Alasan</div><div class="detail-story">${esc(w.reason||'')}</div>
    <div class="form-row" style="margin-top:10px"><label class="form-label">Catatan Admin (opsional)</label><input type="text" class="form-input" id="wlAdmNote" value="${esc(w.adminNote||'')}" placeholder="Catatan..."></div>`
  const act=document.getElementById('wlDetailActions')
  if(hasPerm('handle_wl')&&(w.status==='pending'||w.status==='process'))
    act.innerHTML=`<button class="btn btn-green" onclick="updateWL('${key}','accepted')">‚úì Terima</button><button class="btn" onclick="updateWL('${key}','process')">‚ü≥ Proses</button><button class="btn btn-danger" onclick="updateWL('${key}','rejected')">‚úó Tolak</button>`
  else act.innerHTML=`<span class="badge b-${w.status}">${w.status.toUpperCase()}</span>`
  openModal('modalWLDetail')
}
async function updateWL(key,status){
  const note=document.getElementById('wlAdmNote')?.value||''
  const snap=await DB.ref('registrations/'+key).get(); const w=snap.val()
  await DB.ref('registrations/'+key).update({ status, adminNote:note, reviewedBy:UP.username, reviewedAt:Date.now() })
  if(status==='accepted' && w.uid){
    await DB.ref('users/'+w.uid).update({ wlStatus:'accepted', icName:w.name })
  }
  addLog('WL_REVIEW',`WL ${status}: ${w.name} oleh ${UP.username}`)
  toast('WL '+status+'!','s'); closeModal('modalWLDetail'); loadAdmWL('pending'); loadAdmWL('all'); loadAdmDash()
}

// ‚îÄ‚îÄ CS ADMIN ‚îÄ‚îÄ
async function loadAdmCS(mode){
  const tbodyId=mode==='pending'?'tbodyCSPend':'tbodyCSAll'
  const tbody=document.getElementById(tbodyId); if(!tbody) return
  tbody.innerHTML=`<tr class="empty-row"><td colspan="6">Memuat...</td></tr>`
  const snap=await DB.ref('cs_requests').get()
  if(!snap.exists()){ tbody.innerHTML=`<tr class="empty-row"><td colspan="6">Tidak ada data.</td></tr>`; return }
  let entries=Object.entries(snap.val()).map(([k,v])=>({...v,_key:k}))
  if(mode==='pending') entries=entries.filter(x=>x.status==='pending')
  entries.sort((a,b)=>b.createdAt-a.createdAt)
  tbody.innerHTML=entries.map(c=>`<tr><td>${esc(c.icName||'')}</td><td>${esc(c.charName||'')}</td><td>${esc(c.level||'')}</td><td>${esc(c.schedule||'')}</td><td><span class="badge b-${c.status}">${c.status.toUpperCase()}</span></td><td><button class="atn-btn" onclick="openCSDetail('${c._key}')">Detail</button></td></tr>`).join('')
}
async function openCSDetail(key){
  const snap=await DB.ref('cs_requests/'+key).get(); if(!snap.exists()) return
  const c=snap.val()
  document.getElementById('csDetailBody').innerHTML=`
    <div class="detail-row"><div class="dk">IC Name</div><div class="dv">${esc(c.icName||'')}</div></div>
    <div class="detail-row"><div class="dk">Char Name</div><div class="dv">${esc(c.charName||'')}</div></div>
    <div class="detail-row"><div class="dk">Usia / Level</div><div class="dv">${esc(c.age||'')} / ${esc(c.level||'')}</div></div>
    <div class="detail-row"><div class="dk">Jadwal</div><div class="dv">${esc(c.schedule||'')}</div></div>
    <div class="detail-row"><div class="dk">Screenshot</div><div class="dv"><a href="${esc(c.screenshot||'#')}" target="_blank" style="color:var(--blue)">Lihat</a></div></div>
    <div class="detail-row"><div class="dk">Status</div><div class="dv"><span class="badge b-${c.status}">${c.status.toUpperCase()}</span></div></div>
    <div class="form-label" style="margin:10px 0 4px">Story IC (${(c.story||'').trim().split(/\s+/).filter(Boolean).length} kata)</div>
    <div class="detail-story">${esc(c.story||'')}</div>
    <div class="form-row" style="margin-top:10px"><label class="form-label">Catatan Admin</label><input type="text" class="form-input" id="csAdmNote" value="${esc(c.adminNote||'')}" placeholder="Catatan..."></div>`
  const act=document.getElementById('csDetailActions')
  if(hasPerm('handle_cs')&&(c.status==='pending'||c.status==='process'))
    act.innerHTML=`<button class="btn btn-green" onclick="updateCS('${key}','accepted')">‚úì Terima</button><button class="btn" onclick="updateCS('${key}','process')">‚ü≥ Proses</button><button class="btn btn-danger" onclick="updateCS('${key}','rejected')">‚úó Tolak</button>`
  else act.innerHTML=`<span class="badge b-${c.status}">${c.status.toUpperCase()}</span>`
  openModal('modalCSDetail')
}
async function updateCS(key,status){
  const note=document.getElementById('csAdmNote')?.value||''
  const snap=await DB.ref('cs_requests/'+key).get(); const c=snap.val()
  await DB.ref('cs_requests/'+key).update({ status, adminNote:note, reviewedBy:UP.username, reviewedAt:Date.now() })
  addLog('CS_REVIEW',`CS ${status}: ${c.charName} oleh ${UP.username}`)
  toast('CS '+status+'!','s'); closeModal('modalCSDetail'); loadAdmCS('pending'); loadAdmCS('all')
}

// ‚îÄ‚îÄ IMPORT ADMIN ‚îÄ‚îÄ
async function loadAdmImport(){
  const tbody=document.getElementById('tbodyImport'); if(!tbody) return
  tbody.innerHTML=`<tr class="empty-row"><td colspan="6">Memuat...</td></tr>`
  const snap=await DB.ref('import_requests').get()
  if(!snap.exists()){ tbody.innerHTML=`<tr class="empty-row"><td colspan="6">Tidak ada data.</td></tr>`; return }
  const entries=Object.entries(snap.val()).map(([k,v])=>({...v,_key:k})).sort((a,b)=>b.createdAt-a.createdAt)
  const nb=document.getElementById('nbImport'); if(nb) nb.textContent=entries.filter(x=>x.status==='pending').length
  tbody.innerHTML=entries.map(r=>`<tr><td>${esc(r.username||'')}</td><td>${esc(r.charName||'')}</td><td style="text-transform:capitalize">${esc(r.type||'')}</td><td>${esc(r.faction||'')}</td><td><span class="badge b-${r.status}">${r.status.toUpperCase()}</span></td><td><button class="atn-btn" onclick="openImportDetail('${r._key}')">Detail</button></td></tr>`).join('')
}
async function openImportDetail(key){
  const snap=await DB.ref('import_requests/'+key).get(); if(!snap.exists()) return
  const r=snap.val()
  document.getElementById('importDetailBody').innerHTML=`
    <div class="detail-row"><div class="dk">Username</div><div class="dv">${esc(r.username||'')}</div></div>
    <div class="detail-row"><div class="dk">Tipe</div><div class="dv" style="text-transform:capitalize">${esc(r.type||'')}</div></div>
    <div class="detail-row"><div class="dk">Char Name</div><div class="dv">${esc(r.charName||'')}</div></div>
    <div class="detail-row"><div class="dk">Fraksi/Family</div><div class="dv">${esc(r.faction||'')}</div></div>
    <div class="detail-row"><div class="dk">Bukti</div><div class="dv"><a href="${esc(r.proof||'#')}" target="_blank" style="color:var(--blue)">Lihat</a></div></div>
    <div class="detail-row"><div class="dk">Status</div><div class="dv"><span class="badge b-${r.status}">${r.status.toUpperCase()}</span></div></div>
    <div class="form-label" style="margin:10px 0 4px">Items</div><div class="detail-story">${esc(r.items||'‚Äî')}</div>
    <div class="form-label" style="margin:8px 0 4px">Lore IC</div><div class="detail-story">${esc(r.lore||'')}</div>
    <div class="form-row" style="margin-top:10px"><label class="form-label">Catatan Admin</label><input type="text" class="form-input" id="impAdmNote" value="${esc(r.adminNote||'')}" placeholder="Catatan..."></div>`
  const act=document.getElementById('importDetailActions')
  if(hasPerm('handle_import')&&r.status==='pending')
    act.innerHTML=`<button class="btn btn-green" onclick="updateImport('${key}','accepted')">‚úì Terima</button><button class="btn btn-danger" onclick="updateImport('${key}','denied')">‚úó Tolak</button>`
  else act.innerHTML=`<span class="badge b-${r.status}">${r.status.toUpperCase()}</span>`
  openModal('modalImportDetail')
}
async function updateImport(key,status){
  const note=document.getElementById('impAdmNote')?.value||''
  const snap=await DB.ref('import_requests/'+key).get(); const r=snap.val()
  await DB.ref('import_requests/'+key).update({ status, adminNote:note, reviewedBy:UP.username, reviewedAt:Date.now() })
  addLog('IMPORT',`Import ${status}: ${r.charName} (${r.type}) oleh ${UP.username}`)
  toast('Import '+status+'!','s'); closeModal('modalImportDetail'); loadAdmImport()
}

// ‚îÄ‚îÄ USERS ADMIN ‚îÄ‚îÄ
async function loadAdmUsers(){
  const tbody=document.getElementById('tbodyUsers'); if(!tbody) return
  tbody.innerHTML=`<tr class="empty-row"><td colspan="7">Memuat...</td></tr>`
  const [usersSnap,permsSnap]=await Promise.all([DB.ref('users').get(),DB.ref('admin_perms').get()])
  if(!usersSnap.exists()){ tbody.innerHTML=`<tr class="empty-row"><td colspan="7">Tidak ada user.</td></tr>`; return }
  const perms=permsSnap.val()||{}
  const users=Object.entries(usersSnap.val()).map(([k,v])=>({...v,_key:k})).sort((a,b)=>a.createdAt-b.createdAt)
  tbody.innerHTML=users.map(u=>{
    const p=perms[u._key]||{}
    const role=p.role||u.role||'user'
    const isBanned=u.status==='banned'
    return `<tr><td><span class="${rClass(role)}">${esc(u.username||'')}</span>${isBanned?' <span class="badge b-banned" style="font-size:8px">BAN</span>':''}</td>
      <td style="font-size:10px;color:var(--text3)">${esc(u.email||'')}</td>
      <td>${ROLE_LABELS[role]||role}</td>
      <td>${u.wlStatus==='accepted'?'<span class="badge b-accepted" style="font-size:8px">‚úì</span>':'‚Äî'}</td>
      <td style="font-size:10.5px">${esc(u.icName||'‚Äî')}</td>
      <td style="font-size:10px">${fmtDate(u.createdAt)}</td>
      <td style="white-space:nowrap">
        ${hasPerm('manage_roles')?`<button class="atn-btn" onclick="openRoleModal('${u._key}','${esc(u.username||'')}','${role}',${JSON.stringify((p.perms||[]))})">Role</button> `:''}
        ${hasPerm('edit_icname')?`<button class="atn-btn" onclick="openICModal('${u._key}','${esc(u.username||'')}','${esc(u.icName||'')}')">IC</button> `:''}
        ${hasPerm('ban_user')&&!isBanned?`<button class="atn-btn r" onclick="openBanModal('${u._key}','${esc(u.username||'')}')">Ban</button>`:''}
        ${hasPerm('ban_user')&&isBanned?`<button class="atn-btn g" onclick="unbanUser('${u._key}')">Unban</button>`:''}
      </td></tr>`
  }).join('')
}

// ‚îÄ‚îÄ ROLE MODAL ‚îÄ‚îÄ
function openRoleModal(uid,name,role,perms){
  roleTarget={uid,name,role,perms:[...perms]}
  document.getElementById('roleTargetInfo').textContent='User: '+name+' | Role saat ini: '+(ROLE_LABELS[role]||role)
  document.getElementById('roleSelect').innerHTML=ROLES.map(r=>`<div class="role-chip ${r===role?'sel':''}" onclick="selectRole(this,'${r}')">${ROLE_LABELS[r]||r}</div>`).join('')
  document.getElementById('permSelect').innerHTML=ALL_PERMS.map(p=>`<div class="perm-tag ${perms.includes(p)?'on':'off'}" onclick="togglePerm(this,'${p}')">${PERM_LABELS[p]||p}</div>`).join('')
  openModal('modalRole')
}
function selectRole(el,r){ document.querySelectorAll('#roleSelect .role-chip').forEach(c=>c.classList.remove('sel')); el.classList.add('sel'); roleTarget.newRole=r }
function togglePerm(el,p){ el.classList.toggle('on'); el.classList.toggle('off'); if(!roleTarget.newPerms) roleTarget.newPerms=[...roleTarget.perms]; if(el.classList.contains('on')) roleTarget.newPerms.push(p); else roleTarget.newPerms=roleTarget.newPerms.filter(x=>x!==p) }
async function confirmRole(){
  if(!roleTarget) return
  const newRole=roleTarget.newRole||roleTarget.role, newPerms=roleTarget.newPerms||roleTarget.perms
  await DB.ref('users/'+roleTarget.uid).update({ role:newRole })
  await DB.ref('admin_perms/'+roleTarget.uid).set({ uid:roleTarget.uid, username:roleTarget.name, role:newRole, perms:newPerms, setAt:Date.now(), setBy:UP.username })
  addLog('ROLE',`Role diubah: ${roleTarget.name} ‚Üí ${newRole} | Perms: ${newPerms.join(',')} | oleh ${UP.username}`)
  toast('Role diperbarui!','s'); closeModal('modalRole'); loadAdmUsers()
}

// ‚îÄ‚îÄ BAN MODAL ‚îÄ‚îÄ
function openBanModal(uid,name){ banTarget={uid,name}; document.getElementById('banTargetInfo').textContent='Akan ban: '+name; document.getElementById('banReasonInput').value=''; openModal('modalBan') }
async function confirmBan(){
  if(!banTarget) return; const reason=document.getElementById('banReasonInput').value.trim(); if(!reason){ toast('Isi alasan!','e'); return }
  await DB.ref('users/'+banTarget.uid).update({ status:'banned', banReason:reason, bannedBy:UP.username, bannedAt:Date.now() })
  addLog('BAN',`Ban: ${banTarget.name} ‚Äî ${reason} oleh ${UP.username}`)
  toast('User dibanned.','s'); closeModal('modalBan'); loadAdmUsers()
}
async function unbanUser(uid){ if(!confirm('Unban user ini?')) return; await DB.ref('users/'+uid).update({ status:'active', banReason:'', bannedBy:'' }); toast('User di-unban.','s'); loadAdmUsers() }

// ‚îÄ‚îÄ IC MODAL ‚îÄ‚îÄ
function openICModal(uid,name,icName){ icTarget={uid,name}; document.getElementById('icTargetInfo').textContent='User: '+name; document.getElementById('icNameInput').value=icName; openModal('modalICName') }
async function confirmICName(){ if(!icTarget) return; const n=document.getElementById('icNameInput').value.trim(); if(!n){ toast('Nama IC kosong!','e'); return }; await DB.ref('users/'+icTarget.uid).update({ icName:n }); addLog('ROLE',`IC Name ${icTarget.name}: ${n}`); toast('IC Name diperbarui!','s'); closeModal('modalICName'); loadAdmUsers() }

// ‚îÄ‚îÄ BANNED ‚îÄ‚îÄ
async function loadAdmBanned(){
  const tbody=document.getElementById('tbodyBanned'); if(!tbody) return
  const snap=await DB.ref('users').orderByChild('status').equalTo('banned').get()
  if(!snap.exists()){ tbody.innerHTML='<tr class="empty-row"><td colspan="5">Tidak ada user banned.</td></tr>'; return }
  tbody.innerHTML=Object.entries(snap.val()).map(([k,u])=>`<tr><td>${esc(u.username||'')}</td><td style="font-size:10px">${esc(u.email||'')}</td><td>${esc(u.banReason||'')}</td><td>${esc(u.bannedBy||'')}</td><td><button class="atn-btn g" onclick="unbanUser('${k}')">Unban</button></td></tr>`).join('')
}

// ‚îÄ‚îÄ REPORTS ADMIN ‚îÄ‚îÄ
async function loadAdmReports(){
  const tbody=document.getElementById('tbodyReports'); if(!tbody) return
  const snap=await DB.ref('reports').get()
  if(!snap.exists()){ tbody.innerHTML='<tr class="empty-row"><td colspan="6">Tidak ada laporan.</td></tr>'; return }
  const entries=Object.entries(snap.val()).map(([k,v])=>({...v,_key:k})).sort((a,b)=>b.createdAt-a.createdAt)
  tbody.innerHTML=entries.map(r=>`<tr><td>${esc(r.reporter||'')}</td><td>${esc(r.target||'')}</td><td>${esc(r.type||'')}</td><td><span class="badge b-${r.status==='open'?'open':'accepted'}">${r.status.toUpperCase()}</span></td><td>${fmtDate(r.createdAt)}</td><td><button class="atn-btn g" onclick="closeReport('${r._key}')">Tutup</button></td></tr>`).join('')
}
async function closeReport(key){ await DB.ref('reports/'+key).update({ status:'closed', closedBy:UP.username }); toast('Report ditutup.','i'); loadAdmReports() }

// ‚îÄ‚îÄ ADMIN CHAT ‚îÄ‚îÄ
function loadAdmChat(){
  if(admChatListener) admChatListener()
  const el=document.getElementById('admChatMsgs'); if(!el) return
  admChatListener = DB.ref('admin_chat').orderByChild('ts').limitToLast(80).on('value', snap=>{
    if(!snap.exists()){ el.innerHTML='<div style="text-align:center;padding:16px;color:var(--text3);font-size:11px">Belum ada pesan.</div>'; return }
    el.innerHTML=Object.values(snap.val()).map(m=>{
      const mine=m.uid===CU?.uid
      return `<div class="adm-msg ${mine?'mine':'theirs'}"><div class="adm-msg-meta"><span class="${rClass(m.role)}">[${ROLE_LABELS[m.role]||m.role}]</span> ${esc(m.author||'')}</div><div class="adm-msg-text">${esc(m.text||'')}</div><div class="adm-msg-time">${timeAgo(m.ts)}</div></div>`
    }).join('')
    el.scrollTop=el.scrollHeight
  })
}
async function sendAdminChat(){
  const input=document.getElementById('admChatInput'); if(!input||!input.value.trim()||!CU) return
  const text=input.value.trim(); input.value=''
  await DB.ref('admin_chat').push({ uid:CU.uid, author:UP.username, role:UP.role||'user', text, ts:Date.now() })
  addLog('CHAT',`Admin chat: ${UP.username}: ${text.substring(0,50)}`)
}

// ‚îÄ‚îÄ ANNOUNCEMENTS ADMIN ‚îÄ‚îÄ
function selAnnTag(el,tag){ document.querySelectorAll('#annTagPicker .role-chip').forEach(c=>c.classList.remove('sel')); el.classList.add('sel'); selectedAnnTag=tag }
async function loadAdmAnn(){
  const el=document.getElementById('annAdminList'); if(!el) return
  const snap=await DB.ref('announcements').orderByChild('ts').limitToLast(20).get()
  if(!snap.exists()){ el.innerHTML='<div style="color:var(--text3);font-size:11px">Belum ada pengumuman.</div>'; return }
  el.innerHTML=Object.entries(snap.val()).reverse().map(([k,a])=>`<div style="padding:9px;border-bottom:1px solid var(--border2)"><div style="font-size:11.5px;font-weight:600">${esc(a.title||'')}</div><div style="font-size:9.5px;color:var(--text3)">${esc(a.tag)} ‚Ä¢ ${fmtDate(a.ts)}</div><button class="atn-btn r" style="margin-top:4px" onclick="delAnn('${k}')">Hapus</button></div>`).join('')
}
async function postAnn(){
  const title=document.getElementById('annTitleInput').value.trim(), body=document.getElementById('annBodyInput').value.trim()
  if(!title||!body){ toast('Isi judul dan isi!','e'); return }
  const key=DB.ref('announcements').push().key
  await DB.ref('announcements/'+key).set({ tag:selectedAnnTag, title, content:body, author:UP.username, uid:CU.uid, ts:Date.now() })
  addLog('NEWS',`Pengumuman baru: "${title}" oleh ${UP.username}`)
  toast('Pengumuman diposting!','s'); document.getElementById('annTitleInput').value=''; document.getElementById('annBodyInput').value=''; loadAdmAnn(); loadAnn()
}
async function delAnn(key){ if(!confirm('Hapus pengumuman?')) return; await DB.ref('announcements/'+key).remove(); toast('Dihapus.','i'); loadAdmAnn() }

// ‚îÄ‚îÄ GUIDES ADMIN ‚îÄ‚îÄ
async function loadAdmGuides(){
  const type=document.getElementById('guideTypeFilter')?.value||'rules'
  const el=document.getElementById('guideAdmList'); if(!el) return
  const snap=await DB.ref('guides').orderByChild('type').equalTo(type).get()
  if(!snap.exists()){ el.innerHTML='<div style="color:var(--text3);font-size:11px">Belum ada artikel.</div>'; return }
  el.innerHTML=Object.entries(snap.val()).map(([k,g])=>`<div style="padding:9px;border-bottom:1px solid var(--border2)"><div style="font-size:11.5px;font-weight:600">${g.pinned?'üìå ':''} ${esc(g.title||'')}</div><div style="font-size:9.5px;color:var(--text3)">${esc(g.tag||'')} ‚Ä¢ ${fmtDate(g.createdAt)}</div><div style="display:flex;gap:5px;margin-top:5px"><button class="atn-btn" onclick='editGuide("${k}",${JSON.stringify(g)})'>Edit</button><button class="atn-btn r" onclick="delGuide('${k}')">Hapus</button></div></div>`).join('')
}
function editGuide(key,g){ editingGuideKey=key; document.getElementById('guideTitleInput').value=g.title||''; document.getElementById('guideTagInput').value=g.tag||''; document.getElementById('guideBodyInput').value=g.body||''; document.getElementById('guidePinnedInput').checked=g.pinned||false; document.getElementById('guideFormTitle').textContent='Edit Artikel'; document.getElementById('cancelGuideBtn').style.display='' }
function cancelGuideEdit(){ editingGuideKey=null; document.getElementById('guideTitleInput').value=''; document.getElementById('guideTagInput').value=''; document.getElementById('guideBodyInput').value=''; document.getElementById('guidePinnedInput').checked=false; document.getElementById('guideFormTitle').textContent='Tambah Artikel'; document.getElementById('cancelGuideBtn').style.display='none' }
async function submitGuide(){
  const type=document.getElementById('guideTypeFilter')?.value||'rules', title=document.getElementById('guideTitleInput').value.trim(), tag=document.getElementById('guideTagInput').value.trim(), body=document.getElementById('guideBodyInput').value.trim(), pinned=document.getElementById('guidePinnedInput').checked
  if(!title||!body){ toast('Isi judul dan konten!','e'); return }
  const data={type,title,tag,body,pinned,author:UP.username,createdAt:Date.now()}
  if(editingGuideKey){ await DB.ref('guides/'+editingGuideKey).update(data); toast('Diperbarui!','s') }
  else { await DB.ref('guides').push(data); toast('Artikel ditambahkan!','s') }
  delete guideCache[type]; cancelGuideEdit(); loadAdmGuides()
}
async function delGuide(key){ const type=document.getElementById('guideTypeFilter')?.value||'rules'; if(!confirm('Hapus artikel?')) return; await DB.ref('guides/'+key).remove(); delete guideCache[type]; toast('Dihapus.','i'); loadAdmGuides() }

// ‚îÄ‚îÄ STAFF ADMIN ‚îÄ‚îÄ
async function loadAdmStaff(){
  const tbody=document.getElementById('staffAdmTbody'); if(!tbody) return
  const snap=await DB.ref('staff').orderByChild('order').get()
  if(!snap.exists()){ tbody.innerHTML='<tr class="empty-row"><td colspan="4">Belum ada staff.</td></tr>'; return }
  tbody.innerHTML=Object.entries(snap.val()).map(([k,s])=>`<tr><td><span class="${s.class||'r-user'}">${esc(s.name||'‚Äî')}</span></td><td>${esc(s.role||'')}</td><td style="font-size:10px">${esc(s.wa?'+'+s.wa:'‚Äî')}</td><td><button class="atn-btn r" onclick="delStaff('${k}')">Hapus</button></td></tr>`).join('')
}
async function addStaff(){
  const name=document.getElementById('staffNameInput').value.trim(), role=document.getElementById('staffRoleInput').value, wa=document.getElementById('staffWAInput').value.trim()
  if(!name){ toast('Isi nama!','e'); return }
  const roleClass={'Owner':'r-owner','Co-Owner':'r-owner','Developer':'r-developer','Head Admin':'r-headadmin','Senior Admin':'r-senioradmin','Admin':'r-admin','Junior Admin':'r-junioradmin','Management':'r-management','Moderator':'r-moderator','Community Handle':'r-communityhandle','Senior Helper':'r-seniorhelper','Helper':'r-helper','Junior Helper':'r-juniorhelper','Volunteer':'r-volunteer','Ex Staff':'r-exstaff'}
  const count=(await DB.ref('staff').get()).numChildren()
  await DB.ref('staff').push({ name, role, wa:wa||'', class:roleClass[role]||'r-user', emoji:'', order:count+1 })
  toast('Staff ditambahkan!','s'); document.getElementById('staffNameInput').value=''; document.getElementById('staffWAInput').value=''; loadAdmStaff()
}
async function delStaff(key){ if(!confirm('Hapus staff ini?')) return; await DB.ref('staff/'+key).remove(); toast('Dihapus.','i'); loadAdmStaff() }

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
function loadSettingsForm(){
  const c=CFG, s=appConfig
  const sv=(id,v)=>{ const el=document.getElementById(id); if(el) el.value=v!==undefined?v:'' }
  sv('cfgServerIP',c.serverIP); sv('cfgServerName',c.serverName); sv('cfgWANumber',c.waNumber); sv('cfgWAGroup',c.waGroup); sv('cfgDescription',c.description); sv('cfgPostCooldown',s.postCooldownMin||60)
  sv('cfgWLOpen',s.wlOpen===false?'0':'1'); sv('cfgWLReq',s.wlRequirements||'Min. 17 tahun\nWhatsApp aktif\nMengerti RP dasar')
  sv('cfgCSOpen',s.csOpen===false?'0':'1'); sv('cfgCSInfo',s.csInfo||''); sv('cfgCSSchedules',s.csSchedules||'Senin 19:00,Kamis 19:00'); sv('cfgCSMinWords',s.csMinWords||150); sv('cfgCSPanduan',s.csPanduan||'')
  sv('cfgImportOpen',s.importOpen===false?'0':'1'); sv('cfgGoodside',s.goodsideOpen===false?'0':'1'); sv('cfgBadside',s.badsideOpen===false?'0':'1'); sv('cfgFamily',s.familyOpen===false?'0':'1'); sv('cfgImportInfo',s.importInfo||''); sv('cfgImportReq',s.importRequirements||'')
}
async function saveServerConfig(){
  const data={ serverIP:document.getElementById('cfgServerIP').value.trim(), serverName:document.getElementById('cfgServerName').value.trim(), waNumber:document.getElementById('cfgWANumber').value.trim(), waGroup:document.getElementById('cfgWAGroup').value.trim(), description:document.getElementById('cfgDescription').value.trim() }
  const cooldown=parseInt(document.getElementById('cfgPostCooldown').value)||60
  await DB.ref('config').update(data)
  await DB.ref('settings/postCooldownMin').set(cooldown)
  addLog('SYSTEM','Config server diperbarui oleh '+UP.username); toast('Config tersimpan!','s')
}
async function saveWLConfig(){
  const data={ wlOpen:document.getElementById('cfgWLOpen').value==='1', wlRequirements:document.getElementById('cfgWLReq').value.trim() }
  await DB.ref('settings').update(data); addLog('SYSTEM','Config WL diperbarui'); toast('Config WL tersimpan!','s'); applyAppConfig()
}
async function saveCSConfig(){
  const data={ csOpen:document.getElementById('cfgCSOpen').value==='1', csInfo:document.getElementById('cfgCSInfo').value.trim(), csSchedules:document.getElementById('cfgCSSchedules').value.trim(), csMinWords:parseInt(document.getElementById('cfgCSMinWords').value)||150, csPanduan:document.getElementById('cfgCSPanduan').value.trim() }
  await DB.ref('settings').update(data); addLog('SYSTEM','Config CS diperbarui'); toast('Config CS tersimpan!','s'); applyAppConfig()
}
async function saveImportConfig(){
  const data={ importOpen:document.getElementById('cfgImportOpen').value==='1', goodsideOpen:document.getElementById('cfgGoodside').value==='1', badsideOpen:document.getElementById('cfgBadside').value==='1', familyOpen:document.getElementById('cfgFamily').value==='1', importInfo:document.getElementById('cfgImportInfo').value.trim(), importRequirements:document.getElementById('cfgImportReq').value.trim() }
  await DB.ref('settings').update(data); addLog('SYSTEM','Config Import diperbarui'); toast('Config Import tersimpan!','s'); applyAppConfig()
}

// ‚îÄ‚îÄ TABLE FILTER ‚îÄ‚îÄ
function filterTbl(tblId,q){ const tbody=document.getElementById(tblId)?.querySelector('tbody'); if(!tbody) return; tbody.querySelectorAll('tr').forEach(tr=>{ tr.style.display=(tr.textContent.toLowerCase().includes(q.toLowerCase())||tr.classList.contains('empty-row'))?'':'none' }) }

// ============================================================
// INIT
// ============================================================
window.addEventListener('DOMContentLoaded', ()=>{
  nav('home')
  setTimeout(()=>document.getElementById('loader').classList.add('hidden'), 1000)
})
</script>
</body>
</html>
