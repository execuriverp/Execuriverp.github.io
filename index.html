<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Forum</title>
<style>
:root{
  --bg:#09090E;--bg2:#0F0F18;--bg3:#161622;--bg4:#1E1E2E;--bg5:#252535;
  --border:rgba(255,255,255,.07);--border2:rgba(255,255,255,.04);--border3:rgba(255,255,255,.14);
  --text:#DCDCE8;--text2:#9898B0;--text3:#5A5A72;
  --accent:#fff;--accent2:#d0d0e8;
  --gold:#FFD700;--orange:#FF6B00;--red:#E63946;--green:#25D366;--blue:#64b4ff;--purple:#b464ff;--cyan:#00C9B1;
  --radius:3px;--font:'Segoe UI',system-ui,sans-serif;--mono:'Courier New',monospace
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.5;min-height:100vh}
a{color:inherit;text-decoration:none}
::-webkit-scrollbar{width:3px;height:3px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1)}
.wrap{max-width:1200px;margin:0 auto;padding:0 16px}

/* TOPBAR */
#topbar{background:rgba(9,9,14,.97);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;backdrop-filter:blur(10px)}
.topbar-inner{display:flex;align-items:center;height:50px;gap:4px}
.logo{font-size:15px;font-weight:800;letter-spacing:3px;color:var(--accent);white-space:nowrap;margin-right:16px;flex-shrink:0}
.logo em{color:var(--text3);font-weight:400;font-size:10px;letter-spacing:0;font-style:normal;margin-left:5px}
nav.main-nav{display:flex;align-items:center;gap:1px;flex:1;overflow-x:auto}
nav.main-nav a{padding:5px 10px;color:var(--text2);font-size:11.5px;border-radius:var(--radius);white-space:nowrap;transition:all .12s}
nav.main-nav a:hover,nav.main-nav a.active{color:var(--accent);background:var(--bg3)}
.topbar-right{display:flex;align-items:center;gap:6px;flex-shrink:0;margin-left:10px}
.hamburger{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:6px;background:none;border:none}
.hamburger span{display:block;width:16px;height:1.5px;background:var(--text2)}
.notif-dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--red);margin-left:3px;vertical-align:middle}

/* BTN */
.btn{display:inline-flex;align-items:center;gap:4px;padding:5px 11px;border:1px solid var(--border3);border-radius:var(--radius);font-size:11.5px;cursor:pointer;transition:all .12s;background:transparent;color:var(--text2);font-family:var(--font);white-space:nowrap}
.btn:hover{color:var(--accent);background:var(--bg3)}
.btn-primary{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}
.btn-primary:hover{background:var(--accent2);color:#000}
.btn-danger{color:var(--red);border-color:rgba(230,57,70,.3);background:rgba(230,57,70,.06)}
.btn-danger:hover{background:var(--red);color:#fff}
.btn-green{color:var(--green);border-color:rgba(37,211,102,.3)}
.btn-green:hover{background:var(--green);color:#000}
.btn-sm{padding:3px 8px;font-size:11px}

/* MOBILE NAV */
.mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300}
.mobile-overlay.open{display:block}
.mobile-nav{position:fixed;top:0;left:0;width:260px;height:100vh;background:var(--bg2);border-right:1px solid var(--border);z-index:301;padding:14px 10px;display:flex;flex-direction:column;gap:2px;overflow-y:auto;transform:translateX(-100%);transition:transform .22s ease}
.mobile-nav.open{transform:translateX(0)}
.mobile-nav-logo{font-size:14px;font-weight:800;letter-spacing:3px;padding:4px 8px 12px;border-bottom:1px solid var(--border);margin-bottom:8px}
.mobile-nav-close{position:absolute;top:12px;right:12px;background:none;border:none;color:var(--text2);font-size:16px;cursor:pointer}
.mobile-nav a{display:block;padding:8px;color:var(--text2);border-radius:var(--radius);font-size:12.5px;transition:all .1s}
.mobile-nav a:hover{background:var(--bg3);color:var(--accent)}

/* LAYOUT */
.page-layout{display:flex;gap:16px;padding:16px 0 40px;align-items:flex-start}
.main-col{flex:1;min-width:0}
.side-col{width:240px;flex-shrink:0;display:flex;flex-direction:column;gap:8px}

/* CARD */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.category{margin-bottom:12px}
.cat-title{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--text3);padding:0 0 6px;border-bottom:1px solid var(--border);margin-bottom:3px}
.forum-row{display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border2);gap:10px;transition:background .1s;cursor:pointer}
.forum-row:last-child{border-bottom:none}
.forum-row:hover{background:var(--bg3)}
.forum-icon{width:32px;height:32px;border-radius:var(--radius);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;border:1px solid var(--border)}
.forum-info{flex:1;min-width:0}
.forum-name{font-size:12.5px;font-weight:600;color:var(--text);margin-bottom:2px}
.forum-desc{font-size:10.5px;color:var(--text3)}
.forum-stats{text-align:right;flex-shrink:0;min-width:55px}
.forum-stats .count{font-size:13px;font-weight:700;color:var(--text);display:block}
.forum-stats .label{font-size:9.5px;color:var(--text3)}

/* WIDGET */
.widget{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.widget-title{padding:8px 11px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);border-bottom:1px solid var(--border)}
.widget-body{padding:9px 11px}
.stat-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border2);font-size:11.5px}
.stat-row:last-child{border-bottom:none}
.stat-row .s-val{font-weight:700;color:var(--accent)}
.server-block{padding:8px;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px;cursor:pointer;transition:border-color .1s}
.server-block:last-child{margin-bottom:0}
.server-block:hover{border-color:var(--border3)}
.server-block .srv-type{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:2px}
.server-block .srv-addr{font-family:var(--mono);color:var(--text);font-size:11.5px}
.online-count{font-size:22px;font-weight:700;color:var(--accent)}
.online-sub{font-size:10.5px;color:var(--text3);margin-bottom:8px}
.online-tags{display:flex;flex-wrap:wrap;gap:5px}
.online-tag{display:flex;align-items:center;gap:3px;font-size:10.5px;color:var(--text2)}
.online-tag .dot{width:5px;height:5px;border-radius:50%;background:var(--green);flex-shrink:0}

/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:12px}
.tab-btn{padding:6px 13px;font-size:11.5px;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .12s;background:none;border-top:none;border-left:none;border-right:none;font-family:var(--font)}
.tab-btn:hover{color:var(--text)}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-panel{display:none}.tab-panel.active{display:block}

/* FORMS */
.form-row{display:flex;flex-direction:column;gap:3px;margin-bottom:10px}
.form-label{font-size:10.5px;font-weight:600;color:var(--text2)}
.form-input{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:7px 9px;color:var(--text);font-size:12.5px;font-family:var(--font);outline:none;transition:border-color .12s;width:100%}
.form-input:focus{border-color:rgba(255,255,255,.18)}
select.form-input{cursor:pointer}
textarea.form-input{resize:vertical;min-height:80px}

/* BADGES */
.s-badge{font-size:9.5px;font-weight:700;letter-spacing:.8px;padding:2px 6px;display:inline-block;border-radius:var(--radius)}
.s-pending{background:rgba(255,215,0,.08);color:var(--gold);border:1px solid rgba(255,215,0,.2)}
.s-process{background:rgba(100,180,255,.08);color:var(--blue);border:1px solid rgba(100,180,255,.2)}
.s-accepted{background:rgba(37,211,102,.08);color:var(--green);border:1px solid rgba(37,211,102,.2)}
.s-rejected,.s-denied{background:rgba(230,57,70,.08);color:var(--red);border:1px solid rgba(230,57,70,.2)}
.s-banned{background:rgba(230,57,70,.14);color:var(--red);border:1px solid rgba(230,57,70,.3)}
.s-open{background:rgba(255,107,0,.08);color:var(--orange);border:1px solid rgba(255,107,0,.25)}
.s-closed{background:rgba(255,255,255,.04);color:var(--text3);border:1px solid var(--border)}

/* ROLES */
.r-owner{color:#ff6b6b;font-weight:700}.r-developer{color:var(--blue);font-weight:700}
.r-headadmin,.r-admin{color:var(--red);font-weight:700}.r-management{color:var(--purple);font-weight:700}
.r-moderator{color:var(--orange);font-weight:700}
.r-helper,.r-juniorhelper,.r-seniorhelper,.r-junioradmin,.r-senioradmin,.r-communityhandle,.r-volunteer{color:var(--cyan);font-weight:600}
.r-vip{color:var(--gold);font-weight:600}.r-user,.r-exstaff{color:var(--text2)}

/* MISC */
.breadcrumb{display:flex;align-items:center;gap:4px;font-size:10.5px;color:var(--text3);margin-bottom:10px}
.breadcrumb .sep{color:var(--border3)}
.announce-bar{background:var(--bg2);border:1px solid var(--border);border-left:2px solid var(--accent);border-radius:var(--radius);padding:8px 11px;font-size:11.5px;color:var(--text2);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.info-box{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:9px 11px;font-size:11.5px;color:var(--text2);margin-bottom:10px}
.info-box.warn{border-left:2px solid var(--orange);color:var(--orange)}
.info-box.closed{border-left:2px solid var(--red);color:var(--red)}

/* WL STEPS */
.wl-progress{display:flex;align-items:center;margin-bottom:16px}
.wl-step{display:flex;align-items:center;flex:1}
.wl-step-circle{width:26px;height:26px;border-radius:50%;border:1.5px solid var(--border3);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--text3);flex-shrink:0;transition:all .25s}
.wl-step.done .wl-step-circle{background:var(--green);border-color:var(--green);color:#000}
.wl-step.active .wl-step-circle{border-color:var(--accent);color:var(--accent)}
.wl-step-label{font-size:9.5px;color:var(--text3);margin-left:5px;white-space:nowrap}
.wl-step.done .wl-step-label{color:var(--green)}.wl-step.active .wl-step-label{color:var(--accent)}
.wl-step-line{flex:1;height:1px;background:var(--border);margin:0 5px}

/* IMPORT TYPE */
.import-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:12px}
.import-type-btn{background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius);padding:10px 6px;text-align:center;cursor:pointer;transition:all .15s}
.import-type-btn:hover{border-color:var(--border3)}
.import-type-btn.selected{border-color:var(--accent);background:rgba(255,255,255,.04)}
.import-type-btn .it-icon{font-size:20px;margin-bottom:4px}
.import-type-btn .it-label{font-size:10.5px;font-weight:600;color:var(--text2)}

/* TIME SLOTS */
.time-slots{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px}
.time-slot{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:4px 9px;font-size:11px;color:var(--text2);cursor:pointer;transition:all .12s}
.time-slot:hover{border-color:var(--border3)}
.time-slot.selected{border-color:var(--accent);color:var(--accent);background:rgba(255,255,255,.04)}
.time-slot.unavailable{opacity:.35;cursor:not-allowed;text-decoration:line-through}

/* STAFF */
.staff-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(148px,1fr));gap:8px}
.staff-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:13px;text-align:center;transition:border-color .12s}
.staff-card:hover{border-color:var(--border3)}
.staff-avatar{width:46px;height:46px;border-radius:50%;background:var(--bg3);border:1.5px solid var(--border);margin:0 auto 7px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:var(--text2)}
.staff-name{font-size:12.5px;font-weight:600;margin-bottom:2px}
.staff-role{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}

/* LEADERBOARD */
.lb-row{display:flex;align-items:center;gap:9px;padding:9px 12px;border-bottom:1px solid var(--border2);transition:background .1s}
.lb-row:hover{background:var(--bg3)}.lb-row:last-child{border-bottom:none}
.lb-rank{width:24px;text-align:center;font-size:12px;font-weight:700;color:var(--text3);flex-shrink:0}
.lb-rank.top1{color:var(--gold)}.lb-rank.top2{color:var(--text)}.lb-rank.top3{color:#cd7f32}
.lb-avatar{width:32px;height:32px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--text2)}
.lb-info{flex:1;min-width:0}.lb-name{font-size:12.5px;font-weight:600}.lb-sub{font-size:10px;color:var(--text3)}
.lb-val{font-size:12.5px;font-weight:700;color:var(--green);flex-shrink:0}

/* PROFILE */
.profile-banner{height:110px;background:linear-gradient(135deg,#0a0a14,#14141f 50%,#090912);border-bottom:1px solid var(--border);position:relative;overflow:hidden}
.profile-banner::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 12px,rgba(255,255,255,.008) 12px,rgba(255,255,255,.008) 13px)}
.profile-head{display:flex;align-items:flex-end;gap:12px;padding:0 16px 12px;margin-top:-28px;position:relative}
.profile-avatar-wrap{position:relative;flex-shrink:0}
.profile-avatar{width:68px;height:68px;border-radius:50%;border:2.5px solid var(--bg2);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:var(--text2);overflow:hidden}
.profile-avatar img{width:100%;height:100%;object-fit:cover}
.profile-edit-btn{position:absolute;bottom:-1px;right:-1px;width:20px;height:20px;border-radius:50%;background:var(--bg3);border:1px solid var(--border3);display:flex;align-items:center;justify-content:center;font-size:9px;cursor:pointer;color:var(--text2)}
.p-stat .v{font-size:15px;font-weight:700;color:var(--accent);display:block}.p-stat .l{font-size:9.5px;color:var(--text3);text-transform:uppercase}

/* FEED */
.feed-composer{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:10px}
.composer-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;color:var(--text);font-size:12.5px;font-family:var(--font);outline:none;resize:none;transition:border-color .12s}
.post-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:7px}
.post-header{display:flex;align-items:center;gap:9px;padding:11px 13px 0}
.post-avatar{width:33px;height:33px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--text2);overflow:hidden}
.post-avatar img{width:100%;height:100%;object-fit:cover}
.post-body{padding:9px 13px;font-size:12.5px;color:var(--text2);line-height:1.65}
.post-image{width:100%;max-height:280px;object-fit:cover;border-top:1px solid var(--border);border-bottom:1px solid var(--border);display:block;cursor:pointer}
.post-actions{display:flex;align-items:center;gap:5px;padding:7px 13px 10px;border-top:1px solid var(--border2);flex-wrap:wrap}
.reaction-btn{background:none;border:1px solid var(--border);border-radius:20px;padding:3px 9px;font-size:11.5px;color:var(--text3);cursor:pointer;font-family:var(--font);transition:all .12s;display:flex;align-items:center;gap:3px}
.reaction-btn:hover{border-color:var(--border3);color:var(--text2)}
.reaction-btn.active{border-color:rgba(255,255,255,.2);color:var(--accent);background:rgba(255,255,255,.04)}
.post-comments{border-top:1px solid var(--border2);padding:9px 13px}
.comment-item{display:flex;gap:7px;margin-bottom:7px}
.comment-ava{width:24px;height:24px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--text2)}
.comment-body{background:var(--bg3);border-radius:var(--radius);padding:5px 9px;flex:1}
.comment-author{font-size:10.5px;font-weight:600;color:var(--text);margin-bottom:1px}
.comment-text{font-size:11.5px;color:var(--text2)}
.comment-input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:5px 11px;color:var(--text);font-size:11.5px;font-family:var(--font);outline:none}
.feed-ann-card{background:var(--bg2);border:1px solid var(--border);border-left:2px solid var(--red);border-radius:var(--radius);padding:11px 13px;margin-bottom:8px}
.feed-ann-card .ann-title{font-size:12.5px;font-weight:700;color:var(--accent);margin-bottom:3px}
.feed-ann-card .ann-body{font-size:11.5px;color:var(--text2);line-height:1.6}
.feed-ann-card .ann-meta{font-size:10px;color:var(--text3);margin-top:5px}

/* PM / CHAT */
.chat-layout{display:flex;height:calc(100vh - 115px);background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.chat-sidebar{width:238px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column}
.chat-sidebar-header{padding:10px 11px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-size:11.5px;font-weight:700}
.chat-search-bar{padding:6px 9px;border-bottom:1px solid var(--border)}
.chat-search-bar input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;color:var(--text);font-size:11.5px;font-family:var(--font);outline:none}
.chat-list{flex:1;overflow-y:auto}
.chat-item{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-bottom:1px solid var(--border2);transition:background .08s;position:relative}
.chat-item:hover{background:var(--bg3)}.chat-item.active{background:var(--bg4)}
.chat-item.unread::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:2px;height:20px;background:var(--accent)}
.chat-ava{width:33px;height:33px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--text2);position:relative;overflow:hidden}
.chat-ava img{width:100%;height:100%;object-fit:cover}
.online-dot{position:absolute;bottom:0;right:0;width:7px;height:7px;border-radius:50%;background:var(--green);border:1.5px solid var(--bg2)}
.chat-item-name{font-size:11.5px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.chat-item-preview{font-size:10px;color:var(--text3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:1px}
.chat-unread-badge{position:absolute;top:6px;right:8px;background:var(--accent);color:#000;font-size:8.5px;font-weight:700;width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.chat-main{flex:1;display:flex;flex-direction:column;min-width:0}
.chat-main-header{padding:9px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:12.5px;font-weight:700}
.chat-header-status{font-size:9.5px;color:var(--green);font-weight:400}
.chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.msg-group{display:flex;gap:7px;align-items:flex-end}.msg-group.mine{flex-direction:row-reverse}
.msg-ava-sm{width:24px;height:24px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700}
.msg-bubbles{display:flex;flex-direction:column;gap:2px;max-width:62%}
.msg-group.mine .msg-bubbles{align-items:flex-end}
.msg-bubble{padding:6px 10px;border-radius:12px;font-size:11.5px;line-height:1.45;word-break:break-word;background:var(--bg3);border:1px solid var(--border)}
.msg-group.mine .msg-bubble{background:var(--bg4);border-color:var(--border3)}
.msg-time{font-size:9.5px;color:var(--text3);margin-top:1px}
.msg-group.mine .msg-time{text-align:right}
.date-sep{text-align:center;font-size:9.5px;color:var(--text3);padding:2px 0;display:flex;align-items:center;gap:7px}
.date-sep::before,.date-sep::after{content:'';flex:1;height:1px;background:var(--border2)}
.chat-input-area{padding:9px 12px;border-top:1px solid var(--border);display:flex;align-items:flex-end;gap:6px}
.chat-input-wrap{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:6px 11px;display:flex;align-items:flex-end;gap:6px;transition:border-color .12s}
.chat-input-wrap:focus-within{border-color:rgba(255,255,255,.15)}
.chat-textarea{flex:1;background:none;border:none;color:var(--text);font-size:11.5px;font-family:var(--font);outline:none;resize:none;max-height:90px;line-height:1.5}
.chat-send-btn{width:32px;height:32px;border-radius:50%;background:var(--accent);color:#000;border:none;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:500;align-items:center;justify-content:center;padding:1rem}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border3);border-radius:var(--radius);width:90%;max-width:440px;max-height:90vh;overflow-y:auto;animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.modal.wide{max-width:580px}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:13px 15px;border-bottom:1px solid var(--border)}
.modal-title{font-size:13.5px;font-weight:700;color:var(--accent)}
.modal-close{background:none;border:none;color:var(--text3);font-size:17px;cursor:pointer;line-height:1}
.modal-close:hover{color:var(--accent)}
.modal-body{padding:14px 15px}
.modal-footer{padding:11px 15px;border-top:1px solid var(--border);display:flex;gap:7px;justify-content:flex-end}
.detail-row{display:flex;gap:.5rem;margin-bottom:.4rem;font-size:12px}
.detail-key{font-size:10px;color:var(--text2);min-width:110px;padding-top:.1rem}
.detail-val{color:var(--text);font-weight:600;flex:1;word-break:break-all}
.detail-story{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:11.5px;color:var(--text);line-height:1.65;max-height:180px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}

/* ADMIN */
.admin-layout{display:flex;min-height:calc(100vh - 50px);margin:0 -16px}
.admin-sidebar{width:200px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);padding:12px 0;overflow-y:auto}
.adm-nav-section{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--text3);padding:8px 13px 3px;margin-top:4px}
.adm-nav-item{display:flex;align-items:center;gap:6px;padding:6px 13px;font-size:11.5px;color:var(--text2);cursor:pointer;transition:all .08s;border-left:2px solid transparent;border:none;background:none;width:100%;text-align:left;border-left:2px solid transparent;font-family:var(--font)}
.adm-nav-item:hover{background:rgba(255,255,255,.025);color:var(--text)}
.adm-nav-item.active{color:var(--accent);background:rgba(255,255,255,.03);border-left-color:var(--accent)}
.adm-nav-badge{margin-left:auto;background:var(--red);color:#fff;font-size:8.5px;padding:1.5px 5px;border-radius:8px;min-width:15px;text-align:center}
.admin-content{flex:1;padding:18px 20px;overflow:auto}
.admin-page-title{font-size:16px;font-weight:700;color:var(--accent);margin-bottom:3px}
.admin-page-sub{font-size:10.5px;color:var(--text3);margin-bottom:14px;letter-spacing:.5px}
.admin-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:8px;margin-bottom:16px}
.admin-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
.admin-card .ac-label{font-size:9.5px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.admin-card .ac-val{font-size:24px;font-weight:700;color:var(--accent)}

/* TABLE */
.table-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;overflow-x:auto;margin-bottom:12px}
.table-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:6px}
.table-title{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text)}
.table-search{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:5px 9px;font-size:11px;font-family:var(--font);outline:none;border-radius:var(--radius);width:170px;transition:border-color .12s}
.table-search:focus{border-color:rgba(255,255,255,.15)}
table{width:100%;border-collapse:collapse;min-width:500px}
th{background:var(--bg3);padding:7px 10px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);text-align:left;border-bottom:1px solid var(--border)}
td{padding:8px 10px;font-size:11.5px;color:var(--text2);border-bottom:1px solid var(--border2);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.012)}
.empty-row td{text-align:center;color:var(--text3);font-size:11px;padding:1.5rem}
.action-btn{background:none;border:1px solid var(--border);color:var(--text2);padding:3px 7px;font-size:10px;cursor:pointer;transition:all .12s;font-family:var(--font);border-radius:var(--radius)}
.action-btn:hover{border-color:var(--accent);color:var(--accent)}
.action-btn.r:hover{border-color:var(--red);color:var(--red)}
.action-btn.g:hover{border-color:var(--green);color:var(--green)}

/* LOG */
.log-stream{background:var(--bg);border:1px solid var(--border);padding:8px;max-height:380px;overflow-y:auto;font-family:var(--mono);font-size:10.5px}
.log-entry{padding:.28rem 0;border-bottom:1px solid rgba(255,255,255,.025);display:flex;gap:.5rem;align-items:flex-start}
.log-time{color:var(--text3);min-width:125px;flex-shrink:0;font-size:9.5px}
.log-type{min-width:52px;flex-shrink:0;font-weight:700;font-size:9.5px}
.log-type.AUTH{color:var(--blue)}.log-type.WL{color:var(--gold)}.log-type.BAN{color:var(--red)}
.log-type.ACCEPT{color:var(--green)}.log-type.DENY,.log-type.REJECT{color:var(--orange)}
.log-type.ROLE{color:var(--purple)}.log-type.CS{color:var(--cyan)}.log-type.IMPORT{color:#6DD5A8}
.log-type.SYSTEM{color:var(--text2)}.log-type.NEWS{color:var(--purple)}.log-type.CHAT{color:var(--gold)}
.log-msg{color:var(--text);flex:1;line-height:1.4;font-size:10.5px}

/* ADMIN CHAT */
.admin-chat-wrap{display:flex;flex-direction:column;height:62vh;border:1px solid var(--border);border-radius:var(--radius)}
.admin-chat-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:var(--bg3)}
.admin-msg{max-width:70%;padding:7px 10px;border-radius:var(--radius)}
.admin-msg.mine{align-self:flex-end;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1)}
.admin-msg.theirs{align-self:flex-start;background:var(--bg2);border:1px solid var(--border)}
.admin-msg-meta{font-size:9.5px;color:var(--text2);margin-bottom:2px}
.admin-msg-text{font-size:11.5px;color:var(--text);line-height:1.5}
.admin-msg-time{font-size:9px;color:var(--text3);margin-top:2px}
.admin-chat-input-row{display:flex;gap:6px;padding:9px 12px;background:var(--bg2);border-top:1px solid var(--border)}
.admin-chat-input-row input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:7px 10px;color:var(--text);font-family:var(--font);font-size:12px;outline:none}
.admin-chat-input-row input:focus{border-color:rgba(255,255,255,.15)}
.btn-send{background:var(--accent);color:#000;border:none;padding:7px 14px;font-size:11.5px;font-weight:700;cursor:pointer;border-radius:var(--radius)}

/* PERM TAGS */
.perm-tag{font-size:10px;padding:3px 8px;cursor:pointer;user-select:none;display:inline-block;margin:2px;transition:all .12s;border-radius:var(--radius)}
.perm-tag.on{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.2);color:var(--accent)}
.perm-tag.off{background:none;border:1px solid var(--border);color:var(--text3)}
.role-chip{font-size:10px;padding:4px 9px;cursor:pointer;transition:all .12s;border:1px solid var(--border);color:var(--text2);display:inline-block;margin:2px;border-radius:var(--radius)}
.role-chip:hover{border-color:var(--border3)}
.role-chip.sel{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.25);color:var(--accent)}

/* SETTINGS */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.settings-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.settings-card-title{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--border)}

/* TOAST */
.toast-container{position:fixed;bottom:18px;right:18px;z-index:600;display:flex;flex-direction:column;gap:7px}
.toast{background:var(--bg2);border:1px solid var(--border3);border-radius:var(--radius);padding:9px 14px;font-size:11.5px;color:var(--text);display:flex;align-items:center;gap:7px;min-width:190px;animation:slideIn .2s ease}
.toast.success{border-left:2px solid var(--green)}.toast.error{border-left:2px solid var(--red)}.toast.info{border-left:2px solid var(--blue)}
@keyframes slideIn{from{transform:translateX(16px);opacity:0}to{transform:translateX(0);opacity:1}}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;transition:opacity .3s}
#loader.hidden{opacity:0;pointer-events:none}
.loader-logo{font-size:18px;font-weight:800;letter-spacing:4px;color:var(--accent)}
.loader-bar-wrap{width:140px;height:1.5px;background:var(--border);border-radius:2px;overflow:hidden}
.loader-bar{height:100%;background:var(--accent);animation:loadBar 1.1s ease-in-out forwards}
@keyframes loadBar{0%{width:0}100%{width:100%}}
.page{display:none}.page.active{display:block}
.adm-tab{display:none}.adm-tab.active{display:block}

/* RESPONSIVE */
@media(max-width:900px){.side-col{display:none}}
@media(max-width:700px){.hamburger{display:flex}nav.main-nav{display:none}.chat-sidebar{display:none}.admin-sidebar{display:none}.settings-grid{grid-template-columns:1fr}.admin-cards{grid-template-columns:1fr 1fr}.staff-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}}
@media(max-width:480px){.admin-cards{grid-template-columns:1fr}}
</style>
</head>
<body>

<div id="loader"><div class="loader-logo">MIRACLE</div><div class="loader-bar-wrap"><div class="loader-bar"></div></div></div>
<div class="toast-container" id="toastContainer"></div>

<!-- MOBILE NAV -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileNav()"></div>
<nav class="mobile-nav" id="mobileNav">
  <button class="mobile-nav-close" onclick="closeMobileNav()">&#215;</button>
  <div class="mobile-nav-logo">MIRACLE</div>
  <a href="#" onclick="showPage('forums');closeMobileNav()">&#127968; Home</a>
  <a href="#" onclick="showPage('feed');closeMobileNav()">&#128240; Feed</a>
  <a href="#" onclick="showPage('whitelist');closeMobileNav()">&#128203; Whitelist</a>
  <a href="#" onclick="showPage('cs');closeMobileNav()">&#127917; Character Story</a>
  <a href="#" onclick="showPage('import');closeMobileNav()">&#128230; Import</a>
  <a href="#" onclick="showPage('staff');closeMobileNav()">&#128101; Staff</a>
  <a href="#" onclick="showPage('leaderboard');closeMobileNav()">&#127942; Leaderboard</a>
  <a href="#" onclick="showPage('report');closeMobileNav()">&#128169; Report</a>
  <a href="#" onclick="showPage('announcements');closeMobileNav()">&#128226; Pengumuman</a>
  <a href="#" onclick="showPage('rules');closeMobileNav()">&#128220; Rules</a>
  <a href="#" onclick="showPage('pm');closeMobileNav()">&#128172; Pesan<span class="notif-dot" id="pmDotMobile" style="display:none"></span></a>
  <a href="#" id="mobileAdminLink" onclick="showPage('admin');closeMobileNav()" style="display:none">&#9881; Admin</a>
</nav>

<!-- TOPBAR -->
<div id="topbar">
  <div class="wrap">
    <div class="topbar-inner">
      <button class="hamburger" onclick="openMobileNav()"><span></span><span></span><span></span></button>
      <div class="logo">MIRACLE<em>RP</em></div>
      <nav class="main-nav" id="mainNav">
        <a href="#" class="active" onclick="showPage('forums',this)">Home</a>
        <a href="#" onclick="showPage('feed',this)">Feed</a>
        <a href="#" onclick="showPage('whitelist',this)">Whitelist</a>
        <a href="#" onclick="showPage('cs',this)">C.Story</a>
        <a href="#" onclick="showPage('import',this)">Import</a>
        <a href="#" onclick="showPage('staff',this)">Staff</a>
        <a href="#" onclick="showPage('leaderboard',this)">LB</a>
        <a href="#" onclick="showPage('report',this)">Report</a>
        <a href="#" onclick="showPage('announcements',this)">Pengumuman</a>
        <a href="#" onclick="showPage('pm',this)">Pesan<span class="notif-dot" id="pmDot" style="display:none"></span></a>
        <a href="#" id="adminNavLink" onclick="showPage('admin',this)" style="display:none">Admin</a>
      </nav>
      <div class="topbar-right" id="topbarRight">
        <button class="btn" onclick="openModal('loginModal')">Masuk</button>
        <button class="btn btn-primary" onclick="openModal('loginModal')">Daftar</button>
      </div>
    </div>
  </div>
</div>
<!-- MODALS -->
<div class="modal-overlay" id="loginModal">
  <div class="modal"><div class="modal-header"><div class="modal-title">Login / Daftar</div><button class="modal-close" onclick="closeModal('loginModal')">&#215;</button></div>
  <div class="modal-body"><p style="font-size:11.5px;color:var(--text3);margin-bottom:14px">Login dengan Google untuk bergabung di komunitas Miracle RP.</p>
  <button class="btn btn-primary" style="width:100%;justify-content:center;padding:10px;font-size:13px" onclick="loginWithGoogle()">
    <svg width="15" height="15" viewBox="0 0 48 48" style="flex-shrink:0"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
    Masuk dengan Google</button></div></div>
</div>
<div class="modal-overlay" id="newPmModal">
  <div class="modal"><div class="modal-header"><div class="modal-title">Pesan Baru</div><button class="modal-close" onclick="closeModal('newPmModal')">&#215;</button></div>
  <div class="modal-body"><div class="form-row"><label class="form-label">Kirim ke (username)</label><input type="text" class="form-input" id="newPmTarget" placeholder="Username..."></div>
  <div class="form-row"><label class="form-label">Pesan</label><textarea class="form-input" id="newPmMessage" placeholder="Tulis pesan..."></textarea></div></div>
  <div class="modal-footer"><button class="btn" onclick="closeModal('newPmModal')">Batal</button><button class="btn btn-primary" onclick="sendNewPm()">Kirim</button></div></div>
</div>
<div class="modal-overlay" id="imageModal" onclick="closeModal('imageModal')">
  <img id="imageModalSrc" src="" style="max-width:90vw;max-height:90vh;border-radius:4px;object-fit:contain">
</div>
<!-- Modal WL Detail -->
<div class="modal-overlay" id="modalWL">
  <div class="modal wide"><div class="modal-header"><div class="modal-title">Detail Whitelist</div><button class="modal-close" onclick="closeModal('modalWL')">&#215;</button></div>
  <div class="modal-body"><div id="wlDetailBody"></div></div>
  <div class="modal-footer" id="wlActions"></div></div>
</div>
<!-- Modal CS Detail -->
<div class="modal-overlay" id="modalCS">
  <div class="modal wide"><div class="modal-header"><div class="modal-title">Detail CS Request</div><button class="modal-close" onclick="closeModal('modalCS')">&#215;</button></div>
  <div class="modal-body"><div id="csDetailBody"></div></div>
  <div class="modal-footer" id="csActions"></div></div>
</div>
<!-- Modal Import Detail -->
<div class="modal-overlay" id="modalImport">
  <div class="modal wide"><div class="modal-header"><div class="modal-title">Detail Import Request</div><button class="modal-close" onclick="closeModal('modalImport')">&#215;</button></div>
  <div class="modal-body"><div id="importDetailBody"></div></div>
  <div class="modal-footer" id="importActions"></div></div>
</div>
<!-- Modal Role & Permission -->
<div class="modal-overlay" id="modalRole">
  <div class="modal wide"><div class="modal-header"><div class="modal-title">Kelola Role & Permission</div><button class="modal-close" onclick="closeModal('modalRole')">&#215;</button></div>
  <div class="modal-body">
    <div style="font-size:11px;color:var(--text2);margin-bottom:12px" id="roleTargetSub"></div>
    <div style="margin-bottom:10px"><div class="form-label" style="margin-bottom:5px">Primary Role</div><div id="primaryRoleSelect" style="display:flex;flex-wrap:wrap;gap:3px"></div></div>
    <div><div class="form-label" style="margin-bottom:5px">Permission Tambahan</div><div id="permSelect" style="display:flex;flex-wrap:wrap;gap:2px"></div></div>
  </div>
  <div class="modal-footer"><button class="btn" onclick="closeModal('modalRole')">Batal</button><button class="btn btn-primary" onclick="confirmRoleChange()">Simpan</button></div></div>
</div>
<!-- Modal Ban -->
<div class="modal-overlay" id="modalBan">
  <div class="modal"><div class="modal-header"><div class="modal-title" style="color:var(--red)">Ban User</div><button class="modal-close" onclick="closeModal('modalBan')">&#215;</button></div>
  <div class="modal-body"><p style="font-size:11.5px;color:var(--text2);margin-bottom:10px" id="banTargetSub"></p>
  <div class="form-row"><label class="form-label">Alasan Ban</label><input type="text" class="form-input" id="banReasonInput" placeholder="Alasan..."></div></div>
  <div class="modal-footer"><button class="btn" onclick="closeModal('modalBan')">Batal</button><button class="btn btn-danger" onclick="confirmBan()">Ban User</button></div></div>
</div>
<!-- Modal IC Name -->
<div class="modal-overlay" id="modalICName">
  <div class="modal"><div class="modal-header"><div class="modal-title">Edit Nama IC</div><button class="modal-close" onclick="closeModal('modalICName')">&#215;</button></div>
  <div class="modal-body"><p style="font-size:11px;color:var(--text2);margin-bottom:10px" id="icNameTargetSub"></p>
  <div class="form-row"><label class="form-label">Nama IC Baru (Format: Nama_Belakang)</label><input type="text" class="form-input" id="icNameInput" placeholder="John_Doe"></div></div>
  <div class="modal-footer"><button class="btn" onclick="closeModal('modalICName')">Batal</button><button class="btn btn-primary" onclick="confirmICNameChange()">Simpan</button></div></div>
</div>

<div class="wrap">
<!-- HOME -->
<div class="page active" id="page-forums">
  <div class="page-layout">
    <div class="main-col">
      <div class="announce-bar" id="topAnnounce"><span>&#128226;</span><span><strong>Selamat datang</strong> di Miracle RP Community Forum!</span></div>
      <div class="category">
        <div class="cat-title">Miracle Roleplay</div>
        <div class="card">
          <div class="forum-row" onclick="showPage('feed')"><div class="forum-icon">&#128240;</div><div class="forum-info"><div class="forum-name">Community Feed</div><div class="forum-desc">Update, cerita dan diskusi komunitas.</div></div><div class="forum-stats"><span class="count" id="statPosts">&#8212;</span><span class="label">posts</span></div></div>
          <div class="forum-row" onclick="showPage('whitelist')"><div class="forum-icon">&#128203;</div><div class="forum-info"><div class="forum-name">Pendaftaran Whitelist</div><div class="forum-desc">Daftar untuk bergabung sebagai player.</div></div><div class="forum-stats"><span class="count" id="statWL">&#8212;</span><span class="label">pending</span></div></div>
          <div class="forum-row" onclick="showPage('cs')"><div class="forum-icon">&#127917;</div><div class="forum-info"><div class="forum-name">Character Story Request</div><div class="forum-desc">Ajukan cerita latar belakang karakter.</div></div><div class="forum-stats"><span class="count" id="statCS">&#8212;</span><span class="label">request</span></div></div>
          <div class="forum-row" onclick="showPage('import')"><div class="forum-icon">&#128230;</div><div class="forum-info"><div class="forum-name">Import Request</div><div class="forum-desc">Request import goodside / badside / family.</div></div><div class="forum-stats"><span class="count" id="statImport">&#8212;</span><span class="label">pending</span></div></div>
          <div class="forum-row" onclick="showPage('report')"><div class="forum-icon">&#128169;</div><div class="forum-info"><div class="forum-name">Laporan & Bantuan</div><div class="forum-desc">Laporkan pelanggaran atau minta bantuan staff.</div></div><div class="forum-stats"><span class="count" id="statReports">&#8212;</span><span class="label">open</span></div></div>
        </div>
      </div>
      <div class="category">
        <div class="cat-title">Informasi Server</div>
        <div class="card">
          <div class="forum-row" onclick="showPage('announcements')"><div class="forum-icon">&#128226;</div><div class="forum-info"><div class="forum-name">Pengumuman</div><div class="forum-desc">Informasi resmi dari tim Miracle RP.</div></div><div class="forum-stats"><span class="count" id="statAnnouncements">&#8212;</span><span class="label">posts</span></div></div>
          <div class="forum-row" onclick="showPage('rules')"><div class="forum-icon">&#128220;</div><div class="forum-info"><div class="forum-name">Peraturan & Guide</div><div class="forum-desc">Rules, Guide Job, Goodside, Badside.</div></div></div>
          <div class="forum-row" onclick="showPage('staff')"><div class="forum-icon">&#128101;</div><div class="forum-info"><div class="forum-name">Tim Staff</div><div class="forum-desc">Kenali tim admin dan staff Miracle RP.</div></div></div>
        </div>
      </div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Server Address</div><div class="widget-body">
        <div class="server-block" onclick="copyToClip(document.getElementById('srvIP').textContent)"><div class="srv-type">SA:MP Roleplay</div><div class="srv-addr" id="srvIP">memuat...</div></div>
        <div class="server-block" onclick="copyToClip(document.getElementById('srvDC').textContent)"><div class="srv-type">Discord</div><div class="srv-addr" id="srvDC">memuat...</div></div>
      </div></div>
      <div class="widget"><div class="widget-title">Online Sekarang</div><div class="widget-body">
        <div class="online-count" id="onlineCount">0</div><div class="online-sub" id="onlineSub">memuat...</div>
        <div class="online-tags" id="onlineTags"></div>
      </div></div>
      <div class="widget"><div class="widget-title">Statistik</div><div class="widget-body" style="padding:0 11px">
        <div class="stat-row"><span>Total Member</span><span class="s-val" id="totalMembers">&#8212;</span></div>
        <div class="stat-row"><span>WL Diterima</span><span class="s-val" id="wlAcceptedStat">&#8212;</span></div>
        <div class="stat-row"><span>WL Pending</span><span class="s-val" id="wlPendingStat">&#8212;</span></div>
      </div></div>
    </div>
  </div>
</div>

<!-- FEED -->
<div class="page" id="page-feed">
  <div class="page-layout">
    <div class="main-col">
      <div id="feedAnnouncements"></div>
      <div id="feedComposer" style="display:none">
        <div class="feed-composer">
          <div style="display:flex;gap:9px;align-items:flex-start">
            <div class="post-avatar" id="composerAvatar">?</div>
            <textarea class="composer-input" id="composerText" placeholder="Bagikan sesuatu ke komunitas..." rows="3"></textarea>
          </div>
          <div style="display:flex;align-items:center;gap:7px;margin-top:9px">
            <label class="btn btn-sm" style="cursor:pointer">&#128247; Foto<input type="file" accept="image/*" style="display:none" onchange="handlePostImage(event)"></label>
            <div style="flex:1"></div>
            <span id="cooldownTimer" style="font-size:10.5px;color:var(--text3);display:none"></span>
            <button class="btn btn-primary btn-sm" onclick="submitPost()">Posting</button>
          </div>
          <div id="postImagePreview" style="display:none;margin-top:7px">
            <img id="postImgPreviewImg" style="max-height:130px;border-radius:3px;border:1px solid var(--border)">
            <button onclick="clearPostImage()" style="background:none;border:none;color:var(--red);cursor:pointer;margin-left:7px;font-size:11px">&#10005; Hapus</button>
          </div>
        </div>
      </div>
      <div id="feedList"></div>
      <div id="feedEmpty" style="display:none;text-align:center;padding:36px;color:var(--text3);font-size:12px">Belum ada post.</div>
    </div>
    <div class="side-col"><div class="widget"><div class="widget-title">Server</div><div class="widget-body"><div class="server-block"><div class="srv-type">SA:MP</div><div class="srv-addr" id="feedSrvIP">&#8212;</div></div></div></div></div>
  </div>
</div>

<!-- WHITELIST -->
<div class="page" id="page-whitelist">
  <div class="page-layout">
    <div class="main-col">
      <div class="breadcrumb"><a href="#" onclick="showPage('forums')">Home</a><span class="sep">&#8250;</span><span>Whitelist</span></div>
      <div id="wlStatusView" style="display:none"></div>
      <div id="wlFormView">
        <div id="wlClosedBox" class="info-box closed" style="display:none">&#9940; Whitelist sedang ditutup. Pantau pengumuman untuk info pembukaan.</div>
        <div id="wlOpenContent">
          <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:10px">Form Pendaftaran Whitelist</div>
          <div class="wl-progress">
            <div class="wl-step active" id="wlStep1"><div class="wl-step-circle">1</div><div class="wl-step-label">Data Diri</div></div>
            <div class="wl-step-line"></div>
            <div class="wl-step" id="wlStep2"><div class="wl-step-circle">2</div><div class="wl-step-label">Pengetahuan RP</div></div>
            <div class="wl-step-line"></div>
            <div class="wl-step" id="wlStep3"><div class="wl-step-circle">3</div><div class="wl-step-label">Verifikasi WA</div></div>
            <div class="wl-step-line"></div>
            <div class="wl-step" id="wlStep4"><div class="wl-step-circle">4</div><div class="wl-step-label">Selesai</div></div>
          </div>
          <div id="wlPage1" class="card" style="padding:18px">
            <div style="font-size:12.5px;font-weight:700;color:var(--accent);margin-bottom:12px">Data Diri</div>
            <div id="wlReqBox" class="info-box" style="display:none"></div>
            <div class="form-row"><label class="form-label">Nama Lengkap</label><input type="text" class="form-input" id="wlNama" placeholder="Nama lengkap kamu"></div>
            <div class="form-row"><label class="form-label">Nama Karakter (IC) &mdash; Format: Nama_Belakang</label><input type="text" class="form-input" id="wlKarakter" placeholder="Nama_Karakter"></div>
            <div class="form-row"><label class="form-label">Umur</label><input type="number" class="form-input" id="wlUmur" placeholder="Umur" style="max-width:110px"></div>
            <div class="form-row"><label class="form-label">Nomor WhatsApp</label><input type="text" class="form-input" id="wlWA" placeholder="08xxxxxxxxxx" style="max-width:190px"></div>
            <div class="form-row"><label class="form-label">Pengalaman SA:MP</label><select class="form-input" id="wlExp" style="max-width:230px"><option value="">Pilih...</option><option>Ya, sudah berpengalaman</option><option>Ya, tapi masih belajar</option><option>Belum pernah</option></select></div>
            <div class="form-row"><label class="form-label">Fraksi yang Diminati</label><input type="text" class="form-input" id="wlFaction" placeholder="Civilian, Polisi, dll" style="max-width:230px"></div>
            <button class="btn btn-primary" onclick="wlNext(1)">Lanjut &#8594;</button>
          </div>
          <div id="wlPage2" class="card" style="padding:18px;display:none">
            <div style="font-size:12.5px;font-weight:700;color:var(--accent);margin-bottom:12px">Pengetahuan Roleplay</div>
            <div class="form-row"><label class="form-label">Apa itu Roleplay?</label><textarea class="form-input" id="wlQ1" placeholder="Jelaskan dengan kata-katamu sendiri..."></textarea></div>
            <div class="form-row"><label class="form-label">Apa itu Metagaming? Berikan contoh!</label><textarea class="form-input" id="wlQ2" placeholder="Penjelasan + contoh..."></textarea></div>
            <div class="form-row"><label class="form-label">Apa itu Powergaming? Berikan contoh!</label><textarea class="form-input" id="wlQ3" placeholder="Penjelasan + contoh..."></textarea></div>
            <div class="form-row"><label class="form-label">Alasan bergabung di Miracle RP</label><textarea class="form-input" id="wlReason" placeholder="Alasan kamu..."></textarea></div>
            <div style="display:flex;gap:7px"><button class="btn" onclick="wlBack(2)">&#8592; Kembali</button><button class="btn btn-primary" onclick="wlNext(2)">Lanjut &#8594;</button></div>
          </div>
          <div id="wlPage3" class="card" style="padding:18px;display:none">
            <div style="font-size:12.5px;font-weight:700;color:var(--accent);margin-bottom:12px">Verifikasi WhatsApp</div>
            <p style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">Kode verifikasi akan dikirim ke WA <strong id="wlWADisplay"></strong>.</p>
            <div class="info-box">&#128241; Demo mode: masukkan kode <strong>123456</strong></div>
            <div class="form-row"><label class="form-label">Kode Verifikasi</label><input type="text" class="form-input" id="wlOTP" placeholder="6 digit kode" style="max-width:150px;letter-spacing:4px;text-align:center"></div>
            <div style="display:flex;gap:7px"><button class="btn" onclick="wlBack(3)">&#8592; Kembali</button><button class="btn btn-primary" onclick="wlSubmit()">Kirim Pendaftaran</button></div>
          </div>
          <div id="wlPage4" class="card" style="padding:28px;text-align:center;display:none">
            <div style="font-size:36px;margin-bottom:10px">&#9989;</div>
            <div style="font-size:15px;font-weight:700;color:var(--green);margin-bottom:7px">Pendaftaran Berhasil!</div>
            <div style="font-size:11.5px;color:var(--text3);line-height:1.6">Pendaftaran sedang diproses oleh staff.<br>Pantau status di halaman ini.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="side-col">
      <div class="widget"><div class="widget-title">Syarat Whitelist</div><div class="widget-body" id="wlReqWidget" style="font-size:11.5px;color:var(--text2);line-height:1.9"><span style="color:var(--text3)">Memuat...</span></div></div>
      <div class="widget"><div class="widget-title">Status WL</div><div class="widget-body" style="padding:0 11px">
        <div class="stat-row"><span>Pending</span><span class="s-val" id="wlStatPending">&#8212;</span></div>
        <div class="stat-row"><span>Diproses</span><span class="s-val" id="wlStatProcess">&#8212;</span></div>
        <div class="stat-row"><span>Diterima</span><span class="s-val" id="wlStatAccepted">&#8212;</span></div>
      </div></div>
    </div>
  </div>
</div>

<!-- CHARACTER STORY -->
<div class="page" id="page-cs">
  <div class="page-layout">
    <div class="main-col">
      <div class="breadcrumb"><a href="#" onclick="showPage('forums')">Home</a><span class="sep">&#8250;</span><span>Character Story Request</span></div>
      <div id="csMyRequest" style="display:none"></div>
      <div id="csFormView">
        <div id="csClosedBox" class="info-box closed" style="display:none">&#9940; CS Request sedang ditutup sementara.</div>
        <div id="csOpenContent">
          <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:10px">Buat Character Story Request</div>
          <div class="card" style="padding:18px">
            <div id="csInfoBox" class="info-box">Memuat info...</div>
            <div class="form-row"><label class="form-label">Nama IC (Sesuai WL)</label><input type="text" class="form-input" id="csIcName" placeholder="Nama_IC_Kamu"></div>
            <div class="form-row"><label class="form-label">Nama Character Story</label><input type="text" class="form-input" id="csCharName" placeholder="Karakter_Story"></div>
            <div class="form-row"><label class="form-label">Usia Karakter</label><input type="number" class="form-input" id="csAge" placeholder="Usia" style="max-width:110px"></div>
            <div class="form-row"><label class="form-label">Level Karakter</label><input type="number" class="form-input" id="csLevel" placeholder="Level" style="max-width:110px"></div>
            <div class="form-row"><label class="form-label">Screenshot Level (link)</label><input type="text" class="form-input" id="csScreenshot" placeholder="https://..."></div>
            <div class="form-row"><label class="form-label">Story IC <span id="csMinWordLabel" style="font-size:9.5px;color:var(--text3)">(min. 150 kata)</span></label><textarea class="form-input" id="csStory" rows="6" placeholder="Ceritakan latar belakang karakter secara detail..."></textarea></div>
            <div class="form-row"><label class="form-label">Pilih Jadwal Review</label><div class="time-slots" id="csTimeSlots"><span style="color:var(--text3);font-size:11px">Memuat jadwal...</span></div></div>
            <button class="btn btn-primary" onclick="submitCS()">Kirim CS Request</button>
          </div>
        </div>
      </div>
    </div>
    <div class="side-col"><div class="widget"><div class="widget-title">Panduan CS</div><div class="widget-body" id="csPanduanWidget" style="font-size:11.5px;color:var(--text2);line-height:1.9"><span style="color:var(--text3)">Memuat...</span></div></div></div>
  </div>
</div>

<!-- IMPORT -->
<div class="page" id="page-import">
  <div class="page-layout">
    <div class="main-col">
      <div class="breadcrumb"><a href="#" onclick="showPage('forums')">Home</a><span class="sep">&#8250;</span><span>Import Request</span></div>
      <div id="importMyRequest" style="display:none"></div>
      <div id="importFormView">
        <div id="importClosedBox" class="info-box closed" style="display:none">&#9940; Import Request sedang ditutup sementara.</div>
        <div id="importOpenContent">
          <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:10px">Buat Import Request</div>
          <div class="card" style="padding:18px">
            <div id="importInfoBox" class="info-box">Memuat info...</div>
            <div class="form-row"><label class="form-label">Jenis Import</label>
              <div class="import-type-grid">
                <div class="import-type-btn" id="impTypeGoodside" onclick="selectImportType(this,'goodside')"><div class="it-icon">&#128330;</div><div class="it-label">Goodside</div></div>
                <div class="import-type-btn" id="impTypeBadside" onclick="selectImportType(this,'badside')"><div class="it-icon">&#128298;</div><div class="it-label">Badside</div></div>
                <div class="import-type-btn" id="impTypeFamily" onclick="selectImportType(this,'family')"><div class="it-icon">&#128106;</div><div class="it-label">Family</div></div>
              </div>
            </div>
            <div class="form-row"><label class="form-label">Nama IC</label><input type="text" class="form-input" id="importIcName" placeholder="Nama_IC_Kamu"></div>
            <div class="form-row"><label class="form-label">Fraksi / Family yang Dituju</label><input type="text" class="form-input" id="importFaction" placeholder="Nama fraksi atau family"></div>
            <div class="form-row"><label class="form-label">Level Karakter</label><input type="number" class="form-input" id="importLevel" placeholder="Level" style="max-width:110px"></div>
            <div class="form-row"><label class="form-label">Alasan / Lore IC</label><textarea class="form-input" id="importLore" rows="4" placeholder="Jelaskan alasan in-character..."></textarea></div>
            <div class="form-row"><label class="form-label">Bukti Pendukung (link)</label><input type="text" class="form-input" id="importProof" placeholder="https://..."></div>
            <button class="btn btn-primary" onclick="submitImport()">Kirim Request</button>
          </div>
        </div>
      </div>
    </div>
    <div class="side-col"><div class="widget"><div class="widget-title">Ketentuan Import</div><div class="widget-body" id="importReqWidget" style="font-size:11.5px;color:var(--text2);line-height:1.9"><span style="color:var(--text3)">Memuat...</span></div></div></div>
  </div>
</div>

<!-- STAFF -->
<div class="page" id="page-staff">
  <div class="page-layout">
    <div class="main-col">
      <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:10px">Tim Staff Miracle RP</div>
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this,'staff-all')">Semua</button>
        <button class="tab-btn" onclick="switchTab(this,'staff-owner')">Owner</button>
        <button class="tab-btn" onclick="switchTab(this,'staff-admin')">Admin</button>
        <button class="tab-btn" onclick="switchTab(this,'staff-dev')">Developer</button>
        <button class="tab-btn" onclick="switchTab(this,'staff-helper')">Helper</button>
      </div>
      <div class="tab-panel active" id="staff-all"><div class="staff-grid" id="staffGridAll"></div></div>
      <div class="tab-panel" id="staff-owner"><div class="staff-grid" id="staffGridOwner"></div></div>
      <div class="tab-panel" id="staff-admin"><div class="staff-grid" id="staffGridAdmin"></div></div>
      <div class="tab-panel" id="staff-dev"><div class="staff-grid" id="staffGridDev"></div></div>
      <div class="tab-panel" id="staff-helper"><div class="staff-grid" id="staffGridHelper"></div></div>
    </div>
    <div class="side-col"><div class="widget"><div class="widget-title">Hubungi Staff</div><div class="widget-body" style="font-size:11.5px;color:var(--text2);line-height:1.9"><p>&#128172; Forum ini</p><p id="staffWAInfo">&#128241; WhatsApp</p><p>&#8987; Jam aktif: 17:00-24:00 WIB</p></div></div></div>
  </div>
</div>

<!-- LEADERBOARD -->
<div class="page" id="page-leaderboard">
  <div class="page-layout">
    <div class="main-col">
      <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:10px">Leaderboard</div>
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this,'lb-posts')">Posts Terbanyak</button>
        <button class="tab-btn" onclick="switchTab(this,'lb-wl')">WL Terbaru</button>
      </div>
      <div class="tab-panel active" id="lb-posts"><div class="card" id="lbPostsList"></div></div>
      <div class="tab-panel" id="lb-wl"><div class="card" id="lbWLList"></div></div>
    </div>
    <div class="side-col"><div class="widget"><div class="widget-title">Role Colors</div><div class="widget-body" style="padding:0 11px">
      <div class="stat-row"><span class="r-owner">Owner</span></div>
      <div class="stat-row"><span class="r-admin">Admin</span></div>
      <div class="stat-row"><span class="r-developer">Developer</span></div>
      <div class="stat-row"><span class="r-helper">Helper</span></div>
      <div class="stat-row"><span class="r-vip">VIP</span></div>
      <div class="stat-row"><span class="r-user">Member</span></div>
    </div></div></div>
  </div>
</div>

<!-- REPORT -->
<div class="page" id="page-report">
  <div class="page-layout">
    <div class="main-col">
      <div class="breadcrumb"><a href="#" onclick="showPage('forums')">Home</a><span class="sep">&#8250;</span><span>Laporan</span></div>
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this,'rp-form')">Buat Laporan</button>
        <button class="tab-btn" onclick="switchTab(this,'rp-list');loadReportList()">Laporan Saya</button>
      </div>
      <div class="tab-panel active" id="rp-form">
        <div class="info-box warn" style="margin-bottom:10px">&#9888; Pastikan kamu punya <strong>bukti valid</strong>. Laporan palsu = sanksi.</div>
        <div class="card" style="padding:16px">
          <div class="form-row"><label class="form-label">Nama Karakter Pelapor</label><input type="text" class="form-input" id="repReporter" placeholder="Nama_IC_Kamu"></div>
          <div class="form-row"><label class="form-label">Nama / Mask ID Terlapor</label><input type="text" class="form-input" id="repTarget" placeholder="Nama_IC / Mask 123456"></div>
          <div class="form-row"><label class="form-label">Jenis Pelanggaran</label><select class="form-input" id="repType"><option value="">Pilih...</option><option>DM (Deathmatch)</option><option>VDM (Vehicle Deathmatch)</option><option>Hack / Cheat</option><option>Bug Abuse</option><option>Bad RP</option><option>OOC Harassment</option><option>Scam / Penipuan</option><option>Lainnya</option></select></div>
          <div class="form-row"><label class="form-label">Tanggal & Waktu Kejadian</label><input type="datetime-local" class="form-input" id="repDate" style="max-width:230px"></div>
          <div class="form-row"><label class="form-label">Kronologi Kejadian</label><textarea class="form-input" id="repKronologi" rows="5" placeholder="Jelaskan kronologi secara detail..."></textarea></div>
          <div class="form-row"><label class="form-label">Link Bukti (Foto/Video)</label><input type="text" class="form-input" id="repBukti" placeholder="https://..."></div>
          <button class="btn btn-primary" onclick="submitReport()">Kirim Laporan</button>
        </div>
      </div>
      <div class="tab-panel" id="rp-list"><div class="card" id="reportList"><div style="text-align:center;padding:28px;color:var(--text3)">Memuat...</div></div></div>
    </div>
    <div class="side-col"><div class="widget"><div class="widget-title">Panduan Report</div><div class="widget-body" style="font-size:11.5px;color:var(--text2);line-height:1.9"><p>1. Sertakan bukti valid</p><p>2. Isi semua kolom</p><p>3. Jangan report hal remeh</p><p>4. Laporan palsu = sanksi</p><p>5. Tunggu respons staff</p></div></div></div>
  </div>
</div>

<!-- ANNOUNCEMENTS -->
<div class="page" id="page-announcements">
  <div class="page-layout">
    <div class="main-col">
      <div class="breadcrumb"><a href="#" onclick="showPage('forums')">Home</a><span class="sep">&#8250;</span><span>Pengumuman</span></div>
      <div id="announcementsList"></div>
    </div>
    <div class="side-col"><div class="widget"><div class="widget-title">Info</div><div class="widget-body" style="font-size:11.5px;color:var(--text2)">Pengumuman resmi dari tim Miracle RP.</div></div></div>
  </div>
</div>

<!-- RULES / GUIDES -->
<div class="page" id="page-rules">
  <div class="page-layout">
    <div class="main-col">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this,'rules-tab');loadGuides('rules')">Rules Server</button>
        <button class="tab-btn" onclick="switchTab(this,'guides-job');loadGuides('guide_job')">Guide Job</button>
        <button class="tab-btn" onclick="switchTab(this,'guides-good');loadGuides('guide_goodside')">Guide Goodside</button>
        <button class="tab-btn" onclick="switchTab(this,'guides-bad');loadGuides('guide_badside')">Guide Badside</button>
      </div>
      <div class="tab-panel active" id="rules-tab"><div id="rulesContent"><div style="text-align:center;padding:28px;color:var(--text3)">Memuat...</div></div></div>
      <div class="tab-panel" id="guides-job"><div id="guidesJobContent"><div style="text-align:center;padding:28px;color:var(--text3)">Memuat...</div></div></div>
      <div class="tab-panel" id="guides-good"><div id="guidesGoodContent"><div style="text-align:center;padding:28px;color:var(--text3)">Memuat...</div></div></div>
      <div class="tab-panel" id="guides-bad"><div id="guidesBadContent"><div style="text-align:center;padding:28px;color:var(--text3)">Memuat...</div></div></div>
    </div>
    <div class="side-col"><div class="widget"><div class="widget-title">Navigasi</div><div class="widget-body" style="padding:0 11px">
      <div class="stat-row"><a href="#" onclick="switchTab(document.querySelector('.tab-btn'),'rules-tab');loadGuides('rules')">Rules Server</a></div>
      <div class="stat-row"><a href="#">Guide Job</a></div>
      <div class="stat-row"><a href="#">Guide Goodside</a></div>
      <div class="stat-row"><a href="#">Guide Badside</a></div>
    </div></div></div>
  </div>
</div>

<!-- PROFILE -->
<div class="page" id="page-profile">
  <div style="max-width:820px">
    <div class="card" style="margin-bottom:10px;overflow:visible">
      <div class="profile-banner"></div>
      <div class="profile-head">
        <div class="profile-avatar-wrap">
          <div class="profile-avatar" id="profileAvatar">?</div>
          <div class="profile-edit-btn" onclick="document.getElementById('avatarInput').click()">&#9998;</div>
          <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="changeAvatar(event)">
        </div>
        <div style="flex:1">
          <div style="font-size:17px;font-weight:700;color:var(--accent)" id="profileName">&#8212;</div>
          <span id="profileRoleBadge" class="s-badge" style="margin-top:3px;display:inline-block">Member</span>
          <div style="display:flex;gap:16px;margin-top:7px">
            <div class="p-stat"><span class="v" id="profilePosts">0</span><span class="l">Posts</span></div>
            <div class="p-stat"><span class="v" id="profileJoined">&#8212;</span><span class="l">Join</span></div>
          </div>
        </div>
        <div style="margin-left:auto;align-self:flex-start;margin-top:38px">
          <button class="btn btn-danger btn-sm" onclick="logoutUser()" id="profileLogoutBtn" style="display:none">Logout</button>
        </div>
      </div>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(this,'prof-about')">Tentang</button>
      <button class="tab-btn" onclick="switchTab(this,'prof-posts');loadProfilePosts()">Postingan</button>
      <button class="tab-btn" onclick="switchTab(this,'prof-settings')">Pengaturan</button>
    </div>
    <div class="tab-panel active" id="prof-about">
      <div class="card" style="padding:13px">
        <div class="form-row"><div class="form-label">Username</div><div style="font-size:12px;color:var(--text2)" id="profileUsername">&#8212;</div></div>
        <div class="form-row"><div class="form-label">Email</div><div style="font-size:12px;color:var(--text2)" id="profileEmail">&#8212;</div></div>
        <div class="form-row"><div class="form-label">WL Status</div><div id="profileWLStatus">&#8212;</div></div>
        <div class="form-row" style="margin-bottom:0"><div class="form-label">Status Akun</div><div id="profileStatus">&#8212;</div></div>
      </div>
    </div>
    <div class="tab-panel" id="prof-posts"><div class="card" id="profilePostsList"><div style="text-align:center;padding:28px;color:var(--text3)">Memuat...</div></div></div>
    <div class="tab-panel" id="prof-settings">
      <div class="card" style="padding:16px;max-width:420px">
        <div class="form-row"><label class="form-label">Display Name</label><input type="text" class="form-input" id="settingsDisplayName" placeholder="Nama tampilan"></div>
        <button class="btn btn-primary" onclick="saveSettings()">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- PM -->
<div class="page" id="page-pm" style="padding:16px 0">
  <div class="chat-layout">
    <div class="chat-sidebar">
      <div class="chat-sidebar-header"><span>Pesan</span><button class="btn btn-primary btn-sm" onclick="openModal('newPmModal')">+ Baru</button></div>
      <div class="chat-search-bar"><input type="text" placeholder="Cari..." oninput="filterConvos(this.value)"></div>
      <div class="chat-list" id="pmConvoList"><div style="text-align:center;padding:18px;color:var(--text3);font-size:11px">Memuat...</div></div>
    </div>
    <div class="chat-main">
      <div class="chat-main-header" id="chatHeader" style="display:none">
        <div class="chat-ava" id="chatHeaderAvatar">?</div>
        <div><div id="chatHeaderName">&#8212;</div><div class="chat-header-status">&#9679; Online</div></div>
      </div>
      <div class="chat-messages" id="chatMessages"><div style="text-align:center;padding:36px;color:var(--text3);font-size:12px">Pilih percakapan atau mulai yang baru.</div></div>
      <div class="chat-input-area" id="chatInputArea" style="display:none">
        <div class="chat-input-wrap">
          <textarea class="chat-textarea" id="chatInput" placeholder="Tulis pesan..." rows="1" onkeydown="handleChatKey(event)" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,90)+'px'"></textarea>
        </div>
        <button class="chat-send-btn" onclick="sendMessage()">&#9658;</button>
      </div>
    </div>
  </div>
</div>
</div><!-- /wrap -->

<!-- ADMIN PAGE (full width, di luar .wrap) -->
<div class="page" id="page-admin">
  <div class="admin-layout">
    <div class="admin-sidebar" id="adminSidebar"></div>
    <div class="admin-content" id="adminContent">

      <div id="adm-overview" class="adm-tab active">
        <div class="admin-page-title">Dashboard</div>
        <div class="admin-page-sub">Statistik real-time Miracle RP Community</div>
        <div class="admin-cards">
          <div class="admin-card"><div class="ac-label">Total Member</div><div class="ac-val" id="admStatMembers">&#8212;</div></div>
          <div class="admin-card"><div class="ac-label">WL Pending</div><div class="ac-val" style="color:var(--red)" id="admStatWL">&#8212;</div></div>
          <div class="admin-card"><div class="ac-label">CS Pending</div><div class="ac-val" id="admStatCS">&#8212;</div></div>
          <div class="admin-card"><div class="ac-label">Import Pending</div><div class="ac-val" id="admStatImport">&#8212;</div></div>
          <div class="admin-card"><div class="ac-label">Report Open</div><div class="ac-val" style="color:var(--orange)" id="admStatReports">&#8212;</div></div>
          <div class="admin-card"><div class="ac-label">Banned</div><div class="ac-val" style="color:var(--red)" id="admStatBanned">&#8212;</div></div>
          <div class="admin-card"><div class="ac-label">WL Diterima</div><div class="ac-val" style="color:var(--green)" id="admStatAccepted">&#8212;</div></div>
          <div class="admin-card"><div class="ac-label">Staff Aktif</div><div class="ac-val" style="color:var(--blue)" id="admStatStaff">&#8212;</div></div>
        </div>
        <div style="font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:7px">Aktivitas Terbaru</div>
        <div class="table-wrap"><div class="log-stream" id="dashLogs" style="max-height:280px;border:none"></div></div>
      </div>

      <div id="adm-adminChat" class="adm-tab" style="display:none">
        <div class="admin-page-title">Admin Chat</div>
        <div class="admin-page-sub">Diskusi internal tim staff</div>
        <div class="admin-chat-wrap">
          <div class="admin-chat-msgs" id="adminChatMsgs"><div style="text-align:center;padding:16px;color:var(--text3);font-size:11px">Memuat...</div></div>
          <div class="admin-chat-input-row">
            <input id="adminChatInput" placeholder="Tulis ke tim admin..." onkeydown="if(event.key==='Enter')sendAdminChat()">
            <button class="btn-send" onclick="sendAdminChat()">Kirim</button>
          </div>
        </div>
      </div>

      <div id="adm-wlPending" class="adm-tab" style="display:none">
        <div class="admin-page-title">Pending Whitelist</div><div class="admin-page-sub">Review dan proses antrian WL</div>
        <div class="table-wrap">
          <div class="table-header"><div class="table-title">Antrian WL <span id="wlPendingLbl" style="color:var(--red);font-size:9.5px"></span></div><input class="table-search" placeholder="Cari..." oninput="filterTable('tblWLPending',this.value)"></div>
          <table id="tblWLPending"><thead><tr><th>Nama IC</th><th>WA</th><th>Fraksi</th><th>Tgl Daftar</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbodyWLPending"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table>
        </div>
      </div>

      <div id="adm-wlAll" class="adm-tab" style="display:none">
        <div class="admin-page-title">Semua Whitelist</div><div class="admin-page-sub">Riwayat semua pendaftaran</div>
        <div class="table-wrap">
          <div class="table-header"><div class="table-title">Riwayat WL</div><input class="table-search" placeholder="Cari..." oninput="filterTable('tblWLAll',this.value)"></div>
          <table id="tblWLAll"><thead><tr><th>Nama IC</th><th>Username</th><th>WA</th><th>Fraksi</th><th>Status</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody id="tbodyWLAll"><tr class="empty-row"><td colspan="7">Memuat...</td></tr></tbody></table>
        </div>
      </div>

      <div id="adm-csPending" class="adm-tab" style="display:none">
        <div class="admin-page-title">Pending CS Request</div><div class="admin-page-sub">Review character story request</div>
        <div class="table-wrap">
          <div class="table-header"><div class="table-title">Antrian CS <span id="csPendingLbl" style="color:var(--red);font-size:9.5px"></span></div><input class="table-search" placeholder="Cari..." oninput="filterTable('tblCSPending',this.value)"></div>
          <table id="tblCSPending"><thead><tr><th>Nama IC</th><th>Char Name</th><th>Level</th><th>WA</th><th>Jadwal</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbodyCSPending"><tr class="empty-row"><td colspan="7">Memuat...</td></tr></tbody></table>
        </div>
      </div>

      <div id="adm-csAll" class="adm-tab" style="display:none">
        <div class="admin-page-title">Semua CS Request</div>
        <div class="table-wrap">
          <div class="table-header"><div class="table-title">Riwayat CS</div><input class="table-search" placeholder="Cari..." oninput="filterTable('tblCSAll',this.value)"></div>
          <table id="tblCSAll"><thead><tr><th>Nama IC</th><th>Char Name</th><th>Level</th><th>Status</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody id="tbodyCSAll"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table>
        </div>
      </div>

      <div id="adm-importReq" class="adm-tab" style="display:none">
        <div class="admin-page-title">Import Requests</div><div class="admin-page-sub">Goodside / Badside / Family</div>
        <div class="table-wrap">
          <div class="table-header"><div class="table-title">Antrian Import <span id="importPendingLbl" style="color:var(--red);font-size:9.5px"></span></div><input class="table-search" placeholder="Cari..." oninput="filterTable('tblImport',this.value)"></div>
          <table id="tblImport"><thead><tr><th>Nama IC</th><th>Username</th><th>Tipe</th><th>Fraksi/Family</th><th>Level</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbodyImport"><tr class="empty-row"><td colspan="7">Memuat...</td></tr></tbody></table>
        </div>
      </div>

      <div id="adm-users" class="adm-tab" style="display:none">
        <div class="admin-page-title">Users & Role</div><div class="admin-page-sub">Kelola user, role, dan permission</div>
        <div class="table-wrap">
          <div class="table-header"><div class="table-title">Daftar User</div><input class="table-search" placeholder="Cari username / email..." oninput="filterTable('tblUsers',this.value)"></div>
          <table id="tblUsers"><thead><tr><th>Username</th><th>Email</th><th>Role</th><th>WL</th><th>Nama IC</th><th>Joined</th><th>Aksi</th></tr></thead><tbody id="tbodyUsers"><tr class="empty-row"><td colspan="7">Memuat...</td></tr></tbody></table>
        </div>
      </div>

      <div id="adm-banned" class="adm-tab" style="display:none">
        <div class="admin-page-title">Banned Users</div>
        <div class="table-wrap">
          <div class="table-header"><div class="table-title">Banned List</div></div>
          <table id="tblBanned"><thead><tr><th>Username</th><th>Email</th><th>Alasan</th><th>Oleh</th><th>Tgl Ban</th><th>Aksi</th></tr></thead><tbody id="tbodyBanned"><tr class="empty-row"><td colspan="6">Tidak ada.</td></tr></tbody></table>
        </div>
      </div>

      <div id="adm-reports" class="adm-tab" style="display:none">
        <div class="admin-page-title">Reports</div>
        <div class="table-wrap">
          <div class="table-header"><div class="table-title">Daftar Report</div><input class="table-search" placeholder="Cari..." oninput="filterTable('tblReports',this.value)"></div>
          <table id="tblReports"><thead><tr><th>Pelapor</th><th>Terlapor</th><th>Jenis</th><th>Status</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody id="tbodyReports"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table>
        </div>
      </div>

      <div id="adm-announce" class="adm-tab" style="display:none">
        <div class="admin-page-title">Kelola Pengumuman</div>
        <div style="display:grid;grid-template-columns:1fr 310px;gap:12px;align-items:start">
          <div class="table-wrap"><div class="table-header"><div class="table-title">Daftar Pengumuman</div></div><div id="annAdminList"></div></div>
          <div class="table-wrap"><div class="table-header"><div class="table-title">Buat Pengumuman</div></div>
          <div style="padding:12px">
            <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:8px" id="annTagSelect">
              <span class="role-chip sel" onclick="selAnnTag(this,'ANNOUNCEMENT')">ANNOUNCEMENT</span>
              <span class="role-chip" onclick="selAnnTag(this,'MAINTENANCE')">MAINTENANCE</span>
              <span class="role-chip" onclick="selAnnTag(this,'WARNING')">WARNING</span>
              <span class="role-chip" onclick="selAnnTag(this,'INFO')">INFO</span>
            </div>
            <div class="form-row"><label class="form-label">Judul</label><input type="text" class="form-input" id="annTitle" placeholder="Judul..."></div>
            <div class="form-row"><label class="form-label">Isi</label><textarea class="form-input" id="annBody" rows="4" placeholder="Isi pengumuman..."></textarea></div>
            <button class="btn btn-primary" style="width:100%" onclick="postAnnouncement()">Posting</button>
          </div></div>
        </div>
      </div>

      <div id="adm-guides" class="adm-tab" style="display:none">
        <div class="admin-page-title">Kelola Guides & Rules</div>
        <div style="display:grid;grid-template-columns:1fr 310px;gap:12px;align-items:start">
          <div class="table-wrap">
            <div class="table-header">
              <div class="table-title">Artikel</div>
              <select class="table-search" id="guideTypeFilter" onchange="loadAdminGuides()" style="width:150px">
                <option value="rules">Rules Server</option>
                <option value="guide_job">Guide Job</option>
                <option value="guide_goodside">Guide Goodside</option>
                <option value="guide_badside">Guide Badside</option>
              </select>
            </div>
            <div id="guideAdminList"></div>
          </div>
          <div class="table-wrap"><div class="table-header"><div class="table-title" id="guideFormTitle">Tambah Artikel</div></div>
          <div style="padding:12px">
            <div class="form-row"><label class="form-label">Judul</label><input type="text" class="form-input" id="guideTitle" placeholder="Judul..."></div>
            <div class="form-row"><label class="form-label">Tag</label><input type="text" class="form-input" id="guideTag" placeholder="WAJIB BACA, dll"></div>
            <div class="form-row"><label class="form-label">Konten</label><textarea class="form-input" id="guideBody" rows="5" placeholder="Isi artikel..."></textarea></div>
            <label style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text2);margin-bottom:8px;cursor:pointer"><input type="checkbox" id="guidePinned"> Pinned</label>
            <button class="btn btn-primary" style="width:100%" onclick="submitGuide()">Simpan</button>
            <button class="btn" id="btnCancelGuide" onclick="cancelGuideEdit()" style="display:none;width:100%;margin-top:4px">Batal</button>
          </div></div>
        </div>
      </div>

      <div id="adm-staff" class="adm-tab" style="display:none">
        <div class="admin-page-title">Kelola Staff List</div>
        <div style="display:grid;grid-template-columns:1fr 270px;gap:12px;align-items:start">
          <div class="table-wrap"><div class="table-header"><div class="table-title">Staff</div></div>
            <table><thead><tr><th>Nama</th><th>Role</th><th>Deskripsi</th><th>Aksi</th></tr></thead><tbody id="staffAdminTbody"><tr class="empty-row"><td colspan="4">Memuat...</td></tr></tbody></table>
          </div>
          <div class="table-wrap"><div class="table-header"><div class="table-title">Tambah Staff</div></div>
          <div style="padding:12px">
            <div class="form-row"><label class="form-label">Nama</label><input type="text" class="form-input" id="staffName" placeholder="Nama staff"></div>
            <div class="form-row"><label class="form-label">Role</label>
              <select class="form-input" id="staffRoleInput">
                <option value="owner">Owner</option><option value="developer">Developer</option>
                <option value="headadmin">Head Admin</option><option value="admin">Admin</option>
                <option value="senioradmin">Senior Admin</option><option value="junioradmin">Junior Admin</option>
                <option value="moderator">Moderator</option><option value="management">Management</option>
                <option value="communityhandle">Community Handle</option>
                <option value="seniorhelper">Senior Helper</option><option value="juniorhelper">Junior Helper</option>
                <option value="volunteer">Volunteer</option><option value="exstaff">Ex Staff</option>
              </select>
            </div>
            <div class="form-row"><label class="form-label">Deskripsi</label><input type="text" class="form-input" id="staffDesc" placeholder="Jabatan / departemen"></div>
            <button class="btn btn-primary" style="width:100%" onclick="addStaff()">Tambah</button>
          </div></div>
        </div>
      </div>

      <div id="adm-settings" class="adm-tab" style="display:none">
        <div class="admin-page-title">Pengaturan Sistem</div>
        <div class="admin-page-sub">Semua konfigurasi WL, CS, Import, dan server</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="settings-card">
            <div class="settings-card-title">Server Config</div>
            <div class="form-row"><label class="form-label">IP SA:MP</label><input type="text" class="form-input" id="cfgServerIP" placeholder="ip:port"></div>
            <div class="form-row"><label class="form-label">Nama Server</label><input type="text" class="form-input" id="cfgServerName" placeholder="Miracle RP"></div>
            <div class="form-row"><label class="form-label">Link Discord</label><input type="text" class="form-input" id="cfgDiscord" placeholder="discord.gg/..."></div>
            <div class="form-row"><label class="form-label">Nomor WA Admin</label><input type="text" class="form-input" id="cfgWA" placeholder="628xxxxxxxxxx"></div>
            <div class="form-row"><label class="form-label">Post Cooldown (menit)</label><input type="number" class="form-input" id="cfgCooldown" value="60" style="max-width:90px"></div>
            <button class="btn btn-primary" onclick="saveConfig()">Simpan</button>
          </div>
          <div class="settings-card">
            <div class="settings-card-title">Whitelist Settings</div>
            <div class="form-row"><label class="form-label">Status WL</label><select class="form-input" id="cfgWLOpen"><option value="1">Terbuka</option><option value="0">Ditutup</option></select></div>
            <div class="form-row"><label class="form-label">Syarat & Ketentuan WL (satu per baris)</label><textarea class="form-input" id="cfgWLRequirements" rows="5" placeholder="Min. 17 tahun&#10;WhatsApp aktif&#10;Mengerti dasar RP"></textarea></div>
            <button class="btn btn-primary" onclick="saveWLConfig()">Simpan WL</button>
          </div>
          <div class="settings-card">
            <div class="settings-card-title">CS Request Settings</div>
            <div class="form-row"><label class="form-label">Status CS</label><select class="form-input" id="cfgCSOpen"><option value="1">Terbuka</option><option value="0">Ditutup</option></select></div>
            <div class="form-row"><label class="form-label">Info CS untuk Pemohon</label><textarea class="form-input" id="cfgCSInfo" rows="2" placeholder="Jadwal review: Senin & Kamis 19:00-21:00"></textarea></div>
            <div class="form-row"><label class="form-label">Jadwal Review (pisah koma)</label><input type="text" class="form-input" id="cfgCSSchedules" placeholder="Senin 19:00,Senin 20:00,Kamis 19:00,Kamis 20:00"></div>
            <div class="form-row"><label class="form-label">Min. Kata Story</label><input type="number" class="form-input" id="cfgCSMinWords" value="150" style="max-width:90px"></div>
            <div class="form-row"><label class="form-label">Panduan CS (satu per baris)</label><textarea class="form-input" id="cfgCSPanduan" rows="4" placeholder="Min. 150 kata&#10;Karakter realistis&#10;Tidak overpowered"></textarea></div>
            <button class="btn btn-primary" onclick="saveCSConfig()">Simpan CS</button>
          </div>
          <div class="settings-card">
            <div class="settings-card-title">Import Request Settings</div>
            <div class="form-row"><label class="form-label">Status Import (master)</label><select class="form-input" id="cfgImportOpen"><option value="1">Terbuka</option><option value="0">Tutup Semua</option></select></div>
            <div class="form-row"><label class="form-label">Goodside</label><select class="form-input" id="cfgGoodsideOpen"><option value="1">Buka</option><option value="0">Tutup</option></select></div>
            <div class="form-row"><label class="form-label">Badside</label><select class="form-input" id="cfgBadsideOpen"><option value="1">Buka</option><option value="0">Tutup</option></select></div>
            <div class="form-row"><label class="form-label">Family</label><select class="form-input" id="cfgFamilyOpen"><option value="1">Buka</option><option value="0">Tutup</option></select></div>
            <div class="form-row"><label class="form-label">Info Import untuk Pemohon</label><textarea class="form-input" id="cfgImportInfo" rows="2" placeholder="Info singkat..."></textarea></div>
            <div class="form-row"><label class="form-label">Ketentuan Import (satu per baris)</label><textarea class="form-input" id="cfgImportRequirements" rows="4" placeholder="Harus ada lore IC&#10;Max 1 request/minggu"></textarea></div>
            <button class="btn btn-primary" onclick="saveImportConfig()">Simpan Import</button>
          </div>
        </div>
      </div>

      <div id="adm-logs" class="adm-tab" style="display:none">
        <div class="admin-page-title">System Logs</div><div class="admin-page-sub">Riwayat semua aktivitas sistem</div>
        <div class="table-wrap">
          <div class="table-header">
            <div class="table-title">Activity Log</div>
            <div style="display:flex;gap:5px">
              <select class="table-search" style="width:110px" onchange="filterLogs(this.value)">
                <option value="">Semua</option><option value="AUTH">AUTH</option><option value="WL">WL</option>
                <option value="CS">CS</option><option value="IMPORT">IMPORT</option>
                <option value="BAN">BAN</option><option value="ACCEPT">ACCEPT</option>
                <option value="DENY">DENY</option><option value="ROLE">ROLE</option>
                <option value="SYSTEM">SYSTEM</option><option value="CHAT">CHAT</option>
              </select>
              <button class="btn btn-danger btn-sm" id="btnClearLogs" onclick="clearLogs()" style="display:none">Clear</button>
            </div>
          </div>
          <div class="log-stream" id="logStream" style="max-height:520px;border:none"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="firebaseconfig.js"></script>
<script>
// ============================
// GLOBALS
// ============================
let currentUser = null;
let userProfile = null;
let activeConvoId = null;
let adminChatListener = null;
let pmListeners = {};
let selectedImportType = null;
let selectedCSSlot = null;
let selectedAnnTag = 'ANNOUNCEMENT';
let editingGuideId = null;
let roleModalTarget = null;
let banModalTarget = null;
let icModalTarget = null;
let allLogsCache = [];
let postImageBase64 = null;
const DB = firebase.firestore();
const STORAGE = firebase.storage ? firebase.storage() : null;

const ROLES_ORDER = ['owner','developer','headadmin','senioradmin','admin','junioradmin','management','moderator','communityhandle','seniorhelper','helper','juniorhelper','volunteer','exstaff','vip','user'];
const ADMIN_ROLES = ['owner','developer','headadmin','senioradmin','admin','junioradmin','management','moderator','communityhandle','seniorhelper','juniorhelper','volunteer'];
const ALL_PERMISSIONS = ['manage_wl','manage_cs','manage_import','manage_users','manage_announce','manage_guides','manage_staff','manage_settings','ban_user','clear_logs','manage_reports'];

function roleClass(r){ return 'r-'+(r||'user').replace(/[\s\/]/g,'').toLowerCase(); }
function roleName(r){ const names={owner:'Owner',developer:'Developer',headadmin:'Head Admin',senioradmin:'Senior Admin',admin:'Admin',junioradmin:'Junior Admin',management:'Management',moderator:'Moderator',communityhandle:'Community Handle',seniorhelper:'Senior Helper',helper:'Helper',juniorhelper:'Junior Helper',volunteer:'Volunteer',exstaff:'Ex Staff',vip:'VIP',user:'Member'}; return names[r]||'Member'; }
function fmtDate(ts){ if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}); }
function fmtDT(ts){ if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString('id-ID',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}); }
function timeAgo(ts){ if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts),now=new Date(),diff=Math.floor((now-d)/1000); if(diff<60) return diff+'d lalu'; if(diff<3600) return Math.floor(diff/60)+'m lalu'; if(diff<86400) return Math.floor(diff/3600)+'j lalu'; return Math.floor(diff/86400)+'h lalu'; }
function uid(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }
function escH(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function initials(n){ if(!n) return '?'; const parts=n.trim().split(/\s+/); return (parts[0][0]+(parts[1]?parts[1][0]:'')).toUpperCase(); }

// ============================
// TOAST
// ============================
function toast(msg,type='info',dur=3200){
  const el=document.createElement('div'); el.className='toast '+type;
  const icons={success:'',error:'',info:''};
  el.innerHTML='<span>'+icons[type]+'</span><span>'+escH(msg)+'</span>';
  document.getElementById('toastContainer').prepend(el);
  setTimeout(()=>el.remove(),dur);
}

// ============================
// MODAL
// ============================
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
document.addEventListener('keydown',e=>{ if(e.key==='Escape') document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open')); });

// ============================
// NAVIGATION
// ============================
function showPage(name, navEl){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const page = document.getElementById('page-'+name);
  if(page) page.classList.add('active');
  document.querySelectorAll('nav.main-nav a').forEach(a=>a.classList.remove('active'));
  if(navEl) navEl.classList.add('active');
  if(name==='feed') initFeed();
  if(name==='announcements') loadAnnouncements();
  if(name==='rules') loadGuides('rules');
  if(name==='pm') initPM();
  if(name==='leaderboard') loadLeaderboard();
  if(name==='staff') loadStaff();
  if(name==='admin') initAdmin();
  window.scrollTo(0,0);
}
function switchTab(btn, panelId){
  const parent = btn.closest('.tabs')||btn.parentElement;
  parent.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const container = parent.nextElementSibling?.parentElement||document;
  container.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  const panel = document.getElementById(panelId);
  if(panel) panel.classList.add('active');
}
function openMobileNav(){ document.getElementById('mobileNav').classList.add('open'); document.getElementById('mobileOverlay').classList.add('open'); }
function closeMobileNav(){ document.getElementById('mobileNav').classList.remove('open'); document.getElementById('mobileOverlay').classList.remove('open'); }

// ============================
// AUTH
// ============================
async function loginWithGoogle(){
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    await firebase.auth().signInWithPopup(provider);
    closeModal('loginModal'); toast('Login berhasil!','success');
  }catch(e){ toast('Login gagal: '+e.message,'error'); }
}
async function logoutUser(){
  await firebase.auth().signOut();
  currentUser=null; userProfile=null;
  toast('Logout berhasil.','info');
  showPage('forums');
}
firebase.auth().onAuthStateChanged(async u=>{
  currentUser=u;
  if(u){
    const ref=DB.collection('users').doc(u.uid);
    const snap=await ref.get();
    if(!snap.exists){
      await ref.set({ uid:u.uid, email:u.email, displayName:u.displayName||u.email.split('@')[0], photoURL:u.photoURL||'', role:'user', permissions:[], wlStatus:'none', icName:'', banned:false, postCount:0, createdAt:firebase.firestore.FieldValue.serverTimestamp() });
      await addLog('AUTH','Akun baru: '+u.email);
    }
    userProfile=( await ref.get() ).data();
    renderTopbarAuth();
    renderPmDot();
    if(userProfile.banned){ await firebase.auth().signOut(); toast('Akun kamu dibanned.','error'); return; }
  } else {
    renderTopbarAuth();
  }
  loadHomeStats();
  loadConfig();
});

function renderTopbarAuth(){
  const el=document.getElementById('topbarRight');
  if(!currentUser){ el.innerHTML='<button class="btn" onclick="openModal(\'loginModal\')">Masuk</button><button class="btn btn-primary" onclick="openModal(\'loginModal\')">Daftar</button>'; document.getElementById('adminNavLink').style.display='none'; document.getElementById('mobileAdminLink').style.display='none'; return; }
  const p=userProfile||{};
  const isAdmin=ADMIN_ROLES.includes(p.role);
  if(isAdmin){ document.getElementById('adminNavLink').style.display=''; document.getElementById('mobileAdminLink').style.display=''; }
  const ava = p.photoURL ? `<img src="${p.photoURL}" style="width:28px;height:28px;border-radius:50%;object-fit:cover">` : `<div style="width:28px;height:28px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:1px solid var(--border)">${initials(p.displayName)}</div>`;
  el.innerHTML=`<div style="display:flex;align-items:center;gap:7px;cursor:pointer" onclick="showPage('profile')">${ava}<span style="font-size:11.5px;color:var(--text);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escH(p.displayName||'')}</span><span class="${roleClass(p.role)}" style="font-size:9.5px">[${roleName(p.role)}]</span></div>`;
}

// ============================
// CONFIG (ADMIN CONFIGURABLE)
// ============================
let appConfig = {
  serverIP:'127.0.0.1:7777', serverName:'Miracle RP', discord:'discord.gg/miracle', waContact:'628000000000', postCooldownMin:60,
  wlOpen:true, wlRequirements:'Min. 17 tahun\nWhatsApp aktif\nMengerti dasar RP',
  csOpen:true, csInfo:'Jadwal review setiap Senin & Kamis 19:00-21:00', csSchedules:'Senin 19:00,Senin 20:00,Kamis 19:00,Kamis 20:00', csMinWords:150, csPanduan:'Min. 150 kata\nKarakter realistis\nTidak overpowered\nLore masuk akal',
  importOpen:true, goodsideOpen:true, badsideOpen:true, familyOpen:true, importInfo:'Request dibuka setiap minggu', importRequirements:'Harus ada lore IC\nMax 1 request/minggu\nLevel min. 10'
};
async function loadConfig(){
  try{
    const snap=await DB.collection('config').doc('main').get();
    if(snap.exists) appConfig={...appConfig,...snap.data()};
  }catch(e){}
  applyConfig();
}
function applyConfig(){
  const c=appConfig;
  const ipEl=document.getElementById('srvIP'); if(ipEl) ipEl.textContent=c.serverIP;
  const dcEl=document.getElementById('srvDC'); if(dcEl) dcEl.textContent=c.discord;
  const feedIP=document.getElementById('feedSrvIP'); if(feedIP) feedIP.textContent=c.serverIP;
  const waInfo=document.getElementById('staffWAInfo'); if(waInfo) waInfo.textContent=' '+c.waContact;
  // WL
  const wlClosed=document.getElementById('wlClosedBox'); if(wlClosed) wlClosed.style.display=c.wlOpen?'none':'';
  const wlOpen=document.getElementById('wlOpenContent'); if(wlOpen) wlOpen.style.display=c.wlOpen?'':'none';
  const wlReqWidget=document.getElementById('wlReqWidget'); if(wlReqWidget){ wlReqWidget.innerHTML=c.wlRequirements.split('\n').filter(Boolean).map(r=>`<p> ${escH(r)}</p>`).join(''); }
  const wlReqBox=document.getElementById('wlReqBox'); if(wlReqBox && c.wlRequirements){ wlReqBox.style.display=''; wlReqBox.innerHTML=c.wlRequirements.split('\n').filter(Boolean).map(r=>` ${escH(r)}`).join(' &nbsp;|&nbsp; '); }
  // CS
  const csClosed=document.getElementById('csClosedBox'); if(csClosed) csClosed.style.display=c.csOpen?'none':'';
  const csOpen=document.getElementById('csOpenContent'); if(csOpen) csOpen.style.display=c.csOpen?'':'none';
  const csInfo=document.getElementById('csInfoBox'); if(csInfo) csInfo.textContent=c.csInfo;
  const csMinWord=document.getElementById('csMinWordLabel'); if(csMinWord) csMinWord.textContent='(min. '+c.csMinWords+' kata)';
  const csPanduan=document.getElementById('csPanduanWidget'); if(csPanduan) csPanduan.innerHTML=c.csPanduan.split('\n').filter(Boolean).map(r=>`<p> ${escH(r)}</p>`).join('');
  const timeSlots=document.getElementById('csTimeSlots');
  if(timeSlots){ const slots=c.csSchedules.split(',').map(s=>s.trim()).filter(Boolean); timeSlots.innerHTML=slots.map(s=>`<div class="time-slot" onclick="selectCSSlot(this,'${escH(s)}')">${escH(s)}</div>`).join(''); }
  // Import
  const impClosed=document.getElementById('importClosedBox'); if(impClosed) impClosed.style.display=c.importOpen?'none':'';
  const impOpen=document.getElementById('importOpenContent'); if(impOpen) impOpen.style.display=c.importOpen?'':'none';
  const impInfo=document.getElementById('importInfoBox'); if(impInfo) impInfo.textContent=c.importInfo;
  const impReq=document.getElementById('importReqWidget'); if(impReq) impReq.innerHTML=c.importRequirements.split('\n').filter(Boolean).map(r=>`<p> ${escH(r)}</p>`).join('');
  // Import type btns
  ['goodside','badside','family'].forEach(t=>{
    const btn=document.getElementById('impType'+t.charAt(0).toUpperCase()+t.slice(1));
    if(btn){ const isOpen=c[t+'Open']&&c.importOpen; btn.style.opacity=isOpen?'1':'.35'; btn.style.pointerEvents=isOpen?'':'none'; }
  });
}

// ============================
// HOME STATS
// ============================
async function loadHomeStats(){
  try{
    const [members,wlPending,wlAccepted,csP,importP,reports,ann] = await Promise.all([
      DB.collection('users').get(),
      DB.collection('whitelist').where('status','==','pending').get(),
      DB.collection('whitelist').where('status','==','accepted').get(),
      DB.collection('cs_requests').where('status','==','pending').get(),
      DB.collection('import_requests').where('status','==','pending').get(),
      DB.collection('reports').where('status','==','open').get(),
      DB.collection('announcements').get()
    ]);
    const setT=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
    setT('statPosts',0); setT('statWL',wlPending.size); setT('statCS',csP.size); setT('statImport',importP.size); setT('statReports',reports.size); setT('statAnnouncements',ann.size);
    setT('totalMembers',members.size); setT('wlAcceptedStat',wlAccepted.size); setT('wlPendingStat',wlPending.size);
    setT('onlineCount',members.size); setT('onlineSub',appConfig.serverName);
    setT('wlStatPending',wlPending.size); setT('wlStatProcess',0); setT('wlStatAccepted',wlAccepted.size);
    // online tags
    const ot=document.getElementById('onlineTags');
    if(ot){ const tags=['Member','VIP','Staff']; ot.innerHTML=tags.map(t=>`<div class="online-tag"><div class="dot"></div>${t}</div>`).join(''); }
    // feed post count
    const posts=await DB.collection('posts').orderBy('createdAt','desc').limit(1).get();
    setT('statPosts',posts.size*10||0);
  }catch(e){}
}

// ============================
// FEED
// ============================
let feedInitialized=false;
function initFeed(){
  if(!feedInitialized){ feedInitialized=true; }
  if(currentUser && userProfile){ const comp=document.getElementById('feedComposer'); if(comp) comp.style.display=''; const ava=document.getElementById('composerAvatar'); if(ava){ if(userProfile.photoURL) ava.innerHTML=`<img src="${userProfile.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`; else ava.textContent=initials(userProfile.displayName); } }
  loadFeed();
  loadFeedAnnouncements();
}
async function loadFeedAnnouncements(){
  const el=document.getElementById('feedAnnouncements'); if(!el) return;
  try{
    const snap=await DB.collection('announcements').orderBy('createdAt','desc').limit(2).get();
    el.innerHTML=snap.docs.map(d=>{ const a=d.data(); return `<div class="feed-ann-card"><div class="ann-title"> ${escH(a.title||'')}</div><div class="ann-body">${escH((a.body||'').substring(0,160)+(a.body&&a.body.length>160?'...':''))}</div><div class="ann-meta">${fmtDate(a.createdAt)} &bull; ${escH(a.authorName||'Admin')}</div></div>`; }).join('');
    // topbar announce
    if(snap.docs.length>0){ const first=snap.docs[0].data(); const el2=document.getElementById('topAnnounce'); if(el2) el2.innerHTML=`<span></span><span><strong>${escH(first.tag||'INFO')}</strong>  ${escH((first.title||'').substring(0,60))}</span>`; }
  }catch(e){}
}
async function loadFeed(){
  const list=document.getElementById('feedList'); const empty=document.getElementById('feedEmpty'); if(!list) return;
  list.innerHTML='<div style="text-align:center;padding:24px;color:var(--text3)">Memuat...</div>';
  try{
    const snap=await DB.collection('posts').orderBy('createdAt','desc').limit(30).get();
    if(snap.empty){ list.innerHTML=''; if(empty) empty.style.display=''; return; }
    list.innerHTML=snap.docs.map(d=>renderPostCard(d.id,d.data())).join('');
  }catch(e){ list.innerHTML='<div style="text-align:center;padding:24px;color:var(--text3)">Error memuat feed.</div>'; }
}
function renderPostCard(id,p){
  const ava = p.photoURL ? `<img src="${p.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : initials(p.authorName||'?');
  const img = p.imageURL ? `<img class="post-image" src="${p.imageURL}" loading="lazy" onclick="openModal('imageModal');document.getElementById('imageModalSrc').src=this.src" onerror="this.style.display='none'">` : '';
  const likes=p.likes||0; const liked=(p.likedBy||[]).includes(currentUser?.uid);
  return `<div class="post-card" id="post-${id}">
    <div class="post-header">
      <div class="post-avatar">${ava}</div>
      <div style="flex:1;min-width:0"><div style="font-size:12.5px;font-weight:600">${escH(p.authorName||'?')}</div><div style="font-size:9.5px;color:var(--text3)">${timeAgo(p.createdAt)}</div></div>
      ${currentUser&&(p.authorUid===currentUser.uid||(userProfile&&ADMIN_ROLES.includes(userProfile.role)))?`<button class="btn btn-danger btn-sm" onclick="deletePost('${id}')">Hapus</button>`:''}
    </div>
    ${p.body?`<div class="post-body">${escH(p.body).replace(/\n/g,'<br>')}</div>`:''}
    ${img}
    <div class="post-actions">
      <button class="reaction-btn ${liked?'active':''}" onclick="likePost('${id}',this)"> ${likes}</button>
      <button class="reaction-btn" onclick="toggleComments('${id}')"> Komentar</button>
    </div>
    <div class="post-comments" id="comments-${id}" style="display:none">
      <div id="commentsList-${id}" style="margin-bottom:7px"></div>
      ${currentUser?`<div style="display:flex;gap:6px"><div class="comment-ava">${initials(userProfile?.displayName||'?')}</div><input class="comment-input" placeholder="Tambah komentar..." onkeydown="if(event.key==='Enter')addComment('${id}',this)"></div>`:''}
    </div>
  </div>`;
}
async function submitPost(){
  if(!currentUser){ toast('Login dulu!','error'); return; }
  // cooldown check
  const lastPost=await DB.collection('posts').where('authorUid','==',currentUser.uid).orderBy('createdAt','desc').limit(1).get();
  if(!lastPost.empty){ const diff=(new Date()-lastPost.docs[0].data().createdAt.toDate())/60000; const cooldown=appConfig.postCooldownMin||60; if(diff<cooldown){ toast(`Cooldown: tunggu ${Math.ceil(cooldown-diff)} menit lagi.`,'error'); return; } }
  const body=document.getElementById('composerText').value.trim();
  if(!body && !postImageBase64){ toast('Tulis sesuatu dulu!','error'); return; }
  try{
    const data={ authorUid:currentUser.uid, authorName:userProfile?.displayName||'', photoURL:userProfile?.photoURL||'', body, createdAt:firebase.firestore.FieldValue.serverTimestamp(), likes:0, likedBy:[], commentCount:0 };
    if(postImageBase64) data.imageURL=postImageBase64;
    await DB.collection('posts').add(data);
    await DB.collection('users').doc(currentUser.uid).update({ postCount:firebase.firestore.FieldValue.increment(1) });
    document.getElementById('composerText').value=''; clearPostImage();
    toast('Post berhasil!','success'); loadFeed();
  }catch(e){ toast('Gagal post: '+e.message,'error'); }
}
async function deletePost(id){
  if(!confirm('Hapus post ini?')) return;
  try{ await DB.collection('posts').doc(id).delete(); toast('Post dihapus.','info'); loadFeed(); }catch(e){ toast('Gagal hapus.','error'); }
}
async function likePost(id,btn){
  if(!currentUser){ toast('Login dulu!','error'); return; }
  const ref=DB.collection('posts').doc(id); const snap=await ref.get(); if(!snap.exists) return;
  const data=snap.data(); const liked=(data.likedBy||[]).includes(currentUser.uid);
  await ref.update({ likes:firebase.firestore.FieldValue.increment(liked?-1:1), likedBy:liked?firebase.firestore.FieldValue.arrayRemove(currentUser.uid):firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
  btn.classList.toggle('active',!liked); btn.innerHTML=' '+(data.likes+(liked?-1:1));
}
async function toggleComments(id){
  const el=document.getElementById('comments-'+id); if(!el) return;
  const isOpen=el.style.display!=='none'; el.style.display=isOpen?'none':'';
  if(!isOpen){ const listEl=document.getElementById('commentsList-'+id); if(listEl){ const snap=await DB.collection('posts').doc(id).collection('comments').orderBy('createdAt').get(); listEl.innerHTML=snap.docs.map(d=>{ const c=d.data(); return `<div class="comment-item"><div class="comment-ava">${initials(c.authorName||'?')}</div><div class="comment-body"><div class="comment-author">${escH(c.authorName||'?')}</div><div class="comment-text">${escH(c.body||'')}</div></div></div>`; }).join(''); } }
}
async function addComment(postId,input){
  if(!currentUser||!input.value.trim()) return;
  await DB.collection('posts').doc(postId).collection('comments').add({ authorUid:currentUser.uid, authorName:userProfile?.displayName||'', body:input.value.trim(), createdAt:firebase.firestore.FieldValue.serverTimestamp() });
  input.value=''; toggleComments(postId); toggleComments(postId);
}
function handlePostImage(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ postImageBase64=ev.target.result; const prev=document.getElementById('postImagePreview'); const img=document.getElementById('postImgPreviewImg'); if(prev&&img){ img.src=ev.target.result; prev.style.display=''; } }; r.readAsDataURL(f); }
function clearPostImage(){ postImageBase64=null; const prev=document.getElementById('postImagePreview'); if(prev) prev.style.display='none'; }

// ============================
// WHITELIST
// ============================
let wlCurrentPage=1;
async function checkMyWL(){
  if(!currentUser){ document.getElementById('wlStatusView').style.display='none'; document.getElementById('wlFormView').style.display=''; return; }
  const snap=await DB.collection('whitelist').where('uid','==',currentUser.uid).orderBy('createdAt','desc').limit(1).get();
  if(!snap.empty){
    const d=snap.docs[0].data(); const statusView=document.getElementById('wlStatusView'); const formView=document.getElementById('wlFormView');
    statusView.style.display=''; formView.style.display='none';
    const statusHTML={'pending':'<span class="s-badge s-pending">PENDING</span>','process':'<span class="s-badge s-process">DIPROSES</span>','accepted':'<span class="s-badge s-accepted">DITERIMA </span>','rejected':'<span class="s-badge s-rejected">DITOLAK</span>'};
    statusView.innerHTML=`<div class="card" style="padding:16px">
      <div style="font-size:12.5px;font-weight:700;margin-bottom:10px">Status Whitelist Kamu</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">${statusHTML[d.status]||d.status}<span style="font-size:10.5px;color:var(--text3)">${fmtDate(d.createdAt)}</span></div>
      <div class="detail-row"><div class="detail-key">Nama IC</div><div class="detail-val">${escH(d.icName||'')}</div></div>
      <div class="detail-row"><div class="detail-key">Nama Lengkap</div><div class="detail-val">${escH(d.namaLengkap||'')}</div></div>
      <div class="detail-row"><div class="detail-key">Fraksi Diminati</div><div class="detail-val">${escH(d.fraksi||'')}</div></div>
      ${d.adminNote?`<div class="info-box" style="margin-top:10px"><strong>Catatan Admin:</strong> ${escH(d.adminNote)}</div>`:''}
      ${d.status==='rejected'?`<button class="btn btn-primary" style="margin-top:12px" onclick="document.getElementById('wlStatusView').style.display='none';document.getElementById('wlFormView').style.display=''">Daftar Ulang</button>`:''}
    </div>`;
  } else { document.getElementById('wlStatusView').style.display='none'; document.getElementById('wlFormView').style.display=''; }
}
function wlNext(page){
  if(page===1){
    const nama=document.getElementById('wlNama').value.trim(), kar=document.getElementById('wlKarakter').value.trim(), umur=document.getElementById('wlUmur').value, wa=document.getElementById('wlWA').value.trim(), exp=document.getElementById('wlExp').value;
    if(!nama||!kar||!umur||!wa||!exp){ toast('Isi semua field!','error'); return; }
    if(!currentUser){ openModal('loginModal'); return; }
    document.getElementById('wlPage1').style.display='none'; document.getElementById('wlPage2').style.display='';
    document.getElementById('wlStep1').classList.remove('active'); document.getElementById('wlStep1').classList.add('done');
    document.getElementById('wlStep2').classList.add('active');
  } else if(page===2){
    const q1=document.getElementById('wlQ1').value.trim(), q2=document.getElementById('wlQ2').value.trim(), q3=document.getElementById('wlQ3').value.trim(), reason=document.getElementById('wlReason').value.trim();
    if(!q1||!q2||!q3||!reason){ toast('Isi semua pertanyaan!','error'); return; }
    document.getElementById('wlWADisplay').textContent=document.getElementById('wlWA').value;
    document.getElementById('wlPage2').style.display='none'; document.getElementById('wlPage3').style.display='';
    document.getElementById('wlStep2').classList.remove('active'); document.getElementById('wlStep2').classList.add('done');
    document.getElementById('wlStep3').classList.add('active');
  }
}
function wlBack(page){
  if(page===2){ document.getElementById('wlPage2').style.display='none'; document.getElementById('wlPage1').style.display=''; document.getElementById('wlStep2').classList.remove('active'); document.getElementById('wlStep1').classList.remove('done'); document.getElementById('wlStep1').classList.add('active'); }
  else if(page===3){ document.getElementById('wlPage3').style.display='none'; document.getElementById('wlPage2').style.display=''; document.getElementById('wlStep3').classList.remove('active'); document.getElementById('wlStep2').classList.remove('done'); document.getElementById('wlStep2').classList.add('active'); }
}
async function wlSubmit(){
  const otp=document.getElementById('wlOTP').value.trim();
  if(otp!=='123456'){ toast('Kode OTP salah!','error'); return; }
  if(!currentUser){ toast('Login dulu!','error'); return; }
  try{
    await DB.collection('whitelist').add({ uid:currentUser.uid, email:currentUser.email, namaLengkap:document.getElementById('wlNama').value.trim(), icName:document.getElementById('wlKarakter').value.trim(), umur:document.getElementById('wlUmur').value, wa:document.getElementById('wlWA').value.trim(), experience:document.getElementById('wlExp').value, fraksi:document.getElementById('wlFaction').value.trim(), q1:document.getElementById('wlQ1').value.trim(), q2:document.getElementById('wlQ2').value.trim(), q3:document.getElementById('wlQ3').value.trim(), reason:document.getElementById('wlReason').value.trim(), status:'pending', createdAt:firebase.firestore.FieldValue.serverTimestamp() });
    await addLog('WL','WL baru: '+document.getElementById('wlKarakter').value.trim()+' ('+currentUser.email+')');
    document.getElementById('wlPage3').style.display='none'; document.getElementById('wlPage4').style.display='';
    document.getElementById('wlStep3').classList.remove('active'); document.getElementById('wlStep3').classList.add('done');
    document.getElementById('wlStep4').classList.add('active');
    toast('Pendaftaran berhasil!','success');
  }catch(e){ toast('Gagal: '+e.message,'error'); }
}

// ============================
// CS
// ============================
function selectCSSlot(el,val){ document.querySelectorAll('.time-slot').forEach(s=>s.classList.remove('selected')); el.classList.add('selected'); selectedCSSlot=val; }
async function checkMyCS(){
  if(!currentUser) return;
  const snap=await DB.collection('cs_requests').where('uid','==',currentUser.uid).orderBy('createdAt','desc').limit(1).get();
  if(!snap.empty){
    const d=snap.docs[0].data(); if(d.status==='pending'||d.status==='process'){
      document.getElementById('csMyRequest').style.display=''; document.getElementById('csFormView').style.display='none';
      document.getElementById('csMyRequest').innerHTML=`<div class="card" style="padding:14px;margin-bottom:10px"><div style="font-size:12.5px;font-weight:700;margin-bottom:8px">CS Request Aktif</div><div class="detail-row"><div class="detail-key">Char Name</div><div class="detail-val">${escH(d.charName||'')}</div></div><div class="detail-row"><div class="detail-key">Jadwal</div><div class="detail-val">${escH(d.schedule||'')}</div></div><div class="detail-row"><div class="detail-key">Status</div><div class="detail-val"><span class="s-badge s-${d.status}">${d.status.toUpperCase()}</span></div></div></div>`;
    }
  }
}
async function submitCS(){
  if(!currentUser){ openModal('loginModal'); return; }
  const icName=document.getElementById('csIcName').value.trim(), charName=document.getElementById('csCharName').value.trim(), age=document.getElementById('csAge').value, level=document.getElementById('csLevel').value, screenshot=document.getElementById('csScreenshot').value.trim(), story=document.getElementById('csStory').value.trim();
  if(!icName||!charName||!age||!level||!story||!selectedCSSlot){ toast('Isi semua field!','error'); return; }
  const words=story.trim().split(/\s+/).length;
  if(words<(appConfig.csMinWords||150)){ toast(`Story min. ${appConfig.csMinWords||150} kata! (${words} kata sekarang)`,'error'); return; }
  try{
    await DB.collection('cs_requests').add({ uid:currentUser.uid, email:currentUser.email, icName, charName, age, level, screenshot, story, schedule:selectedCSSlot, status:'pending', createdAt:firebase.firestore.FieldValue.serverTimestamp() });
    await addLog('CS','CS baru: '+charName+' ('+currentUser.email+')');
    toast('CS Request terkirim!','success');
    document.getElementById('csFormView').style.display='none';
    document.getElementById('csMyRequest').style.display=''; document.getElementById('csMyRequest').innerHTML='<div class="card" style="padding:14px"><div style="color:var(--green);font-weight:700"> CS Request berhasil dikirim!</div></div>';
  }catch(e){ toast('Gagal: '+e.message,'error'); }
}

// ============================
// IMPORT
// ============================
function selectImportType(el,type){ document.querySelectorAll('.import-type-btn').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); selectedImportType=type; }
async function submitImport(){
  if(!currentUser){ openModal('loginModal'); return; }
  if(!selectedImportType){ toast('Pilih jenis import!','error'); return; }
  const icName=document.getElementById('importIcName').value.trim(), faction=document.getElementById('importFaction').value.trim(), level=document.getElementById('importLevel').value, lore=document.getElementById('importLore').value.trim(), proof=document.getElementById('importProof').value.trim();
  if(!icName||!faction||!level||!lore){ toast('Isi semua field!','error'); return; }
  try{
    await DB.collection('import_requests').add({ uid:currentUser.uid, email:currentUser.email, icName, faction, level, lore, proof, type:selectedImportType, status:'pending', createdAt:firebase.firestore.FieldValue.serverTimestamp() });
    await addLog('IMPORT','Import request: '+icName+' ('+selectedImportType+')');
    toast('Import request terkirim!','success');
    document.getElementById('importFormView').style.display='none'; document.getElementById('importMyRequest').style.display=''; document.getElementById('importMyRequest').innerHTML='<div class="card" style="padding:14px"><div style="color:var(--green);font-weight:700"> Import request berhasil dikirim!</div></div>';
  }catch(e){ toast('Gagal: '+e.message,'error'); }
}

// ============================
// STAFF
// ============================
async function loadStaff(){
  const grids={ all:'staffGridAll', owner:'staffGridOwner', admin:'staffGridAdmin', dev:'staffGridDev', helper:'staffGridHelper' };
  Object.values(grids).forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML='<div style="color:var(--text3);font-size:11px;padding:10px">Memuat...</div>'; });
  try{
    const snap=await DB.collection('staff_list').orderBy('order').get();
    const staffs=snap.docs.map(d=>({...d.data(),id:d.id}));
    function renderStaffCard(s){ const initL=initials(s.name||'?'); const roleMap={owner:'r-owner',developer:'r-developer',headadmin:'r-headadmin',senioradmin:'r-headadmin',admin:'r-admin',junioradmin:'r-admin',management:'r-management',moderator:'r-moderator',communityhandle:'r-helper',seniorhelper:'r-helper',juniorhelper:'r-helper',volunteer:'r-helper',exstaff:'r-exstaff'}; return `<div class="staff-card"><div class="staff-avatar">${initL}</div><div class="staff-name">${escH(s.name||'')}</div><div class="staff-role ${roleMap[s.role]||'r-user'}">${roleName(s.role)}</div>${s.desc?`<div style="font-size:9.5px;color:var(--text3);margin-top:4px">${escH(s.desc)}</div>`:''}</div>`; }
    const catAll=document.getElementById('staffGridAll'); if(catAll) catAll.innerHTML=staffs.map(renderStaffCard).join('')||'<p style="color:var(--text3);font-size:11px">Tidak ada staff.</p>';
    const owners=['owner']; const admins=['headadmin','senioradmin','admin','junioradmin','management','moderator','communityhandle']; const devs=['developer']; const helpers=['seniorhelper','helper','juniorhelper','volunteer'];
    const catOwner=document.getElementById('staffGridOwner'); if(catOwner) catOwner.innerHTML=staffs.filter(s=>owners.includes(s.role)).map(renderStaffCard).join('');
    const catAdmin=document.getElementById('staffGridAdmin'); if(catAdmin) catAdmin.innerHTML=staffs.filter(s=>admins.includes(s.role)).map(renderStaffCard).join('');
    const catDev=document.getElementById('staffGridDev'); if(catDev) catDev.innerHTML=staffs.filter(s=>devs.includes(s.role)).map(renderStaffCard).join('');
    const catHelper=document.getElementById('staffGridHelper'); if(catHelper) catHelper.innerHTML=staffs.filter(s=>helpers.includes(s.role)).map(renderStaffCard).join('');
  }catch(e){ const el=document.getElementById('staffGridAll'); if(el) el.innerHTML='<p style="color:var(--text3)">Error.</p>'; }
}

// ============================
// LEADERBOARD
// ============================
async function loadLeaderboard(){
  try{
    const [posts,wls]=await Promise.all([ DB.collection('users').orderBy('postCount','desc').limit(10).get(), DB.collection('whitelist').where('status','==','accepted').orderBy('createdAt','desc').limit(10).get() ]);
    const rankColors={0:'top1',1:'top2',2:'top3'};
    const lbPosts=document.getElementById('lbPostsList');
    if(lbPosts) lbPosts.innerHTML=posts.docs.map((d,i)=>{ const u=d.data(); return `<div class="lb-row"><div class="lb-rank ${rankColors[i]||''}">${i+1}</div><div class="lb-avatar">${initials(u.displayName||'?')}</div><div class="lb-info"><div class="lb-name">${escH(u.displayName||'')}</div><div class="lb-sub ${roleClass(u.role)}">${roleName(u.role)}</div></div><div class="lb-val">${u.postCount||0}</div></div>`; }).join('');
    const lbWL=document.getElementById('lbWLList');
    if(lbWL) lbWL.innerHTML=wls.docs.map((d,i)=>{ const w=d.data(); return `<div class="lb-row"><div class="lb-rank ${rankColors[i]||''}">${i+1}</div><div class="lb-avatar">${initials(w.icName||'?')}</div><div class="lb-info"><div class="lb-name">${escH(w.icName||'')}</div><div class="lb-sub">${fmtDate(w.createdAt)}</div></div><div class="lb-val"></div></div>`; }).join('');
  }catch(e){}
}

// ============================
// ANNOUNCEMENTS
// ============================
async function loadAnnouncements(){
  const el=document.getElementById('announcementsList'); if(!el) return;
  el.innerHTML='<div style="text-align:center;padding:24px;color:var(--text3)">Memuat...</div>';
  try{
    const snap=await DB.collection('announcements').orderBy('createdAt','desc').get();
    if(snap.empty){ el.innerHTML='<div style="text-align:center;padding:28px;color:var(--text3)">Belum ada pengumuman.</div>'; return; }
    const tagColors={ANNOUNCEMENT:'var(--red)',MAINTENANCE:'var(--orange)',WARNING:'var(--orange)',INFO:'var(--blue)'};
    el.innerHTML=snap.docs.map(d=>{ const a=d.data(); return `<div class="card" style="padding:16px;margin-bottom:8px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:9.5px;font-weight:700;letter-spacing:1px;padding:2px 7px;border-radius:2px;background:${tagColors[a.tag]||'var(--blue)'}22;color:${tagColors[a.tag]||'var(--blue)'};">${escH(a.tag||'INFO')}</span><span style="font-size:10.5px;color:var(--text3)">${fmtDT(a.createdAt)}</span><span style="font-size:10.5px;color:var(--text3)"></span><span style="font-size:10.5px;color:var(--text3)">${escH(a.authorName||'Admin')}</span></div><div style="font-size:13px;font-weight:700;margin-bottom:8px">${escH(a.title||'')}</div><div style="font-size:12px;color:var(--text2);line-height:1.65;white-space:pre-wrap">${escH(a.body||'')}</div></div>`; }).join('');
  }catch(e){ el.innerHTML='<div style="color:var(--text3);padding:16px">Error.</div>'; }
}

// ============================
// GUIDES & RULES
// ============================
const guidesCache={};
async function loadGuides(type){
  const contentIds={rules:'rulesContent',guide_job:'guidesJobContent',guide_goodside:'guidesGoodContent',guide_badside:'guidesBadContent'};
  const el=document.getElementById(contentIds[type]); if(!el) return;
  if(guidesCache[type]){ el.innerHTML=guidesCache[type]; return; }
  el.innerHTML='<div style="text-align:center;padding:24px;color:var(--text3)">Memuat...</div>';
  try{
    const snap=await DB.collection('guides').where('type','==',type).orderBy('pinned','desc').orderBy('createdAt','asc').get();
    if(snap.empty){ el.innerHTML='<div style="text-align:center;padding:28px;color:var(--text3)">Belum ada konten.</div>'; return; }
    guidesCache[type]=snap.docs.map(d=>{ const g=d.data(); return `<div class="card" style="padding:16px;margin-bottom:8px">${g.pinned?'<span style="font-size:9px;color:var(--gold);font-weight:700;letter-spacing:1px;margin-bottom:5px;display:inline-block"> PINNED</span>':''}<div style="display:flex;align-items:center;gap:7px;margin-bottom:7px">${g.tag?`<span style="font-size:9.5px;font-weight:700;padding:2px 6px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:2px">${escH(g.tag)}</span>`:''}<div style="font-size:13px;font-weight:700">${escH(g.title||'')}</div></div><div style="font-size:12px;color:var(--text2);line-height:1.7;white-space:pre-wrap">${escH(g.body||'')}</div></div>`; }).join('');
    el.innerHTML=guidesCache[type];
  }catch(e){ el.innerHTML='<div style="color:var(--text3);padding:16px">Error.</div>'; }
}

// ============================
// REPORT
// ============================
async function submitReport(){
  if(!currentUser){ openModal('loginModal'); return; }
  const reporter=document.getElementById('repReporter').value.trim(), target=document.getElementById('repTarget').value.trim(), type=document.getElementById('repType').value, date=document.getElementById('repDate').value, kronologi=document.getElementById('repKronologi').value.trim(), bukti=document.getElementById('repBukti').value.trim();
  if(!reporter||!target||!type||!kronologi){ toast('Isi semua field wajib!','error'); return; }
  try{
    await DB.collection('reports').add({ uid:currentUser.uid, email:currentUser.email, reporter, target, type, date, kronologi, bukti, status:'open', createdAt:firebase.firestore.FieldValue.serverTimestamp() });
    toast('Laporan berhasil dikirim!','success'); ['repReporter','repTarget','repKronologi','repBukti'].forEach(id=>document.getElementById(id).value=''); document.getElementById('repType').value='';
  }catch(e){ toast('Gagal: '+e.message,'error'); }
}
async function loadReportList(){
  const el=document.getElementById('reportList'); if(!el) return;
  if(!currentUser){ el.innerHTML='<div style="padding:16px;color:var(--text3);font-size:11px">Login untuk melihat laporan.</div>'; return; }
  el.innerHTML='<div style="padding:16px;text-align:center;color:var(--text3)">Memuat...</div>';
  const snap=await DB.collection('reports').where('uid','==',currentUser.uid).orderBy('createdAt','desc').get();
  if(snap.empty){ el.innerHTML='<div style="padding:16px;color:var(--text3);font-size:11px">Belum ada laporan.</div>'; return; }
  el.innerHTML=snap.docs.map(d=>{ const r=d.data(); return `<div style="padding:10px 13px;border-bottom:1px solid var(--border2)"><div style="font-size:12px;font-weight:600">${escH(r.type||'')}: ${escH(r.target||'')}</div><div style="font-size:10.5px;color:var(--text3)">${fmtDate(r.createdAt)} &bull; <span class="s-badge s-${r.status==='open'?'open':'accepted'}">${r.status.toUpperCase()}</span></div></div>`; }).join('');
}

// ============================
// PM
// ============================
function initPM(){
  if(!currentUser){ document.getElementById('chatMessages').innerHTML='<div style="text-align:center;padding:36px;color:var(--text3)">Login untuk menggunakan pesan.</div>'; return; }
  loadConvos();
}
async function loadConvos(){
  const list=document.getElementById('pmConvoList'); if(!list) return;
  DB.collection('conversations').where('participants','array-contains',currentUser.uid).orderBy('lastMessageTime','desc').onSnapshot(snap=>{
    if(snap.empty){ list.innerHTML='<div style="text-align:center;padding:18px;color:var(--text3);font-size:11px">Belum ada percakapan.</div>'; return; }
    list.innerHTML=snap.docs.map(d=>{ const c=d.data(); const otherId=c.participants.find(p=>p!==currentUser.uid); const otherName=c.participantNames?.[otherId]||otherId; const unread=(c.unread||{})[currentUser.uid]>0; return `<div class="chat-item ${unread?'unread':''} ${d.id===activeConvoId?'active':''}" onclick="openConvo('${d.id}','${escH(otherName)}','${otherId}')"><div class="chat-ava">${initials(otherName)}</div><div style="flex:1;min-width:0"><div class="chat-item-name">${escH(otherName)}</div><div class="chat-item-preview">${escH((c.lastMessage||'').substring(0,35))}</div></div>${unread?'<div class="chat-unread-badge">'+c.unread[currentUser.uid]+'</div>':''}</div>`; }).join('');
  });
}
async function openConvo(convoId, otherName, otherId){
  activeConvoId=convoId;
  const header=document.getElementById('chatHeader'); const input=document.getElementById('chatInputArea');
  header.style.display='flex'; input.style.display='flex';
  document.getElementById('chatHeaderName').textContent=otherName;
  document.getElementById('chatHeaderAvatar').textContent=initials(otherName);
  // mark read
  await DB.collection('conversations').doc(convoId).update({ [`unread.${currentUser.uid}`]:0 });
  // listen messages
  if(pmListeners[convoId]) pmListeners[convoId]();
  const msgsEl=document.getElementById('chatMessages');
  pmListeners[convoId]=DB.collection('conversations').doc(convoId).collection('messages').orderBy('createdAt').onSnapshot(snap=>{
    msgsEl.innerHTML=snap.docs.map(d=>{ const m=d.data(); const mine=m.senderUid===currentUser.uid; return `<div class="msg-group ${mine?'mine':''}"><div class="msg-ava-sm">${initials(mine?(userProfile?.displayName||'?'):otherName)}</div><div class="msg-bubbles"><div class="msg-bubble">${escH(m.text||'')}</div><div class="msg-time">${timeAgo(m.createdAt)}</div></div></div>`; }).join('');
    msgsEl.scrollTop=msgsEl.scrollHeight;
  });
}
async function sendMessage(){
  const input=document.getElementById('chatInput'); if(!input||!input.value.trim()||!activeConvoId||!currentUser) return;
  const text=input.value.trim(); input.value=''; input.style.height='auto';
  const batch=DB.batch();
  const msgRef=DB.collection('conversations').doc(activeConvoId).collection('messages').doc();
  batch.set(msgRef,{ senderUid:currentUser.uid, senderName:userProfile?.displayName||'', text, createdAt:firebase.firestore.FieldValue.serverTimestamp() });
  const convoRef=DB.collection('conversations').doc(activeConvoId);
  const snap=await convoRef.get(); const c=snap.data();
  const otherId=c.participants.find(p=>p!==currentUser.uid);
  batch.update(convoRef,{ lastMessage:text, lastMessageTime:firebase.firestore.FieldValue.serverTimestamp(), [`unread.${otherId}`]:firebase.firestore.FieldValue.increment(1) });
  await batch.commit();
}
async function sendNewPm(){
  if(!currentUser){ toast('Login dulu!','error'); return; }
  const targetName=document.getElementById('newPmTarget').value.trim(); const msg=document.getElementById('newPmMessage').value.trim();
  if(!targetName||!msg){ toast('Isi semua field!','error'); return; }
  try{
    const userSnap=await DB.collection('users').where('displayName','==',targetName).limit(1).get();
    if(userSnap.empty){ toast('User tidak ditemukan!','error'); return; }
    const otherUser=userSnap.docs[0]; const otherId=otherUser.id;
    const convoId=[currentUser.uid,otherId].sort().join('_');
    const convoRef=DB.collection('conversations').doc(convoId);
    const names={}; names[currentUser.uid]=userProfile?.displayName||''; names[otherId]=otherUser.data().displayName||'';
    await convoRef.set({ participants:[currentUser.uid,otherId], participantNames:names, lastMessage:msg, lastMessageTime:firebase.firestore.FieldValue.serverTimestamp(), unread:{[otherId]:1} },{ merge:true });
    await DB.collection('conversations').doc(convoId).collection('messages').add({ senderUid:currentUser.uid, senderName:userProfile?.displayName||'', text:msg, createdAt:firebase.firestore.FieldValue.serverTimestamp() });
    closeModal('newPmModal'); document.getElementById('newPmTarget').value=''; document.getElementById('newPmMessage').value='';
    toast('Pesan terkirim!','success'); openConvo(convoId,otherUser.data().displayName||targetName,otherId);
  }catch(e){ toast('Gagal: '+e.message,'error'); }
}
function handleChatKey(e){ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); } }
function filterConvos(q){ document.querySelectorAll('.chat-item').forEach(el=>{ el.style.display=el.textContent.toLowerCase().includes(q.toLowerCase())?'':'none'; }); }
async function renderPmDot(){
  if(!currentUser) return;
  DB.collection('conversations').where('participants','array-contains',currentUser.uid).onSnapshot(snap=>{
    const hasUnread=snap.docs.some(d=>((d.data().unread||{})[currentUser.uid]||0)>0);
    ['pmDot','pmDotMobile'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display=hasUnread?'':'none'; });
  });
}

// ============================
// PROFILE
// ============================
async function loadProfilePage(){
  if(!currentUser){ showPage('forums'); return; }
  const p=userProfile;
  document.getElementById('profileName').textContent=p.displayName||'';
  document.getElementById('profileUsername').textContent='@'+(p.displayName||'');
  document.getElementById('profileEmail').textContent=p.email||'';
  document.getElementById('profileJoined').textContent=fmtDate(p.createdAt)||'';
  document.getElementById('profilePosts').textContent=p.postCount||0;
  document.getElementById('profileLogoutBtn').style.display='';
  const ava=document.getElementById('profileAvatar'); if(p.photoURL) ava.innerHTML=`<img src="${p.photoURL}" style="width:100%;height:100%;object-fit:cover">`;
  else ava.textContent=initials(p.displayName||'?');
  const rb=document.getElementById('profileRoleBadge'); rb.textContent=roleName(p.role); rb.className='s-badge'; rb.style.background='rgba(255,255,255,.05)'; rb.style.border='1px solid rgba(255,255,255,.15)'; rb.style.color='var(--accent)';
  const wlStatus=document.getElementById('profileWLStatus'); const wlSnap=await DB.collection('whitelist').where('uid','==',currentUser.uid).orderBy('createdAt','desc').limit(1).get();
  const statusMap={pending:'<span class="s-badge s-pending">PENDING</span>',process:'<span class="s-badge s-process">DIPROSES</span>',accepted:'<span class="s-badge s-accepted">DITERIMA</span>',rejected:'<span class="s-badge s-rejected">DITOLAK</span>',none:'<span style="color:var(--text3)">Belum Mendaftar</span>'};
  if(!wlSnap.empty) wlStatus.innerHTML=statusMap[wlSnap.docs[0].data().status]||''; else wlStatus.innerHTML=statusMap.none;
  const profStatus=document.getElementById('profileStatus'); profStatus.innerHTML=p.banned?'<span class="s-badge s-banned">BANNED</span>':'<span style="color:var(--green)"> Aktif</span>';
  document.getElementById('settingsDisplayName').value=p.displayName||'';
}
async function saveSettings(){
  if(!currentUser) return; const name=document.getElementById('settingsDisplayName').value.trim();
  if(!name){ toast('Nama tidak boleh kosong!','error'); return; }
  await DB.collection('users').doc(currentUser.uid).update({ displayName:name });
  userProfile.displayName=name; renderTopbarAuth(); toast('Tersimpan!','success');
}
async function changeAvatar(e){ const f=e.target.files[0]; if(!f||!currentUser) return; const r=new FileReader(); r.onload=async ev=>{ const base64=ev.target.result; await DB.collection('users').doc(currentUser.uid).update({ photoURL:base64 }); userProfile.photoURL=base64; loadProfilePage(); renderTopbarAuth(); toast('Avatar diperbarui!','success'); }; r.readAsDataURL(f); }
async function loadProfilePosts(){ const el=document.getElementById('profilePostsList'); if(!el||!currentUser) return; el.innerHTML='<div style="padding:16px;text-align:center;color:var(--text3)">Memuat...</div>'; const snap=await DB.collection('posts').where('authorUid','==',currentUser.uid).orderBy('createdAt','desc').limit(15).get(); if(snap.empty){ el.innerHTML='<div style="padding:16px;color:var(--text3)">Belum ada post.</div>'; return; } el.innerHTML=snap.docs.map(d=>{ const p=d.data(); return `<div style="padding:10px 12px;border-bottom:1px solid var(--border2)"><div style="font-size:11.5px;color:var(--text2);line-height:1.5">${escH((p.body||'').substring(0,100))}</div><div style="font-size:9.5px;color:var(--text3);margin-top:4px">${timeAgo(p.createdAt)}</div></div>`; }).join(''); }

// ============================
// LOGS
// ============================
async function addLog(type,msg){ try{ await DB.collection('logs').add({ type, msg, uid:currentUser?.uid||'system', uname:userProfile?.displayName||'System', createdAt:firebase.firestore.FieldValue.serverTimestamp() }); }catch(e){} }
async function loadLogs(containerId='logStream', limit=100, filterType=''){
  const el=document.getElementById(containerId); if(!el) return;
  let query=DB.collection('logs').orderBy('createdAt','desc');
  if(filterType) query=query.where('type','==',filterType);
  query=query.limit(limit);
  const snap=await query.get();
  allLogsCache=snap.docs.map(d=>({...d.data(),id:d.id}));
  renderLogs(containerId,allLogsCache);
}
function renderLogs(containerId,logs){ const el=document.getElementById(containerId); if(!el) return; if(!logs.length){ el.innerHTML='<div class="log-entry"><div class="log-msg" style="color:var(--text3)">Tidak ada log.</div></div>'; return; } el.innerHTML=logs.map(l=>`<div class="log-entry"><div class="log-time">${fmtDT(l.createdAt)}</div><div class="log-type ${l.type||'SYSTEM'}">${l.type||'SYS'}</div><div class="log-msg">[${escH(l.uname||'?')}] ${escH(l.msg||'')}</div></div>`).join(''); }
async function filterLogs(type){ await loadLogs('logStream',100,type); }
async function clearLogs(){ if(!confirm('Hapus semua logs?')) return; const snap=await DB.collection('logs').limit(200).get(); const batch=DB.batch(); snap.docs.forEach(d=>batch.delete(d.ref)); await batch.commit(); toast('Logs dihapus.','info'); loadLogs(); }

// ============================
// ADMIN
// ============================
function hasPermission(perm){ if(!userProfile) return false; if(['owner','developer'].includes(userProfile.role)) return true; if(userProfile.role==='headadmin'&&!['clear_logs'].includes(perm)) return true; return (userProfile.permissions||[]).includes(perm); }
function initAdmin(){
  if(!currentUser||!userProfile||!ADMIN_ROLES.includes(userProfile.role)){ showPage('forums'); return; }
  buildAdminSidebar(); switchAdminTab('overview'); loadAdminDashboard();
}
function buildAdminSidebar(){
  const sidebar=document.getElementById('adminSidebar'); if(!sidebar) return;
  const perm=userProfile?.role; const isOwner=['owner','developer'].includes(perm); const isAdmin=['owner','developer','headadmin','senioradmin','admin','junioradmin'].includes(perm);
  sidebar.innerHTML=`
    <div style="padding:8px 13px 5px;font-size:13px;font-weight:800;letter-spacing:2px;color:var(--accent);margin-bottom:4px">ADMIN</div>
    <div class="adm-nav-section">Utama</div>
    <button class="adm-nav-item active" id="navOverview" onclick="switchAdminTab('overview')"> Overview</button>
    <button class="adm-nav-item" id="navAdminChat" onclick="switchAdminTab('adminChat');loadAdminChat()"> Admin Chat</button>
    <div class="adm-nav-section">Manajemen</div>
    ${hasPermission('manage_wl')?`<button class="adm-nav-item" id="navWLPending" onclick="switchAdminTab('wlPending');loadAdminWL('pending')"> WL Pending <span class="adm-nav-badge" id="navBadgeWL">0</span></button>`:''}
    ${hasPermission('manage_wl')?`<button class="adm-nav-item" id="navWLAll" onclick="switchAdminTab('wlAll');loadAdminWL('all')"> WL Semua</button>`:''}
    ${hasPermission('manage_cs')?`<button class="adm-nav-item" id="navCSPending" onclick="switchAdminTab('csPending');loadAdminCS('pending')"> CS Pending <span class="adm-nav-badge" id="navBadgeCS">0</span></button>`:''}
    ${hasPermission('manage_cs')?`<button class="adm-nav-item" id="navCSAll" onclick="switchAdminTab('csAll');loadAdminCS('all')"> CS Semua</button>`:''}
    ${hasPermission('manage_import')?`<button class="adm-nav-item" id="navImport" onclick="switchAdminTab('importReq');loadAdminImport()"> Import Request <span class="adm-nav-badge" id="navBadgeImport">0</span></button>`:''}
    ${hasPermission('manage_users')?`<button class="adm-nav-item" id="navUsers" onclick="switchAdminTab('users');loadAdminUsers()"> Users & Role</button>`:''}
    ${hasPermission('ban_user')?`<button class="adm-nav-item" id="navBanned" onclick="switchAdminTab('banned');loadBanned()"> Banned Users</button>`:''}
    <button class="adm-nav-item" id="navReports" onclick="switchAdminTab('reports');loadAdminReports()"> Reports</button>
    <div class="adm-nav-section">Konten</div>
    ${hasPermission('manage_announce')?`<button class="adm-nav-item" id="navAnnounce" onclick="switchAdminTab('announce');loadAnnAdmin()"> Pengumuman</button>`:''}
    ${hasPermission('manage_guides')?`<button class="adm-nav-item" id="navGuides" onclick="switchAdminTab('guides');loadAdminGuides()"> Guides & Rules</button>`:''}
    ${hasPermission('manage_staff')?`<button class="adm-nav-item" id="navStaff" onclick="switchAdminTab('staff');loadStaffAdmin()"> Staff List</button>`:''}
    ${isOwner?`<div class="adm-nav-section">System</div><button class="adm-nav-item" id="navSettings" onclick="switchAdminTab('settings');loadSettingsForm()"> Settings</button><button class="adm-nav-item" id="navLogs" onclick="switchAdminTab('logs');loadLogs()"> System Logs</button>`:''}
  `;
}
function switchAdminTab(name){
  document.querySelectorAll('.adm-tab').forEach(t=>{t.style.display='none';t.classList.remove('active');});
  const tab=document.getElementById('adm-'+name); if(tab){ tab.style.display=''; tab.classList.add('active'); }
  document.querySelectorAll('.adm-nav-item').forEach(b=>b.classList.remove('active'));
  const nav=document.getElementById('nav'+name.charAt(0).toUpperCase()+name.slice(1)); if(nav) nav.classList.add('active');
}
async function loadAdminDashboard(){
  try{
    const [members,wlP,csP,importP,reports,banned,wlA,staff]=await Promise.all([
      DB.collection('users').get(), DB.collection('whitelist').where('status','==','pending').get(),
      DB.collection('cs_requests').where('status','==','pending').get(),
      DB.collection('import_requests').where('status','==','pending').get(),
      DB.collection('reports').where('status','==','open').get(),
      DB.collection('users').where('banned','==',true).get(),
      DB.collection('whitelist').where('status','==','accepted').get(),
      DB.collection('staff_list').get()
    ]);
    const s=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
    s('admStatMembers',members.size); s('admStatWL',wlP.size); s('admStatCS',csP.size); s('admStatImport',importP.size);
    s('admStatReports',reports.size); s('admStatBanned',banned.size); s('admStatAccepted',wlA.size); s('admStatStaff',staff.size);
    const badgeWL=document.getElementById('navBadgeWL'); if(badgeWL) badgeWL.textContent=wlP.size;
    const badgeCS=document.getElementById('navBadgeCS'); if(badgeCS) badgeCS.textContent=csP.size;
    const badgeImp=document.getElementById('navBadgeImport'); if(badgeImp) badgeImp.textContent=importP.size;
    await loadLogs('dashLogs',30);
  }catch(e){}
}

// ============================
// ADMIN WL
// ============================
async function loadAdminWL(mode){
  const tbody=document.getElementById(mode==='pending'?'tbodyWLPending':'tbodyWLAll'); if(!tbody) return;
  tbody.innerHTML='<tr class="empty-row"><td colspan="'+(mode==='pending'?6:7)+'">Memuat...</td></tr>';
  let query=DB.collection('whitelist').orderBy('createdAt','desc');
  if(mode==='pending') query=query.where('status','==','pending');
  const snap=await query.get();
  if(snap.empty){ tbody.innerHTML='<tr class="empty-row"><td colspan="'+(mode==='pending'?6:7)+'">Tidak ada data.</td></tr>'; return; }
  const lbl=document.getElementById(mode==='pending'?'wlPendingLbl':''); if(lbl) lbl.textContent='('+snap.size+')';
  tbody.innerHTML=snap.docs.map(d=>{ const w={...d.data(),id:d.id}; const statusBadge=`<span class="s-badge s-${w.status}">${w.status.toUpperCase()}</span>`;
    return `<tr><td><strong>${escH(w.icName||'')}</strong></td>${mode==='all'?`<td>${escH(w.email||'')}</td>`:''}<td>${escH(w.wa||'')}</td><td>${escH(w.fraksi||'')}</td><td>${fmtDate(w.createdAt)}</td><td>${statusBadge}</td><td><button class="action-btn" onclick="openWLDetail('${d.id}')">Detail</button></td></tr>`;
  }).join('');
}
async function openWLDetail(id){
  const snap=await DB.collection('whitelist').doc(id).get(); if(!snap.exists) return;
  const w=snap.data(); const isAdmin=ADMIN_ROLES.includes(userProfile?.role);
  document.getElementById('wlDetailBody').innerHTML=`
    <div class="detail-row"><div class="detail-key">Nama Lengkap</div><div class="detail-val">${escH(w.namaLengkap||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Nama IC</div><div class="detail-val">${escH(w.icName||'')}</div></div>
    <div class="detail-row"><div class="detail-key">WhatsApp</div><div class="detail-val">${escH(w.wa||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Umur</div><div class="detail-val">${escH(w.umur||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Fraksi</div><div class="detail-val">${escH(w.fraksi||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Pengalaman</div><div class="detail-val">${escH(w.experience||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Status</div><div class="detail-val"><span class="s-badge s-${w.status}">${w.status.toUpperCase()}</span></div></div>
    <hr style="border-color:var(--border);margin:10px 0">
    <div class="form-label" style="margin-bottom:4px">Q1: Apa itu RP?</div><div class="detail-story">${escH(w.q1||'')}</div>
    <div class="form-label" style="margin-top:8px;margin-bottom:4px">Q2: Metagaming</div><div class="detail-story">${escH(w.q2||'')}</div>
    <div class="form-label" style="margin-top:8px;margin-bottom:4px">Q3: Powergaming</div><div class="detail-story">${escH(w.q3||'')}</div>
    <div class="form-label" style="margin-top:8px;margin-bottom:4px">Alasan</div><div class="detail-story">${escH(w.reason||'')}</div>
    <div class="form-row" style="margin-top:10px"><label class="form-label">Catatan Admin</label><input type="text" class="form-input" id="wlAdminNote" value="${escH(w.adminNote||'')}" placeholder="Opsional..."></div>
  `;
  const actions=document.getElementById('wlActions');
  if(isAdmin&&w.status==='pending'){
    actions.innerHTML=`<button class="btn btn-green" onclick="updateWL('${id}','accepted')"> Terima</button><button class="btn" onclick="updateWL('${id}','process')"> Proses</button><button class="btn btn-danger" onclick="updateWL('${id}','rejected')"> Tolak</button>`;
  } else { actions.innerHTML=`<span class="s-badge s-${w.status}">${w.status.toUpperCase()}</span>`; }
  openModal('modalWL');
}
async function updateWL(id,status){
  const note=document.getElementById('wlAdminNote')?.value||'';
  const snap=await DB.collection('whitelist').doc(id).get(); const w=snap.data();
  await DB.collection('whitelist').doc(id).update({ status, adminNote:note, reviewedBy:userProfile?.displayName||'', reviewedAt:firebase.firestore.FieldValue.serverTimestamp() });
  if(status==='accepted' && w.uid){ await DB.collection('users').doc(w.uid).update({ wlStatus:'accepted', icName:w.icName }); }
  await addLog(status==='accepted'?'ACCEPT':status==='rejected'?'REJECT':'WL','WL '+status+': '+w.icName+' oleh '+userProfile?.displayName);
  toast('WL '+status+'!','success'); closeModal('modalWL'); loadAdminWL('pending'); loadAdminWL('all'); loadAdminDashboard();
}

// ============================
// ADMIN CS
// ============================
async function loadAdminCS(mode){
  const tbody=document.getElementById(mode==='pending'?'tbodyCSPending':'tbodyCSAll'); if(!tbody) return;
  tbody.innerHTML='<tr class="empty-row"><td colspan="'+(mode==='pending'?7:6)+'">Memuat...</td></tr>';
  let query=DB.collection('cs_requests').orderBy('createdAt','desc');
  if(mode==='pending') query=query.where('status','==','pending');
  const snap=await query.get();
  if(snap.empty){ tbody.innerHTML='<tr class="empty-row"><td colspan="'+(mode==='pending'?7:6)+'">Tidak ada data.</td></tr>'; return; }
  const lbl=document.getElementById('csPendingLbl'); if(lbl&&mode==='pending') lbl.textContent='('+snap.size+')';
  tbody.innerHTML=snap.docs.map(d=>{ const c={...d.data(),id:d.id}; const sb=`<span class="s-badge s-${c.status}">${c.status.toUpperCase()}</span>`;
    return `<tr><td>${escH(c.icName||'')}</td><td>${escH(c.charName||'')}</td><td>${escH(c.level||'')}</td>${mode==='pending'?`<td>${escH(c.email||'')}</td><td>${escH(c.schedule||'')}</td>`:''}<td>${sb}</td><td>${fmtDate(c.createdAt)}</td><td><button class="action-btn" onclick="openCSDetail('${d.id}')">Detail</button></td></tr>`;
  }).join('');
}
async function openCSDetail(id){
  const snap=await DB.collection('cs_requests').doc(id).get(); if(!snap.exists) return;
  const c=snap.data(); const words=(c.story||'').trim().split(/\s+/).length;
  document.getElementById('csDetailBody').innerHTML=`
    <div class="detail-row"><div class="detail-key">IC Name</div><div class="detail-val">${escH(c.icName||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Char Name</div><div class="detail-val">${escH(c.charName||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Usia / Level</div><div class="detail-val">${escH(c.age||'')} / ${escH(c.level||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Jadwal</div><div class="detail-val">${escH(c.schedule||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Screenshot</div><div class="detail-val"><a href="${escH(c.screenshot||'')}" target="_blank" style="color:var(--blue)">Lihat</a></div></div>
    <div class="detail-row"><div class="detail-key">Status</div><div class="detail-val"><span class="s-badge s-${c.status}">${c.status.toUpperCase()}</span></div></div>
    <div class="form-label" style="margin:10px 0 4px">Story IC (${words} kata)</div>
    <div class="detail-story">${escH(c.story||'')}</div>
    <div class="form-row" style="margin-top:10px"><label class="form-label">Catatan Admin</label><input type="text" class="form-input" id="csAdminNote" value="${escH(c.adminNote||'')}" placeholder="Opsional..."></div>
  `;
  const actions=document.getElementById('csActions');
  if(c.status==='pending'||c.status==='process'){
    actions.innerHTML=`<button class="btn btn-green" onclick="updateCS('${id}','accepted')"> Terima</button><button class="btn" onclick="updateCS('${id}','process')"> Proses</button><button class="btn btn-danger" onclick="updateCS('${id}','rejected')"> Tolak</button>`;
  } else { actions.innerHTML=`<span class="s-badge s-${c.status}">${c.status.toUpperCase()}</span>`; }
  openModal('modalCS');
}
async function updateCS(id,status){
  const note=document.getElementById('csAdminNote')?.value||'';
  const snap=await DB.collection('cs_requests').doc(id).get(); const c=snap.data();
  await DB.collection('cs_requests').doc(id).update({ status, adminNote:note, reviewedBy:userProfile?.displayName||'', reviewedAt:firebase.firestore.FieldValue.serverTimestamp() });
  await addLog(status==='accepted'?'ACCEPT':'CS','CS '+status+': '+c.charName);
  toast('CS '+status+'!','success'); closeModal('modalCS'); loadAdminCS('pending'); loadAdminCS('all');
}

// ============================
// ADMIN IMPORT
// ============================
async function loadAdminImport(){
  const tbody=document.getElementById('tbodyImport'); if(!tbody) return;
  tbody.innerHTML='<tr class="empty-row"><td colspan="7">Memuat...</td></tr>';
  const snap=await DB.collection('import_requests').orderBy('createdAt','desc').get();
  if(snap.empty){ tbody.innerHTML='<tr class="empty-row"><td colspan="7">Tidak ada data.</td></tr>'; return; }
  const lbl=document.getElementById('importPendingLbl'); if(lbl) lbl.textContent='('+snap.docs.filter(d=>d.data().status==='pending').length+' pending)';
  tbody.innerHTML=snap.docs.map(d=>{ const r={...d.data(),id:d.id}; const sb=`<span class="s-badge s-${r.status}">${r.status.toUpperCase()}</span>`;
    return `<tr><td>${escH(r.icName||'')}</td><td>${escH(r.email||'')}</td><td style="text-transform:capitalize">${escH(r.type||'')}</td><td>${escH(r.faction||'')}</td><td>${escH(r.level||'')}</td><td>${sb}</td><td><button class="action-btn" onclick="openImportDetail('${d.id}')">Detail</button></td></tr>`;
  }).join('');
}
async function openImportDetail(id){
  const snap=await DB.collection('import_requests').doc(id).get(); if(!snap.exists) return;
  const r=snap.data();
  document.getElementById('importDetailBody').innerHTML=`
    <div class="detail-row"><div class="detail-key">Nama IC</div><div class="detail-val">${escH(r.icName||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Tipe</div><div class="detail-val" style="text-transform:capitalize">${escH(r.type||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Fraksi/Family</div><div class="detail-val">${escH(r.faction||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Level</div><div class="detail-val">${escH(r.level||'')}</div></div>
    <div class="detail-row"><div class="detail-key">Bukti</div><div class="detail-val"><a href="${escH(r.proof||'')}" target="_blank" style="color:var(--blue)">Lihat</a></div></div>
    <div class="detail-row"><div class="detail-key">Status</div><div class="detail-val"><span class="s-badge s-${r.status}">${r.status.toUpperCase()}</span></div></div>
    <div class="form-label" style="margin:10px 0 4px">Lore IC</div><div class="detail-story">${escH(r.lore||'')}</div>
    <div class="form-row" style="margin-top:10px"><label class="form-label">Catatan Admin</label><input type="text" class="form-input" id="importAdminNote" value="${escH(r.adminNote||'')}" placeholder="Opsional..."></div>
  `;
  const actions=document.getElementById('importActions');
  if(r.status==='pending') actions.innerHTML=`<button class="btn btn-green" onclick="updateImport('${id}','accepted')"> Terima</button><button class="btn btn-danger" onclick="updateImport('${id}','rejected')"> Tolak</button>`;
  else actions.innerHTML=`<span class="s-badge s-${r.status}">${r.status.toUpperCase()}</span>`;
  openModal('modalImport');
}
async function updateImport(id,status){
  const note=document.getElementById('importAdminNote')?.value||'';
  const snap=await DB.collection('import_requests').doc(id).get(); const r=snap.data();
  await DB.collection('import_requests').doc(id).update({ status, adminNote:note, reviewedBy:userProfile?.displayName||'', reviewedAt:firebase.firestore.FieldValue.serverTimestamp() });
  await addLog(status==='accepted'?'ACCEPT':'IMPORT','Import '+status+': '+r.icName+' ('+r.type+')');
  toast('Import '+status+'!','success'); closeModal('modalImport'); loadAdminImport();
}

// ============================
// ADMIN USERS
// ============================
async function loadAdminUsers(){
  const tbody=document.getElementById('tbodyUsers'); if(!tbody) return;
  tbody.innerHTML='<tr class="empty-row"><td colspan="7">Memuat...</td></tr>';
  const snap=await DB.collection('users').orderBy('createdAt','desc').get();
  if(snap.empty){ tbody.innerHTML='<tr class="empty-row"><td colspan="7">Tidak ada user.</td></tr>'; return; }
  tbody.innerHTML=snap.docs.map(d=>{ const u={...d.data(),id:d.id}; const wlBadge=u.wlStatus==='accepted'?'<span class="s-badge s-accepted" style="font-size:9px"></span>':'<span style="color:var(--text3)"></span>'; const ban=u.banned?'<span class="s-badge s-banned" style="font-size:9px">BANNED</span>':'';
    return `<tr><td><span class="${roleClass(u.role)}">${escH(u.displayName||'')}</span> ${ban}</td><td style="font-size:10px;color:var(--text3)">${escH(u.email||'')}</td><td>${roleName(u.role)}</td><td>${wlBadge}</td><td style="font-size:10.5px">${escH(u.icName||'')}</td><td style="font-size:10px">${fmtDate(u.createdAt)}</td>
      <td style="white-space:nowrap">
        ${hasPermission('manage_users')?`<button class="action-btn" onclick="openRoleModal('${d.id}','${escH(u.displayName||'')}','${u.role||'user'}',${JSON.stringify(u.permissions||[]).replace(/"/g,'&quot;')})">Role</button>`:''}
        ${hasPermission('manage_users')?`<button class="action-btn" onclick="openICNameModal('${d.id}','${escH(u.displayName||'')}','${escH(u.icName||'')}')">IC</button>`:''}
        ${hasPermission('ban_user')&&!u.banned?`<button class="action-btn r" onclick="openBanModal('${d.id}','${escH(u.displayName||'')}')">Ban</button>`:hasPermission('ban_user')&&u.banned?`<button class="action-btn g" onclick="unbanUser('${d.id}')">Unban</button>`:''}
      </td></tr>`;
  }).join('');
}

// ============================
// ROLE MODAL
// ============================
function openRoleModal(uid,name,role,perms){
  roleModalTarget={uid,name,role,perms};
  document.getElementById('roleTargetSub').textContent='User: '+name+' | Role saat ini: '+roleName(role);
  const roleSelect=document.getElementById('primaryRoleSelect');
  roleSelect.innerHTML=ROLES_ORDER.map(r=>`<div class="role-chip ${r===role?'sel':''}" onclick="selectPrimaryRole(this,'${r}')">${roleName(r)}</div>`).join('');
  const permSelect=document.getElementById('permSelect');
  permSelect.innerHTML=ALL_PERMISSIONS.map(p=>`<div class="perm-tag ${perms.includes(p)?'on':'off'}" onclick="togglePerm(this,'${p}')">${p}</div>`).join('');
  openModal('modalRole');
}
function selectPrimaryRole(el,role){ document.querySelectorAll('#primaryRoleSelect .role-chip').forEach(c=>c.classList.remove('sel')); el.classList.add('sel'); roleModalTarget.newRole=role; }
function togglePerm(el,perm){ el.classList.toggle('on'); el.classList.toggle('off'); if(!roleModalTarget.newPerms) roleModalTarget.newPerms=[...roleModalTarget.perms]; if(el.classList.contains('on')) roleModalTarget.newPerms.push(perm); else roleModalTarget.newPerms=roleModalTarget.newPerms.filter(p=>p!==perm); }
async function confirmRoleChange(){
  if(!roleModalTarget) return;
  const newRole=roleModalTarget.newRole||roleModalTarget.role; const newPerms=roleModalTarget.newPerms||roleModalTarget.perms;
  await DB.collection('users').doc(roleModalTarget.uid).update({ role:newRole, permissions:newPerms });
  await addLog('ROLE','Role '+roleModalTarget.name+': '+roleName(roleModalTarget.role)+'  '+roleName(newRole));
  toast('Role diperbarui!','success'); closeModal('modalRole'); loadAdminUsers();
}

// ============================
// BAN MODAL
// ============================
function openBanModal(uid,name){ banModalTarget={uid,name}; document.getElementById('banTargetSub').textContent='User: '+name; document.getElementById('banReasonInput').value=''; openModal('modalBan'); }
async function confirmBan(){ if(!banModalTarget) return; const reason=document.getElementById('banReasonInput').value.trim(); if(!reason){ toast('Isi alasan ban!','error'); return; } await DB.collection('users').doc(banModalTarget.uid).update({ banned:true, banReason:reason, bannedBy:userProfile?.displayName||'' }); await addLog('BAN','Ban: '+banModalTarget.name+'  '+reason); toast('User dibanned.','success'); closeModal('modalBan'); loadAdminUsers(); }
async function unbanUser(uid){ if(!confirm('Unban user ini?')) return; await DB.collection('users').doc(uid).update({ banned:false, banReason:'', bannedBy:'' }); await addLog('AUTH','Unban: '+uid); toast('User di-unban.','success'); loadAdminUsers(); }

// ============================
// IC NAME MODAL
// ============================
function openICNameModal(uid,name,icName){ icModalTarget={uid,name}; document.getElementById('icNameTargetSub').textContent='User: '+name; document.getElementById('icNameInput').value=icName; openModal('modalICName'); }
async function confirmICNameChange(){ if(!icModalTarget) return; const newName=document.getElementById('icNameInput').value.trim(); if(!newName){ toast('Nama IC tidak boleh kosong!','error'); return; } await DB.collection('users').doc(icModalTarget.uid).update({ icName:newName }); await addLog('ROLE','IC Name '+icModalTarget.name+': '+newName); toast('Nama IC diperbarui!','success'); closeModal('modalICName'); loadAdminUsers(); }

// ============================
// BANNED LIST
// ============================
async function loadBanned(){
  const tbody=document.getElementById('tbodyBanned'); if(!tbody) return;
  const snap=await DB.collection('users').where('banned','==',true).get();
  if(snap.empty){ tbody.innerHTML='<tr class="empty-row"><td colspan="6">Tidak ada user banned.</td></tr>'; return; }
  tbody.innerHTML=snap.docs.map(d=>{ const u=d.data(); return `<tr><td>${escH(u.displayName||'')}</td><td style="font-size:10px">${escH(u.email||'')}</td><td>${escH(u.banReason||'')}</td><td>${escH(u.bannedBy||'')}</td><td></td><td><button class="action-btn g" onclick="unbanUser('${d.id}')">Unban</button></td></tr>`; }).join('');
}

// ============================
// ADMIN REPORTS
// ============================
async function loadAdminReports(){
  const tbody=document.getElementById('tbodyReports'); if(!tbody) return;
  const snap=await DB.collection('reports').orderBy('createdAt','desc').get();
  if(snap.empty){ tbody.innerHTML='<tr class="empty-row"><td colspan="6">Tidak ada laporan.</td></tr>'; return; }
  tbody.innerHTML=snap.docs.map(d=>{ const r=d.data(); const sb=`<span class="s-badge s-${r.status==='open'?'open':'accepted'}">${r.status.toUpperCase()}</span>`;
    return `<tr><td>${escH(r.reporter||'')}</td><td>${escH(r.target||'')}</td><td>${escH(r.type||'')}</td><td>${sb}</td><td>${fmtDate(r.createdAt)}</td><td><button class="action-btn g" onclick="closeReport('${d.id}')">Tutup</button></td></tr>`;
  }).join('');
}
async function closeReport(id){ await DB.collection('reports').doc(id).update({ status:'closed', closedBy:userProfile?.displayName||'' }); toast('Report ditutup.','info'); loadAdminReports(); }

// ============================
// ADMIN CHAT
// ============================
async function loadAdminChat(){
  if(adminChatListener) adminChatListener();
  const el=document.getElementById('adminChatMsgs'); if(!el) return;
  adminChatListener=DB.collection('admin_chat').orderBy('createdAt').limit(80).onSnapshot(snap=>{
    el.innerHTML=snap.docs.map(d=>{ const m=d.data(); const mine=m.uid===currentUser?.uid;
      return `<div class="admin-msg ${mine?'mine':'theirs'}"><div class="admin-msg-meta"><span class="${roleClass(m.role)}">[${roleName(m.role)}]</span> ${escH(m.uname||'')}</div><div class="admin-msg-text">${escH(m.text||'')}</div><div class="admin-msg-time">${timeAgo(m.createdAt)}</div></div>`;
    }).join('');
    el.scrollTop=el.scrollHeight;
  });
}
async function sendAdminChat(){
  const input=document.getElementById('adminChatInput'); if(!input||!input.value.trim()||!currentUser) return;
  const text=input.value.trim(); input.value='';
  await DB.collection('admin_chat').add({ uid:currentUser.uid, uname:userProfile?.displayName||'', role:userProfile?.role||'user', text, createdAt:firebase.firestore.FieldValue.serverTimestamp() });
  await addLog('CHAT','Admin chat: '+userProfile?.displayName+': '+text.substring(0,50));
}

// ============================
// ANNOUNCEMENT ADMIN
// ============================
function selAnnTag(el,tag){ document.querySelectorAll('#annTagSelect .role-chip').forEach(c=>c.classList.remove('sel')); el.classList.add('sel'); selectedAnnTag=tag; }
async function loadAnnAdmin(){
  const el=document.getElementById('annAdminList'); if(!el) return;
  el.innerHTML='<div style="padding:10px;color:var(--text3)">Memuat...</div>';
  const snap=await DB.collection('announcements').orderBy('createdAt','desc').get();
  if(snap.empty){ el.innerHTML='<div style="padding:10px;color:var(--text3)">Belum ada pengumuman.</div>'; return; }
  el.innerHTML=snap.docs.map(d=>{ const a=d.data(); return `<div style="padding:10px 13px;border-bottom:1px solid var(--border2)"><div style="font-size:11.5px;font-weight:600">${escH(a.title||'')}</div><div style="font-size:9.5px;color:var(--text3);margin-top:2px">${escH(a.tag||'')}  ${fmtDate(a.createdAt)}</div><button class="action-btn r" style="margin-top:4px" onclick="deleteAnnouncement('${d.id}')">Hapus</button></div>`; }).join('');
}
async function postAnnouncement(){ const title=document.getElementById('annTitle').value.trim(),body=document.getElementById('annBody').value.trim(); if(!title||!body){ toast('Isi judul dan isi!','error'); return; } await DB.collection('announcements').add({ tag:selectedAnnTag, title, body, authorUid:currentUser.uid, authorName:userProfile?.displayName||'Admin', createdAt:firebase.firestore.FieldValue.serverTimestamp() }); await addLog('NEWS','Pengumuman baru: '+title); toast('Pengumuman diposting!','success'); document.getElementById('annTitle').value=''; document.getElementById('annBody').value=''; loadAnnAdmin(); loadFeedAnnouncements(); }
async function deleteAnnouncement(id){ if(!confirm('Hapus pengumuman ini?')) return; await DB.collection('announcements').doc(id).delete(); toast('Dihapus.','info'); loadAnnAdmin(); }

// ============================
// GUIDE ADMIN
// ============================
async function loadAdminGuides(){
  const type=document.getElementById('guideTypeFilter')?.value||'rules';
  const el=document.getElementById('guideAdminList'); if(!el) return;
  el.innerHTML='<div style="padding:10px;color:var(--text3)">Memuat...</div>';
  const snap=await DB.collection('guides').where('type','==',type).orderBy('pinned','desc').orderBy('createdAt','asc').get();
  if(snap.empty){ el.innerHTML='<div style="padding:10px;color:var(--text3)">Belum ada artikel.</div>'; return; }
  el.innerHTML=snap.docs.map(d=>{ const g=d.data(); return `<div style="padding:10px 13px;border-bottom:1px solid var(--border2)"><div style="font-size:11.5px;font-weight:600">${g.pinned?' ':''} ${escH(g.title||'')}</div><div style="font-size:9.5px;color:var(--text3);margin-top:2px">${escH(g.tag||'')}  ${fmtDate(g.createdAt)}</div><div style="display:flex;gap:5px;margin-top:5px"><button class="action-btn" onclick="editGuide('${d.id}',${JSON.stringify(g).replace(/"/g,'&quot;')})">Edit</button><button class="action-btn r" onclick="deleteGuide('${d.id}')">Hapus</button></div></div>`; }).join('');
}
function editGuide(id,g){ editingGuideId=id; document.getElementById('guideTitle').value=g.title||''; document.getElementById('guideTag').value=g.tag||''; document.getElementById('guideBody').value=g.body||''; document.getElementById('guidePinned').checked=g.pinned||false; document.getElementById('guideFormTitle').textContent='Edit Artikel'; document.getElementById('btnCancelGuide').style.display=''; }
function cancelGuideEdit(){ editingGuideId=null; document.getElementById('guideTitle').value=''; document.getElementById('guideTag').value=''; document.getElementById('guideBody').value=''; document.getElementById('guidePinned').checked=false; document.getElementById('guideFormTitle').textContent='Tambah Artikel'; document.getElementById('btnCancelGuide').style.display='none'; }
async function submitGuide(){ const type=document.getElementById('guideTypeFilter')?.value||'rules', title=document.getElementById('guideTitle').value.trim(), tag=document.getElementById('guideTag').value.trim(), body=document.getElementById('guideBody').value.trim(), pinned=document.getElementById('guidePinned').checked; if(!title||!body){ toast('Isi judul dan konten!','error'); return; } const data={type,title,tag,body,pinned,authorUid:currentUser.uid,authorName:userProfile?.displayName||''}; if(editingGuideId){ await DB.collection('guides').doc(editingGuideId).update(data); toast('Diperbarui!','success'); } else { await DB.collection('guides').add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()}); toast('Artikel ditambahkan!','success'); } delete guidesCache[type]; cancelGuideEdit(); loadAdminGuides(); }
async function deleteGuide(id){ const type=document.getElementById('guideTypeFilter')?.value||'rules'; if(!confirm('Hapus artikel ini?')) return; await DB.collection('guides').doc(id).delete(); delete guidesCache[type]; toast('Dihapus.','info'); loadAdminGuides(); }

// ============================
// STAFF ADMIN
// ============================
async function loadStaffAdmin(){
  const tbody=document.getElementById('staffAdminTbody'); if(!tbody) return;
  const snap=await DB.collection('staff_list').orderBy('order').get();
  if(snap.empty){ tbody.innerHTML='<tr class="empty-row"><td colspan="4">Belum ada staff.</td></tr>'; return; }
  tbody.innerHTML=snap.docs.map(d=>{ const s=d.data(); return `<tr><td><span class="${roleClass(s.role)}">${escH(s.name||'')}</span></td><td>${roleName(s.role)}</td><td style="font-size:10.5px;color:var(--text3)">${escH(s.desc||'')}</td><td><button class="action-btn r" onclick="removeStaff('${d.id}')">Hapus</button></td></tr>`; }).join('');
}
async function addStaff(){ const name=document.getElementById('staffName').value.trim(), role=document.getElementById('staffRoleInput').value, desc=document.getElementById('staffDesc').value.trim(); if(!name){ toast('Isi nama!','error'); return; } const count=(await DB.collection('staff_list').get()).size; await DB.collection('staff_list').add({ name, role, desc, order:count, createdAt:firebase.firestore.FieldValue.serverTimestamp() }); toast('Staff ditambahkan!','success'); document.getElementById('staffName').value=''; document.getElementById('staffDesc').value=''; loadStaffAdmin(); }
async function removeStaff(id){ if(!confirm('Hapus staff ini?')) return; await DB.collection('staff_list').doc(id).delete(); toast('Staff dihapus.','info'); loadStaffAdmin(); }

// ============================
// SETTINGS FORM
// ============================
function loadSettingsForm(){
  const c=appConfig;
  ['cfgServerIP','cfgServerName','cfgDiscord','cfgWA','cfgCooldown','cfgWLRequirements','cfgCSInfo','cfgCSSchedules','cfgCSMinWords','cfgCSPanduan','cfgImportInfo','cfgImportRequirements'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; const key=id.replace('cfg',''); const cKey=key.charAt(0).toLowerCase()+key.slice(1); if(el.tagName==='TEXTAREA'||el.type==='text'||el.type==='number') el.value=c[cKey]||''; });
  ['cfgWLOpen','cfgCSOpen','cfgImportOpen','cfgGoodsideOpen','cfgBadsideOpen','cfgFamilyOpen'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; const key=id.replace('cfg',''); const cKey=key.charAt(0).toLowerCase()+key.slice(1); el.value=c[cKey]?'1':'0'; });
}
async function saveConfig(){ const data={ serverIP:document.getElementById('cfgServerIP').value.trim(), serverName:document.getElementById('cfgServerName').value.trim(), discord:document.getElementById('cfgDiscord').value.trim(), waContact:document.getElementById('cfgWA').value.trim(), postCooldownMin:parseInt(document.getElementById('cfgCooldown').value)||60 }; await DB.collection('config').doc('main').set(data,{merge:true}); Object.assign(appConfig,data); applyConfig(); await addLog('SYSTEM','Config server diperbarui'); toast('Config tersimpan!','success'); }
async function saveWLConfig(){ const data={ wlOpen:document.getElementById('cfgWLOpen').value==='1', wlRequirements:document.getElementById('cfgWLRequirements').value.trim() }; await DB.collection('config').doc('main').set(data,{merge:true}); Object.assign(appConfig,data); applyConfig(); await addLog('SYSTEM','Config WL diperbarui'); toast('Config WL tersimpan!','success'); }
async function saveCSConfig(){ const data={ csOpen:document.getElementById('cfgCSOpen').value==='1', csInfo:document.getElementById('cfgCSInfo').value.trim(), csSchedules:document.getElementById('cfgCSSchedules').value.trim(), csMinWords:parseInt(document.getElementById('cfgCSMinWords').value)||150, csPanduan:document.getElementById('cfgCSPanduan').value.trim() }; await DB.collection('config').doc('main').set(data,{merge:true}); Object.assign(appConfig,data); applyConfig(); await addLog('SYSTEM','Config CS diperbarui'); toast('Config CS tersimpan!','success'); }
async function saveImportConfig(){ const data={ importOpen:document.getElementById('cfgImportOpen').value==='1', goodsideOpen:document.getElementById('cfgGoodsideOpen').value==='1', badsideOpen:document.getElementById('cfgBadsideOpen').value==='1', familyOpen:document.getElementById('cfgFamilyOpen').value==='1', importInfo:document.getElementById('cfgImportInfo').value.trim(), importRequirements:document.getElementById('cfgImportRequirements').value.trim() }; await DB.collection('config').doc('main').set(data,{merge:true}); Object.assign(appConfig,data); applyConfig(); await addLog('SYSTEM','Config Import diperbarui'); toast('Config Import tersimpan!','success'); }

// ============================
// TABLE FILTER
// ============================
function filterTable(tableId,q){ const tbody=document.getElementById(tableId)?.querySelector('tbody'); if(!tbody) return; tbody.querySelectorAll('tr').forEach(tr=>{ tr.style.display=tr.textContent.toLowerCase().includes(q.toLowerCase())||tr.classList.contains('empty-row')?'':'none'; }); }

// ============================
// UTILS
// ============================
function copyToClip(text){ navigator.clipboard.writeText(text).then(()=>toast('Tersalin!','success')); }

// ============================
// INIT
// ============================
window.addEventListener('DOMContentLoaded',()=>{
  // Load initial data based on URL hash or default
  const page=location.hash.replace('#','');
  if(page) showPage(page); else showPage('forums');
  // Loader
  setTimeout(()=>document.getElementById('loader').classList.add('hidden'),900);
  // Check WL status when whitelist page viewed
  document.querySelectorAll('a[onclick*="whitelist"]').forEach(el=>{ el.addEventListener('click',()=>setTimeout(checkMyWL,100)); });
  // Check CS status
  document.querySelectorAll('a[onclick*="cs"]').forEach(el=>{ el.addEventListener('click',()=>setTimeout(checkMyCS,100)); });
  // Profile page
  document.querySelectorAll('a[onclick*="profile"]').forEach(el=>{ el.addEventListener('click',()=>setTimeout(loadProfilePage,100)); });
  // Load initial rules
  setTimeout(()=>loadGuides('rules'),500);
});
// Programmatic tab override for rules
const origShowPage=window.showPage;
window.showPage=function(name,navEl){
  origShowPage(name,navEl);
  if(name==='whitelist') setTimeout(checkMyWL,100);
  if(name==='cs') setTimeout(checkMyCS,100);
  if(name==='profile') setTimeout(loadProfilePage,100);
  if(name==='rules') setTimeout(()=>loadGuides('rules'),100);
};
</script>
</body>
</html>

