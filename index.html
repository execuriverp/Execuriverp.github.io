<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Miracle Community Forum</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyD5JGQ3eARM5Lo2IG3mkpdx7p3uh0nrBIk",
  authDomain:"samp-miracle.firebaseapp.com",
  databaseURL:"https://samp-miracle-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"samp-miracle",
  storageBucket:"samp-miracle.firebasestorage.app",
  messagingSenderId:"465126706451",
  appId:"1:465126706451:web:b94f2359a348ff7078dee6"
});
const DB=firebase.database();
</script>
<style>
:root{
--bg:#09090E;--bg2:#0F0F18;--bg3:#161622;--bg4:#1E1E2E;--bg5:#252535;
--b:rgba(255,255,255,.07);--b2:rgba(255,255,255,.04);--b3:rgba(255,255,255,.14);
--t:#DCDCE8;--t2:#9898B0;--t3:#5A5A72;
--acc:#fff;--gold:#FFD700;--or:#FF6B00;--red:#E63946;--grn:#25D366;--blu:#64b4ff;--pur:#b464ff;--cya:#00C9B1;
--r:3px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--t);font-family:'Segoe UI',system-ui,sans-serif;font-size:14px;line-height:1.5;min-height:100vh}
a{color:inherit;text-decoration:none}
::-webkit-scrollbar{width:3px;height:3px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1)}

/* TOPBAR */
#topbar{background:rgba(9,9,14,.97);border-bottom:1px solid var(--b);position:sticky;top:0;z-index:200;backdrop-filter:blur(10px)}
.tb{display:flex;align-items:center;height:50px;gap:4px;padding:0 16px;max-width:1200px;margin:0 auto}
.logo{font-size:15px;font-weight:800;letter-spacing:3px;color:#fff;cursor:pointer;flex-shrink:0;margin-right:10px}
.logo em{color:var(--t3);font-style:normal;font-weight:400;font-size:10px;letter-spacing:0;margin-left:4px}
.mnav{display:flex;align-items:center;gap:1px;flex:1;overflow-x:auto;scrollbar-width:none}
.mnav::-webkit-scrollbar{display:none}
.mnav a{padding:5px 9px;color:var(--t2);font-size:11.5px;border-radius:var(--r);white-space:nowrap;cursor:pointer;transition:all .1s}
.mnav a:hover,.mnav a.act{color:#fff;background:var(--bg3)}
.tbr{display:flex;align-items:center;gap:6px;flex-shrink:0;margin-left:8px}

/* HAMBURGER */
.hbg{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:6px;background:none;border:none}
.hbg span{display:block;width:16px;height:1.5px;background:var(--t2)}
.mbo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300}
.mbo.open{display:block}
.mbnav{position:fixed;top:0;left:0;width:240px;height:100vh;background:var(--bg2);border-right:1px solid var(--b);z-index:301;padding:10px 8px;overflow-y:auto;transform:translateX(-100%);transition:transform .2s}
.mbnav.open{transform:translateX(0)}
.mbnav a{display:flex;align-items:center;gap:8px;padding:8px 10px;color:var(--t2);border-radius:var(--r);font-size:12px;cursor:pointer;transition:all .08s}
.mbnav a:hover{background:var(--bg3);color:#fff}
.mb-logo{font-size:13px;font-weight:800;letter-spacing:3px;padding:4px 10px 12px;border-bottom:1px solid var(--b);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
.mb-cls{background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer}

/* LAYOUT */
.wrap{max-width:1200px;margin:0 auto;padding:0 16px}
.playout{display:flex;gap:16px;padding:14px 0 40px;align-items:flex-start}
.mcol{flex:1;min-width:0}
.scol{width:230px;flex-shrink:0;display:flex;flex-direction:column;gap:8px}

/* CARD */
.card{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r)}
.wgt{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r);overflow:hidden}
.wgt-ttl{padding:7px 11px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);border-bottom:1px solid var(--b)}
.wgt-body{padding:9px 11px}
.srow{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--b2);font-size:11.5px}
.srow:last-child{border-bottom:none}
.srow .sv{font-weight:700;color:#fff}

/* FORUM ROW */
.frow{display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid var(--b2);gap:10px;cursor:pointer;transition:background .08s}
.frow:last-child{border-bottom:none}
.frow:hover{background:var(--bg3)}
.fi{width:32px;height:32px;border-radius:var(--r);background:var(--bg3);border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.fn{flex:1;min-width:0}
.fn-name{font-size:12.5px;font-weight:600;color:#fff;margin-bottom:2px}
.fn-desc{font-size:10.5px;color:var(--t3)}
.fstat{text-align:right;flex-shrink:0}
.fstat .cnt{font-size:13px;font-weight:700;display:block}
.fstat .lbl{font-size:9.5px;color:var(--t3)}

/* BTN */
.btn{display:inline-flex;align-items:center;gap:4px;padding:5px 11px;border:1px solid var(--b3);border-radius:var(--r);font-size:11.5px;cursor:pointer;transition:all .1s;background:transparent;color:var(--t2);font-family:inherit;white-space:nowrap}
.btn:hover{color:#fff;background:var(--bg3)}
.btn-p{background:#fff;color:#000;border-color:#fff;font-weight:700}
.btn-p:hover{background:#ddd;color:#000}
.btn-d{color:var(--red);border-color:rgba(230,57,70,.3)}
.btn-d:hover{background:var(--red);color:#fff}
.btn-g{color:var(--grn);border-color:rgba(37,211,102,.3)}
.btn-g:hover{background:var(--grn);color:#000}
.btn-sm{padding:3px 8px;font-size:10.5px}
.btn:disabled{opacity:.4;cursor:not-allowed}

/* FORMS */
.fgrp{display:flex;flex-direction:column;gap:3px;margin-bottom:10px}
.flbl{font-size:10.5px;font-weight:600;color:var(--t2)}
.finp{background:var(--bg3);border:1px solid var(--b);border-radius:var(--r);padding:7px 9px;color:#fff;font-size:12.5px;font-family:inherit;outline:none;transition:border-color .1s;width:100%}
.finp:focus{border-color:rgba(255,255,255,.18)}
select.finp option{background:var(--bg3)}
textarea.finp{resize:vertical;min-height:80px}

/* BADGE */
.bdg{font-size:9.5px;font-weight:700;letter-spacing:.6px;padding:2px 6px;display:inline-block;border-radius:var(--r)}
.b-pending{background:rgba(255,215,0,.08);color:var(--gold);border:1px solid rgba(255,215,0,.2)}
.b-process{background:rgba(100,180,255,.08);color:var(--blu);border:1px solid rgba(100,180,255,.2)}
.b-accepted{background:rgba(37,211,102,.08);color:var(--grn);border:1px solid rgba(37,211,102,.2)}
.b-rejected,.b-denied{background:rgba(230,57,70,.08);color:var(--red);border:1px solid rgba(230,57,70,.2)}
.b-banned{background:rgba(230,57,70,.14);color:var(--red);border:1px solid rgba(230,57,70,.3)}
.b-open{background:rgba(37,211,102,.08);color:var(--grn);border:1px solid rgba(37,211,102,.2)}

/* ROLE */
.r-owner{color:#ff6b6b;font-weight:700}.r-developer{color:var(--blu);font-weight:700}
.r-headadmin,.r-senioradmin,.r-admin,.r-junioradmin{color:var(--red);font-weight:700}
.r-management{color:var(--pur);font-weight:700}.r-moderator{color:var(--or);font-weight:700}
.r-communityhandle,.r-seniorhelper,.r-helper,.r-juniorhelper,.r-volunteer{color:var(--cya);font-weight:600}
.r-vip{color:var(--gold);font-weight:600}.r-user,.r-exstaff{color:var(--t2)}

/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--b);margin-bottom:12px}
.tbn{padding:7px 13px;font-size:11.5px;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;background:none;border-top:none;border-left:none;border-right:none;font-family:inherit;transition:all .1s}
.tbn:hover{color:var(--t)}
.tbn.act{color:#fff;border-bottom-color:#fff}
.tpanel{display:none}.tpanel.act{display:block}

/* INFO BOX */
.ibox{background:var(--bg3);border:1px solid var(--b);border-radius:var(--r);padding:9px 11px;font-size:11.5px;color:var(--t2);margin-bottom:10px}
.ibox.warn{border-left:2px solid var(--or);color:var(--or)}
.ibox.closed{border-left:2px solid var(--red);color:var(--red)}
.ibox.ok{border-left:2px solid var(--grn);color:var(--grn)}

/* ANN BAR */
.annbar{background:var(--bg2);border:1px solid var(--b);border-left:2px solid #fff;border-radius:var(--r);padding:8px 11px;font-size:11.5px;color:var(--t2);margin-bottom:12px;display:flex;align-items:center;gap:8px}

/* FEED */
.composer{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r);padding:12px;margin-bottom:8px}
.comp-inp{width:100%;background:var(--bg3);border:1px solid var(--b);border-radius:var(--r);padding:8px 10px;color:#fff;font-size:12.5px;font-family:inherit;outline:none;resize:none;transition:border-color .1s}
.comp-inp:focus{border-color:rgba(255,255,255,.15)}
.img-preview{margin-top:8px;position:relative;display:none}
.img-preview img{max-height:200px;border-radius:var(--r);border:1px solid var(--b)}
.img-remove{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.7);border:none;color:#fff;width:20px;height:20px;border-radius:50%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.pcard{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r);margin-bottom:7px}
.phdr{display:flex;align-items:center;gap:9px;padding:11px 13px 0}
.pava{width:34px;height:34px;border-radius:50%;background:var(--bg3);border:1px solid var(--b);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--t2);overflow:hidden}
.pava img{width:100%;height:100%;object-fit:cover}
.pbody{padding:8px 13px;font-size:12.5px;color:var(--t2);line-height:1.65;white-space:pre-wrap;word-break:break-word}
.post-img{max-width:100%;max-height:400px;display:block;margin:8px 13px;border-radius:var(--r);border:1px solid var(--b);cursor:pointer}
.pact{display:flex;align-items:center;gap:5px;padding:7px 13px 9px;border-top:1px solid var(--b2)}
.rbtn{background:none;border:1px solid var(--b);border-radius:20px;padding:3px 9px;font-size:11.5px;color:var(--t3);cursor:pointer;font-family:inherit;transition:all .1s}
.rbtn:hover{border-color:var(--b3);color:var(--t2)}
.rbtn.liked{border-color:rgba(230,57,70,.3);color:var(--red);background:rgba(230,57,70,.05)}
.pcmts{border-top:1px solid var(--b2);padding:8px 13px}
.cmt-item{display:flex;gap:6px;margin-bottom:6px}
.cmt-av{width:24px;height:24px;border-radius:50%;background:var(--bg3);border:1px solid var(--b);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700}
.cmt-bdy{background:var(--bg3);border-radius:var(--r);padding:5px 9px;flex:1}
.cmt-auth{font-size:10px;font-weight:600;color:#fff;margin-bottom:1px}
.cmt-txt{font-size:11.5px;color:var(--t2)}
.cmt-inp{flex:1;background:var(--bg3);border:1px solid var(--b);border-radius:20px;padding:5px 11px;color:#fff;font-size:11.5px;font-family:inherit;outline:none}

/* IMG MODAL */
.img-modal-img{max-width:100%;max-height:80vh;border-radius:var(--r)}

/* WL STEPS */
.wlsteps{display:flex;align-items:center;margin-bottom:16px}
.wlstep{display:flex;align-items:center;flex:1}
.wlstep-c{width:26px;height:26px;border-radius:50%;border:1.5px solid var(--b3);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--t3);flex-shrink:0}
.wlstep-l{font-size:9.5px;color:var(--t3);margin-left:5px;white-space:nowrap}
.wlstep.done .wlstep-c{background:var(--grn);border-color:var(--grn);color:#000}
.wlstep.done .wlstep-l{color:var(--grn)}
.wlstep.act .wlstep-c{border-color:#fff;color:#fff}
.wlstep.act .wlstep-l{color:#fff}
.wlline{flex:1;height:1px;background:var(--b);margin:0 5px}

/* STAFF */
.sgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
.scard{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r);padding:13px;text-align:center;transition:border-color .1s}
.scard:hover{border-color:var(--b3)}
.scard-av{width:46px;height:46px;border-radius:50%;background:var(--bg3);border:1.5px solid var(--b);margin:0 auto 7px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700}
.scard-name{font-size:12.5px;font-weight:600;margin-bottom:2px}
.scard-role{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}

/* LB */
.lbrow{display:flex;align-items:center;gap:9px;padding:9px 12px;border-bottom:1px solid var(--b2);transition:background .08s}
.lbrow:hover{background:var(--bg3)}.lbrow:last-child{border-bottom:none}
.lbrank{width:22px;text-align:center;font-size:12px;font-weight:700;color:var(--t3);flex-shrink:0}
.lbrank.r1{color:var(--gold)}.lbrank.r2{color:#ccc}.lbrank.r3{color:#cd7f32}
.lbav{width:32px;height:32px;border-radius:50%;background:var(--bg3);border:1px solid var(--b);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;overflow:hidden}
.lbav img{width:100%;height:100%;object-fit:cover}
.lbi{flex:1;min-width:0}.lbn{font-size:12.5px;font-weight:600}.lbs{font-size:10px;color:var(--t3)}
.lbv{font-size:12.5px;font-weight:700;color:var(--grn);flex-shrink:0}

/* MODAL */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:500;align-items:center;justify-content:center;padding:1rem}
.mo.open{display:flex}
.mdl{background:var(--bg2);border:1px solid var(--b3);border-radius:var(--r);width:90%;max-width:440px;max-height:90vh;overflow-y:auto;animation:mIn .18s ease}
.mdl.wide{max-width:560px}
@keyframes mIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.mhdr{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;border-bottom:1px solid var(--b)}
.mtitle{font-size:13px;font-weight:700;color:#fff}
.mclose{background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer;line-height:1}
.mclose:hover{color:#fff}
.mbody{padding:14px 15px}
.mfoot{padding:10px 15px;border-top:1px solid var(--b);display:flex;gap:7px;justify-content:flex-end}
.drow{display:flex;gap:8px;margin-bottom:5px;font-size:12px}
.dk{font-size:10px;color:var(--t2);min-width:110px;padding-top:.1rem;flex-shrink:0}
.dv{color:#fff;font-weight:600;flex:1;word-break:break-all}
.dstory{background:var(--bg3);border:1px solid var(--b);border-radius:var(--r);padding:8px;font-size:11.5px;color:#fff;line-height:1.65;max-height:180px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}

/* IMPORT TYPES */
.imp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:12px}
.imp-btn{background:var(--bg3);border:1.5px solid var(--b);border-radius:var(--r);padding:10px 6px;text-align:center;cursor:pointer;transition:all .13s}
.imp-btn:hover{border-color:var(--b3)}
.imp-btn.sel{border-color:#fff;background:rgba(255,255,255,.04)}
.imp-btn.dis{opacity:.3;pointer-events:none}
.it-icon{font-size:20px;margin-bottom:4px}
.it-lbl{font-size:10.5px;font-weight:600;color:var(--t2)}

/* ANN CARD */
.ann-card{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r);padding:15px;margin-bottom:8px}
.ann-tag{font-size:9.5px;font-weight:700;padding:2px 6px;border-radius:var(--r);display:inline-block;margin-bottom:7px}
.ann-ttl{font-size:13.5px;font-weight:700;color:#fff;margin-bottom:7px}
.ann-body{font-size:12px;color:var(--t2);line-height:1.7;white-space:pre-wrap}
.ann-meta{font-size:10px;color:var(--t3);margin-top:8px}

/* GUIDE CARD */
.gcard{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r);padding:15px;margin-bottom:8px}
.gtag{font-size:9px;font-weight:700;letter-spacing:.8px;padding:2px 6px;border:1px solid var(--b);border-radius:var(--r);display:inline-block;margin-bottom:6px;color:var(--t3)}
.gttl{font-size:13px;font-weight:700;color:#fff;margin-bottom:8px}
.gbody{font-size:12px;color:var(--t2);line-height:1.7;white-space:pre-wrap}

/* PROFILE */
.pbanner{height:90px;background:linear-gradient(135deg,#0a0a14,#14141f 50%,#090912);border-bottom:1px solid var(--b);position:relative}
.phead{display:flex;align-items:flex-end;gap:12px;padding:0 16px 12px;margin-top:-28px;position:relative}
.pava{width:68px;height:68px;border-radius:50%;border:2.5px solid var(--bg2);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:var(--t2);overflow:hidden;flex-shrink:0}
.pava img{width:100%;height:100%;object-fit:cover}

/* ADMIN LAYOUT */
.adm-wrap{display:flex;min-height:calc(100vh - 50px);flex-direction:row}
.adm-sb{width:195px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--b);overflow-y:auto;display:flex;flex-direction:column}
.adm-sb-inner{padding:10px 0;flex:1}
.adm-sec{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--t3);padding:8px 12px 3px;margin-top:4px}
.adm-itm{display:flex;align-items:center;gap:6px;padding:7px 12px;font-size:11.5px;color:var(--t2);cursor:pointer;transition:all .07s;border:none;background:none;width:100%;text-align:left;border-left:2px solid transparent;font-family:inherit;position:relative}
.adm-itm:hover{background:rgba(255,255,255,.02);color:var(--t)}
.adm-itm.act{color:#fff;background:rgba(255,255,255,.03);border-left-color:#fff}
.adm-badge{margin-left:auto;background:var(--red);color:#fff;font-size:8.5px;padding:1px 5px;border-radius:8px;min-width:14px;text-align:center}
.adm-content{flex:1;padding:18px 20px;overflow:auto;min-width:0}
.adm-tab{display:none}.adm-tab.act{display:block}
.adm-title{font-size:16px;font-weight:700;color:#fff;margin-bottom:3px}
.adm-sub{font-size:10.5px;color:var(--t3);margin-bottom:14px}

/* ADMIN CARDS */
.adm-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:16px}
.acard{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r);padding:12px}
.acard .acl{font-size:9.5px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.acard .acv{font-size:24px;font-weight:700;color:#fff}

/* MOBILE ADMIN HEADER */
.adm-mob-hdr-outer{display:none}
.adm-mob-ttl{font-size:13px;font-weight:700;color:#fff}

/* TABLE */
.twrap{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r);overflow:hidden;overflow-x:auto;margin-bottom:12px;-webkit-overflow-scrolling:touch;max-width:100%}
.thdr{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--b);flex-wrap:wrap;gap:6px}
.ttitle{font-size:11px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:#fff}
.tsrch{background:var(--bg3);border:1px solid var(--b);color:#fff;padding:5px 9px;font-size:11px;font-family:inherit;outline:none;border-radius:var(--r);width:160px}
.tsrch:focus{border-color:rgba(255,255,255,.14)}
table{width:100%;border-collapse:collapse;min-width:400px}
th{background:var(--bg3);padding:7px 10px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);text-align:left;border-bottom:1px solid var(--b)}
td{padding:8px 10px;font-size:11.5px;color:var(--t2);border-bottom:1px solid var(--b2);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.01)}
.empty-row td{text-align:center;color:var(--t3);font-size:11px;padding:1.5rem}
.atb{background:none;border:1px solid var(--b);color:var(--t2);padding:3px 7px;font-size:10px;cursor:pointer;border-radius:var(--r);font-family:inherit;transition:all .1s;white-space:nowrap}
.atb:hover{border-color:#fff;color:#fff}
.atb.r:hover{border-color:var(--red);color:var(--red)}
.atb.g:hover{border-color:var(--grn);color:var(--grn)}

/* LOGS */
.logstream{background:var(--bg);border:1px solid var(--b);padding:8px;max-height:380px;overflow-y:auto;font-family:'Courier New',monospace;font-size:10.5px}
.log-line{padding:2.5px 0;border-bottom:1px solid rgba(255,255,255,.025);display:flex;gap:8px;align-items:flex-start}
.log-time{color:var(--t3);min-width:110px;flex-shrink:0;font-size:9.5px}
.log-type{min-width:52px;flex-shrink:0;font-weight:700;font-size:9.5px}
.log-type.AUTH{color:var(--blu)}.log-type.WL,.log-type.WL_REVIEW{color:var(--gold)}
.log-type.BAN{color:var(--red)}.log-type.ACCEPT{color:var(--grn)}
.log-type.DENY,.log-type.REJECT{color:var(--or)}.log-type.ROLE{color:var(--pur)}
.log-type.CS,.log-type.CS_REVIEW{color:var(--cya)}.log-type.IMPORT{color:#6DD5A8}
.log-type.SYSTEM{color:var(--t2)}.log-type.NEWS{color:var(--pur)}.log-type.POST{color:var(--blu)}
.log-msg{color:#fff;flex:1;line-height:1.4;font-size:10.5px}

/* ADMIN CHAT */
.adm-chat{display:flex;flex-direction:column;height:55vh;border:1px solid var(--b);border-radius:var(--r);min-height:300px}
.adm-chat-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:7px;background:var(--bg3)}
.adm-msg{max-width:72%;padding:7px 10px;border-radius:var(--r)}
.adm-msg.mine{align-self:flex-end;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1)}
.adm-msg.theirs{align-self:flex-start;background:var(--bg2);border:1px solid var(--b)}
.adm-msg-meta{font-size:9px;color:var(--t2);margin-bottom:2px}
.adm-msg-txt{font-size:11.5px;color:#fff;line-height:1.5;word-break:break-word}
.adm-msg-time{font-size:9px;color:var(--t3);margin-top:2px}
.adm-chat-inp{display:flex;gap:6px;padding:9px 12px;background:var(--bg2);border-top:1px solid var(--b)}
.adm-chat-inp input{flex:1;background:var(--bg3);border:1px solid var(--b);border-radius:var(--r);padding:7px 10px;color:#fff;font-family:inherit;font-size:12px;outline:none}
.adm-chat-inp button{background:#fff;color:#000;border:none;padding:7px 14px;font-size:11.5px;font-weight:700;cursor:pointer;border-radius:var(--r)}

/* SETTINGS */
.sgrd{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.sc{background:var(--bg2);border:1px solid var(--b);border-radius:var(--r);padding:14px}
.sc-ttl{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--b)}

/* PERM CHIPS */
.perm-tag{font-size:10px;padding:3px 8px;cursor:pointer;user-select:none;display:inline-block;margin:2px;border-radius:var(--r);transition:all .1s}
.perm-tag.on{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.22);color:#fff}
.perm-tag.off{background:none;border:1px solid var(--b);color:var(--t3)}
.role-chip{font-size:10px;padding:4px 9px;cursor:pointer;border:1px solid var(--b);color:var(--t2);display:inline-block;margin:2px;border-radius:var(--r);transition:all .1s}
.role-chip:hover{border-color:var(--b3)}
.role-chip.sel{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.25);color:#fff}

/* TOAST */
.toast-wrap{position:fixed;bottom:18px;right:18px;z-index:600;display:flex;flex-direction:column;gap:7px}
.toast{background:var(--bg2);border:1px solid var(--b3);border-radius:var(--r);padding:9px 14px;font-size:11.5px;color:#fff;display:flex;align-items:center;gap:7px;min-width:180px;animation:tIn .18s ease}
.toast.s{border-left:2px solid var(--grn)}.toast.e{border-left:2px solid var(--red)}.toast.i{border-left:2px solid var(--blu)}
@keyframes tIn{from{transform:translateX(14px);opacity:0}to{transform:none;opacity:1}}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;transition:opacity .4s}
#loader.hidden{opacity:0;pointer-events:none;visibility:hidden}
.ld-logo{font-size:18px;font-weight:800;letter-spacing:4px;color:#fff}
.ld-bar{width:140px;height:1.5px;background:var(--b);border-radius:2px;overflow:hidden}
.ld-fill{height:100%;background:#fff;animation:lb 1s ease-in-out forwards}
@keyframes lb{0%{width:0}100%{width:100%}}

/* PAGES */
.page{display:none}.page.act{display:block}

/* SRV BLOCK */
.srv-blk{padding:8px;border:1px solid var(--b);border-radius:var(--r);margin-bottom:6px;cursor:pointer;transition:border-color .1s}
.srv-blk:hover{border-color:var(--b3)}
.srv-blk:last-child{margin-bottom:0}
.srv-tp{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);margin-bottom:2px}
.srv-addr{font-family:'Courier New',monospace;color:#fff;font-size:11.5px}

/* RESPONSIVE */
@media(max-width:900px){.scol{display:none}}
@media(max-width:768px){
  .hbg{display:flex}.mnav{display:none}
  .sgrd{grid-template-columns:1fr}
  .adm-sb{display:none!important}
  .adm-mob-hdr-outer{display:block!important}
  .adm-wrap{flex-direction:column!important;min-height:unset}
  .adm-content{padding:10px 12px;width:100%;box-sizing:border-box}
  .adm-cards{grid-template-columns:repeat(2,1fr)}
  .twrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{min-width:500px;font-size:11px}
  .thdr{flex-direction:column;align-items:stretch;gap:6px}
  .tsrch{width:100%!important;box-sizing:border-box}
  .annAdmGrid,.guideAdmGrid,.staffAdmGrid{grid-template-columns:1fr!important}
  .imp-grid{grid-template-columns:repeat(3,1fr)}
  .mdl-inner{width:92vw!important;max-width:92vw!important}
  .mfoot{flex-wrap:wrap;gap:6px}
  .adm-chat{height:50vh}
  .adm-mob-menu{max-height:70vh;overflow-y:auto}
}
@media(max-width:480px){
  .adm-cards{grid-template-columns:repeat(2,1fr)}
  .playout{padding:8px 0 30px}
  .wrap{padding:0 8px}
  .acard .acv{font-size:20px}
  table{min-width:400px;font-size:10.5px}
}
  .playout{padding:8px 0 30px}
  .wrap{padding:0 10px}
  .sgrd{grid-template-columns:repeat(2,1fr)}
  .imp-grid{grid-template-columns:repeat(3,1fr)}
  .btn{padding:4px 9px;font-size:11px}
  .wlstep-l{display:none}
  .adm-cards{grid-template-columns:1fr 1fr}
  .acard .acv{font-size:20px}
}
</style>
</head>
<body>

<div id="loader"><div class="ld-logo">MIRACLE</div><div class="ld-bar"><div class="ld-fill"></div></div></div>
<div class="toast-wrap" id="toastWrap"></div>

<!-- MODALS -->
<div class="mo" id="moLogin">
  <div class="mdl"><div class="mhdr"><div class="mtitle">Login / Daftar</div><button class="mclose" onclick="cm('moLogin')">‚úï</button></div>
  <div class="mbody"><p style="font-size:11.5px;color:var(--t2);margin-bottom:14px">Login dengan akun Google kamu untuk bergabung.</p>
  <button class="btn btn-p" style="width:100%;justify-content:center;padding:10px;font-size:13px" onclick="loginGoogle()">
  <svg width="14" height="14" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
  Masuk dengan Google</button></div></div>
</div>
<div class="mo" id="moWL">
  <div class="mdl wide"><div class="mhdr"><div class="mtitle">Detail Whitelist</div><button class="mclose" onclick="cm('moWL')">‚úï</button></div>
  <div class="mbody" id="wlDetailBody"></div><div class="mfoot" id="wlDetailAct"></div></div>
</div>
<div class="mo" id="moCS">
  <div class="mdl wide"><div class="mhdr"><div class="mtitle">Detail CS Request</div><button class="mclose" onclick="cm('moCS')">‚úï</button></div>
  <div class="mbody" id="csDetailBody"></div><div class="mfoot" id="csDetailAct"></div></div>
</div>
<div class="mo" id="moImport">
  <div class="mdl wide"><div class="mhdr"><div class="mtitle">Detail Import Request</div><button class="mclose" onclick="cm('moImport')">‚úï</button></div>
  <div class="mbody" id="impDetailBody"></div><div class="mfoot" id="impDetailAct"></div></div>
</div>
<div class="mo" id="moRole">
  <div class="mdl wide"><div class="mhdr"><div class="mtitle">Kelola Role & Permission</div><button class="mclose" onclick="cm('moRole')">‚úï</button></div>
  <div class="mbody">
    <p style="font-size:11px;color:var(--t2);margin-bottom:10px" id="roleInfo"></p>
    <div style="margin-bottom:12px"><div class="flbl" style="margin-bottom:5px">Role</div><div id="roleSelect" style="display:flex;flex-wrap:wrap;gap:3px"></div></div>
    <div><div class="flbl" style="margin-bottom:5px">Permissions</div><div id="permSelect" style="display:flex;flex-wrap:wrap;gap:2px"></div></div>
  </div>
  <div class="mfoot"><button class="btn" onclick="cm('moRole')">Batal</button><button class="btn btn-p" onclick="confirmRole()">Simpan</button></div></div>
</div>
<div class="mo" id="moBan">
  <div class="mdl"><div class="mhdr"><div class="mtitle" style="color:var(--red)">Ban User</div><button class="mclose" onclick="cm('moBan')">‚úï</button></div>
  <div class="mbody"><p style="font-size:11.5px;color:var(--t2);margin-bottom:10px" id="banInfo"></p>
  <div class="fgrp"><label class="flbl">Alasan Ban</label><input type="text" class="finp" id="banReason" placeholder="Alasan..."></div></div>
  <div class="mfoot"><button class="btn" onclick="cm('moBan')">Batal</button><button class="btn btn-d" onclick="confirmBan()">Ban</button></div></div>
</div>
<div class="mo" id="moIC">
  <div class="mdl"><div class="mhdr"><div class="mtitle">Edit Nama IC</div><button class="mclose" onclick="cm('moIC')">‚úï</button></div>
  <div class="mbody"><p style="font-size:11px;color:var(--t2);margin-bottom:10px" id="icInfo"></p>
  <div class="fgrp"><label class="flbl">Nama IC Baru</label><input type="text" class="finp" id="icInput" placeholder="Nama_IC"></div></div>
  <div class="mfoot"><button class="btn" onclick="cm('moIC')">Batal</button><button class="btn btn-p" onclick="confirmIC()">Simpan</button></div></div>
</div>
<div class="mo" id="moImg">
  <div class="mdl" style="background:transparent;border:none;max-width:90vw;width:auto">
    <button onclick="cm('moImg')" style="position:absolute;top:-28px;right:0;background:none;border:none;color:#fff;font-size:20px;cursor:pointer">‚úï</button>
    <img id="moImgSrc" class="img-modal-img" src="">
  </div>
</div>

<!-- MOBILE NAV -->
<div class="mbo" id="mbo" onclick="closeMob()"></div>
<nav class="mbnav" id="mbnav">
  <div class="mb-logo">MIRACLE RP<button class="mb-cls" onclick="closeMob()">‚úï</button></div>
  <a onclick="nav('home');closeMob()">üè† Home</a>
  <a onclick="nav('feed');closeMob()">üì∞ Feed</a>
  <a onclick="nav('whitelist');closeMob()">üìã Whitelist</a>
  <a onclick="nav('cs');closeMob()">üé≠ Character Story</a>
  <a onclick="nav('import');closeMob()">üì¶ Import</a>
  <a onclick="nav('staff');closeMob()">üë• Staff</a>
  <a onclick="nav('leaderboard');closeMob()">üèÜ Leaderboard</a>
  <a onclick="nav('report');closeMob()">üö© Report</a>
  <a onclick="nav('announcements');closeMob()">üì¢ Pengumuman</a>
  <a onclick="nav('rules');closeMob()">üìú Rules</a>
  <a id="admMobLink" onclick="nav('admin');closeMob()" style="display:none">‚öôÔ∏è Admin Panel</a>
</nav>

<!-- TOPBAR -->
<div id="topbar">
  <div class="tb">
    <button class="hbg" onclick="openMob()"><span></span><span></span><span></span></button>
    <div class="logo" onclick="nav('home')">MIRACLE<em>RP</em></div>
    <nav class="mnav" id="mainNav">
      <a onclick="nav('home')" data-p="home" class="act">Home</a>
      <a onclick="nav('feed')" data-p="feed">Feed</a>
      <a onclick="nav('whitelist')" data-p="whitelist">Whitelist</a>
      <a onclick="nav('cs')" data-p="cs">C.Story</a>
      <a onclick="nav('import')" data-p="import">Import</a>
      <a onclick="nav('staff')" data-p="staff">Staff</a>
      <a onclick="nav('leaderboard')" data-p="leaderboard">LB</a>
      <a onclick="nav('report')" data-p="report">Report</a>
      <a onclick="nav('announcements')" data-p="announcements">Pengumuman</a>
      <a id="admNavLink" onclick="nav('admin')" data-p="admin" style="display:none">Admin</a>
    </nav>
    <div class="tbr" id="tbRight">
      <button class="btn" onclick="om('moLogin')">Masuk</button>
      <button class="btn btn-p" onclick="om('moLogin')">Daftar</button>
    </div>
  </div>
</div>

<div class="wrap">

<!-- HOME -->
<div class="page act" id="page-home">
  <div class="playout">
    <div class="mcol">
      <div class="annbar" id="topAnnBar" style="display:none"><span>üì¢</span><span id="topAnnTxt"></span></div>
      <div style="margin-bottom:12px">
        <div style="font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--t3);padding-bottom:6px;border-bottom:1px solid var(--b);margin-bottom:3px">Miracle Roleplay</div>
        <div class="card">
          <div class="frow" onclick="nav('feed')"><div class="fi">üì∞</div><div class="fn"><div class="fn-name">Community Feed</div><div class="fn-desc">Update, cerita dan diskusi komunitas</div></div><div class="fstat"><span class="cnt" id="hPosts">‚Äî</span><span class="lbl">posts</span></div></div>
          <div class="frow" onclick="nav('whitelist')"><div class="fi">üìã</div><div class="fn"><div class="fn-name">Pendaftaran Whitelist</div><div class="fn-desc">Daftar untuk bergabung sebagai player</div></div><div class="fstat"><span class="cnt" id="hWL">‚Äî</span><span class="lbl">pending</span></div></div>
          <div class="frow" onclick="nav('cs')"><div class="fi">üé≠</div><div class="fn"><div class="fn-name">Character Story Request</div><div class="fn-desc">Ajukan latar belakang karakter kamu</div></div><div class="fstat"><span class="cnt" id="hCS">‚Äî</span><span class="lbl">request</span></div></div>
          <div class="frow" onclick="nav('import')"><div class="fi">üì¶</div><div class="fn"><div class="fn-name">Import Request</div><div class="fn-desc">Request import goodside / badside / family</div></div><div class="fstat"><span class="cnt" id="hImport">‚Äî</span><span class="lbl">pending</span></div></div>
          <div class="frow" onclick="nav('report')"><div class="fi">üö©</div><div class="fn"><div class="fn-name">Laporan & Bantuan</div><div class="fn-desc">Laporkan pelanggaran atau minta bantuan</div></div></div>
        </div>
      </div>
      <div>
        <div style="font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--t3);padding-bottom:6px;border-bottom:1px solid var(--b);margin-bottom:3px">Informasi</div>
        <div class="card">
          <div class="frow" onclick="nav('announcements')"><div class="fi">üì¢</div><div class="fn"><div class="fn-name">Pengumuman</div><div class="fn-desc">Informasi resmi dari tim Miracle RP</div></div></div>
          <div class="frow" onclick="nav('rules')"><div class="fi">üìú</div><div class="fn"><div class="fn-name">Peraturan & Guide</div><div class="fn-desc">Rules, Guide Job, Goodside, Badside</div></div></div>
          <div class="frow" onclick="nav('staff')"><div class="fi">üëë</div><div class="fn"><div class="fn-name">Tim Staff</div><div class="fn-desc">Kenali tim admin dan staff Miracle RP</div></div></div>
        </div>
      </div>
    </div>
    <div class="scol">
      <div class="wgt"><div class="wgt-ttl">Server Address</div><div class="wgt-body">
        <div class="srv-blk" onclick="copyTxt(document.getElementById('srvIP').textContent)"><div class="srv-tp">SA:MP</div><div class="srv-addr" id="srvIP">memuat...</div></div>
        <div class="srv-blk" onclick="copyTxt(document.getElementById('srvWA').textContent)"><div class="srv-tp">WhatsApp</div><div class="srv-addr" id="srvWA">memuat...</div></div>
      </div></div>
      <div class="wgt" id="featWgt"><div class="wgt-ttl">Fitur Server</div><div class="wgt-body" id="featList" style="padding:0 11px"></div></div>
    </div>
  </div>
</div>

<!-- FEED -->
<div class="page" id="page-feed">
  <div class="playout">
    <div class="mcol">
      <div id="feedComposer" style="display:none">
        <div class="composer">
          <div style="display:flex;gap:9px;align-items:flex-start">
            <div class="pava" id="compAva">?</div>
            <textarea class="comp-inp" id="compTxt" placeholder="Bagikan sesuatu ke komunitas..." rows="3"></textarea>
          </div>
          <div id="imgPreview" class="img-preview"><img id="imgPreviewImg" src=""><button class="img-remove" onclick="clearImg()">‚úï</button></div>
          <div style="display:flex;align-items:center;gap:7px;margin-top:9px">
            <label style="cursor:pointer;font-size:11px;color:var(--t3);display:flex;align-items:center;gap:4px;padding:3px 7px;border:1px solid var(--b);border-radius:var(--r);transition:all .1s" onmouseover="this.style.borderColor='var(--b3)'" onmouseout="this.style.borderColor='var(--b)'">
              üì∑ Foto<input type="file" accept="image/*" style="display:none" onchange="handleImg(this)">
            </label>
            <span id="cdMsg" style="font-size:10px;color:var(--t3);display:none"></span>
            <div style="flex:1"></div>
            <button class="btn btn-p btn-sm" onclick="submitPost()">Posting</button>
          </div>
        </div>
      </div>
      <div id="feedList"></div>
      <div id="feedEmpty" style="display:none;text-align:center;padding:36px;color:var(--t3);font-size:12px">Belum ada post.</div>
    </div>
    <div class="scol">
      <div class="wgt"><div class="wgt-ttl">Server</div><div class="wgt-body"><div class="srv-blk"><div class="srv-tp">SA:MP</div><div class="srv-addr" id="feedIP">‚Äî</div></div></div></div>
    </div>
  </div>
</div>

<!-- WHITELIST -->
<div class="page" id="page-whitelist">
  <div class="playout">
    <div class="mcol">
      <div id="wlMyStatus" style="display:none"></div>
      <div id="wlFormWrap">
        <div id="wlClosedBox" class="ibox closed" style="display:none">üö´ Whitelist sedang ditutup. Pantau pengumuman untuk info lebih lanjut.</div>
        <div id="wlOpenWrap">
          <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Form Pendaftaran Whitelist</div>
          <div class="wlsteps">
            <div class="wlstep act" id="wlS1"><div class="wlstep-c">1</div><div class="wlstep-l">Data Diri</div></div>
            <div class="wlline"></div>
            <div class="wlstep" id="wlS2"><div class="wlstep-c">2</div><div class="wlstep-l">Pengetahuan RP</div></div>
            <div class="wlline"></div>
            <div class="wlstep" id="wlS3"><div class="wlstep-c">3</div><div class="wlstep-l">Konfirmasi</div></div>
            <div class="wlline"></div>
            <div class="wlstep" id="wlS4"><div class="wlstep-c">4</div><div class="wlstep-l">Selesai</div></div>
          </div>
          <div class="card" style="padding:18px">
            <div id="wlP1">
              <div style="font-size:12px;font-weight:700;color:#fff;margin-bottom:12px">Data Diri</div>
              <div id="wlReqInfo" class="ibox" style="display:none"></div>
              <div class="fgrp"><label class="flbl">Nama IC (Format: Nama_Belakang)</label><input type="text" class="finp" id="wlIC" placeholder="John_Doe"></div>
              <div class="fgrp"><label class="flbl">Nama Lengkap (OOC)</label><input type="text" class="finp" id="wlFN" placeholder="Nama lengkap kamu"></div>
              <div class="fgrp"><label class="flbl">Umur</label><input type="number" class="finp" id="wlAge" placeholder="Umur" style="max-width:100px" min="10" max="99"></div>
              <div class="fgrp"><label class="flbl">Nomor WhatsApp</label><input type="text" class="finp" id="wlWA" placeholder="08xxxxxxxxxx" style="max-width:180px"></div>
              <div class="fgrp"><label class="flbl">Pengalaman SA:MP</label><select class="finp" id="wlExp" style="max-width:200px"><option value="">Pilih...</option><option value="veteran">Veteran</option><option value="menengah">Menengah</option><option value="pemula">Pemula</option></select></div>
              <div class="fgrp"><label class="flbl">Fraksi yang Diminati</label><input type="text" class="finp" id="wlFaction" placeholder="Civilian, LSPD, dll" style="max-width:220px"></div>
              <button class="btn btn-p" onclick="wlNext(1)">Lanjut ‚Üí</button>
            </div>
            <div id="wlP2" style="display:none">
              <div style="font-size:12px;font-weight:700;color:#fff;margin-bottom:12px">Pengetahuan Roleplay</div>
              <div class="fgrp"><label class="flbl">Apa itu Roleplay? Jelaskan!</label><textarea class="finp" id="wlQ1" placeholder="Jelaskan dengan kata-katamu sendiri..." rows="3"></textarea></div>
              <div class="fgrp"><label class="flbl">Apa itu Metagaming? Berikan contoh!</label><textarea class="finp" id="wlQ2" placeholder="Penjelasan + contoh..." rows="3"></textarea></div>
              <div class="fgrp"><label class="flbl">Apa itu Powergaming? Berikan contoh!</label><textarea class="finp" id="wlQ3" placeholder="Penjelasan + contoh..." rows="3"></textarea></div>
              <div class="fgrp"><label class="flbl">Alasan bergabung di Miracle RP</label><textarea class="finp" id="wlReason" placeholder="Alasan kamu..." rows="3"></textarea></div>
              <div style="display:flex;gap:7px"><button class="btn" onclick="wlBack(2)">‚Üê Kembali</button><button class="btn btn-p" onclick="wlNext(2)">Lanjut ‚Üí</button></div>
            </div>
            <div id="wlP3" style="display:none">
              <div style="font-size:12px;font-weight:700;color:#fff;margin-bottom:10px">Konfirmasi Data</div>
              <div id="wlPreview" class="ibox" style="font-size:11px;line-height:2"></div>
              <div style="display:flex;gap:7px;margin-top:10px"><button class="btn" onclick="wlBack(3)">‚Üê Kembali</button><button class="btn btn-p" onclick="wlSubmit()">Kirim Pendaftaran ‚úì</button></div>
            </div>
            <div id="wlP4" style="display:none;text-align:center;padding:24px 0">
              <div style="font-size:32px;margin-bottom:10px">‚úÖ</div>
              <div style="font-size:15px;font-weight:700;color:var(--grn);margin-bottom:7px">Pendaftaran Berhasil!</div>
              <div style="font-size:11.5px;color:var(--t3)">Tunggu review dari staff. Cek status di halaman ini.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="scol">
      <div class="wgt"><div class="wgt-ttl">Syarat WL</div><div class="wgt-body" id="wlReqWgt" style="font-size:11.5px;color:var(--t2);line-height:1.9">Memuat...</div></div>
      <div class="wgt"><div class="wgt-ttl">Status WL</div><div class="wgt-body" style="padding:0 11px">
        <div class="srow"><span>Pending</span><span class="sv" id="wlPendSide">‚Äî</span></div>
        <div class="srow"><span>Diproses</span><span class="sv" id="wlProcSide">‚Äî</span></div>
        <div class="srow"><span>Diterima</span><span class="sv" id="wlAccSide">‚Äî</span></div>
      </div></div>
    </div>
  </div>
</div>

<!-- CS -->
<div class="page" id="page-cs">
  <div class="playout">
    <div class="mcol">
      <div id="csMyStatus" style="display:none"></div>
      <div id="csFormWrap">
        <div id="csClosedBox" class="ibox closed" style="display:none">üö´ CS Request sedang ditutup.</div>
        <div id="csOpenWrap">
          <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Character Story Request</div>
          <div class="card" style="padding:18px">
            <div id="csInfoBox" class="ibox">Memuat info...</div>
            <div class="fgrp"><label class="flbl">Nama IC (sesuai WL)</label><input type="text" class="finp" id="csIC" placeholder="Nama_IC"></div>
            <div class="fgrp"><label class="flbl">Nama Character Story</label><input type="text" class="finp" id="csChar" placeholder="Nama karakter CS"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <div class="fgrp"><label class="flbl">Usia Karakter</label><input type="number" class="finp" id="csAge" placeholder="Usia"></div>
              <div class="fgrp"><label class="flbl">Level Karakter</label><input type="number" class="finp" id="csLvl" placeholder="Level"></div>
            </div>
            <div class="fgrp"><label class="flbl">Screenshot Level (link)</label><input type="text" class="finp" id="csScr" placeholder="https://..."></div>
            <div class="fgrp"><label class="flbl">Story IC <span id="csMinLbl" style="font-size:9.5px;color:var(--t3)">(min. 150 kata)</span></label>
              <textarea class="finp" id="csStory" rows="6" placeholder="Ceritakan latar belakang karakter..."></textarea>
              <div style="font-size:10px;color:var(--t3);margin-top:3px" id="csWC">0 kata</div>
            </div>
            <div class="fgrp"><label class="flbl">Jadwal Review</label>
              <div id="csSlots" style="display:flex;flex-wrap:wrap;gap:5px;margin-top:4px"></div>
            </div>
            <button class="btn btn-p" onclick="submitCS()">Kirim CS Request</button>
          </div>
        </div>
      </div>
    </div>
    <div class="scol">
      <div class="wgt"><div class="wgt-ttl">Panduan CS</div><div class="wgt-body" id="csPanWgt" style="font-size:11.5px;color:var(--t2);line-height:1.9">Memuat...</div></div>
    </div>
  </div>
</div>

<!-- IMPORT -->
<div class="page" id="page-import">
  <div class="playout">
    <div class="mcol">
      <div id="impMyStatus" style="display:none"></div>
      <div id="impFormWrap">
        <div id="impClosedBox" class="ibox closed" style="display:none">üö´ Import Request sedang ditutup.</div>
        <div id="impOpenWrap">
          <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Import Request</div>
          <div class="card" style="padding:18px">
            <div id="impInfoBox" class="ibox">Memuat info...</div>
            <div class="fgrp"><label class="flbl">Jenis Import</label>
              <div class="imp-grid">
                <div class="imp-btn" id="impGood" onclick="selImp(this,'goodside')"><div class="it-icon">üîµ</div><div class="it-lbl">Goodside</div></div>
                <div class="imp-btn" id="impBad" onclick="selImp(this,'badside')"><div class="it-icon">üî¥</div><div class="it-lbl">Badside</div></div>
                <div class="imp-btn" id="impFam" onclick="selImp(this,'family')"><div class="it-icon">üë®‚Äçüë©‚Äçüëß</div><div class="it-lbl">Family</div></div>
              </div>
            </div>
            <div class="fgrp"><label class="flbl">Nama Karakter (charName)</label><input type="text" class="finp" id="impChar" placeholder="Nama karakter tujuan"></div>
            <div class="fgrp"><label class="flbl">Fraksi / Family Tujuan</label><input type="text" class="finp" id="impFaction" placeholder="Nama fraksi atau family"></div>
            <div class="fgrp"><label class="flbl">Items / Aset yang Dibawa</label><textarea class="finp" id="impItems" rows="2" placeholder="List item, uang, kendaraan, dll"></textarea></div>
            <div class="fgrp"><label class="flbl">Lore IC (Alasan In-Character)</label><textarea class="finp" id="impLore" rows="4" placeholder="Jelaskan alasan IC..."></textarea></div>
            <div class="fgrp"><label class="flbl">Bukti Pendukung (link screenshot)</label><input type="text" class="finp" id="impProof" placeholder="https://..."></div>
            <button class="btn btn-p" onclick="submitImport()">Kirim Request</button>
          </div>
        </div>
      </div>
    </div>
    <div class="scol">
      <div class="wgt"><div class="wgt-ttl">Ketentuan Import</div><div class="wgt-body" id="impReqWgt" style="font-size:11.5px;color:var(--t2);line-height:1.9">Memuat...</div></div>
    </div>
  </div>
</div>

<!-- STAFF -->
<div class="page" id="page-staff">
  <div class="playout">
    <div class="mcol">
      <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Tim Staff Miracle RP</div>
      <div class="sgrid" id="staffGrid"></div>
    </div>
    <div class="scol">
      <div class="wgt"><div class="wgt-ttl">Hubungi Staff</div><div class="wgt-body" style="font-size:11.5px;color:var(--t2);line-height:2"><p id="staffWA">Memuat...</p><p>‚è∞ Jam aktif: 17:00‚Äì24:00</p></div></div>
    </div>
  </div>
</div>

<!-- LB -->
<div class="page" id="page-leaderboard">
  <div class="playout">
    <div class="mcol">
      <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Leaderboard</div>
      <div class="tabs">
        <button class="tbn act" onclick="stab(this,'lb-posts')">Posts Terbanyak</button>
        <button class="tbn" onclick="stab(this,'lb-wl')">WL Terbaru</button>
      </div>
      <div class="tpanel act" id="lb-posts"><div class="card" id="lbPosts"></div></div>
      <div class="tpanel" id="lb-wl"><div class="card" id="lbWL"></div></div>
    </div>
  </div>
</div>

<!-- REPORT -->
<div class="page" id="page-report">
  <div class="playout">
    <div class="mcol">
      <div class="ibox warn" style="margin-bottom:10px">‚ö†Ô∏è Sertakan bukti valid. Laporan palsu = sanksi.</div>
      <div class="card" style="padding:16px">
        <div class="fgrp"><label class="flbl">Nama Karakter Pelapor</label><input type="text" class="finp" id="repReporter" placeholder="Nama_IC_Kamu"></div>
        <div class="fgrp"><label class="flbl">Nama / ID Terlapor</label><input type="text" class="finp" id="repTarget" placeholder="Nama_IC / ID"></div>
        <div class="fgrp"><label class="flbl">Jenis Pelanggaran</label><select class="finp" id="repType"><option value="">Pilih...</option><option>DM (Deathmatch)</option><option>VDM</option><option>Hack / Cheat</option><option>Bug Abuse</option><option>Bad RP</option><option>OOC Harassment</option><option>Scam</option><option>Lainnya</option></select></div>
        <div class="fgrp"><label class="flbl">Tanggal & Waktu</label><input type="datetime-local" class="finp" id="repDate" style="max-width:220px"></div>
        <div class="fgrp"><label class="flbl">Kronologi</label><textarea class="finp" id="repKron" rows="5" placeholder="Jelaskan secara detail..."></textarea></div>
        <div class="fgrp"><label class="flbl">Link Bukti</label><input type="text" class="finp" id="repBukti" placeholder="https://..."></div>
        <button class="btn btn-p" onclick="submitReport()">Kirim Laporan</button>
      </div>
    </div>
    <div class="scol">
      <div class="wgt"><div class="wgt-ttl">Panduan Report</div><div class="wgt-body" style="font-size:11.5px;color:var(--t2);line-height:2"><p>1. Sertakan bukti valid</p><p>2. Isi semua kolom</p><p>3. Jangan laporan palsu</p><p>4. Tunggu respons staff</p></div></div>
    </div>
  </div>
</div>

<!-- ANNOUNCEMENTS -->
<div class="page" id="page-announcements">
  <div class="playout">
    <div class="mcol">
      <div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:10px">Pengumuman</div>
      <div id="annList"></div>
    </div>
  </div>
</div>

<!-- RULES -->
<div class="page" id="page-rules">
  <div class="playout">
    <div class="mcol">
      <div class="tabs">
        <button class="tbn act" onclick="stab(this,'r-rules');loadGuides('rules')">Rules Server</button>
        <button class="tbn" onclick="stab(this,'r-job');loadGuides('guide_job')">Guide Job</button>
        <button class="tbn" onclick="stab(this,'r-good');loadGuides('guide_goodside')">Goodside</button>
        <button class="tbn" onclick="stab(this,'r-bad');loadGuides('guide_badside')">Badside</button>
      </div>
      <div class="tpanel act" id="r-rules"><div id="gRules"><div style="padding:24px;text-align:center;color:var(--t3)">Memuat...</div></div></div>
      <div class="tpanel" id="r-job"><div id="gJob"></div></div>
      <div class="tpanel" id="r-good"><div id="gGood"></div></div>
      <div class="tpanel" id="r-bad"><div id="gBad"></div></div>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div class="page" id="page-profile">
  <div style="max-width:780px">
    <div class="card" style="margin-bottom:10px;overflow:visible">
      <div class="pbanner"></div>
      <div class="phead">
        <div class="pava" id="profAva">?</div>
        <div style="flex:1">
          <div style="font-size:17px;font-weight:700;color:#fff" id="profName">‚Äî</div>
          <span id="profRole" style="font-size:10px;color:var(--t3)">Member</span>
          <div style="display:flex;gap:16px;margin-top:8px">
            <div><span style="font-size:17px;font-weight:700;display:block" id="profPosts">0</span><span style="font-size:9.5px;color:var(--t3);text-transform:uppercase">Posts</span></div>
            <div><span style="font-size:17px;font-weight:700;display:block" id="profJoined">‚Äî</span><span style="font-size:9.5px;color:var(--t3);text-transform:uppercase">Bergabung</span></div>
          </div>
        </div>
        <div style="margin-left:auto;align-self:flex-start;margin-top:36px">
          <button class="btn btn-d btn-sm" id="profLogout" onclick="logoutUser()" style="display:none">Logout</button>
        </div>
      </div>
    </div>
    <div class="tabs">
      <button class="tbn act" onclick="stab(this,'p-about')">Tentang</button>
      <button class="tbn" onclick="stab(this,'p-posts');loadMyPosts()">Postingan</button>
      <button class="tbn" onclick="stab(this,'p-settings')">Pengaturan</button>
    </div>
    <div class="tpanel act" id="p-about">
      <div class="card" style="padding:13px">
        <div class="drow"><div class="dk">Username</div><div class="dv" id="profUN">‚Äî</div></div>
        <div class="drow"><div class="dk">Email</div><div class="dv" id="profEmail">‚Äî</div></div>
        <div class="drow"><div class="dk">Status WL</div><div class="dv" id="profWL">‚Äî</div></div>
        <div class="drow" style="margin-bottom:0"><div class="dk">IC Name</div><div class="dv" id="profIC">‚Äî</div></div>
      </div>
    </div>
    <div class="tpanel" id="p-posts"><div class="card" id="myPostList"></div></div>
    <div class="tpanel" id="p-settings">
      <div class="card" style="padding:16px;max-width:380px">
        <div class="fgrp"><label class="flbl">Username</label><input type="text" class="finp" id="setUN" placeholder="Username"></div>
        <button class="btn btn-p" onclick="saveProfile()">Simpan</button>
      </div>
    </div>
  </div>
</div>

</div><!-- /wrap -->

<!-- ADMIN (full width) -->
<div class="page" id="page-admin">
  <!-- mobile header: shown on <=768px, hidden on desktop -->
  <div style="position:sticky;top:50px;z-index:160;display:none" id="admMobWrap" class="adm-mob-hdr-outer">
    <div style="display:flex;align-items:center;gap:8px;padding:9px 14px;background:var(--bg2);border-bottom:1px solid var(--b);position:relative">
      <span style="font-size:15px;color:var(--t2)">‚ò∞</span>
      <div style="font-size:13px;font-weight:700;color:#fff;flex:1" id="admMobTitle">Dashboard</div>
      <button class="btn btn-sm" id="admMenuBtn" onclick="toggleAdmMenu()">Menu ‚ñæ</button>
      <div id="admMobMenu" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--bg2);border:1px solid var(--b3);border-top:none;z-index:200;max-height:70vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.6)"></div>
    </div>
  </div>
  <div class="adm-wrap">
    <div class="adm-sb" id="admSB"></div>
    <div class="adm-content" id="admContent">

      <div id="adm-overview" class="adm-tab act">
        <div class="adm-title">Dashboard</div><div class="adm-sub">Statistik real-time Miracle RP</div>
        <div class="adm-cards">
          <div class="acard"><div class="acl">Member</div><div class="acv" id="admMembers">‚Äî</div></div>
          <div class="acard"><div class="acl">WL Pending</div><div class="acv" style="color:var(--red)" id="admWLPend">‚Äî</div></div>
          <div class="acard"><div class="acl">CS Pending</div><div class="acv" id="admCSPend">‚Äî</div></div>
          <div class="acard"><div class="acl">Import Pending</div><div class="acv" id="admImpPend">‚Äî</div></div>
          <div class="acard"><div class="acl">Report Open</div><div class="acv" style="color:var(--or)" id="admRepOpen">‚Äî</div></div>
          <div class="acard"><div class="acl">WL Diterima</div><div class="acv" style="color:var(--grn)" id="admWLAcc">‚Äî</div></div>
          <div class="acard"><div class="acl">Banned</div><div class="acv" style="color:var(--red)" id="admBanned">‚Äî</div></div>
          <div class="acard"><div class="acl">Staff</div><div class="acv" style="color:var(--blu)" id="admStaff">‚Äî</div></div>
        </div>
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:7px">Log Terbaru</div>
        <div class="logstream" id="dashLog"></div>
      </div>

      <div id="adm-adminChat" class="adm-tab" style="display:none">
        <div class="adm-title">Admin Chat</div><div class="adm-sub">Diskusi internal tim staff</div>
        <div class="adm-chat">
          <div class="adm-chat-msgs" id="admChatMsgs"><div style="text-align:center;padding:16px;color:var(--t3);font-size:11px">Memuat...</div></div>
          <div class="adm-chat-inp"><input id="admChatIn" placeholder="Tulis pesan ke tim admin..." onkeydown="if(event.key==='Enter')sendAdmChat()"><button onclick="sendAdmChat()">Kirim</button></div>
        </div>
      </div>

      <div id="adm-wlPending" class="adm-tab" style="display:none">
        <div class="adm-title">Pending Whitelist <span id="wlPLbl" style="color:var(--red);font-size:12px"></span></div>
        <div class="twrap"><div class="thdr"><div class="ttitle">Antrian WL</div><input class="tsrch" placeholder="Cari..." oninput="ftbl('tWLPend',this.value)"></div>
        <table id="tWLPend"><thead><tr><th>Nama IC</th><th>WA</th><th>Fraksi</th><th>Tgl</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbWLPend"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-wlAll" class="adm-tab" style="display:none">
        <div class="adm-title">Semua Whitelist</div>
        <div class="twrap"><div class="thdr"><div class="ttitle">Riwayat WL</div><input class="tsrch" placeholder="Cari..." oninput="ftbl('tWLAll',this.value)"></div>
        <table id="tWLAll"><thead><tr><th>Nama IC</th><th>Username</th><th>WA</th><th>Status</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody id="tbWLAll"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-csPending" class="adm-tab" style="display:none">
        <div class="adm-title">Pending CS Request</div>
        <div class="twrap"><div class="thdr"><div class="ttitle">Antrian CS</div><input class="tsrch" placeholder="Cari..." oninput="ftbl('tCSPend',this.value)"></div>
        <table id="tCSPend"><thead><tr><th>IC Name</th><th>Char Name</th><th>Level</th><th>Jadwal</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbCSPend"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-csAll" class="adm-tab" style="display:none">
        <div class="adm-title">Semua CS Request</div>
        <div class="twrap"><div class="thdr"><div class="ttitle">Riwayat CS</div><input class="tsrch" placeholder="Cari..." oninput="ftbl('tCSAll',this.value)"></div>
        <table id="tCSAll"><thead><tr><th>IC Name</th><th>Char Name</th><th>Level</th><th>Status</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody id="tbCSAll"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-importReq" class="adm-tab" style="display:none">
        <div class="adm-title">Import Requests</div>
        <div class="twrap"><div class="thdr"><div class="ttitle">Antrian Import</div><input class="tsrch" placeholder="Cari..." oninput="ftbl('tImport',this.value)"></div>
        <table id="tImport"><thead><tr><th>Username</th><th>charName</th><th>Tipe</th><th>Fraksi</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbImport"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-users" class="adm-tab" style="display:none">
        <div class="adm-title">Users & Role</div>
        <div class="twrap"><div class="thdr"><div class="ttitle">Daftar User</div><input class="tsrch" placeholder="Cari..." oninput="ftbl('tUsers',this.value)"></div>
        <table id="tUsers"><thead><tr><th>Username</th><th>Email</th><th>Role</th><th>WL</th><th>IC Name</th><th>Joined</th><th>Aksi</th></tr></thead><tbody id="tbUsers"><tr class="empty-row"><td colspan="7">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-banned" class="adm-tab" style="display:none">
        <div class="adm-title">Banned Users</div>
        <div class="twrap"><div class="thdr"><div class="ttitle">Banned List</div></div>
        <table><thead><tr><th>Username</th><th>Email</th><th>Alasan</th><th>Oleh</th><th>Aksi</th></tr></thead><tbody id="tbBanned"><tr class="empty-row"><td colspan="5">Tidak ada.</td></tr></tbody></table></div>
      </div>

      <div id="adm-reports" class="adm-tab" style="display:none">
        <div class="adm-title">Reports</div>
        <div class="twrap"><div class="thdr"><div class="ttitle">Daftar Laporan</div><input class="tsrch" placeholder="Cari..." oninput="ftbl('tReports',this.value)"></div>
        <table id="tReports"><thead><tr><th>Pelapor</th><th>Terlapor</th><th>Jenis</th><th>Status</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody id="tbReports"><tr class="empty-row"><td colspan="6">Memuat...</td></tr></tbody></table></div>
      </div>

      <div id="adm-announce" class="adm-tab" style="display:none">
        <div class="adm-title">Kelola Pengumuman</div>
        <div style="display:grid;grid-template-columns:1fr 280px;gap:12px;align-items:start" id="annAdmGrid">
          <div class="twrap"><div class="thdr"><div class="ttitle">Pengumuman</div></div><div id="annAdmList" style="padding:8px"></div></div>
          <div class="twrap"><div class="thdr"><div class="ttitle">Buat Pengumuman</div></div>
          <div style="padding:12px">
            <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:8px" id="annTagPick">
              <span class="role-chip sel" onclick="selAnnTag(this,'ANNOUNCEMENT')">ANNOUNCEMENT</span>
              <span class="role-chip" onclick="selAnnTag(this,'MAINTENANCE')">MAINTENANCE</span>
              <span class="role-chip" onclick="selAnnTag(this,'WARNING')">WARNING</span>
              <span class="role-chip" onclick="selAnnTag(this,'INFO')">INFO</span>
            </div>
            <div class="fgrp"><label class="flbl">Judul</label><input type="text" class="finp" id="annTtlIn" placeholder="Judul..."></div>
            <div class="fgrp"><label class="flbl">Isi</label><textarea class="finp" id="annBodyIn" rows="4" placeholder="Isi pengumuman..."></textarea></div>
            <button class="btn btn-p" style="width:100%" onclick="postAnn()">Posting</button>
          </div></div>
        </div>
      </div>

      <div id="adm-guides" class="adm-tab" style="display:none">
        <div class="adm-title">Kelola Guides & Rules</div>
        <div style="display:grid;grid-template-columns:1fr 280px;gap:12px;align-items:start" id="guideAdmGrid">
          <div class="twrap">
            <div class="thdr"><div class="ttitle">Artikel</div>
              <select class="tsrch" id="guideTypeF" onchange="loadAdmGuides()" style="width:150px">
                <option value="rules">Rules Server</option>
                <option value="guide_job">Guide Job</option>
                <option value="guide_goodside">Guide Goodside</option>
                <option value="guide_badside">Guide Badside</option>
              </select>
            </div>
            <div id="guideAdmList" style="padding:8px"></div>
          </div>
          <div class="twrap"><div class="thdr"><div class="ttitle" id="guideFormTtl">Tambah Artikel</div></div>
          <div style="padding:12px">
            <div class="fgrp"><label class="flbl">Judul</label><input type="text" class="finp" id="guideTtlIn" placeholder="Judul..."></div>
            <div class="fgrp"><label class="flbl">Tag</label><input type="text" class="finp" id="guideTagIn" placeholder="WAJIB BACA, UMUM, dll"></div>
            <div class="fgrp"><label class="flbl">Konten</label><textarea class="finp" id="guideBodyIn" rows="5" placeholder="Isi artikel..."></textarea></div>
            <label style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--t2);margin-bottom:8px;cursor:pointer"><input type="checkbox" id="guidePinned"> Pinned</label>
            <button class="btn btn-p" style="width:100%" onclick="submitGuide()">Simpan</button>
            <button class="btn" id="cancelGuideBtn" onclick="cancelGuide()" style="display:none;width:100%;margin-top:4px">Batal Edit</button>
          </div></div>
        </div>
      </div>

      <div id="adm-staff" class="adm-tab" style="display:none">
        <div class="adm-title">Kelola Staff List</div>
        <div style="display:grid;grid-template-columns:1fr 250px;gap:12px;align-items:start" id="staffAdmGrid">
          <div class="twrap"><div class="thdr"><div class="ttitle">Staff</div></div>
          <table><thead><tr><th>Nama</th><th>Role</th><th>WA</th><th>Aksi</th></tr></thead><tbody id="tbStaff"><tr class="empty-row"><td colspan="4">Memuat...</td></tr></tbody></table></div>
          <div class="twrap"><div class="thdr"><div class="ttitle">Tambah Staff</div></div>
          <div style="padding:12px">
            <div class="fgrp"><label class="flbl">Nama</label><input type="text" class="finp" id="staffNameIn" placeholder="Nama"></div>
            <div class="fgrp"><label class="flbl">Role</label><select class="finp" id="staffRoleIn"><option>Owner</option><option>Co-Owner</option><option>Developer</option><option>Head Admin</option><option>Senior Admin</option><option>Admin</option><option>Junior Admin</option><option>Management</option><option>Moderator</option><option>Community Handle</option><option>Senior Helper</option><option>Helper</option><option>Junior Helper</option><option>Volunteer</option><option>Ex Staff</option></select></div>
            <div class="fgrp"><label class="flbl">WhatsApp</label><input type="text" class="finp" id="staffWAIn" placeholder="628xxxxxxxxxx"></div>
            <button class="btn btn-p" style="width:100%" onclick="addStaff()">Tambah</button>
          </div></div>
        </div>
      </div>

      <div id="adm-settings" class="adm-tab" style="display:none">
        <div class="adm-title">Pengaturan Sistem</div><div class="adm-sub">Semua perubahan langsung tersimpan ke database</div>
        <div class="sgrd">
          <div class="sc"><div class="sc-ttl">Server Config</div>
            <div class="fgrp"><label class="flbl">IP SA:MP</label><input type="text" class="finp" id="cfgIP" placeholder="ip:port"></div>
            <div class="fgrp"><label class="flbl">Nama Server</label><input type="text" class="finp" id="cfgName" placeholder="MIRACLE ROLEPLAY"></div>
            <div class="fgrp"><label class="flbl">Nomor WA Admin</label><input type="text" class="finp" id="cfgWA" placeholder="628xxxxxxxxxx"></div>
            <div class="fgrp"><label class="flbl">Link WA Group</label><input type="text" class="finp" id="cfgWAG" placeholder="https://chat.whatsapp.com/..."></div>
            <div class="fgrp"><label class="flbl">Deskripsi</label><textarea class="finp" id="cfgDesc" rows="2"></textarea></div>
            <div class="fgrp"><label class="flbl">Post Cooldown (menit)</label><input type="number" class="finp" id="cfgCD" style="max-width:90px"></div>
            <button class="btn btn-p" onclick="saveSrvCfg()">Simpan Server</button>
          </div>
          <div class="sc"><div class="sc-ttl">Whitelist Settings</div>
            <div class="fgrp"><label class="flbl">Status WL</label><select class="finp" id="cfgWLOpen"><option value="1">üü¢ Terbuka</option><option value="0">üî¥ Ditutup</option></select></div>
            <div class="fgrp"><label class="flbl">Syarat WL (satu per baris)</label><textarea class="finp" id="cfgWLReq" rows="5"></textarea></div>
            <button class="btn btn-p" onclick="saveWLCfg()">Simpan WL</button>
          </div>
          <div class="sc"><div class="sc-ttl">CS Request Settings</div>
            <div class="fgrp"><label class="flbl">Status CS</label><select class="finp" id="cfgCSOpen"><option value="1">üü¢ Terbuka</option><option value="0">üî¥ Ditutup</option></select></div>
            <div class="fgrp"><label class="flbl">Info CS</label><textarea class="finp" id="cfgCSInfo" rows="2"></textarea></div>
            <div class="fgrp"><label class="flbl">Jadwal (pisah koma)</label><input type="text" class="finp" id="cfgCSSched" placeholder="Senin 19:00,Kamis 19:00"></div>
            <div class="fgrp"><label class="flbl">Min. Kata Story</label><input type="number" class="finp" id="cfgCSMin" style="max-width:90px"></div>
            <div class="fgrp"><label class="flbl">Panduan CS (satu per baris)</label><textarea class="finp" id="cfgCSPan" rows="4"></textarea></div>
            <button class="btn btn-p" onclick="saveCScfg()">Simpan CS</button>
          </div>
          <div class="sc"><div class="sc-ttl">Import Request Settings</div>
            <div class="fgrp"><label class="flbl">Import (master)</label><select class="finp" id="cfgImpOpen"><option value="1">üü¢ Buka</option><option value="0">üî¥ Tutup</option></select></div>
            <div class="fgrp"><label class="flbl">Goodside</label><select class="finp" id="cfgGood"><option value="1">üü¢ Buka</option><option value="0">üî¥ Tutup</option></select></div>
            <div class="fgrp"><label class="flbl">Badside</label><select class="finp" id="cfgBad"><option value="1">üü¢ Buka</option><option value="0">üî¥ Tutup</option></select></div>
            <div class="fgrp"><label class="flbl">Family</label><select class="finp" id="cfgFam"><option value="1">üü¢ Buka</option><option value="0">üî¥ Tutup</option></select></div>
            <div class="fgrp"><label class="flbl">Info Import</label><textarea class="finp" id="cfgImpInfo" rows="2"></textarea></div>
            <div class="fgrp"><label class="flbl">Ketentuan (satu per baris)</label><textarea class="finp" id="cfgImpReq" rows="4"></textarea></div>
            <button class="btn btn-p" onclick="saveImpCfg()">Simpan Import</button>
          </div>
        </div>
      </div>

      <div id="adm-logs" class="adm-tab" style="display:none">
        <div class="adm-title">System Logs</div><div class="adm-sub">Riwayat semua aktivitas</div>
        <div class="twrap">
          <div class="thdr"><div class="ttitle">Activity Log</div>
            <div style="display:flex;gap:5px;flex-wrap:wrap">
              <select class="tsrch" style="width:110px" id="logTypeF" onchange="renderLogs()">
                <option value="">Semua</option><option>AUTH</option><option>WL</option><option>WL_REVIEW</option>
                <option>CS</option><option>CS_REVIEW</option><option>IMPORT</option><option>BAN</option>
                <option>ROLE</option><option>NEWS</option><option>POST</option><option>SYSTEM</option>
              </select>
              <button class="btn btn-d btn-sm" id="clearLogsBtn" onclick="clearLogs()" style="display:none">Clear Logs</button>
            </div>
          </div>
          <div class="logstream" id="logStream" style="max-height:500px;border:none"></div>
        </div>
      </div>

    </div>
  </div>
</div>


<script>
// ============================================================
// GLOBALS
// ============================================================
let CU=null,UP=null,CFG={},SCFG={};
let logsCache=[],admChatListen=null,selImpType=null,selCSSlot=null;
let editGuideKey=null,selAnnTagVal='ANNOUNCEMENT',roleTarget=null,banTarget=null,icTarget=null;
let postImgBase64=null;

const ALL_PERMS=['handle_wl','handle_cs','handle_import','handle_goodside','handle_badside','ban_user','edit_icname','manage_news','manage_guides','manage_announce','view_logs','clear_logs','settings','admin_chat','manage_roles'];
const PERM_LBL={handle_wl:'Handle WL',handle_cs:'Handle CS',handle_import:'Handle Import',handle_goodside:'Handle Goodside',handle_badside:'Handle Badside',ban_user:'Ban User',edit_icname:'Edit IC Name',manage_news:'Manage News',manage_guides:'Manage Guides',manage_announce:'Manage Announce',view_logs:'View Logs',clear_logs:'Clear Logs',settings:'Settings',admin_chat:'Admin Chat',manage_roles:'Manage Roles'};
const ROLES=['owner','developer','headadmin','senioradmin','admin','junioradmin','management','moderator','communityhandle','seniorhelper','helper','juniorhelper','volunteer','exstaff','vip','user'];
const RLBL={owner:'Owner',developer:'Developer',headadmin:'Head Admin',senioradmin:'Senior Admin',admin:'Admin',junioradmin:'Junior Admin',management:'Management',moderator:'Moderator',communityhandle:'Community Handle',seniorhelper:'Senior Helper',helper:'Helper',juniorhelper:'Junior Helper',volunteer:'Volunteer',exstaff:'Ex Staff',vip:'VIP',user:'Member'};
const ADMIN_ROLES=['owner','developer','headadmin','senioradmin','admin','junioradmin','management','moderator','communityhandle','seniorhelper','helper','juniorhelper','volunteer'];

// ============================================================
// HELPERS
// ============================================================
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function ini(n){if(!n)return'?';const p=n.trim().split(/\s+/);return(p[0][0]+(p[1]?p[1][0]:'')).toUpperCase()}
function fmtD(ts){return ts?new Date(ts).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}):'‚Äî'}
function fmtDT(ts){return ts?new Date(ts).toLocaleString('id-ID',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}):'‚Äî'}
function ago(ts){if(!ts)return'';const d=Math.floor((Date.now()-ts)/1000);if(d<60)return d+'d';if(d<3600)return Math.floor(d/60)+'m lalu';if(d<86400)return Math.floor(d/3600)+'j lalu';return Math.floor(d/86400)+'hr lalu'}
function rc(r){return 'r-'+(r||'user').toLowerCase().replace(/[\s\/]/g,'')}
function st(id,v){const e=document.getElementById(id);if(e)e.textContent=v}
function toast(msg,type,dur){
  type=type||'i';dur=dur||3200;
  var el=document.createElement('div');el.className='toast '+type;
  el.innerHTML='<span>'+(type==='s'?'‚úì':type==='e'?'‚úó':'‚Ñπ')+'</span><span>'+esc(msg)+'</span>';
  document.getElementById('toastWrap').prepend(el);setTimeout(function(){el.remove()},dur);
}
function om(id){document.getElementById(id).classList.add('open')}
function cm(id){document.getElementById(id).classList.remove('open')}
function copyTxt(t){navigator.clipboard.writeText(t).then(function(){toast('Tersalin!','s')})}
document.addEventListener('keydown',function(e){if(e.key==='Escape')document.querySelectorAll('.mo.open').forEach(function(m){m.classList.remove('open')})});

// ============================================================
// NAV
// ============================================================
function nav(page){
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('act')});
  var el=document.getElementById('page-'+page);if(el)el.classList.add('act');
  document.querySelectorAll('.mnav a').forEach(function(a){a.classList.remove('act')});
  var na=document.querySelector('.mnav a[data-p="'+page+'"]');if(na)na.classList.add('act');
  if(page==='feed')initFeed();
  else if(page==='whitelist')initWL();
  else if(page==='cs')initCS();
  else if(page==='import')initImport();
  else if(page==='staff')loadStaff();
  else if(page==='leaderboard')loadLB();
  else if(page==='announcements')loadAnn();
  else if(page==='rules')loadGuides('rules');
  else if(page==='profile')initProfile();
  else if(page==='admin')initAdmin();
  window.scrollTo(0,0);
}

function stab(btn,pid){
  var par=btn.closest('.tabs');if(!par)return;
  par.querySelectorAll('.tbn').forEach(function(b){b.classList.remove('act')});btn.classList.add('act');
  var nx=par.nextElementSibling;if(nx)nx.querySelectorAll('.tpanel').forEach(function(p){p.classList.remove('act')});
  var tp=document.getElementById(pid);if(tp)tp.classList.add('act');
}

function openMob(){document.getElementById('mbnav').classList.add('open');document.getElementById('mbo').classList.add('open')}
function closeMob(){document.getElementById('mbnav').classList.remove('open');document.getElementById('mbo').classList.remove('open')}

// ============================================================
// AUTH
// ============================================================
async function loginGoogle(){
  try{
    var p=new firebase.auth.GoogleAuthProvider();
    await firebase.auth().signInWithPopup(p);
    cm('moLogin');toast('Login berhasil!','s');
  }catch(e){toast('Login gagal: '+e.message,'e')}
}

async function logoutUser(){
  await firebase.auth().signOut();CU=null;UP=null;renderAuth();toast('Logout.','i');nav('home');
}

firebase.auth().onAuthStateChanged(async function(u){
  CU=u;
  if(u){
    var snap=await DB.ref('users/'+u.uid).get();
    if(!snap.exists()){
      await DB.ref('users/'+u.uid).set({uid:u.uid,email:u.email,username:u.displayName||u.email.split('@')[0],photoURL:u.photoURL||'',role:'user',status:'active',wlStatus:'none',icName:'',postCount:0,createdAt:Date.now()});
    }
    UP=(await DB.ref('users/'+u.uid).get()).val();
    if(UP && UP.status==='banned'){await firebase.auth().signOut();toast('Akun kamu dibanned.','e');hideLoader();return}
    var ps=await DB.ref('admin_perms/'+u.uid).get();
    if(ps.exists()){
      var pd=ps.val();
      if(pd.role && pd.role!==UP.role) await DB.ref('users/'+u.uid).update({role:pd.role});
      UP.role=pd.role||UP.role;
      UP.perms=pd.perms||[];
    }
    addLog('AUTH','Login: '+UP.username+' ('+UP.role+')');
  }
  renderAuth();loadConfig();loadHomeStats();
  hideLoader();
});

function renderAuth(){
  var el=document.getElementById('tbRight');
  var isAdm=ADMIN_ROLES.indexOf(UP&&UP.role)>=0;
  document.getElementById('admNavLink').style.display=isAdm?'':'none';
  document.getElementById('admMobLink').style.display=isAdm?'':'none';
  if(!CU){
    el.innerHTML='<button class="btn" onclick="om(\'moLogin\')">Masuk</button><button class="btn btn-p" onclick="om(\'moLogin\')">Daftar</button>';
    return;
  }
  var av=UP&&UP.photoURL?'<img src="'+UP.photoURL+'" style="width:28px;height:28px;border-radius:50%;object-fit:cover">':'<div style="width:28px;height:28px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;border:1px solid var(--b)">'+ini(UP&&UP.username)+'</div>';
  el.innerHTML='<div style="display:flex;align-items:center;gap:7px;cursor:pointer" onclick="nav(\'profile\')">'+av+'<span style="font-size:11px;color:var(--t);max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(UP&&UP.username||'')+'</span></div>';
}

// ============================================================
// CONFIG
// ============================================================
function loadConfig(){
  DB.ref('config').on('value',function(snap){CFG=snap.val()||{};applyConfig()});
  DB.ref('settings').on('value',function(snap){SCFG=snap.val()||{};applySettings()});
}

function applyConfig(){
  st('srvIP',CFG.serverIP||'‚Äî');st('feedIP',CFG.serverIP||'‚Äî');
  st('srvWA',CFG.waNumber?String(CFG.waNumber):'‚Äî');
  st('staffWA','WhatsApp: '+(CFG.waNumber||'‚Äî'));
  DB.ref('announcements').orderByChild('ts').limitToLast(1).get().then(function(s){
    if(s.exists()){
      var a=Object.values(s.val())[0];
      document.getElementById('topAnnBar').style.display='flex';
      document.getElementById('topAnnTxt').innerHTML='<strong>'+esc(a.tag||'')+'</strong> ‚Äî '+esc((a.title||'').substring(0,70));
    }
  });
  DB.ref('features').orderByChild('order').get().then(function(s){
    var el=document.getElementById('featList');if(!el)return;
    if(s.exists()){
      var items=Object.values(s.val()).sort(function(a,b){return a.order-b.order});
      el.innerHTML=items.map(function(f){return'<div class="srow"><span>'+esc(f.icon||'')+' '+esc(f.title||'')+'</span></div>'}).join('');
    }
  });
}

function applySettings(){
  var s=SCFG;
  // WL
  var wlOk=s.wlOpen!==false;
  var wcb=document.getElementById('wlClosedBox');if(wcb)wcb.style.display=wlOk?'none':'';
  var wow=document.getElementById('wlOpenWrap');if(wow)wow.style.display=wlOk?'':'none';
  var wrw=document.getElementById('wlReqWgt');
  if(wrw)wrw.innerHTML=(s.wlRequirements||'Min. 17 tahun\nWhatsApp aktif').split('\n').filter(Boolean).map(function(r){return'<p>‚úì '+esc(r)+'</p>'}).join('');
  var wri=document.getElementById('wlReqInfo');
  if(wri&&s.wlRequirements){wri.style.display='';wri.innerHTML=s.wlRequirements.split('\n').filter(Boolean).map(function(r){return'‚úì '+esc(r)}).join(' &nbsp;|&nbsp; ')}
  // CS
  var csOk=s.csOpen!==false;
  var ccb=document.getElementById('csClosedBox');if(ccb)ccb.style.display=csOk?'none':'';
  var cow=document.getElementById('csOpenWrap');if(cow)cow.style.display=csOk?'':'none';
  var cib=document.getElementById('csInfoBox');if(cib)cib.textContent=s.csInfo||'Jadwal review setiap Senin & Kamis';
  var cml=document.getElementById('csMinLbl');if(cml)cml.textContent='(min. '+(s.csMinWords||150)+' kata)';
  var cpw=document.getElementById('csPanWgt');
  if(cpw)cpw.innerHTML=(s.csPanduan||'Min. 150 kata\nKarakter realistis').split('\n').filter(Boolean).map(function(r){return'<p>‚úì '+esc(r)+'</p>'}).join('');
  var slots=document.getElementById('csSlots');
  if(slots){
    var sl=(s.csSchedules||'Senin 19:00,Kamis 19:00').split(',').map(function(x){return x.trim()}).filter(Boolean);
    slots.innerHTML=sl.map(function(x){
      return '<div class="slot-btn" data-slot="'+esc(x)+'" onclick="selSlot(this)" style="background:var(--bg3);border:1.5px solid var(--b);border-radius:var(--r);padding:5px 10px;font-size:11px;color:var(--t2);cursor:pointer;transition:all .1s">'+esc(x)+'</div>';
    }).join('');
  }
  // Import
  var iOk=s.importOpen!==false;
  var icb=document.getElementById('impClosedBox');if(icb)icb.style.display=iOk?'none':'';
  var iow=document.getElementById('impOpenWrap');if(iow)iow.style.display=iOk?'':'none';
  var iib=document.getElementById('impInfoBox');if(iib)iib.textContent=s.importInfo||'Import request dibuka secara berkala';
  var irw=document.getElementById('impReqWgt');
  if(irw)irw.innerHTML=(s.importRequirements||'Harus ada lore IC\nMax 1 request/minggu').split('\n').filter(Boolean).map(function(r){return'<p>‚úì '+esc(r)+'</p>'}).join('');
  [['impGood','goodsideOpen'],['impBad','badsideOpen'],['impFam','familyOpen']].forEach(function(pair){
    var btn=document.getElementById(pair[0]);
    if(btn)btn.className='imp-btn'+((!iOk||s[pair[1]]===false)?' dis':'');
  });
}

// ============================================================
// HOME STATS
// ============================================================
function loadHomeStats(){
  DB.ref('posts').get().then(function(s){st('hPosts',s.exists()?Object.keys(s.val()).length:0)});
  DB.ref('registrations').get().then(function(s){
    var v=Object.values(s.val()||{});
    st('hWL',v.filter(function(x){return x.status==='pending'}).length);
    st('wlPendSide',v.filter(function(x){return x.status==='pending'}).length);
    st('wlProcSide',v.filter(function(x){return x.process}).length);
    st('wlAccSide',v.filter(function(x){return x.status==='accepted'}).length);
  });
  DB.ref('cs_requests').get().then(function(s){st('hCS',s.exists()?Object.values(s.val()||{}).filter(function(x){return x.status==='pending'}).length:0)});
  DB.ref('import_requests').get().then(function(s){st('hImport',s.exists()?Object.values(s.val()||{}).filter(function(x){return x.status==='pending'}).length:0)});
}

// ============================================================
// FEED
// ============================================================
function initFeed(){
  if(CU&&UP){
    var fc=document.getElementById('feedComposer');if(fc)fc.style.display='';
    var ca=document.getElementById('compAva');
    if(ca)ca.innerHTML=UP.photoURL?'<img src="'+UP.photoURL+'" style="width:100%;height:100%;border-radius:50%;object-fit:cover">':ini(UP.username);
  }
  loadFeed();
}

function loadFeed(){
  var list=document.getElementById('feedList'),empty=document.getElementById('feedEmpty');if(!list)return;
  DB.ref('posts').orderByChild('ts').limitToLast(40).get().then(function(snap){
    if(!snap.exists()){list.innerHTML='';if(empty)empty.style.display='';return}
    var entries=Object.entries(snap.val()).reverse();
    list.innerHTML=entries.map(function(e){return renderPost(e[0],e[1])}).join('');
    if(empty)empty.style.display='none';
  });
}

function renderPost(key,p){
  var av=p.photoURL?'<img src="'+esc(p.photoURL)+'" style="width:100%;height:100%;border-radius:50%;object-fit:cover">':ini(p.author||'?');
  var likes=Object.keys(p.likes||{}).length;
  var liked=CU&&p.likes&&p.likes[CU.uid];
  var canDel=CU&&(CU.uid===p.uid||(UP&&ADMIN_ROLES.indexOf(UP.role)>=0));
  var imgHtml=p.imageUrl?'<img class="post-img" src="'+esc(p.imageUrl)+'" onclick="viewImg(this.src)" alt="foto">':'';
  return '<div class="pcard" id="pc-'+key+'">'+
    '<div class="phdr">'+
      '<div class="pava">'+av+'</div>'+
      '<div style="flex:1"><div style="font-size:12.5px;font-weight:600">'+esc(p.author||'?')+' <span class="'+rc(p.role)+'" style="font-size:9.5px">['+esc(RLBL[p.role]||'Member')+']</span></div><div style="font-size:9.5px;color:var(--t3)">'+ago(p.ts)+'</div></div>'+
      (canDel?'<button class="btn btn-d btn-sm" onclick="delPost(\''+key+'\')">Hapus</button>':'')+
    '</div>'+
    (p.content?'<div class="pbody">'+esc(p.content)+'</div>':'')+
    imgHtml+
    '<div class="pact">'+
      '<button class="rbtn'+(liked?' liked':'')+'" id="like-'+key+'" onclick="toggleLike(\''+key+'\',this)">‚ù§ '+likes+'</button>'+
      '<button class="rbtn" onclick="toggleCmt(\''+key+'\')">üí¨ Komentar</button>'+
    '</div>'+
    '<div class="pcmts" id="cmt-'+key+'" style="display:none">'+
      '<div id="cmtList-'+key+'" style="margin-bottom:6px"></div>'+
      (CU?'<div style="display:flex;gap:6px;align-items:center"><div class="cmt-av">'+ini(UP&&UP.username||'?')+'</div><input class="cmt-inp" placeholder="Komentar..." onkeydown="if(event.key===\'Enter\')addCmt(\''+key+'\',this)"></div>':'<div style="font-size:10.5px;color:var(--t3)">Login untuk komentar.</div>')+
    '</div>'+
  '</div>';
}

function viewImg(url){document.getElementById('moImgSrc').src=url;om('moImg')}

function handleImg(input){
  var file=input.files[0];if(!file)return;
  if(file.size>4*1024*1024){toast('Foto max 4MB!','e');input.value='';return}
  var r=new FileReader();
  r.onload=function(e){
    postImgBase64=e.target.result;
    var prev=document.getElementById('imgPreview');prev.style.display='';
    document.getElementById('imgPreviewImg').src=e.target.result;
  };
  r.readAsDataURL(file);
}

function clearImg(){postImgBase64=null;document.getElementById('imgPreview').style.display='none';document.getElementById('imgPreviewImg').src=''}

async function submitPost(){
  if(!CU){om('moLogin');return}
  var txt=document.getElementById('compTxt').value.trim();
  if(!txt&&!postImgBase64){toast('Tulis sesuatu atau tambahkan foto!','e');return}
  if(txt.length>1000){toast('Teks max 1000 karakter!','e');return}
  var cooldown=(SCFG.postCooldownMin||60)*60*1000;
  var lastSnap=await DB.ref('posts').orderByChild('uid').equalTo(CU.uid).limitToLast(1).get();
  if(lastSnap.exists()){
    var lp=Object.values(lastSnap.val())[0];
    var diff=Date.now()-lp.ts;
    if(diff<cooldown){toast('Cooldown: tunggu '+Math.ceil((cooldown-diff)/60000)+' menit lagi.','e');return}
  }
  var key=DB.ref('posts').push().key;
  var postData={uid:CU.uid,author:UP.username,photoURL:UP.photoURL||'',role:UP.role||'user',content:txt,likeCount:0,likes:{},ts:Date.now()};
  if(postImgBase64)postData.imageUrl=postImgBase64;
  await DB.ref('posts/'+key).set(postData);
  await DB.ref('users/'+CU.uid+'/postCount').transaction(function(c){return(c||0)+1});
  addLog('POST',UP.username+' posting: '+txt.substring(0,50));
  document.getElementById('compTxt').value='';clearImg();toast('Post berhasil!','s');loadFeed();
}

async function delPost(key){
  if(!confirm('Hapus post ini?'))return;
  await DB.ref('posts/'+key).remove();toast('Post dihapus.','i');loadFeed();
}

async function toggleLike(key,btn){
  if(!CU){toast('Login dulu!','e');return}
  var ref=DB.ref('posts/'+key+'/likes/'+CU.uid);
  var snap=await ref.get();
  var cur=parseInt(btn.textContent.replace(/\D/g,''))||0;
  if(snap.exists()){await ref.remove();btn.className='rbtn';btn.innerHTML='‚ù§ '+(cur-1)}
  else{await ref.set(true);btn.className='rbtn liked';btn.innerHTML='‚ù§ '+(cur+1)}
}

async function toggleCmt(key){
  var el=document.getElementById('cmt-'+key);if(!el)return;
  var open=el.style.display!=='none';el.style.display=open?'none':'';
  if(!open){
    var ls=document.getElementById('cmtList-'+key);
    if(ls){
      var snap=await DB.ref('posts/'+key+'/comments').get();
      ls.innerHTML=snap.exists()?Object.values(snap.val()).map(function(c){
        return '<div class="cmt-item"><div class="cmt-av">'+ini(c.author||'?')+'</div><div class="cmt-bdy"><div class="cmt-auth">'+esc(c.author||'?')+'</div><div class="cmt-txt">'+esc(c.text||'')+'</div></div></div>';
      }).join(''):'<div style="font-size:10.5px;color:var(--t3)">Belum ada komentar.</div>';
    }
  }
}

async function addCmt(key,input){
  if(!CU||!input.value.trim())return;
  await DB.ref('posts/'+key+'/comments').push({uid:CU.uid,author:UP.username,text:input.value.trim(),ts:Date.now()});
  input.value='';
  var el=document.getElementById('cmt-'+key);if(el)el.style.display='none';
  setTimeout(function(){toggleCmt(key)},50);
}

// ============================================================
// WHITELIST
// ============================================================
function initWL(){checkMyWL();loadHomeStats()}

async function checkMyWL(){
  if(!CU)return;
  var snap=await DB.ref('registrations').orderByChild('uid').equalTo(CU.uid).get();
  if(!snap.exists())return;
  var entries=Object.values(snap.val()).sort(function(a,b){return b.submittedAt-a.submittedAt});
  var latest=entries[0];
  var sv=document.getElementById('wlMyStatus'),fw=document.getElementById('wlFormWrap');
  var sm={pending:'<span class="bdg b-pending">PENDING</span>',process:'<span class="bdg b-process">DIPROSES</span>',accepted:'<span class="bdg b-accepted">DITERIMA ‚úì</span>',rejected:'<span class="bdg b-rejected">DITOLAK</span>',denied:'<span class="bdg b-denied">DITOLAK</span>'};
  if(latest.status==='pending'||latest.status==='process'){
    sv.style.display='';fw.style.display='none';
    sv.innerHTML='<div class="card" style="padding:16px;margin-bottom:12px"><div style="font-size:12.5px;font-weight:700;margin-bottom:10px">Status Pendaftaran Kamu</div><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">'+(sm[latest.status]||'')+'<span style="font-size:10px;color:var(--t3)">'+fmtD(latest.submittedAt)+'</span></div><div class="drow"><div class="dk">Nama IC</div><div class="dv">'+esc(latest.name||'')+'</div></div><div class="drow"><div class="dk">Fraksi</div><div class="dv">'+esc(latest.faction||'')+'</div></div>'+(latest.adminNote?'<div class="ibox" style="margin-top:10px"><strong>Catatan:</strong> '+esc(latest.adminNote)+'</div>':'')+'</div>';
  } else if(latest.status==='accepted'){
    sv.style.display='';fw.style.display='none';
    sv.innerHTML='<div class="ibox ok" style="margin-bottom:12px">‚úÖ Whitelist diterima. IC Name: <strong>'+esc(latest.name)+'</strong> ‚Äî Selamat datang!</div>';
  } else {
    sv.style.display='';fw.style.display='';
    sv.innerHTML='<div class="ibox warn" style="margin-bottom:10px">‚ö†Ô∏è Pendaftaran sebelumnya ditolak. Kamu bisa mendaftar ulang.'+(latest.adminNote?'<br>Alasan: '+esc(latest.adminNote):'')+'</div>';
  }
}

var wlData={};
function wlNext(p){
  if(p===1){
    var ic=document.getElementById('wlIC').value.trim(),fn=document.getElementById('wlFN').value.trim(),age=document.getElementById('wlAge').value,wa=document.getElementById('wlWA').value.trim(),exp=document.getElementById('wlExp').value;
    if(!ic||!fn||!age||!wa||!exp){toast('Isi semua field!','e');return}
    if(!CU){om('moLogin');return}
    if(parseInt(age)<10||parseInt(age)>99){toast('Umur tidak valid!','e');return}
    wlData={name:ic,fullName:fn,age:parseInt(age),wa:wa,exp:exp,faction:document.getElementById('wlFaction').value.trim()};
    document.getElementById('wlP1').style.display='none';document.getElementById('wlP2').style.display='';setWlStep(2);
  } else if(p===2){
    var q1=document.getElementById('wlQ1').value.trim(),q2=document.getElementById('wlQ2').value.trim(),q3=document.getElementById('wlQ3').value.trim(),reason=document.getElementById('wlReason').value.trim();
    if(!q1||!q2||!q3||!reason){toast('Isi semua pertanyaan!','e');return}
    wlData.q1=q1;wlData.q2=q2;wlData.q3=q3;wlData.reason=reason;
    document.getElementById('wlP2').style.display='none';document.getElementById('wlP3').style.display='';setWlStep(3);
    document.getElementById('wlPreview').innerHTML='IC: <b>'+esc(wlData.name)+'</b><br>Nama: <b>'+esc(wlData.fullName)+'</b><br>Umur: <b>'+wlData.age+'</b><br>WA: <b>'+esc(wlData.wa)+'</b><br>Pengalaman: <b>'+esc(wlData.exp)+'</b><br>Fraksi: <b>'+esc(wlData.faction||'-')+'</b>';
  }
}
function wlBack(p){
  if(p===2){document.getElementById('wlP2').style.display='none';document.getElementById('wlP1').style.display='';setWlStep(1)}
  else if(p===3){document.getElementById('wlP3').style.display='none';document.getElementById('wlP2').style.display='';setWlStep(2)}
}
function setWlStep(n){
  for(var i=1;i<=4;i++){
    var s=document.getElementById('wlS'+i);if(!s)continue;
    s.className='wlstep'+(i<n?' done':i===n?' act':'');
  }
}
async function wlSubmit(){
  if(!CU){toast('Login dulu!','e');return}
  try{
    var key=DB.ref('registrations').push().key;
    var data=Object.assign({},wlData,{uid:CU.uid,email:CU.email,username:UP.username,status:'pending',submittedAt:Date.now()});
    await DB.ref('registrations/'+key).set(data);
    await DB.ref('users/'+CU.uid).update({wlStatus:'pending'});
    addLog('WL',UP.username+' daftar WL: '+wlData.name);
    document.getElementById('wlP3').style.display='none';document.getElementById('wlP4').style.display='';setWlStep(4);
    toast('Pendaftaran berhasil!','s');loadHomeStats();
  }catch(e){toast('Gagal: '+e.message,'e')}
}

// ============================================================
// CS
// ============================================================
function initCS(){
  checkMyCS();
  var st2=document.getElementById('csStory');
  if(st2)st2.addEventListener('input',function(){
    var wc=this.value.trim().split(/\s+/).filter(Boolean).length;
    document.getElementById('csWC').textContent=wc+' kata';
  });
}

function selSlot(el){
  document.querySelectorAll('#csSlots .slot-btn').forEach(function(s){s.style.borderColor='var(--b)';s.style.color='var(--t2)'});
  el.style.borderColor='#fff';el.style.color='#fff';selCSSlot=el.dataset.slot;
}

async function checkMyCS(){
  if(!CU)return;
  var snap=await DB.ref('cs_requests').orderByChild('uid').equalTo(CU.uid).limitToLast(1).get();
  if(snap.exists()){
    var d=Object.values(snap.val())[0];
    if(d.status==='pending'||d.status==='process'){
      document.getElementById('csMyStatus').style.display='';document.getElementById('csFormWrap').style.display='none';
      document.getElementById('csMyStatus').innerHTML='<div class="card" style="padding:14px;margin-bottom:10px"><div style="font-size:12.5px;font-weight:700;margin-bottom:8px">CS Request Aktif</div><div class="drow"><div class="dk">Char Name</div><div class="dv">'+esc(d.charName||'')+'</div></div><div class="drow" style="margin-bottom:0"><div class="dk">Status</div><div class="dv"><span class="bdg b-'+d.status+'">'+d.status.toUpperCase()+'</span></div></div></div>';
    }
  }
}

async function submitCS(){
  if(!CU){om('moLogin');return}
  var icName=document.getElementById('csIC').value.trim(),charName=document.getElementById('csChar').value.trim(),age=document.getElementById('csAge').value,level=document.getElementById('csLvl').value,screenshot=document.getElementById('csScr').value.trim(),story=document.getElementById('csStory').value.trim();
  if(!icName||!charName||!age||!level||!story||!selCSSlot){toast('Isi semua field dan pilih jadwal!','e');return}
  var wc=story.trim().split(/\s+/).filter(Boolean).length,min=SCFG.csMinWords||150;
  if(wc<min){toast('Story min. '+min+' kata! ('+wc+' sekarang)','e');return}
  try{
    var key=DB.ref('cs_requests').push().key;
    await DB.ref('cs_requests/'+key).set({uid:CU.uid,email:CU.email,username:UP.username,icName:icName,charName:charName,age:parseInt(age),level:parseInt(level),screenshot:screenshot,story:story,schedule:selCSSlot,status:'pending',createdAt:Date.now()});
    addLog('CS',UP.username+' CS request: '+charName);
    toast('CS Request terkirim!','s');
    document.getElementById('csFormWrap').style.display='none';document.getElementById('csMyStatus').style.display='';
    document.getElementById('csMyStatus').innerHTML='<div class="ibox ok">‚úÖ CS Request berhasil dikirim!</div>';
  }catch(e){toast('Gagal: '+e.message,'e')}
}

// ============================================================
// IMPORT
// ============================================================
function initImport(){checkMyImport()}

function selImp(el,type){
  document.querySelectorAll('.imp-btn').forEach(function(b){b.classList.remove('sel')});
  el.classList.add('sel');selImpType=type;
}

async function checkMyImport(){
  if(!CU)return;
  var snap=await DB.ref('import_requests').orderByChild('userId').equalTo(CU.uid).limitToLast(1).get();
  if(snap.exists()){
    var d=Object.values(snap.val())[0];
    if(d.status==='pending'){
      document.getElementById('impMyStatus').style.display='';document.getElementById('impFormWrap').style.display='none';
      document.getElementById('impMyStatus').innerHTML='<div class="card" style="padding:14px;margin-bottom:10px"><div style="font-size:12.5px;font-weight:700;margin-bottom:8px">Import Request Aktif</div><div class="drow"><div class="dk">Tipe</div><div class="dv" style="text-transform:capitalize">'+esc(d.type||'')+'</div></div><div class="drow" style="margin-bottom:0"><div class="dk">Status</div><div class="dv"><span class="bdg b-'+d.status+'">'+d.status.toUpperCase()+'</span></div></div></div>';
    }
  }
}

async function submitImport(){
  if(!CU){om('moLogin');return}
  if(!selImpType){toast('Pilih jenis import!','e');return}
  var charName=document.getElementById('impChar').value.trim(),faction=document.getElementById('impFaction').value.trim(),items=document.getElementById('impItems').value.trim(),lore=document.getElementById('impLore').value.trim(),proof=document.getElementById('impProof').value.trim();
  if(!charName||!faction||!lore){toast('Isi semua field wajib!','e');return}
  try{
    var key=DB.ref('import_requests').push().key;
    await DB.ref('import_requests/'+key).set({userId:CU.uid,email:CU.email,username:UP.username,type:selImpType,charName:charName,faction:faction,items:items,lore:lore,proof:proof,status:'pending',createdAt:Date.now()});
    addLog('IMPORT',UP.username+' import request: '+charName+' ('+selImpType+')');
    toast('Import request terkirim!','s');
    document.getElementById('impFormWrap').style.display='none';document.getElementById('impMyStatus').style.display='';
    document.getElementById('impMyStatus').innerHTML='<div class="ibox ok">‚úÖ Import request berhasil dikirim!</div>';
  }catch(e){toast('Gagal: '+e.message,'e')}
}

// ============================================================
// STAFF
// ============================================================
async function loadStaff(){
  var grid=document.getElementById('staffGrid');if(!grid)return;
  var snap=await DB.ref('staff').orderByChild('order').get();
  if(!snap.exists()){grid.innerHTML='<p style="color:var(--t3);font-size:11px">Belum ada data staff.</p>';return}
  var rCls={Owner:'r-owner','Co-Owner':'r-owner',Developer:'r-developer','Head Admin':'r-headadmin','Senior Admin':'r-senioradmin',Admin:'r-admin','Junior Admin':'r-junioradmin',Management:'r-management',Moderator:'r-moderator','Community Handle':'r-communityhandle','Senior Helper':'r-seniorhelper',Helper:'r-helper','Junior Helper':'r-juniorhelper',Volunteer:'r-volunteer','Ex Staff':'r-exstaff'};
  var sorted=Object.values(snap.val()).sort(function(a,b){return a.order-b.order});
  grid.innerHTML=sorted.map(function(s){
    return '<div class="scard"><div class="scard-av">'+(s.emoji||ini(s.name||'?'))+'</div><div class="scard-name">'+esc(s.name||'‚Äî')+'</div><div class="scard-role '+(rCls[s.role]||'r-user')+'">'+esc(s.role||'')+'</div>'+(s.wa?'<div style="font-size:9px;color:var(--t3);margin-top:4px">üì± +'+s.wa+'</div>':'')+'</div>';
  }).join('');
}

// ============================================================
// LEADERBOARD
// ============================================================
async function loadLB(){
  var snap=await DB.ref('users').orderByChild('postCount').limitToLast(10).get();
  var lbP=document.getElementById('lbPosts');
  if(lbP&&snap.exists()){
    var users=Object.values(snap.val()).filter(function(u){return u.postCount>0}).sort(function(a,b){return b.postCount-a.postCount});
    var rc2={0:'r1',1:'r2',2:'r3'};
    lbP.innerHTML=users.length?users.map(function(u,i){
      return '<div class="lbrow"><div class="lbrank '+(rc2[i]||'')+'">'+( i+1)+'</div><div class="lbav">'+(u.photoURL?'<img src="'+esc(u.photoURL)+'">':ini(u.username||'?'))+'</div><div class="lbi"><div class="lbn">'+esc(u.username||'')+'</div><div class="lbs '+rc(u.role)+'">'+(RLBL[u.role||'user']||'Member')+'</div></div><div class="lbv">'+(u.postCount||0)+'</div></div>';
    }).join(''):'<div style="padding:18px;text-align:center;color:var(--t3)">Belum ada data.</div>';
  }
  var snapWL=await DB.ref('registrations').orderByChild('status').equalTo('accepted').get();
  var lbW=document.getElementById('lbWL');
  if(lbW&&snapWL.exists()){
    var wls=Object.values(snapWL.val()).sort(function(a,b){return b.reviewedAt-a.reviewedAt}).slice(0,10);
    lbW.innerHTML=wls.map(function(w,i){
      return '<div class="lbrow"><div class="lbrank '+(i<3?'r'+(i+1):'')+'">'+(i+1)+'</div><div class="lbav">'+ini(w.name||'?')+'</div><div class="lbi"><div class="lbn">'+esc(w.name||'')+'</div><div class="lbs">'+fmtD(w.reviewedAt)+'</div></div><div class="lbv" style="color:var(--grn)">‚úì</div></div>';
    }).join('');
  }
}

// ============================================================
// ANNOUNCEMENTS
// ============================================================
async function loadAnn(){
  var el=document.getElementById('annList');if(!el)return;
  el.innerHTML='<div style="padding:24px;text-align:center;color:var(--t3)">Memuat...</div>';
  var snap=await DB.ref('announcements').orderByChild('ts').limitToLast(30).get();
  if(!snap.exists()){el.innerHTML='<div style="padding:24px;text-align:center;color:var(--t3)">Belum ada pengumuman.</div>';return}
  var tclr={ANNOUNCEMENT:'var(--red)',MAINTENANCE:'var(--or)',WARNING:'var(--or)',INFO:'var(--blu)'};
  el.innerHTML=Object.values(snap.val()).reverse().map(function(a){
    return '<div class="ann-card"><div class="ann-tag" style="background:'+( tclr[a.tag]||'var(--blu)')+'22;color:'+(tclr[a.tag]||'var(--blu)')+';">'+esc(a.tag||'INFO')+'</div><div class="ann-ttl">'+esc(a.title||'')+'</div><div class="ann-body">'+esc(a.content||'')+'</div><div class="ann-meta">'+fmtDT(a.ts)+' ‚Ä¢ '+esc(a.author||'Admin')+'</div></div>';
  }).join('');
}

// ============================================================
// GUIDES
// ============================================================
var gcache={};
async function loadGuides(type){
  var ids={rules:'gRules',guide_job:'gJob',guide_goodside:'gGood',guide_badside:'gBad'};
  var el=document.getElementById(ids[type]);if(!el)return;
  if(gcache[type]){el.innerHTML=gcache[type];return}
  el.innerHTML='<div style="padding:24px;text-align:center;color:var(--t3)">Memuat...</div>';
  var snap=await DB.ref('guides').orderByChild('type').equalTo(type).get();
  if(!snap.exists()){el.innerHTML='<div style="padding:24px;text-align:center;color:var(--t3)">Belum ada konten.</div>';return}
  gcache[type]=Object.values(snap.val()).sort(function(a,b){return(b.pinned?1:0)-(a.pinned?1:0)}).map(function(g){
    return '<div class="gcard">'+(g.pinned?'<div style="font-size:9px;color:var(--gold);font-weight:700;margin-bottom:4px">üìå PINNED</div>':'')+'<div class="gtag">'+esc(g.tag||'')+'</div><div class="gttl">'+esc(g.title||'')+'</div><div class="gbody">'+esc(g.body||'')+'</div></div>';
  }).join('');
  el.innerHTML=gcache[type];
}

// ============================================================
// REPORT
// ============================================================
async function submitReport(){
  if(!CU){om('moLogin');return}
  var reporter=document.getElementById('repReporter').value.trim(),target=document.getElementById('repTarget').value.trim(),type=document.getElementById('repType').value,date=document.getElementById('repDate').value,kron=document.getElementById('repKron').value.trim(),bukti=document.getElementById('repBukti').value.trim();
  if(!reporter||!target||!type||!kron){toast('Isi semua field wajib!','e');return}
  var key=DB.ref('reports').push().key;
  await DB.ref('reports/'+key).set({uid:CU.uid,email:CU.email,username:UP.username,reporter:reporter,target:target,type:type,date:date,kronologi:kron,bukti:bukti,status:'open',createdAt:Date.now()});
  toast('Laporan dikirim!','s');
  ['repReporter','repTarget','repKron','repBukti'].forEach(function(id){document.getElementById(id).value=''});
  document.getElementById('repType').value='';
}

// ============================================================
// PROFILE
// ============================================================
async function initProfile(){
  if(!CU){nav('home');return}
  st('profName',UP.username||'');st('profUN','@'+(UP.username||''));st('profEmail',CU.email||'');
  st('profIC',UP.icName||'‚Äî');st('profJoined',fmtD(UP.createdAt)||'‚Äî');st('profPosts',UP.postCount||0);
  document.getElementById('profLogout').style.display='';
  var el=document.getElementById('profAva');el.innerHTML=UP.photoURL?'<img src="'+UP.photoURL+'" style="width:100%;height:100%;object-fit:cover">':ini(UP.username||'?');
  document.getElementById('profRole').textContent=RLBL[UP.role||'user']||'Member';
  var wlS=await DB.ref('registrations').orderByChild('uid').equalTo(CU.uid).limitToLast(1).get();
  var sm={pending:'<span class="bdg b-pending">PENDING</span>',process:'<span class="bdg b-process">DIPROSES</span>',accepted:'<span class="bdg b-accepted">DITERIMA</span>',rejected:'<span class="bdg b-rejected">DITOLAK</span>',denied:'<span class="bdg b-denied">DITOLAK</span>'};
  document.getElementById('profWL').innerHTML=wlS.exists()?( sm[Object.values(wlS.val())[0].status]||'‚Äî'):'<span style="color:var(--t3)">Belum Mendaftar</span>';
  document.getElementById('setUN').value=UP.username||'';
}

async function saveProfile(){
  if(!CU)return;var name=document.getElementById('setUN').value.trim();
  if(!name){toast('Nama kosong!','e');return}if(name.length>30){toast('Max 30 karakter!','e');return}
  await DB.ref('users/'+CU.uid+'/username').set(name);UP.username=name;renderAuth();toast('Tersimpan!','s');
}

async function loadMyPosts(){
  var el=document.getElementById('myPostList');if(!el||!CU)return;
  el.innerHTML='<div style="padding:18px;text-align:center;color:var(--t3)">Memuat...</div>';
  var snap=await DB.ref('posts').orderByChild('uid').equalTo(CU.uid).get();
  if(!snap.exists()){el.innerHTML='<div style="padding:14px;color:var(--t3)">Belum ada post.</div>';return}
  el.innerHTML=Object.values(snap.val()).reverse().map(function(p){
    return '<div style="padding:9px 12px;border-bottom:1px solid var(--b2)"><div style="font-size:11.5px;color:var(--t2)">'+esc((p.content||'').substring(0,100))+'</div><div style="font-size:9.5px;color:var(--t3);margin-top:3px">'+ago(p.ts)+'</div></div>';
  }).join('');
}

// ============================================================
// LOGS
// ============================================================
async function addLog(type,msg){
  try{
    if(!CU)return;
    await DB.ref('logs').push({by:(UP&&UP.username)||'system',msg:msg,type:type,ts:Date.now()});
  }catch(e){}
}

async function loadAdmLogs(){
  var snap=await DB.ref('logs').orderByChild('ts').limitToLast(300).get();
  logsCache=snap.exists()?Object.values(snap.val()).reverse():[];renderLogs();
  var btn=document.getElementById('clearLogsBtn');
  if(btn&&hasPerm('clear_logs'))btn.style.display='';
}

function renderLogs(){
  var el=document.getElementById('logStream');if(!el)return;
  var f=document.getElementById('logTypeF');var filter=f?f.value:'';
  var logs=filter?logsCache.filter(function(l){return l.type===filter}):logsCache;
  if(!logs.length){el.innerHTML='<div class="log-line"><div class="log-msg" style="color:var(--t3)">Tidak ada log.</div></div>';return}
  el.innerHTML=logs.map(function(l){
    return '<div class="log-line"><div class="log-time">'+fmtDT(l.ts)+'</div><div class="log-type '+(l.type||'')+'">'+esc(l.type||'SYS')+'</div><div class="log-msg">['+esc(l.by||'?')+'] '+esc(l.msg||'')+'</div></div>';
  }).join('');
}

async function clearLogs(){
  if(!confirm('Hapus semua logs?'))return;
  await DB.ref('logs').remove();logsCache=[];renderLogs();
  addLog('SYSTEM','Logs dihapus oleh '+(UP&&UP.username||'?'));toast('Logs dihapus.','i');
}

// ============================================================
// ADMIN ‚Äî PERMISSION HELPER
// ============================================================
function hasPerm(p){
  if(!UP)return false;
  if(UP.role==='owner'||UP.role==='developer')return true;
  return Array.isArray(UP.perms)&&UP.perms.indexOf(p)>=0;
}

// ============================================================
// ADMIN ‚Äî SIDEBAR & TAB SWITCHING
// ============================================================
var ADM_ITEMS=[
  {id:'overview',     icon:'üìä', lbl:'Overview',      sec:'Utama',       always:true,  fn:function(){loadAdmDash()}},
  {id:'adminChat',    icon:'üí¨', lbl:'Admin Chat',    sec:'',            perm:'admin_chat', fn:function(){loadAdmChat()}},
  {id:'wlPending',    icon:'üìã', lbl:'WL Pending',    sec:'Manajemen',   perm:'handle_wl', badge:'nbWL', fn:function(){loadAdmWL('pending')}},
  {id:'wlAll',        icon:'üìã', lbl:'WL Semua',      sec:'',            perm:'handle_wl', fn:function(){loadAdmWL('all')}},
  {id:'csPending',    icon:'üé≠', lbl:'CS Pending',    sec:'',            perm:'handle_cs', badge:'nbCS', fn:function(){loadAdmCS('pending')}},
  {id:'csAll',        icon:'üé≠', lbl:'CS Semua',      sec:'',            perm:'handle_cs', fn:function(){loadAdmCS('all')}},
  {id:'importReq',    icon:'üì¶', lbl:'Import Req',    sec:'',            perm:'handle_import', badge:'nbImp', fn:function(){loadAdmImport()}},
  {id:'users',        icon:'üë•', lbl:'Users & Role',  sec:'',            perm:'manage_roles', fn:function(){loadAdmUsers()}},
  {id:'banned',       icon:'üö´', lbl:'Banned',        sec:'',            perm:'ban_user', fn:function(){loadAdmBanned()}},
  {id:'reports',      icon:'üö©', lbl:'Reports',       sec:'',            always:true,  fn:function(){loadAdmReports()}},
  {id:'announce',     icon:'üì¢', lbl:'Pengumuman',    sec:'Konten',      perm:'manage_announce', fn:function(){loadAdmAnn()}},
  {id:'guides',       icon:'üìö', lbl:'Guides & Rules',sec:'',            perm:'manage_guides', fn:function(){loadAdmGuides()}},
  {id:'staff',        icon:'üëë', lbl:'Staff List',    sec:'',            always:true,  fn:function(){loadAdmStaff()}},
  {id:'settings',     icon:'‚öôÔ∏è', lbl:'Settings',     sec:'Sistem',      perm:'settings', fn:function(){loadSettingsForm()}},
  {id:'logs',         icon:'üìú', lbl:'Logs',          sec:'',            perm:'view_logs', fn:function(){loadAdmLogs()}},
];

var currentAdmFn=null;

function initAdmin(){
  if(!CU||!UP||ADMIN_ROLES.indexOf(UP.role)<0){nav('home');toast('Akses ditolak.','e');return}
  buildAdmSidebar();
  switchAdmTab('overview');
}

function buildAdmSidebar(){
  var sb=document.getElementById('admSB');if(!sb)return;
  var html='<div style="padding:10px 12px 5px;font-size:13px;font-weight:800;letter-spacing:2px;color:#fff;border-bottom:1px solid var(--b);padding-bottom:10px;margin-bottom:4px">ADMIN</div>';
  var lastSec='';
  ADM_ITEMS.forEach(function(item){
    if(!item.always&&!hasPerm(item.perm))return;
    if(item.sec&&item.sec!==lastSec){lastSec=item.sec;html+='<div class="adm-sec">'+item.sec+'</div>'}
    html+='<button class="adm-itm" id="si-'+item.id+'" data-tab="'+item.id+'">'+item.icon+' '+item.lbl+(item.badge?'<span class="adm-badge" id="'+item.badge+'">0</span>':'')+'</button>';
  });
  sb.innerHTML=html;
  // Attach click handlers AFTER innerHTML
  ADM_ITEMS.forEach(function(item){
    var btn=document.getElementById('si-'+item.id);
    if(btn){
      btn.addEventListener('click',function(){
        switchAdmTab(item.id);
      });
    }
  });
  // Mobile menu
  buildAdmMobMenu();
}

function buildAdmMobMenu(){
  var mm=document.getElementById('admMobMenu');if(!mm)return;
  var html='';
  ADM_ITEMS.forEach(function(item){
    if(!item.always&&!hasPerm(item.perm))return;
    html+='<div class="adm-mob-item" data-tab="'+item.id+'" style="padding:10px 16px;border-bottom:1px solid var(--b2);cursor:pointer;font-size:12.5px;color:var(--t2);display:flex;align-items:center;gap:8px">'+item.icon+' '+item.lbl+'</div>';
  });
  mm.innerHTML=html;
  mm.querySelectorAll('.adm-mob-item').forEach(function(el){
    el.addEventListener('click',function(){
      switchAdmTab(el.dataset.tab);
      var m=document.getElementById('admMobMenu');if(m)m.style.display='none';
    });
  });
}

function toggleAdmMenu(){
  var menu=document.getElementById('admMobMenu');
  if(!menu)return;
  var isOpen=menu.style.display!=='none'&&menu.style.display!=='';
  menu.style.display=isOpen?'none':'block';
}

function switchAdmTab(id){
  // Hide all tabs
  document.querySelectorAll('.adm-tab').forEach(function(t){t.style.display='none';t.classList.remove('act')});
  // Show target tab
  var tab=document.getElementById('adm-'+id);
  if(tab){tab.style.display='';tab.classList.add('act')}
  // Update sidebar active state
  document.querySelectorAll('.adm-itm').forEach(function(b){b.classList.remove('act')});
  var si=document.getElementById('si-'+id);if(si)si.classList.add('act');
  // Update mobile title
  var item=null;
  for(var i=0;i<ADM_ITEMS.length;i++){if(ADM_ITEMS[i].id===id){item=ADM_ITEMS[i];break}}
  if(item){
    var mt=document.getElementById('admMobTitle');if(mt)mt.textContent=item.icon+' '+item.lbl;
    // Call the loader function
    if(item.fn)item.fn();
  }
}

// ============================================================
// ADMIN DASHBOARD
// ============================================================
async function loadAdmDash(){
  try{
    var results=await Promise.all([DB.ref('users').get(),DB.ref('registrations').get(),DB.ref('cs_requests').get(),DB.ref('import_requests').get(),DB.ref('reports').get(),DB.ref('staff').get()]);
    var uv=results[0].val()||{},rv=results[1].val()||{},cv=results[2].val()||{},iv=results[3].val()||{},repv=results[4].val()||{},sv=results[5].val()||{};
    var wlPend=Object.values(rv).filter(function(x){return x.status==='pending'}).length;
    var csPend=Object.values(cv).filter(function(x){return x.status==='pending'}).length;
    var impPend=Object.values(iv).filter(function(x){return x.status==='pending'}).length;
    var repOpen=Object.values(repv).filter(function(x){return x.status==='open'}).length;
    var wlAcc=Object.values(rv).filter(function(x){return x.status==='accepted'}).length;
    var banCount=Object.values(uv).filter(function(u){return u.status==='banned'}).length;
    st('admMembers',Object.keys(uv).length);st('admWLPend',wlPend);st('admCSPend',csPend);
    st('admImpPend',impPend);st('admRepOpen',repOpen);st('admWLAcc',wlAcc);
    st('admBanned',banCount);st('admStaff',Object.keys(sv).length);
    [['nbWL',wlPend],['nbCS',csPend],['nbImp',impPend]].forEach(function(pair){var e=document.getElementById(pair[0]);if(e)e.textContent=pair[1]});
  }catch(e){console.error('loadAdmDash error',e)}
  // Load recent logs
  var snap=await DB.ref('logs').orderByChild('ts').limitToLast(20).get();
  var el=document.getElementById('dashLog');if(!el)return;
  if(!snap.exists()){el.innerHTML='<div class="log-line"><div class="log-msg" style="color:var(--t3)">Belum ada log.</div></div>';return}
  el.innerHTML=Object.values(snap.val()).reverse().map(function(l){
    return '<div class="log-line"><div class="log-time">'+fmtDT(l.ts)+'</div><div class="log-type '+(l.type||'')+'">'+esc(l.type||'SYS')+'</div><div class="log-msg">['+esc(l.by||'?')+'] '+esc(l.msg||'')+'</div></div>';
  }).join('');
}

// ============================================================
// WL ADMIN
// ============================================================
async function loadAdmWL(mode){
  var tbId=mode==='pending'?'tbWLPend':'tbWLAll';
  var tb=document.getElementById(tbId);if(!tb)return;
  tb.innerHTML='<tr class="empty-row"><td colspan="6">Memuat...</td></tr>';
  var snap=await DB.ref('registrations').get();
  if(!snap.exists()){tb.innerHTML='<tr class="empty-row"><td colspan="6">Belum ada data.</td></tr>';return}
  var entries=Object.entries(snap.val()).map(function(e){return Object.assign({},e[1],{_key:e[0]})});
  if(mode==='pending')entries=entries.filter(function(x){return x.status==='pending'});
  entries.sort(function(a,b){return b.submittedAt-a.submittedAt});
  var lbl=document.getElementById('wlPLbl');if(lbl&&mode==='pending')lbl.textContent='('+entries.filter(function(x){return x.status==='pending'}).length+')';
  if(!entries.length){tb.innerHTML='<tr class="empty-row"><td colspan="6">Tidak ada data.</td></tr>';return}
  tb.innerHTML=entries.map(function(w){
    return '<tr><td><strong>'+esc(w.name||'')+'</strong></td><td style="font-size:10.5px">'+esc(w.wa||'')+'</td><td>'+esc(w.faction||'')+'</td><td style="font-size:10px">'+fmtD(w.submittedAt)+'</td><td><span class="bdg b-'+w.status+'">'+w.status.toUpperCase()+'</span></td><td><button class="atb" onclick="openWLDetail(\''+w._key+'\')">Detail</button></td></tr>';
  }).join('');
}

async function openWLDetail(key){
  var snap=await DB.ref('registrations/'+key).get();if(!snap.exists())return;
  var w=snap.val();
  document.getElementById('wlDetailBody').innerHTML='<div class="drow"><div class="dk">Nama IC</div><div class="dv">'+esc(w.name||'')+'</div></div><div class="drow"><div class="dk">Nama OOC</div><div class="dv">'+esc(w.fullName||'')+'</div></div><div class="drow"><div class="dk">Username</div><div class="dv">'+esc(w.username||'')+'</div></div><div class="drow"><div class="dk">Email</div><div class="dv" style="font-size:11px">'+esc(w.email||'')+'</div></div><div class="drow"><div class="dk">WA</div><div class="dv">'+esc(w.wa||'')+'</div></div><div class="drow"><div class="dk">Umur</div><div class="dv">'+esc(w.age||'')+'</div></div><div class="drow"><div class="dk">Fraksi</div><div class="dv">'+esc(w.faction||'')+'</div></div><div class="drow"><div class="dk">Pengalaman</div><div class="dv">'+esc(w.exp||'')+'</div></div><div class="drow"><div class="dk">Status</div><div class="dv"><span class="bdg b-'+w.status+'">'+w.status.toUpperCase()+'</span></div></div><hr style="border-color:var(--b);margin:10px 0"><div class="flbl" style="margin-bottom:4px">Q: Apa itu RP?</div><div class="dstory">'+esc(w.q1||'')+'</div><div class="flbl" style="margin:8px 0 4px">Q: Metagaming</div><div class="dstory">'+esc(w.q2||'')+'</div><div class="flbl" style="margin:8px 0 4px">Q: Powergaming</div><div class="dstory">'+esc(w.q3||'')+'</div><div class="flbl" style="margin:8px 0 4px">Alasan</div><div class="dstory">'+esc(w.reason||'')+'</div><div class="fgrp" style="margin-top:10px"><label class="flbl">Catatan Admin</label><input type="text" class="finp" id="wlNote" value="'+esc(w.adminNote||'')+'" placeholder="Catatan..."></div>';
  var act=document.getElementById('wlDetailAct');
  if(hasPerm('handle_wl')&&(w.status==='pending'||w.status==='process')){
    act.innerHTML='<button class="btn btn-g" onclick="updWL(\''+key+'\',\'accepted\')">‚úì Terima</button><button class="btn" onclick="updWL(\''+key+'\',\'process\')">‚ü≥ Proses</button><button class="btn btn-d" onclick="updWL(\''+key+'\',\'rejected\')">‚úó Tolak</button>';
  } else {
    act.innerHTML='<span class="bdg b-'+w.status+'">'+w.status.toUpperCase()+'</span>';
  }
  om('moWL');
}

async function updWL(key,status){
  var note=document.getElementById('wlNote');var noteVal=note?note.value:'';
  var snap=await DB.ref('registrations/'+key).get();var w=snap.val();
  await DB.ref('registrations/'+key).update({status:status,adminNote:noteVal,reviewedBy:UP.username,reviewedAt:Date.now()});
  if(status==='accepted'&&w.uid)await DB.ref('users/'+w.uid).update({wlStatus:'accepted',icName:w.name});
  addLog('WL_REVIEW','WL '+status+': '+w.name+' oleh '+UP.username);
  toast('WL '+status+'!','s');cm('moWL');loadAdmWL('pending');loadAdmWL('all');loadAdmDash();
}

// ============================================================
// CS ADMIN
// ============================================================
async function loadAdmCS(mode){
  var tbId=mode==='pending'?'tbCSPend':'tbCSAll';
  var tb=document.getElementById(tbId);if(!tb)return;
  tb.innerHTML='<tr class="empty-row"><td colspan="6">Memuat...</td></tr>';
  var snap=await DB.ref('cs_requests').get();
  if(!snap.exists()){tb.innerHTML='<tr class="empty-row"><td colspan="6">Belum ada data.</td></tr>';return}
  var entries=Object.entries(snap.val()).map(function(e){return Object.assign({},e[1],{_key:e[0]})});
  if(mode==='pending')entries=entries.filter(function(x){return x.status==='pending'});
  entries.sort(function(a,b){return b.createdAt-a.createdAt});
  if(!entries.length){tb.innerHTML='<tr class="empty-row"><td colspan="6">Tidak ada data.</td></tr>';return}
  tb.innerHTML=entries.map(function(c){
    return '<tr><td>'+esc(c.icName||'')+'</td><td>'+esc(c.charName||'')+'</td><td>'+esc(c.level||'')+'</td><td>'+esc(c.schedule||'')+'</td><td><span class="bdg b-'+c.status+'">'+c.status.toUpperCase()+'</span></td><td><button class="atb" onclick="openCSDetail(\''+c._key+'\')">Detail</button></td></tr>';
  }).join('');
}

async function openCSDetail(key){
  var snap=await DB.ref('cs_requests/'+key).get();if(!snap.exists())return;var c=snap.val();
  document.getElementById('csDetailBody').innerHTML='<div class="drow"><div class="dk">IC Name</div><div class="dv">'+esc(c.icName||'')+'</div></div><div class="drow"><div class="dk">Char Name</div><div class="dv">'+esc(c.charName||'')+'</div></div><div class="drow"><div class="dk">Usia / Level</div><div class="dv">'+esc(c.age||'')+' / '+esc(c.level||'')+'</div></div><div class="drow"><div class="dk">Jadwal</div><div class="dv">'+esc(c.schedule||'')+'</div></div><div class="drow"><div class="dk">Screenshot</div><div class="dv"><a href="'+esc(c.screenshot||'#')+'" target="_blank" style="color:var(--blu)">Lihat ‚Üí</a></div></div><div class="drow"><div class="dk">Status</div><div class="dv"><span class="bdg b-'+c.status+'">'+c.status.toUpperCase()+'</span></div></div><div class="flbl" style="margin:10px 0 4px">Story IC <span style="color:var(--t3);font-size:9px">('+((c.story||'').trim().split(/\s+/).filter(Boolean).length)+' kata)</span></div><div class="dstory">'+esc(c.story||'')+'</div><div class="fgrp" style="margin-top:10px"><label class="flbl">Catatan Admin</label><input type="text" class="finp" id="csNote" value="'+esc(c.adminNote||'')+'" placeholder="Catatan..."></div>';
  var act=document.getElementById('csDetailAct');
  if(hasPerm('handle_cs')&&(c.status==='pending'||c.status==='process')){
    act.innerHTML='<button class="btn btn-g" onclick="updCS(\''+key+'\',\'accepted\')">‚úì Terima</button><button class="btn" onclick="updCS(\''+key+'\',\'process\')">‚ü≥ Proses</button><button class="btn btn-d" onclick="updCS(\''+key+'\',\'rejected\')">‚úó Tolak</button>';
  } else {
    act.innerHTML='<span class="bdg b-'+c.status+'">'+c.status.toUpperCase()+'</span>';
  }
  om('moCS');
}

async function updCS(key,status){
  var note=document.getElementById('csNote');var noteVal=note?note.value:'';
  var snap=await DB.ref('cs_requests/'+key).get();var c=snap.val();
  await DB.ref('cs_requests/'+key).update({status:status,adminNote:noteVal,reviewedBy:UP.username,reviewedAt:Date.now()});
  addLog('CS_REVIEW','CS '+status+': '+c.charName+' oleh '+UP.username);
  toast('CS '+status+'!','s');cm('moCS');loadAdmCS('pending');loadAdmCS('all');
}

// ============================================================
// IMPORT ADMIN
// ============================================================
async function loadAdmImport(){
  var tb=document.getElementById('tbImport');if(!tb)return;
  tb.innerHTML='<tr class="empty-row"><td colspan="6">Memuat...</td></tr>';
  var snap=await DB.ref('import_requests').get();
  if(!snap.exists()){tb.innerHTML='<tr class="empty-row"><td colspan="6">Belum ada data.</td></tr>';return}
  var entries=Object.entries(snap.val()).map(function(e){return Object.assign({},e[1],{_key:e[0]})}).sort(function(a,b){return b.createdAt-a.createdAt});
  var nb=document.getElementById('nbImp');if(nb)nb.textContent=entries.filter(function(x){return x.status==='pending'}).length;
  tb.innerHTML=entries.map(function(r){
    return '<tr><td>'+esc(r.username||'')+'</td><td>'+esc(r.charName||'')+'</td><td style="text-transform:capitalize">'+esc(r.type||'')+'</td><td>'+esc(r.faction||'')+'</td><td><span class="bdg b-'+r.status+'">'+r.status.toUpperCase()+'</span></td><td><button class="atb" onclick="openImpDetail(\''+r._key+'\')">Detail</button></td></tr>';
  }).join('');
}

async function openImpDetail(key){
  var snap=await DB.ref('import_requests/'+key).get();if(!snap.exists())return;var r=snap.val();
  var canHandle=hasPerm('handle_import')||(r.type==='goodside'&&hasPerm('handle_goodside'))||(r.type==='badside'&&hasPerm('handle_badside'));
  document.getElementById('impDetailBody').innerHTML='<div class="drow"><div class="dk">Username</div><div class="dv">'+esc(r.username||'')+'</div></div><div class="drow"><div class="dk">Tipe</div><div class="dv" style="text-transform:capitalize">'+esc(r.type||'')+'</div></div><div class="drow"><div class="dk">Char Name</div><div class="dv">'+esc(r.charName||'')+'</div></div><div class="drow"><div class="dk">Fraksi/Family</div><div class="dv">'+esc(r.faction||'')+'</div></div><div class="drow"><div class="dk">Bukti</div><div class="dv"><a href="'+esc(r.proof||'#')+'" target="_blank" style="color:var(--blu)">Lihat ‚Üí</a></div></div><div class="drow"><div class="dk">Status</div><div class="dv"><span class="bdg b-'+r.status+'">'+r.status.toUpperCase()+'</span></div></div><div class="flbl" style="margin:10px 0 4px">Items</div><div class="dstory">'+esc(r.items||'‚Äî')+'</div><div class="flbl" style="margin:8px 0 4px">Lore IC</div><div class="dstory">'+esc(r.lore||'')+'</div><div class="fgrp" style="margin-top:10px"><label class="flbl">Catatan Admin</label><input type="text" class="finp" id="impNote" value="'+esc(r.adminNote||'')+'" placeholder="Catatan..."></div>';
  var act=document.getElementById('impDetailAct');
  if(canHandle&&r.status==='pending'){
    act.innerHTML='<button class="btn btn-g" onclick="updImp(\''+key+'\',\'accepted\')">‚úì Terima</button><button class="btn btn-d" onclick="updImp(\''+key+'\',\'denied\')">‚úó Tolak</button>';
  } else {
    act.innerHTML='<span class="bdg b-'+r.status+'">'+r.status.toUpperCase()+'</span>';
  }
  om('moImport');
}

async function updImp(key,status){
  var note=document.getElementById('impNote');var noteVal=note?note.value:'';
  var snap=await DB.ref('import_requests/'+key).get();var r=snap.val();
  await DB.ref('import_requests/'+key).update({status:status,adminNote:noteVal,reviewedBy:UP.username,reviewedAt:Date.now()});
  addLog('IMPORT','Import '+status+': '+r.charName+' ('+r.type+') oleh '+UP.username);
  toast('Import '+status+'!','s');cm('moImport');loadAdmImport();
}

// ============================================================
// USERS ADMIN
// ============================================================
async function loadAdmUsers(){
  var tb=document.getElementById('tbUsers');if(!tb)return;
  tb.innerHTML='<tr class="empty-row"><td colspan="7">Memuat...</td></tr>';
  var results=await Promise.all([DB.ref('users').get(),DB.ref('admin_perms').get()]);
  if(!results[0].exists()){tb.innerHTML='<tr class="empty-row"><td colspan="7">Tidak ada user.</td></tr>';return}
  var perms=results[1].val()||{};
  var users=Object.entries(results[0].val()).map(function(e){return Object.assign({},e[1],{_key:e[0]})}).sort(function(a,b){return(a.createdAt||0)-(b.createdAt||0)});
  tb.innerHTML=users.map(function(u){
    var p=perms[u._key]||{},role=p.role||u.role||'user',isBanned=u.status==='banned';
    var permsArr=p.perms||[];
    return '<tr>'+
      '<td><span class="'+rc(role)+'">'+esc(u.username||'')+'</span>'+(isBanned?' <span class="bdg b-banned" style="font-size:8px">BAN</span>':'')+'</td>'+
      '<td style="font-size:10px;color:var(--t3)">'+esc(u.email||'')+'</td>'+
      '<td><span style="font-size:11px">'+esc(RLBL[role]||role)+'</span></td>'+
      '<td>'+(u.wlStatus==='accepted'?'<span class="bdg b-accepted" style="font-size:8px">‚úì</span>':'‚Äî')+'</td>'+
      '<td style="font-size:10.5px">'+esc(u.icName||'‚Äî')+'</td>'+
      '<td style="font-size:10px">'+fmtD(u.createdAt)+'</td>'+
      '<td style="white-space:nowrap">'+
        (hasPerm('manage_roles')?'<button class="atb" id="rb-'+u._key+'">Role</button> ':'')+
        (hasPerm('edit_icname')?'<button class="atb" id="ib-'+u._key+'">IC</button> ':'')+
        (hasPerm('ban_user')&&!isBanned?'<button class="atb r" id="bb-'+u._key+'">Ban</button>':'')+
        (hasPerm('ban_user')&&isBanned?'<button class="atb g" id="ub-'+u._key+'">Unban</button>':'')+
      '</td>'+
    '</tr>';
  }).join('');
  // Attach handlers
  users.forEach(function(u){
    var p=perms[u._key]||{},role=p.role||u.role||'user',permsArr=p.perms||[];
    var rb=document.getElementById('rb-'+u._key);
    if(rb)rb.addEventListener('click',function(){openRoleModal(u._key,u.username||'',role,permsArr)});
    var ib=document.getElementById('ib-'+u._key);
    if(ib)ib.addEventListener('click',function(){openICModal(u._key,u.username||'',u.icName||'')});
    var bb=document.getElementById('bb-'+u._key);
    if(bb)bb.addEventListener('click',function(){openBanModal(u._key,u.username||'')});
    var ub=document.getElementById('ub-'+u._key);
    if(ub)ub.addEventListener('click',function(){unban(u._key)});
  });
}

function openRoleModal(uid,name,role,permsArr){
  roleTarget={uid:uid,name:name,role:role,newRole:role,newPerms:permsArr.slice()};
  document.getElementById('roleInfo').textContent='User: '+name+' | Role: '+(RLBL[role]||role);
  document.getElementById('roleSelect').innerHTML=ROLES.map(function(r){return'<div class="role-chip'+(r===role?' sel':'')+'" data-r="'+r+'">'+RLBL[r]+'</div>'}).join('');
  document.getElementById('permSelect').innerHTML=ALL_PERMS.map(function(p){return'<div class="perm-tag'+(permsArr.indexOf(p)>=0?' on':' off')+'" data-p="'+p+'">'+PERM_LBL[p]+'</div>'}).join('');
  document.querySelectorAll('#roleSelect .role-chip').forEach(function(el){
    el.addEventListener('click',function(){
      document.querySelectorAll('#roleSelect .role-chip').forEach(function(c){c.classList.remove('sel')});
      el.classList.add('sel');roleTarget.newRole=el.dataset.r;
    });
  });
  document.querySelectorAll('#permSelect .perm-tag').forEach(function(el){
    el.addEventListener('click',function(){
      el.classList.toggle('on');el.classList.toggle('off');
      var p=el.dataset.p;
      if(el.classList.contains('on')){if(roleTarget.newPerms.indexOf(p)<0)roleTarget.newPerms.push(p)}
      else{roleTarget.newPerms=roleTarget.newPerms.filter(function(x){return x!==p})}
    });
  });
  om('moRole');
}

async function confirmRole(){
  if(!roleTarget)return;
  await DB.ref('users/'+roleTarget.uid).update({role:roleTarget.newRole});
  await DB.ref('admin_perms/'+roleTarget.uid).set({uid:roleTarget.uid,username:roleTarget.name,role:roleTarget.newRole,perms:roleTarget.newPerms,setAt:Date.now(),setBy:UP.username});
  addLog('ROLE','Role: '+roleTarget.name+' ‚Üí '+roleTarget.newRole+' | Perms: '+roleTarget.newPerms.join(',')+' | oleh '+UP.username);
  toast('Role diperbarui!','s');cm('moRole');loadAdmUsers();
}

function openBanModal(uid,name){
  banTarget={uid:uid,name:name};
  document.getElementById('banInfo').textContent='Akan ban: '+name;
  document.getElementById('banReason').value='';om('moBan');
}
async function confirmBan(){
  if(!banTarget)return;var reason=document.getElementById('banReason').value.trim();
  if(!reason){toast('Isi alasan!','e');return}
  await DB.ref('users/'+banTarget.uid).update({status:'banned',banReason:reason,bannedBy:UP.username,bannedAt:Date.now()});
  addLog('BAN','Ban: '+banTarget.name+' ‚Äî '+reason+' oleh '+UP.username);
  toast('User dibanned.','s');cm('moBan');loadAdmUsers();
}
async function unban(uid){
  if(!confirm('Unban user ini?'))return;
  await DB.ref('users/'+uid).update({status:'active',banReason:'',bannedBy:''});
  toast('User di-unban.','s');loadAdmUsers();
}
function openICModal(uid,name,icName){
  icTarget={uid:uid,name:name};
  document.getElementById('icInfo').textContent='User: '+name;
  document.getElementById('icInput').value=icName;om('moIC');
}
async function confirmIC(){
  if(!icTarget)return;var n=document.getElementById('icInput').value.trim();
  if(!n){toast('Nama IC kosong!','e');return}
  await DB.ref('users/'+icTarget.uid).update({icName:n});
  addLog('ROLE','IC Name '+icTarget.name+': '+n);toast('IC Name diperbarui!','s');cm('moIC');loadAdmUsers();
}

async function loadAdmBanned(){
  var tb=document.getElementById('tbBanned');if(!tb)return;
  var snap=await DB.ref('users').orderByChild('status').equalTo('banned').get();
  if(!snap.exists()){tb.innerHTML='<tr class="empty-row"><td colspan="5">Tidak ada user banned.</td></tr>';return}
  tb.innerHTML=Object.entries(snap.val()).map(function(e){
    var k=e[0],u=e[1];
    return '<tr><td>'+esc(u.username||'')+'</td><td style="font-size:10px">'+esc(u.email||'')+'</td><td>'+esc(u.banReason||'')+'</td><td>'+esc(u.bannedBy||'')+'</td><td><button class="atb g" onclick="unban(\''+k+'\')">Unban</button></td></tr>';
  }).join('');
}

async function loadAdmReports(){
  var tb=document.getElementById('tbReports');if(!tb)return;
  var snap=await DB.ref('reports').get();
  if(!snap.exists()){tb.innerHTML='<tr class="empty-row"><td colspan="6">Tidak ada laporan.</td></tr>';return}
  var entries=Object.entries(snap.val()).map(function(e){return Object.assign({},e[1],{_key:e[0]})}).sort(function(a,b){return b.createdAt-a.createdAt});
  tb.innerHTML=entries.map(function(r){
    return '<tr><td>'+esc(r.reporter||'')+'</td><td>'+esc(r.target||'')+'</td><td>'+esc(r.type||'')+'</td><td><span class="bdg b-'+(r.status==='open'?'open':'accepted')+'">'+r.status.toUpperCase()+'</span></td><td style="font-size:10px">'+fmtD(r.createdAt)+'</td><td><button class="atb g" onclick="closeReport(\''+r._key+'\')">Tutup</button></td></tr>';
  }).join('');
}
async function closeReport(key){await DB.ref('reports/'+key).update({status:'closed',closedBy:UP.username});toast('Report ditutup.','i');loadAdmReports()}

// ============================================================
// ADMIN CHAT
// ============================================================
function loadAdmChat(){
  if(admChatListen)admChatListen();
  var el=document.getElementById('admChatMsgs');if(!el)return;
  admChatListen=DB.ref('admin_chat').orderByChild('ts').limitToLast(100).on('value',function(snap){
    if(!snap.exists()){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--t3);font-size:11px">Belum ada pesan.</div>';return}
    el.innerHTML=Object.values(snap.val()).map(function(m){
      var mine=m.uid===( CU&&CU.uid);
      return '<div class="adm-msg '+(mine?'mine':'theirs')+'"><div class="adm-msg-meta"><span class="'+rc(m.role)+'">['+esc(RLBL[m.role]||m.role)+']</span> '+esc(m.author||'')+'</div><div class="adm-msg-txt">'+esc(m.text||'')+'</div><div class="adm-msg-time">'+ago(m.ts)+'</div></div>';
    }).join('');
    el.scrollTop=el.scrollHeight;
  });
}

async function sendAdmChat(){
  var inp=document.getElementById('admChatIn');
  if(!inp||!inp.value.trim()||!CU)return;
  var text=inp.value.trim();inp.value='';
  await DB.ref('admin_chat').push({uid:CU.uid,author:UP.username,role:UP.role||'user',text:text,ts:Date.now()});
}

// ============================================================
// ANNOUNCE ADMIN
// ============================================================
function selAnnTag(el,tag){
  document.querySelectorAll('#annTagPick .role-chip').forEach(function(c){c.classList.remove('sel')});
  el.classList.add('sel');selAnnTagVal=tag;
}
async function loadAdmAnn(){
  var el=document.getElementById('annAdmList');if(!el)return;
  var snap=await DB.ref('announcements').orderByChild('ts').limitToLast(20).get();
  if(!snap.exists()){el.innerHTML='<div style="color:var(--t3);font-size:11px;padding:4px">Belum ada pengumuman.</div>';return}
  el.innerHTML=Object.entries(snap.val()).reverse().map(function(e){
    var k=e[0],a=e[1];
    return '<div style="padding:9px;border-bottom:1px solid var(--b2)"><div style="font-size:11.5px;font-weight:600">'+esc(a.title||'')+'</div><div style="font-size:9.5px;color:var(--t3)">'+esc(a.tag)+' ‚Ä¢ '+fmtD(a.ts)+'</div><button class="atb r" style="margin-top:4px" onclick="delAnn(\''+k+'\')">Hapus</button></div>';
  }).join('');
}
async function postAnn(){
  var title=document.getElementById('annTtlIn').value.trim(),body=document.getElementById('annBodyIn').value.trim();
  if(!title||!body){toast('Isi judul dan isi!','e');return}
  var key=DB.ref('announcements').push().key;
  await DB.ref('announcements/'+key).set({tag:selAnnTagVal,title:title,content:body,author:UP.username,uid:CU.uid,ts:Date.now()});
  addLog('NEWS','Pengumuman baru: "'+title+'" oleh '+UP.username);
  toast('Pengumuman diposting!','s');document.getElementById('annTtlIn').value='';document.getElementById('annBodyIn').value='';loadAdmAnn();loadAnn();
}
async function delAnn(key){if(!confirm('Hapus pengumuman?'))return;await DB.ref('announcements/'+key).remove();toast('Dihapus.','i');loadAdmAnn()}

// ============================================================
// GUIDES ADMIN
// ============================================================
async function loadAdmGuides(){
  var tf=document.getElementById('guideTypeF');var type=tf?tf.value:'rules';
  var el=document.getElementById('guideAdmList');if(!el)return;
  var snap=await DB.ref('guides').orderByChild('type').equalTo(type).get();
  if(!snap.exists()){el.innerHTML='<div style="color:var(--t3);font-size:11px;padding:4px">Belum ada artikel.</div>';return}
  el.innerHTML=Object.entries(snap.val()).map(function(e){
    var k=e[0],g=e[1];
    var gJson=JSON.stringify(g).replace(/'/g,"\\'");
    return '<div style="padding:9px;border-bottom:1px solid var(--b2)"><div style="font-size:11.5px;font-weight:600">'+(g.pinned?'üìå ':'')+esc(g.title||'')+'</div><div style="font-size:9.5px;color:var(--t3)">'+esc(g.tag||'')+' ‚Ä¢ '+fmtD(g.createdAt)+'</div><div style="display:flex;gap:5px;margin-top:5px"><button class="atb" id="ge-'+k+'">Edit</button><button class="atb r" id="gd-'+k+'">Hapus</button></div></div>';
  }).join('');
  // Attach handlers
  Object.entries(snap.val()).forEach(function(e){
    var k=e[0],g=e[1];
    var geBtn=document.getElementById('ge-'+k);
    if(geBtn)geBtn.addEventListener('click',function(){editGuideItem(k,g)});
    var gdBtn=document.getElementById('gd-'+k);
    if(gdBtn)gdBtn.addEventListener('click',function(){delGuide(k)});
  });
}

function editGuideItem(key,g){
  editGuideKey=key;
  document.getElementById('guideTtlIn').value=g.title||'';
  document.getElementById('guideTagIn').value=g.tag||'';
  document.getElementById('guideBodyIn').value=g.body||'';
  document.getElementById('guidePinned').checked=g.pinned||false;
  document.getElementById('guideFormTtl').textContent='Edit Artikel';
  document.getElementById('cancelGuideBtn').style.display='';
}
function cancelGuide(){
  editGuideKey=null;
  document.getElementById('guideTtlIn').value='';document.getElementById('guideTagIn').value='';
  document.getElementById('guideBodyIn').value='';document.getElementById('guidePinned').checked=false;
  document.getElementById('guideFormTtl').textContent='Tambah Artikel';
  document.getElementById('cancelGuideBtn').style.display='none';
}
async function submitGuide(){
  var tf=document.getElementById('guideTypeF');var type=tf?tf.value:'rules';
  var title=document.getElementById('guideTtlIn').value.trim();
  var tag=document.getElementById('guideTagIn').value.trim();
  var body=document.getElementById('guideBodyIn').value.trim();
  var pinned=document.getElementById('guidePinned').checked;
  if(!title||!body){toast('Isi judul dan konten!','e');return}
  var data={type:type,title:title,tag:tag,body:body,pinned:pinned,author:UP.username,createdAt:Date.now()};
  if(editGuideKey){await DB.ref('guides/'+editGuideKey).update(data);toast('Diperbarui!','s')}
  else{await DB.ref('guides').push(data);toast('Artikel ditambahkan!','s')}
  delete gcache[type];cancelGuide();loadAdmGuides();
}
async function delGuide(key){
  var tf=document.getElementById('guideTypeF');var type=tf?tf.value:'rules';
  if(!confirm('Hapus artikel?'))return;
  await DB.ref('guides/'+key).remove();delete gcache[type];toast('Dihapus.','i');loadAdmGuides();
}

// ============================================================
// STAFF ADMIN
// ============================================================
async function loadAdmStaff(){
  var tb=document.getElementById('tbStaff');if(!tb)return;
  var snap=await DB.ref('staff').orderByChild('order').get();
  if(!snap.exists()){tb.innerHTML='<tr class="empty-row"><td colspan="4">Belum ada staff.</td></tr>';return}
  var entries=Object.entries(snap.val());
  tb.innerHTML=entries.map(function(e){
    var k=e[0],s=e[1];
    return '<tr><td><span class="'+(s.class||'r-user')+'">'+esc(s.name||'‚Äî')+'</span></td><td>'+esc(s.role||'')+'</td><td style="font-size:10px">'+esc(s.wa?'+'+s.wa:'‚Äî')+'</td><td><button class="atb r" id="ds-'+k+'">Hapus</button></td></tr>';
  }).join('');
  entries.forEach(function(e){
    var k=e[0];var btn=document.getElementById('ds-'+k);
    if(btn)btn.addEventListener('click',function(){delStaff(k)});
  });
}
async function addStaff(){
  var name=document.getElementById('staffNameIn').value.trim();
  var role=document.getElementById('staffRoleIn').value;
  var wa=document.getElementById('staffWAIn').value.trim();
  if(!name){toast('Isi nama!','e');return}
  var rCls={Owner:'r-owner','Co-Owner':'r-owner',Developer:'r-developer','Head Admin':'r-headadmin','Senior Admin':'r-senioradmin',Admin:'r-admin','Junior Admin':'r-junioradmin',Management:'r-management',Moderator:'r-moderator','Community Handle':'r-communityhandle','Senior Helper':'r-seniorhelper',Helper:'r-helper','Junior Helper':'r-juniorhelper',Volunteer:'r-volunteer','Ex Staff':'r-exstaff'};
  var count=(await DB.ref('staff').get()).numChildren();
  await DB.ref('staff').push({name:name,role:role,wa:wa||'',class:rCls[role]||'r-user',emoji:'',order:count+1});
  toast('Staff ditambahkan!','s');document.getElementById('staffNameIn').value='';document.getElementById('staffWAIn').value='';loadAdmStaff();
}
async function delStaff(key){if(!confirm('Hapus staff ini?'))return;await DB.ref('staff/'+key).remove();toast('Dihapus.','i');loadAdmStaff()}

// ============================================================
// SETTINGS
// ============================================================
function loadSettingsForm(){
  function sv(id,v){var e=document.getElementById(id);if(e)e.value=(v!==undefined&&v!==null)?v:''}
  sv('cfgIP',CFG.serverIP);sv('cfgName',CFG.serverName);sv('cfgWA',CFG.waNumber);sv('cfgWAG',CFG.waGroup);sv('cfgDesc',CFG.description);sv('cfgCD',SCFG.postCooldownMin||60);
  sv('cfgWLOpen',SCFG.wlOpen===false?'0':'1');sv('cfgWLReq',SCFG.wlRequirements||'Min. 17 tahun\nWhatsApp aktif\nMengerti RP dasar');
  sv('cfgCSOpen',SCFG.csOpen===false?'0':'1');sv('cfgCSInfo',SCFG.csInfo||'');sv('cfgCSSched',SCFG.csSchedules||'Senin 19:00,Kamis 19:00');sv('cfgCSMin',SCFG.csMinWords||150);sv('cfgCSPan',SCFG.csPanduan||'');
  sv('cfgImpOpen',SCFG.importOpen===false?'0':'1');sv('cfgGood',SCFG.goodsideOpen===false?'0':'1');sv('cfgBad',SCFG.badsideOpen===false?'0':'1');sv('cfgFam',SCFG.familyOpen===false?'0':'1');sv('cfgImpInfo',SCFG.importInfo||'');sv('cfgImpReq',SCFG.importRequirements||'');
}
async function saveSrvCfg(){
  await DB.ref('config').update({serverIP:document.getElementById('cfgIP').value.trim(),serverName:document.getElementById('cfgName').value.trim(),waNumber:document.getElementById('cfgWA').value.trim(),waGroup:document.getElementById('cfgWAG').value.trim(),description:document.getElementById('cfgDesc').value.trim()});
  await DB.ref('settings/postCooldownMin').set(parseInt(document.getElementById('cfgCD').value)||60);
  addLog('SYSTEM','Config server diperbarui oleh '+UP.username);toast('Tersimpan!','s');
}
async function saveWLCfg(){await DB.ref('settings').update({wlOpen:document.getElementById('cfgWLOpen').value==='1',wlRequirements:document.getElementById('cfgWLReq').value.trim()});addLog('SYSTEM','Config WL diperbarui');toast('Config WL tersimpan!','s')}
async function saveCScfg(){await DB.ref('settings').update({csOpen:document.getElementById('cfgCSOpen').value==='1',csInfo:document.getElementById('cfgCSInfo').value.trim(),csSchedules:document.getElementById('cfgCSSched').value.trim(),csMinWords:parseInt(document.getElementById('cfgCSMin').value)||150,csPanduan:document.getElementById('cfgCSPan').value.trim()});addLog('SYSTEM','Config CS diperbarui');toast('Config CS tersimpan!','s')}
async function saveImpCfg(){await DB.ref('settings').update({importOpen:document.getElementById('cfgImpOpen').value==='1',goodsideOpen:document.getElementById('cfgGood').value==='1',badsideOpen:document.getElementById('cfgBad').value==='1',familyOpen:document.getElementById('cfgFam').value==='1',importInfo:document.getElementById('cfgImpInfo').value.trim(),importRequirements:document.getElementById('cfgImpReq').value.trim()});addLog('SYSTEM','Config Import diperbarui');toast('Config Import tersimpan!','s')}

// ============================================================
// TABLE FILTER
// ============================================================
function ftbl(tblId,q){
  var tbody=document.getElementById(tblId);if(!tbody)return;
  var rows=tbody.getElementsByTagName('tr');
  for(var i=0;i<rows.length;i++){
    var tr=rows[i];
    tr.style.display=(tr.textContent.toLowerCase().indexOf(q.toLowerCase())>=0||tr.classList.contains('empty-row'))?'':'none';
  }
}

// ============================================================
// RESPONSIVE ADMIN GRIDS
// ============================================================
function checkAdmGrids(){
  var w=window.innerWidth;
  ['annAdmGrid','guideAdmGrid','staffAdmGrid'].forEach(function(id){
    var el=document.getElementById(id);if(!el)return;
    el.style.gridTemplateColumns=w<700?'1fr':'1fr 280px';
  });
}
window.addEventListener('resize',checkAdmGrids);
window.addEventListener('click',function(e){
  var menu=document.getElementById('admMobMenu');
  var btn=document.getElementById('admMenuBtn');
  if(menu&&btn&&menu.style.display==='block'&&!menu.contains(e.target)&&!btn.contains(e.target)){
    menu.style.display='none';
  }
});

// ============================================================
// INIT
// ============================================================
window.addEventListener('DOMContentLoaded',function(){
  nav('home');
  checkAdmGrids();
  // Hide loader after max 2s regardless
  setTimeout(function(){hideLoader()},2000);
});

function hideLoader(){
  var loader=document.getElementById('loader');
  if(loader&&!loader.classList.contains('hidden'))loader.classList.add('hidden');
}

</script>
</body>
</html>
