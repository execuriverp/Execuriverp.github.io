<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ExeMusic 3.1 - Updated</title>
  <link rel="icon" type="image/png" href="exemusicicon.png">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --accent: #00ff88; 
      --text: #ffffff;
      --text-dim: #b3b3b3;
      --bg: #050505;
      --card-bg: #121212;
      --glass: rgba(255, 255, 255, 0.05);
      --danger: #ff3333;
      --warning: #ffcc00;
      --tiktok-red: #ff0050;
      --gold: #ffd700;
      --purple: #bf00ff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    /* --- ROBLOX STYLE BROADCAST SYSTEM --- */
    .sys-broadcast {
        position: fixed;
        top: -150px; 
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
        background: rgba(15, 15, 15, 0.95);
        border-left: 4px solid var(--accent);
        border-radius: 6px;
        padding: 15px;
        z-index: 12000;
        box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease, transform 0.4s ease;
        backdrop-filter: blur(10px);
    }
    .sys-broadcast.active { top: 20px; }
    
    .sb-content { display: flex; align-items: flex-start; gap: 12px; }
    .sb-icon { font-size: 20px; color: var(--accent); margin-top: 2px; }
    .sb-text h4 { margin: 0; font-size: 14px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
    .sb-text p { margin: 4px 0 0; font-size: 12px; color: #ddd; line-height: 1.4; }
    
    .sb-close {
        position: absolute; top: 10px; right: 10px;
        background: transparent; border: none; color: #666;
        cursor: pointer; font-size: 16px; padding: 5px;
    }
    .sb-close:hover { color: white; }

    .sb-progress {
        width: 100%; height: 3px; background: #333;
        margin-top: 12px; border-radius: 2px; overflow: hidden;
    }
    .sb-bar {
        width: 100%; height: 100%; background: var(--accent);
        transform-origin: left;
    }
    @keyframes countDown { from { transform: scaleX(1); } to { transform: scaleX(0); } }
    @keyframes disco-pulse { 0% { border-color: rgba(255,255,255,0.08); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 50% { border-color: rgba(var(--accent), 0.3); box-shadow: 0 20px 50px rgba(var(--accent), 0.2); } 100% { border-color: rgba(255,255,255,0.08); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } }
    @keyframes disco-heartbeat { 
      0% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 
      20% { transform: scale(1.02); box-shadow: 0 25px 60px var(--accent)80; } 
      40% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 
      60% { transform: scale(1.03); box-shadow: 0 30px 70px var(--accent); } 
      100% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); } 
    }
    @keyframes rainbow-glow { 
      0% { border-color: #ff0000; box-shadow: inset 0 0 20px #ff0000, 0 20px 50px #ff000080; } 
      16% { border-color: #ff7f00; box-shadow: inset 0 0 20px #ff7f00, 0 20px 50px #ff7f0080; } 
      33% { border-color: #ffff00; box-shadow: inset 0 0 20px #ffff00, 0 20px 50px #ffff0080; } 
      50% { border-color: #00ff00; box-shadow: inset 0 0 20px #00ff00, 0 20px 50px #00ff0080; } 
      66% { border-color: #0000ff; box-shadow: inset 0 0 20px #0000ff, 0 20px 50px #0000ff80; } 
      83% { border-color: #8b00ff; box-shadow: inset 0 0 20px #8b00ff, 0 20px 50px #8b00ff80; } 
      100% { border-color: #ff0000; box-shadow: inset 0 0 20px #ff0000, 0 20px 50px #ff000080; } 
    }
    @keyframes snowfall { 
      0% { transform: translateY(-10px) translateX(0); opacity: 1; } 
      25% { transform: translateY(25vh) translateX(15px); opacity: 1; }
      50% { transform: translateY(50vh) translateX(-10px); opacity: 1; }
      75% { transform: translateY(75vh) translateX(20px); opacity: 1; }
      100% { transform: translateY(100vh) translateX(0); opacity: 0; } 
    }
    .snowflake { 
      position: fixed; 
      top: -10px; 
      color: #00d4ff; 
      font-size: 1.5em; 
      font-family: Arial, sans-serif; 
      text-shadow: 0 0 5px #00d4ff; 
      z-index: 1;
      pointer-events: none;
      animation: snowfall linear forwards;
    }

    /* --- OVERLAYS --- */
    .full-overlay {
      position: fixed; inset: 0; background: #000; z-index: 10000;
      display: none; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; padding: 30px;
    }
    .full-overlay i { font-size: 60px; margin-bottom: 20px; }
    .full-overlay h1 { font-size: 24px; color: var(--accent); }
    .full-overlay p { color: var(--text-dim); margin-top: 10px; }
    #bannedScreen h1 { color: var(--danger); }

    #loadingCard {
      position: absolute; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: 0.5s;
    }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--glass); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- MAIN APP --- */
    .app {
      background: rgba(18, 18, 18, 0.6);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 35px;
      width: 95%; max-width: 400px; 
      height: 95vh;
      display: flex; flex-direction: column; 
      padding: 25px; 
      position: relative;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; margin-bottom: 15px; }
    .header img { width: 110px; cursor: pointer; transition: 0.3s; }
    .header img:active { transform: scale(0.9); }
    
    .header-right { display: flex; align-items: center; gap: 10px; }
    
    #btnNotif {
      position: relative;
      width: 42px; height: 42px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: 0.2s;
    }
    #btnNotif:hover { background: var(--accent); color: black; border-color: var(--accent); }
    #btnNotif:active { transform: scale(0.95); }
    #btnNotif .notif-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      min-width: 18px;
      height: 18px;
      background: var(--danger);
      border-radius: 9px;
      font-size: 10px;
      font-weight: 700;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    #btnNotif .notif-badge.show { display: flex; }
    
    #topLoginBtn { 
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); 
      color: white; padding: 8px 16px; border-radius: 20px; font-size: 11px; cursor: pointer;
      font-weight: 600; transition: 0.2s;
    }
    #topLoginBtn:hover { background: var(--accent); color: black; border-color: var(--accent); }

    /* Notif/Chat panel - TikTok/ML style */
    .notif-panel {
      position: fixed;
      top: 70px;
      right: 20px;
      width: calc(100vw - 40px);
      max-width: 360px;
      max-height: 70vh;
      background: rgba(24, 24, 24, 0.98);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.6);
      z-index: 2500;
      display: none;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(20px);
      animation: notifPanelIn 0.25s ease;
    }
    .notif-panel.show { display: flex; }
    @keyframes notifPanelIn {
      from { opacity: 0; transform: translateY(-15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .notif-panel-header {
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .notif-panel-header h3 {
      margin: 0;
      font-size: 16px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .notif-panel-close {
      background: none;
      border: none;
      color: #888;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
    }
    .notif-panel-close:hover { color: white; }
    .notif-list {
      overflow-y: auto;
      flex: 1;
      padding: 8px 0;
      min-height: 120px;
      max-height: 60vh;
    }
    .notif-list::-webkit-scrollbar { width: 6px; }
    .notif-list::-webkit-scrollbar-track { background: #111; border-radius: 10px; }
    .notif-list::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    .notif-item {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: background 0.2s;
      cursor: default;
    }
    .notif-item:hover { background: rgba(255,255,255,0.04); }
    .notif-item-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .notif-item-icon.admin { background: rgba(255,51,51,0.2); color: #ff6b6b; }
    .notif-item-icon.violation { background: rgba(255,204,0,0.2); color: var(--warning); }
    .notif-item-icon.upload { background: rgba(0,255,136,0.15); color: var(--accent); }
    .notif-item-icon.follow { background: rgba(255,0,80,0.15); color: var(--tiktok-red); }
    .notif-item-icon.system { background: rgba(0,212,255,0.15); color: #00d4ff; }
    .notif-item-body { flex: 1; min-width: 0; }
    .notif-item-body .n-text { font-size: 13px; color: #ddd; line-height: 1.4; }
    .notif-item-body .n-time { font-size: 11px; color: #666; margin-top: 4px; }
    .notif-empty {
      padding: 30px 20px;
      text-align: center;
      color: #555;
      font-size: 13px;
    }
    @media (max-width: 480px) {
      .notif-panel {
        right: 10px;
        left: 10px;
        width: auto;
        max-width: none;
      }
    }

    .cover-box {
      flex: 1; width: 100%; border-radius: 25px;
      background: #000; display: flex; align-items: center; justify-content: center;
      margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
      overflow: hidden; position: relative; z-index: 10; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .eq { display: flex; align-items: flex-end; gap: 5px; height: 60px; position: relative; z-index: 15; }
    .eq span { width: 6px; background: var(--accent); border-radius: 10px; height: 10px; transition: height 0.2s ease; box-shadow: 0 0 15px var(--accent); }
    .playing span { animation: wave 0.8s infinite ease-in-out; }
    .playing span:nth-child(1) { animation-delay: 0.1s; }
    .playing span:nth-child(2) { animation-delay: 0.3s; }
    .playing span:nth-child(3) { animation-delay: 0.2s; }
    .playing span:nth-child(4) { animation-delay: 0.4s; }
    @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 50px; } }

    .track-info { margin-bottom: 20px; flex-shrink: 0; text-align: left; }
    #title { font-size: 22px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 5px; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
    
    .user-row { display: flex; align-items: center; gap: 10px; }
    #by { color: var(--accent); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    
    #btnFollow { 
      font-size: 12px; 
      background: var(--tiktok-red); 
      color: white; 
      border: none; 
      width: 22px; height: 22px; 
      border-radius: 50%; 
      font-weight: bold; 
      cursor: pointer; 
      display: none; 
      transition: 0.2s; 
      align-items: center; 
      justify-content: center;
    }
    #btnFollow:active { transform: scale(0.9); }

    .sys-container { background: rgba(255,255,255,0.03); border-radius: 18px; padding: 12px; margin-bottom: 15px; flex-shrink: 0; z-index: 5;}
    .sys-tools { display: flex; justify-content: space-between; margin-bottom: 8px; padding: 0 10px; }
    .sys-tools button { background: none; border: none; color: white; cursor: pointer; font-size: 18px; opacity: 0.7; transition: 0.2s; }
    .sys-tools button:hover { opacity: 1; transform: translateY(-2px); color: var(--accent); }
    
    .vol-row { display: flex; align-items: center; gap: 10px; padding: 0 5px; }
    #vol { flex: 1; height: 4px; accent-color: var(--accent); cursor: pointer; border-radius: 2px; }

    .prog-area { margin-bottom: 20px; flex-shrink: 0; z-index: 5; }
    #seek { width: 100%; height: 5px; accent-color: var(--accent); cursor: pointer; display: block; border-radius: 2px; }
    .time { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-dim); margin-top: 6px; font-weight: 500; position: relative; align-items: center; }
    
    /* LOADING SPINNER */
    .loading-spinner {
      width: 12px;
      height: 12px;
      border: 2px solid rgba(0, 255, 136, 0.3);
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
      margin: 0 auto;
    }
    .loading-spinner.show { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .dur-wrapper { display: flex; align-items: center; gap: 6px; }

    .main-ctrl { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-bottom: 20px; flex-shrink: 0; position: relative; z-index: 110; }
    .btn-play { width: 65px; height: 65px; background: var(--accent); border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-size: 24px; cursor: pointer; box-shadow: 0 0 25px rgba(0, 255, 136, 0.4); transition: 0.2s; }
    .btn-play:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(0, 255, 136, 0.4); }
    .btn-sec { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 10px; opacity: 0.9; }
    .btn-sec:active { transform: scale(0.9); }

    .footer { margin-top: auto; display: flex; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 15px 30px; border-radius: 25px; flex-shrink: 0; z-index: 10; }
    .footer button { background: none; border: none; color: white; font-size: 18px; opacity: 0.5; cursor: pointer; transition: 0.2s; }
    .footer button:hover { opacity: 1; }
    
    .active { color: var(--accent) !important; opacity: 1 !important; text-shadow: 0 0 10px var(--accent); }

    /* MODALS */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 2000; backdrop-filter: blur(5px); }
    .sheet { position: absolute; bottom: 0; width: 100%; max-width: 400px; left: 50%; transform: translateX(-50%); background: #181818; border-radius: 30px 30px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); border-top: 1px solid #333; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }

    .song-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-radius: 8px; transition: 0.2s; }
    .song-item:hover { background: rgba(255,255,255,0.05); }
    
    #toast { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) translateY(20px); background: #222; border: 1px solid var(--accent); color: var(--accent); padding: 12px 25px; border-radius: 50px; font-size: 13px; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 3000; pointer-events: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .inp-dark { width:100%; padding:14px; margin-bottom:12px; background:#0a0a0a; color:white; border:1px solid #333; border-radius: 12px; font-size: 14px; }
    .inp-dark:focus { border-color: var(--accent); }
    .btn-act { width:100%; padding:14px; background:var(--accent); border:none; border-radius:12px; font-weight:bold; color:black; cursor: pointer; margin-top: 5px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
    
    .prof-stat { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
    .prof-stat div { text-align: center; }
    .prof-stat b { display: block; font-size: 20px; color: white; }
    .prof-stat span { font-size: 11px; color: var(--text-dim); text-transform: uppercase; }
    .section-title { font-size: 12px; font-weight: bold; margin: 20px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

    /* PROFILE TAB STYLES */
    .profile-tabs-wrapper { display: flex; gap: 0; margin: 20px -25px 0 -25px; border-bottom: 2px solid #222; }
    .profile-tab-btn { 
      flex: 1; 
      background: transparent; 
      border: none; 
      color: #666; 
      padding: 15px 20px; 
      cursor: pointer; 
      border-bottom: 3px solid transparent;
      text-transform: uppercase; 
      font-weight: 600; 
      font-size: 12px;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      position: relative;
    }
    .profile-tab-btn:hover { color: #999; }
    .profile-tab-btn.active { 
      color: var(--accent); 
      border-bottom-color: var(--accent);
    }

    .profile-tab-content { 
      display: none; 
      padding: 25px 0;
      animation: fadeIn 0.3s ease;
    }
    .profile-tab-content.active { display: block; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* PROFILE GRID IMPROVEMENTS */
    .profile-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 25px 0;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 15px;
      border: 1px solid #333;
    }
    .profile-stat-item {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      background: transparent;
      transition: all 0.2s ease;
      border: none;
    }
    .profile-stat-item:hover {
      background: transparent;
      transform: translateY(-2px);
      border-color: transparent;
    }
    .profile-stat-item b { 
      display: block; 
      font-size: 24px; 
      color: #fff;
      margin-bottom: 5px;
    }
    .profile-stat-item span { 
      font-size: 11px; 
      color: var(--text-dim); 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ACCOUNT SETTINGS STYLES */
    .account-setting-box {
      padding: 18px;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.03);
      border: 1px solid #333;
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .account-setting-box:hover {
      background: rgba(255,255,255,0.05);
      border-color: #444;
    }
    .account-setting-label {
      color: var(--accent);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: block;
    }
    .account-setting-value {
      color: #ddd;
      font-size: 13px;
      word-break: break-all;
      margin-bottom: 12px;
      padding: 12px;
      background: #0a0a0a;
      border-radius: 8px;
      border: 1px solid #222;
      font-family: 'Courier New', monospace;
    }

    /* RESPONSIVE POST LIST */
    .posts-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; }
    .posts-list::-webkit-scrollbar { width: 6px; }
    .posts-list::-webkit-scrollbar-track { background: #0a0a0a; border-radius: 10px; }
    .posts-list::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    .posts-list::-webkit-scrollbar-thumb:hover { background: #00dd7a; }

    /* BUTTON IMPROVEMENTS */
    .btn-account {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      font-weight: 600;
      color: black;
      cursor: pointer;
      margin-bottom: 10px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s ease;
    }
    .btn-account:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px var(--accent)40;
    }
    .btn-account:active {
      transform: translateY(0);
    }
    .btn-account.danger {
      background: #ff6b6b;
    }
    .btn-account.danger:hover {
      box-shadow: 0 8px 20px #ff6b6b40;
    }
    .btn-account.logout {
      background: #222;
      color: #ff6b6b;
      border: 1px solid #333;
    }
    .btn-account.logout:hover {
      background: #1a1a1a;
      border-color: #ff6b6b;
      box-shadow: 0 8px 20px #ff6b6b20;
    }

    /* MODAL MESSAGE STYLES */
    .modal-msg {
      text-align: center;
      font-size: 12px;
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      display: none;
    }
    .modal-msg.show { display: block; }
    .modal-msg.success {
      color: var(--accent);
      background: rgba(0,255,136,0.1);
      border: 1px solid #00dd7a;
    }
    .modal-msg.error {
      color: #ff6b6b;
      background: rgba(255,107,107,0.1);
      border: 1px solid #ff6b6b;
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 480px) {
      .spotify-banner {
        height: 100px;
        margin: -25px -25px 15px -25px;
        padding: 15px;
      }
      .spotify-avatar {
        width: 70px;
        height: 70px;
        font-size: 24px;
      }
      .spotify-info {
        margin-left: 12px;
      }
      .spotify-info h2 {
        font-size: 18px;
      }
      .profile-stats-grid {
        grid-template-columns: 1fr;
        margin: 20px 0;
        padding: 15px;
        gap: 15px;
      }
      .profile-stats-grid b {
        font-size: 20px;
      }
      .profile-tabs-wrapper {
        margin: 15px -25px 0 -25px;
      }
      .profile-tab-btn {
        padding: 12px 15px;
        font-size: 11px;
      }
      .profile-tab-content {
        padding: 20px 0;
      }
      .account-setting-box {
        padding: 14px;
        margin-bottom: 12px;
      }
      .btn-account {
        padding: 12px;
        font-size: 12px;
        margin-bottom: 8px;
      }
      .posts-list {
        max-height: 200px;
      }
    }

    @media (min-width: 481px) and (max-width: 768px) {
      .profile-stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      .spotify-banner {
        height: 110px;
      }
    }

    @media (min-width: 769px) {
      .profile-stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .v-badge { color: #1da1f2; font-size: 12px; margin-left: 4px; }

    .spotify-banner {
      width: 100%; height: 120px;
      background: linear-gradient(to bottom, var(--accent), #181818);
      margin: -25px -25px 20px -25px;
      border-radius: 30px 30px 0 0;
      display: flex; align-items: flex-end; padding: 20px;
      position: relative;
    }
    .spotify-avatar {
      width: 80px; height: 80px; background: #222; 
      border-radius: 50%; box-shadow: 0 8px 25px rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center; font-size: 30px;
      border: 3px solid #181818;
      overflow: hidden;
      position: relative;
    }
    .spotify-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-edit {
        position: absolute; inset: 0; background: rgba(0,0,0,0.5);
        display: none; align-items: center; justify-content: center;
        font-size: 14px; cursor: pointer; color: white;
    }
    .spotify-avatar:hover .avatar-edit { display: flex; }

    .spotify-info { margin-left: 15px; }
    .spotify-info h2 { font-size: 24px; margin: 0; }
    
    /* Updated Tag Styles */
    .user-tag {
      font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 800;
      text-transform: uppercase; margin-left: 5px; vertical-align: middle; letter-spacing: 0.5px;
    }
    .tag-admin { background: #ff3333; color: #fff; }
    .tag-owner { background: gold; color: #000; animation: pulse 2s infinite; }
    .tag-staff { background: #0088ff; color: #fff; }
    .tag-executive { background: #aa00ff; color: #fff; }
    .tag-user { background: #444; color: #eee; }
    .tag-sepuh { background: #1a1a1a; color: var(--accent); border: 1px solid var(--accent); }
    .tag-rich { background: linear-gradient(45deg, gold, #fff); color: #000; }
    .tag-galau { background: #555; color: #fff; font-style: italic; }
    .tag-cheater { background: #ff0050; color: #fff; text-decoration: line-through; }
    .tag-vvip { background: var(--purple); color: #fff; box-shadow: 0 0 10px var(--purple); }
    
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }

    /* About Modal Styling */
    .about-box { font-size: 13px; line-height: 1.6; color: #ccc; }
    .about-box h3 { color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
    .about-box p { margin-bottom: 10px; }
    .about-box b { color: #fff; }
    .about-features { margin: 8px 0 12px 18px; padding: 0; }
    .about-features li { margin-bottom: 8px; }
    .about-footer { font-size: 12px; color: #888; margin-top: 8px; }
    .about-credit { font-size: 12px; color: #666; margin-top: 8px; }
    .about-dev-link { color: #00d4ff; font-weight: 700; text-decoration: none; text-shadow: 0 0 10px #00d4ff; transition: color 0.2s, text-shadow 0.2s; }
    .about-dev-link:hover { color: #7df9ff; text-shadow: 0 0 15px #7df9ff; }
    .rules-warn { background: rgba(255, 51, 51, 0.1); border-left: 3px solid var(--danger); padding: 10px; margin: 10px 0; border-radius: 4px; }

    /* Broadcast: exit animation & developer name */
    .sys-broadcast.sb-closing {
      top: -180px !important;
      opacity: 0;
      transform: translateX(-50%) translateY(-15px);
      transition: top 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease, transform 0.4s ease;
    }
    .sb-text p .sb-dev-name {
      color: #00d4ff;
      font-weight: 700;
      text-shadow: 0 0 8px #00d4ff;
      display: inline;
    }
  </style>
</head>
<body>

  <div id="sysBroadcast" class="sys-broadcast">
      <button class="sb-close" onclick="closeBroadcast()"><i class="fas fa-times"></i></button>
      <div class="sb-content">
          <i class="fas fa-bullhorn sb-icon"></i>
          <div class="sb-text">
              <h4>Announcement</h4>
              <p id="sbMessage">Loading message...</p>
          </div>
      </div>
      <div class="sb-progress"><div id="sbBar" class="sb-bar"></div></div>
  </div>

  <div id="mtScreen" class="full-overlay">
    <i class="fas fa-tools" style="color: var(--accent)"></i>
    <h1>Server Maintenance</h1>
    <p>Kami sedang melakukan pembaruan sistem.<br>Mohon tunggu beberapa saat lagi.</p>
  </div>

  <div id="bannedScreen" class="full-overlay">
    <i class="fas fa-user-slash" style="color: var(--danger)"></i>
    <h1>Access Denied</h1>
    <p>Akun anda telah diblokir secara permanen oleh admin.</p>
  </div>

  <div id="loadingCard"><div class="spinner"></div></div>
  <div id="toast">Notification</div>

  <div class="app">
    <div class="header">
        <img src="exemusic.png" alt="Logo" onclick="openAbout()">
        <div class="header-right">
          <button id="btnNotif" onclick="toggleNotifPanel()" title="Notifikasi">
            <i class="fas fa-bell"></i>
            <span id="notifBadge" class="notif-badge"></span>
          </button>
          <button id="topLoginBtn" onclick="openProfile()">Log-in</button>
        </div>
    </div>

    <div id="notifPanel" class="notif-panel">
      <div class="notif-panel-header">
        <h3><i class="fas fa-comment-dots"></i> Notifikasi</h3>
        <button class="notif-panel-close" onclick="closeNotifPanel()"><i class="fas fa-times"></i></button>
      </div>
      <div id="notifList" class="notif-list">
        <div class="notif-empty">Memuat...</div>
      </div>
    </div>

    <div class="cover-box">
      <div class="eq" id="eq"><span></span><span></span><span></span><span></span><span></span></div>
    </div>

    <div class="track-info">
      <div id="title">Loading Lagu...</div>
      <div class="user-row">
        <div id="by" onclick="viewCreator()">@system</div>
        <button id="btnFollow" onclick="followUser()"><i class="fas fa-plus"></i></button>
      </div>
    </div>

    <div class="sys-container">
      <div class="sys-tools">
        <button onclick="copyRawUrl()" title="Copy Url"><i class="fas fa-link"></i></button>
        <button onclick="shareLink()" title="Share Link"><i class="fas fa-share-alt"></i></button>
        <button onclick="downloadSong()" title="Download"><i class="fas fa-download"></i></button>
        <button onclick="openReq()" title="Add/Request"><i class="fas fa-plus-circle"></i></button>
      </div>
      <div class="vol-row">
        <i class="fas fa-volume-down" style="font-size:12px; color:#888"></i>
        <input type="range" id="vol" min="0" max="1" step="0.01" value="0.8">
        <i class="fas fa-volume-up" style="font-size:12px; color:#fff"></i>
      </div>
    </div>

    <div class="prog-area">
      <input type="range" id="seek" value="0">
      <div class="time">
        <span id="cur">0:00</span>
        <div class="dur-wrapper">
          <div class="loading-spinner" id="loadSpinner"></div>
          <span id="dur">0:00</span>
        </div>
      </div>
    </div>

    <div class="main-ctrl">
      <button class="btn-sec" onclick="prev()"><i class="fas fa-step-backward"></i></button>
      <button class="btn-play" onclick="toggle()" id="playBtn"><i class="fas fa-play"></i></button>
      <button class="btn-sec" onclick="next()"><i class="fas fa-step-forward"></i></button>
    </div>

    <div class="footer">
      <button id="shuf" onclick="toggleShuffle()"><i class="fas fa-random"></i></button>
      <button onclick="openList(false)"><i class="fas fa-list-ul"></i></button>
      <button onclick="openList(true)"><i class="fas fa-heart"></i></button>
      <button id="adminBtn" style="display:none; color:gold" onclick="openAdmin()"><i class="fas fa-shield-alt"></i></button>
      <button id="rep" onclick="toggleRepeat()"><i class="fas fa-redo"></i></button>
    </div>
  </div>

  <div class="modal" id="modalAuth" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 id="authTitle" style="text-align:center; margin-bottom:20px; color:var(--accent)">Login ke ExeMusic</h3>
      <div id="usernameSection" style="display:none; margin-bottom:15px;">
        <p style="font-size:12px; color:#888; text-align:center; margin-bottom:10px;">üëã Selamat datang! Buat username Anda:</p>
        <input id="authUser" class="inp-dark" placeholder="Username (min 3 karakter)">
      </div>
      <button onclick="handleGoogleAuth()" id="googleAuthBtn" class="btn-act" style="background:#fff; color:#000; display:flex; align-items:center; justify-content:center; gap:10px; font-weight:600;">
        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
        <span id="googleBtnText">Masuk dengan Google</span>
      </button>
      <p style="font-size:11px; color:#888; text-align:center; margin-top:15px;">üîí Login aman dengan akun Google Anda</p>
    </div>
  </div>

  <div class="modal" id="modalProfile" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <div class="spotify-banner">
          <div class="spotify-avatar">
              <img id="pAvatarImg" src="https://via.placeholder.com/150">
              <div class="avatar-edit" onclick="document.getElementById('avatarInp').click()"><i class="fas fa-camera"></i></div>
          </div>
          <input type="file" id="avatarInp" style="display:none" accept="image/*" onchange="uploadAvatar(this)">
          <div class="spotify-info">
              <div style="display:flex; align-items:center; gap:5px">
                  <h2 id="pUsername">User</h2>
                  <span id="pBadge"></span>
              </div>
              <div id="pTagDisplay"></div> </div>
      </div>
      
      <!-- PROFILE TABS -->
      <div class="profile-tabs-wrapper">
        <button id="tabProfile" class="profile-tab-btn active" onclick="switchProfileTab('profile')">üìä Profil Saya</button>
        <button id="tabAccount" class="profile-tab-btn" onclick="switchProfileTab('account')">‚öôÔ∏è Akun</button>
      </div>

      <!-- PROFILE TAB -->
      <div id="profileTab" class="profile-tab-content active">
        <div class="profile-stats-grid">
          <div class="profile-stat-item">
            <b id="pFol">0</b>
            <span>Followers</span>
          </div>
          <div class="profile-stat-item">
            <b id="pFollowing">0</b>
            <span>Following</span>
          </div>
        </div>
        <div class="section-title">üìù Postingan Saya</div>
        <div id="myPostList" class="posts-list"></div>
      </div>

      <!-- ACCOUNT TAB -->
      <div id="accountTab" class="profile-tab-content">
        <div class="account-setting-box">
          <label class="account-setting-label">üìß Email Address</label>
          <div class="account-setting-value" id="pEmail">Loading...</div>
        </div>

        <button onclick="openChangeNameModal()" class="btn-account">‚úèÔ∏è Ubah Nama Pengguna</button>
        <button onclick="openChangePasswordModal()" class="btn-account danger">üîê Ubah Password</button>
        <button onclick="auth.signOut(); location.reload()" class="btn-account logout">üö™ Logout</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalChangeNames" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:20px; color:var(--accent); font-size:16px;">‚úèÔ∏è Ubah Nama Pengguna</h3>
      <input id="cnPass" type="password" class="inp-dark" placeholder="Password Saat Ini">
      <input id="cnNewName" class="inp-dark" placeholder="Nama Pengguna Baru">
      <button onclick="handleChangeName()" class="btn-act">Ubah Nama</button>
      <div id="cnMsg" class="modal-msg"></div>
    </div>
  </div>

  <div class="modal" id="modalChangePass" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:20px; color:var(--accent); font-size:16px;">üîê Ubah Password</h3>
      <input id="cpOldPass" type="password" class="inp-dark" placeholder="Password Lama">
      <input id="cpNewPass" type="password" class="inp-dark" placeholder="Password Baru (Min. 6 karakter)">
      <input id="cpConfirm" type="password" class="inp-dark" placeholder="Konfirmasi Password Baru">
      <button onclick="handleChangePassword()" class="btn-act">Ubah Password</button>
      <div id="cpMsg" class="modal-msg"></div>
    </div>
  </div>

  <div class="modal" id="modalCreator" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <div class="spotify-banner" style="background: linear-gradient(to bottom, #333, #181818);">
          <div class="spotify-avatar"><img id="vAvatarImg" src="https://via.placeholder.com/150"></div>
          <div class="spotify-info">
              <div style="display:flex; align-items:center; gap:5px">
                  <h2 id="vName">@creator</h2>
                  <span id="vBadge"></span>
              </div>
              <div id="vTagDisplay"></div> </div>
      </div>
      <div class="profile-stats-grid">
        <div class="profile-stat-item">
          <b id="vFol">0</b>
          <span>Followers</span>
        </div>
        <div class="profile-stat-item" style="padding: 0; background: transparent; border: none; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s;" onclick="followCreator()">
          <b id="vCreatorFollowBtn" style="cursor:pointer; transition:0.2s; position: relative; z-index: 10;">Follow</b>
          <span style="cursor:pointer; color:var(--accent); font-weight:600; font-size:11px; position: relative; z-index: 10;">KLIK</span>
        </div>
      </div>
      <div class="section-title">üìù Lagu Terupload</div>
      <div id="creatorPostList"></div>
    </div>
  </div>

  <div class="modal" id="modalReq" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <h3 style="text-align:center; margin-bottom:10px; color:var(--accent)">Upload Lagu</h3>
      <div class="rules-warn" style="font-size: 11px; margin-bottom: 15px;">
          <b>‚ö†Ô∏è PERHATIAN:</b> Dilarang mengupload konten SARA, pornografi audio, atau lagu earrape yang merusak telinga. Pelanggaran akan mengakibatkan <b>BANNED PERMANENT</b> tanpa peringatan!
      </div>
      <div id="uploadFormUser" style="display:none">
          <input id="rLagu" class="inp-dark" placeholder="Judul Lagu - Artist">
          <input id="rUrl" class="inp-dark" placeholder="Link MP3 (Top4Top Only)">
          <button onclick="confirmAndSave()" class="btn-act">POST SEKARANG</button>
      </div>
      <div id="uploadFormGuest">
          <input id="guestName" class="inp-dark" placeholder="Nama Anda">
          <input id="guestLagu" class="inp-dark" placeholder="Judul Lagu - Artist">
          <input id="guestUrl" class="inp-dark" placeholder="Link MP3 Top4Top">
          <button onclick="sendWA()" class="btn-act" style="background:#25D366; color:white">WHATSAPP REQUEST</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalList" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet"><div id="songContainer"></div></div>
  </div>

  <div class="modal" id="modalAbout" onclick="if(event.target==this)this.style.display='none'">
    <div class="sheet">
      <div class="about-box">
        <h3>üéµ Executive Music 3.1 Version</h3>
        <p>Selamat datang di exemusic. Website ini dirancang khusus untuk para creator url yang ingin berbagi dan menikmati musik berkualitas tinggi dengan komunitas yang solid.</p>
        
        <p><b>Fitur Unggulan Platform</b></p>
        <ul class="about-features">
          <li><b>High-Fidelity Audio Streaming</b> ‚Äì Nikmati streaming musik dengan kualitas audio lossless tanpa kompresi berlebihan</li>
          <li><b>Smart Social System</b> ‚Äì Follow creator favorit Anda dan bangun komunitas musik dengan sistem following yang terintegrasi</li>
          <li><b>Dynamic Badge System</b> ‚Äì Dapatkan badge verifikasi otomatis saat mencapai 50+ followers sebagai tanda kreator original (bisa request ke admin)</li>
          <li><b>Deep Linking Technology</b> ‚Äì Bagikan lagu spesifik dengan ID unik langsung ke teman via link khusus</li>
          <li><b>Anti-Spam Protection</b> ‚Äì Sistem cooldown 30 menit mencegah spam dan menjaga kualitas konten exemusic.</li>
          <li><b>Real-time Sync System</b> ‚Äì Semua data followers, likes, dan playlist tersinkronisasi secara real-time</li>
          <li><b>Cloud-Based Infrastructure</b> ‚Äì Data tersimpan aman di database dengan backup otomatis</li>
          <li><b>Multi-Device Support</b> ‚Äì Akses dari desktop, mobile, atau tablet dengan pengalaman yang konsisten</li>
        </ul>

        <p><b>Cara Upload Musik</b></p>
        <p><b>Untuk User yang Sudah Login:</b><br>
        Anda dapat langsung mengupload musik dengan menekan tombol + (Add/Request), kemudian masukkan judul lagu dan link MP3 dari Top4Top. Setelah submit, lagu Anda akan langsung tersedia di platform dan dapat didengarkan oleh semua user.</p>
        <p><b>Untuk Guest (Belum Login):</b><br>
        Jika Anda belum memiliki akun, Anda masih bisa request upload dengan mengirim detail lagu via WhatsApp ke admin. Setelah admin meninjau dan menyetujui, lagu Anda akan diupload ke platform dengan kredit nama Anda.</p>

        <p><b>Program Reward & Incentive</b></p>
        <p>Kami menghargai kontribusi para creator aktif dengan sistem reward yang menarik:</p>
        <ul class="about-features">
          <li>üèÜ <b>VIP Membership</b> ‚Äì Creator dengan performa terbaik berkesempatan mendapatkan akses VIP eksklusif dari admin</li>
          <li>üí∞ <b>Cash Reward</b> ‚Äì Raih reward hingga $0.99 atau Rp 16.000 untuk creator yang mencapai target followers dan engagement tertentu</li>
          <li>üìà <b>Kriteria Penilaian:</b> Total followers, jumlah lagu terupload, engagement rate, dan konsistensi konten</li>
        </ul>
        <p><em>* Syarat dan ketentuan berlaku. Keputusan admin bersifat final.</em></p>

        <p><b>Badge Original User</b></p>
        <p>Sistem badge verifikasi akan otomatis muncul di profil Anda ketika berhasil mengumpulkan 50 followers organik. Badge ini menandakan bahwa Anda adalah creator original dan terpercaya di exemusic.</p>
        
        <div class="rules-warn">
          <b>PERATURAN KETAT EXEMUSIC:</b><br><br>
          Akun yang terbukti mengupload konten ilegal seperti:<br>
          ‚Ä¢ Konten SARA (Suku, Agama, Ras, dan Antar golongan)<br>
          ‚Ä¢ Audio pornografi atau konten seksual eksplisit<br>
          ‚Ä¢ Earrape atau audio yang merusak pendengaran<br>
          ‚Ä¢ Konten yang melanggar hak cipta secara jelas<br>
          ‚Ä¢ Konten yang mengandung ujaran kebencian<br><br>
          <strong>‚ö†Ô∏è AKAN DIHAPUS PERMANEN TANPA PERINGATAN</strong>
        </div>

        <p style="margin-top:12px;">
          <a href="https://wa.me/62895329018240" target="_blank" rel="noopener" class="btn-act about-link-btn" style="display:inline-block; text-decoration:none; margin-right:8px; margin-bottom:8px;">üì± Contact WhatsApp ‚Äì click here!</a>
          <a href="https://execuriverp.github.io/changelogs" target="_blank" rel="noopener" class="btn-act about-link-btn" style="display:inline-block; text-decoration:none; background:#333; color:var(--accent); border:1px solid var(--accent);">üìã Changelogs ‚Äì click here!</a>
        </p>
        <p class="about-footer">Kami menerapkan zero-tolerance policy untuk menjaga kualitas dan keamanan exemusic. Mohon hormati aturan ini demi kenyamanan bersama.</p>
        <p class="about-credit">Dibuat oleh <a href="?profile_userid=GsU6ThLD9gb5P3k8RS87ro553Ks2" class="about-dev-link">Hexky</a><br>¬© 2025 ExeMusic Website</p>
        <button onclick="closeModal()" class="btn-act">SAYA MENGERTI</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCVJYSR4nHeoRA9WTMZa3-2xliKQRrd5g4",
      authDomain: "exemusic-execuriverp.firebaseapp.com",
      databaseURL: "https://exemusic-execuriverp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "exemusic-execuriverp",
      storageBucket: "exemusic-execuriverp.firebasestorage.app",
      messagingSenderId: "722057744401",
      appId: "1:722057744401:web:cd6a6a103692059bda61b0",
      measurementId: "G-2P56Y7QQ18"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let songs = [], i = 0, isShuf = false, isRepeat = false, isLoginMode = true;
    let userData = null;
    let fav = JSON.parse(localStorage.getItem("exeFav") || "[]");
    const audio = new Audio();
    let broadcastTimeout;
    let discoModeActive = false;
    let discoColor = "#00ff88";
    let lastDiscoUser = null;
    let iceModeActive = false;
    let snowflakeInterval = null;
    let notifList = [];
    const lastReadNotifTimeKey = 'exeNotifRead';

    // Tambahan tag keren dan lucu
    function getTagHTML(tag) {
      if(!tag || tag === "none") return '';
      const t = tag.toLowerCase();
      return `<span class="user-tag tag-${t}">${tag}</span>`;
    }

    // REALTIME MONITORING
    db.ref('settings').on('value', s => {
        const val = s.val();
        if(!val) return;
        if(val.mt === true) {
            db.ref('users/' + auth.currentUser?.uid + '/role').once('value', r => {
                if(r.val() !== 'admin') document.getElementById('mtScreen').style.display = 'flex';
            });
        } else { document.getElementById('mtScreen').style.display = 'none'; }
        if(val.announcement) triggerBroadcast(val.announcement);
        
        // DISCO MODE MONITORING
        if(val.discoMode !== discoModeActive) {
            discoModeActive = val.discoMode || false;
            if(discoModeActive && val.discoColor) {
                discoColor = val.discoColor;
                applyDiscoMode(discoColor);
                if(val.discoInitiator) {
                    const initiator = val.discoInitiator;
                    if(initiator !== lastDiscoUser) {
                        triggerBroadcast(`üéâ ${initiator} has started disco mode!`);
                        lastDiscoUser = initiator;
                    }
                }
            } else if(!discoModeActive) {
                resetTheme();
                triggerBroadcast("Disco mode ended! Back to normal.");
            }
        } else if(discoModeActive && val.discoColor && val.discoColor !== discoColor) {
            discoColor = val.discoColor;
            applyDiscoMode(discoColor);
        }
    });

    // NOTIFICATIONS: global + per-user
    function loadNotifs() {
      db.ref('notifications').orderByChild('timestamp').limitToLast(80).on('value', snap => {
        const val = snap.val();
        const list = [];
        if (val) Object.keys(val).forEach(k => list.push({ ...val[k], id: 'g_' + k }));
        mergeAndRenderNotifs(list, 'global');
      });
      auth.onAuthStateChanged(u => {
        if (!u) { mergeAndRenderNotifs([], 'user'); return; }
        db.ref('users/' + u.uid + '/notifications').orderByChild('timestamp').limitToLast(80).on('value', snap => {
          const val = snap.val();
          const list = [];
          if (val) Object.keys(val).forEach(k => list.push({ ...val[k], id: 'u_' + k }));
          mergeAndRenderNotifs(list, 'user');
        });
      });
    }
    let _globalNotifs = [];
    let _userNotifs = [];
    function mergeAndRenderNotifs(list, source) {
      if (source === 'global') _globalNotifs = list;
      else _userNotifs = list;
      notifList = [..._globalNotifs, ..._userNotifs].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      renderNotifList();
      updateNotifBadge();
    }
    function timeAgo(ts) {
      if (!ts) return '';
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 60) return 'Baru saja';
      if (s < 3600) return Math.floor(s / 60) + ' menit lalu';
      if (s < 86400) return Math.floor(s / 3600) + ' jam lalu';
      if (s < 604800) return Math.floor(s / 86400) + ' hari lalu';
      return new Date(ts).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
    }
    function renderNotifList() {
      const el = document.getElementById('notifList');
      if (!el) return;
      if (!notifList.length) {
        el.innerHTML = '<div class="notif-empty">Belum ada notifikasi</div>';
        return;
      }
      const typeIcon = { admin: 'fa-shield-alt', violation: 'fa-exclamation-triangle', upload: 'fa-music', follow: 'fa-user-plus', system: 'fa-info-circle' };
      el.innerHTML = notifList.map(n => {
        const type = (n.type || 'system');
        const icon = typeIcon[type] || 'fa-bell';
        return '<div class="notif-item"><div class="notif-item-icon ' + type + '"><i class="fas ' + icon + '"></i></div><div class="notif-item-body"><div class="n-text">' + escapeHtml(n.text || n.message || '') + '</div><div class="n-time">' + timeAgo(n.timestamp) + '</div></div></div>';
      }).join('');
    }
    function updateNotifBadge() {
      const lastRead = parseInt(localStorage.getItem(lastReadNotifTimeKey) || '0', 10);
      const count = notifList.filter(n => (n.timestamp || 0) > lastRead).length;
      const badge = document.getElementById('notifBadge');
      if (badge) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.classList.toggle('show', count > 0);
      }
    }
    function toggleNotifPanel() {
      const panel = document.getElementById('notifPanel');
      if (panel.classList.toggle('show')) {
        localStorage.setItem(lastReadNotifTimeKey, String(Date.now()));
        updateNotifBadge();
      }
    }
    function closeNotifPanel() {
      document.getElementById('notifPanel').classList.remove('show');
      localStorage.setItem(lastReadNotifTimeKey, String(Date.now()));
      updateNotifBadge();
    }
    document.addEventListener('click', function(e) {
      const panel = document.getElementById('notifPanel');
      const btn = document.getElementById('btnNotif');
      if (panel && panel.classList.contains('show') && !panel.contains(e.target) && btn && !btn.contains(e.target))
        closeNotifPanel();
    });
    loadNotifs();

    function triggerBroadcast(msg) {
        const el = document.getElementById('sysBroadcast');
        const bar = document.getElementById('sbBar');
        const msgEl = document.getElementById('sbMessage');
        el.classList.remove('active', 'sb-closing');
        bar.style.animation = 'none';
        void bar.offsetWidth;
        if (typeof msg === 'string' && msg.trim().toLowerCase().startsWith('hexky:')) {
            const rest = msg.slice(6).trim();
            msgEl.innerHTML = '<span class="sb-dev-name">Hexky</span>: ' + escapeHtml(rest);
        } else {
            msgEl.textContent = msg;
        }
        setTimeout(() => {
            el.classList.add('active');
            bar.style.animation = 'countDown 15s linear forwards';
        }, 100);
        clearTimeout(broadcastTimeout);
        broadcastTimeout = setTimeout(closeBroadcast, 15000);
    }
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function closeBroadcast() {
        const el = document.getElementById('sysBroadcast');
        el.classList.add('sb-closing');
        setTimeout(() => {
            el.classList.remove('active', 'sb-closing');
        }, 400);
    }

    function createSnowflake() {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.textContent = '‚ùÑ';
        snowflake.style.left = Math.random() * window.innerWidth + 'px';
        const duration = Math.random() * 3 + 4; // 4-7 detik jatuh - lebih ringan dan cepat!
        const delay = Math.random() * 0.3;
        snowflake.style.animation = `snowfall ${duration}s linear ${delay}s forwards`;
        document.body.appendChild(snowflake);
        
        setTimeout(() => snowflake.remove(), (duration + delay) * 1000);
    }

    function startSnowfall() {
        if(snowflakeInterval) clearInterval(snowflakeInterval);
        snowflakeInterval = setInterval(createSnowflake, 300);
        // Create initial snowflakes
        for(let i = 0; i < 15; i++) {
            setTimeout(() => createSnowflake(), i * 100);
        }
    }

    function stopSnowfall() {
        if(snowflakeInterval) {
            clearInterval(snowflakeInterval);
            snowflakeInterval = null;
        }
        document.querySelectorAll('.snowflake').forEach(flake => flake.remove());
    }

    function applyDiscoMode(color) {
        document.documentElement.style.setProperty('--accent', color);
        
        // Check jika ice mode
        if(color.toLowerCase() === '#ice') {
            iceModeActive = true;
            color = '#00d4ff'; // Blizzard blue
            document.documentElement.style.setProperty('--accent', color);
        } else {
            iceModeActive = false;
            stopSnowfall();
        }
        
        // Background tetap gelap, cuma ambil tint sedikit
        const rgb = parseInt(color.slice(1), 16);
        const r = (rgb >> 16) & 255;
        const g = (rgb >> 8) & 255;
        const b = rgb & 255;
        
        const app = document.querySelector('.app');
        if(app) {
            // Rainbow effect jika color is rainbow code, ice mode heartbeat, otherwise disco heartbeat
            if(color.toLowerCase() === '#00d4ff') {
                app.style.animation = 'disco-heartbeat 1.2s infinite';
                app.style.borderColor = color;
                app.style.borderWidth = '2px';
                startSnowfall();
            } else if(color.toLowerCase().includes('rainbow')) {
                app.style.animation = 'rainbow-glow 3s infinite linear';
            } else {
                app.style.animation = 'disco-heartbeat 1.2s infinite';
                app.style.borderColor = color;
                app.style.borderWidth = '2px';
            }
            app.style.background = `rgba(${r}, ${g}, ${b}, 0.05)`;
            app.style.boxShadow = `0 0 40px ${color}60`;
        }
        
        // Body background tetap dark
        document.body.style.background = '#050505';
        
        // Update button colors dynamically dengan glow besar
        document.querySelectorAll('.btn-act').forEach(btn => {
            btn.style.background = color;
            btn.style.boxShadow = `0 0 25px ${color}, 0 0 50px ${color}40`;
            btn.style.transform = 'scale(1.02)';
        });
        
        document.querySelectorAll('.btn-play').forEach(btn => {
            btn.style.background = color;
            btn.style.boxShadow = `0 0 40px ${color}, 0 0 80px ${color}40`;
            btn.style.color = '#000';
        });
        
        // Update eq color dengan glow lebih besar dan kontras
        document.querySelectorAll('.eq span').forEach(span => {
            span.style.background = color;
            span.style.boxShadow = `0 0 30px ${color}, 0 0 60px ${color}, 0 0 90px ${color}40`;
            span.style.filter = 'brightness(1.3)';
        });
        
        // Update broadcast bar
        const sbBar = document.getElementById('sbBar');
        if(sbBar) {
            sbBar.style.background = color;
            sbBar.style.boxShadow = `0 0 15px ${color}`;
        }
        
        // System container jadi lebih colorful dengan border
        document.querySelectorAll('.sys-container').forEach(el => {
            el.style.background = `rgba(${r}, ${g}, ${b}, 0.08)`;
            el.style.border = `1px solid ${color}40`;
            el.style.boxShadow = `inset 0 0 15px rgba(${r}, ${g}, ${b}, 0.1)`;
        });
        
        // Modal sheets dengan gradient
        document.querySelectorAll('.sheet').forEach(el => {
            el.style.background = `linear-gradient(180deg, rgba(${r}, ${g}, ${b}, 0.08) 0%, #181818 100%)`;
            el.style.borderTop = `2px solid ${color}80`;
        });
        
        // Title jadi lebih colorful
        const title = document.getElementById('title');
        if(title) {
            title.style.color = color;
            title.style.textShadow = `0 0 20px ${color}80`;
        }
        
        // "By" text juga
        const byEl = document.getElementById('by');
        if(byEl) {
            byEl.style.color = color;
            byEl.style.textShadow = `0 0 10px ${color}60`;
        }
    }

    function resetTheme() {
        document.documentElement.style.setProperty('--accent', '#00ff88');
        document.documentElement.style.setProperty('--bg', '#050505');
        document.documentElement.style.setProperty('--card-bg', '#121212');
        
        document.body.style.background = '#050505';
        
        // Stop snowfall jika active
        if(iceModeActive) {
            stopSnowfall();
            iceModeActive = false;
        }
        
        const app = document.querySelector('.app');
        if(app) {
            app.style.animation = 'none';
            app.style.background = 'rgba(18, 18, 18, 0.6)';
            app.style.borderColor = 'rgba(255,255,255,0.08)';
            app.style.borderWidth = '1px';
            app.style.boxShadow = '0 20px 50px rgba(0,0,0,0.5)';
        }
        
        // Reset button colors
        document.querySelectorAll('.btn-act').forEach(btn => {
            btn.style.background = 'var(--accent)';
            btn.style.boxShadow = 'none';
            btn.style.transform = 'scale(1)';
        });
        
        document.querySelectorAll('.btn-play').forEach(btn => {
            btn.style.background = 'var(--accent)';
            btn.style.boxShadow = '0 0 25px rgba(0, 255, 136, 0.4)';
            btn.style.color = '#000';
        });
        
        // Reset eq color
        document.querySelectorAll('.eq span').forEach(span => {
            span.style.background = 'var(--accent)';
            span.style.boxShadow = '0 0 15px var(--accent)';
            span.style.filter = 'brightness(1)';
        });
        
        // Reset broadcast
        const sbBar = document.getElementById('sbBar');
        if(sbBar) {
            sbBar.style.background = 'var(--accent)';
            sbBar.style.boxShadow = 'none';
        }
        
        // System container
        document.querySelectorAll('.sys-container').forEach(el => {
            el.style.background = 'rgba(255,255,255,0.03)';
            el.style.border = '1px solid rgba(255,255,255,0.05)';
            el.style.boxShadow = 'none';
        });
        
        // Modal sheets
        document.querySelectorAll('.sheet').forEach(el => {
            el.style.background = '#181818';
            el.style.borderTop = '1px solid #333';
        });
        
        // Title reset
        const title = document.getElementById('title');
        if(title) {
            title.style.color = '';
            title.style.textShadow = '0 0 10px rgba(0,0,0,0.5)';
        }
        
        // "By" reset
        const byEl = document.getElementById('by');
        if(byEl) {
            byEl.style.color = 'var(--accent)';
            byEl.style.textShadow = 'none';
        }
    }

    // FUNCTION: Generate fake follower dengan format User_randomnumber
    function generateFakeFollower() {
      const randomNum = Math.floor(Math.random() * 999999) + 10000;
      return `User_${randomNum}`;
    }

    // AUTH & USER DATA
    auth.onAuthStateChanged(u => {
      if(u) {
        db.ref('users/' + u.uid).on('value', snap => {
          userData = snap.val();
          if(!userData) return;
          if(userData.banned === true) {
              document.getElementById('bannedScreen').style.display = 'flex';
              auth.signOut(); return;
          }
          document.getElementById('topLoginBtn').textContent = userData.username;
          document.getElementById('pUsername').innerText = userData.username;
          document.getElementById('pAvatarImg').src = userData.avatar || "https://via.placeholder.com/150";
          document.getElementById('pFol').innerText = (Array.isArray(userData.followers) ? userData.followers.length : userData.followers) || 0;
          document.getElementById('pFollowing').innerText = (Array.isArray(userData.following) ? userData.following.length : userData.following) || 0;
          document.getElementById('pTagDisplay').innerHTML = getTagHTML(userData.tag);
          const followerCount = Array.isArray(userData.followers) ? userData.followers.length : userData.followers || 0;
          document.getElementById('pBadge').innerHTML = (followerCount >= 50) ? '<i class="fas fa-check-circle v-badge"></i>' : '';
          
          // Sensor email
          const email = u.email || "";
          const [name, domain] = email.split('@');
          const sensoredEmail = name.slice(0, Math.max(1, Math.floor(name.length / 3))) + '*'.repeat(Math.max(3, name.length - 2)) + '@' + domain;
          document.getElementById('pEmail').innerText = sensoredEmail;
          
          if(userData.role === 'admin') document.getElementById('adminBtn').style.display = 'block';
          document.getElementById('uploadFormUser').style.display = 'block';
          document.getElementById('uploadFormGuest').style.display = 'none';
          document.getElementById('btnFollow').style.display = 'flex';
          updateFollowUI();
        });
      } else {
        document.getElementById('topLoginBtn').textContent = "Login";
        document.getElementById('btnFollow').style.display = 'none';
        document.getElementById('adminBtn').style.display = 'none';
      }
      document.getElementById('loadingCard').style.display = 'none';
    });

    // SONGS DATA WITH DEEP LINKING
    db.ref('songs').on('value', snap => {
      const val = snap.val();
      if(val) {
        songs = Object.keys(val).map(k => ({...val[k], key: k}));
        
        // Cek ID di URL (execuriverp.github.io/exemusic?id=0)
        const urlParams = new URLSearchParams(window.location.search);
        const songId = urlParams.get('id');
        const profileUid = urlParams.get('profile_userid');
        
        if(profileUid && auth.currentUser) {
          // Open profile dengan deep link
          if(profileUid === auth.currentUser.uid) {
            openProfile();
          } else {
            // Buka profile orang lain
            db.ref('users/' + profileUid).get().then(snap => {
              if(snap.exists()) {
                const userData = snap.val();
                document.getElementById('vAvatarImg').src = userData?.avatar || "https://via.placeholder.com/150";
                const followerCountView = Array.isArray(userData?.followers) ? userData.followers.length : userData?.followers || 0;
                document.getElementById('vName').innerHTML = "@" + userData.username + ((followerCountView >= 50) ? '<i class="fas fa-check-circle v-badge"></i>' : '');
                document.getElementById('vFol').innerText = followerCountView;
                document.getElementById('vTagDisplay').innerHTML = getTagHTML(userData?.tag);
                
                const creatorSongs = songs.filter(x => x.uid === profileUid);
                document.getElementById('creatorPostList').innerHTML = creatorSongs.map(x => `<div class="song-item" onclick="setup(${songs.indexOf(x)}); closeModal()"><span>${x.title}</span><small><i class="fas fa-play"></i></small></div>`).join('');
                
                document.getElementById('modalCreator').dataset.creatorUid = profileUid;
                updateCreatorFollowUI(profileUid);
                document.getElementById('modalCreator').style.display = 'block';
              }
            });
          }
        } else if(audio.src === "") {
            if(songId && songs[songId]) {
                setup(parseInt(songId), false);
            } else {
                setup(0, false);
            }
        }
      }
    });

    async function setup(idx, play = true) {
      if(!songs[idx]) return;
      i = idx;
      
      // Update URL without refresh
      const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + i;
      window.history.pushState({path:newUrl},'',newUrl);

      audio.src = songs[i].url;
      document.getElementById('title').textContent = songs[i].title;
      const cRef = await db.ref('users/' + songs[i].uid).get();
      const cData = cRef.val();
      const followerCountBadge = Array.isArray(cData?.followers) ? cData.followers.length : cData?.followers || 0;
      const badge = (followerCountBadge >= 50) ? '<i class="fas fa-check-circle v-badge"></i>' : '';
      document.getElementById('by').innerHTML = "@" + (songs[i].by || "system") + badge;
      if(play) { audio.play(); document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>'; document.getElementById('eq').classList.add('playing'); }
      updateFollowUI();
    }

    // UPLOAD LOGIC WITH CONFIRMATION & COOLDOWN
    function confirmAndSave() {
        const title = document.getElementById('rLagu').value;
        const url = document.getElementById('rUrl').value;
        
        if(!title || !url) return msg("Isi semua data!");
        
        // Cooldown Check (30 Menit)
        const lastUpload = userData.lastUpload || 0;
        const now = Date.now();
        const diff = (now - lastUpload) / 1000 / 60; // dalam menit
        
        if(diff < 30 && userData.role !== 'admin') {
            return Swal.fire({
                icon: 'error',
                title: 'Sabar...',
                text: `Tunggu ${Math.ceil(30 - diff)} menit lagi untuk upload lagu berikutnya.`,
                background: '#181818', color: '#fff'
            });
        }

        Swal.fire({
            title: 'Are you sure?',
            text: "Jika lagu ini melanggar rules kami (Sara, Porn, Earrape), akun anda akan kami BANNED PERMANENT!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#00ff88',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Saya Tanggung Jawab',
            background: '#181818',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                saveMusic(title, url);
            }
        });
    }

    function saveMusic(t, u) {
        const newSong = {
            title: t,
            url: u,
            uid: auth.currentUser.uid,
            by: userData.username,
            timestamp: Date.now()
        };
        
        db.ref('songs').push(newSong).then(() => {
            db.ref('users/' + auth.currentUser.uid).update({ lastUpload: Date.now() });
            db.ref('notifications').push({
              type: 'upload',
              text: userData.username + ' mengupload: ' + t,
              fromName: userData.username,
              timestamp: Date.now()
            });
            msg("Berhasil diposting!");
            closeModal();
            document.getElementById('rLagu').value = "";
            document.getElementById('rUrl').value = "";
        });
    }

    // CORE AUDIO CONTROLS
    function toggle() {
      if(audio.paused) { audio.play(); document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>'; document.getElementById('eq').classList.add('playing'); }
      else { audio.pause(); document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>'; document.getElementById('eq').classList.remove('playing'); }
    }
    function next() { setup(isShuf ? Math.floor(Math.random()*songs.length) : (i+1)%songs.length); }
    function prev() { setup(isShuf ? Math.floor(Math.random()*songs.length) : (i-1+songs.length)%songs.length); }
    
    audio.ontimeupdate = () => {
      document.getElementById('seek').value = (audio.currentTime/audio.duration)*100 || 0;
      document.getElementById('cur').textContent = fmt(audio.currentTime);
      document.getElementById('dur').textContent = fmt(audio.duration);
      // Hide spinner when duration is available
      if(audio.duration > 0) {
        document.getElementById('loadSpinner').classList.remove('show');
      }
    };
    
    // Show loading spinner when song starts playing (duration not yet loaded)
    audio.onplay = () => {
      if(audio.duration === 0 || isNaN(audio.duration)) {
        document.getElementById('loadSpinner').classList.add('show');
      }
    };
    
    // Hide spinner when metadata is loaded
    audio.onloadedmetadata = () => {
      document.getElementById('loadSpinner').classList.remove('show');
    };
    document.getElementById('seek').oninput = (e) => audio.currentTime = (e.target.value/100)*audio.duration;
    document.getElementById('vol').oninput = (e) => audio.volume = e.target.value;
    audio.onended = () => isRepeat ? (audio.currentTime=0, audio.play()) : next();

    // FOLLOWERS LOGIC
    async function followUser() {
      if(!auth.currentUser) return msg("Login dulu!");
      const targetUid = songs[i].uid;
      if(!targetUid || targetUid === auth.currentUser.uid) return msg("Gak bisa follow diri sendiri");
      
      try {
        const targetRef = db.ref('users/' + targetUid);
        const currentRef = db.ref('users/' + auth.currentUser.uid);
        
        const targetSnap = await targetRef.get();
        const currentSnap = await currentRef.get();
        
        const targetData = targetSnap.val();
        const currentData = currentSnap.val();
        
        const targetFollowers = Array.isArray(targetData?.followers) ? [...targetData.followers] : [];
        const currentFollowing = Array.isArray(currentData?.following) ? [...currentData.following] : [];
        
        const isFollowing = targetFollowers.includes(auth.currentUser.uid);
        
        if(isFollowing) {
          // Unfollow
          const newFollowers = targetFollowers.filter(uid => uid !== auth.currentUser.uid);
          const newFollowing = currentFollowing.filter(uid => uid !== targetUid);
          
          await targetRef.update({ followers: newFollowers });
          await currentRef.update({ following: newFollowing });
          msg("Unfollowed!");
        } else {
          // Follow
          const newFollowers = [...targetFollowers, auth.currentUser.uid];
          const newFollowing = [...currentFollowing, targetUid];
          
          await targetRef.update({ followers: newFollowers });
          await currentRef.update({ following: newFollowing });
          db.ref('users/' + targetUid + '/notifications').push({
            type: 'follow',
            text: userData.username + ' mulai mengikuti kamu',
            fromName: userData.username,
            fromUid: auth.currentUser.uid,
            timestamp: Date.now()
          });
          msg("Followed! ‚úÖ");
        }
        // Update button state immediately
        await updateFollowUI();
      } catch(err) {
        msg("Error: " + err.message);
      }
    }

    async function updateFollowUI() {
      if(!auth.currentUser || !songs[i].uid) return;
      const targetSnap = await db.ref('users/' + songs[i].uid).get();
      const targetData = targetSnap.val();
      const targetFollowers = Array.isArray(targetData?.followers) ? targetData.followers : [];
      
      const btn = document.getElementById('btnFollow');
      if(targetFollowers.includes(auth.currentUser.uid)) {
        btn.style.display = 'none'; // Hide button jika sudah follow
      } else {
        btn.style.display = 'flex';
        btn.innerHTML = '<i class="fas fa-plus"></i>';
        btn.style.background = "var(--tiktok-red)";
      }
    }

    // UTILS
    function fmt(s) { if(isNaN(s)) return "0:00"; let m=Math.floor(s/60),sec=Math.floor(s%60); return m+":"+(sec<10?"0"+sec:sec); }
    function msg(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
    
    function openProfile() { 
        if(!auth.currentUser) document.getElementById('modalAuth').style.display='block'; 
        else {
            const myPosts = songs.filter(s => s.uid === auth.currentUser.uid);
            document.getElementById('myPostList').innerHTML = myPosts.map(s => `<div class="song-item" onclick="setup(${songs.indexOf(s)}); closeModal()"><span>${s.title}</span><small><i class="fas fa-play"></i></small></div>`).join('');
            document.getElementById('modalProfile').style.display = 'block';
        }
    }
    
    async function viewCreator() {
        const s = songs[i]; 
        if(!s.uid) return;
        
        // Jika creator adalah user sendiri, buka profile modal
        if(auth.currentUser && s.uid === auth.currentUser.uid) {
            openProfile();
            return;
        }
        
        const cRef = await db.ref('users/' + s.uid).get();
        const cData = cRef.val();
        const followerCountCreator = Array.isArray(cData?.followers) ? cData.followers.length : cData?.followers || 0;
        document.getElementById('vAvatarImg').src = cData?.avatar || "https://via.placeholder.com/150";
        document.getElementById('vName').innerHTML = "@" + s.by + ((followerCountCreator >= 50) ? '<i class="fas fa-check-circle v-badge"></i>' : '');
        document.getElementById('vFol').innerText = followerCountCreator;
        document.getElementById('vTagDisplay').innerHTML = getTagHTML(cData?.tag);
        const creatorSongs = songs.filter(x => x.uid === s.uid);
        document.getElementById('creatorPostList').innerHTML = creatorSongs.map(x => `<div class="song-item" onclick="setup(${songs.indexOf(x)}); closeModal()"><span>${x.title}</span><small><i class="fas fa-play"></i></small></div>`).join('');
        
        // Set data untuk follow button
        document.getElementById('modalCreator').dataset.creatorUid = s.uid;
        
        // Update follow button state
        updateCreatorFollowUI(s.uid);
        
        document.getElementById('modalCreator').style.display = 'block';
    }

    async function updateCreatorFollowUI(creatorUid) {
      if(!auth.currentUser) return;
      const creatorSnap = await db.ref('users/' + creatorUid).get();
      const creatorData = creatorSnap.val();
      const creatorFollowers = Array.isArray(creatorData?.followers) ? creatorData.followers : [];
      
      const btnText = document.getElementById('vCreatorFollowBtn');
      
      if(creatorFollowers.includes(auth.currentUser.uid)) {
        btnText.innerText = 'Following ‚úì';
        btnText.style.color = 'var(--accent)';
      } else {
        btnText.innerText = 'Follow';
        btnText.style.color = '#ddd';
      }
    }

    async function followCreator() {
      if(!auth.currentUser) return msg("Login dulu!");
      
      const creatorUid = document.getElementById('modalCreator').dataset.creatorUid;
      if(!creatorUid || creatorUid === auth.currentUser.uid) return msg("Gak bisa follow diri sendiri");
      
      try {
        const creatorRef = db.ref('users/' + creatorUid);
        const currentRef = db.ref('users/' + auth.currentUser.uid);
        
        const creatorSnap = await creatorRef.get();
        const currentSnap = await currentRef.get();
        
        const creatorData = creatorSnap.val();
        const currentData = currentSnap.val();
        
        const creatorFollowers = Array.isArray(creatorData?.followers) ? [...creatorData.followers] : [];
        const currentFollowing = Array.isArray(currentData?.following) ? [...currentData.following] : [];
        
        const isFollowing = creatorFollowers.includes(auth.currentUser.uid);
        
        if(isFollowing) {
          // Unfollow
          const newFollowers = creatorFollowers.filter(uid => uid !== auth.currentUser.uid);
          const newFollowing = currentFollowing.filter(uid => uid !== creatorUid);
          
          await creatorRef.update({ followers: newFollowers });
          await currentRef.update({ following: newFollowing });
          msg("Unfollowed!");
        } else {
          // Follow
          const newFollowers = [...creatorFollowers, auth.currentUser.uid];
          const newFollowing = [...currentFollowing, creatorUid];
          
          await creatorRef.update({ followers: newFollowers });
          await currentRef.update({ following: newFollowing });
          db.ref('users/' + creatorUid + '/notifications').push({
            type: 'follow',
            text: userData.username + ' mulai mengikuti kamu',
            fromName: userData.username,
            fromUid: auth.currentUser.uid,
            timestamp: Date.now()
          });
          msg("Followed! ‚úÖ");
        }
        // Update button
        await updateCreatorFollowUI(creatorUid);
      } catch(err) {
        msg("Error: " + err.message);
      }
    }

    async function openList(f) {
      const c = document.getElementById('songContainer');
      const l = f ? songs.filter(s => fav.includes(s.url)) : songs;
      c.innerHTML = '<p style="text-align:center; padding:20px; color:#555">Memuat...</p>';
      let html = "";
      for(let s of l) {
          const uRef = await db.ref('users/' + s.uid).get();
          const uData = uRef.val();
          const followerCount = Array.isArray(uData?.followers) ? uData.followers.length : uData?.followers || 0;
          const badge = (followerCount >= 50) ? '<i class="fas fa-check-circle v-badge"></i>' : '';
          html += `<div class="song-item" onclick="setup(${songs.indexOf(s)}); closeModal()"><div style="flex:1"><b>${s.title}</b><br><small style="color:#777">@${s.by}${badge}</small></div><span onclick="toggleFav('${s.url}', event)" style="color:${fav.includes(s.url)?'var(--accent)':'#444'}"><i class="fas fa-heart"></i></span></div>`;
      }
      c.innerHTML = html;
      document.getElementById('modalList').style.display='block';
    }

    function toggleFav(u, e) { e.stopPropagation(); fav = fav.includes(u) ? fav.filter(x => x !== u) : [...fav, u]; localStorage.setItem("exeFav", JSON.stringify(fav)); openList(false); }
    function toggleShuffle() { isShuf = !isShuf; document.getElementById('shuf').classList.toggle('active', isShuf); }
    function toggleRepeat() { isRepeat = !isRepeat; document.getElementById('rep').classList.toggle('active', isRepeat); }
    function copyRawUrl() { navigator.clipboard.writeText(songs[i].url); msg("Link audio disalin"); }
    
    function shareLink() { 
        const link = window.location.origin + window.location.pathname + "?id=" + i;
        navigator.clipboard.writeText(link); 
        msg("Link lagu dengan ID disalin"); 
    }
    
    function downloadSong() { window.open(songs[i].url); }
    function openReq() { document.getElementById('modalReq').style.display='block'; }
    function openAbout() { document.getElementById('modalAbout').style.display='block'; }
    function toggleAuthMode() { /* Google Sign-In only - not used */ }
    function sendWA() { window.open(`https://wa.me/62895329018240?text=Halo Admin, saya ${document.getElementById('guestName').value} ingin upload: ${document.getElementById('guestLagu').value}`); }
    function openAdmin() { if(userData?.role === 'admin') window.location.href = 'admmenu.html'; }

    let isFirstTimeUser = false;

    function handleAuth() {
      /* Old function - replaced by handleGoogleAuth */
    }

    function handleGoogleAuth() {
      if(isFirstTimeUser) {
        // Complete registration
        const username = document.getElementById('authUser').value.trim();
        
        if(!username || username.length < 3) {
          msg('‚ùå Username minimal 3 karakter!');
          return;
        }
        
        const user = auth.currentUser;
        if(!user) {
          msg('‚ùå Session expired, silakan coba lagi');
          isFirstTimeUser = false;
          document.getElementById('usernameSection').style.display = 'none';
          document.getElementById('googleBtnText').innerText = 'Masuk dengan Google';
          return;
        }
        
        // Generate 3-5 fake followers
        const fakeFollowerCount = Math.floor(Math.random() * 3) + 3;
        const fakeFollowers = [];
        for(let i = 0; i < fakeFollowerCount; i++) {
          fakeFollowers.push(generateFakeFollower());
        }
        
        // Simpan data user ke database
        db.ref('users/' + user.uid).set({
          username: username,
          email: user.email,
          avatar: user.photoURL || "https://via.placeholder.com/150",
          role: 'user',
          followers: fakeFollowers,
          following: [],
          tag: 'user',
          createdAt: Date.now()
        }).then(() => {
          isFirstTimeUser = false;
          document.getElementById('usernameSection').style.display = 'none';
          document.getElementById('googleBtnText').innerText = 'Masuk dengan Google';
          closeModal();
          msg('‚úÖ Akun berhasil dibuat! Selamat datang ' + username + '!');
        }).catch(err => {
          msg('‚ùå Gagal menyimpan data: ' + err.message);
        });
      } else {
        // Google Sign-In
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({
          prompt: 'select_account'
        });
        
        auth.signInWithPopup(provider)
          .then(result => {
            const user = result.user;
            const isNewUser = result.additionalUserInfo.isNewUser;
            
            // Cek apakah user baru
            if(isNewUser) {
              isFirstTimeUser = true;
              // Tampilkan form username
              document.getElementById('googleBtnText').innerText = 'Buat Akun';
              document.getElementById('usernameSection').style.display = 'block';
              msg('üëã Selamat datang! Buat username Anda untuk melanjutkan.');
            } else {
              // User lama, langsung masuk
              closeModal();
              msg('‚úÖ Selamat datang kembali!');
            }
          })
          .catch(err => {
            if(err.code === 'auth/popup-closed-by-user') {
              msg('‚ö†Ô∏è Login dibatalkan');
            } else if(err.code === 'auth/cancelled-popup-request') {
              // Ignore
            } else {
              msg('‚ùå Gagal login: ' + err.message);
            }
          });
      }
    }

    function uploadAvatar(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            db.ref('users/' + auth.currentUser.uid).update({ avatar: e.target.result }).then(() => msg("Profil Updated!"));
        };
        reader.readAsDataURL(file);
    }

    // PROFILE MANAGEMENT FUNCTIONS
    function switchProfileTab(tab) {
      const profileTab = document.getElementById('profileTab');
      const accountTab = document.getElementById('accountTab');
      const btnProfile = document.getElementById('tabProfile');
      const btnAccount = document.getElementById('tabAccount');
      
      if(tab === 'profile') {
        profileTab.classList.add('active');
        accountTab.classList.remove('active');
        btnProfile.classList.add('active');
        btnAccount.classList.remove('active');
      } else {
        profileTab.classList.remove('active');
        accountTab.classList.add('active');
        btnProfile.classList.remove('active');
        btnAccount.classList.add('active');
      }
    }

    function openChangeNameModal() {
      document.getElementById('cnMsg').innerText = '';
      document.getElementById('cnMsg').classList.remove('show', 'success', 'error');
      document.getElementById('cnPass').value = '';
      document.getElementById('cnNewName').value = '';
      document.getElementById('modalChangeNames').style.display = 'block';
    }

    async function handleChangeName() {
      const password = document.getElementById('cnPass').value;
      const newName = document.getElementById('cnNewName').value;
      const msgEl = document.getElementById('cnMsg');
      
      msgEl.classList.remove('success', 'error');
      
      if(!newName || !password) {
        msgEl.innerText = '‚ö†Ô∏è Isi semua field!';
        msgEl.classList.add('show', 'error');
        return;
      }
      if(newName.length < 3) {
        msgEl.innerText = '‚ö†Ô∏è Nama minimal 3 karakter!';
        msgEl.classList.add('show', 'error');
        return;
      }
      
      const lastChange = userData.lastNameChange || 0;
      const now = Date.now();
      const diffDays = (now - lastChange) / (1000 * 60 * 60 * 24);
      
      if(diffDays < 7) {
        msgEl.innerText = `‚è≥ Tunggu ${Math.ceil(7 - diffDays)} hari lagi!`;
        msgEl.classList.add('show', 'error');
        return;
      }
      
      const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, password);
      
      try {
        await auth.currentUser.reauthenticateWithCredential(credential);
        await db.ref('users/' + auth.currentUser.uid).update({
          username: newName,
          lastNameChange: Date.now()
        });
        msgEl.innerText = '‚úÖ Nama berhasil diubah!';
        msgEl.classList.add('show', 'success');
        setTimeout(() => {
          document.getElementById('modalChangeNames').style.display = 'none';
          msg('Nama pengguna telah diperbarui!');
        }, 1500);
      } catch(err) {
        msgEl.innerText = '‚ùå Password salah!';
        msgEl.classList.add('show', 'error');
      }
    }

    function openChangePasswordModal() {
      document.getElementById('cpMsg').innerText = '';
      document.getElementById('cpMsg').classList.remove('show', 'success', 'error');
      document.getElementById('cpOldPass').value = '';
      document.getElementById('cpNewPass').value = '';
      document.getElementById('cpConfirm').value = '';
      document.getElementById('modalChangePass').style.display = 'block';
    }

    async function handleChangePassword() {
      const oldPass = document.getElementById('cpOldPass').value;
      const newPass = document.getElementById('cpNewPass').value;
      const confirm = document.getElementById('cpConfirm').value;
      const msgEl = document.getElementById('cpMsg');
      
      msgEl.classList.remove('success', 'error');
      
      if(!oldPass || !newPass || !confirm) {
        msgEl.innerText = '‚ö†Ô∏è Isi semua field!';
        msgEl.classList.add('show', 'error');
        return;
      }
      if(newPass.length < 6) {
        msgEl.innerText = '‚ö†Ô∏è Password minimal 6 karakter!';
        msgEl.classList.add('show', 'error');
        return;
      }
      if(newPass !== confirm) {
        msgEl.innerText = '‚ö†Ô∏è Password tidak cocok!';
        msgEl.classList.add('show', 'error');
        return;
      }
      
      const lastChange = userData.lastPasswordChange || 0;
      const now = Date.now();
      const diffDays = (now - lastChange) / (1000 * 60 * 60 * 24);
      
      if(diffDays < 7) {
        msgEl.innerText = `‚è≥ Tunggu ${Math.ceil(7 - diffDays)} hari lagi!`;
        msgEl.classList.add('show', 'error');
        return;
      }
      
      const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, oldPass);
      
      try {
        await auth.currentUser.reauthenticateWithCredential(credential);
        await auth.currentUser.updatePassword(newPass);
        await db.ref('users/' + auth.currentUser.uid).update({
          lastPasswordChange: Date.now()
        });
        msgEl.innerText = '‚úÖ Password berhasil diubah!';
        msgEl.classList.add('show', 'success');
        setTimeout(() => {
          document.getElementById('modalChangePass').style.display = 'none';
          msg('Password telah diperbarui!');
        }, 1500);
      } catch(err) {
        msgEl.innerText = '‚ùå Password lama salah!';
        msgEl.classList.add('show', 'error');
      }
    }
  </script>
</body>
</html>
