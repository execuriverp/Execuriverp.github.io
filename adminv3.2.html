<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - ExeMusic v3.2</title>
  <link rel="icon" type="image/png" href="exemusicicon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --spotify-green: #1DB954;
      --spotify-black: #121212;
      --spotify-dark: #181818;
      --spotify-grey: #282828;
      --spotify-text: #FFFFFF;
      --spotify-text-dim: #B3B3B3;
      --accent: #1ed760;
      --danger: #e91429;
      --gold: #ffb400;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Circular', 'Helvetica Neue', Helvetica, Arial, sans-serif; }
    body { background-color: var(--spotify-black); color: var(--spotify-text); display: flex; height: 100vh; overflow: hidden; }

    /* Sidebar */
    .sidebar { width: 260px; background-color: #000; display: flex; flex-direction: column; padding: 24px 12px; }
    .logo { display: flex; align-items: center; gap: 8px; font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 32px; padding: 0 12px; text-decoration: none; }
    .nav-item { display: flex; align-items: center; gap: 16px; padding: 12px; color: var(--spotify-text-dim); text-decoration: none; font-size: 14px; font-weight: 700; border-radius: 4px; transition: 0.2s; cursor: pointer; }
    .nav-item:hover, .nav-item.active { color: #fff; background-color: var(--spotify-grey); }

    /* Main Content */
    .main-content { flex: 1; overflow-y: auto; padding: 32px; background: linear-gradient(to bottom, #222, var(--spotify-black)); }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; margin-bottom: 40px; }
    .stat-card { background: var(--spotify-dark); padding: 24px; border-radius: 8px; border: 1px solid #333; }
    .stat-val { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
    .stat-label { color: var(--spotify-text-dim); font-size: 14px; }

    /* Tables/Lists */
    .section { background: var(--spotify-dark); border-radius: 8px; padding: 24px; margin-bottom: 32px; }
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; color: var(--spotify-text-dim); font-size: 12px; text-transform: uppercase; border-bottom: 1px solid #333; }
    td { padding: 12px; font-size: 14px; border-bottom: 1px solid #222; }
    .tr-hover:hover { background: #222; }

    /* Buttons & Inputs */
    .btn { padding: 8px 16px; border-radius: 20px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 12px; }
    .btn-primary { background: var(--spotify-green); color: #000; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-dim { background: #333; color: #fff; }
    .btn:hover { transform: scale(1.05); }

    .inp-dark { background: #333; border: 1px solid #444; color: #fff; padding: 8px 16px; border-radius: 4px; font-size: 14px; width: 100%; }

    /* Modals */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: var(--spotify-dark); padding: 32px; border-radius: 8px; width: 100%; max-width: 500px; }

    /* Mobile */
    @media (max-width: 768px) {
      body { flex-direction: column; }
      .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 12px; }
      .logo { display: none; }
      .nav-item { white-space: nowrap; }
      .main-content { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <a href="exemusicv3.2.html" class="logo"><img src="exemusicicon.png" width="32"> Admin</a>
    <div class="nav-item active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Dashboard</div>
    <div class="nav-item" onclick="showSection('songs')"><i class="fas fa-music"></i> Kelola Lagu</div>
    <div class="nav-item" onclick="showSection('requests')"><i class="fas fa-cloud-upload-alt"></i> Request Lagu</div>
    <div class="nav-item" onclick="showSection('users')"><i class="fas fa-users"></i> Kelola User</div>
    <div class="nav-item" onclick="showSection('broadcast')"><i class="fas fa-bullhorn"></i> Broadcast</div>
    <div class="nav-item" onclick="showSection('settings')"><i class="fas fa-cog"></i> Pengaturan</div>
    <div class="nav-item" onclick="location.href='exemusicv3.2.html'" style="margin-top: auto;"><i class="fas fa-arrow-left"></i> Kembali</div>
  </div>

  <div class="main-content">
    <div id="dashboard" class="admin-section">
      <div class="header"><h1>Dashboard</h1></div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-val" id="statSongs">0</div><div class="stat-label">Total Lagu</div></div>
        <div class="stat-card"><div class="stat-val" id="statUsers">0</div><div class="stat-label">Total User</div></div>
        <div class="stat-card"><div class="stat-val" id="statRequests">0</div><div class="stat-label">Request Pending</div></div>
        <div class="stat-card"><div class="stat-val" id="statPlays">0</div><div class="stat-label">Total Plays</div></div>
      </div>
      <div class="section">
        <div class="section-title">Aktivitas Terkini</div>
        <div id="recentActivity">Memuat...</div>
      </div>
    </div>

    <div id="songs" class="admin-section" style="display: none;">
      <div class="header"><h1>Kelola Lagu</h1><button class="btn btn-primary" onclick="openAddSong()">Tambah Lagu</button></div>
      <div class="section">
        <table>
          <thead><tr><th>Cover</th><th>Judul</th><th>Oleh</th><th>Plays</th><th>Aksi</th></tr></thead>
          <tbody id="songList"></tbody>
        </table>
      </div>
    </div>

    <div id="requests" class="admin-section" style="display: none;">
      <div class="header"><h1>Request Lagu</h1></div>
      <div class="section">
        <table>
          <thead><tr><th>Judul</th><th>URL</th><th>Pemohon</th><th>Aksi</th></tr></thead>
          <tbody id="requestList"></tbody>
        </table>
      </div>
    </div>

    <div id="users" class="admin-section" style="display: none;">
      <div class="header"><h1>Kelola User</h1></div>
      <div class="section">
        <table>
          <thead><tr><th>Avatar</th><th>Username</th><th>Role</th><th>Ketupat</th><th>Aksi</th></tr></thead>
          <tbody id="userList"></tbody>
        </table>
      </div>
    </div>

    <div id="broadcast" class="admin-section" style="display: none;">
      <div class="header"><h1>Sistem Broadcast</h1></div>
      <div class="section" style="max-width: 600px;">
        <label>Judul Broadcast</label><input id="bcTitle" class="inp-dark" style="margin: 8px 0 16px;" placeholder="PENGUMUMAN">
        <label>Pesan Broadcast</label><textarea id="bcMsg" class="inp-dark" style="margin: 8px 0 24px; height: 100px;" placeholder="Tulis pesan..."></textarea>
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-primary" onclick="sendBroadcast()">Kirim Sekarang</button>
          <button class="btn btn-danger" onclick="stopBroadcast()">Hentikan Broadcast</button>
        </div>
      </div>
    </div>

    <div id="settings" class="admin-section" style="display: none;">
      <div class="header"><h1>Pengaturan Website</h1></div>
      <div class="section" style="max-width: 500px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <span>Mode Maintenance</span>
          <button id="btnMaint" class="btn btn-dim" onclick="toggleMaint()">OFF</button>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <span>Efek Salju (Snowfall)</span>
          <button id="btnSnow" class="btn btn-dim" onclick="toggleSnow()">OFF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Add Song -->
  <div id="modalAddSong" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 24px;">Tambah/Edit Lagu</h2>
      <input id="sTitle" class="inp-dark" placeholder="Judul Lagu" style="margin-bottom: 12px;">
      <input id="sBy" class="inp-dark" placeholder="Nama Artist/User" style="margin-bottom: 12px;">
      <input id="sUrl" class="inp-dark" placeholder="URL Audio Direct" style="margin-bottom: 12px;">
      <input id="sCover" class="inp-dark" placeholder="URL Cover Image" style="margin-bottom: 24px;">
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-primary" style="flex: 1;" onclick="saveSong()">Simpan</button>
        <button class="btn btn-dim" onclick="closeModal()">Batal</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCVJYSR4nHeoRA9WTMZa3-2xliKQRrd5g4",
      authDomain: "exemusic-execuriverp.firebaseapp.com",
      databaseURL: "https://exemusic-execuriverp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "exemusic-execuriverp",
      storageBucket: "exemusic-execuriverp.firebasestorage.app",
      messagingSenderId: "722057744401",
      appId: "1:722057744401:web:cd6a6a103692059bda61b0",
      measurementId: "G-2P56Y7QQ18"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let editKey = null;

    // Protection
    auth.onAuthStateChanged(u => {
      if(!u) return location.href = 'exemusicv3.2.html';
      db.ref('users/' + u.uid + '/role').once('value', snap => {
        if(snap.val() !== 'admin') {
          alert("Akses ditolak! Anda bukan admin.");
          location.href = 'exemusicv3.2.html';
        } else {
          initAdmin();
        }
      });
    });

    function initAdmin() {
      loadStats();
      loadSongs();
      loadRequests();
      loadUsers();
      loadSettings();
    }

    function showSection(id) {
      document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      event.currentTarget.classList.add('active');
    }

    function loadStats() {
      db.ref('songs').on('value', snap => {
        const val = snap.val() || {};
        const count = Object.keys(val).length;
        document.getElementById('statSongs').textContent = count;
        let plays = 0;
        Object.values(val).forEach(s => plays += (s.plays || 0));
        document.getElementById('statPlays').textContent = plays;
      });
      db.ref('users').on('value', snap => {
        document.getElementById('statUsers').textContent = Object.keys(snap.val() || {}).length;
      });
      db.ref('requests').on('value', snap => {
        document.getElementById('statRequests').textContent = Object.keys(snap.val() || {}).length;
      });
    }

    function loadSongs() {
      db.ref('songs').on('value', snap => {
        const list = document.getElementById('songList');
        list.innerHTML = '';
        const data = snap.val() || {};
        Object.keys(data).forEach(k => {
          const s = data[k];
          list.innerHTML += `
            <tr class="tr-hover">
              <td><img src="${s.cover || 'exemusicicon.png'}" width="40" height="40" style="border-radius: 4px;"></td>
              <td>${s.title}</td>
              <td>@${s.by || 'Unknown'}</td>
              <td>${s.plays || 0}</td>
              <td>
                <button class="btn btn-dim" onclick="editSong('${k}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteSong('${k}')">Hapus</button>
              </td>
            </tr>
          `;
        });
      });
    }

    function loadRequests() {
      db.ref('requests').on('value', snap => {
        const list = document.getElementById('requestList');
        list.innerHTML = '';
        const data = snap.val() || {};
        Object.keys(data).forEach(k => {
          const r = data[k];
          list.innerHTML += `
            <tr class="tr-hover">
              <td>${r.title}</td>
              <td><a href="${r.url}" target="_blank" style="color: var(--spotify-green);">Link</a></td>
              <td>@${r.by}</td>
              <td>
                <button class="btn btn-primary" onclick="approveRequest('${k}')">Approve</button>
                <button class="btn btn-danger" onclick="rejectRequest('${k}')">Reject</button>
              </td>
            </tr>
          `;
        });
      });
    }

    function loadUsers() {
      db.ref('users').on('value', snap => {
        const list = document.getElementById('userList');
        list.innerHTML = '';
        const data = snap.val() || {};
        Object.keys(data).forEach(k => {
          const u = data[k];
          list.innerHTML += `
            <tr class="tr-hover">
              <td><img src="${u.avatar || 'exemusicicon.png'}" width="32" height="32" style="border-radius: 50%;"></td>
              <td>${u.username} ${u.banned ? 'ðŸ”´' : ''}</td>
              <td>${u.role || 'user'}</td>
              <td>ðŸ’  ${u.ketupat || 0}</td>
              <td>
                <button class="btn btn-dim" onclick="editUser('${k}')">Manage</button>
                <button class="btn btn-danger" onclick="toggleBan('${k}', ${u.banned})">${u.banned ? 'Unban' : 'Ban'}</button>
              </td>
            </tr>
          `;
        });
      });
    }

    function loadSettings() {
      db.ref('settings').on('value', snap => {
        const s = snap.val() || {};
        const bM = document.getElementById('btnMaint');
        const bS = document.getElementById('btnSnow');
        bM.textContent = s.maintenance ? 'ON' : 'OFF';
        bM.className = s.maintenance ? 'btn btn-danger' : 'btn btn-dim';
        bS.textContent = s.snowfall ? 'ON' : 'OFF';
        bS.className = s.snowfall ? 'btn btn-primary' : 'btn btn-dim';
      });
    }

    // Actions
    function openAddSong() {
      editKey = null;
      document.getElementById('sTitle').value = '';
      document.getElementById('sBy').value = '';
      document.getElementById('sUrl').value = '';
      document.getElementById('sCover').value = '';
      document.getElementById('modalAddSong').style.display = 'flex';
    }

    function editSong(key) {
      editKey = key;
      db.ref('songs/' + key).once('value', snap => {
        const s = snap.val();
        document.getElementById('sTitle').value = s.title;
        document.getElementById('sBy').value = s.by;
        document.getElementById('sUrl').value = s.url;
        document.getElementById('sCover').value = s.cover || '';
        document.getElementById('modalAddSong').style.display = 'flex';
      });
    }

    function saveSong() {
      const data = {
        title: document.getElementById('sTitle').value,
        by: document.getElementById('sBy').value,
        url: document.getElementById('sUrl').value,
        cover: document.getElementById('sCover').value,
        timestamp: Date.now()
      };
      if(editKey) db.ref('songs/' + editKey).update(data);
      else db.ref('songs').push(data);
      closeModal();
      Swal.fire('Berhasil', 'Lagu disimpan', 'success');
    }

    function deleteSong(key) {
      if(confirm('Hapus lagu ini?')) db.ref('songs/' + key).remove();
    }

    function approveRequest(key) {
      db.ref('requests/' + key).once('value', snap => {
        const r = snap.val();
        db.ref('songs').push({
          title: r.title,
          url: r.url,
          cover: r.cover || '',
          by: r.by,
          uid: r.uid,
          timestamp: Date.now()
        }).then(() => {
          db.ref('requests/' + key).remove();
          // Notif user
          db.ref('notifications/' + r.uid).push({
            message: `Lagu "${r.title}" kamu telah disetujui!`,
            timestamp: Date.now()
          });
          Swal.fire('Berhasil', 'Request disetujui', 'success');
        });
      });
    }

    function rejectRequest(key) {
      if(confirm('Tolak request ini?')) db.ref('requests/' + key).remove();
    }

    function toggleBan(uid, current) {
      db.ref('users/' + uid).update({ banned: !current });
    }

    function sendBroadcast() {
      const title = document.getElementById('bcTitle').value;
      const msg = document.getElementById('bcMsg').value;
      if(!msg) return;
      db.ref('broadcast').set({
        title: title || "PENGUMUMAN",
        message: msg,
        active: true,
        timestamp: Date.now()
      }).then(() => Swal.fire('Terkirim', 'Broadcast aktif', 'success'));
    }

    function stopBroadcast() {
      db.ref('broadcast/active').set(false);
    }

    function toggleMaint() {
      db.ref('settings/maintenance').once('value', snap => {
        db.ref('settings/maintenance').set(!snap.val());
      });
    }

    function toggleSnow() {
      db.ref('settings/snowfall').once('value', snap => {
        db.ref('settings/snowfall').set(!snap.val());
      });
    }

    function editUser(uid) {
      Swal.fire({
        title: 'Manage User',
        html: `
          <input id="swalKetupat" type="number" class="swal2-input" placeholder="Jumlah Ketupat">
          <select id="swalRole" class="swal2-input">
            <option value="user">User</option>
            <option value="vip">VIP</option>
            <option value="admin">Admin</option>
          </select>
        `,
        preConfirm: () => {
          const k = document.getElementById('swalKetupat').value;
          const r = document.getElementById('swalRole').value;
          const updates = { role: r };
          if(k) updates.ketupat = parseInt(k);
          db.ref('users/' + uid).update(updates);
        }
      });
    }

    function closeModal() {
      document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }
  </script>
</body>
</html>
